<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-122855516-2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-122855516-2');
    </script>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://rawgit.com/aframevr/aframe/master/dist/aframe-master.js"></script>
    <script src="./viewer.js"></script>
    <script>
        AFRAME.registerComponent('click-handler', {
            init: function () {
                this.el.addEventListener('mouseenter', () => {
                    this.el.setAttribute('scale',{x:1.1, y:1.1, z:1.1})
                });

                this.el.addEventListener('mouseleave', () => {
                    this.el.setAttribute('scale',{x:1.0, y:1.0, z:1.0})
                });
                this.el.addEventListener('click', () => {
                    console.log("looking for the node")
                    const viewer = Viewer.getViewer()
                    const node = viewer.getNodeForAFrameObject(this.el)
                    if (node.children) {
                        const nav = node.children.find(ch => ch.type === 'nav-action')
                        if (nav) {
                            console.log("found the nav", nav)
                            viewer.loadScene(nav.targetScene)
                        }
                        const play = node.children.find(ch => ch.type === 'playsound-action')
                        if (play) {
                            const asset = viewer.findAssetById(play.assetRef)
                            const url = viewer.getURLForResourceId(asset.assetId)
                            const audio = document.createElement('audio')
                            audio.autoplay = true
                            audio.src = url
                        }
                    }
                });
            }
        });
    </script>

</head>
<body>
<a-scene>
    <a-entity camera look-controls wasd-controls>
        <a-entity cursor="fuse: true; maxDistance: 30;"
                  id="cursor"
                  position="0 0 -3"
                  geometry="primitive:ring; radiusInner: 0.2; radiusOuter:0.3"
                  material="color:cyan; shader:flat"
                  raycaster="objects: .action; recursive:true;"
                  >
            <a-animation begin="click" easing="ease-in" attribute="scale" dur="150"
                         fill="forwards" from="0.2 0.2 0.2" to="1 1 1"></a-animation>
            <a-animation begin="fusing" easing="ease-in" attribute="scale" dur="1500"
                         fill="backwards" from="1 1 1" to="0.2 0.2 0.2"></a-animation>

        </a-entity>
    </a-entity>
    <a-entity id="children"></a-entity>

    <a-entity laser-controls="hand: left"
              raycaster="objects: .action;" line="color:blue;"></a-entity>
    <a-entity laser-controls="hand: right"
              raycaster="objects: .action;" line="color:blue;"></a-entity>

</a-scene>

<script>
    function parseQuery(str) {
        if (str.startsWith('?')) str = str.substring(1)
        console.log("parsing", str)
        const parts = str.split("&")
        console.log(parts)
        const args = {}
        parts.forEach(part => {
            const p2 = part.split('=')
            args[p2[0]] = p2[1]
        })
        return args
    }
    console.log("loading from the URL string")
    const args = parseQuery(document.location.search)
    console.log("args = ", args)
    const SERVER_URL = "https://vr.josh.earth/360/doc/"
    const SERVER_URL_ASSETS = "https://vr.josh.earth/360/asset/"
    Viewer.getViewer().doLoad(args.doc,SERVER_URL,SERVER_URL_ASSETS)
</script>
</body>
</html>