<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-122855516-2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-122855516-2');
    </script>
    <meta charset="UTF-8">
    <title>Title</title>
    <!-- required for the transitions -->
    <script src="https://code.createjs.com/tweenjs-0.6.2.min.js"></script>
    <script src="https://rawgit.com/aframevr/aframe/master/dist/aframe-master.js"></script>
    <script src="./viewer.js"></script>
    <script>
        function scaleTo(el, sc, dur) {
            const scale = el.object3D.scale
            const tween = new TWEEN.Tween(scale).to({x:sc,y:sc,z:sc,},dur)
            tween.start()
        }
        AFRAME.registerComponent('click-handler', {
            init: function () {
                this.el.addEventListener('mouseenter', () => {
                    if(Viewer.getViewer().elementHasAction(this.el)) scaleTo(this.el,1.2, 200)
                });

                this.el.addEventListener('mouseleave', () => {
                    if(Viewer.getViewer().elementHasAction(this.el)) scaleTo(this.el,1.0, 200)
                });
                this.el.addEventListener('click', () => {
                    const viewer = Viewer.getViewer()
                    const node = viewer.getNodeForAFrameObject(this.el)
                    if (node.children) {
                        const nav = node.children.find(ch => ch.type === 'nav-action')
                        if (nav) {
                            viewer.loadScene(nav.targetScene)
                        }
                        const play = node.children.find(ch => ch.type === 'playsound-action')
                        if (play) {
                            const asset = viewer.findAssetById(play.assetRef)
                            const url = viewer.getURLForResourceId(asset.assetId)
                            const audio = document.createElement('audio')
                            audio.autoplay = true
                            audio.src = url
                        }
                    }
                });
            }
        });
    </script>

</head>
<body>
<a-scene id="scene">
    <a-entity camera look-controls wasd-controls>
        <a-entity cursor="fuse: true; maxDistance: 30;"
                  class="gaze"
                  id="cursor"
                  position="0 0 -3"
                  geometry="primitive:ring; radiusInner: 0.2; radiusOuter:0.3"
                  material="color:cyan; shader:flat"
                  raycaster="objects: .action; recursive:true;"
                  >
            <a-animation begin="click" easing="ease-in" attribute="scale" dur="150"
                         fill="forwards" from="0.2 0.2 0.2" to="1 1 1"></a-animation>
            <a-animation begin="fusing" easing="ease-in" attribute="scale" dur="1500"
                         fill="backwards" from="1 1 1" to="0.2 0.2 0.2"></a-animation>

        </a-entity>
    </a-entity>
    <a-entity id="children"></a-entity>

    <a-entity laser-controls="hand: left"
              class="dof6"
              raycaster="objects: .action;" line="color:blue;"></a-entity>
    <a-entity laser-controls="hand: right"
              class="dof6"
              raycaster="objects: .action;" line="color:blue;"></a-entity>

</a-scene>

<script>
    function parseQuery(str) {
        if (str.startsWith('?')) str = str.substring(1)
        console.log("parsing", str)
        const parts = str.split("&")
        console.log(parts)
        const args = {}
        parts.forEach(part => {
            const p2 = part.split('=')
            args[p2[0]] = p2[1]
        })
        return args
    }
    console.log("loading from the URL string")
    const args = parseQuery(document.location.search)
    console.log("args = ", args)
    let SERVER_URL = "https://vr.josh.earth/360/doc/"
    let SERVER_URL_ASSETS = "https://vr.josh.earth/360/asset/"

    let local = false
    if(!args.doc) {
        local = true
        args.doc = "scene.json"
        SERVER_URL = "./"
        SERVER_URL_ASSETS = "./"

    }
    Viewer.getViewer().doLoad(args.doc,SERVER_URL,SERVER_URL_ASSETS,local)

    function setEnabled(sel,vis) {
        const elem = $(sel)
        elem.setAttribute('visible', vis)
    }

    function switch6DOF() {
        setEnabled('.gaze',false)
        setEnabled('.dof6',true)
    }


    function switchGaze() {
        setEnabled('.gaze',true)
        setEnabled('.dof6',false)
    }

    on($('a-scene'),'enter-vr',()=>{
        if(AFRAME.utils.device.checkHeadsetConnected()) {
            switch6DOF()
        } else {
            switchGaze()
        }
    })
    on($('a-scene'),'exit-vr',switchGaze)

    //always start up in gaze mode
    on($('a-scene'),'loaded',switchGaze)
</script>
</body>
</html>