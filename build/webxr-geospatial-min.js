!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.XRGeospatialAnchor=t()}(this,function(){"use strict";let e="undefined"!=typeof Float32Array?Float32Array:Array;Math.PI;function t(){let t=new e(16);return e!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function r(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function i(){let t=new e(3);return e!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function o(e,t,r){let i=t[0],o=t[1],a=t[2],n=r[3]*i+r[7]*o+r[11]*a+r[15];return n=n||1,e[0]=(r[0]*i+r[4]*o+r[8]*a+r[12])/n,e[1]=(r[1]*i+r[5]*o+r[9]*a+r[13])/n,e[2]=(r[2]*i+r[6]*o+r[10]*a+r[14])/n,e}!function(){let e=i()}();function a(e){this._token=e.token,this._url=e.url;var t=Cesium.Resource.createIfNeeded(e.url);this._resource=t,this._tilingScheme=e.tilingScheme,Cesium.defined(this._tilingScheme)||(this._tilingScheme=new Cesium.WebMercatorTilingScheme({numberOfLevelZeroTilesX:1,numberOfLevelZeroTilesY:1,ellipsoid:Cesium.defaultValue(e.ellipsoid,Cesium.Ellipsoid.WGS84)})),this._heightmapWidth=64,this._levelZeroMaximumGeometricError=Cesium.TerrainProvider.getEstimatedLevelZeroGeometricErrorForAHeightmap(this._tilingScheme.ellipsoid,this._heightmapWidth,this._tilingScheme.getNumberOfXTilesAtLevel(0)),this._proxy=e.proxy,this._terrainDataStructure={heightScale:1/256,heightOffset:-32768,elementsPerHeight:3,stride:4,elementMultiplier:256,isBigEndian:!0,lowestEncodedHeight:0,highestEncodedHeight:16777215},this._errorEvent=new Cesium.Event;var r=e.credit;"string"==typeof r&&(r=new Cesium.Credit(r)),this._credit=r,this._readyPromise=Promise.resolve(!0),this._terrainPromises={}}Object.defineProperties(a.prototype,{errorEvent:{get:function(){return this._errorEvent}},credit:{get:function(){return this._credit}},tilingScheme:{get:function(){return this._tilingScheme}},ready:{get:function(){return!0}},readyPromise:{get:function(){return this._readyPromise}},hasWaterMask:{get:function(){return!1}},hasVertexNormals:{get:function(){return!1}}}),a.prototype.requestTileGeometry=function(e,t,r,i){var o=this._url+r+"/"+e+"/"+t+".png",a=this._proxy;Cesium.defined(a)&&(o=a.getURL(o));var n=this._resource.getDerivedResource({url:o,queryParameters:{cesium:!0},request:i}).fetchImage({preferImageBitmap:!0});if(Cesium.defined(n)){var s=this;return n.then(function(e){return new Cesium.HeightmapTerrainData({buffer:Cesium.getImagePixels(e,s._heightmapWidth,s._heightmapWidth),width:s._heightmapWidth,height:s._heightmapWidth,childTileMask:r<16?0:15,structure:s._terrainDataStructure})})}},a.prototype.getLevelMaximumGeometricError=function(e){return this._levelZeroMaximumGeometricError/(1<<e)},a.prototype.getTileDataAvailable=function(e,t,r){return r<16||void 0};const n="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};var s=null,c=null;if(void 0!==n.XRAnchor)s=n.XRAnchor;if(void 0!==n.XRDevice)c=n.XRDevice;const u={enableHighAccuracy:!0,maximumAge:3e4},l=t();var d=i(),h=i(),m=t(),f=function(){let t=new e(9);return e!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1,t}(),p=null,g=null,v=null,_=null,w=null,y=[],C=null,A=t(),E=t(),G=null,L=!1,x=null,O=null,S=!1,M=null,P=0;function R(){return L?O:_}var b=null;async function T(e){return b=Cesium.Cartographic.clone(e,b),await D(b),b.height}var N=null;function D(e){return Promise.resolve(Cesium.sampleTerrain(N,15,[e]).then(e=>e[0]))}function X(e,t){try{e.dispatchEvent("newGeoAnchor",{oldAnchor:e,newAnchor:t})}catch(e){console.error("newGeoAnchor event error",e)}}function F(e,t){!function(e){C(e,void 0,E),Cesium.Matrix4.inverseTransformation(E,A)}(e);for(let e=0;e<y.length;e++){const t=y[e];try{t()}catch(e){console.error("lazy finalization of geoanchor failed: ",e)}}y=[];try{t.dispatchEvent("updateCartesian")}catch(e){console.error("updateCartesian event error",e)}}var q=!1;var W=!1,k=null;async function H(e,t=!1){if(!W&&(!v||t||v.coords.accuracy>e.coords.accuracy||v.coords.accuracy==e.coords.accuracy&&v.coords.altitudeAccuracy>e.coords.altitudeAccuracy)){W=!0,e={timestamp:e.timestamp,coords:{altitude:e.coords.altitude,latitude:e.coords.latitude,longitude:e.coords.longitude,accuracy:e.coords.accuracy,altitudeAccuracy:e.coords.altitudeAccuracy,heading:e.coords.heading,speed:e.coords.speed}};try{q&&(e.coords.altitude,k=Cesium.Cartographic.fromDegrees(e.coords.longitude,e.coords.latitude,e.coords.altitude),await D(k),e.coords.altitude=k.height);let t=await g.requestFrameOfReference("head-model"),r=await g.addAnchor(l,t);r._isInternalGeoAnchor=!0,!L&&_&&(X(_,r),await g.removeAnchor(_)),_=r,v=e,w=await async function(e,t,r=null){if(!r){let i=Cesium.Cartographic.fromDegrees(e,t);r=await T(i)}return Cesium.Cartesian3.fromDegrees(e,t,r)}(e.coords.longitude,e.coords.latitude,e.coords.altitude),L||F(w,_),W=!1}catch(e){W=!1,console.error("error setting the geospatial origin: ",e)}}}function I(e){e.code,console.error("watchPosition failed: ",e.message)}function Z(e){v?e():y.push(e)}class j extends s{constructor(e){let t="geoAnchor-"+(new Date).getTime()+"-"+Math.floor(Math.random()*Number.MAX_SAFE_INTEGER);super(l,t),this._cartographic=e,this._localCartesian=i(),this._cartesian=Cesium.Cartographic.toCartesian(e),this._newGeoOriginNotifier=this._newGeoAnchor.bind(this),this._updateCartesianNotifier=this._updateLocalCartesian.bind(this),this._updateLocalNotifier=this._updateLocalMatrix.bind(this);let r=R();r.addEventListener("newGeoAnchor",this._newGeoOriginNotifier),r.addEventListener("updateCartesian",this._updateCartesianNotifier),r.addEventListener("update",this._updateLocalNotifier),this._updateLocalCartesian()}_newGeoAnchor(e){e.oldAnchor.removeEventListener("newGeoAnchor",this._newGeoOriginNotifier),e.oldAnchor.removeEventListener("updateCartesian",this._updateCartesianNotifier),e.oldAnchor.removeEventListener("update",this._updateLocalNotifier),e.newAnchor.addEventListener("newGeoAnchor",this._newGeoOriginNotifier),e.newAnchor.addEventListener("updateCartesian",this._updateCartesianNotifier),e.newAnchor.addEventListener("update",this._updateLocalNotifier)}_updateLocalCartesian(){var e,t,r,i;e=d,t=this._cartesian.x,r=this._cartesian.y,i=this._cartesian.z,e[0]=t,e[1]=r,e[2]=i,o(this._localCartesian,d,A),S&&(function(e,t){e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10]}(f,M.modelMatrix),function(e,t,r){let i=t[0],o=t[1],a=t[2];e[0]=i*r[0]+o*r[3]+a*r[6],e[1]=i*r[1]+o*r[4]+a*r[7],e[2]=i*r[2]+o*r[5]+a*r[8]}(this._localCartesian,this._localCartesian,f)),this._updateLocalMatrix()}_updateLocalMatrix(){var e,t,i;r(d,R().modelMatrix),e=d,t=d,i=this._localCartesian,e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],function(e,t){e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1}(m,d),super.updateModelMatrix(m,R.timeStamp)}get cartographic(){return null==this._cartographic&&(this._cartographic=Cesium.Cartographic.fromCartesian(this._cartesian)),this._cartographic}set cartographic(e){this._cartographic=e,this._cartesian=Cesium.Cartographic.toCartesian(e),this._updateLocalCartesian()}get cartesian(){return this._cartesian}set cartesian(e){this._cartesian=e,this._cartographic=null,this._updateLocalCartesian()}static getGeoOriginPose(){return R()?R().modelMatrix:l}static getOriginCartesian(){}static createGeoAnchor(e){return new Promise((t,r)=>{if(!window.hasOwnProperty("Cesium")){var i="must load Cesium.js for XRGeospatialAnchor to work";console.error(i),r(i)}Z(()=>{t(new j(e))})})}static useEstimatedElevation(e){!async function(e){let t=function(e){return new Promise(t=>setTimeout(t,e))};if(q!=e&&(q=e,v))for(q&&(v.coords.altitude=_saveViewHeight);_updateOrigin;)await t(1),await H(v,!0)}(e)}static overrideGeoOrientation(e){S=!0,M=e,L?F(x,O):v&&F(w,_)}static overrideGeoLocation(e,t){!L&&_?X(_,t):L&&X(O,t),L=!0,F(x=e,O=t)}static overrideGeoLocationOrientation(e,t){!L&&_?X(_,t):L&&X(O,t),S=!0,M=t,L=!0,F(x=e,O=t)}static useDeviceGeolocation(){L&&_&&X(O,_),S=!1,M=null,L=!1,x=null,O=null,v&&F(w,_)}static async getDefaultElevation(e){return await T(e)}static getDeviceElevation(){return new Promise((e,t)=>{Z(()=>{g.requestFrameOfReference("head-model").then(t=>{t.getTransformTo(G,m),r(d,m);let i=d[1];r(d,R().modelMatrix);let o=i-d[1];e(v.coords.altitude+o)})})})}static async getDeviceCartographic(){return new Promise((a,n)=>{Z(()=>{g.requestFrameOfReference("head-model").then(n=>{n.getTransformTo(G,m),r(d,m),r(h,R().modelMatrix),t=d,i=h,(e=d)[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],o(d,d,E),p=Cesium.Cartesian3.unpack(d,0,p),a(Cesium.Cartographic.fromCartesian(p))})})});var e,t,i}}return void 0!==n.XRGeospatialAnchr?console.warn("XRGeospatialAnchor already defined on global."):void 0!==n.XRAnchor&&void 0!==n.XRDevice&&(!function(){var e=(c=n.XRDevice).prototype.requestSession;c.prototype.requestSession=async function(t){let r=e.bind(this),i=await r(t);if(window.hasOwnProperty("Cesium")&&t.alignEUS&&t.geolocation){const e=()=>{g=null,P&&(navigator.geolocation.clearWatch(P),P=0),v=null,_=null,L=!1,S=!1,y=[],i.removeEventListener("end",e)};i._useGeolocation=!0,i.addEventListener("end",e),await async function(e){g=e,C||(C=Cesium.Transforms.localFrameToFixedFrameGenerator("east","up")),N||(N=new a({url:"https://s3.amazonaws.com/elevation-tiles-prod/terrarium/",requestWaterMask:!0,requestVertexNormals:!0}));try{return await e.requestFrameOfReference("head-model"),G=await e.requestFrameOfReference("eye-level"),"geolocation"in navigator&&(P=navigator.geolocation.watchPosition(H,I,u),!0)}catch(e){return console.error("Can't start geolocation to XR mapping",e),!1}}(i)}return i};var t=c.prototype.endSession;c.prototype.endSession=function(e){let r=t.bind(this)(e);return session._useGeolocation&&j.closeSession(),r};var r=c.prototype.supportsSession;c.prototype.supportsSession=async function(e={}){let t=r.bind(this),i=Object.assign({},e);var o=!1;if(e.hasOwnProperty("geolocation")&&(o=!0,delete i.geolocation),await t(e),!o||e.hasOwnProperty("alignEUS"))return!0;throw null}}(),window.XRGeospatialAnchor=j),j});
