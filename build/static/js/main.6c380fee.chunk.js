(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{12:function(e,t){e.exports={adds:[],add:function(e){this.adds.forEach(function(t){return t(e)})},onAdd:function(e){this.adds.push(e)},offAdd:function(e){this.adds=this.adds.filter(function(t){return t!==e})}}},46:function(e,t,n){e.exports=n(96)},51:function(e,t,n){},55:function(e,t,n){},63:function(e,t,n){},96:function(e,t,n){"use strict";n.r(t);var r=n(0),i=n.n(r),a=n(42),o=n.n(a),s=(n(51),n(53),n(2)),c=n(3),u=n(5),l=n(4),h=n(6),p=(n(55),n(7)),d=n(11),f=n(8),v=n(45);function m(e){var t=document.location;t.search&&t.search.substring(1).split("&").forEach(function(t){var n=t.split("=");e[n[0]]=n[1]});return e}var y=function(e,t,n){return e.addEventListener(t,n)};function g(e){return JSON.stringify(e)}function b(e,t){return{x:e,y:t,minus:function(e){return b(this.x-e.x,this.y-e.y)},add:function(e){return b(this.x+e.x,this.y+e.y)},divide:function(e){return b(this.x/e,this.y/e)},multiply:function(e){return b(this.x*e,this.y*e)},idivide:function(e){return b(Math.floor(this.x/e),Math.floor(this.y/e))},floor:function(){return b(Math.floor(this.x),Math.floor(this.y))},distance:function(e){var t=e.x-this.x,n=e.y-this.y;return Math.sqrt(t*t+n*n)},equals:function(e){return e.x===this.x&&e.y===this.y},toString:function(){return"(".concat(e,",").concat(t,")")}}}function w(e){var t=m({}),n={};Object.keys(t).forEach(function(e){return n[e]=t[e]}),Object.keys(e).forEach(function(t){return n[t]=e[t]});var r=Object.keys(n).map(function(e){return"".concat(e,"=").concat(n[e])}).join("&");window.history.pushState(e,"a title","?"+r)}function O(e){return Object.keys(e).map(function(t){return"".concat(t,"=").concat(e[t])}).join("&")}var k=function(e){var t="grid fill",n=e.leftWidth,r=e.rightWidth;e.showLeft||(t+=" hide-left",n=0),e.showRight||(t+=" hide-right",r=0);var a={gridTemplateColumns:"\n    [left] ".concat(n,"px\n    [left-resize] 2px\n    [center] auto\n    [right-resize] 2px\n    [right] ").concat(r,"px\n    ")};return i.a.createElement("div",{className:t,style:a},e.children)},S=function(e){var t="toolbar";return e.left&&(t+=" left"),e.right&&(t+=" right"),e.bottom&&(t+=" bottom"),e.top&&(t+=" top"),e.center&&(t+=" center"),e.middle&&(t+=" middle"),e.scroll&&(t+=" scroll"),i.a.createElement("div",{className:t},e.children)},A=function(e){var t="panel";return e.left&&(t+=" left"),e.right&&(t+=" right"),e.bottom&&(t+=" bottom"),e.top&&(t+=" top"),e.center&&(t+=" center"),e.middle&&(t+=" middle"),e.scroll&&(t+=" scroll"),e.transparent&&(t+=" transparent"),i.a.createElement("div",{className:t},e.children)},x=function(e){return i.a.createElement("span",{className:"spacer"})},C=function(e){var t=e.selected,n=Object(v.a)(e,["selected"]),r=t?"selected":"";return i.a.createElement("button",Object.assign({className:r},n))},M=function(e){return i.a.createElement(p.f,{className:"popup-menu"},e.actions.map(function(e,t){if(e.divider)return i.a.createElement("div",{className:"divider",key:t});var n=!1;return"undefined"===typeof e.enabled&&(n=!0),!0===e.enabled&&(n=!0),i.a.createElement("button",{key:t,disabled:!n,onClick:function(){p.e.hide(),e.fun&&e.fun()}},i.a.createElement("i",{className:"fa fa-"+e.icon})," ",e.title)}))},E=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this,e))).toggleLeftPane=function(e){return n.setState({showLeft:!n.state.showLeft})},n.toggleRightPane=function(e){return n.setState({showRight:!n.state.showRight})},n.onMouseDownLeft=function(e){e.preventDefault(),e.stopPropagation(),n.setState({dragSide:"left"}),window.addEventListener("mousemove",n.onMouseMove),window.addEventListener("mouseup",n.onMouseUp)},n.onMouseDownRight=function(e){e.preventDefault(),e.stopPropagation(),n.setState({dragSide:"right"}),window.addEventListener("mousemove",n.onMouseMove),window.addEventListener("mouseup",n.onMouseUp)},n.onMouseMove=function(e){e.preventDefault(),e.stopPropagation();var t=b(e.clientX,e.clientY);"left"===n.state.dragSide&&n.setState({leftWidth:t.x}),"right"===n.state.dragSide&&n.setState({rightWidth:window.innerWidth-t.x})},n.onMouseUp=function(e){e.preventDefault(),e.stopPropagation(),window.removeEventListener("mousemove",n.onMouseMove),window.removeEventListener("mouseup",n.onMouseUp)},n.state={showLeft:!0,showRight:!0,leftWidth:250,rightWidth:250,dragSide:"none"},n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){return i.a.createElement(k,{showLeft:this.state.showLeft,showRight:this.state.showRight,leftWidth:this.state.leftWidth,rightWidth:this.state.rightWidth},i.a.createElement(S,{center:!0,bottom:!0},i.a.createElement("button",{className:"fa"+(this.state.showLeft?" fa-caret-left":" fa-caret-right"),onClick:this.toggleLeftPane}),i.a.createElement(x,null),this.props.bottomText,i.a.createElement(x,null),i.a.createElement("button",{className:"fa"+(this.state.showRight?" fa-caret-right":" fa-caret-left"),onClick:this.toggleRightPane})),i.a.createElement("div",{className:"left-resize",onMouseDown:this.onMouseDownLeft}),i.a.createElement("div",{className:"right-resize",onMouseDown:this.onMouseDownRight}),this.props.children)}}]),t}(r.Component),j="CHANGED",D="DROP_TARGET",R=new(function(){function e(t){Object(s.a)(this,e),this.listeners={},this.selected=[],this.dropTarget=null,this.clip=null}return Object(c.a)(e,[{key:"on",value:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}},{key:"off",value:function(e,t){var n=this.listeners[e].indexOf(t);n>=0&&this.listeners[e].splice(n,1)}},{key:"fire",value:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].forEach(function(e){return e(t)})}},{key:"setSelection",value:function(e){this.selected=[e],this.fire(j,this)}},{key:"addToSelection",value:function(e){this.selected.push(e),this.fire(j,this)}},{key:"clearSelection",value:function(){this.selected=[],this.fire(j,this)}},{key:"isSelected",value:function(e){return this.selected.indexOf(e)>=0}},{key:"getSelection",value:function(){return 0===this.selected.length?null:this.selected[0]}},{key:"isEmpty",value:function(){return 0===this.selected.length}},{key:"getFullSelection",value:function(){return this.selected}},{key:"setDropTarget",value:function(e){this.dropTarget!==e&&(this.dropTarget=e,this.fire(D,this.dropTarget))}},{key:"getDropTarget",value:function(){return this.dropTarget}},{key:"setDropType",value:function(e){this.dropType=e}},{key:"getDropType",value:function(){return this.dropType}},{key:"setClipboard",value:function(e){this.clip=e}},{key:"getClipboard",value:function(){return this.clip}}]),e}()),P=n(20),L=n.n(P),T=function(e){function t(e){var n;Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this,e))).mousePress=function(e){var t=n.canvasToPoint(e);n.setState({lightness:t.x,value:t.y}),n.redraw(),n.pressed=!0},n.mouseMove=function(e){if(n.pressed){var t=n.canvasToPoint(e);n.setState({lightness:t.x,value:t.y}),n.redraw()}},n.mouseUp=function(e){n.pressed=!1,n.redraw()},n.redraw=function(){n.drawPicker(),n.drawSlider(),n.drawIndicator()},n.livalToCanvas=function(e,t){return b(e/100*100,t/100*100)},n.mouseToCanvas=function(e){var t=e.target.getBoundingClientRect();return b(e.clientX,e.clientY).minus(b(t.x,t.y))},n.mousePressSlider=function(e){n.sliderPressed=!0;var t=n.mouseToCanvas(e),r=n.canvasToHue(t);n.setState({hue:r}),setTimeout(n.redraw,100)},n.mouseMoveSlider=function(e){if(n.sliderPressed){var t=n.mouseToCanvas(e),r=n.canvasToHue(t);n.setState({hue:r}),setTimeout(n.redraw,100)}},n.mouseUpSlider=function(){n.sliderPressed=!1},n.close=function(){var e=L.a.hsluvToHex([Math.floor(n.state.hue),Math.floor(n.state.lightness),Math.floor(n.state.value)]);e.length>7&&(e="#000000"),n.props.onSelect(e),p.e.hide()};var r=L.a.hexToHsluv(e.value);return n.state={hue:r[0],lightness:r[1],value:r[2]},console.log("the current value is",e.value,L.a.hexToHsluv(e.value)),n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){this.redraw()}},{key:"canvasToPoint",value:function(e){var t=this.canvas.getBoundingClientRect(),n=b(e.clientX,e.clientY).minus(b(t.x,t.y)),r=this.canvas.height,i=this.canvas.width;return b(n.x/i*100,n.y/r*100)}},{key:"drawPicker",value:function(){if(this.canvas){for(var e=this.canvas.getContext("2d"),t=Math.floor(this.state.hue),n=0;n<=4;n++)for(var r=0;r<=4;r++){var i=L.a.hsluvToHex([t,25*n,25*r]);i.length>7&&(i="#000000"),e.fillStyle=i,e.fillRect(20*n,20*r,20,20)}var a=20,o=this.livalToCanvas(this.state.lightness,this.state.value);e.strokeStyle="white",e.strokeRect(Math.floor(o.x/a)*a,Math.floor(o.y/a)*a,a,a),e.strokeStyle="black",e.strokeRect(Math.floor(o.x/a)*a+1,Math.floor(o.y/a)*a+1,18,18),e.strokeStyle="black",e.lineWidth=1,e.strokeRect(0,0,100,100)}}},{key:"canvasToHue",value:function(e){return Math.floor(e.x/this.slider.width*360)}},{key:"hueToCanvas",value:function(e){return e/360*this.slider.width}},{key:"drawSlider",value:function(){var e=this.slider.getContext("2d"),t=this.slider.width,n=this.slider.height;e.fillStyle="red",e.fillRect(0,0,t,n);for(var r=0;r<t;r+=10){var i=this.canvasToHue(b(r,0)),a=L.a.hsluvToHex([i,100,50]);a.length>7&&(a="#000000"),e.fillStyle=a,e.fillRect(r,0,10,n)}e.strokeStyle="black",e.lineWidth=1;var o=10*Math.floor(this.hueToCanvas(this.state.hue)/10);e.strokeRect(o,0,10,n),e.strokeRect(0,0,t,n)}},{key:"drawIndicator",value:function(){var e=this.indicator.getContext("2d"),t=this.indicator.width,n=this.indicator.height,r=L.a.hsluvToHex([Math.floor(this.state.hue),Math.floor(this.state.lightness),Math.floor(this.state.value)]);r.length>7&&(r="#000000"),e.fillStyle=r,e.fillRect(0,0,t,n),e.strokeStyle="black",e.lineWidth=1,e.strokeRect(0,0,t,n)}},{key:"render",value:function(){var e=this;return i.a.createElement("div",{style:{display:"flex",flexDirection:"column",alignItems:"center"}},i.a.createElement("canvas",{ref:function(t){return e.canvas=t},width:100,height:100,onMouseDown:this.mousePress,onMouseMove:this.mouseMove,onMouseUp:this.mouseUp}),i.a.createElement("canvas",{ref:function(t){return e.slider=t},width:100,height:30,onMouseDown:this.mousePressSlider,onMouseMove:this.mouseMoveSlider,onMouseUp:this.mouseUpSlider}),i.a.createElement("canvas",{ref:function(t){return e.indicator=t},width:32,height:32,onClick:this.close}))}}]),t}(r.Component),I=n(12),N="USER_CHANGE",G=new(function(){function e(){var t=this;Object(s.a)(this,e),this.login=function(e){t.win=window.open(e.url,"_blank"),window.addEventListener("message",t.authCallback),t.win&&t.win.focus()},this.logout=function(){localStorage.clear(),t.doclistSupported=!1,t.fire(N)},this.authCallback=function(e){t.setUserData(e.data.payload),t.win.close(),window.removeEventListener("message",t.authCallback),t.doclistSupported=!0,t.fire(N),I.add("login succeeded")},this.listeners={},this.supported=!1,this.doclistSupported=!1,this.docDeleteSupported=!1,this.assetUploadSupported=!1,this.scriptEditingSupported=!1,this.passwordSupported=!1,this.connected=!1,this.serverID="".concat("serverid","_").concat(Math.floor(1e4*Math.random()))}return Object(c.a)(e,[{key:"on",value:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}},{key:"fire",value:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].forEach(function(e){return e(t)})}},{key:"init",value:function(){var e=this;this.isLoggedIn()&&(this.doclistSupported=!0),fetch(V()).then(function(e){return e.json()}).then(function(t){console.info("Server Info:",t),!0===t.authentication&&(e.supported=!0),!0===t.passwordSupported&&(e.passwordSupported=!0),!0===t.assetUpload&&(e.assetUploadSupported=!0),!0===t.scriptEditing&&(e.scriptEditingSupported=!0),!0===t.docDeleteSupported&&(e.docDeleteSupported=!0),e.serverID=V().replace(/[\.\:\/]/g,""),e.getJSON(W()).then(function(t){t.success?(e.fire(N),e.doclistSupported=!0):e.logout(),e.connected=!0,e.fire("CONNECTED")}).then(function(){e.connected=!0,e.fire("CONNECTED")})})}},{key:"isConnected",value:function(){return this.connected}},{key:"isLoggedIn",value:function(){return!!localStorage.getItem("access-token")}},{key:"supportsPassword",value:function(){return this.passwordSupported}},{key:"supportsAuth",value:function(){return this.supported}},{key:"supportsDocList",value:function(){return this.doclistSupported}},{key:"supportsAssetUpload",value:function(){return this.assetUploadSupported}},{key:"supportsScriptEdit",value:function(){return this.scriptEditingSupported}},{key:"supportsDocDelete",value:function(){return this.docDeleteSupported}},{key:"doPasswordLogin",value:function(e){var t=this;return localStorage.setItem("access-token",e),this.getJSON(W()).then(function(e){!0===e.success?(console.log("the logged in response is",e),t.doclistSupported=!0,I.add("login succeeded"),t.fire(N)):(I.add("login failed"),localStorage.clear(),t.doclistSupported=!1,t.fire(N))})}},{key:"setUserData",value:function(e){localStorage.setItem("access-token",e.accessToken)}},{key:"getAccessToken",value:function(){return localStorage.getItem("access-token")}},{key:"getUsername",value:function(){return this.getAccessToken()}},{key:"getServerID",value:function(){return this.serverID}},{key:"fetch",value:function(e){function t(t,n){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e,t){return t.mode="cors",t.cache="no-cache",t.headers||(t.headers={}),t.headers["access-key"]=G.getAccessToken(),console.log("fetching",e,"with options",t),fetch(e,t).then(function(e){if(404===e.status)throw new Error(e.statusText+" "+e.url);return e})})},{key:"getJSON",value:function(e){return this.fetch(e,{method:"GET",headers:{"Content-Type":"application/json"}}).then(function(e){return e.json()})}}]),e}()),B={EXPANDED_CHANGED:"EXPANDED_CHANGED",STRUCTURE_CHANGED:"STRUCTURE_CHANGED",STRUCTURE_ADDED:"STRUCTURE_ADDED",STRUCTURE_REMOVED:"STRUCTURE_REMOVED",PROPERTY_CHANGED:"PROPERTY_CHANGED",CLEAR_DIRTY:"CLEAR_DIRTY",SAVED:"SAVED",DOCUMENT_SWAPPED:"DOCUMENT_SWAPPED"},F={BASE:"https://vr.josh.earth/generaled/api/"};function U(){return F.BASE+"doc/"}function z(){return F.BASE+"asset/"}function H(){return F.BASE+"scripts/"}function V(){return F.BASE+"info"}function W(){return F.BASE+"userinfo"}var K=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this))).genID=function(e){return"".concat(e,"_").concat(Math.floor(1e3*Math.random()*1e3*1e3))},n.save=function(){console.info("saving",n.getSceneRoot());var e={doc:n.getSceneRoot(),type:n.getDocType(),id:n.getDocId()},t=JSON.stringify(e,function(e,t){if("parent"!==e)return t});return console.info("doc is",t),G.fetch(U()+n.docid,{method:"POST",body:t,headers:{"Content-Type":"application/json"}}).then(function(e){return e.json()}).then(function(e){console.log("Success result is",e),w({mode:"edit",doc:n.docid,doctype:n.getDocType()}),n.fire(B.SAVED,!0)}).catch(function(e){return console.log("error",e)})},n.hasChildren=function(e){return e&&e.children&&e.children.length},n.getChildren=function(e){return e.children},n.listeners={},n.expanded_map={},n.docid=null,e.SERVER_URL&&(F.BASE="https://".concat(e.SERVER_URL,"/")),console.log("using server",F.BASE),G.init(),n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"on",value:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}},{key:"fire",value:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].forEach(function(e){return e(t)})}},{key:"off",value:function(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(function(e){return e!==t}))}},{key:"isExpanded",value:function(e){return e.id||(e.id=""+Math.random()),"undefined"===typeof this.expanded_map[e.id]&&(this.expanded_map[e.id]=!0),this.expanded_map[e.id]}},{key:"toggleItemCollapsed",value:function(e){var t=this.isExpanded(e);this.expanded_map[e.id]=!t,this.fire(B.EXPANDED_CHANGED,e)}},{key:"setPropertyValue",value:function(e,t,n){throw new Error("subclass of TreeItemProvider must implement setPropertyValue")}},{key:"setDocument",value:function(e,t){this.root=e,this.docid=t,this.fire(B.STRUCTURE_CHANGED,{provider:this})}},{key:"getDocId",value:function(){return this.docid}},{key:"loadDoc",value:function(e){var t=this;console.log("need to load the doc",e),G.getJSON(U()+e).then(function(e){if(console.log("got the doc",e),e.type!==t.getDocType())throw new Error("incorrect doctype for this provider",e.type);t.setDocument(e.doc,e.id)}).catch(function(e){console.warn("missing doc",e),t.setDocument(t.makeEmptyRoot(),t.genID("doc")),w({mode:"edit",doc:t.docid,doctype:t.getDocType()})})}},{key:"reloadDocument",value:function(){var e=this,t=this.generateSelectionPath(R.getSelection());console.log("got the path",t),G.getJSON(U()+this.docid).then(function(n){if(n.type!==e.getDocType())throw new Error("incorrect doctype for this provider",n.type);e.setDocument(n.doc,n.id),e.fire(B.CLEAR_DIRTY,!0);var r=e.findNodeFromSelectionPath(e.getSceneRoot(),t);console.log("set new selection to ",r),R.setSelection(r)}).catch(function(e){console.warn("couldn't reload the doc",e)})}},{key:"generateSelectionPath",value:function(){throw new Error("generateSelectionPath not implemented")}},{key:"findNodeFromSelectionPath",value:function(){throw new Error("findNodeFromSelectionPath not implemented")}},{key:"makeEmptyRoot",value:function(){throw new Error("makeEmptyRoot() not implemented")}},{key:"getSceneRoot",value:function(){return this.root}},{key:"uploadFile",value:function(e){return new Promise(function(t,n){(new FormData).append("file",e),console.info("filesize is",e.size,e.name);var r=new XMLHttpRequest;r.onreadystatechange=function(){return console.log("ready state = ".concat(r.readyState," status ").concat(r.status))},r.addEventListener("progress",function(e){return console.log("progress")}),r.addEventListener("load",function(e){return t(r.response)}),r.addEventListener("error",function(e){return console.log("error")}),r.addEventListener("abort",function(e){return console.log("abort")});var i=z()+e.name;console.info("uploading to ",i),r.responseType="json",r.open("POST",i),r.setRequestHeader("access-key",G.getAccessToken()),r.send(e)})}}]),t}(function(){function e(){Object(s.a)(this,e)}return Object(c.a)(e,[{key:"on",value:function(e,t){throw new Error("interface 'on' not implemented")}},{key:"off",value:function(e,t){throw new Error("interface 'off' not implemented")}},{key:"fire",value:function(e,t){throw new Error("interface 'fire' not implemented")}},{key:"getSceneRoot",value:function(){throw new Error("interface 'getSceneRoot' not implemented")}},{key:"deleteChild",value:function(e){throw new Error("deleteChild not implemented yet")}},{key:"appendChild",value:function(e,t){throw new Error("appendChild not implemented yet")}},{key:"insertNodeBefore",value:function(e,t){throw new Error("insertNodeBefore() not implemented yet")}},{key:"findNodeById",value:function(e){throw new Error("findNodeById() not implemented yet")}},{key:"findParent",value:function(e){throw new Error("findParent() not implemented yet")}},{key:"hasChildren",value:function(e){throw new Error("hasChildren() not implemented yet")}},{key:"getChildren",value:function(e){throw new Error("getChildren() not implemented yet")}},{key:"isExpanded",value:function(e){throw new Error("interface 'isExpanded' not implemented")}},{key:"calculateContextMenu",value:function(e){throw new Error("calculateContextMenu() not implemented yet")}},{key:"toggleItemCollapsed",value:function(e){throw new Error("toggleItemCollapsed() not implemented yet")}},{key:"getRendererForItem",value:function(e){throw new Error("getRendererForItem() not implemented yet")}},{key:"setPropertyValue",value:function(e,t,n){throw new Error("interface setPropertyValue not implemented")}},{key:"setPropertyValueByName",value:function(e,t,n){throw new Error("interface 'setPropertyValueByName() not implemented'")}},{key:"getProperties",value:function(e){throw new Error("interface 'getProperties()' not implemented")}},{key:"getDocId",value:function(){throw new Error("getDocId() not implemented")}},{key:"getDocType",value:function(){throw new Error("getDocType() not implemented")}},{key:"getApp",value:function(){throw new Error("getApp() not implemented")}},{key:"getTitle",value:function(){throw new Error("getTitle() not implemented")}}]),e}()),Y=function(e){function t(){var e,n;Object(s.a)(this,t);for(var r=arguments.length,i=new Array(r),a=0;a<r;a++)i[a]=arguments[a];return(n=Object(u.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(i)))).keypressed=function(e){13===e.charCode&&n.props.onCommit()},n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){var e=this.props.def;if(e.hasHints()&&e.getHints().multiline)return i.a.createElement("textarea",{value:this.props.value,onChange:this.props.onChange,onBlur:this.props.onBlur});return i.a.createElement("input",{type:"string",value:this.props.value,onChange:this.props.onChange,onKeyPress:this.keypressed,onBlur:this.props.onBlur})}}]),t}(r.Component),X=function(e){var t=e.renderer,n=e.values.map(function(n){return i.a.createElement(p.c,{key:n,onClick:function(t){return e.onSelect(n)}},i.a.createElement(t,{value:n,def:e.def,obj:e.obj,provider:e.provider}))});return i.a.createElement(p.f,{className:"popup-menu"},n)},Z=function(e){var t="";return"undefined"!==typeof e.value&&null!==e.value&&(t=e.value.toString()),i.a.createElement("span",null,t)},Q=function(e){function t(){var e,n;Object(s.a)(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=Object(u.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(a)))).open=function(e){p.e.show(i.a.createElement(X,{values:n.calculateValues(),renderer:n.calculateRenderer(),onSelect:n.selectValue,provider:n.props.provider}),e.target)},n.selectValue=function(e){p.e.hide(),n.props.onChange(e)},n.renderValue=function(e){var t=n.props.def,r=n.props.obj,a=n.calculateRenderer();return i.a.createElement(a,{value:e,def:t,obj:r,provider:n.props.provider})},n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"calculateRenderer",value:function(){var e=this.props.def,t=this.props.obj;if(!this.props.provider.getRendererForEnum)return Z;var n=this.props.provider.getRendererForEnum(e.getKey(),t);return n||Z}},{key:"calculateValues",value:function(){var e=this.props.provider.getValuesForEnum(this.props.def.getKey(),this.props.obj,this.props.def);return e||(console.log("no values for enum ".concat(this.props.def.getKey())),[])}},{key:"render",value:function(){return i.a.createElement("button",{onClick:this.open},this.renderValue(this.props.value))}}]),t}(r.Component),q=function(e){var t="";return"undefined"!==typeof e.value&&(t=e.value.toString()),i.a.createElement("span",null,t)},J=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this,e))).addValue=function(){n.setState({showEditor:!0})},n.enumChanged=function(e){var t=n.props.value.slice();t.push(e),n.props.onChange(t)},n.state={showEditor:!1,value:""},n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"calculateRenderer",value:function(){var e=this.props.def,t=this.props.obj;if(!this.props.provider.getRendererForEnum)return q;var n=this.props.provider.getRendererForEnum(e.key,t);return n||q}},{key:"render",value:function(){var e=this.props.value;return e||(e=[]),i.a.createElement("div",null,this.renderValues(),i.a.createElement("button",{onClick:this.addValue,className:"fa fa-plus"}),this.renderEditor())}},{key:"deleteItem",value:function(e){var t=this.props.value.slice();t=t.filter(function(t){return t!==e}),this.props.onChange(t)}},{key:"renderValues",value:function(){var e=this,t=this.calculateRenderer();return i.a.createElement(p.f,null,this.props.value.map(function(n,r){return i.a.createElement("div",{key:r},i.a.createElement("button",{className:"fa fa-minus",onClick:function(){return e.deleteItem(n)}}),i.a.createElement(t,{value:n,provider:e.props.provider}))}))}},{key:"renderEditor",value:function(){if(!this.state.showEditor)return"";var e=this.props.def,t=this.props.obj;return i.a.createElement(Q,{value:this.state.value,onChange:this.enumChanged,def:e,obj:t,provider:this.props.provider})}}]),t}(r.Component),$={STRING:"string",NUMBER:"number",BOOLEAN:"boolean",ENUM:"enum",COLOR:"color",GROUP:"group"},_=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this,e))).changed=function(e){n.props.def.isType($.STRING)&&(n.setState({value:e.target.value}),n.props.def.isLive()&&n.props.def.setValue(e.target.value)),n.props.def.isType($.NUMBER)&&n.updateNum(e.target.value),n.props.def.isType($.BOOLEAN)&&n.setState({value:e.target.checked})},n.customChanged=function(e){if(n.props.def.isType($.COLOR))return n.colorChanged(e);n.setState({value:e}),n.props.def.setValue(e)},n.keypressed=function(e){13===e.charCode&&n.commit()},n.updateNum=function(e){var t=n.props.def;t.hasHints()&&(t.getHints().hasOwnProperty("min")&&e<t.getHints().min&&(e=t.getHints().min),t.getHints().hasOwnProperty("max")&&e>t.getHints().max&&(e=t.getHints().max)),n.setState({value:e}),isNaN(parseFloat(e))||t.setValue(parseFloat(e))},n.numberKeyDown=function(e){"ArrowUp"===e.key&&e.shiftKey&&(e.preventDefault(),n.updateNum(n.state.value+10)),"ArrowDown"===e.key&&e.shiftKey&&(e.preventDefault(),n.updateNum(n.state.value-10))},n.booleanChanged=function(e){n.setState({value:e.target.checked}),n.props.def.setValue(e.target.checked)},n.enumChanged=function(e){n.setState({value:e}),n.props.def.setValue(e)},n.arrayChanged=function(e){n.setState({value:e}),n.props.def.setValue(e)},n.colorChanged=function(e){n.setState({value:e}),n.props.def.setValue(e)},n.commit=function(){n.props.def.setValue(n.state.value)},n.openColorEditor=function(e){p.e.show(i.a.createElement(T,{onSelect:n.colorChanged,value:n.state.value}),e.target)},n.state={value:e.def.getValue()},n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"componentWillReceiveProps",value:function(e){this.props.def!==e.def&&this.setState({value:e.def.getValue()})}},{key:"shouldComponentUpdate",value:function(e,t){return"group"===e.def.getType()||(this.state.value!==t.value||(this.props.def.getKey()!==e.def.getKey()||this.props.def.getValue()!==e.def.getValue()))}},{key:"render",value:function(){var e=this.props.def,t=R.getSelection(),n=this.props.provider;if(e.isCustom())return this.props.provider.createCustomEditor(this.props.item,e,n,this.state.value,this.customChanged);if(e.isLocked())return i.a.createElement("i",null,e.getValue());if(e.isType($.STRING))return i.a.createElement(Y,{value:this.state.value,onChange:this.changed,onBlur:this.commit,onCommit:this.commit,def:e,obj:t,provider:this.props.provider});if(e.isType($.NUMBER)){var r=1;if(e.hasHints()){var a=e.getHints();a.incrementValue&&(r=a.incrementValue)}return i.a.createElement("input",{type:"number",value:this.state.value,onChange:this.changed,onKeyPress:this.keypressed,onKeyDown:this.numberKeyDown,onBlur:this.commit,step:r})}return e.isType($.BOOLEAN)?i.a.createElement("input",{type:"checkbox",checked:this.state.value,onChange:this.booleanChanged}):e.isType($.ENUM)?i.a.createElement(Q,{value:this.state.value,onChange:this.enumChanged,def:e,obj:t,provider:this.props.provider}):e.isType($.COLOR)?i.a.createElement("button",{style:{backgroundColor:this.state.value},onClick:this.openColorEditor},this.state.value):e.isType("array")?i.a.createElement(J,{value:this.state.value,onChange:this.arrayChanged,def:e,obj:t,provider:this.props.provider}):i.a.createElement("b",null,e.getType(),":",e.getValue())}}]),t}(r.Component),ee=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this,e))).state={selection:null},n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){var e=this;this.h2=function(){return e.setState({selection:R.getSelection()})},this.props.provider.on(B.PROPERTY_CHANGED,this.h2),this.hand=function(t){return e.setState({selection:R.getSelection()})},R.on(j,this.hand)}},{key:"componentWillUnmount",value:function(){R.off(j,this.hand),this.props.provider.off(B.PROPERTY_CHANGED,this.h2)}},{key:"render",value:function(){var e=this,t=this.calculateGroups(this.calculateProps()),n=R.getSelection();return i.a.createElement("ul",{className:"prop-sheet"},t.map(function(t,r){return[i.a.createElement("label",{key:t.getKey()+"-label",title:t.getKey()},t.getName()),e.renderIndeterminate(t,r),i.a.createElement(_,{key:t.getKey()+"-editor",def:t,provider:e.props.provider,item:n})]}))}},{key:"renderIndeterminate",value:function(e,t){return e.isIndeterminate()?i.a.createElement("i",{key:e.getKey()+"-indeterminate",className:"icon fa fa-exclamation-circle"}):""}},{key:"calculateProps",value:function(){var e=R.getFullSelection(),t=e[0],n=this.props.provider,r=n.getProperties(t);return e.forEach(function(e){var t,i;t=r,i=n.getProperties(e),r=t.filter(function(e){return i.find(function(t){return e.key===t.key})})}),r.map(function(t){var r=new te(n,t.key);return e.forEach(function(e){var i=n.getProperties(e).find(function(e){return e.key===t.key});r.addSubProxy(new ne(n,e,i))}),r})}},{key:"calculateGroups",value:function(e){return e.filter(function(e){return e.getType()===$.GROUP}).forEach(function(t){var n=t.getGroupKeys();e=e.filter(function(e){return n.indexOf(e.getKey())<0})}),e}}]),t}(r.Component);var te=function(){function e(t,n){Object(s.a)(this,e),this.provider=t,this.key=n,this.subs=[]}return Object(c.a)(e,[{key:"addSubProxy",value:function(e){this.subs.push(e)}},{key:"first",value:function(){return this.subs[0]}},{key:"getName",value:function(){return this.first().getName()}},{key:"getValue",value:function(){return this.first().getValue()}},{key:"isCustom",value:function(){return this.first().isCustom()}},{key:"hasHints",value:function(){return this.first().hasHints()}},{key:"getHints",value:function(){return this.first().getHints()}},{key:"isLocked",value:function(){return this.first().isLocked()}},{key:"getType",value:function(){return this.first().getType()}},{key:"isType",value:function(e){return this.first().isType(e)}},{key:"isLive",value:function(){return this.first().isLive()}},{key:"getKey",value:function(){return this.key}},{key:"getGroupKeys",value:function(){return this.first().getGroupKeys()}},{key:"setValue",value:function(e){this.subs.forEach(function(t){return t.setValue(e)})}},{key:"isIndeterminate",value:function(){var e=!0,t=this.first().getValue();return this.subs.forEach(function(n){n.getValue()!==t&&(e=!1)}),!e}}]),e}(),ne=function(){function e(t,n,r){Object(s.a)(this,e),this.provider=t,this.item=n,this.def=r}return Object(c.a)(e,[{key:"getKey",value:function(){return this.def.key}},{key:"getName",value:function(){return this.def.name}},{key:"isCustom",value:function(){return this.def.custom}},{key:"isLocked",value:function(){return this.def.locked}},{key:"getType",value:function(){return this.def.type}},{key:"getValue",value:function(){return this.def.value}},{key:"isLive",value:function(){return this.def.live}},{key:"isType",value:function(e){return this.def.type===e}},{key:"setValue",value:function(e){return this.provider.setPropertyValue(this.item,this.def,e)}},{key:"hasHints",value:function(){return this.def.hints}},{key:"getHints",value:function(){return this.def.hints}},{key:"getGroupKeys",value:function(){return this.def.group}},{key:"isIndeterminate",value:function(){return!1}}]),e}();function re(e){return Array.prototype.slice.call(e)}function ie(e,t){return e.createObject(t)}function ae(e,t){var n={};return e.getPropertiesForObject(t).forEach(function(r){n[r]=e.getPropertyValue(t,r)}),n.id=t,n}function oe(e,t){for(var n=e.getArrayLength(t),r=[],i=0;i<n;i++)r.push(e.getElementAt(t,i));return r}function se(e,t,n){e.setProperty(n.id,"parent",t.id);var r=e.getPropertyValue(t.id,"children");e.insertAfter(r,null,n.id)}function ce(e,t,n){e.setProperty(n.id,"parent",t.id);var r=e.getPropertyValue(t.id,"children"),i=e.getArrayLength(r),a=e.getElementAt(r,i-1);e.insertAfter(r,a,n.id)}function ue(e,t){var n=ae(e,t.parent),r=function(e,t,n){return oe(e,t).findIndex(function(e){return e===n})}(e,n.children,t.id);r>=0?e.removeElement(n.children,r):console.error("could not find index for child",t,"in children",n.children)}var le=function(e){return i.a.createElement(p.f,{className:"popup-menu"},e.menu.map(function(e,t){if(e.divider)return i.a.createElement("div",{className:"divider",key:t});var n=!1;return"undefined"===typeof e.enabled&&(n=!0),!0===e.enabled&&(n=!0),i.a.createElement("button",{key:t,disabled:!n,onClick:function(){p.e.hide(),e.fun&&e.fun()}},i.a.createElement("i",{className:"fa fa-"+e.icon})," ",e.title)}))},he=function(e){function t(){var e,n;Object(s.a)(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=Object(u.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(a)))).onSelect=function(e){e.shiftKey?R.addToSelection(n.props.node):R.setSelection(n.props.node)},n.onContextMenu=function(e){if(e.preventDefault(),e.stopPropagation(),R.setSelection(n.props.node),n.props.provider.calculateContextMenu){var t=n.props.provider.calculateContextMenu(n.props.node);p.e.show(i.a.createElement(le,{menu:t}),e.target)}},n.toggleItemCollapsed=function(e){e.preventDefault(),e.stopPropagation(),n.props.provider.toggleItemCollapsed(n.props.node)},n.onDragStart=function(e){n.props.onDragStart(e,n.props.node)},n.onDragOver=function(e){n.props.onDragOver(e,n.props.node)},n.onDragEnd=function(e){n.props.onDragEnd(e,n.props.node)},n.onDrop=function(e){n.props.onDrop(e,n.props.node)},n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){var e="tree-node",t=this.props.node;R.isSelected(t)&&(e+=" selected"),R.getDropTarget()===t&&(e+=" drop-target","parent"===R.getDropType()&&(e+=" drop-parent"));var n="",r=this.props.provider;r.hasChildren(t)?n=r.isExpanded(t)?i.a.createElement("button",{className:"fa fa-caret-down fa-fw borderless",onClick:this.toggleItemCollapsed}):i.a.createElement("button",{className:"fa fa-caret-right fa-fw borderless",onClick:this.toggleItemCollapsed}):n=i.a.createElement("span",{className:"fa fa-fw borderless"});return i.a.createElement("div",{className:e,onClick:this.onSelect,onContextMenu:this.onContextMenu,"data-nodeid":t.id,onDragOver:this.onDragOver,onDrop:this.onDrop},i.a.createElement("span",{style:{width:1.5*this.props.depth+"em"}}),n,r.getRendererForItem(t),i.a.createElement(x,null),this.renderDragBars())}},{key:"renderDragBars",value:function(){return this.props.provider.canBeMoved&&!this.props.provider.canBeMoved(this.props.node)?"":i.a.createElement("span",{className:"drag fa fa-bars",draggable:!0,onDragStart:this.onDragStart,onDragEnd:this.onDragEnd})}}]),t}(r.Component),pe=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this,e))).onDragStart=function(e,t){console.log("starting to drag the item",t),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/html",e.target.parentNode),e.dataTransfer.setDragImage(e.target.parentNode,20,20),e.dataTransfer.dropEffect="move",n.setState({dragTarget:t,internalDrag:!0})},n.onDragOver=function(e,t){if(!n.state.internalDrag)return e.preventDefault(),void(n.props.provider.canAddExternalChild(t,e.dataTransfer)?(R.setDropTarget(t),R.setDropType("parent")):(R.setDropType(null),R.setDropTarget(null)));var r=n.props.provider;if(r.canAddChild(t,n.state.dragTarget))return R.setDropTarget(t),void R.setDropType("parent");r.canBeSibling(t,n.state.dragTarget)?(R.setDropType("sibling"),R.setDropTarget(t)):(R.setDropType(null),R.setDropTarget(null))},n.onDragEnd=function(e,t){if(!n.state.internalDrag)return n.setState({dragTarget:null,internalDrag:!1}),e.preventDefault(),void e.stopPropagation();var r=n.props.provider.getDataGraph();if(n.state.dragTarget&&n.state.dropTarget){var i=ae(r,n.state.dragTarget),a=ae(r,n.state.dropTarget);if(a.id===i.id)return n.setState({dragTarget:null,internalDrag:!1}),void R.setDropTarget(null);if(ue(r,i),"parent"===R.getDropType())r.setProperty(i.id,"parent",a.id),r.insertAfter(a.children,null,i.id);else{var o=ae(r,a.parent);r.setProperty(i.id,"parent",o.id),r.insertAfter(o.children,a.id,i.id)}n.setState({dragTarget:null}),R.setDropTarget(null)}},n.onDrop=function(e,t){n.state.internalDrag||(e.stopPropagation(),e.preventDefault(),n.props.provider.acceptDrop(e,t),n.setState({internalDrag:!1,dragTarget:null}))},n.generateChildren=function(e,t,r){var i=n.props.provider;t.push({node:e,depth:r}),i.hasChildren(e)&&i.isExpanded(e)&&i.getChildren(e).forEach(function(e){n.generateChildren(e,t,r+1)})},n.state={root:n.props.root,dropTarget:null,selection:null,dragTarget:null,internalDrag:!1},n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){var e=this;this.listener=this.props.provider.on(B.EXPANDED_CHANGED,function(t){return e.setState({root:e.props.provider.getSceneRoot()})}),this.props.provider.on(B.STRUCTURE_ADDED,function(t){return e.setState({root:e.props.provider.getSceneRoot()})}),this.props.provider.on(B.STRUCTURE_CHANGED,function(t){return e.setState({root:e.props.provider.getSceneRoot()})}),this.other_listener=R.on(j,function(t){return e.setState({selection:t})}),R.on(D,function(t){return e.setState({dropTarget:R.getDropTarget()})})}},{key:"componentWillUnmount",value:function(){this.props.provider.off(B.EXPANDED_CHANGED,this.listener),R.off(j,this.other_listener)}},{key:"componentWillReceiveProps",value:function(e){e.root&&this.setState({root:e.root})}},{key:"render",value:function(){var e=this;if(!this.state.root)return i.a.createElement("ul",null,"no root yet");var t=[];return this.generateChildren(this.state.root,t,0),i.a.createElement("ul",{className:"tree-table"},t.map(function(t,n){return i.a.createElement(he,{key:n,node:t.node,depth:t.depth,provider:e.props.provider,selection:e.state.selection,onDragStart:e.onDragStart,onDragOver:e.onDragOver,onDragEnd:e.onDragEnd,onDrop:e.onDrop})}))}}]),t}(r.Component),de={PIXEL:{name:"pixel",matches:["pixel","pixels","px"],short:"px"},MILLIMETER:{name:"millimeter",matches:["mm"],short:"mm"}},fe=72;var ve=function(){function e(t,n,r){Object(s.a)(this,e),this.width=t,this.height=n,this.unit=r}return Object(c.a)(e,[{key:"as",value:function(t,n,r){if(this.unit.name===de.MILLIMETER.name&&t.name===de.PIXEL.name){var i=r;return new e(.0393701*this.width*i*n*1,.0393701*this.height*i*n*1,t)}return new e(this.width*n,this.height*n,t)}}]),e}(),me=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this,e))).selectionChanged=function(e){return n.setState({selection:e})},n.redraw=function(){if(n.canvas){var e=n.canvas.getContext("2d"),t=n.props.prov.getPageSize(n.props.prov.getSelectedPage()).as(de.PIXEL,n.props.scale,fe);n.canvas.width=t.width,n.canvas.height=t.height,e.fillStyle="white",e.fillRect(0,0,n.canvas.width,n.canvas.height),e.save(),e.scale(n.props.scale,n.props.scale);var r=n.props.prov.getRawGraph(),i=n.props.prov.getSelectedPage();i&&n.drawPage(e,r,i),e.fillStyle="rgba(0,255,255,0.5)",n.state.hsnap&&e.fillRect(n.state.hsnap.value-1,0,2,n.canvas.height),n.state.vsnap&&e.fillRect(0,n.state.vsnap.value-1,n.canvas.width,2),e.restore()}},n.onClick=function(e){var t=n.toCanvas(e),r=n.findShape(t);r&&n.props.onSelect(r)},n.mouseDown=function(e){n.props.prov.pauseQueue();var t=n.toCanvas(e),r=n.findShape(t);if(r){var i=ae(n.props.prov.getRawGraph(),r);n.setState({pressed:!0,initial:b(i.x,i.y).minus(t),start:t,shape:r})}else{var a=n.props.prov.getSelectedLayer();a&&R.setSelection(a.id)}},n.mouseMove=function(e){if(n.state.pressed){var t=n.toCanvas(e).add(n.state.initial);t=n.snap(t);var r=n.props.prov.getRawGraph();r.process(n.props.prov.cmd.setProperty(n.state.shape,"x",t.x)),r.process(n.props.prov.cmd.setProperty(n.state.shape,"y",t.y))}},n.mouseUp=function(e){n.setState({pressed:!1,hsnap:null,vsnap:null}),n.props.prov.unpauseQueue()},n.state={pressed:!1,selection:null,shape:null,hsnap:null,vsnap:null},e.prov.onRawChange(function(e){-1!==n.props.list&&n.redraw()}),n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){R.on(j,this.selectionChanged),this.props.prov.on(B.STRUCTURE_CHANGED,this.redraw)}},{key:"componentWillUnmount",value:function(){R.off(j,this.selectionChanged),this.props.prov.off(B.STRUCTURE_CHANGED,this.redraw)}},{key:"toCanvas",value:function(e){var t=e.target.getBoundingClientRect();return b(Math.floor((e.clientX-t.left)/this.props.scale),Math.floor((e.clientY-t.top)/this.props.scale))}},{key:"componentDidUpdate",value:function(e){this.redraw()}},{key:"drawPage",value:function(e,t,n){var r=this;oe(t,n.children).forEach(function(n){return r.drawLayer(e,t,ae(t,n))})}},{key:"drawLayer",value:function(e,t,n){var r=this;oe(t,n.children).forEach(function(n){return r.drawShape(e,t,ae(t,n))})}},{key:"drawShape",value:function(e,t,n){var r=this.props.prov.getShapeDef(n.type);r&&r.draw(e,t,n,R.getSelection()===n.id,this.props.prov)}},{key:"isInside",value:function(e,t){var n=ae(this.props.prov.getRawGraph(),t),r=this.props.prov.getShapeDef(n.type);return!!r&&r.isInside(e,n,this.canvas)}},{key:"findShape",value:function(e){var t=this,n=this.props.prov,r=n.getSelectedLayer();if(!r)return null;var i=oe(n.getRawGraph(),r.children);return i.reverse(),i.find(function(n){return t.isInside(e,n)})}},{key:"render",value:function(){var e=this;return i.a.createElement("div",{className:"panel"},i.a.createElement("canvas",{style:{border:"0px solid red"},width:100,height:100,ref:function(t){return e.canvas=t},onClick:this.onClick,onMouseDown:this.mouseDown,onMouseUp:this.mouseUp,onMouseMove:this.mouseMove}))}},{key:"snap",value:function(e){var t={LEFT:"LEFT",RIGHT:"RIGHT",CENTER:"CENTER",TOP:"TOP",MIDDLE:"MIDDLE",BOTTOM:"BOTTOM",NONE:"NONE"},n=[{value:0,type:t.LEFT},{value:320,type:t.CENTER},{value:640,type:t.RIGHT},{value:0,type:t.TOP},{value:240,type:t.MIDDLE},{value:480,type:t.BOTTOM}],r=20;function i(e,n){return n.type===t.LEFT&&Math.abs(e.x-n.value)<r?t.LEFT:n.type===t.CENTER&&Math.abs(e.x+e.width/2-n.value)<r?t.CENTER:n.type===t.RIGHT&&Math.abs(e.x+e.width-n.value)<r?t.RIGHT:t.NONE}function a(e,n){return n.type===t.TOP&&Math.abs(e.y-n.value)<r?t.TOP:n.type===t.MIDDLE&&Math.abs(e.y+e.height/2-n.value)<r?t.MIDDLE:n.type===t.BOTTOM&&Math.abs(e.y+e.height-n.value)<r?t.BOTTOM:t.NONE}var o=ae(this.props.prov.getRawGraph(),this.state.shape),s=this.props.prov.getShapeDef(o.type),c=null,u=null;if(s)for(var l=s.getBounds(e,o,this.canvas),h=0;h<n.length;h++){var p=n[h],d=i(l,p);d===t.LEFT&&(e.x=p.value),d===t.CENTER&&(e.x=p.value-l.width/2),d===t.RIGHT&&(e.x=p.value-l.width);var f=a(l,p);f===t.TOP&&(e.y=p.value),f===t.MIDDLE&&(e.y=p.value-l.height/2),f===t.BOTTOM&&(e.y=p.value-l.height),d!==t.NONE&&(c=p),f!==t.NONE&&(u=p)}return this.setState({hsnap:c,vsnap:u}),e}}]),t}(r.Component),ye=n(23),ge=ye.SET_PROPERTY,be=ye.CREATE_PROPERTY,we=ye.DELETE_PROPERTY,Oe=ye.CREATE_OBJECT,ke=ye.DELETE_OBJECT,Se=ye.INSERT_ELEMENT,Ae=ye.DELETE_ELEMENT,xe=function(){function e(t){Object(s.a)(this,e),this.graph=t,this.history=[],this.current=-1}return Object(c.a)(e,[{key:"submit",value:function(e){this.history.push(e),this.current=this.history.length-1}},{key:"canUndo",value:function(){return this.current>=0}},{key:"canRedo",value:function(){return this.current<this.history.length-1}},{key:"undo",value:function(){var e=this.history[this.current];if(this.current--,e.type!==ge)if(e.type!==be)if(e.type!==Oe){if(e.type!==Se)throw new Error("undo for type not supported: ".concat(e.type));var t={type:Ae,host:this.graph.getHostId(),seq:this.graph.nextSeq(),timestamp:Date.now(),array:e.array,entry:e.entryid};this.graph.process(t)}else{var n={type:ke,host:this.graph.getHostId(),seq:this.graph.nextSeq(),timestamp:Date.now(),id:e.id};this.graph.process(n)}else{var r={type:we,host:this.graph.getHostId(),seq:this.graph.nextSeq(),timestamp:Date.now(),object:e.object,name:e.name};this.graph.process(r)}else{if(!e.prevValue)return void console.warn("undoing set property without a previous value!",e);var i={type:ge,host:this.graph.getHostId(),seq:this.graph.nextSeq(),timestamp:Date.now(),object:e.object,name:e.name,value:e.prevValue};this.graph.process(i)}}},{key:"redo",value:function(){this.current++;var e=this.history[this.current];if(e.type!==ge)if(e.type!==be)if(e.type!==Oe){if(e.type!==Se)throw new Error("redo for type not supported: ".concat(e.type));console.log("redoing",e);var t={type:e.type,host:e.host,seq:this.graph.nextSeq(),timestamp:Date.now(),array:e.array,value:e.value,entryid:this.graph.makeGUID(),prev:-1};this.graph.process(t)}else{var n={type:e.type,host:e.host,seq:this.graph.nextSeq(),timestamp:Date.now(),id:e.id};this.graph.process(n)}else{var r={type:e.type,host:e.host,seq:this.graph.nextSeq(),timestamp:Date.now(),object:e.object,name:e.name,value:e.value};this.graph.process(r)}else{var i={type:e.type,host:e.host,seq:this.graph.nextSeq(),timestamp:Date.now(),object:e.object,name:e.name,value:e.value};this.graph.process(i)}}},{key:"dump",value:function(){return this.history.map(function(e,t){return t+" "+e.type+" "+e.name+" => "+e.value})}}]),e}(),Ce=n(23).SET_PROPERTY,Me=function(){function e(t){var n=this;Object(s.a)(this,e),this.onChange=function(e){return n.listeners.push(e)},this.onRawChange=function(e){return n.rawlisteners.push(e)},this.fire=function(e){return n.listeners.forEach(function(t){return t(e)})},this.fireRaw=function(e){return n.rawlisteners.forEach(function(t){return t(e)})},this.getPropertiesForObject=function(e){return n.graph.getPropertiesForObject(e)},this.getArrayLength=function(e){return n.graph.getArrayLength(e)},this.getElementAt=function(e,t){return n.graph.getElementAt(e,t)},this.getHostId=function(){return n.graph.getHostId()},this.graph=t,this.listeners=[],this.rawlisteners=[],this.paused=!1,this.buffer=[],this.first={},this.last={}}return Object(c.a)(e,[{key:"pause",value:function(){this.paused=!0}},{key:"unpause",value:function(){var e=this;this.paused=!1,this.buffer=[],Object.keys(this.last).forEach(function(t){Object.keys(e.last[t]).forEach(function(n){var r=e.last[t][n];r.prevValue=e.first[t][n].value,e.fire(r),e.graph.process(r)})}),this.first={},this.last={}}},{key:"getPropertyValue",value:function(e,t){return this.paused&&this.last[e]&&this.last[e][t]?this.last[e][t].value:this.graph.getPropertyValue(e,t)}},{key:"bufferOp",value:function(e){this.first[e.object]||(this.first[e.object]={}),this.first[e.object][e.name]||(this.first[e.object][e.name]=e),this.last[e.object]||(this.last[e.object]={}),this.last[e.object][e.name]=e,this.buffer.push(e),this.fireRaw(e)}},{key:"process",value:function(e){e.type===Ce&&this.paused?this.bufferOp(e):(this.fire(e),this.graph.process(e))}}]),e}(),Ee=n(27),je=n(31),De=n.n(je);var Re={publishKey:"pub-c-1cba58da-c59a-4b8b-b756-09e9b33b1edd",subscribeKey:"sub-c-39263f3a-f6fb-11e7-847e-5ef6eb1f4733"},Pe=function(){function e(t,n){var r=this;if(Object(s.a)(this,e),!t)throw new Error("created PubnubSyncWrapper without a provider");if(!n)throw new Error("created PubnubSyncWrapper without a graph");this.paused=!1,this.buffer=[],this.provider=t,n.onChange(function(e){return r.handleGraphChange(e)}),this.pubnub=new De.a(Re)}return Object(c.a)(e,[{key:"calculateChannelName",value:function(){return"metadoc-docupdate-"+this.provider.getDocId()+"_"+G.getServerID()}},{key:"calculateLoggerChannelName",value:function(){return"metadoc-log-"+this.provider.getDocId()+"_"+G.getServerID()}},{key:"start",value:function(){var e=this;this.pubnub.addListener({status:function(t){"PNSubscribeOperation"===t.operation&&"PNConnectedCategory"===t.category&&e.sendHistoryRequest()},message:function(t){return e.handleMessage(t)}}),this.pubnub.subscribe({channels:[this.calculateChannelName(),this.calculateLoggerChannelName()]})}},{key:"pause",value:function(){this.paused=!0}},{key:"unpause",value:function(){var e=this;this.paused=!1,this.buffer.forEach(function(t){return e.sendMessage(t)}),this.buffer=[]}},{key:"shutdown",value:function(){this.pubnub.unsubscribe({channels:[this.calculateChannelName()]}),this.pubnub.stop()}},{key:"sendMessage",value:function(e){var t,n;console.log("PN_SEND:",(n="".concat((t=e).type," ").concat(t.uuid," |  "),t.name&&(n+="".concat(t.name," = ").concat(t.value,"  prev = ").concat(t.prevValue)),n)),this.pubnub.publish({channel:this.calculateChannelName(),message:e},function(e,t){})}},{key:"handleGraphChange",value:function(e){var t=this.provider.getDataGraph().getHostId();if(e.host===t)return this.paused?this.buffer.push(e):void this.sendMessage(e)}},{key:"sendHistoryRequest",value:function(){this.pubnub.publish({channel:this.calculateChannelName(),message:{type:"GET_HISTORY",host:this.provider.getDataGraph().getHostId()}})}},{key:"handleGetHistory",value:function(){var e=this.provider.getDataGraph(),t=e.getHistory().slice();console.log(t);for(var n=0;t.length>0;){if(n>100){console.log("breaking out. possible infinite loop");break}n++;var r=t.splice(0,30);console.log("sending",r.length,r),this.pubnub.publish({channel:this.calculateChannelName(),message:{type:"SEND_HISTORY",host:e.getHostId(),history:r}},function(e,t){console.log("published",e,t)})}}},{key:"handleReceiveHistory",value:function(e){var t=this;e.history.forEach(function(e){return t.provider.getDataGraph().process(e)})}},{key:"handleMessage",value:function(e){if(!this.paused){if(e.channel!==this.calculateLoggerChannelName()){var t=this.provider.getDataGraph();if("GET_HISTORY"===e.message.type)return e.message.host!==t.getHostId()?this.handleGetHistory():void 0;if("SEND_HISTORY"===e.message.type)return e.message.host!==t.getHostId()?this.handleReceiveHistory(e.message):void 0;var n=e.message;return n.host?n.timestamp?void(n.host&&n.host===t.getHostId()||(console.log("REMOTE",n),t.process(n))):console.error("received a message without a timestamp",n):console.log("received a message without a host",n)}var r;e.publisher!==this.pubnub.getUUID()&&(e.message.length?(r=console).log.apply(r,["REMOTE LOGGER"].concat(Object(Ee.a)(e.message))):console.log("REMOTE LOGGER",e.message))}}},{key:"getLogger",value:function(){return new Le(this.provider.getDocId(),this.pubnub)}}]),e}(),Le=function(){function e(t,n){Object(s.a)(this,e),this.count=0,this.docid=t,this.pubnub=n||new De.a(Re)}return Object(c.a)(e,[{key:"calculateLoggerChannelName",value:function(){return"metadoc-log-"+this.docid+"_"+G.getServerID()}},{key:"log",value:function(){var e;(e=console).log.apply(e,["LOGGER"].concat(Array.prototype.slice.call(arguments))),this.pubnub.publish({channel:this.calculateLoggerChannelName(),message:Array.from(arguments).concat(this.count++)})}},{key:"error",value:function(){var e;(e=console).log.apply(e,["LOGGER ERROR"].concat(Array.prototype.slice.call(arguments))),this.pubnub.publish({channel:this.calculateLoggerChannelName(),message:Array.from(arguments).concat(this.count++)})}}]),e}(),Te=function(){function e(){Object(s.a)(this,e)}return Object(c.a)(e,[{key:"log",value:function(){var e;(e=console).log.apply(e,["DUMMY LOGGER"].concat(Array.prototype.slice.call(arguments)))}},{key:"error",value:function(){var e;(e=console).log.apply(e,["DUMMY LOGGER ERROR"].concat(Array.prototype.slice.call(arguments)))}}]),e}(),Ie=function(e){function t(){var e,n;Object(s.a)(this,t);for(var r=arguments.length,i=new Array(r),a=0;a<r;a++)i[a]=arguments[a];return(n=Object(u.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(i)))).clickedScrim=function(e){e.target===n.scrim&&n.props.onScrimClick&&n.props.onScrimClick(e)},n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){var e=this;if(!this.props.visible)return i.a.createElement("div",null);var t={};return this.props.width&&(t.width=this.props.width),this.props.height&&(t.height=this.props.height),i.a.createElement("div",{className:"ac-dialog-scrim",ref:function(t){return e.scrim=t},onClick:this.clickedScrim},i.a.createElement("div",{className:"ac-dialog-body",style:t},this.props.children))}}]),t}(r.Component),Ne=function(e){function t(){var e,n;Object(s.a)(this,t);for(var r=arguments.length,i=new Array(r),a=0;a<r;a++)i[a]=arguments[a];return(n=Object(u.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(i)))).cancel=function(){p.b.hide()},n.okay=function(){p.b.hide(),n.props.provider.createNewDocument(n.props.docid)},n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){return i.a.createElement(Ie,{visible:!0,onScrimClick:this.cancel},i.a.createElement(p.f,{grow:!0},i.a.createElement("h3",null,'Document "',i.a.createElement("b",null,this.props.docid),'" not found'),i.a.createElement(p.f,{grow:!0},"Create a new document?"),i.a.createElement(p.c,null,i.a.createElement("button",{onClick:this.cancel},"cancel"),i.a.createElement("button",{onClick:this.okay},"okay"))))}}]),t}(r.Component),Ge=n(23),Be=Ge.DocGraph,Fe=Ge.CommandGenerator;var Ue=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this,e))).getDocTitle=function(){return"untitled"},n.getDocHistory=function(){return n.getDataGraph().getHistory()},n.getDocGraph=function(){var e=n.getDataGraph().getObjectByProperty("type","root");return function e(t,n){var r=t.getPropertiesForObject(n),i={};return r.forEach(function(r){i[r]=t.getPropertyValue(n,r),"children"===r&&(i.children=oe(t,i[r]).map(function(n){return e(t,n)}))}),i.id=n,i}(n.getDataGraph(),e)},n.onRawChange=function(e){return n.rawlisteners.push(e)},n.getRawGraph=function(){return n.coalescer},n.getDataGraph=function(){return n.syncdoc},n.getSceneRoot=function(){return n.getDataGraph().getObjectByProperty("type","root")},n.hasChildren=function(e){return e&&n.getDataGraph().hasPropertyValue(e,"children")},n.getChildren=function(e){var t=n.getDataGraph();return oe(t,t.getPropertyValue(e,"children"))},n.isExpanded=function(e){return"undefined"===typeof n.expanded[e]&&(n.expanded[e]=!0),n.expanded[e]},n.save=function(e){e&&e.preventDefault();var t={history:n.getDocHistory(),type:n.getDocType(),id:n.getDocId(),graph:n.getDocGraph(),title:n.getDocTitle()},r=JSON.stringify(t);I.add("saving");var i={type:n.getDocType(),title:n.getDocTitle()},a=U()+n.getDocId()+"?"+O(i);return console.log("saving ".concat(r.length," chars to ").concat(a),t),G.fetch(a,{method:"POST",body:r,headers:{"Content-Type":"application/json"}}).then(function(e){return e.json()}).then(function(e){console.log("got back result",e),w({mode:n.mode,doc:n.getDocId(),doctype:n.getDocType()}),I.add(e.message),n.fire(B.SAVED,!0)}).catch(function(e){return console.log("error",e)})},n.docLoaded=function(){return Promise.resolve()},n.toggleConnected=function(){n.connected=!n.connected,n.pubnub&&(n.connected?n.pubnub.unpause():n.pubnub.pause()),n.fire("CONNECTED",n.connected)},n.isConnected=function(){return n.connected},n.pauseQueue=function(){return n.coalescer.pause()},n.unpauseQueue=function(){return n.coalescer.unpause()},n.performUndo=function(e){e&&e.preventDefault&&e.preventDefault(),n.undoqueue.canUndo()?n.undoqueue.undo():console.warn("at beginnning of the undo queue")},n.performRedo=function(e){e&&e.preventDefault&&e.preventDefault(),n.undoqueue.canRedo()&&n.undoqueue.redo()},n.options=e||{},n.mode=e.mode||"edit",n.datalisteners=[],n.rawlisteners=[],n.expanded={},e.doc?n.loadDoc(e.doc):n.createNewDocument(),n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"toggleItemCollapsed",value:function(e){var t=this.isExpanded(e);this.expanded[e]=!t,this.fire(B.EXPANDED_CHANGED,e)}},{key:"setPropertyValue",value:function(e,t,n){var r=this.cmd.setProperty(e,t.key,n);r.prevValue=t.value,this.getRawGraph().process(r),this.fire(B.PROPERTY_CHANGED,{provider:this,child:e,propKey:t.key,oldValue:t.value,newValue:n})}},{key:"loadDoc",value:function(e){var t=this;return G.getJSON(U()+e).then(function(n){if(console.log("got the payload",n),!n.id)return t.showMissingDocDialog(e);var r=t.makeDocFromServerHistory(n.history);t.setupDocFlow(r,e)}).catch(function(n){console.error("there was an error loading doc",e,n);var r=new Be;t.makeEmptyRoot(r),t.setupDocFlow(r,t.genID("doc"))})}},{key:"createNewDocument",value:function(e){e||(e=this.genID("doc"));var t=new Be;this.makeEmptyRoot(t),this.setupDocFlow(t,e)}},{key:"setupDocFlow",value:function(e,t){var n=this;this.pubnub&&this.pubnub.shutdown(),this.pubnub=null,this.syncdoc=e,this.cmd=new Fe(this.syncdoc),this.root=this.getSceneRoot(),this.docid=t,this.undoqueue=new xe(e),this.coalescer=new Me(this.syncdoc),this.coalescer.onChange(function(e){return n.undoqueue.submit(e)}),this.coalescer.onRawChange(function(e){return n.rawlisteners.forEach(function(t){return t(e)})}),this.syncdoc.onChange(function(e){return n.rawlisteners.forEach(function(t){return t(e)})}),this.syncdoc.onChange(function(e){n.fire(B.STRUCTURE_CHANGED,{provider:n}),n.fire(B.PROPERTY_CHANGED,{provider:n})}),this.fire(B.STRUCTURE_CHANGED,{provider:this}),this.fire(B.CLEAR_DIRTY,!0),R.clearSelection(),this.pubnub=new Pe(this,this.syncdoc),this.pubnub.unpause(),this.pubnub.start(),this.docLoaded().then(function(){n.fire(B.DOCUMENT_SWAPPED,{provider:n}),w({mode:n.mode,doc:n.getDocId(),doctype:n.getDocType()}),n.connected=!0,n.fire("CONNECTED",n.connected)})}},{key:"reloadDocument",value:function(){var e=this;return G.getJSON(U()+this.docid).then(function(t){if(t.type!==e.getDocType())throw new Error("incorrect doctype for this provider",t.type);var n=e.makeDocFromServerHistory(t.history);e.setupDocFlow(n,e.docid)}).catch(function(t){console.error("couldn't reload the doc",t);var n=new Be;e.makeEmptyRoot(n),e.setupDocFlow(n,e.genID("doc"))})}},{key:"duplicateDocument",value:function(){var e=this,t=this.genID("doc");this.save().then(function(){return e.docid=t,e.setDocTitle("copy of "+e.getDocTitle()),e.save()}).then(function(){return I.add("duplicating doc"),e.loadDoc(t)})}},{key:"makeDocFromServerHistory",value:function(e){var t=new Be;return e.forEach(function(e){return t.process(e)}),t}},{key:"showMissingDocDialog",value:function(e){p.b.show(i.a.createElement(Ne,{docid:e,provider:this}))}}]),t}(K),ze=function(){function e(){var t=this;Object(s.a)(this,e),this.keyDown=function(n){var r=t.bindings.filter(function(e){return e.key===n.keyCode}).filter(function(t){var r=!0;return t.modifiers.forEach(function(t){t!==e.MODIFIERS.COMMAND||n.metaKey||(r=!1),t!==e.MODIFIERS.SHIFT||n.shiftKey||(r=!1)}),n.shiftKey&&!t.modifiers.some(function(t){return t===e.MODIFIERS.SHIFT})&&(r=!1),r});r.length>0&&t.dispatchEvents(r,n)},this.bindings=[],this.listeners={}}return Object(c.a)(e,[{key:"addKeyBinding",value:function(e){this.bindings.push(e)}},{key:"addListener",value:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}},{key:"attachKeyEvents",value:function(e){e.addEventListener("keydown",this.keyDown)}},{key:"dispatchEvents",value:function(e,t){var n=this;e.forEach(function(e){n.listeners[e.id]&&n.listeners[e.id].forEach(function(e){return e?e(t):null})})}}]),e}();ze.KEYS={S:83,Z:90,C:67,V:86,X:88,LEFT_ARROW:37,RIGHT_ARROW:39},ze.MODIFIERS={COMMAND:"COMMAND",SHIFT:"SHIFT"};var He=function(){function e(){Object(s.a)(this,e)}return Object(c.a)(e,[{key:"make",value:function(e,t){return ae(e,e.createObject({type:"rect",title:"second rect",x:100,y:100,rx:20,ry:20,width:100,height:100,fillColor:"#ff00ff",parent:t.id}))}},{key:"draw",value:function(e,t,n,r){if(e.fillStyle="gray",e.fillStyle=n.fillColor,n.rx>0||n.ry>0){var i={x:n.x,y:n.y},a={x:n.x+n.width,y:n.y},o={x:n.x+n.width,y:n.y+n.height},s={x:n.x,y:n.y+n.height};e.beginPath(),e.moveTo(i.x+n.rx,i.y),e.lineTo(a.x-n.rx,a.y),e.quadraticCurveTo(a.x,a.y,a.x,a.y+n.ry),e.lineTo(o.x,o.y-n.ry),e.quadraticCurveTo(o.x,o.y,o.x-n.rx,o.y),e.lineTo(s.x+n.rx,s.y),e.quadraticCurveTo(s.x,s.y,s.x,s.y-n.ry),e.lineTo(i.x,i.y+n.ry),e.quadraticCurveTo(i.x,i.y,i.x+n.rx,i.y),e.closePath(),e.fill()}else e.fillRect(n.x,n.y,n.width,n.height);r&&(e.strokeStyle="red",e.strokeRect(n.x+.5,n.y+.5,n.width,n.height))}},{key:"isInside",value:function(e,t){return!(e.x<t.x)&&(!(e.x>t.x+t.width)&&(!(e.y<t.y)&&!(e.y>t.y+t.height)))}},{key:"getBounds",value:function(e,t){return{x:e.x,y:e.y,width:t.width,height:t.height}}},{key:"toSVGString",value:function(e){return'<rect x="'.concat(e.x,'" y="').concat(e.y,'" width="').concat(e.width,'" height="').concat(e.height,'" fill="').concat(e.fillColor,'"/>')}}]),e}(),Ve=function(){function e(){Object(s.a)(this,e)}return Object(c.a)(e,[{key:"make",value:function(e,t){return ae(e,ie(e,{type:"circle",title:"circle",x:100,y:100,radius:50,fillColor:"#ffff00",parent:t.id}))}},{key:"draw",value:function(e,t,n,r){e.fillStyle="gray",e.fillStyle=n.fillColor,e.beginPath(),e.arc(n.x,n.y,n.radius,0,2*Math.PI),e.fill(),r&&(e.strokeStyle="red",e.strokeRect(n.x-n.radius+.5,n.y-n.radius+.5,2*n.radius,2*n.radius))}},{key:"isInside",value:function(e,t){return Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2)<Math.pow(t.radius,2)}},{key:"getBounds",value:function(e,t,n){return{x:e.x,y:e.y,width:2*t.radius,height:2*t.radius}}},{key:"toSVGString",value:function(e){return'<circle cx="'.concat(e.x,'" cy="').concat(e.y,'" r="').concat(e.radius,'" fill="').concat(e.fillColor,'"/>')}}]),e}(),We=function(){function e(){Object(s.a)(this,e)}return Object(c.a)(e,[{key:"make",value:function(e,t){return ae(e,e.createObject({type:"text",title:"text",text:"title text",horizontalAlign:qe.CENTER,verticalAlign:Qe.BASELINE,autoFit:!0,fontSize:30,fontFamily:Je.SANSSERIF,fontWeight:$e.NORMAL,fontStyle:_e.NORMAL,x:100,y:100,width:200,height:120,fillColor:"#ff00ff",parent:t.id}))}},{key:"draw",value:function(e,t,n,r){var i=this.calculateLines(n,e),a=i.lines,o=i.size_px,s=i.total_height,c=i.total_width;a.forEach(function(e,t){var r=a.length*o;e.xoff=0,n.horizontalAlign===qe.LEFT&&(e.xoff=0),n.horizontalAlign===qe.CENTER&&(e.xoff=(c-e.width)/2),n.horizontalAlign===qe.RIGHT&&(e.xoff=c-e.width),n.verticalAlign===Qe.TOP&&(e.yoff=0),n.verticalAlign===Qe.CENTER&&(e.yoff=(s-r)/2),n.verticalAlign===Qe.BASELINE&&(e.yoff=s-r),n.verticalAlign===Qe.BOTTOM&&(e.yoff=s-r),e.yoff+=(t+1)*e.height}),e.fillStyle=n.fillColor,a.forEach(function(t,r){return e.fillText(t.text,n.x+t.xoff,n.y+t.yoff)}),r&&(e.strokeStyle="red",e.strokeRect(n.x+.5,n.y+.5,c,s))}},{key:"calculateLines",value:function(e,t){var n=parseFloat(e.fontSize);t.font="normal ".concat(n,"px sans-serif");var r=e.text.split("\n").map(function(e){return{text:e,width:t.measureText(e).width,height:n}}),i=0,a=0;return e.autoFit?(i=r.reduce(function(e,t){return Math.max(e,t.width)},0),a=r.reduce(function(e,t){return e+t.height},0)):(i=e.width,a=e.height),{total_width:i,total_height:a,lines:r,size_px:n}}},{key:"insideRect",value:function(e,t,n,r,i){return!(e.x<t)&&(!(e.x>t+r)&&(!(e.y<n)&&!(e.y>n+i)))}},{key:"isInside",value:function(e,t,n){var r=n.getContext("2d"),i=this.calculateLines(t,r),a=i.total_width,o=i.total_height;return this.insideRect(e,t.x,t.y,a,o)}},{key:"getBounds",value:function(e,t,n){var r=n.getContext("2d"),i=this.calculateLines(t,r),a=i.total_width,o=i.total_height;return{x:e.x,y:e.y,width:a,height:o}}},{key:"toSVGString",value:function(e){return'<text x="'.concat(e.x,'" y="').concat(e.y,'"\n                     fill="').concat(e.fillColor,'" fontSize="').concat(e.fontSize,'"\n                     fontFamily="').concat(e.fontFamily,'"\n                >').concat(e.text,"</text>")}}]),e}(),Ke=function(){function e(){Object(s.a)(this,e)}return Object(c.a)(e,[{key:"make",value:function(e,t){return ae(e,e.createObject({type:"image",title:"image",x:100,y:100,width:50,height:50,asset:0,parent:t.id}))}},{key:"draw",value:function(e,t,n,r,i){if(n.asset){var a=t.getPropertyValue(n.asset,"src");i.isImageCached(a)?e.drawImage(i.getCachedImage(a),n.x,n.y,n.width,n.height):(i.requestImageCache(a),e.fillStyle="aqua",e.fillRect(n.x,n.y,n.width,n.height))}else e.fillStyle="aqua",e.fillRect(n.x,n.y,n.width,n.height);r&&(e.strokeStyle="red",e.strokeRect(n.x+.5,n.y+.5,n.width,n.height))}},{key:"isInside",value:function(e,t){return!(e.x<t.x)&&(!(e.x>t.x+t.width)&&(!(e.y<t.y)&&!(e.y>t.y+t.height)))}},{key:"toSVGString",value:function(e,t){console.log("serializing",e,t);var n=ae(t.getDataGraph(),e.asset);return console.log("asset is",n),'<image xlinkHref="'.concat(n.src,'"\n                      width="').concat(e.width,'" height="').concat(e.height,'"\n        />')}}]),e}(),Ye={title:{key:"title",name:"Title",type:$.STRING},x:{key:"x",name:"X",type:$.NUMBER},y:{key:"y",name:"Y",type:$.NUMBER},rx:{key:"rx",name:"RX",type:$.NUMBER},ry:{key:"ry",name:"RY",type:$.NUMBER},fillColor:{key:"fillColor",name:"color",type:$.COLOR,custom:!0},width:{key:"width",name:"Width",type:$.NUMBER},height:{key:"height",name:"Height",type:$.NUMBER},radius:{key:"radius",name:"Radius",type:$.NUMBER},text:{key:"text",name:"text",type:$.STRING,hints:{multiline:!0}},src:{key:"src",name:"src",type:$.STRING},asset:{key:"asset",name:"asset",type:$.ENUM},subtype:{key:"subtype",name:"kind",type:$.STRING,locked:!0},format:{key:"format",name:"format",type:$.STRING,locked:!0},autoFit:{key:"autoFit",name:"Size to Fit",type:$.BOOLEAN,locked:!1},fontSize:{key:"fontSize",name:"Font Size",type:$.STRING,locked:!1},fontFamily:{key:"fontFamily",name:"Font Family",type:$.ENUM,locked:!0},fontWeight:{key:"fontWeight",name:"Font Weight",type:$.ENUM,locked:!0},fontStyle:{key:"fontStyle",name:"Font Style",type:$.ENUM,locked:!0},horizontalAlign:{key:"horizontalAlign",name:"H Align",type:$.ENUM,locked:!1},verticalAlign:{key:"verticalAlign",name:"V Align",type:$.ENUM,locked:!1},pageSize:{key:"pageSize",name:"Size",type:$.STRING,locked:!1,custom:!0}},Xe={rect:new He,circle:new Ve,text:new We,image:new Ke},Ze={page:"file",layer:"sticky-note",rect:"square",circle:"circle",text:"font",plane:"plane",image:"image",model:"cube",cut:"cut",copy:"copy",paste:"paste",delete:"close"},Qe={TOP:"TOP",BASELINE:"BASELINE",CENTER:"CENTER",BOTTOM:"BOTTOM"},qe={LEFT:"LEFT",CENTER:"CENTER",RIGHT:"RIGHT"},Je={SERIF:"serif",SANSSERIF:"sans-serif",MONOSPACE:"monospace"},$e={NORMAL:"normal",BOLD:"bold"},_e={NORMAL:"normal",ITALIC:"italic",OBLIQUE:"oblique"};function et(e){return"rect"===e||("circle"===e||("text"===e||"image"===e))}var tt,nt,rt,it,at,ot,st,ct,ut,lt,ht,pt,dt=n(1),ft=function(){function e(){Object(s.a)(this,e)}return Object(c.a)(e,[{key:"updateProperty",value:function(e,t,n,r){if("tx"===n.name&&(e.position.x=parseFloat(n.value)),"ty"===n.name&&(e.position.y=parseFloat(n.value)),"tz"===n.name&&(e.position.z=parseFloat(n.value)),"rx"===n.name&&(e.rotation.x=parseFloat(n.value)),"ry"===n.name&&(e.rotation.y=parseFloat(n.value)),"rz"===n.name&&(e.rotation.z=parseFloat(n.value)),"sx"===n.name&&(e.scale.x=parseFloat(n.value)),"sy"===n.name&&(e.scale.y=parseFloat(n.value)),"sz"===n.name&&(e.scale.z=parseFloat(n.value)),"visible"===n.name&&(e.visible=n.value),"color"===n.name){var i=n.value;return 0===i.indexOf("#")&&(i=i.substring(1)),void e.material.color.set(parseInt(i,16))}}},{key:"reset",value:function(e,t){e.position.set(t.tx,t.ty,t.tz),e.visible=t.visible}}]),e}(),vt=0,mt=function(e){function t(){return Object(s.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create cube w/ missing parent");return ae(e,e.createObject({type:qt.cube,title:"cube "+vt++,visible:!0,width:.3,height:.3,depth:.3,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,color:"#00ff00",children:e.createArray(),asset:Yt.id,parent:t.id}))}},{key:"makeNode",value:function(e,t){var n=new dt.Mesh(new dt.BoxGeometry(e.width,e.height,e.depth),new dt.MeshLambertMaterial({color:e.color}));return n.name=e.title,n.userData.clickable=!0,n.position.set(e.tx,e.ty,e.tz),n.rotation.set(e.rx,e.ry,e.rz),n.scale.set(e.sx,e.sy,e.sz),n.visible=e.visible,this.attachAsset(n,e,t),n}},{key:"updateProperty",value:function(e,n,r,i){if("width"!==r.name&&"height"!==r.name&&"depth"!==r.name)return r.name===Zt.asset.key?this.attachAsset(e,n,i):Object(d.a)(Object(l.a)(t.prototype),"updateProperty",this).call(this,e,n,r,i);e.geometry=new dt.BoxGeometry(n.width,n.height,n.depth)}},{key:"attachAsset",value:function(e,t,n){if(t.asset!==Yt.id){var r=n.assetsManager.getTexture(t.asset);r&&(e.material=new dt.MeshLambertMaterial({color:t.color,side:dt.DoubleSide,map:r}))}else e.material=new dt.MeshLambertMaterial({color:t.color,side:dt.DoubleSide})}}]),t}(ft),yt=function(e){function t(){return Object(s.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create sphere w/ missing parent");return ae(e,e.createObject({type:"sphere",title:"a sphere",visible:!0,radius:.15,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,color:"#0000ff",children:e.createArray(),asset:Yt.id,parent:t.id}))}},{key:"makeNode",value:function(e,t){var n=new dt.Mesh(new dt.SphereBufferGeometry(e.radius),new dt.MeshLambertMaterial({color:e.color}));return n.name=e.title,n.userData.clickable=!0,n.position.set(e.tx,e.ty,e.tz),n.rotation.set(e.rx,e.ry,e.rz),n.scale.set(e.sx,e.sy,e.sz),n.visible=e.visible,this.attachAsset(n,e,t),n}},{key:"updateProperty",value:function(e,n,r,i){return"radius"===r.name&&(e.geometry=new dt.SphereBufferGeometry(r.value)),r.name===Zt.asset.key?this.attachAsset(e,n,i):Object(d.a)(Object(l.a)(t.prototype),"updateProperty",this).call(this,e,n,r,i)}},{key:"attachAsset",value:function(e,t,n){if(t.asset!==Yt.id){var r=n.assetsManager.getTexture(t.asset);r&&(e.material=new dt.MeshLambertMaterial({color:t.color,side:dt.DoubleSide,map:r}))}else e.material=new dt.MeshLambertMaterial({color:t.color,side:dt.DoubleSide})}}]),t}(ft),gt=function(e){function t(){return Object(s.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create plane w/ missing parent");return ae(e,e.createObject({type:"plane",title:"a plane",visible:!0,width:.5,height:.5,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,color:"#ffffff",children:e.createArray(),asset:Yt.id,parent:t.id}))}},{key:"makeNode",value:function(e,t){var n=new dt.Mesh(new dt.PlaneBufferGeometry(e.width,e.height),new dt.MeshLambertMaterial({color:e.color,side:dt.DoubleSide}));return this.attachAsset(n,e,t),n.userData.clickable=!0,n.position.set(e.tx,e.ty,e.tz),n.rotation.set(e.rx,e.ry,e.rz),n.scale.set(e.sx,e.sy,e.sz),n.visible=e.visible,n}},{key:"updateProperty",value:function(e,n,r,i){return"width"===r.name&&(e.geometry=new dt.PlaneBufferGeometry(r.value,n.height)),"height"===r.name&&(e.geometry=new dt.PlaneBufferGeometry(n.width,r.value)),r.name===Zt.asset.key?this.attachAsset(e,n,i):Object(d.a)(Object(l.a)(t.prototype),"updateProperty",this).call(this,e,n,r,i)}},{key:"attachAsset",value:function(e,t,n){if(t.asset!==Yt.id){var r=n.assetsManager.getTexture(t.asset);r&&(e.material=new dt.MeshLambertMaterial({color:t.color,side:dt.DoubleSide,map:r}))}else e.material=new dt.MeshLambertMaterial({color:t.color,side:dt.DoubleSide})}}]),t}(ft),bt=n(1),wt=function(){function e(e){this.manager=void 0!==e?e:bt.DefaultLoadingManager,this.dracoLoader=null}function t(){var e={};return{get:function(t){return e[t]},add:function(t,n){e[t]=n},remove:function(t){delete e[t]},removeAll:function(){e={}}}}e.prototype={constructor:e,crossOrigin:"anonymous",load:function(e,t,n,r){var i,a=this;i=void 0!==this.resourcePath?this.resourcePath:void 0!==this.path?this.path:bt.LoaderUtils.extractUrlBase(e),a.manager.itemStart(e);var o=function(t){r?r(t):console.error(t),a.manager.itemError(e),a.manager.itemEnd(e)},s=new bt.FileLoader(a.manager);s.setPath(this.path),s.setResponseType("arraybuffer"),s.load(e,function(n){try{a.parse(n,i,function(n){t(n),a.manager.itemEnd(e)},o)}catch(r){o(r)}},n,o)},setCrossOrigin:function(e){return this.crossOrigin=e,this},setPath:function(e){return this.path=e,this},setResourcePath:function(e){return this.resourcePath=e,this},setDRACOLoader:function(e){return this.dracoLoader=e,this},parse:function(e,t,s,c){var d,f={};if("string"===typeof e)d=e;else if(bt.LoaderUtils.decodeText(new Uint8Array(e,0,4))===o){try{f[n.KHR_BINARY_GLTF]=new u(e)}catch(b){return void(c&&c(b))}d=f[n.KHR_BINARY_GLTF].content}else d=bt.LoaderUtils.decodeText(new Uint8Array(e));var v=JSON.parse(d);if(void 0===v.asset||v.asset.version[0]<2)c&&c(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported. Use LegacyGLTFLoader instead."));else{if(v.extensionsUsed)for(var m=0;m<v.extensionsUsed.length;++m){var y=v.extensionsUsed[m],g=v.extensionsRequired||[];switch(y){case n.KHR_LIGHTS_PUNCTUAL:f[y]=new i(v);break;case n.KHR_MATERIALS_UNLIT:f[y]=new a(v);break;case n.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:f[y]=new p(v);break;case n.KHR_DRACO_MESH_COMPRESSION:f[y]=new l(v,this.dracoLoader);break;case n.MSFT_TEXTURE_DDS:f[n.MSFT_TEXTURE_DDS]=new r;break;case n.KHR_TEXTURE_TRANSFORM:f[n.KHR_TEXTURE_TRANSFORM]=new h(v);break;default:g.indexOf(y)>=0&&console.warn('THREE.GLTFLoader: Unknown extension "'+y+'".')}}new F(v,f,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,manager:this.manager}).parse(s,c)}}};var n={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",MSFT_TEXTURE_DDS:"MSFT_texture_dds"};function r(){if(!bt.DDSLoader)throw new Error("THREE.GLTFLoader: Attempting to load .dds texture without importing THREE.DDSLoader");this.name=n.MSFT_TEXTURE_DDS,this.ddsLoader=new bt.DDSLoader}function i(e){this.name=n.KHR_LIGHTS_PUNCTUAL;var t=e.extensions&&e.extensions[n.KHR_LIGHTS_PUNCTUAL]||{};this.lightDefs=t.lights||[]}function a(){this.name=n.KHR_MATERIALS_UNLIT}i.prototype.loadLight=function(e){var t,n=this.lightDefs[e],r=new bt.Color(16777215);void 0!==n.color&&r.fromArray(n.color);var i=void 0!==n.range?n.range:0;switch(n.type){case"directional":(t=new bt.DirectionalLight(r)).target.position.set(0,0,-1),t.add(t.target);break;case"point":(t=new bt.PointLight(r)).distance=i;break;case"spot":(t=new bt.SpotLight(r)).distance=i,n.spot=n.spot||{},n.spot.innerConeAngle=void 0!==n.spot.innerConeAngle?n.spot.innerConeAngle:0,n.spot.outerConeAngle=void 0!==n.spot.outerConeAngle?n.spot.outerConeAngle:Math.PI/4,t.angle=n.spot.outerConeAngle,t.penumbra=1-n.spot.innerConeAngle/n.spot.outerConeAngle,t.target.position.set(0,0,-1),t.add(t.target);break;default:throw new Error('THREE.GLTFLoader: Unexpected light type, "'+n.type+'".')}return t.position.set(0,0,0),t.decay=2,void 0!==n.intensity&&(t.intensity=n.intensity),t.name=n.name||"light_"+e,Promise.resolve(t)},a.prototype.getMaterialType=function(){return bt.MeshBasicMaterial},a.prototype.extendParams=function(e,t,n){var r=[];e.color=new bt.Color(1,1,1),e.opacity=1;var i=t.pbrMetallicRoughness;if(i){if(Array.isArray(i.baseColorFactor)){var a=i.baseColorFactor;e.color.fromArray(a),e.opacity=a[3]}void 0!==i.baseColorTexture&&r.push(n.assignTexture(e,"map",i.baseColorTexture))}return Promise.all(r)};var o="glTF",s=12,c={JSON:1313821514,BIN:5130562};function u(e){this.name=n.KHR_BINARY_GLTF,this.content=null,this.body=null;var t=new DataView(e,0,s);if(this.header={magic:bt.LoaderUtils.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==o)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected. Use LegacyGLTFLoader instead.");for(var r=new DataView(e,s),i=0;i<r.byteLength;){var a=r.getUint32(i,!0);i+=4;var u=r.getUint32(i,!0);if(i+=4,u===c.JSON){var l=new Uint8Array(e,s+i,a);this.content=bt.LoaderUtils.decodeText(l)}else if(u===c.BIN){var h=s+i;this.body=e.slice(h,h+a)}i+=a}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}function l(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=n.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t}function h(){this.name=n.KHR_TEXTURE_TRANSFORM}function p(){return{name:n.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,specularGlossinessParams:["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"],getMaterialType:function(){return bt.ShaderMaterial},extendParams:function(e,t,n){var r=t.extensions[this.name],i=bt.ShaderLib.standard,a=bt.UniformsUtils.clone(i.uniforms),o=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),s=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),c=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),u=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),l=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb;","material.specularRoughness = clamp( 1.0 - glossinessFactor, 0.04, 1.0 );","material.specularColor = specularFactor.rgb;"].join("\n"),h=i.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",o).replace("#include <metalnessmap_pars_fragment>",s).replace("#include <roughnessmap_fragment>",c).replace("#include <metalnessmap_fragment>",u).replace("#include <lights_physical_fragment>",l);delete a.roughness,delete a.metalness,delete a.roughnessMap,delete a.metalnessMap,a.specular={value:(new bt.Color).setHex(1118481)},a.glossiness={value:.5},a.specularMap={value:null},a.glossinessMap={value:null},e.vertexShader=i.vertexShader,e.fragmentShader=h,e.uniforms=a,e.defines={STANDARD:""},e.color=new bt.Color(1,1,1),e.opacity=1;var p=[];if(Array.isArray(r.diffuseFactor)){var d=r.diffuseFactor;e.color.fromArray(d),e.opacity=d[3]}if(void 0!==r.diffuseTexture&&p.push(n.assignTexture(e,"map",r.diffuseTexture)),e.emissive=new bt.Color(0,0,0),e.glossiness=void 0!==r.glossinessFactor?r.glossinessFactor:1,e.specular=new bt.Color(1,1,1),Array.isArray(r.specularFactor)&&e.specular.fromArray(r.specularFactor),void 0!==r.specularGlossinessTexture){var f=r.specularGlossinessTexture;p.push(n.assignTexture(e,"glossinessMap",f)),p.push(n.assignTexture(e,"specularMap",f))}return Promise.all(p)},createMaterial:function(e){var t=new bt.ShaderMaterial({defines:e.defines,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:e.uniforms,fog:!0,lights:!0,opacity:e.opacity,transparent:e.transparent});return t.isGLTFSpecularGlossinessMaterial=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=1,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t.refractionRatio=.98,t.extensions.derivatives=!0,t},cloneMaterial:function(e){var t=e.clone();t.isGLTFSpecularGlossinessMaterial=!0;for(var n=this.specularGlossinessParams,r=0,i=n.length;r<i;r++)t[n[r]]=e[n[r]];return t},refreshUniforms:function(e,t,n,r,i,a){if(!0===i.isGLTFSpecularGlossinessMaterial){var o,s=i.uniforms,c=i.defines;s.opacity.value=i.opacity,s.diffuse.value.copy(i.color),s.emissive.value.copy(i.emissive).multiplyScalar(i.emissiveIntensity),s.map.value=i.map,s.specularMap.value=i.specularMap,s.alphaMap.value=i.alphaMap,s.lightMap.value=i.lightMap,s.lightMapIntensity.value=i.lightMapIntensity,s.aoMap.value=i.aoMap,s.aoMapIntensity.value=i.aoMapIntensity,i.map?o=i.map:i.specularMap?o=i.specularMap:i.displacementMap?o=i.displacementMap:i.normalMap?o=i.normalMap:i.bumpMap?o=i.bumpMap:i.glossinessMap?o=i.glossinessMap:i.alphaMap?o=i.alphaMap:i.emissiveMap&&(o=i.emissiveMap),void 0!==o&&(o.isWebGLRenderTarget&&(o=o.texture),!0===o.matrixAutoUpdate&&o.updateMatrix(),s.uvTransform.value.copy(o.matrix)),i.envMap&&(s.envMap.value=i.envMap,s.envMapIntensity.value=i.envMapIntensity,s.flipEnvMap.value=i.envMap.isCubeTexture?-1:1,s.reflectivity.value=i.reflectivity,s.refractionRatio.value=i.refractionRatio,s.maxMipLevel.value=e.properties.get(i.envMap).__maxMipLevel),s.specular.value.copy(i.specular),s.glossiness.value=i.glossiness,s.glossinessMap.value=i.glossinessMap,s.emissiveMap.value=i.emissiveMap,s.bumpMap.value=i.bumpMap,s.normalMap.value=i.normalMap,s.displacementMap.value=i.displacementMap,s.displacementScale.value=i.displacementScale,s.displacementBias.value=i.displacementBias,null!==s.glossinessMap.value&&void 0===c.USE_GLOSSINESSMAP&&(c.USE_GLOSSINESSMAP="",c.USE_ROUGHNESSMAP=""),null===s.glossinessMap.value&&void 0!==c.USE_GLOSSINESSMAP&&(delete c.USE_GLOSSINESSMAP,delete c.USE_ROUGHNESSMAP)}}}}function d(e,t,n,r){bt.Interpolant.call(this,e,t,n,r)}l.prototype.decodePrimitive=function(e,t){var n=this.json,r=this.dracoLoader,i=e.extensions[this.name].bufferView,a=e.extensions[this.name].attributes,o={},s={},c={};for(var u in a){var l=C[u]||u.toLowerCase();o[l]=a[u]}for(u in e.attributes){l=C[u]||u.toLowerCase();if(void 0!==a[u]){var h=n.accessors[e.attributes[u]],p=k[h.componentType];c[l]=p,s[l]=!0===h.normalized}}return t.getDependency("bufferView",i).then(function(e){return new Promise(function(t){r.decodeDracoFile(e,function(e){for(var n in e.attributes){var r=e.attributes[n],i=s[n];void 0!==i&&(r.normalized=i)}t(e)},o,c)})})},h.prototype.extendTexture=function(e,t){return e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),void 0!==t.texCoord&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),e.needsUpdate=!0,e},d.prototype=Object.create(bt.Interpolant.prototype),d.prototype.constructor=d,d.prototype.copySampleValue_=function(e){for(var t=this.resultBuffer,n=this.sampleValues,r=this.valueSize,i=e*r*3+r,a=0;a!==r;a++)t[a]=n[i+a];return t},d.prototype.beforeStart_=d.prototype.copySampleValue_,d.prototype.afterEnd_=d.prototype.copySampleValue_,d.prototype.interpolate_=function(e,t,n,r){for(var i=this.resultBuffer,a=this.sampleValues,o=this.valueSize,s=2*o,c=3*o,u=r-t,l=(n-t)/u,h=l*l,p=h*l,d=e*c,f=d-c,v=-2*p+3*h,m=p-h,y=1-v,g=m-h+l,b=0;b!==o;b++){var w=a[f+b+o],O=a[f+b+s]*u,k=a[d+b+o],S=a[d+b]*u;i[b]=y*w+g*O+v*k+m*S}return i};var f,v=0,m=1,y=2,g=3,b=4,w=5,O=6,k=(Number,bt.Matrix3,bt.Matrix4,bt.Vector2,bt.Vector3,bt.Vector4,bt.Texture,{5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array}),S={9728:bt.NearestFilter,9729:bt.LinearFilter,9984:bt.NearestMipMapNearestFilter,9985:bt.LinearMipMapNearestFilter,9986:bt.NearestMipMapLinearFilter,9987:bt.LinearMipMapLinearFilter},A={33071:bt.ClampToEdgeWrapping,33648:bt.MirroredRepeatWrapping,10497:bt.RepeatWrapping},x=(bt.BackSide,bt.FrontSide,bt.NeverDepth,bt.LessDepth,bt.EqualDepth,bt.LessEqualDepth,bt.GreaterEqualDepth,bt.NotEqualDepth,bt.GreaterEqualDepth,bt.AlwaysDepth,bt.AddEquation,bt.SubtractEquation,bt.ReverseSubtractEquation,bt.ZeroFactor,bt.OneFactor,bt.SrcColorFactor,bt.OneMinusSrcColorFactor,bt.SrcAlphaFactor,bt.OneMinusSrcAlphaFactor,bt.DstAlphaFactor,bt.OneMinusDstAlphaFactor,bt.DstColorFactor,bt.OneMinusDstColorFactor,bt.SrcAlphaSaturateFactor,{SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16}),C={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},M={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},E={CUBICSPLINE:void 0,LINEAR:bt.InterpolateLinear,STEP:bt.InterpolateDiscrete},j="OPAQUE",D="MASK",R="BLEND",P={"image/png":bt.RGBAFormat,"image/jpeg":bt.RGBFormat};function L(e,t){return"string"!==typeof e||""===e?"":/^(https?:)?\/\//i.test(e)?e:/^data:.*,.*$/i.test(e)?e:/^blob:.*$/i.test(e)?e:t+e}function T(e,t,n){for(var r in n.extensions)void 0===e[r]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[r]=n.extensions[r])}function I(e,t){void 0!==t.extras&&("object"===typeof t.extras?e.userData=t.extras:console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function N(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(var n=0,r=t.weights.length;n<r;n++)e.morphTargetInfluences[n]=t.weights[n];if(t.extras&&Array.isArray(t.extras.targetNames)){var i=t.extras.targetNames;if(e.morphTargetInfluences.length===i.length){e.morphTargetDictionary={};for(n=0,r=i.length;n<r;n++)e.morphTargetDictionary[i[n]]=n}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function G(e){for(var t="",n=Object.keys(e).sort(),r=0,i=n.length;r<i;r++)t+=n[r]+":"+e[n[r]]+";";return t}function B(e){if(e.isInterleavedBufferAttribute){for(var t=e.count,n=e.itemSize,r=e.array.slice(0,t*n),i=0,a=0;i<t;++i)r[a++]=e.getX(i),n>=2&&(r[a++]=e.getY(i)),n>=3&&(r[a++]=e.getZ(i)),n>=4&&(r[a++]=e.getW(i));return new bt.BufferAttribute(r,n,e.normalized)}return e.clone()}function F(e,n,r){this.json=e||{},this.extensions=n||{},this.options=r||{},this.cache=new t,this.primitiveCache={},this.textureLoader=new bt.TextureLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.fileLoader=new bt.FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer")}function U(e,t,n){var r=t.attributes,i=[];function a(t,r){return n.getDependency("accessor",t).then(function(t){e.addAttribute(r,t)})}for(var o in r){var s=C[o]||o.toLowerCase();s in e.attributes||i.push(a(r[o],s))}if(void 0!==t.indices&&!e.index){var c=n.getDependency("accessor",t.indices).then(function(t){e.setIndex(t)});i.push(c)}return I(e,t),Promise.all(i).then(function(){return void 0!==t.targets?function(e,t,n){for(var r=!1,i=!1,a=0,o=t.length;a<o&&(void 0!==(u=t[a]).POSITION&&(r=!0),void 0!==u.NORMAL&&(i=!0),!r||!i);a++);if(!r&&!i)return Promise.resolve(e);var s=[],c=[];for(a=0,o=t.length;a<o;a++){var u=t[a];if(r){var l=void 0!==u.POSITION?n.getDependency("accessor",u.POSITION):e.attributes.position;s.push(l)}i&&(l=void 0!==u.NORMAL?n.getDependency("accessor",u.NORMAL):e.attributes.normal,c.push(l))}return Promise.all([Promise.all(s),Promise.all(c)]).then(function(n){for(var a=n[0],o=n[1],s=0,c=a.length;s<c;s++)e.attributes.position!==a[s]&&(a[s]=B(a[s]));for(s=0,c=o.length;s<c;s++)e.attributes.normal!==o[s]&&(o[s]=B(o[s]));for(s=0,c=t.length;s<c;s++){var u=t[s],l="morphTarget"+s;if(r&&void 0!==u.POSITION){var h=a[s];h.name=l;for(var p=e.attributes.position,d=0,f=h.count;d<f;d++)h.setXYZ(d,h.getX(d)+p.getX(d),h.getY(d)+p.getY(d),h.getZ(d)+p.getZ(d))}if(i&&void 0!==u.NORMAL){var v=o[s];v.name=l;var m=e.attributes.normal;for(d=0,f=v.count;d<f;d++)v.setXYZ(d,v.getX(d)+m.getX(d),v.getY(d)+m.getY(d),v.getZ(d)+m.getZ(d))}}return r&&(e.morphAttributes.position=a),i&&(e.morphAttributes.normal=o),e})}(e,t.targets,n):e})}return F.prototype.parse=function(e,t){var n=this,r=this.json,i=this.extensions;this.cache.removeAll(),this.markDefs(),Promise.all([this.getDependencies("scene"),this.getDependencies("animation"),this.getDependencies("camera")]).then(function(t){var a={scene:t[0][r.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:r.asset,parser:n,userData:{}};T(i,a,r),e(a)}).catch(t)},F.prototype.markDefs=function(){for(var e=this.json.nodes||[],t=this.json.skins||[],n=this.json.meshes||[],r={},i={},a=0,o=t.length;a<o;a++)for(var s=t[a].joints,c=0,u=s.length;c<u;c++)e[s[c]].isBone=!0;for(var l=0,h=e.length;l<h;l++){var p=e[l];void 0!==p.mesh&&(void 0===r[p.mesh]&&(r[p.mesh]=i[p.mesh]=0),r[p.mesh]++,void 0!==p.skin&&(n[p.mesh].isSkinnedMesh=!0))}this.json.meshReferences=r,this.json.meshUses=i},F.prototype.getDependency=function(e,t){var r=e+":"+t,i=this.cache.get(r);if(!i){switch(e){case"scene":i=this.loadScene(t);break;case"node":i=this.loadNode(t);break;case"mesh":i=this.loadMesh(t);break;case"accessor":i=this.loadAccessor(t);break;case"bufferView":i=this.loadBufferView(t);break;case"buffer":i=this.loadBuffer(t);break;case"material":i=this.loadMaterial(t);break;case"texture":i=this.loadTexture(t);break;case"skin":i=this.loadSkin(t);break;case"animation":i=this.loadAnimation(t);break;case"camera":i=this.loadCamera(t);break;case"light":i=this.extensions[n.KHR_LIGHTS_PUNCTUAL].loadLight(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(r,i)}return i},F.prototype.getDependencies=function(e){var t=this.cache.get(e);if(!t){var n=this,r=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(r.map(function(t,r){return n.getDependency(e,r)})),this.cache.add(e,t)}return t},F.prototype.loadBuffer=function(e){var t=this.json.buffers[e],r=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[n.KHR_BINARY_GLTF].body);var i=this.options;return new Promise(function(e,n){r.load(L(t.uri,i.path),e,void 0,function(){n(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})},F.prototype.loadBufferView=function(e){var t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(e){var n=t.byteLength||0,r=t.byteOffset||0;return e.slice(r,r+n)})},F.prototype.loadAccessor=function(e){var t=this,n=this.json,r=this.json.accessors[e];if(void 0===r.bufferView&&void 0===r.sparse)return Promise.resolve(null);var i=[];return void 0!==r.bufferView?i.push(this.getDependency("bufferView",r.bufferView)):i.push(null),void 0!==r.sparse&&(i.push(this.getDependency("bufferView",r.sparse.indices.bufferView)),i.push(this.getDependency("bufferView",r.sparse.values.bufferView))),Promise.all(i).then(function(e){var i,a,o=e[0],s=x[r.type],c=k[r.componentType],u=c.BYTES_PER_ELEMENT,l=u*s,h=r.byteOffset||0,p=void 0!==r.bufferView?n.bufferViews[r.bufferView].byteStride:void 0,d=!0===r.normalized;if(p&&p!==l){var f="InterleavedBuffer:"+r.bufferView+":"+r.componentType,v=t.cache.get(f);v||(i=new c(o),v=new bt.InterleavedBuffer(i,p/u),t.cache.add(f,v)),a=new bt.InterleavedBufferAttribute(v,s,h/u,d)}else i=null===o?new c(r.count*s):new c(o,h,r.count*s),a=new bt.BufferAttribute(i,s,d);if(void 0!==r.sparse){var m=x.SCALAR,y=k[r.sparse.indices.componentType],g=r.sparse.indices.byteOffset||0,b=r.sparse.values.byteOffset||0,w=new y(e[1],g,r.sparse.count*m),O=new c(e[2],b,r.sparse.count*s);null!==o&&a.setArray(a.array.slice());for(var S=0,A=w.length;S<A;S++){var C=w[S];if(a.setX(C,O[S*s]),s>=2&&a.setY(C,O[S*s+1]),s>=3&&a.setZ(C,O[S*s+2]),s>=4&&a.setW(C,O[S*s+3]),s>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return a})},F.prototype.loadTexture=function(e){var t,r=this,i=this.json,a=this.options,o=this.textureLoader,s=window.URL||window.webkitURL,c=i.textures[e],u=c.extensions||{},l=(t=u[n.MSFT_TEXTURE_DDS]?i.images[u[n.MSFT_TEXTURE_DDS].source]:i.images[c.source]).uri,h=!1;return void 0!==t.bufferView&&(l=r.getDependency("bufferView",t.bufferView).then(function(e){h=!0;var n=new Blob([e],{type:t.mimeType});return l=s.createObjectURL(n)})),Promise.resolve(l).then(function(e){var t=bt.Loader.Handlers.get(e);return t||(t=u[n.MSFT_TEXTURE_DDS]?r.extensions[n.MSFT_TEXTURE_DDS].ddsLoader:o),new Promise(function(n,r){t.load(L(e,a.path),n,void 0,r)})}).then(function(e){!0===h&&s.revokeObjectURL(l),e.flipY=!1,void 0!==c.name&&(e.name=c.name),t.mimeType in P&&(e.format=P[t.mimeType]);var n=(i.samplers||{})[c.sampler]||{};return e.magFilter=S[n.magFilter]||bt.LinearFilter,e.minFilter=S[n.minFilter]||bt.LinearMipMapLinearFilter,e.wrapS=A[n.wrapS]||bt.RepeatWrapping,e.wrapT=A[n.wrapT]||bt.RepeatWrapping,e})},F.prototype.assignTexture=function(e,t,r){var i=this;return this.getDependency("texture",r.index).then(function(a){if(!a.isCompressedTexture)switch(t){case"aoMap":case"emissiveMap":case"metalnessMap":case"normalMap":case"roughnessMap":a.format=bt.RGBFormat}if(i.extensions[n.KHR_TEXTURE_TRANSFORM]){var o=void 0!==r.extensions?r.extensions[n.KHR_TEXTURE_TRANSFORM]:void 0;o&&(a=i.extensions[n.KHR_TEXTURE_TRANSFORM].extendTexture(a,o))}e[t]=a})},F.prototype.assignFinalMaterial=function(e){var t=e.geometry,r=e.material,i=this.extensions,a=void 0!==t.attributes.tangent,o=void 0!==t.attributes.color,s=void 0===t.attributes.normal,c=!0===e.isSkinnedMesh,u=Object.keys(t.morphAttributes).length>0,l=u&&void 0!==t.morphAttributes.normal;if(e.isPoints){var h="PointsMaterial:"+r.uuid,p=this.cache.get(h);p||(p=new bt.PointsMaterial,bt.Material.prototype.copy.call(p,r),p.color.copy(r.color),p.map=r.map,p.lights=!1,this.cache.add(h,p)),r=p}else if(e.isLine){h="LineBasicMaterial:"+r.uuid;var d=this.cache.get(h);d||(d=new bt.LineBasicMaterial,bt.Material.prototype.copy.call(d,r),d.color.copy(r.color),d.lights=!1,this.cache.add(h,d)),r=d}if(a||o||s||c||u){h="ClonedMaterial:"+r.uuid+":";r.isGLTFSpecularGlossinessMaterial&&(h+="specular-glossiness:"),c&&(h+="skinning:"),a&&(h+="vertex-tangents:"),o&&(h+="vertex-colors:"),s&&(h+="flat-shading:"),u&&(h+="morph-targets:"),l&&(h+="morph-normals:");var f=this.cache.get(h);f||(f=r.isGLTFSpecularGlossinessMaterial?i[n.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].cloneMaterial(r):r.clone(),c&&(f.skinning=!0),a&&(f.vertexTangents=!0),o&&(f.vertexColors=bt.VertexColors),s&&(f.flatShading=!0),u&&(f.morphTargets=!0),l&&(f.morphNormals=!0),this.cache.add(h,f)),r=f}r.aoMap&&void 0===t.attributes.uv2&&void 0!==t.attributes.uv&&(console.log("THREE.GLTFLoader: Duplicating UVs to support aoMap."),t.addAttribute("uv2",new bt.BufferAttribute(t.attributes.uv.array,2))),r.isGLTFSpecularGlossinessMaterial&&(e.onBeforeRender=i[n.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].refreshUniforms),e.material=r},F.prototype.loadMaterial=function(e){var t,r=this.json,i=this.extensions,a=r.materials[e],o={},s=a.extensions||{},c=[];if(s[n.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){var u=i[n.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];t=u.getMaterialType(),c.push(u.extendParams(o,a,this))}else if(s[n.KHR_MATERIALS_UNLIT]){var l=i[n.KHR_MATERIALS_UNLIT];t=l.getMaterialType(),c.push(l.extendParams(o,a,this))}else{t=bt.MeshStandardMaterial;var h=a.pbrMetallicRoughness||{};if(o.color=new bt.Color(1,1,1),o.opacity=1,Array.isArray(h.baseColorFactor)){var p=h.baseColorFactor;o.color.fromArray(p),o.opacity=p[3]}void 0!==h.baseColorTexture&&c.push(this.assignTexture(o,"map",h.baseColorTexture)),o.metalness=void 0!==h.metallicFactor?h.metallicFactor:1,o.roughness=void 0!==h.roughnessFactor?h.roughnessFactor:1,void 0!==h.metallicRoughnessTexture&&(c.push(this.assignTexture(o,"metalnessMap",h.metallicRoughnessTexture)),c.push(this.assignTexture(o,"roughnessMap",h.metallicRoughnessTexture)))}!0===a.doubleSided&&(o.side=bt.DoubleSide);var d=a.alphaMode||j;return d===R?o.transparent=!0:(o.transparent=!1,d===D&&(o.alphaTest=void 0!==a.alphaCutoff?a.alphaCutoff:.5)),void 0!==a.normalTexture&&t!==bt.MeshBasicMaterial&&(c.push(this.assignTexture(o,"normalMap",a.normalTexture)),o.normalScale=new bt.Vector2(1,1),void 0!==a.normalTexture.scale&&o.normalScale.set(a.normalTexture.scale,a.normalTexture.scale)),void 0!==a.occlusionTexture&&t!==bt.MeshBasicMaterial&&(c.push(this.assignTexture(o,"aoMap",a.occlusionTexture)),void 0!==a.occlusionTexture.strength&&(o.aoMapIntensity=a.occlusionTexture.strength)),void 0!==a.emissiveFactor&&t!==bt.MeshBasicMaterial&&(o.emissive=(new bt.Color).fromArray(a.emissiveFactor)),void 0!==a.emissiveTexture&&t!==bt.MeshBasicMaterial&&c.push(this.assignTexture(o,"emissiveMap",a.emissiveTexture)),Promise.all(c).then(function(){var e;return e=t===bt.ShaderMaterial?i[n.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(o):new t(o),void 0!==a.name&&(e.name=a.name),e.map&&(e.map.encoding=bt.sRGBEncoding),e.emissiveMap&&(e.emissiveMap.encoding=bt.sRGBEncoding),e.specularMap&&(e.specularMap.encoding=bt.sRGBEncoding),I(e,a),a.extensions&&T(i,e,a),e})},F.prototype.loadGeometries=function(e){var t=this,r=this.extensions,i=this.primitiveCache;function a(e){return r[n.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then(function(n){return U(n,e,t)})}for(var o,s,c=[],u=0,l=e.length;u<l;u++){var h,p=e[u],d=(s=void 0,(s=(o=p).extensions&&o.extensions[n.KHR_DRACO_MESH_COMPRESSION])?"draco:"+s.bufferView+":"+s.indices+":"+G(s.attributes):o.indices+":"+G(o.attributes)+":"+o.mode),f=i[d];if(f)c.push(f.promise);else h=p.extensions&&p.extensions[n.KHR_DRACO_MESH_COMPRESSION]?a(p):U(new bt.BufferGeometry,p,t),i[d]={primitive:p,promise:h},c.push(h)}return Promise.all(c)},F.prototype.loadMesh=function(e){for(var t=this,n=this.json,r=(this.extensions,n.meshes[e]),i=r.primitives,a=[],o=0,s=i.length;o<s;o++){var c=void 0===i[o].material?f=f||new bt.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:bt.FrontSide}):this.getDependency("material",i[o].material);a.push(c)}return Promise.all(a).then(function(n){return t.loadGeometries(i).then(function(a){for(var o=[],s=0,c=a.length;s<c;s++){var u,l=a[s],h=i[s],p=n[s];if(h.mode===b||h.mode===w||h.mode===O||void 0===h.mode)!0===(u=!0===r.isSkinnedMesh?new bt.SkinnedMesh(l,p):new bt.Mesh(l,p)).isSkinnedMesh&&u.normalizeSkinWeights(),h.mode===w?u.drawMode=bt.TriangleStripDrawMode:h.mode===O&&(u.drawMode=bt.TriangleFanDrawMode);else if(h.mode===m)u=new bt.LineSegments(l,p);else if(h.mode===g)u=new bt.Line(l,p);else if(h.mode===y)u=new bt.LineLoop(l,p);else{if(h.mode!==v)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+h.mode);u=new bt.Points(l,p)}Object.keys(u.geometry.morphAttributes).length>0&&N(u,r),u.name=r.name||"mesh_"+e,a.length>1&&(u.name+="_"+s),I(u,r),t.assignFinalMaterial(u),o.push(u)}if(1===o.length)return o[0];var d=new bt.Group;for(s=0,c=o.length;s<c;s++)d.add(o[s]);return d})})},F.prototype.loadCamera=function(e){var t,n=this.json.cameras[e],r=n[n.type];if(r)return"perspective"===n.type?t=new bt.PerspectiveCamera(bt.Math.radToDeg(r.yfov),r.aspectRatio||1,r.znear||1,r.zfar||2e6):"orthographic"===n.type&&(t=new bt.OrthographicCamera(r.xmag/-2,r.xmag/2,r.ymag/2,r.ymag/-2,r.znear,r.zfar)),void 0!==n.name&&(t.name=n.name),I(t,n),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")},F.prototype.loadSkin=function(e){var t=this.json.skins[e],n={joints:t.joints};return void 0===t.inverseBindMatrices?Promise.resolve(n):this.getDependency("accessor",t.inverseBindMatrices).then(function(e){return n.inverseBindMatrices=e,n})},F.prototype.loadAnimation=function(e){for(var t=this.json.animations[e],n=[],r=[],i=[],a=[],o=[],s=0,c=t.channels.length;s<c;s++){var u=t.channels[s],l=t.samplers[u.sampler],h=u.target,p=void 0!==h.node?h.node:h.id,f=void 0!==t.parameters?t.parameters[l.input]:l.input,v=void 0!==t.parameters?t.parameters[l.output]:l.output;n.push(this.getDependency("node",p)),r.push(this.getDependency("accessor",f)),i.push(this.getDependency("accessor",v)),a.push(l),o.push(h)}return Promise.all([Promise.all(n),Promise.all(r),Promise.all(i),Promise.all(a),Promise.all(o)]).then(function(n){for(var r=n[0],i=n[1],a=n[2],o=n[3],s=n[4],c=[],u=0,l=r.length;u<l;u++){var h=r[u],p=i[u],f=a[u],v=o[u],m=s[u];if(void 0!==h){var y;switch(h.updateMatrix(),h.matrixAutoUpdate=!0,M[m.path]){case M.weights:y=bt.NumberKeyframeTrack;break;case M.rotation:y=bt.QuaternionKeyframeTrack;break;case M.position:case M.scale:default:y=bt.VectorKeyframeTrack}var g=h.name?h.name:h.uuid,b=void 0!==v.interpolation?E[v.interpolation]:bt.InterpolateLinear,w=[];M[m.path]===M.weights?h.traverse(function(e){!0===e.isMesh&&e.morphTargetInfluences&&w.push(e.name?e.name:e.uuid)}):w.push(g);for(var O=0,k=w.length;O<k;O++){var S=new y(w[O]+"."+M[m.path],p.array,f.array,b);"CUBICSPLINE"===v.interpolation&&(S.createInterpolant=function(e){return new d(this.times,this.values,this.getValueSize()/3,e)},S.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),c.push(S)}}}var A=void 0!==t.name?t.name:"animation_"+e;return new bt.AnimationClip(A,void 0,c)})},F.prototype.loadNode=function(e){var t=this.json,r=this.extensions,i=this,a=t.meshReferences,o=t.meshUses,s=t.nodes[e];return(!0===s.isBone?Promise.resolve(new bt.Bone):void 0!==s.mesh?i.getDependency("mesh",s.mesh).then(function(e){var t;if(a[s.mesh]>1){var n=o[s.mesh]++;(t=e.clone()).name+="_instance_"+n,t.onBeforeRender=e.onBeforeRender;for(var r=0,i=t.children.length;r<i;r++)t.children[r].name+="_instance_"+n,t.children[r].onBeforeRender=e.children[r].onBeforeRender}else t=e;return void 0!==s.weights&&t.traverse(function(e){if(e.isMesh)for(var t=0,n=s.weights.length;t<n;t++)e.morphTargetInfluences[t]=s.weights[t]}),t}):void 0!==s.camera?i.getDependency("camera",s.camera):s.extensions&&s.extensions[n.KHR_LIGHTS_PUNCTUAL]&&void 0!==s.extensions[n.KHR_LIGHTS_PUNCTUAL].light?i.getDependency("light",s.extensions[n.KHR_LIGHTS_PUNCTUAL].light):Promise.resolve(new bt.Object3D)).then(function(e){if(void 0!==s.name&&(e.name=bt.PropertyBinding.sanitizeNodeName(s.name)),I(e,s),s.extensions&&T(r,e,s),void 0!==s.matrix){var t=new bt.Matrix4;t.fromArray(s.matrix),e.applyMatrix(t)}else void 0!==s.translation&&e.position.fromArray(s.translation),void 0!==s.rotation&&e.quaternion.fromArray(s.rotation),void 0!==s.scale&&e.scale.fromArray(s.scale);return e})},F.prototype.loadScene=function(){function e(t,n,r,i){var a=r.nodes[t];return i.getDependency("node",t).then(function(e){return void 0===a.skin?e:i.getDependency("skin",a.skin).then(function(e){for(var n=[],r=0,a=(t=e).joints.length;r<a;r++)n.push(i.getDependency("node",t.joints[r]));return Promise.all(n)}).then(function(n){for(var r=!0===e.isGroup?e.children:[e],i=0,a=r.length;i<a;i++){for(var o=r[i],s=[],c=[],u=0,l=n.length;u<l;u++){var h=n[u];if(h){s.push(h);var p=new bt.Matrix4;void 0!==t.inverseBindMatrices&&p.fromArray(t.inverseBindMatrices.array,16*u),c.push(p)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[u])}o.bind(new bt.Skeleton(s,c),o.matrixWorld)}return e});var t}).then(function(t){n.add(t);var o=[];if(a.children)for(var s=a.children,c=0,u=s.length;c<u;c++){var l=s[c];o.push(e(l,t,r,i))}return Promise.all(o)})}return function(t){var n=this.json,r=this.extensions,i=this.json.scenes[t],a=new bt.Scene;void 0!==i.name&&(a.name=i.name),I(a,i),i.extensions&&T(r,a,i);for(var o=i.nodes||[],s=[],c=0,u=o.length;c<u;c++)s.push(e(o[c],a,n,this));return Promise.all(s).then(function(){return a})}}(),e}(),Ot=n(1),kt=function(){function e(e){this.timeLoaded=0,this.manager=e||Ot.DefaultLoadingManager,this.materials=null,this.verbosity=0,this.attributeOptions={},this.drawMode=Ot.TrianglesDrawMode,this.nativeAttributeMap={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"}}return e.prototype={constructor:e,load:function(e,t,n,r){var i=this,a=new Ot.FileLoader(i.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.load(e,function(e){i.decodeDracoFile(e,t)},n,r)},setPath:function(e){return this.path=e,this},setVerbosity:function(e){return this.verbosity=e,this},setDrawMode:function(e){return this.drawMode=e,this},setSkipDequantization:function(e,t){var n=!0;return"undefined"!==typeof t&&(n=t),this.getAttributeOptions(e).skipDequantization=n,this},decodeDracoFile:function(t,n,r,i){var a=this;e.getDecoderModule().then(function(e){a.decodeDracoFileInternal(t,e.decoder,n,r,i)})},decodeDracoFileInternal:function(e,t,n,r,i){var a=new t.DecoderBuffer;a.Init(new Int8Array(e),e.byteLength);var o=new t.Decoder,s=o.GetEncodedGeometryType(a);if(s==t.TRIANGULAR_MESH)this.verbosity>0&&console.log("Loaded a mesh.");else{if(s!=t.POINT_CLOUD){var c="THREE.DRACOLoader: Unknown geometry type.";throw console.error(c),new Error(c)}this.verbosity>0&&console.log("Loaded a point cloud.")}n(this.convertDracoGeometryTo3JS(t,o,s,a,r,i))},addAttributeToGeometry:function(e,t,n,r,i,a,o,s){if(0===a.ptr){var c="THREE.DRACOLoader: No attribute "+r;throw console.error(c),new Error(c)}var u,l,h=a.num_components(),p=n.num_points()*h;switch(i){case Float32Array:u=new e.DracoFloat32Array,t.GetAttributeFloatForAllPoints(n,a,u),s[r]=new Float32Array(p),l=Ot.Float32BufferAttribute;break;case Int8Array:u=new e.DracoInt8Array,t.GetAttributeInt8ForAllPoints(n,a,u),s[r]=new Int8Array(p),l=Ot.Int8BufferAttribute;break;case Int16Array:u=new e.DracoInt16Array,t.GetAttributeInt16ForAllPoints(n,a,u),s[r]=new Int16Array(p),l=Ot.Int16BufferAttribute;break;case Int32Array:u=new e.DracoInt32Array,t.GetAttributeInt32ForAllPoints(n,a,u),s[r]=new Int32Array(p),l=Ot.Int32BufferAttribute;break;case Uint8Array:u=new e.DracoUInt8Array,t.GetAttributeUInt8ForAllPoints(n,a,u),s[r]=new Uint8Array(p),l=Ot.Uint8BufferAttribute;break;case Uint16Array:u=new e.DracoUInt16Array,t.GetAttributeUInt16ForAllPoints(n,a,u),s[r]=new Uint16Array(p),l=Ot.Uint16BufferAttribute;break;case Uint32Array:u=new e.DracoUInt32Array,t.GetAttributeUInt32ForAllPoints(n,a,u),s[r]=new Uint32Array(p),l=Ot.Uint32BufferAttribute;break;default:c="THREE.DRACOLoader: Unexpected attribute type.";throw console.error(c),new Error(c)}for(var d=0;d<p;d++)s[r][d]=u.GetValue(d);o.addAttribute(r,new l(s[r],h)),e.destroy(u)},convertDracoGeometryTo3JS:function(e,t,n,r,i,a){var o,s;!0===this.getAttributeOptions("position").skipDequantization&&t.SkipAttributeTransform(e.POSITION);var c=performance.now();if(n===e.TRIANGULAR_MESH?(o=new e.Mesh,s=t.DecodeBufferToMesh(r,o)):(o=new e.PointCloud,s=t.DecodeBufferToPointCloud(r,o)),!s.ok()||0==o.ptr){var u="THREE.DRACOLoader: Decoding failed: ";throw u+=s.error_msg(),console.error(u),e.destroy(t),e.destroy(o),new Error(u)}var l,h=performance.now();e.destroy(r),n==e.TRIANGULAR_MESH?(l=o.num_faces(),this.verbosity>0&&console.log("Number of faces loaded: "+l.toString())):l=0;var p=o.num_points(),d=o.num_attributes();this.verbosity>0&&(console.log("Number of points loaded: "+p.toString()),console.log("Number of attributes loaded: "+d.toString()));var f=t.GetAttributeId(o,e.POSITION);if(-1==f){u="THREE.DRACOLoader: No position attribute found.";throw console.error(u),e.destroy(t),e.destroy(o),new Error(u)}var v=t.GetAttribute(o,f),m={},y=new Ot.BufferGeometry;if(i)for(var g in i){var b=a[g],w=i[g],O=t.GetAttributeByUniqueId(o,w);this.addAttributeToGeometry(e,t,o,g,b,O,y,m)}else for(var g in this.nativeAttributeMap){var k=t.GetAttributeId(o,e[this.nativeAttributeMap[g]]);if(-1!==k){this.verbosity>0&&console.log("Loaded "+g+" attribute.");O=t.GetAttribute(o,k);this.addAttributeToGeometry(e,t,o,g,Float32Array,O,y,m)}}if(n==e.TRIANGULAR_MESH)if(this.drawMode===Ot.TriangleStripDrawMode){var S=new e.DracoInt32Array;t.GetTriangleStripsFromMesh(o,S);m.indices=new Uint32Array(S.size());for(var A=0;A<S.size();++A)m.indices[A]=S.GetValue(A);e.destroy(S)}else{var x=3*l;m.indices=new Uint32Array(x);var C=new e.DracoInt32Array;for(A=0;A<l;++A){t.GetFaceFromMesh(o,A,C);var M=3*A;m.indices[M]=C.GetValue(0),m.indices[M+1]=C.GetValue(1),m.indices[M+2]=C.GetValue(2)}e.destroy(C)}y.drawMode=this.drawMode,n==e.TRIANGULAR_MESH&&y.setIndex(new(m.indices.length>65535?Ot.Uint32BufferAttribute:Ot.Uint16BufferAttribute)(m.indices,1));var E=new e.AttributeQuantizationTransform;if(E.InitFromAttribute(v)){y.attributes.position.isQuantized=!0,y.attributes.position.maxRange=E.range(),y.attributes.position.numQuantizationBits=E.quantization_bits(),y.attributes.position.minValues=new Float32Array(3);for(A=0;A<3;++A)y.attributes.position.minValues[A]=E.min_value(A)}return e.destroy(E),e.destroy(t),e.destroy(o),this.decode_time=h-c,this.import_time=performance.now()-h,this.verbosity>0&&(console.log("Decode time: "+this.decode_time),console.log("Import time: "+this.import_time)),y},isVersionSupported:function(t,n){e.getDecoderModule().then(function(e){n(e.decoder.isVersionSupported(t))})},getAttributeOptions:function(e){return"undefined"===typeof this.attributeOptions[e]&&(this.attributeOptions[e]={}),this.attributeOptions[e]}},e.decoderPath="./",e.decoderConfig={},e.decoderModulePromise=null,e.setDecoderPath=function(t){e.decoderPath=t},e.setDecoderConfig=function(t){var n=Ot.DRACOLoader.decoderConfig.wasmBinary;e.decoderConfig=t||{},e.releaseDecoderModule(),n&&(e.decoderConfig.wasmBinary=n)},e.releaseDecoderModule=function(){e.decoderModulePromise=null},e.getDecoderModule=function(){var t=this,n=e.decoderPath,r=e.decoderConfig,i=e.decoderModulePromise;return i||("undefined"!==typeof DracoDecoderModule?i=Promise.resolve():"object"!==typeof WebAssembly||"js"===r.type?i=e._loadScript(n+"draco_decoder.js"):(r.wasmBinaryFile=n+"draco_decoder.wasm",i=e._loadScript(n+"draco_wasm_wrapper.js").then(function(){return e._loadArrayBuffer(r.wasmBinaryFile)}).then(function(e){r.wasmBinary=e})),i=i.then(function(){return new Promise(function(e){r.onModuleLoaded=function(n){t.timeLoaded=performance.now(),e({decoder:n})},DracoDecoderModule(r)})}),e.decoderModulePromise=i,i)},e._loadScript=function(e){var t=document.getElementById("decoder_script");null!==t&&t.parentNode.removeChild(t);var n=document.getElementsByTagName("head")[0],r=document.createElement("script");return r.id="decoder_script",r.type="text/javascript",r.src=e,new Promise(function(e){r.onload=e,n.appendChild(r)})},e._loadArrayBuffer=function(e){var t=new Ot.FileLoader;return t.setResponseType("arraybuffer"),new Promise(function(n,r){t.load(e,n,void 0,r)})},e}(),St=n(1);var At={retarget:(st=new St.Vector3,ct=new St.Quaternion,ut=new St.Vector3,lt=new St.Matrix4,ht=new St.Matrix4,pt=new St.Matrix4,function(e,t,n){(n=n||{}).preserveMatrix=void 0===n.preserveMatrix||n.preserveMatrix,n.preservePosition=void 0===n.preservePosition||n.preservePosition,n.preserveHipPosition=void 0!==n.preserveHipPosition&&n.preserveHipPosition,n.useTargetMatrix=void 0!==n.useTargetMatrix&&n.useTargetMatrix,n.hip=void 0!==n.hip?n.hip:"hip",n.names=n.names||{};var r,i,a,o,s,c,u=t.isObject3D?t.skeleton.bones:this.getBones(t),l=e.isObject3D?e.skeleton.bones:this.getBones(e);if(e.isObject3D?e.skeleton.pose():(n.useTargetMatrix=!0,n.preserveMatrix=!1),n.preservePosition)for(s=[],c=0;c<l.length;c++)s.push(l[c].position.clone());if(n.preserveMatrix)for(e.updateMatrixWorld(),e.matrixWorld.identity(),c=0;c<e.children.length;++c)e.children[c].updateMatrixWorld(!0);if(n.offsets)for(r=[],c=0;c<l.length;++c)i=l[c],a=n.names[i.name]||i.name,n.offsets&&n.offsets[a]&&(i.matrix.multiply(n.offsets[a]),i.matrix.decompose(i.position,i.quaternion,i.scale),i.updateMatrixWorld()),r.push(i.matrixWorld.clone());for(c=0;c<l.length;++c){if(i=l[c],a=n.names[i.name]||i.name,o=this.getBoneByName(a,u),pt.copy(i.matrixWorld),o){if(o.updateMatrixWorld(),n.useTargetMatrix?ht.copy(o.matrixWorld):(ht.getInverse(e.matrixWorld),ht.multiply(o.matrixWorld)),ut.setFromMatrixScale(ht),ht.scale(ut.set(1/ut.x,1/ut.y,1/ut.z)),pt.makeRotationFromQuaternion(ct.setFromRotationMatrix(ht)),e.isObject3D){var h=l.indexOf(i),p=r?r[h]:lt.getInverse(e.skeleton.boneInverses[h]);pt.multiply(p)}pt.copyPosition(ht)}i.parent&&i.parent.isBone?(i.matrix.getInverse(i.parent.matrixWorld),i.matrix.multiply(pt)):i.matrix.copy(pt),n.preserveHipPosition&&a===n.hip&&i.matrix.setPosition(st.set(0,i.position.y,0)),i.matrix.decompose(i.position,i.quaternion,i.scale),i.updateMatrixWorld()}if(n.preservePosition)for(c=0;c<l.length;++c)i=l[c],(a=n.names[i.name]||i.name)!==n.hip&&i.position.copy(s[c]);n.preserveMatrix&&e.updateMatrixWorld(!0)}),retargetClip:function(e,t,n,r){(r=r||{}).useFirstFramePosition=void 0!==r.useFirstFramePosition&&r.useFirstFramePosition,r.fps=void 0!==r.fps?r.fps:30,r.names=r.names||[],t.isObject3D||(t=this.getHelperFromSkeleton(t));var i,a,o,s,c,u,l=Math.round(n.duration*(r.fps/1e3)*1e3),h=1/r.fps,p=[],d=new St.AnimationMixer(t),f=this.getBones(e.skeleton),v=[];for(d.clipAction(n).play(),d.update(0),t.updateMatrixWorld(),c=0;c<l;++c){var m=c*h;for(this.retarget(e,t,r),u=0;u<f.length;++u)s=r.names[f[u].name]||f[u].name,this.getBoneByName(s,t.skeleton)&&(a=f[u],o=v[u]=v[u]||{bone:a},r.hip===s&&(o.pos||(o.pos={times:new Float32Array(l),values:new Float32Array(3*l)}),r.useFirstFramePosition&&(0===c&&(i=a.position.clone()),a.position.sub(i)),o.pos.times[c]=m,a.position.toArray(o.pos.values,3*c)),o.quat||(o.quat={times:new Float32Array(l),values:new Float32Array(4*l)}),o.quat.times[c]=m,a.quaternion.toArray(o.quat.values,4*c));d.update(h),t.updateMatrixWorld()}for(c=0;c<v.length;++c)(o=v[c])&&(o.pos&&p.push(new St.VectorKeyframeTrack(".bones["+o.bone.name+"].position",o.pos.times,o.pos.values)),p.push(new St.QuaternionKeyframeTrack(".bones["+o.bone.name+"].quaternion",o.quat.times,o.quat.values)));return d.uncacheAction(n),new St.AnimationClip(n.name,-1,p)},getHelperFromSkeleton:function(e){var t=new St.SkeletonHelper(e.bones[0]);return t.skeleton=e,t},getSkeletonOffsets:(tt=new St.Vector3,nt=new St.Vector3,rt=new St.Vector3,it=new St.Vector3,at=new St.Vector2,ot=new St.Vector2,function(e,t,n){(n=n||{}).hip=void 0!==n.hip?n.hip:"hip",n.names=n.names||{},t.isObject3D||(t=this.getHelperFromSkeleton(t));var r,i,a,o,s=Object.keys(n.names),c=Object.values(n.names),u=t.isObject3D?t.skeleton.bones:this.getBones(t),l=e.isObject3D?e.skeleton.bones:this.getBones(e),h=[];for(e.skeleton.pose(),o=0;o<l.length;++o)if(r=l[o],a=n.names[r.name]||r.name,(i=this.getBoneByName(a,u))&&a!==n.hip){var p=this.getNearestBone(r.parent,s),d=this.getNearestBone(i.parent,c);p.updateMatrixWorld(),d.updateMatrixWorld(),tt.setFromMatrixPosition(p.matrixWorld),nt.setFromMatrixPosition(r.matrixWorld),rt.setFromMatrixPosition(d.matrixWorld),it.setFromMatrixPosition(i.matrixWorld),at.subVectors(new St.Vector2(nt.x,nt.y),new St.Vector2(tt.x,tt.y)).normalize(),ot.subVectors(new St.Vector2(it.x,it.y),new St.Vector2(rt.x,rt.y)).normalize();var f=at.angle()-ot.angle(),v=(new St.Matrix4).makeRotationFromEuler(new St.Euler(0,0,f));r.matrix.multiply(v),r.matrix.decompose(r.position,r.quaternion,r.scale),r.updateMatrixWorld(),h[a]=v}return h}),renameBones:function(e,t){for(var n=this.getBones(e),r=0;r<n.length;++r){var i=n[r];t[i.name]&&(i.name=t[i.name])}return this},getBones:function(e){return Array.isArray(e)?e:e.bones},getBoneByName:function(e,t){for(var n=0,r=this.getBones(t);n<r.length;n++)if(e===r[n].name)return r[n]},getNearestBone:function(e,t){for(;e.isBone;){if(-1!==t.indexOf(e.name))return e;e=e.parent}},findBoneTrackData:function(e,t){for(var n=/\[(.*)\]\.(.*)/,r={name:e},i=0;i<t.length;++i){var a=n.exec(t[i].name);a&&e===a[1]&&(r[a[2]]=i)}return r},getEqualsBonesNames:function(e,t){var n=this.getBones(e),r=this.getBones(t),i=[];e:for(var a=0;a<n.length;a++)for(var o=n[a].name,s=0;s<r.length;s++)if(o===r[s].name){i.push(o);continue e}return i},clone:function(e){var t=new Map,n=new Map,r=e.clone();return function e(t,n,r){r(t,n);for(var i=0;i<t.children.length;i++)e(t.children[i],n.children[i],r)}(e,r,function(e,r){t.set(r,e),n.set(e,r)}),r.traverse(function(e){if(e.isSkinnedMesh){var r=e,i=t.get(e),a=i.skeleton.bones;r.skeleton=i.skeleton.clone(),r.bindMatrix.copy(i.bindMatrix),r.skeleton.bones=a.map(function(e){return n.get(e)}),r.bind(r.skeleton,r.bindMatrix)}}),r}},xt=function(e){function t(){return Object(s.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create model w/ missing parent");return ae(e,e.createObject({type:"model",title:"a model",visible:!0,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,color:"#ffffff",children:e.createArray(),asset:Yt.id,parent:t.id}))}},{key:"makeNode",value:function(e,t){var n=new dt.Group;n.name=e.title;var r=new dt.Mesh(new dt.SphereBufferGeometry(1),new dt.MeshLambertMaterial({color:"red",transparent:!0,opacity:.2}));return r.material.visible=!0,r.userData.clickable=!0,n.userData.clicker=r,n.add(r),n.position.set(e.tx,e.ty,e.tz),n.rotation.set(e.rx,e.ry,e.rz),n.scale.set(e.sx,e.sy,e.sz),n.visible=e.visible,this.attachAsset(n,e,t),n.enter=function(e,t){n.userData.clicker.visible=!1,n.userData.model?n.userData.currentClip&&(n.userData.action=n.userData.mixer.clipAction(n.userData.currentClip),n.userData.action.play()):n.userData.shouldPlay=!0},n.exit=function(r,i){t.accessObject(e.id).asset===Yt.id&&(n.userData.clicker.visible=!0)},n.tick=function(e,t){var r=e.deltaTime/1e3;n.userData.mixer&&n.userData.mixer.update(r)},n.useClip=function(e){if(n.userData.model){var t=dt.AnimationClip.findByName(n.userData.clips,e);t&&(n.userData.currentClip=t)}else n.userData.currentClipName=e},n.play=function(){n.userData.currentClip&&(n.userData.mixer.stopAllAction(),n.userData.action=n.userData.mixer.clipAction(n.userData.currentClip),n.userData.action.play())},n.stop=function(){n.userData.mixer&&n.userData.mixer.stopAllAction()},n}},{key:"updateProperty",value:function(e,n,r,i){return r.name===Zt.asset.key?this.attachAsset(e,n,i):Object(d.a)(Object(l.a)(t.prototype),"updateProperty",this).call(this,e,n,r,i)}},{key:"setClips",value:function(e){e.mixer&&(e.mixer.stopAllAction(),e.mixer.uncacheRoot(e.mixer.getRoot()),e.mixer=null),e.clips.forEach(function(e){e.validate()&&e.optimize()}),e.clips.length&&(e.currentClip=e.clips[0],e.mixer=new dt.AnimationMixer(e.model))}},{key:"attachAsset",value:function(e,t,n){var r=this;if(t.asset===Yt.id)return console.log("REMOVE NODE CHILDREN"),e.userData.model&&(e.remove(e.userData.model),delete e.userData.model),void(e.userData.clicker.visible=!0);var i=n.accessObject(t.asset);if(i.exists()){var a=n.assetsManager.getAssetURL(i);if(n.getLogger().log("ModelDef loading the model asset url",a),a){var o=new wt;o.setCrossOrigin("anonymous");var s=new kt;kt.setDecoderPath("./draco/"),o.setDRACOLoader(s),e.userData.shouldPlay=!1,e.userData.currentClip=null,e.userData.model=null,e.userData.currentClipName=null,o.load(a,function(t){console.log("loaded",a),e.userData.model&&e.remove(e.userData.model),e.userData.model=t.scene||t.scenes[0],e.userData.model=At.clone(e.userData.model),e.userData.clips=t.animations||[],e.add(e.userData.model),e.userData.model.updateMatrixWorld();var n=e.userData.model;if(e.userData.boundingBox=(new dt.Box3).setFromObject(n),e.userData.boundingBoxSize=e.userData.boundingBox.getSize(new dt.Vector3).length(),e.userData.BoundingBoxCenter=e.userData.boundingBox.getCenter(new dt.Vector3),e.userData.mixer=null,r.setClips(e.userData),e.userData.currentClipName){var i=dt.AnimationClip.findByName(e.userData.clips,e.userData.currentClipName);i&&(e.userData.currentClip=i),e.userData.currentClipName=null}e.userData.shouldPlay&&e.userData.currentClip&&(e.userData.action=e.userData.mixer.clipAction(e.userData.currentClip),e.userData.action.play(),e.userData.shouldPlay=!1),e.userData.clicker.geometry=new dt.SphereBufferGeometry(e.userData.boundingBoxSize/2),e.userData.clicker.visible=!1})}else n.getLogger().error("ModelDef: empty url. cannot load GLTF")}}}]),t}(ft);var Ct=function(){function e(){Object(s.a)(this,e)}return Object(c.a)(e,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create sphere w/ missing parent");return ae(e,e.createObject({type:qt.bg360,title:"background",visible:!0,asset:Yt.id,parent:t.id,imageOffsetAngle:0,imageCropStartAngle:0,imageCropEndAngle:1}))}},{key:"makeNode",value:function(e,t){var n=new dt.MeshLambertMaterial({color:"white",side:dt.BackSide}),r=new dt.Mesh(new dt.SphereBufferGeometry(20,50,50),n);return function(e,t,n){t.onBeforeCompile=function(t){t.uniforms.imageOffsetAngle={value:n.imageOffsetAngle},t.uniforms.imageCropStartAngle={value:n.imageCropStartAngle},t.uniforms.imageCropEndAngle={value:n.imageCropEndAngle},t.vertexShader="\n            uniform float imageOffsetAngle;\n            varying float vImageOffsetAngle;\n            uniform float imageCropStartAngle;            \n            varying float vImageCropStartAngle;            \n            uniform float imageCropEndAngle;            \n            varying float vImageCropEndAngle;            \n        "+t.vertexShader,t.vertexShader=t.vertexShader.replace("#include <begin_vertex>","\n            #include <begin_vertex>\n            vImageOffsetAngle = imageOffsetAngle;\n            vImageCropStartAngle = imageCropStartAngle;\n            vImageCropEndAngle = imageCropEndAngle;\n        "),t.fragmentShader="\n                varying float vImageOffsetAngle;\n                varying float vImageCropStartAngle;\n                varying float vImageCropEndAngle;\n            "+t.fragmentShader,t.fragmentShader=t.fragmentShader.replace("#include <dithering_fragment>","\n            if(vUv.x < vImageCropStartAngle) discard;\n            if(vUv.x > vImageCropEndAngle)  discard;\n            // gl_FragColor.r = vUv.x;\n            // vec3 jv = vec3(cos(gl_FragCoord.x/50.0)); \n            // vec3 empty = vec3(0.0,0.0,0.0);//vec3(jv,jv,jv)\n            // gl_FragColor.rgb = mix(empty,diffuseColor.rgb,jv);\n        "),e.userData.matShader=t}}(r,n,e),r.name=e.title,r.userData.clickable=!0,r.visible=e.visible,this.attachAsset(r,e,t),r}},{key:"updateProperty",value:function(e,t,n,r){if(n.name===Zt.asset.key)return this.attachAsset(e,t,r);e.userData.matShader?("imageOffsetAngle"===n.name&&(e.userData.matShader.uniforms.imageOffsetAngle.value=n.value),"imageCropStartAngle"===n.name&&(e.userData.matShader.uniforms.imageCropStartAngle.value=n.value),"imageCropEndAngle"===n.name&&(e.userData.matShader.uniforms.imageCropEndAngle.value=n.value)):console.warn("BG360: no shader reference?!")}},{key:"attachAsset",value:function(e,t,n){if(t.asset!==Yt.id){var r=n.assetsManager.getTexture(t.asset);r&&(e.material=new dt.MeshLambertMaterial({color:t.color,side:dt.DoubleSide,map:r}))}else e.material=new dt.MeshLambertMaterial({color:"white",side:dt.DoubleSide})}}]),e}(),Mt=n(25),Et=function(e){function t(){return Object(s.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create sphere w/ missing parent");return ae(e,e.createObject({type:qt.text,title:"some text",visible:!0,text:"cool <b>formatted</b> <i>text</i>",cssStyle:"color:black; \nbackground-color:white;\nwidth: 10em;\nfont-size: 200%;\n",tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,children:e.createArray(),parent:t.id}))}},{key:"makeNode",value:function(e){var t=document.createElement("div");t.innerHTML=e.text,t.id="div_".concat(e.id),t.classList.add("weblayer-div"),e.cssStyle&&t.setAttribute("style",e.cssStyle);var n=new Mt.a(t,{pixelRatio:window.devicePixelRatio,onLayerCreate:function(t){t.mesh.material.side=dt.DoubleSide,t.mesh.userData.graphid=e.id,t.mesh.userData.clickable=!0}});n.refresh(!0),n.userData.clickable=!0;var r=new dt.Object3D;return r.previewUpdate=function(){n.update()},r.setText=function(t){t!=r.userData.div.innerHTML&&(r.userData.div.innerHTML=t,e.cssStyle&&r.userData.div.setAttribute("style",e.cssStyle),r.userData.divLayer.refresh(!0))},r.add(n),r.userData.divLayer=n,r.userData.div=t,r.name=e.title,r.userData.clickable=!0,r.position.set(e.tx,e.ty,e.tz),r.rotation.set(e.rx,e.ry,e.rz),r.scale.set(e.sx,e.sy,e.sz),r.visible=e.visible,this.regenerateText(r,e),r}},{key:"updateProperty",value:function(e,n,r,i){return r.name===Zt.text.key&&this.regenerateText(e,n),r.name===Zt.cssStyle.key&&this.regenerateText(e,n),Object(d.a)(Object(l.a)(t.prototype),"updateProperty",this).call(this,e,n,r,i)}},{key:"regenerateText",value:function(e,t){e.userData.div.innerHTML=t.text,t.cssStyle&&e.userData.div.setAttribute("style",t.cssStyle),e.userData.divLayer.refresh(!0)}}]),t}(ft),jt=function(e){function t(){return Object(s.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create Image2D with missing parent");return ae(e,e.createObject({type:qt.img2d,title:"image",visible:!0,width:.5,ratio:1,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,asset:Yt.id,parent:t.id}))}},{key:"makeNode",value:function(e,t){var n=new dt.Mesh(new dt.PlaneBufferGeometry(e.width,e.width*e.ratio),new dt.MeshLambertMaterial({color:"white",side:dt.DoubleSide}));return n.name=e.title,n.userData.clickable=!0,n.position.set(e.tx,e.ty,e.tz),n.rotation.set(e.rx,e.ry,e.rz),n.scale.set(e.sx,e.sy,e.sz),n.visible=e.visible,this.attachAsset(n,e,t),n}},{key:"updateProperty",value:function(e,n,r,i){return r.name===Zt.asset.key?this.attachAsset(e,n,i):r.name!==Zt.width.key&&"ratio"!==r.name?Object(d.a)(Object(l.a)(t.prototype),"updateProperty",this).call(this,e,n,r,i):void(e.geometry=new dt.PlaneBufferGeometry(n.width,n.width*(1/n.ratio)))}},{key:"attachAsset",value:function(e,t,n){if(t.asset!==Yt.id){var r=n.assetsManager.getTexture(t.asset);r&&(e.material=new dt.MeshLambertMaterial({color:"white",side:dt.DoubleSide,map:r}))}else e.material=new dt.MeshLambertMaterial({color:"white",side:dt.DoubleSide})}}]),t}(ft),Dt=0,Rt=function(e){function t(){return Object(s.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create cube w/ missing parent");return ae(e,e.createObject({type:qt.group,title:"group "+Dt++,visible:!0,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,color:"#00ff00",children:e.createArray(),parent:t.id}))}},{key:"makeNode",value:function(e){var t=new dt.Group;return t.name=e.title,t.userData.clickable=!0,t.position.set(e.tx,e.ty,e.tz),t.rotation.set(e.rx,e.ry,e.rz),t.scale.set(e.sx,e.sy,e.sz),t.visible=e.visible,t}},{key:"updateProperty",value:function(e,n,r,i){return Object(d.a)(Object(l.a)(t.prototype),"updateProperty",this).call(this,e,n,r,i)}}]),t}(ft),Pt={vertexShader:"\n                uniform float uTime;\n                uniform float uScale;\n                uniform bool reverseTime;\n                uniform float fadeIn;\n                uniform float fadeOut;\n    \n                attribute vec3 positionStart;\n                attribute float startTime;\n                attribute vec3 velocity;\n                attribute vec3 acceleration;\n                attribute vec3 color;\n                attribute vec3 endColor;\n                attribute float size;\n                attribute float lifeTime;\n    \n                varying vec4 vColor;\n                varying vec4 vEndColor;\n                varying float lifeLeft;\n                varying float alpha;\n    \n                void main() {\n                    vColor = vec4( color, 1.0 );\n                    vEndColor = vec4( endColor, 1.0);\n                    vec3 newPosition;\n                    float timeElapsed = uTime - startTime;\n                    if(reverseTime) timeElapsed = lifeTime - timeElapsed;\n                    if(timeElapsed < fadeIn) {\n                        alpha = timeElapsed/fadeIn;\n                    }\n                    if(timeElapsed >= fadeIn && timeElapsed <= (lifeTime - fadeOut)) {\n                        alpha = 1.0;\n                    }\n                    if(timeElapsed > (lifeTime - fadeOut)) {\n                        alpha = 1.0 - (timeElapsed - (lifeTime-fadeOut))/fadeOut;\n                    }\n                    \n                    lifeLeft = 1.0 - ( timeElapsed / lifeTime );\n                    gl_PointSize = ( uScale * size );// * lifeLeft;\n                    newPosition = positionStart \n                        + (velocity * timeElapsed)\n                        + (acceleration * 0.5 * timeElapsed * timeElapsed)\n                        ;\n                    if (lifeLeft < 0.0) { \n                        lifeLeft = 0.0; \n                        gl_PointSize = 0.;\n                    }\n                    //while active use the new position\n                    if( timeElapsed > 0.0 ) {\n                        gl_Position = projectionMatrix * modelViewMatrix * vec4( newPosition, 1.0 );\n                    } else {\n                        //if dead use the initial position and set point size to 0\n                        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n                        lifeLeft = 0.0;\n                        gl_PointSize = 0.;\n                    }\n                }\n                ",fragmentShader:"\n                varying vec4 vColor;\n                varying vec4 vEndColor;\n                varying float lifeLeft;\n                varying float alpha;\n                uniform sampler2D tSprite;\n                void main() {\n                    // color based on particle texture and the lifeLeft. \n                    // if lifeLeft is 0 then make invisible\n                    vec4 tex = texture2D( tSprite, gl_PointCoord );\n                    vec4 color = mix(vColor, vEndColor, 1.0-lifeLeft);\n                    gl_FragColor = vec4( color.rgb*tex.rgb, alpha * tex.a);\n                }\n    \n            "},Lt=["positionStart","startTime","velocity","acceleration","color","endColor","size","lifeTime"],Tt=function(e){function t(e){var n,r;for(Object(s.a)(this,t),e=e||{},(n=Object(u.a)(this,Object(l.a)(t).call(this))).blending=e.blending?e.blending:dt.NormalBlending,n.PARTICLE_COUNT=e.maxParticles||1e6,n.PARTICLE_CURSOR=0,n.time=0,n.offset=0,n.count=0,n.DPR=window.devicePixelRatio,n.particleUpdate=!1,n.onTick=e.onTick,n.reverseTime=e.reverseTime,n.fadeIn=e.fadeIn||1,0===n.fadeIn&&(n.fadeIn=.001),n.fadeOut=e.fadeOut||1,0===n.fadeOut&&(n.fadeOut=.001),n.rand=[],r=1e5;r>0;r--)n.rand.push(Math.random()-.5);if(n.i=r,n.sprite=e.particleSpriteTex||null,!n.sprite){var i=document.createElement("canvas");i.width=16,i.height=16;var a=i.getContext("2d");a.fillStyle="black",a.fillRect(0,0,i.width,i.height),a.fillStyle="rgba(255,255,255,0.5)",a.beginPath(),a.arc(8,8,8,0,2*Math.PI),a.fill(),n.sprite=new dt.CanvasTexture(i)}return n.sprite.wrapS=n.sprite.wrapT=dt.RepeatWrapping,n.material=new dt.ShaderMaterial({transparent:!0,depthWrite:!1,uniforms:{uTime:{value:0},uScale:{value:1},tSprite:{value:n.sprite},reverseTime:{value:n.reverseTime},fadeIn:{value:n.fadeIn},fadeOut:{value:n.fadeOut}},blending:n.blending,vertexShader:Pt.vertexShader,fragmentShader:Pt.fragmentShader}),n.material.defaultAttributeValues.particlePositionsStartTime=[0,0,0,0],n.material.defaultAttributeValues.particleVelColSizeLife=[0,0,0,0],n.geometry=new dt.BufferGeometry,n.geometry.addAttribute("position",new dt.BufferAttribute(new Float32Array(3*n.PARTICLE_COUNT),3).setDynamic(!0)),n.geometry.addAttribute("positionStart",new dt.BufferAttribute(new Float32Array(3*n.PARTICLE_COUNT),3).setDynamic(!0)),n.geometry.addAttribute("velocity",new dt.BufferAttribute(new Float32Array(3*n.PARTICLE_COUNT),3).setDynamic(!0)),n.geometry.addAttribute("acceleration",new dt.BufferAttribute(new Float32Array(3*n.PARTICLE_COUNT),3).setDynamic(!0)),n.geometry.addAttribute("color",new dt.BufferAttribute(new Float32Array(3*n.PARTICLE_COUNT),3).setDynamic(!0)),n.geometry.addAttribute("endColor",new dt.BufferAttribute(new Float32Array(3*n.PARTICLE_COUNT),3).setDynamic(!0)),n.geometry.addAttribute("startTime",new dt.BufferAttribute(new Float32Array(n.PARTICLE_COUNT),1).setDynamic(!0)),n.geometry.addAttribute("size",new dt.BufferAttribute(new Float32Array(n.PARTICLE_COUNT),1).setDynamic(!0)),n.geometry.addAttribute("lifeTime",new dt.BufferAttribute(new Float32Array(n.PARTICLE_COUNT),1).setDynamic(!0)),n.particleSystem=new dt.Points(n.geometry,n.material),n.particleSystem.frustumCulled=!1,n.add(n.particleSystem),n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"geometryUpdate",value:function(){var e=this;!0===this.particleUpdate&&(this.particleUpdate=!1,Lt.forEach(function(t){var n=e.geometry.getAttribute(t);e.offset+e.count<e.PARTICLE_COUNT?(n.updateRange.offset=e.offset*n.itemSize,n.updateRange.count=e.count*n.itemSize):(n.updateRange.offset=0,n.updateRange.count=-1),n.needsUpdate=!0}),this.offset=0,this.count=0)}},{key:"random",value:function(){return++this.i>=this.rand.length?this.rand[this.i=1]:this.rand[this.i]}},{key:"update",value:function(e){this.time=e/1e3,this.material.uniforms.uTime.value=this.time,this.onTick&&this.onTick(this,this.time),this.geometryUpdate()}},{key:"dispose",value:function(){this.material.dispose(),this.sprite.dispose(),this.geometry.dispose()}},{key:"updateSprite",value:function(e){if(e){var t=this.sprite;this.sprite=e,this.sprite.wrapS=this.sprite.wrapT=dt.RepeatWrapping,this.material.uniforms.tSprite.value=e,t&&t.dispose()}}},{key:"spawnParticle",value:function(e){var t=new dt.Vector3,n=new dt.Vector3,r=new dt.Vector3,i=new dt.Color,a=new dt.Color,o=this.geometry.getAttribute("positionStart"),s=this.geometry.getAttribute("startTime"),c=this.geometry.getAttribute("velocity"),u=this.geometry.getAttribute("acceleration"),l=this.geometry.getAttribute("color"),h=this.geometry.getAttribute("endColor"),p=this.geometry.getAttribute("size"),d=this.geometry.getAttribute("lifeTime");t=void 0!==(e=e||{}).position?t.copy(e.position):t.set(0,0,0),n=void 0!==e.velocity?n.copy(e.velocity):n.set(0,0,0),r=void 0!==e.acceleration?r.copy(e.acceleration):r.set(0,0,0),i=void 0!==e.color?i.copy(e.color):i.set(16777215),a=void 0!==e.endColor?a.copy(e.endColor):a.copy(i);var f=void 0!==e.lifetime?e.lifetime:5,v=void 0!==e.size?e.size:10,m=void 0!==e.sizeRandomness?e.sizeRandomness:0;void 0!==this.DPR&&(v*=this.DPR);var y=this.PARTICLE_CURSOR;o.array[3*y+0]=t.x,o.array[3*y+1]=t.y,o.array[3*y+2]=t.z,c.array[3*y+0]=n.x,c.array[3*y+1]=n.y,c.array[3*y+2]=n.z,u.array[3*y+0]=r.x,u.array[3*y+1]=r.y,u.array[3*y+2]=r.z,l.array[3*y+0]=i.r,l.array[3*y+1]=i.g,l.array[3*y+2]=i.b,h.array[3*y+0]=a.r,h.array[3*y+1]=a.g,h.array[3*y+2]=a.b,p.array[y]=v+this.random()*m,d.array[y]=f,s.array[y]=this.time+.02*this.random(),0===this.offset&&(this.offset=this.PARTICLE_CURSOR),this.count++,this.PARTICLE_CURSOR++,this.PARTICLE_CURSOR>=this.PARTICLE_COUNT&&(this.PARTICLE_CURSOR=0),this.particleUpdate=!0}}]),t}(dt.Object3D),It=function(e,t){return Math.random()*(t-e)+e},Nt=0,Gt=function(e){function t(){return Object(s.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create cube w/ missing parent");return ae(e,e.createObject({type:qt.particles,title:"particles "+Nt++,visible:!0,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,children:e.createArray(),pointSize:10,lifetime:3,startColor:"#ff0000",endColor:"#0000ff",parent:t.id,texture:Yt.id}))}},{key:"makeNode",value:function(e,t){var n={velocity:new dt.Vector3(0,1,0),position:new dt.Vector3(0,0,0),size:e.pointSize,lifetime:e.lifetime,color:new dt.Color(1,0,1),endColor:new dt.Color(0,1,1)},r=new Tt({maxParticles:1e4,position:new dt.Vector3(0,0,0),positionRandomness:0,baseVelocity:new dt.Vector3(0,0,-1),velocity:new dt.Vector3(0,0,0),velocityRandomness:1,acceleration:new dt.Vector3(0,0,0),baseColor:new dt.Color(1,1,.5),color:new dt.Color(1,0,0),colorRandomness:.5,lifetime:3,size:10,sizeRandomness:1,blending:dt.AdditiveBlending,onTick:function(e,t){n.velocity.set(It(-1,1),1,It(-1,1)),e.spawnParticle(n)}});return r.tick=function(e){r.update(e.time)},this.attachTexture(r,e,t),r.userData.options=n,r.name=e.title,r.userData.clickable=!1,r.position.set(e.tx,e.ty,e.tz),r.rotation.set(e.rx,e.ry,e.rz),r.scale.set(e.sx,e.sy,e.sz),r.visible=e.visible,r}},{key:"updateProperty",value:function(e,n,r,i){return r.name===Zt.pointSize.key?e.userData.options.size=n.pointSize:r.name===Zt.lifetime.key?e.userData.options.lifetime=n.lifetime:r.name===Zt.startColor.key?e.userData.options.color.set(n.startColor):r.name===Zt.endColor.key?e.userData.options.endColor.set(n.endColor):r.name===Zt.texture.key?this.attachTexture(e,n,i):Object(d.a)(Object(l.a)(t.prototype),"updateProperty",this).call(this,e,n,r,i)}},{key:"attachTexture",value:function(e,t,n){if(t.asset!==Yt.id){var r=n.accessObject(t.texture);if(r.exists()){var i=n.assetsManager.getAssetURL(r);n.getLogger().log("ParticlesDef: loading the asset url",i);var a=(new dt.TextureLoader).load(i);e.updateSprite(a)}}else e.updateSprite(null)}}]),t}(ft),Bt=0,Ft=function(e){function t(){return Object(s.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't localanchor w/ missing parent");return ae(e,e.createObject({type:qt.localanchor,title:"localanchor "+Bt++,visible:!0,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,color:"#00ff00",children:e.createArray(),recType:ln.SCENE_START,parent:t.id}))}},{key:"makeNode",value:function(e,t){var n=new dt.Group;n.name=e.title,n.userData.clickable=!0,n.position.set(e.tx,e.ty,e.tz),n.rotation.set(e.rx,e.ry,e.rz),n.scale.set(e.sx,e.sy,e.sz),n.visible=e.visible;var r=new dt.Mesh(new dt.SphereBufferGeometry(1),new dt.MeshLambertMaterial({color:"blue",transparent:!0,opacity:.2}));r.material.visible=!0,r.userData.clickable=!0,n.userData.clicker=r,n.add(r);var i=new dt.Mesh(new dt.PlaneBufferGeometry(1,1),new dt.MeshLambertMaterial({color:"white",transparent:!0,opacity:.5,side:dt.DoubleSide}));return i.rotation.x=rn(90),n.add(i),n.userData.preview=i,n.enter=function(t,a){r.visible=!1,n.visible=!1,i.visible=!1,n.userData.info={recType:e.recType,object:e,node:n,callback:function(t){a.fireEventAtTarget(e,"recognized",t),n.visible=!0}},a.sgp.startLocalAnchor(n.userData.info)},n.exit=function(e,t){r.visible=!0,i.visible=!0,t.sgp.stopLocalAnchor(n.userData.info)},n}},{key:"updateProperty",value:function(e,n,r,i){return Object(d.a)(Object(l.a)(t.prototype),"updateProperty",this).call(this,e,n,r,i)}}]),t}(ft),Ut=0,zt=function(e){function t(){return Object(s.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't imageanchor w/ missing parent");return ae(e,e.createObject({type:qt.imageanchor,title:"image anchor "+Ut++,visible:!0,reactivate:!1,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,color:"#00ff00",children:e.createArray(),targetImage:null,imageRealworldWidth:1,recType:ln.SCENE_START,parent:t.id}))}},{key:"makeNode",value:function(e,t){var n=new dt.Group;n.name=e.title,n.userData.clickable=!0,n.position.set(e.tx,e.ty,e.tz),n.rotation.set(e.rx,e.ry,e.rz),n.scale.set(e.sx,e.sy,e.sz),n.visible=e.visible;var r=new dt.Mesh(new dt.SphereBufferGeometry(1),new dt.MeshLambertMaterial({color:"red",transparent:!0,opacity:.2}));r.material.visible=!0,r.userData.clickable=!0,n.userData.clicker=r,n.add(r);var i=new dt.Mesh(new dt.PlaneBufferGeometry(1,1),new dt.MeshLambertMaterial({color:"white",transparent:!0,opacity:.5,side:dt.DoubleSide}));return i.rotation.x=rn(90),n.add(i),n.userData.preview=i,this.updateImagePreview(n,e,t),n.enter=function(t,a){r.visible=!1,n.visible=!1,i.visible=!1,n.userData.info={image:a.sgp.getGraphObjectById(e.targetImage),imageRealworldWidth:e.imageRealworldWidth,reactivate:e.reactivate,recType:e.recType,object:e,node:n,callback:function(t){a.fireEventAtTarget(e,"recognized",t),n.visible=!0}},a.sgp.startImageRecognizer(n.userData.info)},n.exit=function(e,t){r.visible=!0,i.visible=!0,t.sgp.stopImageRecognizer(n.userData.info)},n}},{key:"updateProperty",value:function(e,n,r,i){return r.name===Zt.targetImage.key?this.updateImagePreview(e,n,i):r.name===Zt.imageRealworldWidth.key?this.updateImagePreview(e,n,i):Object(d.a)(Object(l.a)(t.prototype),"updateProperty",this).call(this,e,n,r,i)}},{key:"updateImagePreview",value:function(e,t,n){var r=n.accessObject(t.targetImage);if(r.exists()){var i=n.assetsManager.getAssetURL(r);n.getLogger().log("ImageAnchor loading the asset url",i);var a=(new dt.TextureLoader).load(i);e.userData.preview.material=new dt.MeshLambertMaterial({color:"white",transparent:!0,opacity:.5,side:dt.DoubleSide,map:a});var o=r.height/r.width;e.userData.preview.geometry=new dt.PlaneBufferGeometry(1,o);var s=t.imageRealworldWidth;e.userData.preview.scale.set(s,s,s)}n.accessObject(t.targetImage).exists()?(e.userData.preview.visible=!0,e.userData.clicker.visible=!1):(e.userData.preview.visible=!1,e.userData.clicker.visible=!0)}}]),t}(ft),Ht=0,Vt=function(e){function t(){return Object(s.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create geo anchor w/ missing parent");return ae(e,e.createObject({type:qt.geoanchor,title:"geo anchor "+Ht++,visible:!0,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,color:"#00ff00",children:e.createArray(),targetGeoLocation:null,recType:ln.SCENE_START,parent:t.id}))}},{key:"makeNode",value:function(e){var t=new dt.Group;t.name=e.title,t.userData.clickable=!0,t.position.set(e.tx,e.ty,e.tz),t.rotation.set(e.rx,e.ry,e.rz),t.scale.set(e.sx,e.sy,e.sz),t.visible=e.visible;var n=new dt.Mesh(new dt.SphereBufferGeometry(1),new dt.MeshLambertMaterial({color:"red",transparent:!0,opacity:.2}));return n.material.visible=!0,n.userData.clickable=!0,t.userData.clicker=n,t.add(n),t.enter=function(r,i){n.visible=!1,t.visible=!1,t.userData.info={location:i.sgp.getGraphObjectById(e.targetGeoLocation),recType:e.recType,object:e,node:t,callback:function(n){i.fireEventAtTarget(e,"localized",n),t.visible=!0}},i.sgp.startGeoTracker(t.userData.info)},t.exit=function(e,r){n.visible=!0,r.sgp.stopGeoTracker(t.userData.info)},t}}]),t}(ft),Wt=0,Kt=function(e){function t(){return Object(s.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't add hudanchor w/ missing parent");return ae(e,e.createObject({type:qt.hudanchor,title:"hud anchor "+Wt++,visible:!0,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,children:e.createArray(),parent:t.id}))}},{key:"makeNode",value:function(e,t){var n=new dt.Group;n.name=e.title,n.userData.clickable=!0,n.position.set(e.tx,e.ty,e.tz),n.rotation.set(e.rx,e.ry,e.rz),n.scale.set(e.sx,e.sy,e.sz),n.visible=e.visible;var r=new dt.Mesh(new dt.SphereBufferGeometry(1),new dt.MeshLambertMaterial({color:"red",transparent:!0,opacity:.2}));return r.material.visible=!0,r.userData.clickable=!0,n.userData.clicker=r,n.add(r),n.enter=function(e,t){n.parent.remove(n),n.position.z=0,r.visible=!1,t.sgp.getCamera().add(n)},n.exit=function(t,i){i.sgp.getCamera().remove(n),r.visible=!0,i.sgp.getThreeObject(e.parent).add(n),n.position.set(e.tx,e.ty,e.tz),n.rotation.set(e.rx,e.ry,e.rz),n.scale.set(e.sx,e.sy,e.sz)},n}},{key:"updateProperty",value:function(e,n,r,i){return Object(d.a)(Object(l.a)(t.prototype),"updateProperty",this).call(this,e,n,r,i)}}]),t}(ft),Yt={id:-30,title:"NONE"},Xt={incrementValue:.1},Zt={title:{key:"title",name:"Title",type:$.STRING},description:{key:"description",name:"Description",type:$.STRING},width:{key:"width",name:"Width",type:$.NUMBER,hints:Xt},height:{key:"height",name:"Height",type:$.NUMBER,hints:Xt},depth:{key:"depth",name:"Depth",type:$.NUMBER,hints:Xt},radius:{key:"radius",name:"Radius",type:$.NUMBER,hints:Xt},tx:{key:"tx",name:"TX",type:$.NUMBER,hints:Xt},ty:{key:"ty",name:"TY",type:$.NUMBER,hints:Xt},tz:{key:"tz",name:"TZ",type:$.NUMBER,hints:Xt},rx:{key:"rx",name:"RX",type:$.NUMBER,hints:Xt},ry:{key:"ry",name:"RY",type:$.NUMBER,hints:Xt},rz:{key:"rz",name:"RZ",type:$.NUMBER,hints:Xt},sx:{key:"sx",name:"SX",type:$.NUMBER,hints:Xt},sy:{key:"sy",name:"SY",type:$.NUMBER,hints:Xt},sz:{key:"sz",name:"SZ",type:$.NUMBER,hints:Xt},color:{key:"color",name:"Color",type:$.COLOR,custom:!0},defaultFloor:{key:"defaultFloor",name:"Default Floor",type:$.BOOLEAN},src:{key:"src",name:"src",type:$.STRING,locked:!0},asset:{key:"asset",name:"asset",type:$.ENUM},subtype:{key:"subtype",name:"kind",type:$.STRING,locked:!0},format:{key:"format",name:"format",type:$.STRING,locked:!0},imageOffsetAngle:{key:"imageOffsetAngle",name:"Image Offset Angle",type:$.NUMBER,hints:{incrementValue:.05}},imageCropStartAngle:{key:"imageCropStartAngle",name:"Image Crop Start Angle",type:$.NUMBER,hints:{incrementValue:.05}},imageCropEndAngle:{key:"imageCropEndAngle",name:"Image Crop End Angle",type:$.NUMBER,hints:{incrementValue:.05}},imageRealworldWidth:{key:"imageRealworldWidth",name:"Image width in meters",type:$.NUMBER,hints:{incrementValue:.01}},recType:{key:"recType",name:"Recognition Type",type:$.ENUM},targetImage:{key:"targetImage",name:"Image to Recognize",type:$.ENUM},targetGeoLocation:{key:"targetGeoLocation",name:"Target Location",type:$.ENUM},splashImage:{key:"splashImage",name:"Splash Image",type:$.ENUM},text:{key:"text",name:"Text",type:$.STRING,hints:{multiline:!0}},fontSize:{key:"fontSize",name:"Font Size",type:$.NUMBER},padding:{key:"padding",name:"Padding",type:$.NUMBER},borderWidth:{key:"borderWidth",name:"Border width",type:$.NUMBER},borderRadius:{key:"borderRadius",name:"Corner Size",type:$.NUMBER},horizontalAlign:{key:"horizontalAlign",name:"H Align",type:$.ENUM,locked:!1},textColor:{key:"textColor",name:"Text Color",type:$.COLOR,custom:!0},backgroundColor:{key:"backgroundColor",name:"BG Color",type:$.COLOR,custom:!0},borderColor:{key:"borderColor",name:"Border Color",type:$.COLOR,custom:!0},startColor:{key:"startColor",name:"Start",type:$.COLOR,custom:!0},endColor:{key:"endColor",name:"End",type:$.COLOR,custom:!0},drawBackground:{key:"drawBackground",name:"BG?",type:$.BOOLEAN},scriptBody:{key:"scriptBody",name:"code",type:$.STRING,hints:{multiline:!0}},defaultScene:{key:"defaultScene",name:"Start Scene",type:$.ENUM},visible:{key:"visible",name:"Visible",type:$.BOOLEAN},reactivate:{key:"reactivate",name:"Reactivate Image Search",type:$.BOOLEAN},pointSize:{key:"pointSize",name:"Point Size",type:$.NUMBER},lifetime:{key:"lifetime",name:"Lifetime",type:$.NUMBER,hints:Xt},texture:{key:"texture",name:"texture",type:$.ENUM},cssStyle:{key:"cssStyle",name:"Style",type:$.STRING,hints:{multiline:!0}},latitude:{key:"latitude",name:"Latitude",type:$.NUMBER},longitude:{key:"longitude",name:"Longitude",type:$.NUMBER},altitude:{key:"altitude",name:"altitude",type:$.NUMBER},useAltitude:{key:"useAltitude",name:"use altitude?",type:$.BOOLEAN},autoRecenter:{key:"autoRecenter",name:"Recenter on Load",type:$.BOOLEAN}},Qt=["#ffffff","#ff0000","#ffff00","#00ff00","#00ffff","#0000ff","#ff00ff","#000000"],qt={cube:"cube",sphere:"sphere",plane:"plane",model:"model",bg360:"bg360",text:"text",img2d:"img2d",group:"group",particles:"particles",localanchor:"localanchor",imageanchor:"imageanchor",geoanchor:"geoanchor",hudanchor:"hudanchor"},Jt={SCENE:"scene",ASSET:"asset",BEHAVIOR:"behavior",BEHAVIOR_SCRIPT:"behavior_script",ASSETS_LIST:"assets",BEHAVIORS_LIST:"behaviors",ROOT:"root"},$t={LEFT:"LEFT",CENTER:"CENTER",RIGHT:"RIGHT"};function _t(e){return e===qt.cube||(e===qt.sphere||(e===qt.plane||(e===qt.model||(e===qt.text||(e===qt.bg360||(e===qt.img2d||(e===qt.group||(e===qt.particles||(e===qt.localanchor||(e===qt.imageanchor||(e===qt.geoanchor||e===qt.hudanchor)))))))))))}function en(e){return e===qt.group||(e===qt.localanchor||(e===qt.imageanchor||(e===qt.geoanchor||(e===qt.hudanchor||e===Jt.SCENE))))}function tn(e){return e!==Jt.ROOT&&(e!==Jt.ASSETS_LIST&&e!==Jt.BEHAVIORS_LIST)}function nn(e){if(e===qt.cube)return new mt;if(e===qt.sphere)return new yt;if(e===qt.plane)return new gt;if(e===qt.model)return new xt;if(e===qt.bg360)return new Ct;if(e===qt.text)return new Et;if(e===qt.img2d)return new jt;if(e===qt.group)return new Rt;if(e===qt.particles)return new Gt;if(e===qt.localanchor)return new Ft;if(e===qt.imageanchor)return new zt;if(e===qt.geoanchor)return new Vt;if(e===qt.hudanchor)return new Kt;throw new Error("unknown 3d object type ".concat(e))}var rn=function(e){return e*Math.PI/180},an={PNG:"image/png",JPEG:"image/jpeg",GIF:"image/gif",MP3:"audio/mpeg",AAC:"audio/aac",WAV:"audio/wav",JAVASCRIPT:"text/javascript",GLB:"model/gltf-binary",MP4:"video/mp4"},on={BEHAVIOR:"behavior",IMAGE:"image",GLTF:"gltf",AUDIO:"audio",VIDEO:"video",GEOLOCATION:"geolocation"};function sn(e){return!!e&&(e.toLowerCase()===an.PNG||(e.toLowerCase()===an.JPEG||e.toLowerCase()===an.GIF))}var cn={plane:"plane",cube:"square",sphere:"circle",model:"cube",asset:"file",assets:"archive",behavior:"superpowers",behavior_script:"superpowers",scene:"globe",bg360:"image",img2d:"image",image:"image",text:"font",audio:"music",video:"video-camera",group:"object-group",particles:"certificate",gltf:"cube",localanchor:"anchor",imageanchor:"anchor",geoanchor:"globe",geolocation:"globe",hudanchor:"eye",cut:"cut",copy:"copy",paste:"paste",delete:"close"};function un(e){return Function('"use strict";\n    const toRadians = (deg) => Math.PI/180*deg; \n    return('.concat(e,")"))()}var ln={SCENE_START:"SCENE_START"},hn=n(1),pn=function(e,t){var n,r,i,a,o;this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.target=new hn.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.25,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.enableKeys=!0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={ORBIT:hn.MOUSE.LEFT,ZOOM:hn.MOUSE.MIDDLE,PAN:hn.MOUSE.RIGHT},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=function(){return f.phi},this.getAzimuthalAngle=function(){return f.theta},this.saveState=function(){s.target0.copy(s.target),s.position0.copy(s.object.position),s.zoom0=s.object.zoom},this.reset=function(){s.target.copy(s.target0),s.object.position.copy(s.position0),s.object.zoom=s.zoom0,s.object.updateProjectionMatrix(),s.dispatchEvent(c),s.update(),p=h.NONE},this.update=(n=new hn.Vector3,r=(new hn.Quaternion).setFromUnitVectors(e.up,new hn.Vector3(0,1,0)),i=r.clone().inverse(),a=new hn.Vector3,o=new hn.Quaternion,function(){var e=s.object.position;return n.copy(e).sub(s.target),n.applyQuaternion(r),f.setFromVector3(n),s.autoRotate&&p===h.NONE&&j(2*Math.PI/60/60*s.autoRotateSpeed),f.theta+=v.theta,f.phi+=v.phi,f.theta=Math.max(s.minAzimuthAngle,Math.min(s.maxAzimuthAngle,f.theta)),f.phi=Math.max(s.minPolarAngle,Math.min(s.maxPolarAngle,f.phi)),f.makeSafe(),f.radius*=m,f.radius=Math.max(s.minDistance,Math.min(s.maxDistance,f.radius)),s.target.add(y),n.setFromSpherical(f),n.applyQuaternion(i),e.copy(s.target).add(n),s.object.lookAt(s.target),!0===s.enableDamping?(v.theta*=1-s.dampingFactor,v.phi*=1-s.dampingFactor):v.set(0,0,0),m=1,y.set(0,0,0),!!(g||a.distanceToSquared(s.object.position)>d||8*(1-o.dot(s.object.quaternion))>d)&&(s.dispatchEvent(c),a.copy(s.object.position),o.copy(s.object.quaternion),g=!1,!0)}),this.dispose=function(){s.domElement.removeEventListener("contextmenu",K,!1),s.domElement.removeEventListener("mousedown",G,!1),s.domElement.removeEventListener("wheel",U,!1),s.domElement.removeEventListener("touchstart",H,!1),s.domElement.removeEventListener("touchend",W,!1),s.domElement.removeEventListener("touchmove",V,!1),document.removeEventListener("mousemove",B,!1),document.removeEventListener("mouseup",F,!1),window.removeEventListener("keydown",z,!1)};var s=this,c={type:"change"},u={type:"start"},l={type:"end"},h={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},p=h.NONE,d=1e-6,f=new hn.Spherical,v=new hn.Spherical,m=1,y=new hn.Vector3,g=!1,b=new hn.Vector2,w=new hn.Vector2,O=new hn.Vector2,k=new hn.Vector2,S=new hn.Vector2,A=new hn.Vector2,x=new hn.Vector2,C=new hn.Vector2,M=new hn.Vector2;function E(){return Math.pow(.95,s.zoomSpeed)}function j(e){v.theta-=e}function D(e){v.phi-=e}var R,P=(R=new hn.Vector3,function(e,t){R.setFromMatrixColumn(t,0),R.multiplyScalar(-e),y.add(R)}),L=function(){var e=new hn.Vector3;return function(t,n){e.setFromMatrixColumn(n,1),e.multiplyScalar(t),y.add(e)}}(),T=function(){var e=new hn.Vector3;return function(t,n){var r=s.domElement===document?s.domElement.body:s.domElement;if(s.object.isPerspectiveCamera){var i=s.object.position;e.copy(i).sub(s.target);var a=e.length();a*=Math.tan(s.object.fov/2*Math.PI/180),P(2*t*a/r.clientHeight,s.object.matrix),L(2*n*a/r.clientHeight,s.object.matrix)}else s.object.isOrthographicCamera?(P(t*(s.object.right-s.object.left)/s.object.zoom/r.clientWidth,s.object.matrix),L(n*(s.object.top-s.object.bottom)/s.object.zoom/r.clientHeight,s.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),s.enablePan=!1)}}();function I(e){s.object.isPerspectiveCamera?m/=e:s.object.isOrthographicCamera?(s.object.zoom=Math.max(s.minZoom,Math.min(s.maxZoom,s.object.zoom*e)),s.object.updateProjectionMatrix(),g=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),s.enableZoom=!1)}function N(e){s.object.isPerspectiveCamera?m*=e:s.object.isOrthographicCamera?(s.object.zoom=Math.max(s.minZoom,Math.min(s.maxZoom,s.object.zoom/e)),s.object.updateProjectionMatrix(),g=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),s.enableZoom=!1)}function G(e){if(!1!==s.enabled){switch(e.preventDefault(),e.button){case s.mouseButtons.ORBIT:if(!1===s.enableRotate)return;!function(e){b.set(e.clientX,e.clientY)}(e),p=h.ROTATE;break;case s.mouseButtons.ZOOM:if(!1===s.enableZoom)return;!function(e){x.set(e.clientX,e.clientY)}(e),p=h.DOLLY;break;case s.mouseButtons.PAN:if(!1===s.enablePan)return;!function(e){k.set(e.clientX,e.clientY)}(e),p=h.PAN}p!==h.NONE&&(document.addEventListener("mousemove",B,!1),document.addEventListener("mouseup",F,!1),s.dispatchEvent(u))}}function B(e){if(!1!==s.enabled)switch(e.preventDefault(),p){case h.ROTATE:if(!1===s.enableRotate)return;!function(e){w.set(e.clientX,e.clientY),O.subVectors(w,b);var t=s.domElement===document?s.domElement.body:s.domElement;j(2*Math.PI*O.x/t.clientWidth*s.rotateSpeed),D(2*Math.PI*O.y/t.clientHeight*s.rotateSpeed),b.copy(w),s.update()}(e);break;case h.DOLLY:if(!1===s.enableZoom)return;!function(e){C.set(e.clientX,e.clientY),M.subVectors(C,x),M.y>0?I(E()):M.y<0&&N(E()),x.copy(C),s.update()}(e);break;case h.PAN:if(!1===s.enablePan)return;!function(e){S.set(e.clientX,e.clientY),A.subVectors(S,k),T(A.x,A.y),k.copy(S),s.update()}(e)}}function F(e){!1!==s.enabled&&(document.removeEventListener("mousemove",B,!1),document.removeEventListener("mouseup",F,!1),s.dispatchEvent(l),p=h.NONE)}function U(e){!1===s.enabled||!1===s.enableZoom||p!==h.NONE&&p!==h.ROTATE||(e.preventDefault(),e.stopPropagation(),function(e){e.deltaY<0?N(E()):e.deltaY>0&&I(E()),s.update()}(e),s.dispatchEvent(u),s.dispatchEvent(l))}function z(e){!1!==s.enabled&&!1!==s.enableKeys&&!1!==s.enablePan&&function(e){switch(e.keyCode){case s.keys.UP:T(0,s.keyPanSpeed),s.update();break;case s.keys.BOTTOM:T(0,-s.keyPanSpeed),s.update();break;case s.keys.LEFT:T(s.keyPanSpeed,0),s.update();break;case s.keys.RIGHT:T(-s.keyPanSpeed,0),s.update()}}(e)}function H(e){if(!1!==s.enabled){switch(e.touches.length){case 1:if(!1===s.enableRotate)return;!function(e){b.set(e.touches[0].pageX,e.touches[0].pageY)}(e),p=h.TOUCH_ROTATE;break;case 2:if(!1===s.enableZoom)return;!function(e){var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,r=Math.sqrt(t*t+n*n);x.set(0,r)}(e),p=h.TOUCH_DOLLY;break;case 3:if(!1===s.enablePan)return;!function(e){k.set(e.touches[0].pageX,e.touches[0].pageY)}(e),p=h.TOUCH_PAN;break;default:p=h.NONE}p!==h.NONE&&s.dispatchEvent(u)}}function V(e){if(!1!==s.enabled)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:if(!1===s.enableRotate)return;if(p!==h.TOUCH_ROTATE)return;!function(e){w.set(e.touches[0].pageX,e.touches[0].pageY),O.subVectors(w,b);var t=s.domElement===document?s.domElement.body:s.domElement;j(2*Math.PI*O.x/t.clientWidth*s.rotateSpeed),D(2*Math.PI*O.y/t.clientHeight*s.rotateSpeed),b.copy(w),s.update()}(e);break;case 2:if(!1===s.enableZoom)return;if(p!==h.TOUCH_DOLLY)return;!function(e){var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,r=Math.sqrt(t*t+n*n);C.set(0,r),M.subVectors(C,x),M.y>0?N(E()):M.y<0&&I(E()),x.copy(C),s.update()}(e);break;case 3:if(!1===s.enablePan)return;if(p!==h.TOUCH_PAN)return;!function(e){S.set(e.touches[0].pageX,e.touches[0].pageY),A.subVectors(S,k),T(A.x,A.y),k.copy(S),s.update()}(e);break;default:p=h.NONE}}function W(e){!1!==s.enabled&&(s.dispatchEvent(l),p=h.NONE)}function K(e){!1!==s.enabled&&e.preventDefault()}s.domElement.addEventListener("contextmenu",K,!1),s.domElement.addEventListener("mousedown",G,!1),s.domElement.addEventListener("wheel",U,!1),s.domElement.addEventListener("touchstart",H,!1),s.domElement.addEventListener("touchend",W,!1),s.domElement.addEventListener("touchmove",V,!1),this.update()};(pn.prototype=Object.create(hn.EventDispatcher.prototype)).constructor=hn.OrbitControls,Object.defineProperties(pn.prototype,{center:{get:function(){return console.warn("THREE.OrbitControls: .center has been renamed to .target"),this.target}},noZoom:{get:function(){return console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),!this.enableZoom},set:function(e){console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),this.enableZoom=!e}},noRotate:{get:function(){return console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),!this.enableRotate},set:function(e){console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),this.enableRotate=!e}},noPan:{get:function(){return console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),!this.enablePan},set:function(e){console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),this.enablePan=!e}},noKeys:{get:function(){return console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),!this.enableKeys},set:function(e){console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),this.enableKeys=!e}},staticMoving:{get:function(){return console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),!this.enableDamping},set:function(e){console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),this.enableDamping=!e}},dynamicDampingFactor:{get:function(){return console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor},set:function(e){console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor=e}}});var dn=pn,fn=function(e){function t(){var e,n;Object(s.a)(this,t);for(var r=arguments.length,i=new Array(r),a=0;a<r;a++)i[a]=arguments[a];return(n=Object(u.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(i)))).renderThree=function(e){var t=(e-n.prevTime)/1e3;n.controls.update(),n.mixer&&n.mixer.update(t),n.renderer.render(n.scene,n.camera),n.prevTime=e},n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){this.initThreeJS()}},{key:"render",value:function(){var e=this;return i.a.createElement("div",null,"GLTF viewer",i.a.createElement("div",{ref:function(t){return e.sceneContainer=t}}))}},{key:"initThreeJS",value:function(){var e=this,t=this.props.asset;this.scene=new dt.Scene,this.scene.background=new dt.Color(0),this.camera=new dt.PerspectiveCamera(70,window.innerWidth/window.innerHeight,.1,1e3),this.scene.add(this.camera),this.renderer=new dt.WebGLRenderer({antialias:!0}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.gammaOutput=!0,this.sceneContainer.appendChild(this.renderer.domElement),this.clips=[],this.mixer=null,this.model=null,window.addEventListener("resize",function(){e.camera.aspect=window.innerWidth/window.innerHeight,e.camera.updateProjectionMatrix(),e.renderer.setSize(window.innerWidth,window.innerHeight)},!1),this.controls=new dn(this.camera,this.renderer.domElement),this.controls.screenSpacePanning=!0,this.renderer.setAnimationLoop(this.renderThree);var n=new dt.DirectionalLight(16777215,1);n.position.set(1,1,1).normalize(),this.scene.add(n),this.scene.add(new dt.AmbientLight(16777215,.2));var r=new wt;r.setCrossOrigin("anonymous");var i=new kt;kt.setDecoderPath("./draco/"),r.setDRACOLoader(i);var a=this.props.provider.assetsManager.getAssetURL(t);this.props.provider.getLogger().log("GLTFAssetView loading the url",a),a?r.load(a,function(t){console.log("loaded",a);var n=t.scene||t.scenes[0];e.model=At.clone(n),(n=e.model).updateMatrixWorld();var r=t.animations||[];e.setClips(r);var i=(new dt.Box3).setFromObject(n),o=i.getSize(new dt.Vector3).length(),s=i.getCenter(new dt.Vector3);e.controls.reset(),n.position.x+=n.position.x-s.x,n.position.y+=n.position.y-s.y,n.position.z+=n.position.z-s.z,e.controls.maxDistance=10*o,e.camera.near=o/100,e.camera.far=100*o,e.camera.updateProjectionMatrix(),e.camera.position.copy(s),e.camera.position.x+=o/2,e.camera.position.y+=o/5,e.camera.position.z+=o/2,e.camera.lookAt(s),e.controls.enabled=!0,e.playAllClips(),e.scene.add(n)}):this.props.provider.getLogger().error("GLTFAssetView url is empty!")}},{key:"playAllClips",value:function(){var e=this;this.clips.forEach(function(t){e.mixer.clipAction(t).reset().play()})}},{key:"setClips",value:function(e){this.mixer&&(this.mixer.stopAllAction(),this.mixer.uncacheRoot(this.mixer.getRoot()),this.mixer=null),e.forEach(function(e){e.validate()&&e.optimize()}),e.length&&(this.clips=e,this.mixer=new dt.AnimationMixer(this.model))}}]),t}(r.Component),vn=n(22),mn=(n(61),function(e){function t(e,n){var r;return Object(s.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e,n))).loadCurrentLocation=function(){navigator.geolocation.getCurrentPosition(function(e){console.log("success",e);var t=e.coords;r.props.provider.quick_setPropertyValue(r.props.asset.id,"latitude",t.latitude),r.props.provider.quick_setPropertyValue(r.props.asset.id,"longitude",t.longitude)},function(e){console.log("error",e)})},r.onMapClick=function(e){r.props.provider.quick_setPropertyValue(r.props.asset.id,"latitude",e.latlng.lat),r.props.provider.quick_setPropertyValue(r.props.asset.id,"longitude",e.latlng.lng)},r.updateLocation=function(e){var t=r.props.provider.accessObject(r.props.asset.id),n=Object(vn.b)({lat:t.latitude,lon:t.longitude});r.marker.setLatLng(n),r.mymap.panTo(n)},r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){var e=this;return i.a.createElement("div",null,i.a.createElement(p.c,null,i.a.createElement("button",{onClick:this.loadCurrentLocation},"set to current location")),i.a.createElement("div",{id:"mapid",ref:function(t){return e.div=t},style:{width:"400px",height:"400px",border:"1px solid black"}}))}},{key:"componentWillReceiveProps",value:function(e,t){e.asset.id!==this.props.asset.id&&this.updateLocation()}},{key:"componentDidMount",value:function(){this.mymap=Object(vn.c)("mapid").setView([this.props.asset.longitude,this.props.asset.latitude],18),Object(vn.e)("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw",{maxZoom:18,attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery \xa9 <a href="https://www.mapbox.com/">Mapbox</a>',id:"mapbox.streets"}).addTo(this.mymap),this.mymap.on("click",this.onMapClick);var e=Object(vn.a)({className:"map-icon"});this.marker=Object(vn.d)([this.props.asset.longitude,this.props.asset.latitude],{title:"this is the geo location",icon:e}).addTo(this.mymap),this.props.provider.on(B.PROPERTY_CHANGED,this.updateLocation),this.updateLocation()}},{key:"componentWillUnmount",value:function(){this.props.provider.off(B.PROPERTY_CHANGED,this.updateLocation)}}]),t}(r.Component)),yn=function(e){function t(){return Object(s.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){var e=ae(this.props.provider.getDataGraph(),this.props.asset);return i.a.createElement("div",null,i.a.createElement("h3",null,e.subtype," : ",i.a.createElement("b",null,e.title)),this.renderAsset(e))}},{key:"renderAsset",value:function(e){var t=this.props.provider.assetsManager.getAssetURL(e);return e.subtype===on.IMAGE?i.a.createElement("img",{src:t,alt:e.title}):e.subtype===on.AUDIO?i.a.createElement("audio",{src:t,controls:!0}):e.subtype===on.VIDEO?i.a.createElement("video",{src:t,controls:!0,playsInline:!0,crossOrigin:"anonymous"}):e.subtype===on.BEHAVIOR?i.a.createElement("div",null,t):e.subtype===on.GLTF?i.a.createElement(fn,{asset:e,provider:this.props.provider}):e.subtype===on.GEOLOCATION?i.a.createElement(mn,{asset:e,provider:this.props.provider}):i.a.createElement("div",null,"unknown type")}}]),t}(r.Component);function gn(e,t,n,r,i){G.supportsAssetUpload()||(e=r);var a=i.accessObject(i.getDataGraph().createObject({type:Jt.ASSET,subtype:on.IMAGE,assetId:e,format:n,src:t,width:100,height:100,title:r,parent:0}));i.accessObject(i.getAssetsObject()).insertChildLast(a),i.requestImageCache(i.assetsManager.getAssetURL(a)).then(function(e){a.set("width",e.width),a.set("height",e.height)})}function bn(e,t){I.add("uploading "+e.name),t.uploadFile(e).then(function(n){return I.add("uploaded"),!1===n.success?console.log("there was an error uploading! :("):gn(null,z()+n.asset.id,n.asset.mimeType,e.name,t)})}function wn(e,t){I.add("uploading "+e.name),t.uploadFile(e).then(function(n){if(I.add("uploaded"),!1===n.success)return console.log("there was an error uploading! :(");var r=z()+n.asset.id,i=t.getDataGraph(),a=ae(i,i.createObject({type:Jt.ASSET,subtype:on.GLTF,format:an.GLB,src:r,title:e.name,parent:0}));t.accessObject(t.getAssetsObject()).insertChildLast(a)})}function On(e,t,n,r,i){if(r||(r=t.substring(t.lastIndexOf("/")+1)),!n){var a=r.substring(r.lastIndexOf(".")+1);n="audio/unknown","mp3"===a.toLowerCase()&&(n=an.MP3),"aac"===a.toLowerCase()&&(n=an.AAC)}G.supportsAssetUpload()||(e=r);var o=i.getDataGraph(),s=ae(o,o.createObject({type:Jt.ASSET,subtype:on.AUDIO,assetId:e,format:n,src:t,title:r,parent:0}));i.accessObject(i.getAssetsObject()).insertChildLast(s)}var kn=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this,e))).cancel=function(){p.b.hide()},n.okay=function(){var e,t,r,i,a;p.b.hide(),"remote"===n.state.view?(console.log("adding the url",n.state.url),e=n.state.url,t=n.props.provider,r=e.substring(e.lastIndexOf("/")+1),i=r.substring(r.lastIndexOf(".")+1),a="image/unknown","png"===i.toLowerCase()&&(a=an.PNG),"jpg"===i.toLowerCase()&&(a=an.JPEG),"jpeg"===i.toLowerCase()&&(a=an.JPEG),gn(null,e,a,r,t)):(console.log("the file input is",n.fileInput),re(n.fileInput.current.files).forEach(function(e){bn(e,n.props.provider)}))},n.switchLocal=function(){return n.setState({view:"local"})},n.switchRemote=function(){return n.setState({view:"remote"})},n.selectedFile=function(e){n.setState({fileInput:e.target.value})},n.typedURL=function(e){n.setState({url:e.target.value})},n.state={view:"local",url:""},n.fileInput=i.a.createRef(),n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){return i.a.createElement(Ie,{visible:!0,onScrimClick:this.cancel},i.a.createElement(p.f,{grow:!0},i.a.createElement("h3",null,"add image to assets"),i.a.createElement(p.f,{grow:!0},i.a.createElement(S,null,i.a.createElement(C,{onClick:this.switchLocal,selected:"local"===this.state.view},"local"),i.a.createElement(C,{onClick:this.switchRemote,selected:"remote"===this.state.view},"remote")),this.renderSelectedPanel()),i.a.createElement(p.c,null,i.a.createElement("button",{onClick:this.cancel},"cancel"),i.a.createElement("button",{onClick:this.okay},"okay"))))}},{key:"renderSelectedPanel",value:function(){return"local"===this.state.view?i.a.createElement(p.c,null,i.a.createElement("label",null,"File",i.a.createElement("input",{key:"f1",type:"file",onChange:this.selectedFile,ref:this.fileInput}))):i.a.createElement(p.c,null,i.a.createElement("label",null,"URL",i.a.createElement("input",{key:"f2",value:this.state.url,type:"input",onChange:this.typedURL})))}}]),t}(r.Component),Sn=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this,e))).redraw=function(){if(n.canvas){var e=n.canvas.getContext("2d"),t=n.props.provider.getPageSize(n.props.page).as(de.PIXEL,1,fe);n.canvas.width=t.width,n.canvas.height=t.height,e.fillStyle="white",e.fillRect(0,0,n.canvas.width,n.canvas.height),e.save(),e.scale(n.state.scale,n.state.scale);var r=n.props.provider.getRawGraph(),i=n.props.page;i&&n.drawPage(e,r,i),e.restore()}},n.handleKeypress=function(e){"ArrowRight"===e.key&&n.props.onNext(),"ArrowLeft"===e.key&&n.props.onPrev()},n.state={scale:1},n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){this.canvas.focus(),this.redraw()}},{key:"componentDidUpdate",value:function(e){this.redraw()}},{key:"drawPage",value:function(e,t,n){var r=this;oe(t,n.children).forEach(function(n){return r.drawLayer(e,t,ae(t,n))})}},{key:"drawLayer",value:function(e,t,n){var r=this;oe(t,n.children).forEach(function(n){return r.drawShape(e,t,ae(t,n))})}},{key:"drawShape",value:function(e,t,n){var r=this.props.provider.getShapeDef(n.type);r&&r.draw(e,t,n,R.getSelection()===n.id,this.props.provider)}},{key:"render",value:function(){var e=this;return i.a.createElement("canvas",{tabIndex:-1,width:100,height:100,ref:function(t){return e.canvas=t},style:{width:"100vw"},onClick:this.props.onNext,onKeyDown:this.handleKeypress})}}]),t}(r.Component),An=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this,e))).docSwapped=function(){return n.setState({pageIndex:0})},n.onNext=function(){var e=n.getPages();n.state.pageIndex===e.length-1&&(n.state.pageIndex=-1),n.setState({pageIndex:n.state.pageIndex+1})},n.onPrev=function(){var e=n.getPages();0===n.state.pageIndex&&(n.state.pageIndex=e.length),n.setState({pageIndex:n.state.pageIndex-1})},n.state={pageIndex:-1},n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){this.props.provider.on(B.DOCUMENT_SWAPPED,this.docSwapped)}},{key:"getPages",value:function(){var e=this.props.provider;return e.accessObject(e.getSceneRoot()).array("children").map(function(t){return e.accessObject(t)}).filter(function(e){return"page"===e.type})}},{key:"render",value:function(){var e=this.props.provider,t=this.getPages();if(this.state.pageIndex<0)return i.a.createElement("div",null,"no pages loaded");var n=t[this.state.pageIndex];return i.a.createElement(Sn,{page:n,provider:e,onNext:this.onNext,onPrev:this.onPrev})}}]),t}(r.Component);function xn(e,t){var n=e,r=t.createObject();return t.getPropertiesForObject(n).forEach(function(e){if("children"===e){var i=function(e,t){for(var n=t.createArray(),r=t.getArrayLength(e),i=0;i<r;i++){var a=t.getElementAt(e,i),o=xn(a,t);t.insertElement(n,i,o)}return n}(t.getPropertyValue(n,e),t);t.createProperty(r,e,i)}else t.createProperty(r,e,t.getPropertyValue(n,e))}),r}var Cn=function(){function e(t){Object(s.a)(this,e),this.graph=t}return Object(c.a)(e,[{key:"object",value:function(e){var t=this;if(e&&e.id&&e.exists&&e.exists())return console.log("someone created a graphaccessor on an existing object"),e;if(this.graph.hasObject(e)){var n={};return this.graph.getPropertiesForObject(e).forEach(function(r){n[r]=t.graph.getPropertyValue(e,r)}),n.id=e,n.exists=function(){return!0},n.set=function(r,i){return t.graph.setProperty(e,r,i),n},n.props=function(){var n={};return t.graph.getPropertiesForObject(e).forEach(function(r){n[r]=t.graph.getPropertyValue(e,r)}),n},n.array=function(e){for(var r=n[e],i=t.graph.getArrayLength(r),a=[],o=0;o<i;o++)a.push(t.graph.getElementAt(r,o));return a},n.getChildren=function(){return n.children?n.array("children").map(function(e){return t.object(e)}):[]},n.insertChildLast=function(e){t.graph.setProperty(e.id,"parent",n.id);var r=t.graph.getPropertyValue(n.id,"children"),i=t.graph.getArrayLength(r),a=t.graph.getElementAt(r,i-1);t.graph.insertAfter(r,a,e.id)},n.insertFirstChild=function(e){t.graph.setProperty(e.id,"parent",n.id);var r=t.graph.getPropertyValue(n.id,"children");t.graph.insertAfter(r,null,e.id)},n.child=function(e){return t.object(n.array("children")[e])},n.removeFromParent=function(){var e=t.object(n.parent),r=e.array("children").findIndex(function(e){return e===n.id});r>=0?t.graph.removeElement(e.children,r):console.error("could not find index for child",n,"in children",e.children)},n.getParent=function(){return t.object(n.parent)},n.clone=function(){var e=xn(n.id,t.graph);return t.object(e)},n.find=function(e,t){return t||(t=[]),e(n)&&t.push(n),n.children&&n.getChildren().forEach(function(n){n.find(e,t)}),t},n}return{exists:function(){return!1}}}}]),e}(),Mn=function(e){var t="---";e.value&&e.provider&&(t=e.provider.getDataGraph().getPropertyValue(e.value,"title"));return i.a.createElement("b",null,t)},En=[{name:"1024 x 768 pixels",value:"1024x768px"},{name:"VGA (640x480)",value:"640x480px"},{name:"A4 paper",value:"210x297mm"},{name:"16:9",value:"300x169mm"},{name:"4:3",value:"225x169mm"}],jn=function(e){var t="---";if(e.value&&e.provider){var n=En.find(function(t){return t.value===e.value});t=n?n.name:e.value}return i.a.createElement("b",null,t)},Dn=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this,e))).getApp=function(){return"view"===n.mode?i.a.createElement(An,{provider:Object(f.a)(Object(f.a)(n))}):i.a.createElement(Rn,{provider:Object(f.a)(Object(f.a)(n))})},n.getTitle=function(){return"MetaDoc"},n.getRendererForItem=function(e){if(!n.getDataGraph().getObjectById(e))return i.a.createElement("div",null,"???");var t=n.getDataGraph().getPropertyValue(e,"type"),r=n.getDataGraph().getPropertyValue(e,"title");return Ze[t]?i.a.createElement("div",null,i.a.createElement("i",{className:"fa fa-".concat(Ze[t])})," ",r):i.a.createElement("div",null,r)},n.addShape=function(e){var t=n.getDataGraph(),r=n.getSelectedLayer();if(!r)return console.error("no layer!");se(t,r,e.make(t,r))},n.addRect=function(){return n.addShape(n.getShapeDef("rect"))},n.addCircle=function(){return n.addShape(n.getShapeDef("circle"))},n.addText=function(){return n.addShape(n.getShapeDef("text"))},n.addImage=function(){return n.addShape(n.getShapeDef("image"))},n.addImageAssetFromFile=function(e){n.uploadFile(e).then(function(t){console.log("uploaded file with answer",t);var r=z()+t.id,i=n.getDataGraph(),a=ae(i,i.createObject({type:"asset",subtype:"image",format:e.type,src:r,width:100,height:100,title:e.name,parent:0})),o=ae(i,n.getAssetsObject());ce(i,o,a),n.requestImageCache(r).then(function(e){i.setProperty(a.id,"width",e.width),i.setProperty(a.id,"height",e.height)})})},n.addImageAssetFromURL=function(e){var t=e.substring(e.lastIndexOf("/")+1),r=t.substring(t.lastIndexOf(".")+1),i="image/unknown";"png"===r.toLowerCase()&&(i="image/png"),"jpg"===r.toLowerCase()&&(i="image/jpeg"),"jpeg"===r.toLowerCase()&&(i="image/jpeg");var a=n.getDataGraph(),o=ae(a,a.createObject({type:"asset",subtype:"image",format:i,src:e,width:100,height:100,title:t,parent:0})),s=ae(a,n.getAssetsObject());ce(a,s,o),n.requestImageCache(e).then(function(e){a.setProperty(o.id,"width",e.width),a.setProperty(o.id,"height",e.height)})},n.deleteSelection=function(){var e=n.getDataGraph(),t=n.getSelectedShape();t&&(ue(e,t),R.clearSelection())},n.deleteSelectedAsset=function(){var e=n.getDataGraph();ue(e,ae(e,R.getSelection())),R.clearSelection()},n.cutSelection=function(){var e=n.getDataGraph(),t=R.getSelection();if(t){var r=ae(e,t);R.setClipboard(r.id),ue(e,r),R.clearSelection()}},n.copySelection=function(){var e=n.getDataGraph(),t=R.getSelection();if(t){var r=ae(e,t);R.setClipboard(r.id)}},n.pasteSelection=function(e){if(e.target&&"input"===e.target.getAttribute("type"))return console.log("pasting into an input field. don't intercept");var t=n.getDataGraph(),r=ae(t,R.getClipboard()),i=null;if(et(r.type)&&(i=n.getSelectedLayer()),"layer"===r.type&&(i=n.getSelectedPage()),"page"===r.type&&(i=ae(t,n.getSceneRoot())),!i)return console.error("no parent to ad too! bad obj type?",r.type);var a=function(e,t){var n=t.id,r=e.createObject();return e.getPropertiesForObject(n).forEach(function(t){e.createProperty(r,t,e.getPropertyValue(n,t))}),ae(e,r)}(t,r);t.setProperty(a.id,"parent",i.id),se(t,i,a)},n.exportSVG=function(){var e=n.getSelectedPage(),t=n.renderSVGWrapper(n.renderSVGChildren(e)),r=document.createElement("a");r.href="data:image/svg+xml,"+encodeURIComponent(t),r.download="test.svg",document.body.appendChild(r),r.click()},n.exportPNG=function(){var e=n.getSelectedPage(),t=document.createElement("canvas"),r=t.getContext("2d"),i=n.getRawGraph(),a=n.getPageSize(e).as(de.PIXEL,1,fe);t.width=a.width,t.height=a.height,r.fillStyle="white",r.fillRect(0,0,t.width,t.height),e&&n.accessObject(e.id).getChildren().forEach(function(e){e.getChildren().forEach(function(e){var t=n.getShapeDef(e.type);t&&t.draw(r,i,e,!1,Object(f.a)(Object(f.a)(n)))})});var o=document.createElement("a");o.href=t.toDataURL("image/png"),o.download="test.png",document.body.appendChild(o),o.click()},n.newView=function(){return window.open("./?mode=metadoc&doctype=".concat(n.getDocType(),"&doc=").concat(n.getDocId()))},n.openPresentationView=function(){return window.open("./?mode=view&doctype=".concat(n.getDocType(),"&doc=").concat(n.getDocId()))},n.getAssetsObject=function(){return n.getDataGraph().getObjectByProperty("type","assets")},n.showAddImageAssetDialog=function(){return p.b.show(i.a.createElement(kn,{provider:Object(f.a)(Object(f.a)(n))}))},n.accessObject=function(e){return new Cn(n.getDataGraph()).object(e)},n.imagecache={},n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"getDocType",value:function(){return"metadoc"}},{key:"makeEmptyRoot",value:function(e){var t=ae(e,e.createObject({type:"root",title:"root",pageSize:"640 x 480 px",children:e.createArray(),parent:0})),n=ae(e,e.createObject({type:"page",title:"page 1",children:e.createArray(),parent:0})),r=ae(e,e.createObject({type:"layer",title:"layer 1",children:e.createArray(),parent:0})),i=Xe.rect.make(e,r),a=ae(e,e.createObject({type:"assets",title:"Assets",children:e.createArray(),parent:0}));se(e,r,i),se(e,n,r),se(e,t,n),ce(e,t,a)}},{key:"setPropertyValue",value:function(e,n,r){if(Object(d.a)(Object(l.a)(t.prototype),"setPropertyValue",this).call(this,e,n,r),n.key===Ye.asset.key){var i=ae(this.getDataGraph(),r);Object(d.a)(Object(l.a)(t.prototype),"setPropertyValue",this).call(this,e,{key:"width"},i.width),Object(d.a)(Object(l.a)(t.prototype),"setPropertyValue",this).call(this,e,{key:"height"},i.height)}}},{key:"getProperties",value:function(e){var t=this;var n=[];if(!e)return n;var r=this.syncdoc.getPropertiesForObject(e);return r&&r.forEach(function(r){if("type"!==r&&"children"!==r&&"parent"!==r){var i=t.syncdoc.getPropertyValue(e,r);if(Ye[r])return n.push(function(e,t){var n={};return Object.keys(e).forEach(function(t){return n[t]=e[t]}),n.value=t,n}(Ye[r],i));console.log("unknown property",r)}}),n}},{key:"createCustomEditor",value:function(e,t,n,r,a){if(t.key===Ye.fillColor.key)return i.a.createElement(p.c,null,["#ffffff","#ff0000","#ffff00","#00ff00","#00ffff","#0000ff","#ff00ff","#000000"].map(function(e){return i.a.createElement("button",{key:e,onClick:function(){return a(e)},style:{color:e,padding:"1px",margin:0,borderWidth:0},className:"fa fa-square"})}));if(t.key===Ye.pageSize.key){var o=ae(this.getDataGraph(),e);return i.a.createElement(Q,{def:t,provider:this,obj:e,value:o.pageSize,onChange:a})}return i.a.createElement("i",null,"no custom editor for ",t.key)}},{key:"getValuesForEnum",value:function(e,t){if(e===Ye.asset.key){var n=this.getDataGraph().getPropertyValue(this.getAssetsObject(),"children");return oe(this.getDataGraph(),n)}return e===Ye.fontFamily.key?Object.keys(Je).map(function(e){return Je[e]}):e===Ye.verticalAlign.key?Object.keys(Qe).map(function(e){return Qe[e]}):e===Ye.horizontalAlign.key?Object.keys(qe).map(function(e){return qe[e]}):e===Ye.pageSize.key?En.map(function(e){return e.value}):void 0}},{key:"getRendererForEnum",value:function(e,t){return e===Ye.asset.key?Mn:e===Ye.pageSize.key?jn:void 0}},{key:"getPageSize",value:function(e){var t=this.getSceneRoot(),n=ae(this.getDataGraph(),t);return console.log("parsing",n),function(e){e.value&&(e=e.value);var t=e.trim().match(/(\d+)\s*x\s*(\d+)\s*(px|mm)/);return"px"===t[3]?new ve(parseInt(t[1]),parseInt(t[2]),de.PIXEL):"mm"===t[3]?new ve(parseInt(t[1]),parseInt(t[2]),de.MILLIMETER):new ve(100,100,de.PIXEL)}(n.pageSize)}},{key:"getShapeDef",value:function(e){return Xe[e]}},{key:"getSelectedRoot",value:function(){return ae(this.getDataGraph(),this.getSceneRoot())}},{key:"getSelectedPage",value:function(){var e=R.getSelection();if(!e)return null;for(;;){var t=this.getDataGraph().getPropertyValue(e,"type");if("root"===t)return null;if("page"===t)return ae(this.getDataGraph(),e);if(!(e=this.getDataGraph().getPropertyValue(e,"parent")))break}}},{key:"getSelectedLayer",value:function(){var e=R.getSelection();if(!e)return null;for(;;){var t=this.getDataGraph().getPropertyValue(e,"type");if("root"===t)return null;if("layer"===t)return ae(this.getDataGraph(),e);if(!(e=this.getDataGraph().getPropertyValue(e,"parent")))break}console.log(ae(this.getDataGraph(),e))}},{key:"getSelectedShape",value:function(){var e=R.getSelection();if(!e)return null;var t=this.getDataGraph().getPropertyValue(e,"type");return Xe[t]?ae(this.getDataGraph(),e):null}},{key:"calculateContextMenu",value:function(e){var t=ae(this.getDataGraph(),e);return"assets"===t.type?[{title:"Add Image",icon:"image",fun:this.showAddImageAssetDialog}]:"asset"===t.type?[{title:"delete",icon:"close",fun:this.deleteSelectedAsset}]:[{title:"delete",icon:"close",fun:this.deleteSelection},{title:"rect",icon:Ze.rect,fun:this.addRect},{title:"circle",icon:Ze.circle,fun:this.addCircle},{title:"text",icon:Ze.text,fun:this.addText},{title:"image",icon:Ze.image,fun:this.addImage},{title:"cut",icon:Ze.cut,fun:this.cutSelection},{title:"copy",icon:Ze.copy,fun:this.copySelection},{title:"paste",icon:Ze.paste,fun:this.pasteSelection}]}},{key:"renderSVGWrapper",value:function(e){return'<svg id="svg-canvas" viewBox="0 0 1000 1000" \n                xmlns="http://www.w3.org/2000/svg" \n                xmlnsXlink="http://www.w3.org/1999/xlink">\n                '.concat(e,"</svg>")}},{key:"renderSVGChildren",value:function(e){var t=this;return"page"===e.type?oe(this.getDataGraph(),e.children).map(function(e){return"<g>".concat(t.renderSVGChildren(ae(t.getDataGraph(),e)),"</g>")}).join(""):"layer"===e.type?oe(this.getDataGraph(),e.children).map(function(e){return t.renderSVGChildren(ae(t.getDataGraph(),e))}).join(""):Xe[e.type]?Xe[e.type].toSVGString(e,this):""}},{key:"canAddChild",value:function(e,t){var n=ae(this.getDataGraph(),e),r=ae(this.getDataGraph(),t);return!("layer"!==n.type||!et(r.type))||("page"===n.type&&"layer"===r.type||"root"===n.type&&"page"===r.type)}},{key:"canBeSibling",value:function(e,t){var n=ae(this.getDataGraph(),e),r=ae(this.getDataGraph(),t);return"layer"===n.type&&"layer"===r.type||("page"===n.type&&"page"===r.type||!(!et(n.type)||!et(r.type)))}},{key:"canAddExternalChild",value:function(e,t){return"assets"===ae(this.getDataGraph(),e).type}},{key:"acceptDrop",value:function(e,t){var n=this;"assets"===ae(this.getDataGraph(),t).type&&re(e.dataTransfer.files).forEach(function(e){return n.addImageAssetFromFile(e)})}},{key:"isImageCached",value:function(e){return!!this.imagecache[e]&&this.imagecache[e].complete}},{key:"requestImageCache",value:function(e){var t=this,n=new Image;return this.imagecache[e]=n,new Promise(function(r,i){n.src=e,n.onload=function(){t.fire(B.STRUCTURE_CHANGED,{provider:t}),r(n)}})}},{key:"getCachedImage",value:function(e){return this.imagecache[e]}}]),t}(Ue),Rn=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this,e))).canvasSelected=function(e){return R.setSelection(e)},n.showAddPopup=function(e){var t=[{title:"page",icon:Ze.page,fun:function(){return n.addPage()}},{title:"layer",icon:Ze.layer,fun:function(){return n.addLayer()}},{title:"rect",icon:Ze.rect,fun:function(){return n.props.provider.addRect()}},{title:"circle",icon:Ze.circle,fun:function(){return n.props.provider.addCircle()}},{title:"text",icon:Ze.text,fun:function(){return n.props.provider.addText()}},{title:"image",icon:Ze.image,fun:function(){return n.props.provider.addImage()}}];p.e.show(i.a.createElement(M,{actions:t}),e.target)},n.addPage=function(){var e=n.props.provider.getDataGraph(),t=n.props.provider.getSelectedRoot(),r=ae(e,ie(e,{type:"page",title:"new page",parent:t.id,children:e.createArray()}));se(e,t,r)},n.addLayer=function(){var e=n.props.provider.getDataGraph(),t=n.props.provider.getSelectedPage(),r=ae(e,ie(e,{type:"layer",title:"new layer",parent:t.id,children:e.createArray()}));se(e,t,r)},n.zoomIn=function(){return n.setState({zoom:n.state.zoom+1})},n.zoomOut=function(){return n.setState({zoom:n.state.zoom-1})},n.state={connected:!1,zoom:0,mode:"canvas"},n.im=new ze,n.im.addKeyBinding({id:"save",key:ze.KEYS.S,modifiers:[ze.MODIFIERS.COMMAND]}),n.im.addKeyBinding({id:"undo",key:ze.KEYS.Z,modifiers:[ze.MODIFIERS.COMMAND]}),n.im.addKeyBinding({id:"redo",key:ze.KEYS.Z,modifiers:[ze.MODIFIERS.COMMAND,ze.MODIFIERS.SHIFT]}),n.im.addListener("save",n.props.provider.save),n.im.addListener("undo",n.props.provider.performUndo),n.im.addListener("redo",n.props.provider.performRedo),n.im.addKeyBinding({id:"cut",key:ze.KEYS.X,modifiers:[ze.MODIFIERS.COMMAND]}),n.im.addKeyBinding({id:"copy",key:ze.KEYS.C,modifiers:[ze.MODIFIERS.COMMAND]}),n.im.addKeyBinding({id:"paste",key:ze.KEYS.V,modifiers:[ze.MODIFIERS.COMMAND]}),n.im.addListener("cut",n.props.provider.cutSelection),n.im.addListener("copy",n.props.provider.copySelection),n.im.addListener("paste",n.props.provider.pasteSelection),n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){var e=this;this.im.attachKeyEvents(document),this.props.provider.on("CONNECTED",function(){return e.setState({connected:e.props.provider.isConnected()})}),R.on(j,function(){var t=R.getSelection();if(t&&ae(e.props.provider.getDataGraph(),t).type===Ye.asset.key)return void e.setState({mode:"asset"});e.setState({mode:"canvas"})})}},{key:"render",value:function(){var e=this.props.provider;return i.a.createElement(E,null,i.a.createElement(S,{left:!0,top:!0},i.a.createElement("label",null,e.getTitle())),i.a.createElement(A,{scroll:!0,left:!0,middle:!0},i.a.createElement(pe,{root:e.getSceneRoot(),provider:e})),i.a.createElement(S,{left:!0,bottom:!0},i.a.createElement("button",{className:"fa fa-plus",onClick:this.showAddPopup}),i.a.createElement("button",{className:"fa fa-close",onClick:e.deleteSelection}),i.a.createElement("button",{className:"fa fa-file-image-o",onClick:e.showAddImageAssetDialog})),i.a.createElement(S,{center:!0,top:!0},i.a.createElement("button",{className:"fa fa-save",onClick:e.save}),i.a.createElement("button",{className:"fa fa-download",onClick:e.exportSVG}," SVG"),i.a.createElement("button",{className:"fa fa-download",onClick:e.exportPNG}," PNG"),i.a.createElement("button",{className:"fa fa-undo",onClick:e.performUndo}),i.a.createElement("button",{className:"fa fa-repeat",onClick:e.performRedo}),i.a.createElement("button",{className:"fa fa-search-plus",onClick:this.zoomIn}),i.a.createElement("button",{className:"fa fa-search-minus",onClick:this.zoomOut}),i.a.createElement(x,null),i.a.createElement("button",{className:"fa fa-cut",onClick:e.cutSelection}),i.a.createElement("button",{className:"fa fa-copy",onClick:e.copySelection}),i.a.createElement("button",{className:"fa fa-paste",onClick:e.pasteSelection}),i.a.createElement(x,null),i.a.createElement("button",{className:"fa fa-play",onClick:e.openPresentationView}),i.a.createElement("button",{className:"fa fa-plus",onClick:e.newView}," view"),i.a.createElement("button",{className:"fa fa-superpowers",onClick:e.toggleConnected},this.state.connected?"disconnect":"connect")),i.a.createElement(A,{center:!0,middle:!0,scroll:!0},this.renderCenterPane(this.state.mode)),i.a.createElement(A,{scroll:!0,right:!0},i.a.createElement(ee,{provider:e})),i.a.createElement(S,{right:!0,top:!0}),i.a.createElement(S,{right:!0,bottom:!0}))}},{key:"renderCenterPane",value:function(e){if("canvas"===e)return i.a.createElement(me,{prov:this.props.provider,onSelect:this.canvasSelected,scale:Math.pow(2,this.state.zoom)});var t=R.getSelection();return i.a.createElement(yn,{provider:this.props.provider,asset:t})}}]),t}(r.Component),Pn=n(1),Ln=function(e,t){Pn.Object3D.call(this),t=void 0!==t?t:document,this.visible=!1;var n=new Tn;this.add(n);var r=new In;this.add(r);var i=this;N("camera",e),N("object",void 0),N("enabled",!0),N("axis",null),N("mode","translate"),N("translationSnap",null),N("rotationSnap",null),N("space","world"),N("size",1),N("dragging",!1),N("showX",!0),N("showY",!0),N("showZ",!0);var a={type:"change"},o={type:"mouseDown"},s={type:"mouseUp",mode:i.mode},c={type:"objectChange"},u=new Pn.Raycaster,l=new Pn.Vector3,h=new Pn.Vector3,p=new Pn.Quaternion,d={X:new Pn.Vector3(1,0,0),Y:new Pn.Vector3(0,1,0),Z:new Pn.Vector3(0,0,1)},f=new Pn.Quaternion,v=new Pn.Vector3,m=new Pn.Vector3,y=new Pn.Vector3,g=new Pn.Vector3,b=0,w=new Pn.Vector3,O=new Pn.Quaternion,k=new Pn.Vector3,S=new Pn.Vector3,A=new Pn.Quaternion,x=new Pn.Vector3,C=new Pn.Vector3,M=new Pn.Quaternion,E=new Pn.Vector3,j=new Pn.Vector3,D=new Pn.Quaternion,R=new Pn.Vector3,P=new Pn.Vector3,L=new Pn.Vector3,T=new Pn.Quaternion,I=new Pn.Vector3;function N(e,t){var o=t;Object.defineProperty(i,e,{get:function(){return void 0!==o?o:t},set:function(t){o!==t&&(o=t,r[e]=t,n[e]=t,i.dispatchEvent({type:e+"-changed",value:t}),i.dispatchEvent(a))}}),i[e]=t,r[e]=t,n[e]=t}function G(e){var n=e.changedTouches?e.changedTouches[0]:e,r=t.getBoundingClientRect();return{x:(n.clientX-r.left)/r.width*2-1,y:-(n.clientY-r.top)/r.height*2+1,button:e.button}}function B(e){e.preventDefault()}function F(e){i.enabled&&i.pointerHover(G(e))}function U(e){i.enabled&&(e.preventDefault(),document.addEventListener("mousemove",z,!1),i.pointerHover(G(e)),i.pointerDown(G(e)))}function z(e){i.enabled&&(e.preventDefault(),i.pointerMove(G(e)))}function H(e){i.enabled&&(e.preventDefault(),document.removeEventListener("mousemove",z,!1),i.pointerUp(G(e)))}N("parentQuaternion",A),N("worldPosition",j),N("worldPositionStart",C),N("worldQuaternion",D),N("worldQuaternionStart",M),N("cameraPosition",w),N("cameraQuaternion",O),N("pointStart",m),N("pointEnd",y),N("rotationAxis",g),N("rotationAngle",b),N("eye",P),t.addEventListener("mousedown",U,!1),t.addEventListener("touchstart",U,!1),t.addEventListener("mousemove",F,!1),t.addEventListener("touchmove",F,!1),t.addEventListener("touchmove",z,!1),document.addEventListener("mouseup",H,!1),t.addEventListener("touchend",H,!1),t.addEventListener("touchcancel",H,!1),t.addEventListener("touchleave",H,!1),t.addEventListener("contextmenu",B,!1),this.dispose=function(){t.removeEventListener("mousedown",U),t.removeEventListener("touchstart",U),t.removeEventListener("mousemove",F),t.removeEventListener("touchmove",F),t.removeEventListener("touchmove",z),document.removeEventListener("mouseup",H),t.removeEventListener("touchend",H),t.removeEventListener("touchcancel",H),t.removeEventListener("touchleave",H),t.removeEventListener("contextmenu",B)},this.attach=function(e){this.object=e,this.visible=!0},this.detach=function(){this.object=void 0,this.visible=!1,this.axis=null},this.updateMatrixWorld=function(){void 0!==this.object&&(this.object.updateMatrixWorld(),this.object.parent.matrixWorld.decompose(S,A,x),this.object.matrixWorld.decompose(j,D,R)),this.camera.updateMatrixWorld(),this.camera.matrixWorld.decompose(w,O,k),this.camera instanceof Pn.PerspectiveCamera?P.copy(w).sub(j).normalize():this.camera instanceof Pn.OrthographicCamera&&P.copy(w).normalize(),Pn.Object3D.prototype.updateMatrixWorld.call(this)},this.pointerHover=function(e){if(void 0!==this.object&&!0!==this.dragging&&(void 0===e.button||0===e.button)){u.setFromCamera(e,this.camera);var t=u.intersectObjects(n.picker[this.mode].children,!0)[0]||!1;this.axis=t?t.object.name:null}},this.pointerDown=function(e){if(void 0!==this.object&&!0!==this.dragging&&(void 0===e.button||0===e.button)&&(0===e.button||void 0===e.button)&&null!==this.axis){u.setFromCamera(e,this.camera);var t=u.intersectObjects([r],!0)[0]||!1;if(t){var n=this.space;if("scale"===this.mode?n="local":"E"!==this.axis&&"XYZE"!==this.axis&&"XYZ"!==this.axis||(n="world"),"local"===n&&"rotate"===this.mode){var i=this.rotationSnap;"X"===this.axis&&i&&(this.object.rotation.x=Math.round(this.object.rotation.x/i)*i),"Y"===this.axis&&i&&(this.object.rotation.y=Math.round(this.object.rotation.y/i)*i),"Z"===this.axis&&i&&(this.object.rotation.z=Math.round(this.object.rotation.z/i)*i)}this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),L.copy(this.object.position),T.copy(this.object.quaternion),I.copy(this.object.scale),this.object.matrixWorld.decompose(C,M,E),m.copy(t.point).sub(C),"local"===n&&m.applyQuaternion(M.clone().inverse())}this.dragging=!0,o.mode=this.mode,this.dispatchEvent(o)}},this.pointerMove=function(e){var t=this.axis,n=this.mode,i=this.object,o=this.space;if("scale"===n?o="local":"E"!==t&&"XYZE"!==t&&"XYZ"!==t||(o="world"),void 0!==i&&null!==t&&!1!==this.dragging&&(void 0===e.button||0===e.button)){u.setFromCamera(e,this.camera);var s=u.intersectObjects([r],!0)[0]||!1;if(!1!==s){if(y.copy(s.point).sub(C),"local"===o&&y.applyQuaternion(M.clone().inverse()),"translate"===n)-1===t.search("X")&&(y.x=m.x),-1===t.search("Y")&&(y.y=m.y),-1===t.search("Z")&&(y.z=m.z),"local"===o?i.position.copy(y).sub(m).applyQuaternion(T):i.position.copy(y).sub(m),i.position.add(L),this.translationSnap&&("local"===o&&(i.position.applyQuaternion(p.copy(T).inverse()),-1!==t.search("X")&&(i.position.x=Math.round(i.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(i.position.y=Math.round(i.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(i.position.z=Math.round(i.position.z/this.translationSnap)*this.translationSnap),i.position.applyQuaternion(T)),"world"===o&&(i.parent&&i.position.add(l.setFromMatrixPosition(i.parent.matrixWorld)),-1!==t.search("X")&&(i.position.x=Math.round(i.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(i.position.y=Math.round(i.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(i.position.z=Math.round(i.position.z/this.translationSnap)*this.translationSnap),i.parent&&i.position.sub(l.setFromMatrixPosition(i.parent.matrixWorld))));else if("scale"===n){if(-1!==t.search("XYZ")){var w=y.length()/m.length();y.dot(m)<0&&(w*=-1),l.set(w,w,w)}else l.copy(y).divide(m),-1===t.search("X")&&(l.x=1),-1===t.search("Y")&&(l.y=1),-1===t.search("Z")&&(l.z=1);i.scale.copy(I).multiply(l)}else if("rotate"===n){var O=20/j.distanceTo(l.setFromMatrixPosition(this.camera.matrixWorld)),k="local"===this.space?D:f,S=d[t];"E"===t?(l.copy(y).cross(m),g.copy(P),b=y.angleTo(m)*(l.dot(P)<0?1:-1)):"XYZE"===t?(l.copy(y).sub(m).cross(P).normalize(),g.copy(l),b=y.sub(m).dot(l.cross(P))*O):"X"!==t&&"Y"!==t&&"Z"!==t||(v.copy(S).applyQuaternion(k),g.copy(S),l=S.clone(),h=y.clone().sub(m),"local"===o&&(l.applyQuaternion(k),h.applyQuaternion(M)),b=h.dot(l.cross(P).normalize())*O),this.rotationSnap&&(b=Math.round(b/this.rotationSnap)*this.rotationSnap),this.rotationAngle=b,"local"===o?(i.quaternion.copy(T),i.quaternion.multiply(p.setFromAxisAngle(g,b))):(i.quaternion.copy(p.setFromAxisAngle(g,b)),i.quaternion.multiply(T))}this.dispatchEvent(a),this.dispatchEvent(c)}}},this.pointerUp=function(e){void 0!==e.button&&0!==e.button||(this.dragging&&null!==this.axis&&(s.mode=this.mode,this.dispatchEvent(s)),this.dragging=!1,void 0===e.button&&(this.axis=null))},this.getMode=function(){return i.mode},this.setMode=function(e){i.mode=e},this.setTranslationSnap=function(e){i.translationSnap=e},this.setRotationSnap=function(e){i.rotationSnap=e},this.setSize=function(e){i.size=e},this.setSpace=function(e){i.space=e},this.update=function(){console.warn("TransformControls: update function has been depricated.")}};Ln.prototype=Object.assign(Object.create(Pn.Object3D.prototype),{constructor:Ln,isTransformControls:!0});var Tn=function(){Pn.Object3D.call(this),this.type="TransformControlsGizmo";var e=new Pn.MeshBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,side:Pn.DoubleSide,fog:!1}),t=new Pn.LineBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,linewidth:1,fog:!1}),n=e.clone();n.opacity=.15;var r=e.clone();r.opacity=.33;var i=e.clone();i.color.set(16711680);var a=e.clone();a.color.set(65280);var o=e.clone();o.color.set(255);var s=e.clone();s.opacity=.25;var c=s.clone();c.color.set(16776960);var u=s.clone();u.color.set(65535);var l=s.clone();l.color.set(16711935),e.clone().color.set(16776960);var h=t.clone();h.color.set(16711680);var p=t.clone();p.color.set(65280);var d=t.clone();d.color.set(255);var f=t.clone();f.color.set(65535);var v=t.clone();v.color.set(16711935);var m=t.clone();m.color.set(16776960);var y=t.clone();y.color.set(7895160);var g=m.clone();g.opacity=.25;var b=new Pn.CylinderBufferGeometry(0,.05,.2,12,1,!1),w=new Pn.BoxBufferGeometry(.125,.125,.125),O=new Pn.BufferGeometry;O.addAttribute("position",new Pn.Float32BufferAttribute([0,0,0,1,0,0],3));var k,S=function(e,t){for(var n=new Pn.BufferGeometry,r=[],i=0;i<=64*t;++i)r.push(0,Math.cos(i/32*Math.PI)*e,Math.sin(i/32*Math.PI)*e);return n.addAttribute("position",new Pn.Float32BufferAttribute(r,3)),n},A={X:[[new Pn.Mesh(b,i),[1,0,0],[0,0,-Math.PI/2],null,"fwd"],[new Pn.Mesh(b,i),[1,0,0],[0,0,Math.PI/2],null,"bwd"],[new Pn.Line(O,h)]],Y:[[new Pn.Mesh(b,a),[0,1,0],null,null,"fwd"],[new Pn.Mesh(b,a),[0,1,0],[Math.PI,0,0],null,"bwd"],[new Pn.Line(O,p),null,[0,0,Math.PI/2]]],Z:[[new Pn.Mesh(b,o),[0,0,1],[Math.PI/2,0,0],null,"fwd"],[new Pn.Mesh(b,o),[0,0,1],[-Math.PI/2,0,0],null,"bwd"],[new Pn.Line(O,d),null,[0,-Math.PI/2,0]]],XYZ:[[new Pn.Mesh(new Pn.OctahedronBufferGeometry(.1,0),s),[0,0,0],[0,0,0]]],XY:[[new Pn.Mesh(new Pn.PlaneBufferGeometry(.295,.295),c),[.15,.15,0]],[new Pn.Line(O,m),[.18,.3,0],null,[.125,1,1]],[new Pn.Line(O,m),[.3,.18,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new Pn.Mesh(new Pn.PlaneBufferGeometry(.295,.295),u),[0,.15,.15],[0,Math.PI/2,0]],[new Pn.Line(O,f),[0,.18,.3],[0,0,Math.PI/2],[.125,1,1]],[new Pn.Line(O,f),[0,.3,.18],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new Pn.Mesh(new Pn.PlaneBufferGeometry(.295,.295),l),[.15,0,.15],[-Math.PI/2,0,0]],[new Pn.Line(O,v),[.18,0,.3],null,[.125,1,1]],[new Pn.Line(O,v),[.3,0,.18],[0,-Math.PI/2,0],[.125,1,1]]]},x={X:[[new Pn.Mesh(new Pn.CylinderBufferGeometry(.2,0,1,4,1,!1),n),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new Pn.Mesh(new Pn.CylinderBufferGeometry(.2,0,1,4,1,!1),n),[0,.6,0]]],Z:[[new Pn.Mesh(new Pn.CylinderBufferGeometry(.2,0,1,4,1,!1),n),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new Pn.Mesh(new Pn.OctahedronBufferGeometry(.2,0),n)]],XY:[[new Pn.Mesh(new Pn.PlaneBufferGeometry(.4,.4),n),[.2,.2,0]]],YZ:[[new Pn.Mesh(new Pn.PlaneBufferGeometry(.4,.4),n),[0,.2,.2],[0,Math.PI/2,0]]],XZ:[[new Pn.Mesh(new Pn.PlaneBufferGeometry(.4,.4),n),[.2,0,.2],[-Math.PI/2,0,0]]]},C={START:[[new Pn.Mesh(new Pn.OctahedronBufferGeometry(.01,2),r),null,null,null,"helper"]],END:[[new Pn.Mesh(new Pn.OctahedronBufferGeometry(.01,2),r),null,null,null,"helper"]],DELTA:[[new Pn.Line((k=new Pn.BufferGeometry,k.addAttribute("position",new Pn.Float32BufferAttribute([0,0,0,1,1,1],3)),k),r),null,null,null,"helper"]],X:[[new Pn.Line(O,r.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new Pn.Line(O,r.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new Pn.Line(O,r.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},M={X:[[new Pn.Line(S(1,.5),h)],[new Pn.Mesh(new Pn.OctahedronBufferGeometry(.04,0),i),[0,0,.99],null,[1,3,1]]],Y:[[new Pn.Line(S(1,.5),p),null,[0,0,-Math.PI/2]],[new Pn.Mesh(new Pn.OctahedronBufferGeometry(.04,0),a),[0,0,.99],null,[3,1,1]]],Z:[[new Pn.Line(S(1,.5),d),null,[0,Math.PI/2,0]],[new Pn.Mesh(new Pn.OctahedronBufferGeometry(.04,0),o),[.99,0,0],null,[1,3,1]]],E:[[new Pn.Line(S(1.25,1),g),null,[0,Math.PI/2,0]],[new Pn.Mesh(new Pn.CylinderBufferGeometry(.03,0,.15,4,1,!1),g),[1.17,0,0],[0,0,-Math.PI/2],[1,1,.001]],[new Pn.Mesh(new Pn.CylinderBufferGeometry(.03,0,.15,4,1,!1),g),[-1.17,0,0],[0,0,Math.PI/2],[1,1,.001]],[new Pn.Mesh(new Pn.CylinderBufferGeometry(.03,0,.15,4,1,!1),g),[0,-1.17,0],[Math.PI,0,0],[1,1,.001]],[new Pn.Mesh(new Pn.CylinderBufferGeometry(.03,0,.15,4,1,!1),g),[0,1.17,0],[0,0,0],[1,1,.001]]],XYZE:[[new Pn.Line(S(1,1),y),null,[0,Math.PI/2,0]]]},E={AXIS:[[new Pn.Line(O,r.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},j={X:[[new Pn.Mesh(new Pn.TorusBufferGeometry(1,.1,4,24),n),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new Pn.Mesh(new Pn.TorusBufferGeometry(1,.1,4,24),n),[0,0,0],[Math.PI/2,0,0]]],Z:[[new Pn.Mesh(new Pn.TorusBufferGeometry(1,.1,4,24),n),[0,0,0],[0,0,-Math.PI/2]]],E:[[new Pn.Mesh(new Pn.TorusBufferGeometry(1.25,.1,2,24),n)]],XYZE:[[new Pn.Mesh(new Pn.SphereBufferGeometry(.7,10,8),n)]]},D={X:[[new Pn.Mesh(w,i),[.8,0,0],[0,0,-Math.PI/2]],[new Pn.Line(O,h),null,null,[.8,1,1]]],Y:[[new Pn.Mesh(w,a),[0,.8,0]],[new Pn.Line(O,p),null,[0,0,Math.PI/2],[.8,1,1]]],Z:[[new Pn.Mesh(w,o),[0,0,.8],[Math.PI/2,0,0]],[new Pn.Line(O,d),null,[0,-Math.PI/2,0],[.8,1,1]]],XY:[[new Pn.Mesh(w,c),[.85,.85,0],null,[2,2,.2]],[new Pn.Line(O,m),[.855,.98,0],null,[.125,1,1]],[new Pn.Line(O,m),[.98,.855,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new Pn.Mesh(w,u),[0,.85,.85],null,[.2,2,2]],[new Pn.Line(O,f),[0,.855,.98],[0,0,Math.PI/2],[.125,1,1]],[new Pn.Line(O,f),[0,.98,.855],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new Pn.Mesh(w,l),[.85,0,.85],null,[2,.2,2]],[new Pn.Line(O,v),[.855,0,.98],null,[.125,1,1]],[new Pn.Line(O,v),[.98,0,.855],[0,-Math.PI/2,0],[.125,1,1]]],XYZX:[[new Pn.Mesh(new Pn.BoxBufferGeometry(.125,.125,.125),s),[1.1,0,0]]],XYZY:[[new Pn.Mesh(new Pn.BoxBufferGeometry(.125,.125,.125),s),[0,1.1,0]]],XYZZ:[[new Pn.Mesh(new Pn.BoxBufferGeometry(.125,.125,.125),s),[0,0,1.1]]]},R={X:[[new Pn.Mesh(new Pn.CylinderBufferGeometry(.2,0,.8,4,1,!1),n),[.5,0,0],[0,0,-Math.PI/2]]],Y:[[new Pn.Mesh(new Pn.CylinderBufferGeometry(.2,0,.8,4,1,!1),n),[0,.5,0]]],Z:[[new Pn.Mesh(new Pn.CylinderBufferGeometry(.2,0,.8,4,1,!1),n),[0,0,.5],[Math.PI/2,0,0]]],XY:[[new Pn.Mesh(w,n),[.85,.85,0],null,[3,3,.2]]],YZ:[[new Pn.Mesh(w,n),[0,.85,.85],null,[.2,3,3]]],XZ:[[new Pn.Mesh(w,n),[.85,0,.85],null,[3,.2,3]]],XYZX:[[new Pn.Mesh(new Pn.BoxBufferGeometry(.2,.2,.2),n),[1.1,0,0]]],XYZY:[[new Pn.Mesh(new Pn.BoxBufferGeometry(.2,.2,.2),n),[0,1.1,0]]],XYZZ:[[new Pn.Mesh(new Pn.BoxBufferGeometry(.2,.2,.2),n),[0,0,1.1]]]},P={X:[[new Pn.Line(O,r.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new Pn.Line(O,r.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new Pn.Line(O,r.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},L=function(e){var t=new Pn.Object3D;for(var n in e)for(var r=e[n].length;r--;){var i=e[n][r][0].clone(),a=e[n][r][1],o=e[n][r][2],s=e[n][r][3],c=e[n][r][4];i.name=n,i.tag=c,a&&i.position.set(a[0],a[1],a[2]),o&&i.rotation.set(o[0],o[1],o[2]),s&&i.scale.set(s[0],s[1],s[2]),i.updateMatrix();var u=i.geometry.clone();u.applyMatrix(i.matrix),i.geometry=u,i.position.set(0,0,0),i.rotation.set(0,0,0),i.scale.set(1,1,1),t.add(i)}return t},T=new Pn.Vector3(0,0,0),I=new Pn.Euler,N=new Pn.Vector3(0,1,0),G=new Pn.Vector3(0,0,0),B=new Pn.Matrix4,F=new Pn.Quaternion,U=new Pn.Quaternion,z=new Pn.Quaternion,H=new Pn.Vector3(1,0,0),V=new Pn.Vector3(0,1,0),W=new Pn.Vector3(0,0,1);this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=L(A)),this.add(this.gizmo.rotate=L(M)),this.add(this.gizmo.scale=L(D)),this.add(this.picker.translate=L(x)),this.add(this.picker.rotate=L(j)),this.add(this.picker.scale=L(R)),this.add(this.helper.translate=L(C)),this.add(this.helper.rotate=L(E)),this.add(this.helper.scale=L(P)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1,this.updateMatrixWorld=function(){var e=this.space;"scale"===this.mode&&(e="local");var t="local"===e?this.worldQuaternion:z;this.gizmo.translate.visible="translate"===this.mode,this.gizmo.rotate.visible="rotate"===this.mode,this.gizmo.scale.visible="scale"===this.mode,this.helper.translate.visible="translate"===this.mode,this.helper.rotate.visible="rotate"===this.mode,this.helper.scale.visible="scale"===this.mode;var n=[];n=(n=(n=n.concat(this.picker[this.mode].children)).concat(this.gizmo[this.mode].children)).concat(this.helper[this.mode].children);for(var r=0;r<n.length;r++){var i=n[r];i.visible=!0,i.rotation.set(0,0,0),i.position.copy(this.worldPosition);var a=this.worldPosition.distanceTo(this.cameraPosition);if(i.scale.set(1,1,1).multiplyScalar(a*this.size/7),"helper"!==i.tag){if(i.quaternion.copy(t),"translate"===this.mode||"scale"===this.mode){"X"!==i.name&&"XYZX"!==i.name||Math.abs(N.copy(H).applyQuaternion(t).dot(this.eye))>.99&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),"Y"!==i.name&&"XYZY"!==i.name||Math.abs(N.copy(V).applyQuaternion(t).dot(this.eye))>.99&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),"Z"!==i.name&&"XYZZ"!==i.name||Math.abs(N.copy(W).applyQuaternion(t).dot(this.eye))>.99&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),"XY"===i.name&&Math.abs(N.copy(W).applyQuaternion(t).dot(this.eye))<.2&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),"YZ"===i.name&&Math.abs(N.copy(H).applyQuaternion(t).dot(this.eye))<.2&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),"XZ"===i.name&&Math.abs(N.copy(V).applyQuaternion(t).dot(this.eye))<.2&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),-1!==i.name.search("X")&&(N.copy(H).applyQuaternion(t).dot(this.eye)<-.4?"fwd"===i.tag?i.visible=!1:i.scale.x*=-1:"bwd"===i.tag&&(i.visible=!1)),-1!==i.name.search("Y")&&(N.copy(V).applyQuaternion(t).dot(this.eye)<-.4?"fwd"===i.tag?i.visible=!1:i.scale.y*=-1:"bwd"===i.tag&&(i.visible=!1)),-1!==i.name.search("Z")&&(N.copy(W).applyQuaternion(t).dot(this.eye)<-.4?"fwd"===i.tag?i.visible=!1:i.scale.z*=-1:"bwd"===i.tag&&(i.visible=!1))}else"rotate"===this.mode&&(U.copy(t),N.copy(this.eye).applyQuaternion(F.copy(t).inverse()),-1!==i.name.search("E")&&i.quaternion.setFromRotationMatrix(B.lookAt(this.eye,G,V)),"X"===i.name&&(F.setFromAxisAngle(H,Math.atan2(-N.y,N.z)),F.multiplyQuaternions(U,F),i.quaternion.copy(F)),"Y"===i.name&&(F.setFromAxisAngle(V,Math.atan2(N.x,N.z)),F.multiplyQuaternions(U,F),i.quaternion.copy(F)),"Z"===i.name&&(F.setFromAxisAngle(W,Math.atan2(N.y,N.x)),F.multiplyQuaternions(U,F),i.quaternion.copy(F)));i.visible=i.visible&&(-1===i.name.indexOf("X")||this.showX),i.visible=i.visible&&(-1===i.name.indexOf("Y")||this.showY),i.visible=i.visible&&(-1===i.name.indexOf("Z")||this.showZ),i.visible=i.visible&&(-1===i.name.indexOf("E")||this.showX&&this.showY&&this.showZ),i.material._opacity=i.material._opacity||i.material.opacity,i.material._color=i.material._color||i.material.color.clone(),i.material.color.copy(i.material._color),i.material.opacity=i.material._opacity,this.enabled?this.axis&&(i.name===this.axis?(i.material.opacity=1,i.material.color.lerp(new Pn.Color(1,1,1),.5)):this.axis.split("").some(function(e){return i.name===e})?(i.material.opacity=1,i.material.color.lerp(new Pn.Color(1,1,1),.5)):(i.material.opacity*=.25,i.material.color.lerp(new Pn.Color(1,1,1),.5))):(i.material.opacity*=.5,i.material.color.lerp(new Pn.Color(1,1,1),.5))}else i.visible=!1,"AXIS"===i.name?(i.position.copy(this.worldPositionStart),i.visible=!!this.axis,"X"===this.axis&&(F.setFromEuler(I.set(0,0,0)),i.quaternion.copy(t).multiply(F),Math.abs(N.copy(H).applyQuaternion(t).dot(this.eye))>.9&&(i.visible=!1)),"Y"===this.axis&&(F.setFromEuler(I.set(0,0,Math.PI/2)),i.quaternion.copy(t).multiply(F),Math.abs(N.copy(V).applyQuaternion(t).dot(this.eye))>.9&&(i.visible=!1)),"Z"===this.axis&&(F.setFromEuler(I.set(0,Math.PI/2,0)),i.quaternion.copy(t).multiply(F),Math.abs(N.copy(W).applyQuaternion(t).dot(this.eye))>.9&&(i.visible=!1)),"XYZE"===this.axis&&(F.setFromEuler(I.set(0,Math.PI/2,0)),N.copy(this.rotationAxis),i.quaternion.setFromRotationMatrix(B.lookAt(G,N,V)),i.quaternion.multiply(F),i.visible=this.dragging),"E"===this.axis&&(i.visible=!1)):"START"===i.name?(i.position.copy(this.worldPositionStart),i.visible=this.dragging):"END"===i.name?(i.position.copy(this.worldPosition),i.visible=this.dragging):"DELTA"===i.name?(i.position.copy(this.worldPositionStart),i.quaternion.copy(this.worldQuaternionStart),T.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),T.applyQuaternion(this.worldQuaternionStart.clone().inverse()),i.scale.copy(T),i.visible=this.dragging):(i.quaternion.copy(t),this.dragging?i.position.copy(this.worldPositionStart):i.position.copy(this.worldPosition),this.axis&&(i.visible=-1!==this.axis.search(i.name)))}Pn.Object3D.prototype.updateMatrixWorld.call(this)}};Tn.prototype=Object.assign(Object.create(Pn.Object3D.prototype),{constructor:Tn,isTransformControlsGizmo:!0});var In=function(){Pn.Mesh.call(this,new Pn.PlaneBufferGeometry(1e5,1e5,2,2),new Pn.MeshBasicMaterial({visible:!1,wireframe:!0,side:Pn.DoubleSide,transparent:!0,opacity:.1})),this.type="TransformControlsPlane";var e=new Pn.Vector3(1,0,0),t=new Pn.Vector3(0,1,0),n=new Pn.Vector3(0,0,1),r=new Pn.Vector3,i=new Pn.Vector3,a=new Pn.Vector3,o=new Pn.Matrix4,s=new Pn.Quaternion;this.updateMatrixWorld=function(){var c=this.space;switch(this.position.copy(this.worldPosition),"scale"===this.mode&&(c="local"),e.set(1,0,0).applyQuaternion("local"===c?this.worldQuaternion:s),t.set(0,1,0).applyQuaternion("local"===c?this.worldQuaternion:s),n.set(0,0,1).applyQuaternion("local"===c?this.worldQuaternion:s),a.copy(t),this.mode){case"translate":case"scale":switch(this.axis){case"X":a.copy(this.eye).cross(e),i.copy(e).cross(a);break;case"Y":a.copy(this.eye).cross(t),i.copy(t).cross(a);break;case"Z":a.copy(this.eye).cross(n),i.copy(n).cross(a);break;case"XY":i.copy(n);break;case"YZ":i.copy(e);break;case"XZ":a.copy(n),i.copy(t);break;case"XYZ":case"E":i.set(0,0,0)}break;case"rotate":default:i.set(0,0,0)}0===i.length()?this.quaternion.copy(this.cameraQuaternion):(o.lookAt(r.set(0,0,0),i,a),this.quaternion.setFromRotationMatrix(o)),Pn.Object3D.prototype.updateMatrixWorld.call(this)}};In.prototype=Object.assign(Object.create(Pn.Mesh.prototype),{constructor:In,isTransformControlsPlane:!0});var Nn=Ln;var Gn=function(){function e(){Object(s.a)(this,e)}return Object(c.a)(e,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create scene w/ missing parent");return ae(e,ie(e,{type:"scene",title:function e(t,n,r){var i=t+" "+n;return r.getChildren().find(function(e){return e.title==i})?e(t,n+1,r):i}("Scene ",0,t),autoRecenter:!0,defaultFloor:!1,parent:t.id,children:e.createArray()}))}},{key:"makeNode",value:function(e,t){var n=new dt.Group;return n.name=e.title,this.setDefaultFloor(n,e.defaultFloor),n.start=function(){n.userData.sceneAnchor=new dt.Group,n.userData.sceneAnchor.name="SceneAnchor",n.add(n.userData.sceneAnchor),n.children.forEach(function(e){var r,i=t.accessObject(e.userData.graphid);i.exists()&&((r=i.type)!==qt.geoanchor&&r!==qt.localanchor&&r!==qt.imageanchor&&r!==qt.hudanchor&&i.type!==qt.geoanchor&&i.type!==qt.localanchor&&i.type!==qt.imageanchor&&i.type!==qt.hudanchor&&n.userData.sceneAnchor.add(e))})},n.stop=function(){n.userData.sceneAnchor.children.slice().forEach(function(e){return n.add(e)}),n.remove(n.userData.sceneAnchor)},n}},{key:"updateProperty",value:function(e,t,n,r){console.log("update property",e.name,n.name,n.value),n.name===Zt.defaultFloor.key&&(console.log("setting the floor too",n.value),this.setDefaultFloor(e,n.value))}},{key:"setDefaultFloor",value:function(e,t){if(!0===t){var n=new dt.Mesh(new dt.PlaneBufferGeometry(100,100,10,10),new dt.MeshLambertMaterial({color:"blue"}));n.name="defaultFloor",n.rotation.x=-90*Math.PI/180,e.parts={},e.parts.floor=n,e.add(n)}else e.parts&&e.parts.floor&&(e.remove(e.parts.floor),delete e.parts.floor)}},{key:"getFloorPart",value:function(e){return e&&e.parts?e.parts.floor:null}}]),e}(),Bn=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this,e))).add=function(e){n.setState({notification:e,visible:!0}),setTimeout(n.hide,2e3)},n.hide=function(){return n.setState({visible:!1})},n.state={notification:"saved",visible:!1},n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"componentWillMount",value:function(){I.onAdd(this.add)}},{key:"componentWillUnmount",value:function(){I.offAdd(this.add)}},{key:"render",value:function(){return i.a.createElement("div",{style:{position:"absolute",bottom:"10px",left:"10px",backgroundColor:"rgba(0,0,0,0.6)",borderRadius:"1em",color:"white",fontSize:"24pt",padding:"1em",display:this.state.visible?"block":"none"}},this.state.notification)}}]),t}(r.Component),Fn=function(){function e(){Object(s.a)(this,e)}return Object(c.a)(e,[{key:"getCurrentScene",value:function(){throw new Error("getCurrentScene not implemented")}},{key:"getSceneObjects",value:function(e){throw new Error("getSceneObjects not implemented")}},{key:"getBehaviorsForObject",value:function(e){throw new Error("getBehaviorsForObject(obj) not implemented")}},{key:"getThreeObject",value:function(e){throw new Error("getThreeObject(id) not implemented")}},{key:"getParsedBehaviorAsset",value:function(e){throw new Error("getParsedBehaviorAsset(behavior) not implemented")}},{key:"getAllBehaviors",value:function(){throw new Error("getAllBehaviors() not implemented")}},{key:"getAllScenes",value:function(){throw new Error("getAllScenes not implemented")}},{key:"navigateScene",value:function(e){throw new Error("navigateScene(id) not implemented")}},{key:"playMediaAsset",value:function(e){throw new Error("playMediaAsset(id) not implemented")}},{key:"stopMediaAsset",value:function(e){throw new Error("stopMediaAsset(id) not implemented")}},{key:"getGraphObjectByName",value:function(e){throw new Error("getGraphObjectByName(name) not implemented")}},{key:"getGraphObjectById",value:function(e){throw new Error("getGraphObjectById(id) not implemented")}},{key:"getCamera",value:function(){throw new Error("getCamera() not implemented")}},{key:"getTweenManager",value:function(){throw new Error("getTweenManager() not implemented")}},{key:"startLocalAnchor",value:function(e){throw new Error("startLocalAnchor not implemented")}},{key:"stopLocalAnchor",value:function(e){throw new Error("stopLocalAnchor not implemented")}},{key:"startImageRecognizer",value:function(e){throw new Error("startImageRecognizer not implemented")}},{key:"stopImageRecognizer",value:function(e){throw new Error("stopImageRecognizer not implemented")}},{key:"startGeoTracker",value:function(e){throw new Error("startGeoTracker not implemented")}},{key:"stopGeoTracker",value:function(e){throw new Error("stopGeoTracker not implemented")}}]),e}(),Un=function(){function e(t,n,r){Object(s.a)(this,e),this.manager=t,this.sgp=n,this.logger=this.manager.logger,this.tween=n.getTweenManager(),this.camera=n.getCamera(),this.globalStorage=this.manager.storage,this.behavior=r}return Object(c.a)(e,[{key:"getThreeObjectByTitle",value:function(e){var t=this.sgp.getGraphObjectByName(e);if(!t)throw new Error("object '".concat(e,"' not found"));return this.sgp.getThreeObject(t)}},{key:"getObjectByTitle",value:function(e){return this.sgp.getGraphObjectByName(e)}},{key:"getAssetByTitle",value:function(e){var t=this.sgp.getGraphObjectByName(e);if(!t)throw new Error("asset '".concat(e,"' not found"));var n=this._event&&this._event.data&&this._event.data.event&&this._event.data.event.isTrusted;return new Hn(this.manager,t,n)}},{key:"getAssetById",value:function(e){var t=this.getObjectById(e);if(!t||!t.exists())throw new Error("asset '".concat(e,"' not found"));var n=this._event&&this._event.data&&this._event.data.event&&this._event.data.event.isTrusted;return new Hn(this.manager,t,n)}},{key:"getObjectById",value:function(e){return this.sgp.getGraphObjectById(e)}},{key:"getThreeObjectById",value:function(e){return this.sgp.getThreeObject(e)}},{key:"playSound",value:function(e){this.playMedia(e)}},{key:"playMedia",value:function(e){var t=this.sgp.getGraphObjectById(e),n=this._event&&this._event.data&&this._event.data.event&&this._event.data.event.isTrusted;this.manager.sgp.playMediaAsset(t,n)}},{key:"stopMedia",value:function(e){var t=this.sgp.getGraphObjectById(e);this.manager.sgp.stopMediaAsset(t)}},{key:"getCurrentScene",value:function(){return this.sgp.getCurrentScene()}},{key:"navigateScene",value:function(e){this.manager.fireSceneLifecycleEvent("exit",this.getCurrentScene()),this.sgp.navigateScene(e),this.manager.fireSceneLifecycleEvent("enter",this.getCurrentScene())}},{key:"fireEvent",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;null==n&&(n=this.sgp.getGraphObjectById(this.behavior.parent)),this.manager.fireEventAtTarget(n,e,t)}},{key:"sendMessage",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;null==n&&(n=this.sgp.getGraphObjectById(this.behavior.parent)),this.manager.fireMessageAtTarget(n,e,t)}},{key:"captureEvent",value:function(){this.manager.captureEvent()}},{key:"globals",get:function(){return{THREE:dt,GLTFLoader:wt,GPUParticles:Tt,WebLayer3D:Mt.a}}},{key:"properties",get:function(){return this.behavior.props()}}]),e}(),zn=function(){function e(t,n){Object(s.a)(this,e),this.sgp=t,this.logger=n,this.running=!1,this.storage={},this.logger=n,this.logger.log("ScriptManager created"),this.system_cache={},this.bubbling=!0,window.THREE||(window.THREE=dt),window.GLTFLoader||(window.GLTFLoader=wt),window.GPUParticles||(window.GPUParticles=Tt),window.WebLayer3D||(window.WebLayer3D=Mt.a)}return Object(c.a)(e,[{key:"makeSystemFacade",value:function(e){return new Un(this,this.sgp,e)}},{key:"fireLifecycleEvent",value:function(e){var t=this;this.logger.log("doing ".concat(e," event"));var n={type:e};this.sgp.getAllScenes().forEach(function(r){r.find(function(r){if(r.type===Jt.BEHAVIOR){n.target=t.sgp.getThreeObject(r.parent),n.graphTarget=t.sgp.getGraphObjectById(r.parent);var i=t.sgp.getParsedBehaviorAsset(r),a=t.getSystemFacadeFromCache(r);a.code=i,i[e]&&i[e].call(a,n)}else n.target=t.sgp.getThreeObject(r),n.graphTarget=r,n.target&&n.target[e]&&n.target[e](n,t)})})}},{key:"fireSceneLifecycleEvent",value:function(e,t,n){var r=this;"tick"!==e&&this.logger.log("doing ".concat(e," event"));var i={type:e,time:n?n-this.startTime:-1,deltaTime:n?n-this.lastTime:0,session:this.session};n&&(this.lastTime=n),t.find(function(t){if("tick"!==e&&r.logger.log("calling ".concat(e," on ").concat(t.type," ").concat(t.id)),t.type===Jt.BEHAVIOR){i.target=r.sgp.getThreeObject(t.parent),i.graphTarget=r.sgp.getGraphObjectById(t.parent);var n=r.sgp.getParsedBehaviorAsset(t),a=r.getSystemFacadeFromCache(t);a.code=n,n[e]&&n[e].call(a,i)}else i.target=r.sgp.getThreeObject(t),i.graphTarget=t,i.target&&i.target[e]&&i.target[e](i,r)})}},{key:"tick",value:function(e,t){if(this.running){0===this.startTime&&(this.startTime=e,this.lastTime=e);try{this.session=t,this.fireSceneLifecycleEvent("tick",this.sgp.getCurrentScene(),e)}catch(n){this.logger.error("error in script",n.message),this.logger.log(n),this.stopRunning()}}}},{key:"startRunning",value:function(){this.running=!0,this.startTime=0,this.lastTime=0,this.storage={},this.logger.log("ScriptManager starting");try{this.fireLifecycleEvent("start")}catch(e){this.logger.error("error in script",e.message),this.logger.error(e),this.stopRunning()}}},{key:"startFirstScene",value:function(){try{this.fireSceneLifecycleEvent("enter",this.sgp.getCurrentScene())}catch(e){this.logger.error("error in script",e.message),this.logger.error(e),this.stopRunning()}}},{key:"stopRunning",value:function(){try{this.fireSceneLifecycleEvent("exit",this.sgp.getCurrentScene()),this.fireLifecycleEvent("stop"),this.running=!1,this.storage={},this.destroyListeners()}catch(e){this.running=!1,this.logger.error("error stopping scripts",e.message),this.logger.error(e)}this.logger.log("script manager stopping")}},{key:"isRunning",value:function(){return this.running}},{key:"fireMessageAtTarget",value:function(e,t,n){var r=this;if(this.running)try{var i={type:"message",name:t,data:n,time:this.lastTime,target:this.sgp.getThreeObject(e),graphTarget:e};this.sgp.getBehaviorsForObject(e).forEach(function(e){var t=r.getSystemFacadeFromCache(e),n=r.sgp.getParsedBehaviorAsset(e);t._event=i,t.code=n,n.message&&n.message.call(t,i),t._event=null})}catch(a){this.logger.error("error in '"+t+"' message",a.message),this.logger.error(a),this.stopRunning()}}},{key:"performClickAction",value:function(e,t){this.fireEventAtTarget(e,"click",{event:t})}},{key:"captureEvent",value:function(){this.bubbling=!1}},{key:"fireEventAtTarget",value:function(e,t,n){var r=this;if(this.running)try{!function(){r.bubbling=!0;for(var i={type:t,data:n,time:r.lastTime,target:r.sgp.getThreeObject(e),graphTarget:e},a=r.sgp.getCurrentScene();r.bubbling&&e.id!==a.id&&e.type!==Jt.SCENE;){r.sgp.getBehaviorsForObject(e).forEach(function(e){var n=r.getSystemFacadeFromCache(e),a=r.sgp.getParsedBehaviorAsset(e);n._event=i,a[t]&&(n.code=a,a[t].call(n,i)),n._event=null}),e=r.sgp.getGraphObjectById(e.parent)}}()}catch(i){this.logger.error("error in '"+t+"' event",i.message),this.logger.error(i),this.stopRunning()}}},{key:"destroyListeners",value:function(){this.listeners={}}},{key:"on",value:function(e,t,n){this.listeners||(this.listeners={}),this.listeners[e.id]||(this.listeners[e.id]={}),this.listeners[e.id][t]||(this.listeners[e.id][t]=[]),this.listeners[e.id][t].push(n)}},{key:"getSystemFacadeFromCache",value:function(e){return this.system_cache[e.id]||(this.system_cache[e.id]=this.makeSystemFacade(e)),this.system_cache[e.id]}}]),e}(),Hn=function(){function e(t,n,r){Object(s.a)(this,e),this.manager=t,this.obj=n,this.trusted=r}return Object(c.a)(e,[{key:"play",value:function(){console.log("assets manager playing",this.obj.id),this.manager.sgp.playMediaAsset(this.obj,this.trusted)}},{key:"stop",value:function(){this.manager.sgp.stopMediaAsset(this.obj)}}]),e}(),Vn=function(){function e(){Object(s.a)(this,e),this.running=!1}return Object(c.a)(e,[{key:"update",value:function(e){throw new Error("update not implemented")}},{key:"start",value:function(){this.running=!0}},{key:"isAlive",value:function(){return this.running}},{key:"kill",value:function(){this.running=!1}}]),e}(),Wn=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this))).type="wait",n.duration=e,n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"update",value:function(e){e/=1e3,this.startTime||(this.startTime=e),(e-this.startTime)/this.duration>=1&&(this.running=!1)}}]),t}(Vn),Kn=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this))).type="action",n.fn=e,n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"start",value:function(){var e=this.fn();return this.running=!1,e}}]),t}(Vn),Yn=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this))).type="forever",n.fn=e,n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"start",value:function(){this.running=!0,this.startTime=Date.now()/1e3}},{key:"update",value:function(e){var t=e/1e3-this.startTime;this.fn(t)}}]),t}(Vn),Xn={SINGLE:"single",COMPOUND:"compound"},Zn={LINEAR:"linear",ELASTIC:"elastic"};function Qn(e,t,n){return(t-e)*n+e}var qn=function(e){function t(e){var n;if(Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this))).type="prop",n.target=e.target,n.duration=e.duration,"undefined"===typeof n.duration)throw new Error("duration is missing");if(n.property=e.property,"undefined"===typeof n.property)throw new Error("property is missing");return n.propertyType=e.propertyType||Xn.SINGLE,n.from=e.from,n.to=e.to,n.lerp_type=e.lerpType||Zn.LINEAR,n.loop=e.loop,"undefined"===typeof n.loop&&(n.loop=1),n.loopCount=0,n.reversed=!1,n.autoReverse=e.autoReverse,"undefined"===typeof n.autoReverse&&(n.autoReverse=!1),n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"update",value:function(e){e/=1e3,this.startTime||(this.startTime=e);var t=(e-this.startTime)/this.duration;if(t>1&&(t=1),this.setPropertyValue(this.from,this.to,t),1===t){if(this.loopCount++,this.autoReverse&&(this.reversed=!this.reversed),-1!==this.loop&&this.loopCount>=this.loop)return void(this.running=!1);this.startTime=e}}},{key:"setPropertyValue",value:function(e,t,n,r,i){var a=this;this.propertyType===Xn.SINGLE&&(this.target[this.property]=this.lerp(this.from,this.to,this.reversed?1-n:n)),this.propertyType===Xn.COMPOUND&&Object.keys(this.from).forEach(function(e){a.target[a.property][e]=a.lerp(a.from[e],a.to[e],a.reversed?1-n:n)})}},{key:"lerp",value:function(e,t,n){return this.lerp_type===Zn.LINEAR?Qn(e,t,n):this.lerp_type===Zn.ELASTIC?Qn(e,t,function(e){return Math.pow(2,-10*e)*Math.sin((e-.075)*(2*Math.PI)/.3)+1}(n)):(console.log("invalid LERP_TYPE"),e)}}]),t}(Vn),Jn=function(e){function t(e){var n;if(Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this))).type="clip",n.target=e.target,n.name=e.name,n.loop=e.loop,n.autoReverse=e.autoReverse,"undefined"===typeof n.autoReverse&&(n.autoReverse=!1),"undefined"===typeof n.loop&&(n.loop=1),"undefined"===typeof n.name)throw new Error("name is missing");return n.speed=e.speed,"undefined"===typeof n.speed&&(n.speed=1),n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"start",value:function(){this.running=!0,this.mixer=new dt.AnimationMixer(this.target.scene),this.action=this.mixer.clipAction(dt.AnimationClip.findByName(this.target.animations,this.name)),1===this.loop&&this.action.setLoop(dt.LoopOnce,1),-1===this.loop&&this.action.setLoop(this.autoReverse?dt.LoopPingPong:dt.LoopRepeat,1/0),this.loop>1&&this.action.setLoop(dt.LoopRepeat,this.loop),this.action.play(),this.action.setEffectiveTimeScale(this.speed),this.startTime=Date.now()/1e3,this.prevTime=this.startTime}},{key:"update",value:function(e){var t=e/1e3-this.prevTime;this.mixer.update(t),this.prevTime=e/1e3}},{key:"kill",value:function(){this.action.stop(),this.running=!1}}]),t}(Vn),$n=function(e){function t(){var e;return Object(s.a)(this,t),(e=Object(u.a)(this,Object(l.a)(t).call(this))).subs=[],e}return Object(h.a)(t,e),Object(c.a)(t,[{key:"and",value:function(e){return e instanceof Vn?this.subs.push(e):this.subs.push(new Kn(e)),this}},{key:"start",value:function(){return this.running=!0,this.subs.forEach(function(e){return e.start()}),this}},{key:"update",value:function(e){this.subs.forEach(function(t){t.isAlive()&&t.update(e)})}},{key:"isAlive",value:function(){return void 0!==this.subs.find(function(e){return!0===e.isAlive()})}}]),t}(Vn),_n=function(e){function t(){var e;return Object(s.a)(this,t),(e=Object(u.a)(this,Object(l.a)(t).call(this))).subs=[],e.n=-1,e}return Object(h.a)(t,e),Object(c.a)(t,[{key:"then",value:function(e){return e instanceof Vn?this.subs.push(e):this.subs.push(new Kn(e)),this}},{key:"wait",value:function(e){return this.subs.push(new Wn(e)),this}},{key:"start",value:function(){return this.running=!0,this._startNext(),this}},{key:"_startNext",value:function(){if(this.n=this.n+1,this.n>this.subs.length-1)return this.running=!1,this.n=-1,null;var e=this.subs[this.n],t=e.start();return e.isAlive()?e:t?(console.log("the next swapped itself",t),this.subs[this.n]=t,this.n=this.n-1,this._startNext()):this._startNext()}},{key:"update",value:function(e){var t=this.subs[this.n];t.update(e),t.isAlive()||this._startNext()}},{key:"isAlive",value:function(){return void 0!==this.subs.find(function(e){return!0===e.isAlive()})}}]),t}(Vn),er=function(){function e(){Object(s.a)(this,e),this.subs=[]}return Object(c.a)(e,[{key:"parallel",value:function(){var e=new $n;return this.subs.push(e),e}},{key:"sequence",value:function(){var e=new _n;return this.subs.push(e),e}},{key:"action",value:function(e){var t=new Kn(e);return this.subs.push(t),t}},{key:"prop",value:function(e){var t=new qn(e);return this.subs.push(t),t}},{key:"isAlive",value:function(){return this.subs.find(function(e){return!0===e.isAlive()})}},{key:"update",value:function(e){var t=Date.now();this.subs.forEach(function(e){e.isAlive()&&e.update(t)})}},{key:"forever",value:function(e){var t=new Yn(e);return this.subs.push(t),t}},{key:"clip",value:function(e){var t=new Jn(e);return this.subs.push(t),t}},{key:"wait",value:function(e){var t=new Wn(e);return this.subs.push(t),t}}]),e}(),tr=n(13),nr=n.n(tr),rr=n(17),ir=n(15),ar=n(14),or=window.Cesium,sr=window.XRGeospatialAnchor,cr=function(){function e(){Object(s.a)(this,e),this.imageDetectorMap={},this.geoAnchorMap={},this._workingMatrix=ir.a(),this._identity=ir.a(),this._vec=ar.a(),this.lastFrameTime=0}return Object(c.a)(e,[{key:"getContext",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this.device=0,this.session=0,this.xrCanvas=0,this.xrContext=0,this.canvas=e,this.context=0,this.xrCanvas=document.createElement("canvas"),this.xrContext=this.xrCanvas.getContext("xrpresent"),this._anchoredNodes=new Map,this.projectionMatrix=0;var t=this;return new Promise(function(e,n){navigator.xr.requestDevice().then(function(r){t.device=r,t.device.requestSession({outputContext:t.xrContext,alignEUS:!0,geolocation:!0,worldSensing:!0}).then(function(n){t.session=n,sr.useEstimatedElevation(!0),t.session.nonStandard_setNumberOfTrackedImages(4),t.canvas||(t.canvas=document.createElement("canvas")),t.context||(t.context=t.canvas.getContext("webgl",{compatibleXRDevice:t.device})),t.session.baseLayer=new window.XRWebGLLayer(t.session,t.context),e(t.context)}).catch(function(e){console.error("Session setup error",e),n()})}).catch(function(e){console.error("Error",e),n()})})}},{key:"setAnimationLoop",value:function(e){var t=this;e?(this.session.requestFrameOfReference("head-model").then(function(e){t.headFrameOfReference=e}).catch(function(e){console.error("Error finding head frame of reference",e)}),this.session.requestFrameOfReference("eye-level").then(function(e){t.eyeLevelFrameOfReference=e}).catch(function(e){console.error("Error finding eye frame of reference",e)}),this.userAnimationCallback=e,this.__handleAnimationFrame=this._handleAnimationFrame.bind(this),this.session.requestAnimationFrame(this.__handleAnimationFrame)):console.error("Supply a callback")}},{key:"_handleAnimationFrame",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(this.lastFrameTime=e,this.session&&!this.session.ended&&(this.session.requestAnimationFrame(this.__handleAnimationFrame),this.headFrameOfReference&&this.eyeLevelFrameOfReference)){var n=t.getDevicePose(this.eyeLevelFrameOfReference);if(n){var r=!0,i=!1,a=void 0;try{for(var o,s=t.views[Symbol.iterator]();!(r=(o=s.next()).done);r=!0){var c=o.value;this.userAnimationCallback(this.session.baseLayer.getViewport(c),c.projectionMatrix,n.getViewMatrix(c),e,t),this.projectionMatrix=c.projectionMatrix;break}}catch(u){i=!0,a=u}finally{try{r||null==s.return||s.return()}finally{if(i)throw a}}}else console.log("No pose")}}},{key:"getTime",value:function(){return this.lastFrameTime}},{key:"addAnchoredNode",value:function(e,t,n){return e&&e.uid?(this._anchoredNodes.set(e.uid,{anchor:e,node:t}),t.anchor=e,t.matrixAutoUpdate=!1,t.matrix.fromArray(e.modelMatrix),t.updateMatrixWorld(!0),e._handleAnchorUpdateCallback=this._handleAnchorUpdate.bind(this,n),e._handleAnchorDeleteCallback=this._handleAnchorDelete.bind(this,n),e.addEventListener("update",e._handleAnchorUpdateCallback),e.addEventListener("removed",e._handleAnchorDeleteCallback),n.log("done adding anchored node"),t):(console.error("not a valid anchor",e),void n.error("not a valid anchor ".concat(g(e))))}},{key:"createSceneAnchor",value:function(){var e=Object(rr.a)(nr.a.mark(function e(t,n){var r,i;return nr.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n.log("Creating Scene Anchor"),this.session){e.next=4;break}return n.log("no session"),e.abrupt("return");case 4:return e.next=6,this.session.requestFrameOfReference("eye-level");case 6:return r=e.sent,e.next=9,this.session.requestFrameOfReference("head-model");case 9:return e.sent.getTransformTo(r,this._workingMatrix),ir.c(this._vec,this._workingMatrix),ir.b(this._workingMatrix,this._vec),e.next=15,this.session.addAnchor(this._workingMatrix,r);case 15:return i=e.sent,this.addAnchoredNode(i,t,n),e.abrupt("return",i);case 18:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}()},{key:"updateAnchoredSceneNode",value:function(e,t,n){n.log("Replacing the scene node on the existing scene anchor"),this._removeAnchorFromNode(e),this.addAnchoredNode(e,t,n)}},{key:"removeSceneAnchor",value:function(e,t){t.log("Removing Scene Anchor"),this.session.removeAnchor(e),this._removeAnchorFromNode(e)}},{key:"updateSceneFloorAnchor",value:function(){var e=Object(rr.a)(nr.a.mark(function e(t,n,r){var i,a,o,s,c,u;return nr.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r.log("Finding floor Scene Anchor"),this.session){e.next=4;break}return r.log("no session"),e.abrupt("return",0);case 4:return e.next=6,this.session.requestFrameOfReference("eye-level");case 6:return i=e.sent,e.next=9,this.session.requestFrameOfReference("head-model");case 9:return(a=e.sent).getTransformTo(i,this._workingMatrix),ir.c(this._vec,this._workingMatrix),ir.b(this._workingMatrix,this._vec),o=ar.a(),ir.d(this._workingMatrix,this.projectionMatrix),s=ar.b(0,-1,1),ar.d(s,s,this._workingMatrix),ar.c(s,s),e.next=20,this.session.requestHitTest(o,s,a);case 20:if(!((c=e.sent).length<1)){e.next=24;break}return r.error("No hit returned from hit test"),e.abrupt("return",0);case 24:return e.next=26,this.session.addAnchor(c[0],a);case 26:if(u=e.sent){e.next=30;break}return r.error("No anchor returned from hit test"),e.abrupt("return",0);case 30:return r.log("Replacing the scene node on the existing scene anchor at the floor"),t&&this._removeAnchorFromNode(t),this.addAnchoredNode(u,n,r),e.abrupt("return",u);case 34:case"end":return e.stop()}},e,this)}));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"sleeper",value:function(e){return new Promise(function(t){return setTimeout(function(){return t()},e)})}},{key:"createLocalAnchorFromHitTest",value:function(){var e=Object(rr.a)(nr.a.mark(function e(t,n,r,i){var a,o,s,c,u,l,h;return nr.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.session){e.next=3;break}return i.error("no session"),e.abrupt("return",0);case 3:if(this.projectionMatrix){e.next=6;break}return i.error("No projection matrix"),e.abrupt("return",0);case 6:if(this.canvas&&this.canvas.width&&this.canvas.height){e.next=9;break}return i.error("No canvas or canvas size"),e.abrupt("return",0);case 9:if(t.node){e.next=12;break}return i.error("missing threejs node"),e.abrupt("return",0);case 12:return a=n/this.canvas.width*2-1,o=n/this.canvas.height*2,s=ar.a(),ir.d(this._workingMatrix,this.projectionMatrix),c=ar.b(a,o,.5),ar.d(c,c,this._workingMatrix),ar.c(c,c),e.next=21,this.session.requestFrameOfReference("head-model");case 21:return u=e.sent,e.next=24,this.session.requestHitTest(s,c,u);case 24:if(!((l=e.sent).length<1)){e.next=28;break}return i.error("No hit returned from hit test"),e.abrupt("return",0);case 28:return e.next=30,this.session.addAnchor(l[0],u);case 30:if(h=e.sent){e.next=34;break}return i.error("No anchor returned from hit test"),e.abrupt("return",0);case 34:return this._removeAnchorForNode(t.node),this.addAnchoredNode(h,t.node,i),i.log("made anchor in local coords: "+t.node.position.x+" "+t.node.position.y+" "+t.node.position.z),i.log(t),e.abrupt("return",h);case 39:case"end":return e.stop()}},e,this)}));return function(t,n,r,i){return e.apply(this,arguments)}}()},{key:"stopLocalAnchor",value:function(e,t){console.log("Stopping local anchor"),this._anchoredNodes&&(e.node?this._removeAnchorFromNode(e.node):t.error("missing threejs node"))}},{key:"_fetchImage",value:function(e,t){return new Promise(function(n,r){var i=new Image;i.crossOrigin="Anonymous",i.src=e.image.src,t.log("Loading image",i.src),i.onload=function(){n(i)}})}},{key:"createDetectionImage",value:function(e,t){var n=this;return t.log("creating/find an image recognizer"),new Promise(function(r,i){if(!e.image||!e.node)return t.log("createDetectionImage: missing image or threejs node"),void i("createDetectionImage: missing image or threejs node");if(!n.session)return t.log("no session"),void i("no session");var a=e.imageRealworldWidth||1;if(n.imageDetectorMap[e.image.src]){var o=n.imageDetectorMap[e.image.src];return a!=o.realWorldWidth?(t.log("can't create the same image with different real world width"),void i("can't create the same image with different real world width")):(t.log("createDetectionImage: already created, returning it"),void r(o.name))}n._fetchImage(e,t).then(function(o){t.log("got the image",g(o));var s,c=Object(Ee.a)(Array(10)).map(function(e){return(~~(36*Math.random())).toString(36)}).join(""),u=document.createElement("canvas"),l=u.getContext("2d");u.width=o.width,u.height=o.height,l.drawImage(o,0,0);try{s=l.getImageData(0,0,o.width,o.height)}catch(h){t.log("error drawing image ".concat(g(h))),t.log("name ".concat(h.name)),t.log("name ".concat(h.message)),t.log("local url is "+document.documentURI),t.log("image url from "+o.src),I.add("error drawing image",h.toString()),i(new Error("foo"))}t.log("calling createDetectionImage with image width and height ".concat(o.width," ").concat(o.height)),n.session.nonStandard_createDetectionImage(c,s.data,o.width,o.height,a).then(function(){n.imageDetectorMap[e.image.src]={name:c,realWorldWidth:a,anchor:null},r(c)}).catch(function(e){t.error("error creating detection image: ".concat(e)),i(e)})}).catch(function(e){t.error("error creating detection image: ".concat(e)),i(e)})})}},{key:"startImageRecognizer",value:function(e,t,n){var r=this;if(n.log("starting Image Recognizer"),e.image&&e.node)if(this.session){var i=e.callback,a=e.node;if(this.imageDetectorMap[e.image.src]){var o=this.imageDetectorMap[e.image.src];if(o.anchor){if(!e.reactivate)return n.log("Found existing anchor: use it"),n.log("remove from previous node"),this._removeAnchorFromNode(o.anchor),n.log("add our node"),this.addAnchoredNode(o.anchor,a,n),void(i&&i(e));n.log("Found existing anchor: reactivate"),this.session.removeAnchor(o.anchor),n.log("remove from previous node"),this._removeAnchorFromNode(o.anchor),o.anchor=null}a.anchorName=null,n.log("activate detection image"),this.session.nonStandard_activateDetectionImage(o.name).then(function(o){n.log("found detection image"),a.anchorName=t,a.anchorStyle="image",r.addAnchoredNode(o,a,n),i&&i(e)}).catch(function(e){n.error("error activating detection image: ".concat(e))})}else n.error("not detection object for image",e.image.src)}else n.log("no session");else n.log("missing image or threejs node")}},{key:"stopImageRecognizer",value:function(e,t){if(console.log("Stopping image recognizer"),this._anchoredNodes)if(this.imageDetectorMap[e.image.src]){var n=this.imageDetectorMap[e.image.src];n.anchor&&(console.log("already found the image, removing it"),this._removeAnchorFromNode(n.anchor),n.anchor=null),console.log("deactivating the image"),this.session.nonStandard_deactivateDetectionImage(n.name).then(function(){}).catch(function(e){t.error("error deactivating detection image: ".concat(e))})}else t.error("no detection object for image",e.image.src)}},{key:"createGeoAnchor",value:function(e,t){var n=this;return t.log("creating or reusing a geospatial anchor"),new Promise(function(r,i){if(!e.node)return t.log("Missing threejs node"),void i("Missing threejs node");if(!n.session)return t.log("no session"),void i("no session");if(n.geoAnchorMap[e.location.id]){n.geoAnchorMap[e.location.id];return t.log("found geoanchor: already created, returning it"),void r()}var a=e.location;e.object,e.node;if(0!=a.latitude||0!=a.longitude){var o=new or.Cartographic(a.longitude*Math.PI/180,a.latitude*Math.PI/180,a.altitude);a.useAltitude?(t.log("XRGeoAnchor: Placing an object at specified lla and specified altitude"),t.log(g(o)),sr.createGeoAnchor(o).then(function(t){n.geoAnchorMap[e.location.id]={anchor:t},r()}).catch(function(e){t.error("error creating geospatial anchor: ".concat(e)),i(e)})):sr.getDefaultElevation(o).then(function(a){o.height=a,t.log("XRGeoAnchor: Placing an object at specified lla and estimated altitude"),t.log(g(o)),sr.createGeoAnchor(o).then(function(t){n.geoAnchorMap[e.location.id]={anchor:t},r()}).catch(function(e){t.error("error creating geospatial anchor: ".concat(e)),i(e)})}).catch(function(e){t.error("error getting default elevation: ".concat(e)),i(e)})}else sr.getDeviceCartographic().then(function(a){sr.getDefaultElevation().then(function(o){var s=new or.Cartographic(a.longitude,a.latitude,o);t.log("XRGeoAnchor: Placing an object at your lla"),t.log(g(s)),sr.createGeoAnchor(s).then(function(t){n.geoAnchorMap[e.location.id]={anchor:t},r()}).catch(function(e){t.error("error creating geospatial anchor: ".concat(e)),i(e)})}).catch(function(e){t.error("error getting default elevation: ".concat(e)),i(e)})}).catch(function(e){t.error("error getting device cartographic location: ".concat(e)),i(e)})})}},{key:"addGeoAnchoredNode",value:function(e,t){if(t.log("adding a geotracked node"),e.node)if(this.session)if(this.geoAnchorMap[e.location.id]){var n=this.geoAnchorMap[e.location.id],r=e.callback,i=e.node;this._removeAnchorFromNode(n.anchor),t.log("add our node"),this.addAnchoredNode(n.anchor,i,t),r&&r(e)}else t.error("not geolocation anchor for object",e.location.id);else t.log("no session");else t.log("Missing threejs node")}},{key:"stopGeoTracker",value:function(e,t){e&&e.node&&this._removeAnchorForNode(e.node)}},{key:"_handleAnchorDelete",value:function(e,t){e.log("delete anchor");var n=t.source;this._removeAnchorFromNode(n)}},{key:"_removeAnchorForNode",value:function(e){var t=this;this._anchoredNodes.forEach(function(n){n.node!=e||t._removeAnchorFromNode(e.anchor)})}},{key:"_removeAnchorFromNode",value:function(e){var t=this._anchoredNodes.get(e.uid);t&&(t.node.anchor=null,e.removeEventListener("update",e._handleAnchorUpdateCallback),e.removeEventListener("removed",e._handleAnchorDeleteCallback),e._handleAnchorUpdateCallback=null,e._handleAnchorDeleteCallback=null,this._anchoredNodes.delete(e.uid))}},{key:"_handleAnchorUpdate",value:function(e,t){var n=t.source,r=this._anchoredNodes.get(n.uid);if(r){var i=r.node;i.matrixAutoUpdate=!1,i.matrix.fromArray(n.modelMatrix),i.updateMatrixWorld(!0)}}}],[{key:"supportsARKit",value:function(){return navigator.xr&&navigator.xr._mozillaXRViewer?(console.log("*** Found mozilla xr viewer"),!0):(console.log("*** Did not find WebXR"),!1)}}]),e}(),ur=n(23),lr=ur.SET_PROPERTY,hr=ur.INSERT_ELEMENT,pr=ur.DELETE_ELEMENT,dr=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this))).canvas=e,n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"logger",value:function(){return this.canvas.props.provider.getLogger()}},{key:"getCurrentScene",value:function(){var e=this.canvas.props.provider.getSelectedSceneObject();return e&&e.exists()?e:(this.logger.error("the current scene is null"),null)}},{key:"getSceneObjects",value:function(e){return e.getChildren().filter(function(e){return _t(e.type)})}},{key:"getBehaviorsForObject",value:function(e){return e.getChildren().filter(function(e){return e.type===Jt.BEHAVIOR})}},{key:"getThreeObject",value:function(e){return e.id?this.canvas.findNode(e.id):this.canvas.findNode(e)}},{key:"getParsedBehaviorAsset",value:function(e){var t=this.canvas.props.provider,n=t.accessObject(e.behavior);return t.getCachedBehaviorAsset(n.id)}},{key:"getAllBehaviors",value:function(){return this.canvas.props.provider.accessObject(this.canvas.props.provider.getSceneRoot()).find(function(e){return e.type===Jt.BEHAVIOR})}},{key:"getAllScenes",value:function(){return this.canvas.props.provider.accessObject(this.canvas.props.provider.getSceneRoot()).find(function(e){return e.type===Jt.SCENE})}},{key:"navigateScene",value:function(e){this.canvas.props.provider.accessObject(e).exists()?R.setSelection(e):this.canvas.props.provider.getLogger().error("cannot navigate to a scene that doesn't exist",e)}},{key:"playMediaAsset",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.canvas.props.provider.assetsManager.playMediaAsset(e,t)}},{key:"stopMediaAsset",value:function(e){this.canvas.props.provider.assetsManager.stopMediaAsset(e)}},{key:"getGraphObjectByName",value:function(e){var t=this.canvas.props.provider.accessObject(this.canvas.props.provider.getSceneRoot()).find(function(t){return t.title===e});return!t||t.length<1?null:t[0]}},{key:"getGraphObjectById",value:function(e){return this.canvas.props.provider.accessObject(e)}},{key:"getCamera",value:function(){return this.canvas.camera}},{key:"getTweenManager",value:function(){return this.canvas.tweenManager}},{key:"startLocalAnchor",value:function(e){return this.canvas.startLocalAnchor(e)}},{key:"stopLocalAnchor",value:function(e){return this.canvas.stopLocalAnchor(e)}},{key:"startImageRecognizer",value:function(e){return this.canvas.startImageRecognizer(e)}},{key:"stopImageRecognizer",value:function(e){return this.canvas.stopImageRecognizer(e)}},{key:"startGeoTracker",value:function(e){return this.canvas.startGeoTracker(e)}},{key:"stopGeoTracker",value:function(e){return this.canvas.stopGeoTracker(e)}}]),t}(Fn),fr=.1,vr=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this,e))).moveCameraForward=function(){n.camera.position.z+=-fr},n.moveCameraBackward=function(){n.camera.position.z+=fr},n.handleKeyPress=function(e){"ArrowUp"===e.key&&(n.camera.position.z-=fr),"ArrowDown"===e.key&&(n.camera.position.z+=fr),"a"===e.key&&(n.camera.position.x-=fr),"d"===e.key&&(n.camera.position.x+=fr),"ArrowLeft"===e.key&&(n.camera.rotation.y+=.1),"ArrowRight"===e.key&&(n.camera.rotation.y-=.1)},n.recenterOnSelection=function(){var e=R.getSelection();if(e){var t=n.props.provider.accessObject(e);if(_t(t.type)){var r=n.findNode(e);if(!r)return;n.orbitControls.target0.copy(r.position);var i=r.position.clone().sub(new dt.Vector3(0,0,-2));n.orbitControls.position0.copy(i),n.orbitControls.reset()}t.type===Jt.SCENE&&(n.orbitControls.saveState(),n.orbitControls.target0.set(0,0,0),n.orbitControls.position0.set(1,6,6),n.orbitControls.reset())}},n.pauseQueue=function(e){n.props.provider.pauseQueue()},n.unpauseQueue=function(e){n.props.provider.unpauseQueue()},n.transformChanged=function(e){var t=R.getSelection();if(t){var r=n.props.provider.accessObject(t);if(!_t(r.type))return;if(r.type===qt.bg360)return;var i=n.findNode(t);if(!i)return;var a=n.props.provider;a.quick_setPropertyValue(t,"tx",i.position.x),a.quick_setPropertyValue(t,"ty",i.position.y),a.quick_setPropertyValue(t,"tz",i.position.z)}},n.transformDraggingChanged=function(e){n.orbitControls.enabled=!e.value},n.docSwapped=function(e){n.scenes.forEach(function(e){return n.scene.remove(e)}),n.scenes=[],n.obj_node_map={},n.setState({scene:-1});var t=n.props.provider.getDocGraph();n.rebuildNode(t,"");var r=n.props.provider.getSelectedSceneObject();if(!r.exists())return n.props.provider.getLogger().error("no selected scene found");var i=n.findNode(r.id);n.setCurrentSceneWrapper(i,!1)},n.selectionChanged=function(){n.transformControls.detach();var e=R.getSelection();if(e){var t=n.props.provider.accessObject(e);if(t.type===Jt.SCENE)return n.setCurrentSceneWrapper(n.findNode(e),!0);if(_t(t.type)){var r=n.props.provider.findSceneObjectParent(t);n.setCurrentSceneWrapper(n.findNode(r.id),!0);var i=n.findNode(e);if(!i)return;n.transformControls.attach(i)}else console.log("selected something not an object or scene")}},n.clickedCanvas=function(e){n.canvas.focus();var t=n.canvas.getBoundingClientRect(),r={x:(e.clientX-t.left)/t.width*2-1,y:-(e.clientY-t.top)/t.height*2+1};n.raycaster.setFromCamera(r,n.camera);var i=n.raycaster.intersectObjects(n.getCurrentSceneWrapper().children,!0);if(i&&i.length>=1){var a=function e(t){return t?t.userData.graphid?t:e(t.parent):null}(i[0].object);n.state.running?n.scriptManager.performClickAction(n.props.provider.accessObject(a.userData.graphid),e):R.setSelection(a.userData.graphid)}else R.clearSelection()},n.obj_node_map={},n.previewUpdateNodes=[],n.scenes=[],n.state={scene:-1,running:e.running},n.current_scene_wrapper=null,n.scriptManager=new zn(new dr(Object(f.a)(Object(f.a)(n))),n.props.provider.getLogger()),n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"rebuildNode",value:function(e,t){var n=this;if(e.type===Jt.SCENE){var r=(new Gn).makeNode(e,this.props.provider);this.insertNodeMapping(e.id,r),this.addSceneWrapper(r)}if(_t(e.type)){var i=nn(e.type).makeNode(e,this.props.provider);this.insertNodeMapping(e.id,i),this.findNode(e.parent).add(i)}e.children&&e.children.forEach(function(e){n.rebuildNode(e,t+"   ")})}},{key:"checkAspectRatio",value:function(){if(this.canvas){var e=this.wrapper.clientWidth,t=this.wrapper.clientHeight,n=e/t;Math.abs(this.camera.aspect-n)>.001&&(this.camera.aspect=n,this.camera.updateProjectionMatrix(),this.renderer.setSize(e-4,t-4))}}},{key:"componentDidMount",value:function(){var e=this,t=this.canvas;this.props.provider.getLogger().log("mounting VRCanvas"),cr.supportsARKit()?(this.xr=new cr,this.xr.getContext(t).then(function(n){e.setupRenderer(t,n),e.xr.setAnimationLoop(e.animationLoopWithCamera.bind(e))}).catch(function(e){console.error("Error",e)})):(this.setupRenderer(t,0),this.renderer.setAnimationLoop(this.animationLoop.bind(this)))}},{key:"componentWillUnmount",value:function(){this.saveOrbitControlsState(),this.transformControls.removeEventListener("change",this.transformChanged),this.transformControls.removeEventListener("mouseDown",this.pauseQueue),this.transformControls.removeEventListener("mouseUp",this.unpauseQueue),this.props.provider.off(B.DOCUMENT_SWAPPED,this.docSwapped),R.off(j,this.selectionChanged)}},{key:"setupRenderer",value:function(e,t){var n=this;this.scene=new dt.Scene,this.camera=new dt.PerspectiveCamera(50,e.width/e.height,.1,1e3),this.renderer=new dt.WebGLRenderer({antialias:!1,canvas:e,context:t}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.gammaOutput=!0,this.audioListener=new dt.AudioListener,this.props.provider.setAudioListener(this.audioListener),this.camera.add(this.audioListener),this.xr||(this.scene.background=new dt.Color(0)),this.scene.add(this.camera),this.camera.position.set(1,6,6),this.transformControls=new Nn(this.camera,this.renderer.domElement),this.transformControls.addEventListener("change",this.transformChanged),this.transformControls.addEventListener("dragging-changed",this.transformDraggingChanged),this.transformControls.addEventListener("mouseDown",this.pauseQueue),this.transformControls.addEventListener("mouseUp",this.unpauseQueue),this.scene.add(this.transformControls),this.orbitControls=new dn(this.camera,this.renderer.domElement),this.orbitControls.update(),this.raycaster=new dt.Raycaster;var r=new dt.DirectionalLight(16777215,1);r.position.set(1,1,1).normalize(),this.scene.add(r),this.scene.add(new dt.AmbientLight(16777215,.4)),this.tweenManager=new er,this.props.provider.onRawChange(function(e){return n.updateScene(e)}),this.props.provider.on(B.DOCUMENT_SWAPPED,this.docSwapped),R.on(j,this.selectionChanged),this.docSwapped()}},{key:"animationLoop",value:function(e,t){this.checkAspectRatio();var n=null;this.xr&&(n=this.xr.session),this.state.running&&this.scriptManager.tick(e,n),this.tweenManager&&this.tweenManager.update(e),this.orbitControls&&this.orbitControls.update(),this.previewUpdateNodes.forEach(function(e){return e.previewUpdate()}),this.renderer.render(this.scene,this.camera)}},{key:"animationLoopWithCamera",value:function(e,t,n,r,i){this.scene&&this.camera&&(this.camera.matrix.fromArray(n),this.camera.matrixWorldNeedsUpdate=!0,this.camera.updateMatrixWorld(),this.camera.projectionMatrix.fromArray(t),this.animationLoop(r,i))}},{key:"insertNodeMapping",value:function(e,t){if("string"!==typeof e)throw new Error("cannot map an object to an object. invalid call in insertNodeMapping");this.obj_node_map[e]=t,t.userData.graphid=e,t.previewUpdate&&this.previewUpdateNodes.push(t)}},{key:"removeNodeMapping",value:function(e,t){delete this.obj_node_map[e],delete t.userData.graphid,this.previewUpdateNodes=this.previewUpdateNodes.filter(function(e){return e!==t})}},{key:"findNode",value:function(e){return this.obj_node_map[e]||console.warn("could not find node for id",e),this.obj_node_map[e]}},{key:"updateScene",value:function(e){var t=this.props.provider;if(e.type!==hr)if(e.type!==lr)if(e.type!==pr)   ;else{this.transformControls.detach();var n=this.findNode(e.value);n&&(this.removeNodeMapping(e.value,n),_t(t.accessObject(e.value).type)&&n.parent.remove(n))}else{if("parent"===e.name)return;var r=this.findNode(e.object);if(r){var i=t.accessObject(e.object);if("scene"===i.type)return void(new Gn).updateProperty(r,i,e,this.props.provider);if(_t(i.type))return nn(i.type).updateProperty(r,i,e,this.props.provider)}else console.log("could not find the node for object id:",e)}else{var a=e.value,o=t.accessObject(e.value);if(o.type===Jt.SCENE)return this.populateNode(a);if(_t(o.type))return this.populateNode(a);if(o.type===Jt.ASSET)return;if(o.type===Jt.ASSETS_LIST)return;if(o.type===Jt.BEHAVIOR_SCRIPT)return;if(o.type===Jt.BEHAVIOR)return;if(o.type===Jt.BEHAVIORS_LIST)return;console.warn("unknown object type",o)}}},{key:"shouldComponentUpdate",value:function(e,t,n){return"running"in e&&e.running!==this.props.running&&(this.setState({running:e.running}),!1===e.running?(this.scriptManager.stopRunning(),this.stopAllMedia(),this.resetSceneGraph(),this.stopRecognizers()):(this.startRecognizers(),this.scriptManager.startRunning(),this.scriptManager.startFirstScene()),!1)}},{key:"render",value:function(){var e=this;return i.a.createElement("div",{style:{borderWidth:0,boxSizing:"border-box",height:"100%",display:"flex",flexDirection:"column"}},i.a.createElement("button",{onClick:this.recenterOnSelection},"recenter on selection"),i.a.createElement("div",{style:{boxSizing:"border-box",borderWidth:0,margin:0,padding:0,flex:1,overflow:"auto"},ref:function(t){return e.wrapper=t}},i.a.createElement("canvas",{ref:function(t){return e.canvas=t},style:{boxSizing:"border-box",margin:0,padding:0,width:"100px",height:"100px",borderWidth:0},onClick:this.clickedCanvas,className:"editable-canvas",onKeyDown:this.handleKeyPress,tabIndex:0}),i.a.createElement(Bn,null)))}},{key:"populateNode",value:function(e){var t=this.props.provider.accessObject(e);if(_t(t.type)){var n=nn(t.type).makeNode(t,this.props.provider);return this.insertNodeMapping(e,n),this.findNode(t.parent).add(n),n}if(t.type===Jt.SCENE){var r=(new Gn).makeNode(t,this.props.provider);return this.insertNodeMapping(e,r),this.addSceneWrapper(r),this.setCurrentSceneWrapper(r,!0),r}console.warn("cannot populate node for type",t.type)}},{key:"addSceneWrapper",value:function(e){this.scenes.push(e),this.scene.add(e)}},{key:"saveOrbitControlsState",value:function(){var e=this.scenes.find(function(e){return e.visible});this.orbitControls.saveState();var t=e.userData.graphid;this.props.provider.orbit_state[t]={target:this.orbitControls.target0.clone(),position:this.orbitControls.position0.clone()}}},{key:"restoreOrbitControlsState",value:function(e){var t=e.userData.graphid;if(this.props.provider.orbit_state[t]){var n=this.props.provider.orbit_state[t];this.orbitControls.target0.copy(n.target),this.orbitControls.position0.copy(n.position),this.orbitControls.reset()}}},{key:"setCurrentSceneWrapper",value:function(e,t){if(!e)return this.props.provider.getLogger().error("invalid scene. cannot setCurrentSceneWrapper");var n=this.getCurrentSceneWrapper(),r=e!==n;r&&t&&this.saveOrbitControlsState(),this.current_scene_wrapper=e,this.scenes.forEach(function(t){t.visible=t===e}),r&&this.restoreOrbitControlsState(e)}},{key:"dumpScenes",value:function(){var e=this;this.scenes.forEach(function(t){console.log("scene"),e.dump(t,"")})}},{key:"dump",value:function(e,t){var n=this;console.log(t+"",e.type,e.id,"vis",e.visible),"Mesh"===e.type&&console.log(t+"  ",e.geometry.type),e.children&&e.children.forEach(function(e){return n.dump(e,t+"  ")})}},{key:"getCurrentSceneWrapper",value:function(){return this.current_scene_wrapper}},{key:"resetSceneGraph",value:function(){var e=this;Object.keys(this.obj_node_map).forEach(function(t){var n=e.props.provider.accessObject(t),r=e.obj_node_map[t];if("scene"!==n.type&&_t(n.type)){var i=nn(n.type);i.reset&&i.reset(r,n,e.props.provider.getDataGraph())}})}},{key:"stopAllMedia",value:function(){this.props.provider.assetsManager.stopAllMedia()}},{key:"startRecognizers",value:function(){}},{key:"stopRecognizers",value:function(){}},{key:"startLocalAnchor",value:function(e){this.props.provider.getLogger().log("NOTHING DONE TO start local anchor")}},{key:"stopLocalAnchor",value:function(e){this.props.provider.getLogger().log("NOTHING DONE TO stop local anchor")}},{key:"startImageRecognizer",value:function(e){this.props.provider.getLogger().log("NOTHING DONE TO start image recognizer")}},{key:"stopImageRecognizer",value:function(e){this.props.provider.getLogger().log("NOTHING DONE TO stop image recognizer")}},{key:"startGeoTracker",value:function(e){this.props.provider.getLogger().log("NOTHING DONE TO start geo recognizer")}},{key:"stopGeoTracker",value:function(e){this.props.provider.getLogger().log("NOTHING DONE TO stop geo recognizer")}}]),t}(r.Component),mr=(n(63),n(9)),yr=function(e,t,n){return e.addEventListener(t,n)},gr=function(e,t,n){return e.removeEventListener(t,n)},br=function(e){return e*Math.PI/180},wr=function(e){function t(e,n){var r;return Object(s.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this))).startHover=function(){return r.arrow.material.color.set(16777215)},r.endHover=function(){return r.arrow.material.color.set(16776960)},r.beginDrag=function(e){r.startPoint=r.parent.position.clone(),r.startPoint.copy(e.intersection.point),r.parent.target.parent.worldToLocal(r.startPoint),r.oldFilter=r.parent.pointer.intersectionFilter,r.parent.pointer.intersectionFilter=function(e){return e.userData.draggable},r.startPosition=r.parent.target.position.clone(),r.plane.visible=!0,yr(r.plane,mr.d,r.updateDrag),yr(r.plane,mr.f,r.endDrag)},r.updateDrag=function(e){r.endPoint=e.intersection.point.clone(),r.parent.target.parent.worldToLocal(r.endPoint),"X"===r.axis&&(r.endPoint.y=r.startPoint.y,r.endPoint.z=r.startPoint.z),"Y"===r.axis&&(r.endPoint.x=r.startPoint.x,r.endPoint.z=r.startPoint.z),"Z"===r.axis&&(r.endPoint.x=r.startPoint.x,r.endPoint.y=r.startPoint.y);var t=r.endPoint.clone().sub(r.startPoint),n=r.startPosition.clone().add(t);r.parent.target.position.copy(n),r.parent.position.copy(n)},r.endDrag=function(e){gr(r.plane,mr.d,r.updateDrag),gr(r.plane,mr.f,r.endDrag),r.parent.pointer.intersectionFilter=r.oldFilter,r.plane.visible=!1,r.parent.dispatchEvent({type:"change",start:r.startPosition.clone(),end:r.parent.position.clone()})},r.axis=e,r.control=n,r.makePlane(),r.makeArrow(),r.makeInputGrabber(),r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"makePlane",value:function(){this.plane=new dt.Mesh(new dt.PlaneBufferGeometry(100,100,100,100),new dt.MeshBasicMaterial({visible:!0,wireframe:!0,side:dt.DoubleSide})),"Z"===this.axis&&(this.plane.rotation.y=br(90)),this.plane.userData.draggable=!0,this.plane.visible=!1,this.add(this.plane)}},{key:"makeArrow",value:function(){this.arrow=new dt.Mesh(new dt.CylinderBufferGeometry(.02,.02,4),new dt.MeshLambertMaterial({color:"yellow"})),"X"===this.axis&&(this.arrow.rotation.z=br(90)),"Y"===this.axis&&(this.arrow.rotation.z=br(180)),"Z"===this.axis&&(this.arrow.rotation.x=br(90)),this.add(this.arrow)}},{key:"makeInputGrabber",value:function(){this.input=new dt.Mesh(new dt.CylinderBufferGeometry(.1,.1,4),new dt.MeshLambertMaterial({color:"green",visible:!1})),"X"===this.axis&&(this.input.rotation.z=br(90)),"Y"===this.axis&&(this.input.rotation.z=br(180)),"Z"===this.axis&&(this.input.rotation.x=br(90)),this.input.userData.clickable=!0,this.add(this.input)}},{key:"attach",value:function(){yr(this.input,mr.b,this.startHover),yr(this.input,mr.c,this.endHover),yr(this.input,mr.e,this.beginDrag)}},{key:"detach",value:function(){gr(this.input,mr.b,this.startHover),gr(this.input,mr.c,this.endHover),gr(this.input,mr.e,this.beginDrag)}}]),t}(dt.Group),Or=function(e){function t(){var e;return Object(s.a)(this,t),(e=Object(u.a)(this,Object(l.a)(t).call(this))).handles=[],e.handles.push(new wr("X",Object(f.a)(Object(f.a)(e)))),e.handles.push(new wr("Y",Object(f.a)(Object(f.a)(e)))),e.handles.push(new wr("Z",Object(f.a)(Object(f.a)(e)))),e.handles.forEach(function(t){return e.add(t)}),e.visible=!1,e}return Object(h.a)(t,e),Object(c.a)(t,[{key:"attach",value:function(e,t){this.target=e,this.pointer=t,this.position.copy(e.position),this.visible=!0,this.handles.forEach(function(e){return e.attach()})}},{key:"detach",value:function(){this.target=null,this.pointer=null,this.visible=!1,this.handles.forEach(function(e){return e.attach()})}}]),t}(dt.Group),kr=function(e,t,n){return e.addEventListener(t,n)},Sr=function(e){function t(e,n){var r;if(Object(s.a)(this,t),r=Object(u.a)(this,Object(l.a)(t).call(this)),!e)throw new Error("cannot pass empty scene to Panel2D()");if(!n)throw new Error("cannot pass empty camera to Panel2D()");r.type="panel2d",r.listeners={},r.scene=e,r.camera=n,r.canvas=document.createElement("canvas"),r.canvas.width=256,r.canvas.height=512,r.canvasTexture=new dt.CanvasTexture(r.canvas),r.redrawHandler=function(e){return r.redraw()};var i=r.canvas.getContext("2d");i.fillStyle="red",i.fillRect(0,0,r.canvas.width,r.canvas.height),r.mesh=new dt.Mesh(new dt.PlaneGeometry(1,2),new dt.MeshBasicMaterial({color:"white",map:r.canvasTexture})),r.mesh.userData.clickable=!0,r.comps=[],r.add(r.mesh);var a=null;return kr(r.mesh,mr.d,function(e){var t=e.intersection.uv,n=new dt.Vector2(256*t.x,512-512*t.y);a&&!a.contains(n)&&(a.fire(mr.c),a=null);var i=r.findAt(n);a!==i&&(a&&a.fire(mr.c),a=null),i&&i.fire(mr.b),a=i}),kr(r.mesh,mr.a,function(e){var t=e.intersection.uv,n=new dt.Vector2(256*t.x,512-512*t.y),i=r.findAt(n);i&&i.fire(mr.a)}),r.header=new dt.Mesh(new dt.BoxGeometry(1,.1,.1),new dt.MeshBasicMaterial({color:"goldenrod"})),r.header.userData.clickable=!0,r.header.position.set(0,1.1,0),r.add(r.header),kr(r.header,mr.b,function(e){return r.header.material.color.set("yellow")}),kr(r.header,mr.c,function(e){return r.header.material.color.set("goldenrod")}),kr(r.header,mr.e,function(e){return r.startDrag()}),r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"fire",value:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].forEach(function(e){return e(t)})}},{key:"findAt",value:function(e){for(var t=0;t<this.comps.length;t++){var n=this.comps[t],r=n.findAt({x:e.x-n.x,y:e.y-n.y});if(r)return r}return null}},{key:"add",value:function(e){e instanceof dt.Object3D?Object(d.a)(Object(l.a)(t.prototype),"add",this).call(this,e):(this.comps.push(e),kr(e,"changed",this.redrawHandler))}},{key:"redraw",value:function(){var e=this.canvas.getContext("2d");e.fillStyle="white",e.fillRect(0,0,this.canvas.width,this.canvas.height),this.comps.forEach(function(t){return t.draw(e)}),this.canvasTexture.needsUpdate=!0}},{key:"startDrag",value:function(){var e=this;this.header.userData.clickable=!1,this.mesh.userData.clickable=!1,this.dragSphere=new dt.Mesh(new dt.SphereGeometry(4,32,32),new dt.MeshLambertMaterial({color:"green",wireframe:!0,side:dt.BackSide})),this.dragSphere.userData.clickable=!0,this.scene.add(this.dragSphere),kr(this.dragSphere,mr.d,function(t){return e.moveDrag(t)}),kr(this.dragSphere,mr.f,function(t){return e.endDrag(t)})}},{key:"endDrag",value:function(){this.scene.remove(this.dragSphere),this.dragSphere.userData.clickable=!1,this.header.userData.clickable=!0,this.mesh.userData.clickable=!0}},{key:"moveDrag",value:function(e){this.position.copy(e.point),this.position.add(new dt.Vector3(0,-1,0)),this.lookAt(this.camera.position)}}]),t}(dt.Object3D),Ar=function(){function e(){Object(s.a)(this,e),this.listeners={}}return Object(c.a)(e,[{key:"set",value:function(e,t){return this[e]=t,this.fire("changed",{type:"changed",target:this}),this}},{key:"get",value:function(e){return this[e]}},{key:"addEventListener",value:function(e,t){return this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t),this}},{key:"on",value:function(e,t){return this.addEventListener(e,t),this}},{key:"setAll",value:function(e){var t=this;return Object.keys(e).forEach(function(n){return t.set(n,e[n])}),this}},{key:"fire",value:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].forEach(function(e){return e(t)})}}]),e}(),xr=function(e){function t(){var e;return Object(s.a)(this,t),(e=Object(u.a)(this,Object(l.a)(t).call(this))).type="button",e.text="foo",e.x=0,e.y=0,e.fsize=20,e.w=e.text.length*e.fsize,e.h=20,e.normalBg="white",e.hoverBg="red",e.bg=e.normalBg,e.on(mr.b,function(){e.bg=e.hoverBg,e.fire("changed",{type:"changed",target:Object(f.a)(Object(f.a)(e))})}),e.on(mr.c,function(){e.bg=e.normalBg,e.fire("changed",{type:"changed",target:Object(f.a)(Object(f.a)(e))})}),e}return Object(h.a)(t,e),Object(c.a)(t,[{key:"draw",value:function(e){e.font="".concat(this.fsize,"px sans-serif");var t=e.measureText(this.text);this.w=5+t.width+5,this.h=0+this.fsize+4,e.fillStyle=this.bg,e.fillRect(this.x,this.y,this.w,this.h),e.fillStyle="black",e.fillText(this.text,this.x+3,this.y+this.fsize-2),e.strokeStyle="black",e.strokeRect(this.x,this.y,this.w,this.h)}},{key:"contains",value:function(e){return!(e.x<this.x)&&(!(e.x>this.x+this.w)&&(!(e.y<this.y)&&!(e.y>this.y+this.h)))}},{key:"findAt",value:function(e){return e.x<0?null:e.x>0+this.w?null:e.y<0?null:e.y>0+this.h?null:this}},{key:"set",value:function(e,n){Object(d.a)(Object(l.a)(t.prototype),"set",this).call(this,e,n),"normalBg"===e&&(this.bg=this.normalBg)}}]),t}(Ar),Cr=function(e){function t(){var e;return Object(s.a)(this,t),(e=Object(u.a)(this,Object(l.a)(t).call(this))).type="group",e.x=0,e.y=0,e.w=100,e.h=100,e.bg="gray",e.visible=!0,e.comps=[],e.padding=5,e.border=1,e.layout=function(e){console.log("not laying out anything")},e}return Object(h.a)(t,e),Object(c.a)(t,[{key:"draw",value:function(e){this.visible&&(this.layout(this),e.fillStyle=this.bg,e.fillRect(this.x,this.y,this.w,this.h),this.border>0&&(e.strokeStyle="black",e.strokeRect(this.x,this.y,this.w,this.h)),e.save(),e.translate(this.x+this.padding,this.y+this.padding),this.comps.forEach(function(t){return t.draw(e)}),e.restore())}},{key:"contains",value:function(e){return!(e.x<this.x)&&(!(e.x>this.x+this.w)&&(!(e.y<this.y)&&!(e.y>this.y+this.h)))}},{key:"findAt",value:function(e){if(!this.visible)return null;for(var t=0;t<this.comps.length;t++){var n=this.comps[t],r=n.findAt({x:e.x-n.x-5,y:e.y-n.y-5});if(r)return r}return null}},{key:"childSet",value:function(e,t){return this.childProps[e]=t,this.comps.forEach(function(n){return n.set(e,t)}),this}},{key:"add",value:function(e){return this.comps.push(e),this.fire("changed",{type:"changed",target:this}),this}}]),t}(Ar),Mr=function(e){return Math.PI/180*e},Er=new dt.Vector3(0,1,0),jr=function(){function e(t,n){var r=this;Object(s.a)(this,e),this.stagePos=t,this.stageRot=n,this.states={touchpad:!1},this.listeners={},this.keystates={ArrowLeft:{current:!1,previous:!1},ArrowRight:{current:!1,previous:!1},ArrowUp:{current:!1,previous:!1},ArrowDown:{current:!1,previous:!1}},this.dir=new dt.Vector3(0,0,1),document.addEventListener("keydown",function(e){r.keystates[e.key]&&(r.keystates[e.key].current=!0)}),document.addEventListener("keyup",function(e){r.keystates[e.key]&&(r.keystates[e.key].current=!1)})}return Object(c.a)(e,[{key:"addEventListener",value:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}},{key:"_fire",value:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].forEach(function(e){return e(t)})}},{key:"updateKeys",value:function(){var e=this;!1===this.keystates.ArrowLeft.current&&!0===this.keystates.ArrowLeft.previous&&this.rotateLeft(),!1===this.keystates.ArrowRight.current&&!0===this.keystates.ArrowRight.previous&&this.rotateRight(),!1===this.keystates.ArrowUp.current&&!0===this.keystates.ArrowUp.previous&&this.moveForward(),!1===this.keystates.ArrowDown.current&&!0===this.keystates.ArrowDown.previous&&this.moveBackward(),Object.keys(this.keystates).forEach(function(t){e.keystates[t].previous=e.keystates[t].current})}},{key:"rotateLeft",value:function(){this.dir.applyAxisAngle(Er,Mr(30)),this.stageRot.rotation.y-=Mr(30)}},{key:"rotateRight",value:function(){this.dir.applyAxisAngle(Er,-Mr(30)),this.stageRot.rotation.y+=Mr(30)}},{key:"moveForward",value:function(){this.stagePos.position.add(this.dir),this._fire("move",this.stagePos.position)}},{key:"moveBackward",value:function(){this.stagePos.position.sub(this.dir),this._fire("move",this.stagePos.position)}},{key:"update",value:function(){this.scanGamepads(),this.updateKeys()}},{key:"scanGamepads",value:function(){for(var e=navigator.getGamepads(),t=0;t<e.length;t++){var n=e[t];if(n&&("Daydream Controller"===n.id||"Gear VR Controller"===n.id||"Oculus Go Controller"===n.id||"OpenVR Gamepad"===n.id||n.id.startsWith("Oculus Touch")||n.id.startsWith("Spatial Controller"))){if(n.buttons.length<2)return;var r=n.buttons[0];if(r.pressed&&n.axes&&2===n.axes.length){var i=n.axes[0]<-.5,a=n.axes[0]>.5,o=n.axes[1]<-.5,s=n.axes[1]>.5;o&&!1===this.states.touchpad&&!0===r.pressed&&this.moveForward(),s&&!1===this.states.touchpad&&!0===r.pressed&&this.moveBackward(),i&&!1===this.states.touchpad&&!0===r.pressed&&this.rotateLeft(),a&&!1===this.states.touchpad&&!0===r.pressed&&this.rotateRight()}n.buttons[1].pressed&&console.log("trigger"),!1===this.states.touchpad&&!0===r.pressed&&console.log("pressed"),!0===this.states.touchpad&&!1===r.pressed&&console.log("released"),this.states.touchpad=r.pressed}}}}]),e}();function Dr(e){var t=e.accessObject(e.getSceneRoot()),n=(new Gn).make(e.getDataGraph(),t);t.insertFirstChild(n),R.setSelection(n.id)}function Rr(e){R.isEmpty()||(e.accessObject(R.getSelection()).removeFromParent(),R.clearSelection())}function Pr(e){var t=Object.assign({},e.options,{mode:"edit",switcher:!1,doc:e.genID("doc")});document.location="./?".concat(O(t))}function Lr(e){var t=[];return G.supportsAssetUpload()?t=t.concat([{title:"image",enabled:G.isLoggedIn(),icon:cn.image,fun:function(){return e.showAddImageAssetDialog()}},{title:"server image",enabled:G.isLoggedIn(),icon:cn.image,fun:function(){return e.showAddServerImageDialog()}},{divider:!0},{title:"GLTF model",enabled:G.isLoggedIn(),icon:cn.model,fun:function(){return e.showAddGLTFAssetDialog()}},{title:"GLB model",enabled:G.isLoggedIn(),icon:cn.model,fun:function(){return e.showAddGLBAssetDialog()}},{divider:!0},{title:"audio file",enabled:G.isLoggedIn(),icon:cn.audio,fun:function(){return e.showAddAudioAssetDialog()}},{title:"existing asset on server",enabled:G.isLoggedIn(),icon:cn.assets,fun:function(){return e.showOpenAssetDialog()}}]):t.push({title:"add asset from glitch",icon:cn.assets,fun:function(){return e.showOpenAssetDialog()}}),t.push({title:"geo location",icon:cn.geoanchor,fun:function(){return e.showAddGeoLocationAssetDialog()}}),t}var Tr=n(23),Ir=Tr.SET_PROPERTY,Nr=Tr.CREATE_OBJECT,Gr=Tr.INSERT_ELEMENT,Br=Tr.DELETE_ELEMENT,Fr=function(e){function t(e,n){var r;return Object(s.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this))).editor=e,r.provider=n,r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"getCurrentScene",value:function(){return this.provider.accessObject(this.editor.currentScene)}},{key:"getSceneObjects",value:function(e){return e.getChildren().filter(function(e){return _t(e.type)})}},{key:"getBehaviorsForObject",value:function(e){return e.getChildren().filter(function(e){return e.type===Jt.BEHAVIOR})}},{key:"getThreeObject",value:function(e){return this.editor.findNode(e)}},{key:"getParsedBehaviorAsset",value:function(e){var t=this.provider.accessObject(e.behavior);return this.provider.getCachedBehaviorAsset(t.id)}},{key:"getAllBehaviors",value:function(){return this.provider.accessObject(this.provider.getSceneRoot()).find(function(e){return e.type===Jt.BEHAVIOR})}},{key:"getAllScenes",value:function(){return this.provider.accessObject(this.provider.getSceneRoot()).find(function(e){return e.type===Jt.SCENE})}},{key:"navigateScene",value:function(e){if(this.provider.accessObject(e).exists())return this.editor.swapScene(e);this.provider.getLogger().error("cannot navigate to scene that does not exist",e)}},{key:"playMediaAsset",value:function(e,t){this.provider.assetsManager.playMediaAsset(e,t)}},{key:"stopMediaAsset",value:function(e){this.provider.assetsManager.stopMediaAsset(e)}},{key:"getGraphObjectByName",value:function(e){var t=this.provider.accessObject(this.provider.getSceneRoot()).find(function(t){return t.title===e});return!t||t.length<1?null:t[0]}},{key:"getGraphObjectById",value:function(e){return this.provider.accessObject(e)}},{key:"getCamera",value:function(){return this.editor.camera}},{key:"getTweenManager",value:function(){return this.editor.tweenManager}},{key:"startLocalAnchor",value:function(e){this.provider.getLogger().log("NOTHING DONE TO start local anchor")}},{key:"stopLocalAnchor",value:function(e){this.provider.getLogger().log("NOTHING DONE TO stop local anchor")}},{key:"startImageRecognizer",value:function(e){this.provider.getLogger().log("NOTHING DONE TO start image recognizer")}},{key:"stopImageRecognizer",value:function(e){this.provider.getLogger().log("NOTHING DONE TO stop image recognizer")}},{key:"startGeoTracker",value:function(e){this.provider.getLogger().log("NOTHING DONE TO start geo recognizer")}},{key:"stopGeoTracker",value:function(e){this.provider.getLogger().log("NOTHING DONE TO stop geo recognizer")}}]),t}(Fn),Ur=function(e){function t(e){var n;Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this,e))).standardViewClickHandler=function(e){n.scriptManager.isRunning()?n.scriptManager.performClickAction(n.props.provider.accessObject(e.target.userData.graphid),e):R.setSelection(e.target.userData.graphid)},n.obj_node_map={},n.previewUpdateNodes=[];var r=m({});if(!r.doc)throw new Error("doc not specified");return n.logger=new Le(r.doc),n.scriptManager=new zn(new Fr(Object(f.a)(Object(f.a)(n)),n.props.provider),n.logger),n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"shouldComponentUpdate",value:function(e,t,n){return!1}},{key:"render",value:function(){var e=this;return i.a.createElement("div",null,i.a.createElement("div",{id:"overlay"},i.a.createElement("div",{id:"inner"},i.a.createElement("h1",null,"Application Name"),i.a.createElement("div",{id:"loading-indicator"},i.a.createElement("label",null,"loading"),i.a.createElement("progress",{max:"100",value:"0",id:"progress"})),i.a.createElement("button",{id:"enter-button",disabled:!0},"VR not supported, play anyway"))),i.a.createElement("div",{ref:function(t){return e.wrapper=t}}),i.a.createElement(p.a,null))}},{key:"componentDidMount",value:function(){this.sceneWrappers={},this.initScene(),this.renderer.setAnimationLoop(this.render3.bind(this))}},{key:"render3",value:function(e){this.tweenManager&&this.tweenManager.update(e),this.previewUpdateNodes.forEach(function(e){return e.previewUpdate()}),this.pointer&&this.pointer.tick(e),this.stats&&this.stats.update(e),this.controller&&this.controller.update(e),this.scriptManager.isRunning()&&this.scriptManager.tick(e),this.renderer.render(this.scene,this.camera)}},{key:"initScene",value:function(){var e=this,t=function(e){return document.querySelector(e)},n=function(e,t,n){return e.addEventListener(t,n)},r=this.wrapper;this.tweenManager=new er,this.scene=new dt.Scene,this.stageRot=new dt.Group,this.scene.add(this.stageRot),this.stagePos=new dt.Group,this.stageRot.add(this.stagePos),this.camera=new dt.PerspectiveCamera(70,window.innerWidth/window.innerHeight,.1,50),this.renderer=new dt.WebGLRenderer({antialias:!0});var i=this.renderer;i.setPixelRatio(window.devicePixelRatio),i.setSize(window.innerWidth,window.innerHeight),i.gammaOutput=!0,i.vr.enabled=!0,r.appendChild(i.domElement),this.vrmanager=new mr.h(i),this.audioListener=new dt.AudioListener,this.props.provider.setAudioListener(this.audioListener),this.camera.add(this.audioListener),this.initContent(),window.addEventListener("resize",function(){e.camera.aspect=window.innerWidth/window.innerHeight,e.camera.updateProjectionMatrix(),e.renderer.setSize(window.innerWidth,window.innerHeight)},!1),n(t("#enter-button"),"click",function(){t("#overlay").style.display="none"}),this.vrmanager.addEventListener(mr.j,function(){console.log("VR detected"),t("#enter-button").removeAttribute("disabled",!1),t("#enter-button").innerText="enter vr",n(t("#enter-button"),"click",function(){return e.vrmanager.enterVR()})});t("#loading-indicator").style.display="none",t("#enter-button").style.display="block",t("#enter-button").removeAttribute("disabled"),this.props.provider.onRawChange(this.updateSceneOp.bind(this)),this.props.provider.on(B.DOCUMENT_SWAPPED,this.documentSwapped.bind(this)),R.on(j,this.selectionChanged.bind(this)),n(this.pointer,mr.a,function(){return R.clearSelection()}),this.controller=new jr(this.stagePos,this.stageRot),this.loadScene()}},{key:"selectionChanged",value:function(){var e=R.getSelection();if(null===e&&this.controls)return this.controls.detach(this.selectedNode);var t=this.findNode(e);this.selectedNode!==t&&this.controls&&this.controls.detach(this.selectedNode),this.selectedNode=t,this.selectedNode&&this.controls&&this.controls.attach(this.selectedNode,this.pointer)}},{key:"initContent",value:function(){var e=this;this.xr||(this.scene.background=new dt.Color(0));var t=new dt.DirectionalLight(16777215,1);t.position.set(1,1,1).normalize(),this.scene.add(t),this.scene.add(new dt.AmbientLight(16777215,.2)),this.stats=new mr.i({renderer:this.renderer}),this.props.editable&&this.camera.add(this.stats),this.scene.add(this.camera),this.camera.matrixAutoUpdate=!1,this.pointer=new mr.g(this,{intersectionFilter:function(e){return e.userData.clickable},cameraFollowMouse:!1,mouseSimulatesController:!1,enableLaser:!0,laserLength:20});var n=new dt.Mesh(new dt.CylinderBufferGeometry(.1,.1,1),new dt.MeshLambertMaterial({color:"aqua"}));if(n.position.z=-.5,n.rotation.x=rn(-90),this.pointer.controller1.add(n),this.props.editable&&(this.controls=new Or,this.controls.name="Controls",y(this.controls,"change",function(t){var n=R.getSelection();if(n){var r=e.findNode(n),i=e.props.provider;i.quick_setPropertyValue(n,"tx",r.position.x),i.quick_setPropertyValue(n,"ty",r.position.y),i.quick_setPropertyValue(n,"tz",r.position.z)}})),this.props.editable){this.tools=new Sr(this.scene,this.camera),this.tools.position.set(-1,0,-3),this.scene.add(this.tools),this.tools.add((new xr).setAll({x:5,y:5,text:"add box"}).on(mr.a,function(){var t=e.props.provider.accessObject(e.currentScene);e.props.provider.add3DObject(qt.cube,t)})),this.tools.add((new xr).setAll({x:5,y:35,text:"add sphere"}).on(mr.a,function(){var t=e.props.provider.accessObject(e.currentScene);e.props.provider.add3DObject(qt.sphere,t)})),this.tools.add((new xr).setAll({x:5,y:65,text:"delete"}).on(mr.a,function(){Rr(e.props.provider)})),this.tools.add((new xr).setAll({x:5,y:95,text:"save"}).on(mr.a,this.props.provider.save));var r=(new xr).setAll({x:5,y:125,text:"run"}).on(mr.a,function(){e.scriptManager.isRunning()?(r.set("text","run"),e.scriptManager.stopRunning()):(r.set("text","stop"),e.scriptManager.startRunning(),e.scriptManager.startFirstScene())});this.tools.add(r);var i=(new Cr).setAll({x:5,y:155,w:235,h:35,layout:function(e){var t=0;e.comps.forEach(function(n){n.x=t,n.y=0,t+=n.w+e.padding})}});Qt.forEach(function(t){i.add((new xr).setAll({text:" ",normalBg:t}).on(mr.a,function(){return e.props.provider.setColor(t)}))}),this.tools.add(i),this.tools.redraw()}}},{key:"updateSceneOp",value:function(e){if(e.type===Nr&&e.defaults&&"scene"===e.defaults.type){var t=this.findNode(e.id);if(t)   ;else{var n=this.props.provider.accessObject(e.id);t=(new Gn).makeNode(n,this.props.provider),this.insertNodeMapping(e.id,t),this.sceneWrappers[e.id]=t,this.stagePos.add(t),this.swapScene(e.id)}}if(e.type!==Gr)if(e.type!==Ir)if(e.type!==Br)   ;else{var r=this.props.provider.accessObject(e.value);if(_t(r.type)){var i=this.findNode(r.id);this.findNode(r.parent).remove(i)}}else{var a=this.props.provider.accessObject(e.object);if("asset"===a.type)return;if("assets"===a.type)return;var o=this.findNode(e.object);if(o){if("parent"===e.name)return;if("scene"===a.type)return(new Gn).updateProperty(o,a,e,this.props.provider);if(_t(a.type))return nn(a.type).updateProperty(o,a,e,this.props.provider)}else console.log("could not find the node for object id:",e)}else{var s=this.props.provider.accessObject(e.value);if("scene"===s.type)return;if(_t(s.type)){var c=nn(s.type).makeNode(s,this.props.provider);return y(c,mr.a,this.standardViewClickHandler),this.insertNodeMapping(s.id,c),void this.findNode(s.parent).add(c)}if(s.type===Jt.ASSETS_LIST)return;if(s.type===Jt.ASSET)return;if(s.type===Jt.BEHAVIORS_LIST)return;if(s.type===Jt.BEHAVIOR)return;if(s.type===Jt.BEHAVIOR_SCRIPT)return;console.warn("unknown object type",s)}}},{key:"documentSwapped",value:function(){var e=this;console.log("totally new document!"),Object.keys(this.sceneWrappers).forEach(function(t){var n=e.sceneWrappers[t];e.controls&&n.remove(e.controls),e.stagePos.remove(n)}),this.sceneWrappers={},this.obj_node_map={};var t=this.props.provider.getDocGraph();console.log("we are building the graph"),this.rebuildNode(t,"")}},{key:"rebuildNode",value:function(e,t){var n=this;if(console.log(t,"rebuilding",e.type),e.type===Jt.SCENE){var r=(new Gn).makeNode(e,this.props.provider);this.insertNodeMapping(e.id,r),this.sceneWrappers[e.id]=r,this.stagePos.add(r),this.swapScene(e.id)}if(_t(e.type)){var i=nn(e.type).makeNode(e,this.props.provider);y(i,mr.a,this.standardViewClickHandler),this.insertNodeMapping(e.id,i),this.findNode(e.parent).add(i)}e.children&&e.children.forEach(function(e){n.rebuildNode(e,t+"   ")})}},{key:"swapScene",value:function(e){var t=this;this.currentScene=e,console.log("swapping to the scene",e),Object.keys(this.sceneWrappers).forEach(function(n){var r=t.sceneWrappers[n];r.visible=n===e,t.controls&&r.remove(t.controls)}),this.controls&&this.sceneWrappers[e].add(this.controls),this.sceneWrappers[e].position.x=0,this.sceneWrappers[e].position.z=0}},{key:"loadScene",value:function(){}},{key:"insertNodeMapping",value:function(e,t){if("string"!==typeof e)throw new Error("cannot map an object to an object. invalid call in insertNodeMapping");this.obj_node_map[e]=t,t.previewUpdate&&this.previewUpdateNodes.push(t),t.userData.graphid=e}},{key:"findNode",value:function(e){return this.obj_node_map[e]||console.warn("could not find node for id",e),this.obj_node_map[e]}}]),t}(r.Component),zr=function(e){function t(){var e,n;Object(s.a)(this,t);for(var r=arguments.length,i=new Array(r),a=0;a<r;a++)i[a]=arguments[a];return(n=Object(u.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(i)))).cancel=function(){p.b.hide()},n.okay=function(){p.b.hide(),re(n.fileinput.files).forEach(function(e){console.log("got the file",e)})},n.selectedFile=function(e){console.log("selected a file",e.target)},n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){var e=this;return i.a.createElement(Ie,{visible:!0,onScrimClick:this.cancel},i.a.createElement(p.f,null,i.a.createElement("h3",null,"add GLTF file assets"),i.a.createElement("p",null,"chose ",i.a.createElement("b",null,"the directory")," containing the GLTF file"),i.a.createElement("input",{type:"file",ref:function(t){return e.fileinput=t},onChange:this.selectedFile,multiple:!0,webkitdirectory:"true"}),i.a.createElement(p.c,null,i.a.createElement("button",{onClick:this.cancel},"cancel"),i.a.createElement("button",{onClick:this.okay},"okay"))))}}]),t}(r.Component),Hr=function(e){function t(){var e,n;Object(s.a)(this,t);for(var r=arguments.length,i=new Array(r),a=0;a<r;a++)i[a]=arguments[a];return(n=Object(u.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(i)))).cancel=function(){p.b.hide()},n.okay=function(){p.b.hide(),re(n.fileinput.files).forEach(function(e){wn(e,n.props.provider)})},n.selectedFile=function(e){console.log("selected a file",e.target)},n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){var e=this;return i.a.createElement(Ie,{visible:!0,onScrimClick:this.cancel},i.a.createElement(p.f,null,i.a.createElement("h3",null,"add GLB to assets"),i.a.createElement("p",null,"choose a GLB file"),i.a.createElement("input",{type:"file",ref:function(t){return e.fileinput=t},onChange:this.selectedFile,multiple:!0}),i.a.createElement(p.c,null,i.a.createElement("button",{onClick:this.cancel},"cancel"),i.a.createElement("button",{onClick:this.okay},"okay"))))}}]),t}(r.Component),Vr=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this,e))).cancel=function(){p.b.hide()},n.okay=function(){p.b.hide(),"remote"===n.state.view?(console.log("adding the url",n.state.url),On(null,n.state.url,n.props.provider)):(console.log("the file input is",n.fileInput),re(n.fileInput.current.files).forEach(function(e){!function(e,t){I.add("uploading"),t.uploadFile(e).then(function(n){if(I.add("uploaded"),console.log("uploaded file with answer",n),!1===n.success)return console.log("there was an error uploading! :(");var r=z()+n.asset.id,i=t.getDataGraph(),a=ae(i,i.createObject({type:Jt.ASSET,subtype:on.AUDIO,format:n.asset.mimeType,src:r,title:e.name,parent:0}));t.accessObject(t.getAssetsObject()).insertChildLast(a)})}(e,n.props.provider)}))},n.switchLocal=function(){return n.setState({view:"local"})},n.switchRemote=function(){return n.setState({view:"remote"})},n.selectedFile=function(e){n.setState({fileInput:e.target.value})},n.typedURL=function(e){n.setState({url:e.target.value})},n.state={view:"local",url:""},n.fileInput=i.a.createRef(),n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){return i.a.createElement(Ie,{visible:!0,onScrimClick:this.cancel},i.a.createElement(p.f,{grow:!0},i.a.createElement("h3",null,"add audio to assets"),i.a.createElement(p.f,{grow:!0},i.a.createElement(S,null,i.a.createElement(C,{onClick:this.switchLocal,selected:"local"===this.state.view},"local"),i.a.createElement(C,{onClick:this.switchRemote,selected:"remote"===this.state.view},"remote")),this.renderSelectedPanel()),i.a.createElement(p.c,null,i.a.createElement("button",{onClick:this.cancel},"cancel"),i.a.createElement("button",{onClick:this.okay},"okay"))))}},{key:"renderSelectedPanel",value:function(){return"local"===this.state.view?i.a.createElement(p.c,null,i.a.createElement("label",null,"File",i.a.createElement("input",{key:"f1",type:"file",onChange:this.selectedFile,ref:this.fileInput}))):i.a.createElement(p.c,null,i.a.createElement("label",null,"URL",i.a.createElement("input",{key:"f2",value:this.state.url,type:"input",onChange:this.typedURL})))}}]),t}(r.Component),Wr=function(e){function t(){var e,n;Object(s.a)(this,t);for(var r=arguments.length,i=new Array(r),a=0;a<r;a++)i[a]=arguments[a];return(n=Object(u.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(i)))).cancel=function(){p.b.hide()},n.okay=function(){p.b.hide(),n.props.onAnyway()},n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){return i.a.createElement(Ie,{visible:!0,onScrimClick:this.cancel,width:"600px",height:"auto"},i.a.createElement(p.f,{grow:!0},i.a.createElement("h3",null,"Warning. Your document has unsaved changes."),i.a.createElement("p",null,"Press cancel to go back"),i.a.createElement("p",null,"Press continue to continue anyway and lose the unsaved changes"),i.a.createElement(p.c,null,i.a.createElement("button",{onClick:this.cancel},"cancel"),i.a.createElement("button",{onClick:this.okay},"continue!"))))}}]),t}(r.Component),Kr=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this,e))).refreshList=function(){n.props.provider.loadDocList().then(function(e){return n.setState({docList:e})})},n.dismiss=function(){p.b.hide()},n.state={docList:[]},n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){this.refreshList()}},{key:"generateDocUrl",value:function(e){var t=Object.assign({},this.props.provider.options,{mode:"edit",switcher:!1,doc:e.id});return"./?".concat(O(t))}},{key:"deleteDoc",value:function(e){var t=this;return this.props.provider.removeDoc(e).then(function(e){console.log("removed?",e),t.refreshList()})}},{key:"render",value:function(){var e=this;return i.a.createElement(Ie,{visible:!0,onScrimClick:this.dismiss},i.a.createElement("h3",null,"Open document"),i.a.createElement(p.f,{scroll:!0,style:{flex:1}},i.a.createElement("ul",null,this.state.docList.map(function(t,n){return i.a.createElement("li",{key:n},i.a.createElement("b",null,t.title),i.a.createElement("a",{className:"button",href:e.generateDocUrl(t)},"open"),e.renderDeleteButton(t))}))),i.a.createElement(p.c,{className:"footer"},i.a.createElement("button",{onClick:this.dismiss},"dismiss")))}},{key:"renderDeleteButton",value:function(e){var t=this;return G.supportsDocDelete()?i.a.createElement("button",{onClick:function(){return t.deleteDoc(e)}},"delete"):""}}]),t}(r.Component),Yr=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this,e))).refreshList=function(){n.props.provider.loadAssetList().then(function(e){n.props.filter&&(e=e.filter(n.props.filter)),n.setState({assetList:e})})},n.okay=function(){p.b.hide()},n.state={assetList:[]},n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){this.refreshList()}},{key:"addAsset",value:function(e){return p.b.hide(),sn(e.mimeType)?gn(e.id,e.url,e.mimeType,e.title,this.props.provider):!(t=e.mimeType)||t.toLowerCase()!==an.MP3&&t.toLowerCase()!==an.AAC&&t.toLowerCase()!==an.WAV?function(e){return!!e&&e.toLowerCase()===an.MP4}(e.mimeType)?function(e,t,n,r,i){r||(r=t.substring(t.lastIndexOf("/")+1)),G.supportsAssetUpload()||(e=r);var a=i.accessObject(i.getDataGraph().createObject({type:Jt.ASSET,subtype:on.VIDEO,assetId:e,format:n,src:t,title:r,parent:0}));i.accessObject(i.getAssetsObject()).insertChildLast(a)}(e.id,e.url,e.mimeType,e.title,this.props.provider):function(e){return!!e&&e.toLowerCase()===an.GLB}(e.mimeType)?function(e,t,n,r,i){r||(r=t.substring(t.lastIndexOf("/")+1)),G.supportsAssetUpload()||(e=r);var a=i.accessObject(i.getDataGraph().createObject({type:Jt.ASSET,subtype:on.GLTF,assetId:e,format:n,src:t,title:r,parent:0}));i.accessObject(i.getAssetsObject()).insertChildLast(a)}(e.id,e.url,e.mimeType,e.title,this.props.provider):void console.log("can't add this type",e.mimeType):On(e.id,e.url,e.mimeType,e.title,this.props.provider);var t}},{key:"deleteAsset",value:function(e){var t=this;return this.props.provider.removeAssetSource(e).then(function(e){console.log("removed?",e),t.refreshList()})}},{key:"render",value:function(){var e=this;return i.a.createElement(Ie,{visible:!0,onScrimClick:this.okay},i.a.createElement("h3",null,"Add Asset"),i.a.createElement(p.f,{scroll:!0,grow:!0},i.a.createElement("ul",null,this.state.assetList.map(function(t,n){return i.a.createElement("li",{key:n},i.a.createElement("b",null,t.title," "),i.a.createElement("i",null," ",t.mimeType),i.a.createElement("button",{onClick:function(){return e.addAsset(t)}},"add"),e.renderDeleteButton(t))}))),i.a.createElement(p.c,{className:"footer"},i.a.createElement("button",{onClick:this.okay},"close")))}},{key:"renderDeleteButton",value:function(e){var t=this;return G.supportsAssetUpload()?i.a.createElement("button",{onClick:function(){return t.deleteAsset(e)}},"delete"):""}}]),t}(r.Component),Xr=n(43),Zr=n.n(Xr),Qr=(n(73),n(75),function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this,e))).swap=function(){var e=n.props.provider.accessObject(R.getSelection());e.exists()&&e.type===Jt.BEHAVIOR_SCRIPT&&n.refresh()},n.changeText=function(e){return n.setState({text:e})},n.save=function(e){n.props.provider.updateBehaviorAssetContents(n.state.id,n.state.text)},n.refresh=function(){var e=R.getSelection(),t=n.props.provider.accessObject(e);console.log("id",e,t.exists(),t.type),t.exists()&&t.type===Jt.BEHAVIOR_SCRIPT&&n.props.provider.fetchBehaviorAssetContents(e).then(function(t){n.setState({id:e,text:t})})},n.state={id:null,text:"empty"},n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){this.refresh(),this.props.provider.on(B.PROPERTY_CHANGED,this.refresh),R.on(j,this.swap)}},{key:"componentWillUnmount",value:function(){this.props.provider.off(B.PROPERTY_CHANGED,this.refresh),R.off(j,this.swap)}},{key:"render",value:function(){return null===this.state.id?i.a.createElement("div",null,"loading"):i.a.createElement(Zr.a,{mode:"javascript",theme:"github",name:"script-editor",value:this.state.text,onChange:this.changeText,onBlur:this.save,showGutter:!0,width:"100%",height:"100%"})}}]),t}(r.Component)),qr=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this,e))).refreshList=function(){n.props.provider.loadScriptList().then(function(e){return n.setState({scripts:e})})},n.okay=function(){return p.b.hide()},n.state={scripts:[]},n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){this.refreshList()}},{key:"addScript",value:function(e){p.b.hide(),console.log("URL is",e.url),e.url=e.name,console.log("Now URL is",e.url);var t=this.props.provider.addBehaviorAssetFromURL(e);this.props.onAdd&&this.props.onAdd(t)}},{key:"deleteScript",value:function(e){var t=this;return this.props.provider.removeBehaviorAssetSource(e.name).then(function(){return t.refreshList()})}},{key:"render",value:function(){var e=this;return i.a.createElement(Ie,{visible:!0,onScrimClick:this.okay},i.a.createElement("h3",null,"Choose Behavior Script"),i.a.createElement(p.f,{scroll:!0},i.a.createElement("ul",{className:"behaviors-list"},this.state.scripts.map(function(t,n){return i.a.createElement(p.c,{key:t.name},i.a.createElement(p.f,null,i.a.createElement("div",null,i.a.createElement("i",null,t.name)," -  ",i.a.createElement("b",null,t.title)),i.a.createElement("p",null,t.description)),i.a.createElement(x,null),i.a.createElement("button",{onClick:function(){return e.addScript(t)}},"add"),e.renderDeleteButton(t))}))),i.a.createElement(p.c,{className:"footer"},i.a.createElement("button",{onClick:this.okay},"close")))}},{key:"renderDeleteButton",value:function(e){var t=this;return G.supportsScriptEdit()?i.a.createElement("button",{onClick:function(){return t.deleteScript(e)}},"delete"):""}}]),t}(r.Component),Jr="\n/*\n #title untitled behavior\n #description does something\n*/\n({\n  // defines a target property. must be a scene\n    properties: {\n        scene: { \n            type:'enum', \n            title: 'target scene', \n            value:null, \n            hints: {\n                type:'node',\n                nodeType:'scene'\n            }\n        },\n    },\n    start: function(evt) {\n        //called when the program starts\n    },\n    click: function(evt) {\n        //called when object is clicked on\n        //this.navigateScene(this.properties.scene)\n    }\n})\n",$r="\n/*\n #title scene script\n #description does something\n*/\n({\n    // defines a target property. must be a scene\n    properties: {\n        scene: { \n            type:'enum', \n            title: 'target scene', \n            value:null, \n            hints: {\n                type:'node',\n                nodeType:'scene'\n            }\n        },\n    },\n    start: function(evt) {\n        //called when the program starts\n    },\n    enter: function(evt) {\n        //called when entering a scene\n    },\n    tick: function(evt) {\n        //called on every frame\n    },\n    exit: function(evt) {\n        //called when exiting a scene\n    },\n    stop: function(evt) {\n        //called when the program stops\n    },\n})\n",_r=n(44),ei=n.n(_r),ti=function(e){function t(){return Object(s.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){this.canvas&&this.redraw()}},{key:"componentWillReceiveProps",value:function(e){this.canvas&&this.redraw()}},{key:"redraw",value:function(){ei.a.toCanvas(this.canvas,this.props.url,{width:this.props.width,height:this.props.height})}},{key:"render",value:function(){var e=this,t={};return this.props.style&&Object.assign(t,this.props.style),i.a.createElement("canvas",{width:this.props.width,height:this.props.height,ref:function(t){return e.canvas=t},style:t})}}]),t}(r.Component),ni=function(e){function t(){var e,n;Object(s.a)(this,t);for(var r=arguments.length,i=new Array(r),a=0;a<r;a++)i[a]=arguments[a];return(n=Object(u.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(i)))).okay=function(){p.b.hide()},n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){var e=null;this.props.url&&(e=this.props.url);var t=e.replace("https","wxrv");return t=t.replace("http","wxrv"),i.a.createElement(Ie,{visible:!0,onScrimClick:this.okay},i.a.createElement(p.f,{grow:!0},i.a.createElement("h3",null,this.props.text?this.props.text:"Scan"),i.a.createElement(p.f,{grow:!0},i.a.createElement("label",null,i.a.createElement("a",{href:e},e)),i.a.createElement(ti,{url:t,width:160,height:160})),i.a.createElement(p.c,null,i.a.createElement("button",{onClick:this.okay},"dismiss"))))}}]),t}(r.Component),ri=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this,e))).cancel=function(){p.b.hide()},n.okay=function(){p.b.hide(),G.doPasswordLogin(n.state.field)},n.keyDown=function(e){"Enter"===e.key&&n.okay()},n.state={field:""},n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){var e=this;return i.a.createElement(Ie,{visible:!0,onScrimClick:this.cancel,width:"600px",height:"auto"},i.a.createElement(p.f,{grow:!0},i.a.createElement("h3",null,"login with the password from your env file"),i.a.createElement("label",null,"password"),i.a.createElement("input",{type:"password",value:this.state.field,onKeyDown:this.keyDown,onChange:function(t){e.setState({field:t.target.value})}}),i.a.createElement(p.c,null,i.a.createElement(x,null),i.a.createElement("button",{onClick:this.cancel},"cancel"),i.a.createElement("button",{onClick:this.okay},"okay"))))}}]),t}(r.Component),ii=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this,e))).cancel=function(){p.b.hide()},n.okay=function(){p.b.hide(),console.log("opening window with the data",n.state.data),G.login(n.state.data)},n.state={data:null},n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){var e=this;console.log("opening dialog"),G.getJSON(F.BASE+"auth/github/login").then(function(t){console.log("got the data",t),e.setState({data:t})})}},{key:"render",value:function(){return i.a.createElement(Ie,{visible:!0,onScrimClick:this.cancel},i.a.createElement(p.f,{grow:!0},i.a.createElement("h3",null,"Github Auth"),i.a.createElement("p",null,"To log into MrEd you need a github account. Press the button below to log into github and approve MrEd's access. The app will only use Github for authentication. It does not have access to any of your projects or code."),i.a.createElement("button",{onClick:this.okay},"Open Github"),i.a.createElement(p.c,null,i.a.createElement("button",{onClick:this.cancel},"cancel"))))}}]),t}(r.Component),ai=function(e){function t(e,n){var r;return Object(s.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e,n))).state={error:!1},r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"componentDidCatch",value:function(e,t){this.setState({error:!0});var n=this.props.logger;n?(n.error("an error occurred at the react level"),n.error(e),n.error(t)):console.log("NO LOGGER!")}},{key:"render",value:function(){return!0===this.state.error?i.a.createElement("div",null,i.a.createElement("h1",null,"An error happened. Please look at the console")):this.props.children}}]),t}(r.Component),oi=function(){function e(t){Object(s.a)(this,e),this.provider=t,this.assets_url_map={},this.videocache={},this.audiocache={}}return Object(c.a)(e,[{key:"cacheAssetsList",value:function(){var e=this;return G.getJSON("".concat(z(),"list")).then(function(t){t&&t.forEach&&(G.supportsAssetUpload()?t.forEach(function(t){e.assets_url_map[t.id]=z()+t.id}):(t.forEach(function(t){e.assets_url_map[t.title]=t.url}),console.log("cached the assets",e.assets_url_map)))})}},{key:"getAssetURL",value:function(e){return G.supportsAssetUpload()&&!G.isLoggedIn()?z()+e.assetId:e.assetId?this.assets_url_map[e.assetId]:e.src}},{key:"playMediaAsset",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=this.provider.getLogger();if(e.subtype===on.AUDIO){n.log("playing the audio asset",e);var r=this.getAssetURL(e);if(n.log("playing the audio from the url",r),this.audiocache[e.id]){var i=this.audiocache[e.id];i.isPlaying&&i.stop(),i.play()}else{var a=new dt.Audio(this.provider.getAudioListener());(new dt.AudioLoader).load(r,function(e){a.setBuffer(e),a.setLoop(!1),a.setVolume(.5),a.play()}),this.audiocache[e.id]=a}}if(e.subtype===on.VIDEO){n.log("playing the media asset",e);var o=this.getAssetURL(e);n.log("playing the url yaeah",o);var s=this.videocache[o];s&&(t&&(s.muted=!1),s.play())}}},{key:"stopMediaAsset",value:function(e){e.subtype===on.AUDIO&&this.audiocache[e.id]&&(this.audiocache[e.id].stop(),delete this.audiocache[e.id],this.audiocache[e.id]=null),e.subtype===on.VIDEO&&this.videocache[e.id]&&(this.videocache[e.id].stop(),delete this.videocache[e.id],this.videocache[e.id]=null)}},{key:"stopAllMedia",value:function(){var e=this,t=this.videocache;Object.keys(t).forEach(function(e){var n=t[e];n.pause&&n.pause()}),Object.keys(this.audiocache).forEach(function(t){e.audiocache[t].stop&&e.audiocache[t].stop()})}},{key:"getTexture",value:function(e){var t=this.provider.accessObject(e);if(!t.exists())return null;var n,r=this.getAssetURL(t);if(r)return this.provider.getLogger().log("loading asset url",r),t.subtype===on.IMAGE?(new dt.TextureLoader).load(r):t.subtype===on.VIDEO?(this.videocache[r]?n=this.videocache[r]:((n=document.createElement("video")).crossOrigin="anonymous",n.muted=!0,n.loop=!0,n.setAttribute("playsinline",""),n.src=r,this.videocache[r]=n),new dt.VideoTexture(n)):null;this.provider.getLogger().error("==== null url from asset",t)}}]),e}(),si=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this,e))).getApp=function(){return"edit"===n.mode?i.a.createElement(ci,{provider:Object(f.a)(Object(f.a)(n))}):"vredit"===n.mode?i.a.createElement(Ur,{provider:Object(f.a)(Object(f.a)(n)),editable:!0}):"embed-view"===n.mode?i.a.createElement(Ur,{provider:Object(f.a)(Object(f.a)(n)),editable:!1}):"vrview"===n.mode?i.a.createElement(Ur,{provider:Object(f.a)(Object(f.a)(n)),editable:!1}):void console.log("no mode!")},n.getTitle=function(){return"MrEd"},n.getDocTitle=function(){return n.accessObject(n.getSceneRoot()).title},n.setDocTitle=function(e){return n.accessObject(n.getSceneRoot()).set("title",e)},n.getLogger=function(){return n.pubnub?n.pubnub.getLogger():new Te},n.docLoaded=function(){return n.accessObject(n.getBehaviorsObject()).getChildren().filter(function(e){return e.type===Jt.BEHAVIOR_SCRIPT}).forEach(function(e){n.fetchBehaviorAssetContents(e.id).then(function(t){try{var r=un(t);r.text=t,n.setCachedBehaviorAsset(e.id,r)}catch(i){console.error(i)}})}),n.assetsManager.cacheAssetsList()},n.getRendererForItem=function(e){var t=n.accessObject(e);return t.exists()?t.type===Jt.ASSET?i.a.createElement("div",null,i.a.createElement("i",{className:"fa fa-".concat(cn[t.subtype])})," ",t.title):cn[t.type]?i.a.createElement("div",null,i.a.createElement("i",{className:"fa fa-".concat(cn[t.type])})," ",t.title):i.a.createElement("div",null,t.title):i.a.createElement("div",null,"???")},n.getAssetsObject=function(){return n.getDataGraph().getObjectByProperty("type",Jt.ASSETS_LIST)},n.getBehaviorsObject=function(){return n.getDataGraph().getObjectByProperty("type",Jt.BEHAVIORS_LIST)},n.editIn2D=function(){n.save().then(function(){var e=Object.assign({},n.options,{mode:"edit",switcher:!1,doc:n.getDocId()}),t=document.location,r="".concat(t.protocol,"//").concat(t.host).concat(t.pathname,"?").concat(O(e));p.b.show(i.a.createElement(ni,{text:"Edit in 2D",url:r}))})},n.editInVR=function(){n.save().then(function(){var e=Object.assign({},n.options,{mode:"vredit",switcher:!1,doc:n.getDocId()}),t=document.location,r="".concat(t.protocol,"//").concat(t.host).concat(t.pathname,"?").concat(O(e));p.b.show(i.a.createElement(ni,{text:"Edit in AR/VR",url:r}))})},n.viewInVR=function(){n.save().then(function(){var e=Object.assign({},n.options,{mode:"play",switcher:!1,doc:n.getDocId()}),t=document.location,r="".concat(t.protocol,"//").concat(t.host).concat(t.pathname,"?").concat(O(e));p.b.show(i.a.createElement(ni,{text:"View in AR/VR",url:r}))})},n.add3DObject=function(e,t){var r=nn(e).make(n.getDataGraph(),t);t.insertFirstChild(r),R.setSelection(r.id),I.add("added "+e)},n.cutSelection=function(e){if(e&&e.target){if("input"===e.target.getAttribute("type"))return;if("INPUT"===e.target.nodeName)return;if("TEXTAREA"===e.target.nodeName)return}if(!R.isEmpty()){var t=n.accessObject(R.getSelection());R.setClipboard(t.id),t.removeFromParent(),R.clearSelection()}},n.copySelection=function(e){if(e&&e.target){if("input"===e.target.getAttribute("type"))return;if("INPUT"===e.target.nodeName)return;if("TEXTAREA"===e.target.nodeName)return}if(!R.isEmpty()){var t=n.accessObject(R.getSelection());R.setClipboard(t.id)}},n.pasteSelection=function(e){if(e&&e.target){if("input"===e.target.getAttribute("type"))return;if("INPUT"===e.target.nodeName)return;if("TEXTAREA"===e.target.nodeName)return}var t=n.accessObject(R.getClipboard()),r=null;if(_t(t.type)&&(r=n.getSelectedSceneObject()),"scene"===t.type&&(r=n.accessObject(n.getSceneRoot())),!r)return console.error("no parent to ad too! bad obj type?",t.type);r.insertChildLast(t.clone())},n.setColor=function(e){R.isEmpty()||n.accessObject(R.getSelection()).set("color",e)},n.showAddImageAssetDialog=function(){return p.b.show(i.a.createElement(kn,{provider:Object(f.a)(Object(f.a)(n))}))},n.showAddAudioAssetDialog=function(){return p.b.show(i.a.createElement(Vr,{provider:Object(f.a)(Object(f.a)(n))}))},n.showAddGLTFAssetDialog=function(){return p.b.show(i.a.createElement(zr,{provider:Object(f.a)(Object(f.a)(n))}))},n.showAddGLBAssetDialog=function(){return p.b.show(i.a.createElement(Hr,{provider:Object(f.a)(Object(f.a)(n))}))},n.showOpenDocumentDialog=function(){return p.b.show(i.a.createElement(Kr,{provider:Object(f.a)(Object(f.a)(n))}))},n.showOpenAssetDialog=function(){return p.b.show(i.a.createElement(Yr,{provider:Object(f.a)(Object(f.a)(n))}))},n.showAddServerImageDialog=function(){return p.b.show(i.a.createElement(Yr,{provider:Object(f.a)(Object(f.a)(n)),filter:function(e){return sn(e.mimeType)}}))},n.showOpenBehaviorDialog=function(){return p.b.show(i.a.createElement(qr,{provider:Object(f.a)(Object(f.a)(n))}))},n.showAddGeoLocationAssetDialog=function(){var e,t,r,i;e={latitude:0,longitude:0,altitude:0,useAltitude:!1},t="new geo location",r=Object(f.a)(Object(f.a)(n)),i=r.accessObject(r.getDataGraph().createObject({type:Jt.ASSET,subtype:on.GEOLOCATION,title:t,latitude:e.latitude,longitude:e.longitude,altitude:e.altitude,useAltitude:e.useAltitude,parent:0})),r.accessObject(r.getAssetsObject()).insertChildLast(i)},n.showPasswordDialog=function(){return p.b.show(i.a.createElement(ri,{provider:Object(f.a)(Object(f.a)(n))}))},n.showGithubDialog=function(){return p.b.show(i.a.createElement(ii,{provider:Object(f.a)(Object(f.a)(n))}))},n.accessObject=function(e){return new Cn(n.getDataGraph()).object(e)},n.addBehaviorAssetFromURL=function(e){var t=n.getDataGraph(),r=ae(t,t.createObject({type:Jt.BEHAVIOR_SCRIPT,title:e.title,description:e.description,src:e.url,parent:0}));return n.accessObject(n.getBehaviorsObject()).insertChildLast(r),R.setSelection(r.id),r},n.addCustomBehaviorAsset=function(e){var t=Math.floor(1e8*Math.random()),r="behavior_".concat(t,".js"),i="".concat(H()).concat(r),a=e||Jr;return console.log("posting it to",i),G.fetch(i,{method:"POST",body:a}).then(function(e){return e.json()}).then(function(e){console.log("got back the answer",e);var t=n.getDataGraph(),r=ae(t,t.createObject({type:Jt.BEHAVIOR_SCRIPT,title:e.script.title,description:e.script.description,src:i,parent:0}));return n.accessObject(n.getBehaviorsObject()).insertChildLast(r),R.setSelection(r.id),r}).catch(function(e){return console.error(e)})},n.addSceneScript=function(e){n.addCustomBehaviorAsset($r).then(function(t){return n.addBehaviorToObject(t,e)})},n.addBehaviorToObject=function(e,t){return n.fetchBehaviorAssetContents(e.id).then(function(r){try{var i={type:Jt.BEHAVIOR,title:e.title,description:e.description,parent:0,behavior:e.id},a=un(r);n.setCachedBehaviorAsset(e.id,a),a.properties&&Object.keys(a.properties).forEach(function(e){i[e]=a.properties[e].value});var o=n.getDataGraph(),s=ae(o,o.createObject(i));return n.accessObject(t).insertChildLast(s),s}catch(c){console.error(c)}})},n.imagecache={},n.behaviorCache={},n.orbit_state={},n.assetsManager=new oi(Object(f.a)(Object(f.a)(n))),n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"getDocType",value:function(){return"vr"}},{key:"makeEmptyRoot",value:function(e){var t=ae(e,e.createObject({type:Jt.ROOT,title:"Untitled Project",splashImage:Yt.id,defaultScene:Yt.id,children:e.createArray()})),n=new Cn(e).object(t.id),r=(new Gn).make(e,n),i=(new mt).make(e,r),a=ae(e,e.createObject({type:Jt.ASSETS_LIST,title:"Assets",children:e.createArray(),parent:0})),o=ae(e,e.createObject({type:Jt.BEHAVIORS_LIST,title:"Behaviors",children:e.createArray(),parent:0}));se(e,t,r),se(e,r,i),ce(e,t,o),ce(e,t,a)}},{key:"getProperties",value:function(e){var t=this;var n=[];if(!e)return n;n.push({key:"id",name:"ID",type:$.STRING,value:e,locked:!0});var r=this.accessObject(e);if(r.type===Jt.BEHAVIOR){var i=this.getCachedBehaviorPropDefs(r.behavior);i?Object.keys(i).forEach(function(e){var t=i[e],a={key:e,name:e,type:t.type,value:r[e]};t.hints&&(a.hints=t.hints),n.push(a)}):console.warn("Missing prop defs for behavior object"),n.push({key:"behavior",name:"Script",type:$.STRING,value:r.behavior,locked:!0,custom:!0})}var a=this.syncdoc.getPropertiesForObject(e);return a&&a.forEach(function(i){if("type"!==i&&"children"!==i&&"parent"!==i){var a=t.syncdoc.getPropertyValue(e,i);if(Zt[i]){var o=function(e,t){var n={};return Object.keys(e).forEach(function(t){return n[t]=e[t]}),n.value=t,n}(Zt[i],a);return r.type===Jt.BEHAVIOR_SCRIPT&&("title"!==i&&"description"!==i||(o.locked=!0)),r.type===Jt.ASSET&&r.subtype===on.IMAGE&&("width"!==i&&"height"!==i||(o.locked=!0)),n.push(o)}}}),_t(r.type)&&(n.push({key:"scale",name:"Scale",type:$.GROUP,group:["sx","sy","sz"],custom:!0}),n.push({key:"translation",name:"Translation",type:$.GROUP,group:["tx","ty","tz"],custom:!0}),n.push({key:"rotation",name:"Rotation",type:$.GROUP,group:["rx","ry","rz"],custom:!0})),n}},{key:"setPropertyValue",value:function(e,n,r){var i=this;if("scale"!==n.key&&"translation"!==n.key&&"rotation"!==n.key){if(Object(d.a)(Object(l.a)(t.prototype),"setPropertyValue",this).call(this,e,n,r),n.key===Zt.asset.key){var a=this.accessObject(r);if(a.subtype===on.IMAGE){var o=a.height/a.width*this.accessObject(e).width;Object(d.a)(Object(l.a)(t.prototype),"setPropertyValue",this).call(this,e,{key:"height"},o)}a.subtype===on.GLTF&&console.log("adjusting to a gtlf")}}else n.group.forEach(function(n){return Object(d.a)(Object(l.a)(t.prototype),"setPropertyValue",i).call(i,e,{key:n},r[n])})}},{key:"getValuesForEnum",value:function(e,t,n){var r=this.accessObject(t);if(r.exists()&&r.type===Jt.BEHAVIOR&&n.hasHints()){var i=n.getHints();if("node"===i.type)return this.accessObject(this.getSceneRoot()).find(function(e){return e.type===i.nodeType}).map(function(e){return e.id});if("audio"===i.type)return this.accessObject(this.getAssetsObject()).getChildren().filter(function(e){return e.subtype===on.AUDIO}).map(function(e){return e.id});if("video"===i.type)return this.accessObject(this.getAssetsObject()).getChildren().filter(function(e){return e.subtype===on.VIDEO}).map(function(e){return e.id});if("media"===i.type)return this.accessObject(this.getAssetsObject()).getChildren().filter(function(e){return e.subtype===on.AUDIO||e.subtype===on.VIDEO}).map(function(e){return e.id})}if(e===Zt.asset.key){var a=this.accessObject(this.getAssetsObject()).getChildren();if(hi(r.type)&&pi(r.type))return fi(a.filter(function(e){return e.subtype===on.VIDEO||e.subtype===on.IMAGE}).map(function(e){return e.id}));if(pi(r.type))return fi(a.filter(function(e){return e.subtype===on.VIDEO}).map(function(e){return e.id}));if(r.type===qt.model)return fi(a.filter(function(e){return e.subtype===on.GLTF}).map(function(e){return e.id}));if(hi(r.type))return fi(a.filter(function(e){return e.subtype===on.IMAGE}).map(function(e){return e.id}))}if(e===Zt.horizontalAlign.key)return Object.keys($t).map(function(e){return $t[e]});if(e===Zt.defaultScene.key)return fi(this.accessObject(this.getSceneRoot()).getChildren().filter(function(e){return e.type===Jt.SCENE}).map(function(e){return e.id}));if(e===Zt.texture.key){var o=this.accessObject(this.getAssetsObject()).getChildren();return fi(o=o.filter(function(e){return e.subtype===on.IMAGE}).map(function(e){return e.id}))}if(e===Zt.targetImage.key){var s=this.accessObject(this.getAssetsObject()).getChildren();return s=s.filter(function(e){return e.subtype===on.IMAGE}).map(function(e){return e.id})}if(e===Zt.targetGeoLocation.key){var c=this.accessObject(this.getAssetsObject()).getChildren();return c=c.filter(function(e){return e.subtype===on.GEOLOCATION}).map(function(e){return e.id})}return e===Zt.recType.key?Object.keys(ln):e===Zt.splashImage.key?fi(this.accessObject(this.getAssetsObject()).getChildren().filter(function(e){return e.subtype===on.IMAGE}).map(function(e){return e.id})):void 0}},{key:"getRendererForEnum",value:function(e,t){var n=this.accessObject(t);if(n.exists()&&n.type===Jt.BEHAVIOR)return ui;switch(e){case Zt.asset.key:case Zt.defaultScene.key:case Zt.texture.key:case Zt.targetImage.key:case Zt.targetGeoLocation.key:case Zt.splashImage.key:return ui;default:return null}}},{key:"getSelectedSceneObject",value:function(){var e=R.getSelection();if(null===e)return this.getFirstSceneObject();var t=this.accessObject(e);return t.exists()?t.type===Jt.SCENE?t:_t(t.type)?this.findSceneObjectParent(t):t.type===Jt.BEHAVIOR?this.findSceneObjectParent(t):(this.getLogger().error("We shouldn't ever get here"),this.accessObject(0)):t}},{key:"getFirstSceneObject",value:function(){return this.accessObject(this.getSceneRoot()).getChildren()[0]}},{key:"findSceneObjectParent",value:function(e){return null===e?null:e.exists()?e.type===Jt.SCENE?e:(e=this.accessObject(e.parent),this.findSceneObjectParent(e)):null}},{key:"quick_setPropertyValue",value:function(e,t,n){var r=this.getDataGraph().getPropertyValue(e,t),i=this.cmd.setProperty(e,t,n);i.prevValue=r,i.value!==i.prevValue&&(this.getRawGraph().process(i),this.fire(B.PROPERTY_CHANGED,{provider:this,child:e,propKey:t,oldValue:r,newValue:n}))}},{key:"calculateContextMenu",value:function(e){var t=this,n=[],r=this.accessObject(e);return tn(r.type)&&n.push({title:"delete",icon:cn.delete,fun:function(){return Rr(t)}}),r.type===Jt.ASSETS_LIST?Lr(this):(r.type===Jt.BEHAVIORS_LIST&&n.push({title:"Add Behavior from Server",enabled:G.isLoggedIn(),icon:cn.behavior_script,fun:function(){return t.showOpenBehaviorDialog()}}),en(r.type)&&(n.push({divider:!0}),Object.keys(qt).forEach(function(e){return n.push({title:e,icon:cn[e],fun:function(){return t.add3DObject(e,r)}})})),r.type===Jt.ROOT&&n.push({title:"scene",icon:cn.scene,fun:function(){return Dr(t)}}),function(e){return!!_t(e)||e===Jt.SCENE}(r.type)&&(n.push({divider:!0}),this.accessObject(this.getBehaviorsObject()).getChildren().filter(function(e){return e.type===Jt.BEHAVIOR_SCRIPT}).forEach(function(r){n.push({title:r.title,icon:cn.behavior_script,fun:function(){return t.addBehaviorToObject(r,e)}})}),n.push({title:"Add Behavior from server",icon:cn.behavior_script,enabled:G.isLoggedIn(),fun:function(){p.b.show(i.a.createElement(qr,{provider:t,onAdd:function(n){t.addBehaviorToObject(n,e).then(function(e){R.setSelection(e.id)})}}))}})),r.type===Jt.SCENE&&(n.push({divider:!0}),G.scriptEditingSupported&&n.push({title:"Add Scene script",icon:cn.behavior,fun:function(){return t.addSceneScript(e)}})),r.type===Jt.BEHAVIOR&&(n.push({divider:!0}),n.push({title:"view code",icon:cn.behavior,fun:function(){return R.setSelection(r.behavior)}})),tn(r.type)&&(n.push({divider:!0}),n.push({title:"cut",icon:cn.cut,fun:this.cutSelection}),n.push({title:"copy",icon:cn.copy,fun:this.copySelection}),n.push({title:"paste",icon:cn.paste,fun:this.pasteSelection})),n)}},{key:"canBeMoved",value:function(e){var t=this.accessObject(e);return t.type!==Jt.ROOT&&(t.type!==Jt.BEHAVIORS_LIST&&t.type!==Jt.ASSETS_LIST)}},{key:"canAddChild",value:function(e,t){var n=this.accessObject(e),r=this.accessObject(t);return n.type===Jt.ROOT&&r.type===Jt.SCENE||(!(n.type!==Jt.SCENE||!_t(r.type))||(!(!_t(n.type)||r.type!==Jt.BEHAVIOR)||!(!en(n.type)||!_t(r.type))))}},{key:"canBeSibling",value:function(e,t){var n=this.accessObject(e),r=this.accessObject(t);return n.type===Jt.SCENE&&r.type===Jt.SCENE||!(!_t(n.type)||!_t(r.type))}},{key:"canAddExternalChild",value:function(e,t){return this.accessObject(e).type===Jt.ASSETS_LIST}},{key:"acceptDrop",value:function(e,t){var n=this;this.accessObject(t).type===Jt.ASSETS_LIST&&re(e.dataTransfer.files).forEach(function(e){return sn(e.type)?bn(e,n):function(e){if(!e)return!1;if(console.log("looking at the file",e,"type",e.type,"type"),!e.type||""===e.type||0===e.type.length){if(console.log("no mimetype. check extension"),e.name.toLowerCase().indexOf(".gltf")>0)return!0;if(e.name.toLowerCase().indexOf(".glb")>0)return!0}return"image/gltf"===e.type.toLowerCase()}(e)?wn(e,n):void 0})}},{key:"requestImageCache",value:function(e){var t=this,n=new Image;return this.imagecache[e]=n,new Promise(function(r,i){n.src=e,n.onload=function(){t.fire(B.STRUCTURE_CHANGED,{provider:t}),r(n)}})}},{key:"createCustomEditor",value:function(e,t,n,r,a){return t.key===Zt.color.key||t.key===Zt.backgroundColor.key||t.key===Zt.borderColor.key||t.key===Zt.textColor.key||t.key===Zt.startColor.key||t.key===Zt.endColor.key?i.a.createElement(vi,{def:t,item:e,onChange:a,value:r}):"scale"===t.key?i.a.createElement(li,{def:t,item:e,onChange:a,provider:this}):"translation"===t.key?i.a.createElement(li,{def:t,item:e,onChange:a,provider:this}):"rotation"===t.key?i.a.createElement(li,{def:t,item:e,onChange:a,provider:this}):"behavior"===t.key?i.a.createElement("button",{onClick:function(){return R.setSelection(r)}},"view code"):i.a.createElement("i",null,"no custom editor for ",t.key)}},{key:"loadDocList",value:function(){return G.getJSON("".concat(U(),"list"))}},{key:"removeDoc",value:function(e){return G.fetch("".concat(U(),"delete/").concat(e.id),{method:"POST",body:e.id}).then(function(e){return e.json()})}},{key:"loadAssetList",value:function(){return G.getJSON("".concat(z(),"list"))}},{key:"removeAssetSource",value:function(e){return G.fetch("".concat(z(),"delete/").concat(e.id),{method:"POST",body:e.id}).then(function(e){return e.json()})}},{key:"loadScriptList",value:function(){return G.getJSON("".concat(H(),"list"))}},{key:"removeBehaviorAssetSource",value:function(e){var t="".concat(H(),"delete/").concat(e);return console.log("removing",t),G.fetch(t,{method:"POST",body:e}).then(function(e){return e.json()})}},{key:"fetchBehaviorAssetContents",value:function(e){var t=this.accessObject(e),n=H()+t.src;return G.fetch(n,{method:"GET"}).then(function(e){return e.text()})}},{key:"updateBehaviorAssetContents",value:function(e,t){if(G.supportsScriptEdit())try{var n=un(t);n.text=t,this.setCachedBehaviorAsset(e,n);var r=this.accessObject(e),i=H()+r.src;return G.fetch(i,{method:"POST",body:t}).then(function(e){return e.json()}).then(function(e){r.set("title",e.script.title),r.set("description",e.script.description)})}catch(a){console.error("error parsing the script",a),I.add("error parsing")}}},{key:"getCachedBehaviorPropDefs",value:function(e){return this.behaviorCache[e]?this.behaviorCache[e].properties:(console.error("no parsed behavior in the cache",e),null)}},{key:"getCachedBehaviorAsset",value:function(e){return this.behaviorCache[e]}},{key:"setCachedBehaviorAsset",value:function(e,t){this.behaviorCache[e]=t}},{key:"setAudioListener",value:function(e){this.audioListener=e}},{key:"getAudioListener",value:function(){return this.audioListener}}]),t}(Ue),ci=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this,e))).selectionChanged=function(){if(!R.isEmpty()){var e=n.props.provider.accessObject(R.getSelection());if(e.type===Jt.BEHAVIOR_SCRIPT)return n.setState({mode:"script"});if(e.type===Zt.asset.key)return n.setState({mode:"asset"})}n.setState({mode:"canvas"})},n.toggleRunning=function(){n.setState({running:!n.state.running})},n.newDoc=function(){n.state.dirty?(console.log("can't create new becausue dirty"),p.b.show(i.a.createElement(Wr,{onAnyway:function(){console.log("we are doing it anyway"),Pr(n.props.provider)}}))):Pr(n.props.provider)},n.showOpenDocumentDialog=function(){n.state.dirty?p.b.show(i.a.createElement(Wr,{onAnyway:function(){console.log("we are doing it anyway"),n.props.provider.showOpenDocumentDialog()}})):n.props.provider.showOpenDocumentDialog()},n.state={mode:"canvas",user:null,running:!1,connected:!1,dirty:!0},n.im=new ze,n.im.addKeyBinding({id:"save",key:ze.KEYS.S,modifiers:[ze.MODIFIERS.COMMAND]}),n.im.addKeyBinding({id:"undo",key:ze.KEYS.Z,modifiers:[ze.MODIFIERS.COMMAND]}),n.im.addKeyBinding({id:"redo",key:ze.KEYS.Z,modifiers:[ze.MODIFIERS.COMMAND,ze.MODIFIERS.SHIFT]}),n.im.addListener("save",n.props.provider.save),n.im.addListener("undo",n.props.provider.performUndo),n.im.addListener("redo",n.props.provider.performRedo),n.im.addKeyBinding({id:"cut",key:ze.KEYS.X,modifiers:[ze.MODIFIERS.COMMAND]}),n.im.addKeyBinding({id:"copy",key:ze.KEYS.C,modifiers:[ze.MODIFIERS.COMMAND]}),n.im.addKeyBinding({id:"paste",key:ze.KEYS.V,modifiers:[ze.MODIFIERS.COMMAND]}),n.im.addListener("cut",n.props.provider.cutSelection),n.im.addListener("copy",n.props.provider.copySelection),n.im.addListener("paste",n.props.provider.pasteSelection),n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){var e=this;this.im.attachKeyEvents(document),R.on(j,this.selectionChanged),G.on(N,function(){return e.setState({user:G.getUsername()})}),G.on("CONNECTED",function(){return e.setState({connected:!0})}),G.isConnected()&&this.setState({connected:!0}),this.props.provider.on(B.CLEAR_DIRTY,function(){e.setState({dirty:!1})}),this.props.provider.on(B.PROPERTY_CHANGED,function(){e.setState({dirty:!0})}),this.props.provider.on(B.SAVED,function(){e.setState({dirty:!1})})}},{key:"componentWillUnmount",value:function(){R.off(j,this.selectionChanged)}},{key:"render",value:function(){if(!1===this.state.connected)return i.a.createElement("div",null,i.a.createElement("h1",null,"connecting to server"),i.a.createElement(p.a,null));var e=this.props.provider,t=i.a.createElement("div",null,"doc id: ",i.a.createElement("b",null,e.getDocId())),n=null;return e.pubnub&&(n=e.getLogger()),e.getDataGraph()?i.a.createElement(ai,{logger:n},i.a.createElement(E,{bottomText:t},i.a.createElement(S,{left:!0,top:!0},i.a.createElement("label",null,e.getTitle()," ",this.state.dirty?"dirty":"clean")),i.a.createElement(A,{scroll:!0,left:!0,middle:!0},i.a.createElement(pe,{root:e.getSceneRoot(),provider:e})),i.a.createElement(S,{left:!0,bottom:!0},i.a.createElement("button",{className:"fa fa-cube",onClick:function(t){return function(e,t){var n=t.getSelectedSceneObject(),r=Object.keys(qt).map(function(e){return{title:e,icon:cn[e],fun:function(){return t.add3DObject(e,n)}}});p.e.show(i.a.createElement(M,{actions:r}),e.target)}(t,e)}}),i.a.createElement("button",{className:"fa fa-globe",onClick:function(t){return Dr(e)}}),i.a.createElement("button",{className:"fa fa-archive",onClick:function(t){return function(e,t){var n=Lr(t);p.e.show(i.a.createElement(M,{actions:n}),e.target)}(t,e)}}),i.a.createElement("button",{className:"fa fa-superpowers",onClick:function(t){return function(e,t){var n=[{title:"Add Behavior from Server",enabled:G.isLoggedIn(),icon:cn.behavior_script,fun:function(){return t.showOpenBehaviorDialog()}}];G.supportsScriptEdit()&&n.push({title:"custom behavior",enabled:G.isLoggedIn(),icon:cn.behavior_script,fun:function(){return t.addCustomBehaviorAsset()}}),p.e.show(i.a.createElement(M,{actions:n}),e.target)}(t,e)}})),i.a.createElement(S,{center:!0,top:!0},i.a.createElement("button",{className:"fa fa-file",onClick:this.newDoc,title:"new project"}),i.a.createElement("button",{className:"fa fa-save",onClick:function(){return e.save()},title:"save project"}),i.a.createElement("button",{className:"fa fa-clone",onClick:function(){return e.duplicateDocument()},title:"duplicate project"}),i.a.createElement("button",{onClick:function(){return e.editIn2D()}},"2D Edit"),i.a.createElement("button",{onClick:function(){return e.editInVR()}},"AR Edit"),i.a.createElement("button",{onClick:function(){return e.viewInVR()}},"XR View"),i.a.createElement(x,null),i.a.createElement(di,{onClick:this.toggleRunning,active:this.state.running}),i.a.createElement(x,null),i.a.createElement("button",{className:"fa fa-cut",onClick:e.cutSelection}),i.a.createElement("button",{className:"fa fa-copy",onClick:e.copySelection}),i.a.createElement("button",{className:"fa fa-paste",onClick:e.pasteSelection}),i.a.createElement("button",{className:"fa fa-undo",onClick:e.performUndo}),i.a.createElement("button",{className:"fa fa-repeat",onClick:e.performRedo})),i.a.createElement(A,{center:!0,middle:!0,scroll:!0,transparent:!0},this.renderCenterPane(this.state.mode)),i.a.createElement(A,{scroll:!0,right:!0},i.a.createElement(ee,{provider:e})),i.a.createElement(S,{right:!0,top:!0},this.renderLoginButton()),i.a.createElement(S,{right:!0,bottom:!0}),i.a.createElement(p.a,null),i.a.createElement(p.d,null))):i.a.createElement("div",null,i.a.createElement("h1",null,"connecting to server"),i.a.createElement(p.a,null))}},{key:"renderCenterPane",value:function(e){return"script"===e?i.a.createElement(Qr,{provider:this.props.provider}):"canvas"===e?i.a.createElement(vr,{provider:this.props.provider,running:this.state.running}):i.a.createElement(yn,{provider:this.props.provider,asset:R.getSelection()})}},{key:"renderLoginButton",value:function(){var e=this,t=[];return G.supportsAuth()&&(G.isLoggedIn()?t.push(i.a.createElement("button",{key:"logout",className:"fa fa-user",onClick:G.logout,title:"logout"},"logout")):t.push(i.a.createElement("button",{key:"login",className:"fa fa-user",onClick:function(){G.supportsPassword()?e.props.provider.showPasswordDialog():e.props.provider.showGithubDialog()},title:"login"}))),G.supportsDocList()&&t.push(i.a.createElement("button",{key:"open",className:"fa fa-folder-open",onClick:this.showOpenDocumentDialog,title:"open"})),t}}]),t}(r.Component),ui=function(e){var t="---";return e.value&&e.provider&&(t=e.provider.accessObject(e.value).title),e.value===Yt.id&&(t=Yt.title),i.a.createElement("b",null,t)},li=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this,e))).syncChanged=function(e){return n.setState({sync:!n.state.sync})},n.changed=function(e,t){var r=n.props.provider.accessObject(n.props.item),i=n.props.def.getGroupKeys(),a={};i.forEach(function(e){return a[e]=r[e]});var o=parseFloat(e.target.value);a[t]=o,n.state.sync&&i.forEach(function(e){return a[e]=o}),n.props.onChange(a)},n.state={sync:!1},n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){var e=this,t=this.props.provider.accessObject(this.props.item),n=this.props.def.getGroupKeys().map(function(n){return i.a.createElement("input",{key:n,type:"number",value:t[n],onChange:function(t){e.changed(t,n)},step:.1})});return i.a.createElement(p.c,{className:"scale-editor"},i.a.createElement("input",{type:"checkbox",checked:this.state.sync,onChange:this.syncChanged}),n)}}]),t}(r.Component);function hi(e){return e===qt.plane||e===qt.bg360||e===qt.img2d||e===qt.cube||e===qt.sphere}function pi(e){return e===qt.plane||e===qt.bg360||e===qt.img2d}var di=function(e){var t=e.active?"run-button active fa fa-stop":"run-button fa fa-play";return i.a.createElement("button",{onClick:e.onClick,className:t})};function fi(e){return e.push(Yt.id),e}var vi=function(e){function t(){var e,n;Object(s.a)(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=Object(u.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(a)))).showPopup=function(e){p.e.show(i.a.createElement(mi,{onChange:n.props.onChange,value:n.props.value}),e.target)},n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){return i.a.createElement("button",{style:{backgroundColor:this.props.value},onClick:this.showPopup},this.props.value)}}]),t}(r.Component),mi=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this,e))).onChange=function(e){n.setState({value:e.target.value});var t=e.target.value;t.indexOf("#")>=0&&7===t.length&&n.props.onChange(t)},n.done=function(){n.props.onChange(n.state.value),p.e.hide()},n.state={value:e.value},n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){var e=this;return i.a.createElement(p.f,{style:{width:"130px",height:"100px",backgroundColor:"white"}},i.a.createElement(p.c,null,Qt.map(function(t){return i.a.createElement("button",{key:t,onClick:function(){e.props.onChange(t)},style:{color:t,padding:"1px",margin:0,borderWidth:0},className:"fa fa-square"})})),i.a.createElement("input",{type:"text",value:this.state.value,onChange:this.onChange}),i.a.createElement("button",{onClick:this.done},"done"))}}]),t}(r.Component);function yi(e,t){e.find=function(t,n){return n||(n=[]),t(e)&&n.push(e),e.children&&e.children.forEach(function(e){e.find(t,n)}),n},e.exists=function(){return!0},e.getParent=function(){return t[e.parent]}}var gi=function(e){function t(e){var n;Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this,e))).clickedStart=function(){console.log("clicked. play the sample audio");var e=function(e){return document.querySelector(e)};e("#overlay").style.display="none",e("#test-audio").play();var t=n.canvas;cr.supportsARKit()?(n.xr=new cr,n.xr.getContext(t).then(function(e){n.initThreeJS(t,e),n.xr.setAnimationLoop(n.renderThreeWithCamera.bind(Object(f.a)(Object(f.a)(n)))),n.startScene()}).catch(function(e){console.error("Error",e)})):(n.initThreeJS(t,0),n.renderer.setAnimationLoop(n.renderThree.bind(Object(f.a)(Object(f.a)(n)))),n.startScene())},n.clickedCanvas=function(e){n.logger.log("clicked on the canvas"),n.canvas.focus();var t=n.canvas.getBoundingClientRect(),r={x:(e.clientX-t.left)/t.width*2-1,y:-(e.clientY-t.top)/t.height*2+1};n.raycaster.setFromCamera(r,n.camera);var i=n.three_map[n.current_scene.id],a=n.raycaster.intersectObjects(i.children,!0);if(a&&a.length>=1){var o=a.find(function(e){return e.distance>0});if(o){var s=function e(t){return t?t.userData.graphid?t:e(t.parent):null}(o.object),c=n.obj_map[s.userData.graphid];n.scriptManager.performClickAction(c,e)}}},n.renderThreeWithCamera=function(e,t,r,i,a){n.scene&&n.camera&&(n.camera.matrix.fromArray(r),n.camera.matrixWorldNeedsUpdate=!0,n.camera.updateMatrixWorld(),n.camera.projectionMatrix.fromArray(t),n.renderThree(i,a))},n.renderThree=function(e,t){n.tweenManager&&n.tweenManager.update(e),n.previewUpdateNodes.forEach(function(e){return e.previewUpdate()}),n.pointer&&n.pointer.tick(e),n.stats&&n.stats.update(e),n.controller&&n.controller.update(e);var r=null;n.xr&&(r=n.xr.session),n.scriptManager.tick(e,r),n.renderer.render(n.scene,n.camera)};var r=m({});if(!r.doc)throw new Error("doc not specified");return new K(e.options),n.obj_map={},n.three_map={},n.title_map={},n.previewUpdateNodes=[],n.current_scene=null,n.root=null,n.behavior_map={},n.behavior_assets={},n.assets_url_map={},n.pendingAssets=[],n.sceneAnchor=null,n.logger=new Le(r.doc),n.scriptManager=new zn(new bi(Object(f.a)(Object(f.a)(n))),n.logger),n.provider={accessObject:function(e){return n.obj_map[e]?n.obj_map[e]:{exists:function(){return!1}}},getLogger:function(){return n.logger},getAudioListener:function(){return n.audioListener}},n.assetsManager=new oi(n.provider),n.provider.assetsManager=n.assetsManager,n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){this.logger.log("mounted ImmersivePlayer")}},{key:"startScene",value:function(){var e=this,t=m({});this.assetsManager.cacheAssetsList().then(function(){G.getJSON(U()+t.doc).then(function(t){e.root=t.graph,e.logger.log("loaded payload",e.root),e.buildRoot(e.root),e.logger.log(e.root),Promise.all(e.pendingAssets).then(function(){if(e.logger.log("all assets loaded now. starting script manager"),e.scriptManager.startRunning(),e.root.defaultScene&&e.root.defaultScene!==Yt.id){var t=e.root.children.find(function(t){return t.id===e.root.defaultScene});if(!t)return e.logger.error("cannot find the default scene");e.setCurrentScene(t)}else{var n=e.root.children[0];e.setCurrentScene(n)}e.scriptManager.startFirstScene()})})})}},{key:"render",value:function(){var e=this;return i.a.createElement("div",null,i.a.createElement("audio",{id:"test-audio",src:"https://vr.josh.earth/assets/sounds/clang.mp3"}),i.a.createElement("div",{id:"overlay"},i.a.createElement("div",{id:"inner"},i.a.createElement("div",{id:"title"},"some title"),i.a.createElement("button",{onClick:this.clickedStart},"click to start"))),i.a.createElement(ai,{logger:this.logger},i.a.createElement("canvas",{ref:function(t){return e.canvas=t},width:600,height:400,onClick:this.clickedCanvas})))}},{key:"buildRoot",value:function(e){var t=this;e.children.forEach(function(e){if(e.type===Jt.ASSETS_LIST)return t.initAssets(e)}),e.children.forEach(function(e){return yi(e,t.obj_map),e.type===Jt.SCENE?t.initObject(e):e.type===Jt.BEHAVIORS_LIST?t.initBehaviors(e):void 0})}},{key:"initObject",value:function(e){var t=this;yi(e,this.obj_map),this.obj_map[e.id]=e,e.title&&(this.title_map[e.title]=e);var n=null;if(e.type===Jt.SCENE){var r=(new Gn).makeNode(e,this.provider);this.three_map[e.id]=r,r.userData.graphid=e.id,this.scenes.add(r),r.visible=!1,n=r}return e.props=function(){return e},_t(e.type)&&((n=nn(e.type).makeNode(e,this.provider)).previewUpdate&&this.previewUpdateNodes.push(n),this.three_map[e.id]=n,n.userData.graphid=e.id,y(n,"click",function(n){t.scriptManager.performClickAction(e,n)})),e.type===Jt.BEHAVIOR&&(this.behavior_map[e.id]=e),e.children&&e.children.forEach(function(e){var r=t.initObject(e);r&&n.add(r)}),n}},{key:"initThreeJS",value:function(e,t){var n=this;this.tweenManager=new er,this.scene=new dt.Scene,this.camera=new dt.PerspectiveCamera(70,window.innerWidth/window.innerHeight,.1,50),this.renderer=new dt.WebGLRenderer({antialias:!0,canvas:e,context:t}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.gammaOutput=!0,this.renderer.vr.enabled=!0,this.vrmanager=new mr.h(this.renderer),this.audioListener=new dt.AudioListener,this.camera.add(this.audioListener),this.xr||(this.scene.background=new dt.Color(0)),this.camera.matrixAutoUpdate=!1,this.scene.add(this.camera),window.addEventListener("resize",function(){var e=document.documentElement;n.camera.aspect=e.clientWidth/e.clientHeight,n.camera.updateProjectionMatrix(),n.renderer.setSize(e.clientWidth,e.clientHeight)},!1);var r=new dt.DirectionalLight(16777215,1);r.position.set(1,1,1).normalize(),this.scene.add(r),this.scene.add(new dt.AmbientLight(16777215,.2)),this.scenes=new dt.Group,this.scene.add(this.scenes),this.raycaster=new dt.Raycaster}},{key:"initAssets",value:function(e){var t=this;e.children.forEach(function(e){t.logger.log("loading asset",e),yi(e,t.obj_map),t.obj_map[e.id]=e,e.title&&(t.title_map[e.title]=e),t.assets_url_map[e.id]=e.url})}},{key:"initBehaviors",value:function(e){var t=this;e.children.forEach(function(e){if(yi(e,t.obj_map),t.obj_map[e.id]=e,e.type===Jt.BEHAVIOR_SCRIPT){var n=H()+e.src;t.logger.log("loading behavior",e,"from",n);var r=G.fetch(n,{method:"GET"}).then(function(e){return e.text()}).then(function(n){var r=un(n);return r.text=n,t.behavior_assets[e.id]=r,n}).catch(function(e){t.logger.error("error loading behavior",e)});t.pendingAssets.push(r)}})}},{key:"sleeper",value:function(e){return new Promise(function(t){return setTimeout(function(){return t()},e)})}},{key:"setCurrentScene",value:function(e){var t=this,n=this.three_map[e.id];if(n&&this.xr){var r=n.userData.sceneAnchor;r?(r.children?(this.logger.log("scene has children: ",n.children.length),this.logger.log("scene anchor has children: ",r.children.length)):this.logger.log("no sceneNode children?"),!this.sceneAnchor||this.sceneAnchor&&e.autoRecenter?(this.sceneAnchor&&(this.xr.removeSceneAnchor(this.sceneAnchor,this.logger),this.sceneAnchor=null),this.xr.createSceneAnchor(r,this.logger).then(function(e){t.sceneAnchor=e}).catch(function(e){t.logger.error("error creating new scene anchor: ".concat(e))})):this.xr.updateAnchoredSceneNode(this.sceneAnchor,r,this.logger)):this.logger.error("no sceneNode? so no children?")}this.scenes.children.forEach(function(e){return e.visible=!1}),this.three_map[e.id]&&(this.three_map[e.id].visible=!0),this.current_scene=e}}]),t}(r.Component),bi=function(e){function t(e){var n;return Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this))).player=e,n.logger=n.player.logger,n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"getCurrentScene",value:function(){return this.player.current_scene||this.logger.error("the current scene is null"),this.player.current_scene}},{key:"getSceneObjects",value:function(e){return e.children.filter(function(e){return _t(e.type)})}},{key:"getBehaviorsForObject",value:function(e){return e.children?e.children.filter(function(e){return e.type===Jt.BEHAVIOR}):[]}},{key:"getThreeObject",value:function(e){if(e){if(e.id)return this.player.three_map[e.id]}else this.logger.error("getThreeObject got invalid obj");return this.player.three_map[e]}},{key:"getParsedBehaviorAsset",value:function(e){return this.player.behavior_assets[e.behavior]}},{key:"getAllBehaviors",value:function(){var e=this;return Object.keys(this.player.behavior_map).map(function(t){return e.player.behavior_map[t]})}},{key:"getAllScenes",value:function(){var e=this;return Object.keys(this.player.obj_map).map(function(t){return e.player.obj_map[t]}).filter(function(e){return e.type===Jt.SCENE})}},{key:"navigateScene",value:function(e){this.logger.log("navigating to ",e);var t=this.player.obj_map[e];if(!t)return this.logger.error("couldn't find scene for",e);this.player.setCurrentScene(t)}},{key:"playMediaAsset",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.player.assetsManager.playMediaAsset(e,t)}},{key:"stopMediaAsset",value:function(e){this.player.assetsManager.stopMediaAsset(e)}},{key:"getGraphObjectByName",value:function(e){return this.player.title_map[e]}},{key:"getGraphObjectById",value:function(e){return this.player.obj_map[e]}},{key:"getCamera",value:function(){return this.player.camera}},{key:"getTweenManager",value:function(){return this.player.tweenManager}},{key:"startLocalAnchor",value:function(e){this.logger.log("starting vanilla anchor"),this.player.xr&&this.player.xr.session?this.player.xr.createLocalAnchorFromHitTest(e,e.screenx||0,e.screeny||0,this.logger):this.logger.log("XR is not active?")}},{key:"stopLocalAnchor",value:function(e){this.logger.log("stopping vanilla anchor"),this.player.xr&&this.player.xr.session?this.player.xr.stopLocalAnchor(e,this.logger):this.logger.log("XR is not active?")}},{key:"startImageRecognizer",value:function(e){var t=this;return this.logger.log("starting the image recognizer"),new Promise(function(n,r){t.player.xr&&t.player.xr.session?t.player.xr.createDetectionImage(e,t.logger).then(function(n){t.player.xr.startImageRecognizer(e,n,t.logger)}):t.logger.log("XR is not active?")})}},{key:"stopImageRecognizer",value:function(e){this.logger.log("stopping the image recognizer"),this.player.xr&&this.player.xr.session?this.player.xr.stopImageRecognizer(e,this.logger):this.logger.log("XR is not active?")}},{key:"startGeoTracker",value:function(e){var t=this;return new Promise(function(n,r){t.player.xr&&t.player.xr.session?t.player.xr.createGeoAnchor(e,t.logger).then(function(){t.player.xr.addGeoAnchoredNode(e,t.logger)}):t.logger.log("XR is not active?")})}},{key:"stopGeoTracker",value:function(e){this.player.xr&&this.player.xr.session?this.player.xr.stopGeoTracker(e,this.logger):this.logger.log("XR is not active?")}}]),t}(Fn),wi=function(e){function t(e){var n;Object(s.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this,e))).showProviderList=function(e){p.e.show(i.a.createElement(p.f,null,n.providers.map(function(e){return i.a.createElement("button",{key:e,onClick:function(){return n.openNewProvider(e)}},e)})),e.target)},n.state={switcher:!1},n.providers=["vr","metadoc"];var r=n.props.options.switcher;return"undefined"===typeof r||!0!==r&&"true"!==r||(n.state.switcher=!0),n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"getApp",value:function(){var e=this.props.options.doctype||"vr";return"vr"===e?"play"===this.props.options.mode?(console.log("doing play instead"),i.a.createElement(gi,{options:this.props.options})):(this.provider=new si(this.props.options),this.provider.getApp()):"metadoc"===e?(this.provider=new Dn(this.props.options),this.provider.getApp()):void 0}},{key:"openNewProvider",value:function(e){p.e.hide(),window.open("./?mode=edit&doctype=".concat(e))}},{key:"render",value:function(){return this.state.switcher?i.a.createElement(p.f,{fill:!0},i.a.createElement("button",{style:{position:"absolute",zIndex:10},onClick:this.showProviderList},i.a.createElement("img",{src:"icon.png",alt:"switch apps",height:"20",style:{padding:"0em"}})),i.a.createElement("div",{style:{position:"relative",flex:"1"}},this.getApp()),i.a.createElement(p.a,null),i.a.createElement(p.d,null)):this.getApp()}}]),t}(r.Component),Oi=m({mode:"edit"});console.log("options is",Oi),o.a.render(i.a.createElement(wi,{options:Oi}),document.getElementById("root"))}},[[46,2,1]]]);
//# sourceMappingURL=main.6c380fee.chunk.js.map