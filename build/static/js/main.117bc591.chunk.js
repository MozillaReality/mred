(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{12:function(t,e){t.exports={adds:[],add:function(t){this.adds.forEach(function(e){return e(t)})},onAdd:function(t){this.adds.push(t)},offAdd:function(t){this.adds=this.adds.filter(function(e){return e!==t})}}},45:function(t,e,n){t.exports=n.p+"static/media/startup-sound.8786b4e1.m4a"},47:function(t,e,n){t.exports=n(97)},52:function(t,e,n){},56:function(t,e,n){},64:function(t,e,n){},97:function(t,e,n){"use strict";n.r(e);var r=n(0),a=n.n(r),o=n(42),s=n.n(o),i=(n(52),n(54),n(2)),c=n(3),u=n(6),p=n(4),l=n(7),d=(n(56),n(5)),f=n(11),m=n(8),v=n(46);function b(t){var e=document.location;e.search&&e.search.substring(1).split("&").forEach(function(e){var n=e.split("=");t[n[0]]=n[1]});return t}var h=function(t,e,n){return t.addEventListener(e,n)};function y(t){return JSON.stringify(t)}function O(t,e){return{x:t,y:e,minus:function(t){return O(this.x-t.x,this.y-t.y)},add:function(t){return O(this.x+t.x,this.y+t.y)},divide:function(t){return O(this.x/t,this.y/t)},multiply:function(t){return O(this.x*t,this.y*t)},idivide:function(t){return O(Math.floor(this.x/t),Math.floor(this.y/t))},floor:function(){return O(Math.floor(this.x),Math.floor(this.y))},distance:function(t){var e=t.x-this.x,n=t.y-this.y;return Math.sqrt(e*e+n*n)},equals:function(t){return t.x===this.x&&t.y===this.y},toString:function(){return"(".concat(t,",").concat(e,")")}}}function k(t){var e=b({}),n={};Object.keys(e).forEach(function(t){return n[t]=e[t]}),Object.keys(t).forEach(function(e){return n[e]=t[e]});var r=Object.keys(n).map(function(t){return"".concat(t,"=").concat(n[t])}).join("&");window.history.pushState(t,"a title","?"+r)}function w(t){return Object.keys(t).map(function(e){return"".concat(e,"=").concat(t[e])}).join("&")}var g=function(t){var e="grid fill",n=t.leftWidth,r=t.rightWidth;t.showLeft||(e+=" hide-left",n=0),t.showRight||(e+=" hide-right",r=0);var o={gridTemplateColumns:"\n    [left] ".concat(n,"px\n    [left-resize] 2px\n    [center] auto\n    [right-resize] 2px\n    [right] ").concat(r,"px\n    ")};return a.a.createElement("div",{className:e,style:o},t.children)},S=function(t){var e="toolbar";return t.left&&(e+=" left"),t.right&&(e+=" right"),t.bottom&&(e+=" bottom"),t.top&&(e+=" top"),t.center&&(e+=" center"),t.middle&&(e+=" middle"),t.scroll&&(e+=" scroll"),a.a.createElement("div",{className:e},t.children)},C=function(t){var e="panel";return t.left&&(e+=" left"),t.right&&(e+=" right"),t.bottom&&(e+=" bottom"),t.top&&(e+=" top"),t.center&&(e+=" center"),t.middle&&(e+=" middle"),t.scroll&&(e+=" scroll"),t.transparent&&(e+=" transparent"),a.a.createElement("div",{className:e},t.children)},E=function(t){return a.a.createElement("span",{className:"spacer"})},M=function(t){var e=t.selected,n=Object(v.a)(t,["selected"]),r=e?"selected":"";return a.a.createElement("button",Object.assign({className:r},n))},j=function(t){return a.a.createElement(d.f,{className:"popup-menu"},t.actions.map(function(t,e){if(t.divider)return a.a.createElement("div",{className:"divider",key:e});var n=!1;return"undefined"===typeof t.enabled&&(n=!0),!0===t.enabled&&(n=!0),a.a.createElement("button",{key:e,disabled:!n,onClick:function(){d.e.hide(),t.fun&&t.fun()}},a.a.createElement("i",{className:"fa fa-"+t.icon})," ",t.title)}))},D=function(t){function e(t){var n;return Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this,t))).toggleLeftPane=function(t){return n.setState({showLeft:!n.state.showLeft})},n.toggleRightPane=function(t){return n.setState({showRight:!n.state.showRight})},n.onMouseDownLeft=function(t){t.preventDefault(),t.stopPropagation(),n.setState({dragSide:"left"}),window.addEventListener("mousemove",n.onMouseMove),window.addEventListener("mouseup",n.onMouseUp)},n.onMouseDownRight=function(t){t.preventDefault(),t.stopPropagation(),n.setState({dragSide:"right"}),window.addEventListener("mousemove",n.onMouseMove),window.addEventListener("mouseup",n.onMouseUp)},n.onMouseMove=function(t){t.preventDefault(),t.stopPropagation();var e=O(t.clientX,t.clientY);"left"===n.state.dragSide&&n.setState({leftWidth:e.x}),"right"===n.state.dragSide&&n.setState({rightWidth:window.innerWidth-e.x})},n.onMouseUp=function(t){t.preventDefault(),t.stopPropagation(),window.removeEventListener("mousemove",n.onMouseMove),window.removeEventListener("mouseup",n.onMouseUp)},n.state={showLeft:!0,showRight:!0,leftWidth:250,rightWidth:250,dragSide:"none"},n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"render",value:function(){return a.a.createElement(g,{showLeft:this.state.showLeft,showRight:this.state.showRight,leftWidth:this.state.leftWidth,rightWidth:this.state.rightWidth},a.a.createElement(S,{center:!0,bottom:!0},a.a.createElement("button",{className:"fa"+(this.state.showLeft?" fa-caret-left":" fa-caret-right"),onClick:this.toggleLeftPane}),a.a.createElement(E,null),this.props.bottomText,a.a.createElement(E,null),a.a.createElement("button",{className:"fa"+(this.state.showRight?" fa-caret-right":" fa-caret-left"),onClick:this.toggleRightPane})),a.a.createElement("div",{className:"left-resize",onMouseDown:this.onMouseDownLeft}),a.a.createElement("div",{className:"right-resize",onMouseDown:this.onMouseDownRight}),this.props.children)}}]),e}(r.Component),R="CHANGED",P="DROP_TARGET",I=new(function(){function t(e){Object(i.a)(this,t),this.listeners={},this.selected=[],this.dropTarget=null,this.clip=null}return Object(c.a)(t,[{key:"on",value:function(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)}},{key:"off",value:function(t,e){var n=this.listeners[t].indexOf(e);n>=0&&this.listeners[t].splice(n,1)}},{key:"fire",value:function(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].forEach(function(t){return t(e)})}},{key:"setSelection",value:function(t){this.selected=[t],this.fire(R,this)}},{key:"addToSelection",value:function(t){this.selected.push(t),this.fire(R,this)}},{key:"clearSelection",value:function(){this.selected=[],this.fire(R,this)}},{key:"isSelected",value:function(t){return this.selected.indexOf(t)>=0}},{key:"getSelection",value:function(){return 0===this.selected.length?null:this.selected[0]}},{key:"isEmpty",value:function(){return 0===this.selected.length}},{key:"getFullSelection",value:function(){return this.selected}},{key:"setDropTarget",value:function(t){this.dropTarget!==t&&(this.dropTarget=t,this.fire(P,this.dropTarget))}},{key:"getDropTarget",value:function(){return this.dropTarget}},{key:"setDropType",value:function(t){this.dropType=t}},{key:"getDropType",value:function(){return this.dropType}},{key:"setClipboard",value:function(t){this.clip=t}},{key:"getClipboard",value:function(){return this.clip}}]),t}()),T=n(20),x=n.n(T),N=function(t){function e(t){var n;Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this,t))).mousePress=function(t){var e=n.canvasToPoint(t);n.setState({lightness:e.x,value:e.y}),n.redraw(),n.pressed=!0},n.mouseMove=function(t){if(n.pressed){var e=n.canvasToPoint(t);n.setState({lightness:e.x,value:e.y}),n.redraw()}},n.mouseUp=function(t){n.pressed=!1,n.redraw()},n.redraw=function(){n.drawPicker(),n.drawSlider(),n.drawIndicator()},n.livalToCanvas=function(t,e){return O(t/100*100,e/100*100)},n.mouseToCanvas=function(t){var e=t.target.getBoundingClientRect();return O(t.clientX,t.clientY).minus(O(e.x,e.y))},n.mousePressSlider=function(t){n.sliderPressed=!0;var e=n.mouseToCanvas(t),r=n.canvasToHue(e);n.setState({hue:r}),setTimeout(n.redraw,100)},n.mouseMoveSlider=function(t){if(n.sliderPressed){var e=n.mouseToCanvas(t),r=n.canvasToHue(e);n.setState({hue:r}),setTimeout(n.redraw,100)}},n.mouseUpSlider=function(){n.sliderPressed=!1},n.close=function(){var t=x.a.hsluvToHex([Math.floor(n.state.hue),Math.floor(n.state.lightness),Math.floor(n.state.value)]);t.length>7&&(t="#000000"),n.props.onSelect(t),d.e.hide()};var r=x.a.hexToHsluv(t.value);return n.state={hue:r[0],lightness:r[1],value:r[2]},console.log("the current value is",t.value,x.a.hexToHsluv(t.value)),n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"componentDidMount",value:function(){this.redraw()}},{key:"canvasToPoint",value:function(t){var e=this.canvas.getBoundingClientRect(),n=O(t.clientX,t.clientY).minus(O(e.x,e.y)),r=this.canvas.height,a=this.canvas.width;return O(n.x/a*100,n.y/r*100)}},{key:"drawPicker",value:function(){if(this.canvas){for(var t=this.canvas.getContext("2d"),e=Math.floor(this.state.hue),n=0;n<=4;n++)for(var r=0;r<=4;r++){var a=x.a.hsluvToHex([e,25*n,25*r]);a.length>7&&(a="#000000"),t.fillStyle=a,t.fillRect(20*n,20*r,20,20)}var o=20,s=this.livalToCanvas(this.state.lightness,this.state.value);t.strokeStyle="white",t.strokeRect(Math.floor(s.x/o)*o,Math.floor(s.y/o)*o,o,o),t.strokeStyle="black",t.strokeRect(Math.floor(s.x/o)*o+1,Math.floor(s.y/o)*o+1,18,18),t.strokeStyle="black",t.lineWidth=1,t.strokeRect(0,0,100,100)}}},{key:"canvasToHue",value:function(t){return Math.floor(t.x/this.slider.width*360)}},{key:"hueToCanvas",value:function(t){return t/360*this.slider.width}},{key:"drawSlider",value:function(){var t=this.slider.getContext("2d"),e=this.slider.width,n=this.slider.height;t.fillStyle="red",t.fillRect(0,0,e,n);for(var r=0;r<e;r+=10){var a=this.canvasToHue(O(r,0)),o=x.a.hsluvToHex([a,100,50]);o.length>7&&(o="#000000"),t.fillStyle=o,t.fillRect(r,0,10,n)}t.strokeStyle="black",t.lineWidth=1;var s=10*Math.floor(this.hueToCanvas(this.state.hue)/10);t.strokeRect(s,0,10,n),t.strokeRect(0,0,e,n)}},{key:"drawIndicator",value:function(){var t=this.indicator.getContext("2d"),e=this.indicator.width,n=this.indicator.height,r=x.a.hsluvToHex([Math.floor(this.state.hue),Math.floor(this.state.lightness),Math.floor(this.state.value)]);r.length>7&&(r="#000000"),t.fillStyle=r,t.fillRect(0,0,e,n),t.strokeStyle="black",t.lineWidth=1,t.strokeRect(0,0,e,n)}},{key:"render",value:function(){var t=this;return a.a.createElement("div",{style:{display:"flex",flexDirection:"column",alignItems:"center"}},a.a.createElement("canvas",{ref:function(e){return t.canvas=e},width:100,height:100,onMouseDown:this.mousePress,onMouseMove:this.mouseMove,onMouseUp:this.mouseUp}),a.a.createElement("canvas",{ref:function(e){return t.slider=e},width:100,height:30,onMouseDown:this.mousePressSlider,onMouseMove:this.mouseMoveSlider,onMouseUp:this.mouseUpSlider}),a.a.createElement("canvas",{ref:function(e){return t.indicator=e},width:32,height:32,onClick:this.close}))}}]),e}(r.Component),G=n(12),A="USER_CHANGE",F=new(function(){function t(){var e=this;Object(i.a)(this,t),this.login=function(t){e.win=window.open(t.url,"_blank"),window.addEventListener("message",e.authCallback),e.win&&e.win.focus()},this.logout=function(){localStorage.clear(),e.doclistSupported=!1,e.fire(A)},this.authCallback=function(t){e.setUserData(t.data.payload),e.win.close(),window.removeEventListener("message",e.authCallback),e.doclistSupported=!0,e.fire(A),G.add("login succeeded")},this.listeners={},this.supported=!1,this.doclistSupported=!1,this.docDeleteSupported=!1,this.assetUploadSupported=!1,this.scriptEditingSupported=!1,this.passwordSupported=!1,this.connected=!1,this.serverID="".concat("serverid","_").concat(Math.floor(1e4*Math.random()))}return Object(c.a)(t,[{key:"on",value:function(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)}},{key:"fire",value:function(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].forEach(function(t){return t(e)})}},{key:"init",value:function(){var t=this;this.isLoggedIn()&&(this.doclistSupported=!0),fetch(K()).then(function(t){return t.json()}).then(function(e){console.info("Server Info:",e),!0===e.authentication&&(t.supported=!0),!0===e.passwordSupported&&(t.passwordSupported=!0),!0===e.assetUpload&&(t.assetUploadSupported=!0),!0===e.scriptEditing&&(t.scriptEditingSupported=!0),!0===e.docDeleteSupported&&(t.docDeleteSupported=!0),t.serverID=K().replace(/[\.\:\/]/g,""),t.getJSON(Z()).then(function(e){e.success?(t.fire(A),t.doclistSupported=!0):t.logout(),t.connected=!0,t.fire("CONNECTED")}).then(function(){t.connected=!0,t.fire("CONNECTED")})})}},{key:"isConnected",value:function(){return this.connected}},{key:"isLoggedIn",value:function(){return!!localStorage.getItem("access-token")}},{key:"supportsPassword",value:function(){return this.passwordSupported}},{key:"supportsAuth",value:function(){return this.supported}},{key:"supportsDocList",value:function(){return this.doclistSupported}},{key:"supportsAssetUpload",value:function(){return this.assetUploadSupported}},{key:"supportsScriptEdit",value:function(){return this.scriptEditingSupported}},{key:"supportsDocDelete",value:function(){return this.docDeleteSupported}},{key:"doPasswordLogin",value:function(t){var e=this;return localStorage.setItem("access-token",t),this.getJSON(Z()).then(function(t){!0===t.success?(console.log("the logged in response is",t),e.doclistSupported=!0,G.add("login succeeded"),e.fire(A)):(G.add("login failed"),localStorage.clear(),e.doclistSupported=!1,e.fire(A))})}},{key:"setUserData",value:function(t){localStorage.setItem("access-token",t.accessToken)}},{key:"getAccessToken",value:function(){return localStorage.getItem("access-token")}},{key:"getUsername",value:function(){return this.getAccessToken()}},{key:"getServerID",value:function(){return this.serverID}},{key:"fetch",value:function(t){function e(e,n){return t.apply(this,arguments)}return e.toString=function(){return t.toString()},e}(function(t,e){return e.mode="cors",e.cache="no-cache",e.headers||(e.headers={}),e.headers["access-key"]=F.getAccessToken(),console.log("fetching",t,"with options",e),fetch(t,e).then(function(t){if(404===t.status)throw new Error(t.statusText+" "+t.url);return t})})},{key:"getJSON",value:function(t){return this.fetch(t,{method:"GET",headers:{"Content-Type":"application/json"}}).then(function(t){return t.json()})}},{key:"uploadFile",value:function(t){var e=V()+t.name;return this.fetch(e,{method:"POST",body:t}).then(function(t){return t.json()})}}]),t}()),B={EXPANDED_CHANGED:"EXPANDED_CHANGED",STRUCTURE_CHANGED:"STRUCTURE_CHANGED",STRUCTURE_ADDED:"STRUCTURE_ADDED",STRUCTURE_REMOVED:"STRUCTURE_REMOVED",PROPERTY_CHANGED:"PROPERTY_CHANGED",CLEAR_DIRTY:"CLEAR_DIRTY",SAVED:"SAVED",DOCUMENT_SWAPPED:"DOCUMENT_SWAPPED"},U={BASE:"https://vr.josh.earth/generaled/api/"};function H(){return U.BASE+"doc/"}function V(){return U.BASE+"asset/"}function W(){return U.BASE+"scripts/"}function K(){return U.BASE+"info"}function Z(){return U.BASE+"userinfo"}var q=!0;var Q=function(t){function e(t){var n;return Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this))).genID=function(t){return"".concat(t,"_").concat(Math.floor(1e3*Math.random()*1e3*1e3))},n.save=function(){console.info("saving",n.getSceneRoot());var t={doc:n.getSceneRoot(),type:n.getDocType(),id:n.getDocId()},e=JSON.stringify(t,function(t,e){if("parent"!==t)return e});return console.info("doc is",e),F.fetch(H()+n.docid,{method:"POST",body:e,headers:{"Content-Type":"application/json"}}).then(function(t){return t.json()}).then(function(t){console.log("Success result is",t),k({mode:"edit",doc:n.docid,doctype:n.getDocType()}),n.fire(B.SAVED,!0)}).catch(function(t){return console.log("error",t)})},n.hasChildren=function(t){return t&&t.children&&t.children.length},n.getChildren=function(t){return t.children},n.listeners={},n.expanded_map={},n.docid=null,U.BASE=function(t){if(t)return"https://".concat(t,"/");if(q){console.log("no server url, checking the document");var e=document.location.host;if(e.endsWith(".glitch.me"))return console.log("this is a glitch. using autodetected server"),"https://".concat(e,"/")}return U.BASE}(t.SERVER_URL),console.log("using server",U.BASE),F.init(),n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"on",value:function(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)}},{key:"fire",value:function(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].forEach(function(t){return t(e)})}},{key:"off",value:function(t,e){this.listeners[t]&&(this.listeners[t]=this.listeners[t].filter(function(t){return t!==e}))}},{key:"isExpanded",value:function(t){return t.id||(t.id=""+Math.random()),"undefined"===typeof this.expanded_map[t.id]&&(this.expanded_map[t.id]=!0),this.expanded_map[t.id]}},{key:"toggleItemCollapsed",value:function(t){var e=this.isExpanded(t);this.expanded_map[t.id]=!e,this.fire(B.EXPANDED_CHANGED,t)}},{key:"setPropertyValue",value:function(t,e,n){throw new Error("subclass of TreeItemProvider must implement setPropertyValue")}},{key:"setDocument",value:function(t,e){this.root=t,this.docid=e,this.fire(B.STRUCTURE_CHANGED,{provider:this})}},{key:"getDocId",value:function(){return this.docid}},{key:"loadDoc",value:function(t){var e=this;console.log("need to load the doc",t),F.getJSON(H()+t).then(function(t){if(console.log("got the doc",t),t.type!==e.getDocType())throw new Error("incorrect doctype for this provider",t.type);e.setDocument(t.doc,t.id)}).catch(function(t){console.warn("missing doc",t),e.setDocument(e.makeEmptyRoot(),e.genID("doc")),k({mode:"edit",doc:e.docid,doctype:e.getDocType()})})}},{key:"reloadDocument",value:function(){var t=this,e=this.generateSelectionPath(I.getSelection());console.log("got the path",e),F.getJSON(H()+this.docid).then(function(n){if(n.type!==t.getDocType())throw new Error("incorrect doctype for this provider",n.type);t.setDocument(n.doc,n.id),t.fire(B.CLEAR_DIRTY,!0);var r=t.findNodeFromSelectionPath(t.getSceneRoot(),e);console.log("set new selection to ",r),I.setSelection(r)}).catch(function(t){console.warn("couldn't reload the doc",t)})}},{key:"generateSelectionPath",value:function(){throw new Error("generateSelectionPath not implemented")}},{key:"findNodeFromSelectionPath",value:function(){throw new Error("findNodeFromSelectionPath not implemented")}},{key:"makeEmptyRoot",value:function(){throw new Error("makeEmptyRoot() not implemented")}},{key:"getSceneRoot",value:function(){return this.root}},{key:"uploadFile",value:function(t){return new Promise(function(e,n){(new FormData).append("file",t),console.info("filesize is",t.size,t.name);var r=new XMLHttpRequest;r.onreadystatechange=function(){return console.log("ready state = ".concat(r.readyState," status ").concat(r.status))},r.addEventListener("progress",function(t){return console.log("progress")}),r.addEventListener("load",function(t){return e(r.response)}),r.addEventListener("error",function(t){return console.log("error")}),r.addEventListener("abort",function(t){return console.log("abort")});var a=V()+t.name;console.info("uploading to ",a),r.responseType="json",r.open("POST",a),r.setRequestHeader("access-key",F.getAccessToken()),r.send(t)})}}]),e}(function(){function t(){Object(i.a)(this,t)}return Object(c.a)(t,[{key:"on",value:function(t,e){throw new Error("interface 'on' not implemented")}},{key:"off",value:function(t,e){throw new Error("interface 'off' not implemented")}},{key:"fire",value:function(t,e){throw new Error("interface 'fire' not implemented")}},{key:"getSceneRoot",value:function(){throw new Error("interface 'getSceneRoot' not implemented")}},{key:"deleteChild",value:function(t){throw new Error("deleteChild not implemented yet")}},{key:"appendChild",value:function(t,e){throw new Error("appendChild not implemented yet")}},{key:"insertNodeBefore",value:function(t,e){throw new Error("insertNodeBefore() not implemented yet")}},{key:"findNodeById",value:function(t){throw new Error("findNodeById() not implemented yet")}},{key:"findParent",value:function(t){throw new Error("findParent() not implemented yet")}},{key:"hasChildren",value:function(t){throw new Error("hasChildren() not implemented yet")}},{key:"getChildren",value:function(t){throw new Error("getChildren() not implemented yet")}},{key:"isExpanded",value:function(t){throw new Error("interface 'isExpanded' not implemented")}},{key:"calculateContextMenu",value:function(t){throw new Error("calculateContextMenu() not implemented yet")}},{key:"toggleItemCollapsed",value:function(t){throw new Error("toggleItemCollapsed() not implemented yet")}},{key:"getRendererForItem",value:function(t){throw new Error("getRendererForItem() not implemented yet")}},{key:"setPropertyValue",value:function(t,e,n){throw new Error("interface setPropertyValue not implemented")}},{key:"setPropertyValueByName",value:function(t,e,n){throw new Error("interface 'setPropertyValueByName() not implemented'")}},{key:"getProperties",value:function(t){throw new Error("interface 'getProperties()' not implemented")}},{key:"getDocId",value:function(){throw new Error("getDocId() not implemented")}},{key:"getDocType",value:function(){throw new Error("getDocType() not implemented")}},{key:"getApp",value:function(){throw new Error("getApp() not implemented")}},{key:"getTitle",value:function(){throw new Error("getTitle() not implemented")}}]),t}()),z=function(t){function e(){var t,n;Object(i.a)(this,e);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=Object(u.a)(this,(t=Object(p.a)(e)).call.apply(t,[this].concat(a)))).keypressed=function(t){13===t.charCode&&n.props.onCommit()},n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"render",value:function(){var t=this.props.def;if(t.hasHints()&&t.getHints().multiline)return a.a.createElement("textarea",{value:this.props.value,onChange:this.props.onChange,onBlur:this.props.onBlur});return a.a.createElement("input",{type:"string",value:this.props.value,onChange:this.props.onChange,onKeyPress:this.keypressed,onBlur:this.props.onBlur})}}]),e}(r.Component),J=function(t){var e=t.renderer,n=t.values.map(function(n){return a.a.createElement(d.c,{key:n,onClick:function(e){return t.onSelect(n)}},a.a.createElement(e,{value:n,def:t.def,obj:t.obj,provider:t.provider}))});return a.a.createElement(d.f,{className:"popup-menu"},n)},$=function(t){var e="";return"undefined"!==typeof t.value&&null!==t.value&&(e=t.value.toString()),a.a.createElement("span",null,e)},X=function(t){function e(){var t,n;Object(i.a)(this,e);for(var r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];return(n=Object(u.a)(this,(t=Object(p.a)(e)).call.apply(t,[this].concat(o)))).open=function(t){d.e.show(a.a.createElement(J,{values:n.calculateValues(),renderer:n.calculateRenderer(),onSelect:n.selectValue,provider:n.props.provider}),t.target)},n.selectValue=function(t){d.e.hide(),n.props.onChange(t)},n.renderValue=function(t){var e=n.props.def,r=n.props.obj,o=n.calculateRenderer();return a.a.createElement(o,{value:t,def:e,obj:r,provider:n.props.provider})},n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"calculateRenderer",value:function(){var t=this.props.def,e=this.props.obj;if(!this.props.provider.getRendererForEnum)return $;var n=this.props.provider.getRendererForEnum(t.getKey(),e);return n||$}},{key:"calculateValues",value:function(){var t=this.props.provider.getValuesForEnum(this.props.def.getKey(),this.props.obj,this.props.def);return t||(console.log("no values for enum ".concat(this.props.def.getKey())),[])}},{key:"render",value:function(){return a.a.createElement("button",{onClick:this.open},this.renderValue(this.props.value))}}]),e}(r.Component),Y=function(t){var e="";return"undefined"!==typeof t.value&&(e=t.value.toString()),a.a.createElement("span",null,e)},L=function(t){function e(t){var n;return Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this,t))).addValue=function(){n.setState({showEditor:!0})},n.enumChanged=function(t){var e=n.props.value.slice();e.push(t),n.props.onChange(e)},n.state={showEditor:!1,value:""},n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"calculateRenderer",value:function(){var t=this.props.def,e=this.props.obj;if(!this.props.provider.getRendererForEnum)return Y;var n=this.props.provider.getRendererForEnum(t.key,e);return n||Y}},{key:"render",value:function(){var t=this.props.value;return t||(t=[]),a.a.createElement("div",null,this.renderValues(),a.a.createElement("button",{onClick:this.addValue,className:"fa fa-plus"}),this.renderEditor())}},{key:"deleteItem",value:function(t){var e=this.props.value.slice();e=e.filter(function(e){return e!==t}),this.props.onChange(e)}},{key:"renderValues",value:function(){var t=this,e=this.calculateRenderer();return a.a.createElement(d.f,null,this.props.value.map(function(n,r){return a.a.createElement("div",{key:r},a.a.createElement("button",{className:"fa fa-minus",onClick:function(){return t.deleteItem(n)}}),a.a.createElement(e,{value:n,provider:t.props.provider}))}))}},{key:"renderEditor",value:function(){if(!this.state.showEditor)return"";var t=this.props.def,e=this.props.obj;return a.a.createElement(X,{value:this.state.value,onChange:this.enumChanged,def:t,obj:e,provider:this.props.provider})}}]),e}(r.Component),_={STRING:"string",NUMBER:"number",BOOLEAN:"boolean",ENUM:"enum",COLOR:"color",GROUP:"group"},tt=function(t){function e(t){var n;return Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this,t))).changed=function(t){n.props.def.isType(_.STRING)&&(n.setState({value:t.target.value}),n.props.def.isLive()&&n.props.def.setValue(t.target.value)),n.props.def.isType(_.NUMBER)&&n.updateNum(t.target.value),n.props.def.isType(_.BOOLEAN)&&n.setState({value:t.target.checked})},n.customChanged=function(t){if(n.props.def.isType(_.COLOR))return n.colorChanged(t);n.setState({value:t}),n.props.def.setValue(t)},n.keypressed=function(t){13===t.charCode&&n.commit()},n.updateNum=function(t){var e=n.props.def;e.hasHints()&&(e.getHints().hasOwnProperty("min")&&t<e.getHints().min&&(t=e.getHints().min),e.getHints().hasOwnProperty("max")&&t>e.getHints().max&&(t=e.getHints().max)),n.setState({value:t}),isNaN(parseFloat(t))||e.setValue(parseFloat(t))},n.numberKeyDown=function(t){"ArrowUp"===t.key&&t.shiftKey&&(t.preventDefault(),n.updateNum(n.state.value+10)),"ArrowDown"===t.key&&t.shiftKey&&(t.preventDefault(),n.updateNum(n.state.value-10))},n.booleanChanged=function(t){n.setState({value:t.target.checked}),n.props.def.setValue(t.target.checked)},n.enumChanged=function(t){n.setState({value:t}),n.props.def.setValue(t)},n.arrayChanged=function(t){n.setState({value:t}),n.props.def.setValue(t)},n.colorChanged=function(t){n.setState({value:t}),n.props.def.setValue(t)},n.commit=function(){n.props.def.setValue(n.state.value)},n.openColorEditor=function(t){d.e.show(a.a.createElement(N,{onSelect:n.colorChanged,value:n.state.value}),t.target)},n.state={value:t.def.getValue()},n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"componentWillReceiveProps",value:function(t){this.props.def!==t.def&&this.setState({value:t.def.getValue()})}},{key:"shouldComponentUpdate",value:function(t,e){return"group"===t.def.getType()||(this.state.value!==e.value||(this.props.def.getKey()!==t.def.getKey()||this.props.def.getValue()!==t.def.getValue()))}},{key:"render",value:function(){var t=this.props.def,e=I.getSelection(),n=this.props.provider;if(t.isCustom())return this.props.provider.createCustomEditor(this.props.item,t,n,this.state.value,this.customChanged);if(t.isLocked())return a.a.createElement("i",null,t.getValue());if(t.isType(_.STRING))return a.a.createElement(z,{value:this.state.value,onChange:this.changed,onBlur:this.commit,onCommit:this.commit,def:t,obj:e,provider:this.props.provider});if(t.isType(_.NUMBER)){var r=1;if(t.hasHints()){var o=t.getHints();o.incrementValue&&(r=o.incrementValue)}return a.a.createElement("input",{type:"number",value:this.state.value,onChange:this.changed,onKeyPress:this.keypressed,onKeyDown:this.numberKeyDown,onBlur:this.commit,step:r})}return t.isType(_.BOOLEAN)?a.a.createElement("input",{type:"checkbox",checked:this.state.value,onChange:this.booleanChanged}):t.isType(_.ENUM)?a.a.createElement(X,{value:this.state.value,onChange:this.enumChanged,def:t,obj:e,provider:this.props.provider}):t.isType(_.COLOR)?a.a.createElement("button",{style:{backgroundColor:this.state.value},onClick:this.openColorEditor},this.state.value):t.isType("array")?a.a.createElement(L,{value:this.state.value,onChange:this.arrayChanged,def:t,obj:e,provider:this.props.provider}):a.a.createElement("b",null,t.getType(),":",t.getValue())}}]),e}(r.Component),et=function(t){function e(t){var n;return Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this,t))).state={selection:null},n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"componentDidMount",value:function(){var t=this;this.h2=function(){return t.setState({selection:I.getSelection()})},this.props.provider.on(B.PROPERTY_CHANGED,this.h2),this.hand=function(e){return t.setState({selection:I.getSelection()})},I.on(R,this.hand)}},{key:"componentWillUnmount",value:function(){I.off(R,this.hand),this.props.provider.off(B.PROPERTY_CHANGED,this.h2)}},{key:"render",value:function(){var t=this,e=this.calculateGroups(this.calculateProps()),n=I.getSelection();return a.a.createElement("ul",{className:"prop-sheet"},e.map(function(e,r){return[a.a.createElement("label",{key:e.getKey()+"-label",title:e.getKey()},e.getName()),t.renderIndeterminate(e,r),a.a.createElement(tt,{key:e.getKey()+"-editor",def:e,provider:t.props.provider,item:n})]}))}},{key:"renderIndeterminate",value:function(t,e){return t.isIndeterminate()?a.a.createElement("i",{key:t.getKey()+"-indeterminate",className:"icon fa fa-exclamation-circle"}):""}},{key:"calculateProps",value:function(){var t=I.getFullSelection(),e=t[0],n=this.props.provider,r=n.getProperties(e);return t.forEach(function(t){var e,a;e=r,a=n.getProperties(t),r=e.filter(function(t){return a.find(function(e){return t.key===e.key})})}),r.map(function(e){var r=new nt(n,e.key);return t.forEach(function(t){var a=n.getProperties(t).find(function(t){return t.key===e.key});r.addSubProxy(new rt(n,t,a))}),r})}},{key:"calculateGroups",value:function(t){return t.filter(function(t){return t.getType()===_.GROUP}).forEach(function(e){var n=e.getGroupKeys();t=t.filter(function(t){return n.indexOf(t.getKey())<0})}),t}}]),e}(r.Component);var nt=function(){function t(e,n){Object(i.a)(this,t),this.provider=e,this.key=n,this.subs=[]}return Object(c.a)(t,[{key:"addSubProxy",value:function(t){this.subs.push(t)}},{key:"first",value:function(){return this.subs[0]}},{key:"getName",value:function(){return this.first().getName()}},{key:"getValue",value:function(){return this.first().getValue()}},{key:"isCustom",value:function(){return this.first().isCustom()}},{key:"hasHints",value:function(){return this.first().hasHints()}},{key:"getHints",value:function(){return this.first().getHints()}},{key:"isLocked",value:function(){return this.first().isLocked()}},{key:"getType",value:function(){return this.first().getType()}},{key:"isType",value:function(t){return this.first().isType(t)}},{key:"isLive",value:function(){return this.first().isLive()}},{key:"getKey",value:function(){return this.key}},{key:"getGroupKeys",value:function(){return this.first().getGroupKeys()}},{key:"setValue",value:function(t){this.subs.forEach(function(e){return e.setValue(t)})}},{key:"isIndeterminate",value:function(){var t=!0,e=this.first().getValue();return this.subs.forEach(function(n){n.getValue()!==e&&(t=!1)}),!t}}]),t}(),rt=function(){function t(e,n,r){Object(i.a)(this,t),this.provider=e,this.item=n,this.def=r}return Object(c.a)(t,[{key:"getKey",value:function(){return this.def.key}},{key:"getName",value:function(){return this.def.name}},{key:"isCustom",value:function(){return this.def.custom}},{key:"isLocked",value:function(){return this.def.locked}},{key:"getType",value:function(){return this.def.type}},{key:"getValue",value:function(){return this.def.value}},{key:"isLive",value:function(){return this.def.live}},{key:"isType",value:function(t){return this.def.type===t}},{key:"setValue",value:function(t){return this.provider.setPropertyValue(this.item,this.def,t)}},{key:"hasHints",value:function(){return this.def.hints}},{key:"getHints",value:function(){return this.def.hints}},{key:"getGroupKeys",value:function(){return this.def.group}},{key:"isIndeterminate",value:function(){return!1}}]),t}();function at(t){return Array.prototype.slice.call(t)}function ot(t,e){return t.createObject(e)}function st(t,e){var n={};return t.getPropertiesForObject(e).forEach(function(r){n[r]=t.getPropertyValue(e,r)}),n.id=e,n}function it(t,e){for(var n=t.getArrayLength(e),r=[],a=0;a<n;a++)r.push(t.getElementAt(e,a));return r}function ct(t,e,n){t.setProperty(n.id,"parent",e.id);var r=t.getPropertyValue(e.id,"children");t.insertAfter(r,null,n.id)}function ut(t,e,n){t.setProperty(n.id,"parent",e.id);var r=t.getPropertyValue(e.id,"children"),a=t.getArrayLength(r),o=t.getElementAt(r,a-1);t.insertAfter(r,o,n.id)}function pt(t,e){var n=st(t,e.parent),r=function(t,e,n){return it(t,e).findIndex(function(t){return t===n})}(t,n.children,e.id);r>=0?t.removeElement(n.children,r):console.error("could not find index for child",e,"in children",n.children)}var lt=function(t){return a.a.createElement(d.f,{className:"popup-menu"},t.menu.map(function(t,e){if(t.divider)return a.a.createElement("div",{className:"divider",key:e});var n=!1;return"undefined"===typeof t.enabled&&(n=!0),!0===t.enabled&&(n=!0),a.a.createElement("button",{key:e,disabled:!n,onClick:function(){d.e.hide(),t.fun&&t.fun()}},a.a.createElement("i",{className:"fa fa-"+t.icon})," ",t.title)}))},dt=function(t){function e(){var t,n;Object(i.a)(this,e);for(var r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];return(n=Object(u.a)(this,(t=Object(p.a)(e)).call.apply(t,[this].concat(o)))).onSelect=function(t){t.shiftKey?I.addToSelection(n.props.node):I.setSelection(n.props.node)},n.onContextMenu=function(t){if(t.preventDefault(),t.stopPropagation(),I.setSelection(n.props.node),n.props.provider.calculateContextMenu){var e=n.props.provider.calculateContextMenu(n.props.node);d.e.show(a.a.createElement(lt,{menu:e}),t.target)}},n.toggleItemCollapsed=function(t){t.preventDefault(),t.stopPropagation(),n.props.provider.toggleItemCollapsed(n.props.node)},n.onDragStart=function(t){n.props.onDragStart(t,n.props.node)},n.onDragOver=function(t){n.props.onDragOver(t,n.props.node)},n.onDragEnd=function(t){n.props.onDragEnd(t,n.props.node)},n.onDrop=function(t){n.props.onDrop(t,n.props.node)},n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"render",value:function(){var t="tree-node",e=this.props.node;I.isSelected(e)&&(t+=" selected"),I.getDropTarget()===e&&(t+=" drop-target","parent"===I.getDropType()&&(t+=" drop-parent"));var n="",r=this.props.provider;r.hasChildren(e)?n=r.isExpanded(e)?a.a.createElement("button",{className:"fa fa-caret-down fa-fw borderless",onClick:this.toggleItemCollapsed}):a.a.createElement("button",{className:"fa fa-caret-right fa-fw borderless",onClick:this.toggleItemCollapsed}):n=a.a.createElement("span",{className:"fa fa-fw borderless"});return a.a.createElement("div",{className:t,onClick:this.onSelect,onContextMenu:this.onContextMenu,"data-nodeid":e.id,onDragOver:this.onDragOver,onDrop:this.onDrop},a.a.createElement("span",{style:{width:1.5*this.props.depth+"em"}}),n,r.getRendererForItem(e),a.a.createElement(E,null),this.renderDragBars())}},{key:"renderDragBars",value:function(){return this.props.provider.canBeMoved&&!this.props.provider.canBeMoved(this.props.node)?"":a.a.createElement("span",{className:"drag fa fa-bars",draggable:!0,onDragStart:this.onDragStart,onDragEnd:this.onDragEnd})}}]),e}(r.Component),ft=function(t){function e(t){var n;return Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this,t))).onDragStart=function(t,e){console.log("starting to drag the item",e),t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("text/html",t.target.parentNode),t.dataTransfer.setDragImage(t.target.parentNode,20,20),t.dataTransfer.dropEffect="move",n.setState({dragTarget:e,internalDrag:!0})},n.onDragOver=function(t,e){if(!n.state.internalDrag)return t.preventDefault(),void(n.props.provider.canAddExternalChild(e,t.dataTransfer)?(I.setDropTarget(e),I.setDropType("parent")):(I.setDropType(null),I.setDropTarget(null)));var r=n.props.provider;if(r.canAddChild(e,n.state.dragTarget))return I.setDropTarget(e),void I.setDropType("parent");r.canBeSibling(e,n.state.dragTarget)?(I.setDropType("sibling"),I.setDropTarget(e)):(I.setDropType(null),I.setDropTarget(null))},n.onDragEnd=function(t,e){if(!n.state.internalDrag)return n.setState({dragTarget:null,internalDrag:!1}),t.preventDefault(),void t.stopPropagation();var r=n.props.provider.getDataGraph();if(n.state.dragTarget&&n.state.dropTarget){var a=st(r,n.state.dragTarget),o=st(r,n.state.dropTarget);if(o.id===a.id)return n.setState({dragTarget:null,internalDrag:!1}),void I.setDropTarget(null);if(pt(r,a),"parent"===I.getDropType())r.setProperty(a.id,"parent",o.id),r.insertAfter(o.children,null,a.id);else{var s=st(r,o.parent);r.setProperty(a.id,"parent",s.id),r.insertAfter(s.children,o.id,a.id)}n.setState({dragTarget:null}),I.setDropTarget(null)}},n.onDrop=function(t,e){n.state.internalDrag||(t.stopPropagation(),t.preventDefault(),n.props.provider.acceptDrop(t,e),n.setState({internalDrag:!1,dragTarget:null}))},n.generateChildren=function(t,e,r){var a=n.props.provider;e.push({node:t,depth:r}),a.hasChildren(t)&&a.isExpanded(t)&&a.getChildren(t).forEach(function(t){n.generateChildren(t,e,r+1)})},n.state={root:n.props.root,dropTarget:null,selection:null,dragTarget:null,internalDrag:!1},n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"componentDidMount",value:function(){var t=this;this.listener=this.props.provider.on(B.EXPANDED_CHANGED,function(e){return t.setState({root:t.props.provider.getSceneRoot()})}),this.props.provider.on(B.STRUCTURE_ADDED,function(e){return t.setState({root:t.props.provider.getSceneRoot()})}),this.props.provider.on(B.STRUCTURE_CHANGED,function(e){return t.setState({root:t.props.provider.getSceneRoot()})}),this.other_listener=I.on(R,function(e){return t.setState({selection:e})}),I.on(P,function(e){return t.setState({dropTarget:I.getDropTarget()})})}},{key:"componentWillUnmount",value:function(){this.props.provider.off(B.EXPANDED_CHANGED,this.listener),I.off(R,this.other_listener)}},{key:"componentWillReceiveProps",value:function(t){t.root&&this.setState({root:t.root})}},{key:"render",value:function(){var t=this;if(!this.state.root)return a.a.createElement("ul",null,"no root yet");var e=[];return this.generateChildren(this.state.root,e,0),a.a.createElement("ul",{className:"tree-table"},e.map(function(e,n){return a.a.createElement(dt,{key:n,node:e.node,depth:e.depth,provider:t.props.provider,selection:t.state.selection,onDragStart:t.onDragStart,onDragOver:t.onDragOver,onDragEnd:t.onDragEnd,onDrop:t.onDrop})}))}}]),e}(r.Component),mt={PIXEL:{name:"pixel",matches:["pixel","pixels","px"],short:"px"},MILLIMETER:{name:"millimeter",matches:["mm"],short:"mm"}},vt=72;var bt=function(){function t(e,n,r){Object(i.a)(this,t),this.width=e,this.height=n,this.unit=r}return Object(c.a)(t,[{key:"as",value:function(e,n,r){if(this.unit.name===mt.MILLIMETER.name&&e.name===mt.PIXEL.name){var a=r;return new t(.0393701*this.width*a*n*1,.0393701*this.height*a*n*1,e)}return new t(this.width*n,this.height*n,e)}}]),t}(),ht=function(t){function e(t){var n;return Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this,t))).selectionChanged=function(t){return n.setState({selection:t})},n.redraw=function(){if(n.canvas){var t=n.canvas.getContext("2d"),e=n.props.prov.getPageSize(n.props.prov.getSelectedPage()).as(mt.PIXEL,n.props.scale,vt);n.canvas.width=e.width,n.canvas.height=e.height,t.fillStyle="white",t.fillRect(0,0,n.canvas.width,n.canvas.height),t.save(),t.scale(n.props.scale,n.props.scale);var r=n.props.prov.getRawGraph(),a=n.props.prov.getSelectedPage();a&&n.drawPage(t,r,a),t.fillStyle="rgba(0,255,255,0.5)",n.state.hsnap&&t.fillRect(n.state.hsnap.value-1,0,2,n.canvas.height),n.state.vsnap&&t.fillRect(0,n.state.vsnap.value-1,n.canvas.width,2),t.restore()}},n.onClick=function(t){var e=n.toCanvas(t),r=n.findShape(e);r&&n.props.onSelect(r)},n.mouseDown=function(t){n.props.prov.pauseQueue();var e=n.toCanvas(t),r=n.findShape(e);if(r){var a=st(n.props.prov.getRawGraph(),r);n.setState({pressed:!0,initial:O(a.x,a.y).minus(e),start:e,shape:r})}else{var o=n.props.prov.getSelectedLayer();o&&I.setSelection(o.id)}},n.mouseMove=function(t){if(n.state.pressed){var e=n.toCanvas(t).add(n.state.initial);e=n.snap(e);var r=n.props.prov.getRawGraph();r.process(n.props.prov.cmd.setProperty(n.state.shape,"x",e.x)),r.process(n.props.prov.cmd.setProperty(n.state.shape,"y",e.y))}},n.mouseUp=function(t){n.setState({pressed:!1,hsnap:null,vsnap:null}),n.props.prov.unpauseQueue()},n.state={pressed:!1,selection:null,shape:null,hsnap:null,vsnap:null},t.prov.onRawChange(function(t){-1!==n.props.list&&n.redraw()}),n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"componentDidMount",value:function(){I.on(R,this.selectionChanged),this.props.prov.on(B.STRUCTURE_CHANGED,this.redraw)}},{key:"componentWillUnmount",value:function(){I.off(R,this.selectionChanged),this.props.prov.off(B.STRUCTURE_CHANGED,this.redraw)}},{key:"toCanvas",value:function(t){var e=t.target.getBoundingClientRect();return O(Math.floor((t.clientX-e.left)/this.props.scale),Math.floor((t.clientY-e.top)/this.props.scale))}},{key:"componentDidUpdate",value:function(t){this.redraw()}},{key:"drawPage",value:function(t,e,n){var r=this;it(e,n.children).forEach(function(n){return r.drawLayer(t,e,st(e,n))})}},{key:"drawLayer",value:function(t,e,n){var r=this;it(e,n.children).forEach(function(n){return r.drawShape(t,e,st(e,n))})}},{key:"drawShape",value:function(t,e,n){var r=this.props.prov.getShapeDef(n.type);r&&r.draw(t,e,n,I.getSelection()===n.id,this.props.prov)}},{key:"isInside",value:function(t,e){var n=st(this.props.prov.getRawGraph(),e),r=this.props.prov.getShapeDef(n.type);return!!r&&r.isInside(t,n,this.canvas)}},{key:"findShape",value:function(t){var e=this,n=this.props.prov,r=n.getSelectedLayer();if(!r)return null;var a=it(n.getRawGraph(),r.children);return a.reverse(),a.find(function(n){return e.isInside(t,n)})}},{key:"render",value:function(){var t=this;return a.a.createElement("div",{className:"panel"},a.a.createElement("canvas",{style:{border:"0px solid red"},width:100,height:100,ref:function(e){return t.canvas=e},onClick:this.onClick,onMouseDown:this.mouseDown,onMouseUp:this.mouseUp,onMouseMove:this.mouseMove}))}},{key:"snap",value:function(t){var e={LEFT:"LEFT",RIGHT:"RIGHT",CENTER:"CENTER",TOP:"TOP",MIDDLE:"MIDDLE",BOTTOM:"BOTTOM",NONE:"NONE"},n=[{value:0,type:e.LEFT},{value:320,type:e.CENTER},{value:640,type:e.RIGHT},{value:0,type:e.TOP},{value:240,type:e.MIDDLE},{value:480,type:e.BOTTOM}],r=20;function a(t,n){return n.type===e.LEFT&&Math.abs(t.x-n.value)<r?e.LEFT:n.type===e.CENTER&&Math.abs(t.x+t.width/2-n.value)<r?e.CENTER:n.type===e.RIGHT&&Math.abs(t.x+t.width-n.value)<r?e.RIGHT:e.NONE}function o(t,n){return n.type===e.TOP&&Math.abs(t.y-n.value)<r?e.TOP:n.type===e.MIDDLE&&Math.abs(t.y+t.height/2-n.value)<r?e.MIDDLE:n.type===e.BOTTOM&&Math.abs(t.y+t.height-n.value)<r?e.BOTTOM:e.NONE}var s=st(this.props.prov.getRawGraph(),this.state.shape),i=this.props.prov.getShapeDef(s.type),c=null,u=null;if(i)for(var p=i.getBounds(t,s,this.canvas),l=0;l<n.length;l++){var d=n[l],f=a(p,d);f===e.LEFT&&(t.x=d.value),f===e.CENTER&&(t.x=d.value-p.width/2),f===e.RIGHT&&(t.x=d.value-p.width);var m=o(p,d);m===e.TOP&&(t.y=d.value),m===e.MIDDLE&&(t.y=d.value-p.height/2),m===e.BOTTOM&&(t.y=d.value-p.height),f!==e.NONE&&(c=d),m!==e.NONE&&(u=d)}return this.setState({hsnap:c,vsnap:u}),t}}]),e}(r.Component),yt=n(23),Ot=yt.SET_PROPERTY,kt=yt.CREATE_PROPERTY,wt=yt.DELETE_PROPERTY,gt=yt.CREATE_OBJECT,St=yt.DELETE_OBJECT,Ct=yt.INSERT_ELEMENT,Et=yt.DELETE_ELEMENT,Mt=function(){function t(e){Object(i.a)(this,t),this.graph=e,this.history=[],this.current=-1}return Object(c.a)(t,[{key:"submit",value:function(t){this.history.push(t),this.current=this.history.length-1}},{key:"canUndo",value:function(){return this.current>=0}},{key:"canRedo",value:function(){return this.current<this.history.length-1}},{key:"undo",value:function(){var t=this.history[this.current];if(this.current--,t.type!==Ot)if(t.type!==kt)if(t.type!==gt){if(t.type!==Ct)throw new Error("undo for type not supported: ".concat(t.type));var e={type:Et,host:this.graph.getHostId(),seq:this.graph.nextSeq(),timestamp:Date.now(),array:t.array,entry:t.entryid};this.graph.process(e)}else{var n={type:St,host:this.graph.getHostId(),seq:this.graph.nextSeq(),timestamp:Date.now(),id:t.id};this.graph.process(n)}else{var r={type:wt,host:this.graph.getHostId(),seq:this.graph.nextSeq(),timestamp:Date.now(),object:t.object,name:t.name};this.graph.process(r)}else{if(!t.prevValue)return void console.warn("undoing set property without a previous value!",t);var a={type:Ot,host:this.graph.getHostId(),seq:this.graph.nextSeq(),timestamp:Date.now(),object:t.object,name:t.name,value:t.prevValue};this.graph.process(a)}}},{key:"redo",value:function(){this.current++;var t=this.history[this.current];if(t.type!==Ot)if(t.type!==kt)if(t.type!==gt){if(t.type!==Ct)throw new Error("redo for type not supported: ".concat(t.type));console.log("redoing",t);var e={type:t.type,host:t.host,seq:this.graph.nextSeq(),timestamp:Date.now(),array:t.array,value:t.value,entryid:this.graph.makeGUID(),prev:-1};this.graph.process(e)}else{var n={type:t.type,host:t.host,seq:this.graph.nextSeq(),timestamp:Date.now(),id:t.id};this.graph.process(n)}else{var r={type:t.type,host:t.host,seq:this.graph.nextSeq(),timestamp:Date.now(),object:t.object,name:t.name,value:t.value};this.graph.process(r)}else{var a={type:t.type,host:t.host,seq:this.graph.nextSeq(),timestamp:Date.now(),object:t.object,name:t.name,value:t.value};this.graph.process(a)}}},{key:"dump",value:function(){return this.history.map(function(t,e){return e+" "+t.type+" "+t.name+" => "+t.value})}}]),t}(),jt=n(23).SET_PROPERTY,Dt=function(){function t(e){var n=this;Object(i.a)(this,t),this.onChange=function(t){return n.listeners.push(t)},this.onRawChange=function(t){return n.rawlisteners.push(t)},this.fire=function(t){return n.listeners.forEach(function(e){return e(t)})},this.fireRaw=function(t){return n.rawlisteners.forEach(function(e){return e(t)})},this.getPropertiesForObject=function(t){return n.graph.getPropertiesForObject(t)},this.getArrayLength=function(t){return n.graph.getArrayLength(t)},this.getElementAt=function(t,e){return n.graph.getElementAt(t,e)},this.getHostId=function(){return n.graph.getHostId()},this.graph=e,this.listeners=[],this.rawlisteners=[],this.paused=!1,this.buffer=[],this.first={},this.last={}}return Object(c.a)(t,[{key:"pause",value:function(){this.paused=!0}},{key:"unpause",value:function(){var t=this;this.paused=!1,this.buffer=[],Object.keys(this.last).forEach(function(e){Object.keys(t.last[e]).forEach(function(n){var r=t.last[e][n];r.prevValue=t.first[e][n].value,t.fire(r),t.graph.process(r)})}),this.first={},this.last={}}},{key:"getPropertyValue",value:function(t,e){return this.paused&&this.last[t]&&this.last[t][e]?this.last[t][e].value:this.graph.getPropertyValue(t,e)}},{key:"bufferOp",value:function(t){this.first[t.object]||(this.first[t.object]={}),this.first[t.object][t.name]||(this.first[t.object][t.name]=t),this.last[t.object]||(this.last[t.object]={}),this.last[t.object][t.name]=t,this.buffer.push(t),this.fireRaw(t)}},{key:"process",value:function(t){t.type===jt&&this.paused?this.bufferOp(t):(this.fire(t),this.graph.process(t))}}]),t}(),Rt=n(27),Pt=n(31),It=n.n(Pt);var Tt={publishKey:"pub-c-1cba58da-c59a-4b8b-b756-09e9b33b1edd",subscribeKey:"sub-c-39263f3a-f6fb-11e7-847e-5ef6eb1f4733"},xt=function(){function t(e,n){var r=this;if(Object(i.a)(this,t),!e)throw new Error("created PubnubSyncWrapper without a provider");if(!n)throw new Error("created PubnubSyncWrapper without a graph");this.paused=!1,this.buffer=[],this.provider=e,n.onChange(function(t){return r.handleGraphChange(t)}),this.pubnub=new It.a(Tt)}return Object(c.a)(t,[{key:"calculateChannelName",value:function(){return"metadoc-docupdate-"+this.provider.getDocId()+"_"+F.getServerID()}},{key:"calculateLoggerChannelName",value:function(){return"metadoc-log-"+this.provider.getDocId()+"_"+F.getServerID()}},{key:"start",value:function(){var t=this;this.pubnub.addListener({status:function(e){"PNSubscribeOperation"===e.operation&&"PNConnectedCategory"===e.category&&t.sendHistoryRequest()},message:function(e){return t.handleMessage(e)}}),this.pubnub.subscribe({channels:[this.calculateChannelName(),this.calculateLoggerChannelName()]})}},{key:"pause",value:function(){this.paused=!0}},{key:"unpause",value:function(){var t=this;this.paused=!1,this.buffer.forEach(function(e){return t.sendMessage(e)}),this.buffer=[]}},{key:"shutdown",value:function(){this.pubnub.unsubscribe({channels:[this.calculateChannelName()]}),this.pubnub.stop()}},{key:"sendMessage",value:function(t){var e,n;console.log("PN_SEND:",(n="".concat((e=t).type," ").concat(e.uuid," |  "),e.name&&(n+="".concat(e.name," = ").concat(e.value,"  prev = ").concat(e.prevValue)),n)),this.pubnub.publish({channel:this.calculateChannelName(),message:t},function(t,e){})}},{key:"handleGraphChange",value:function(t){var e=this.provider.getDataGraph().getHostId();if(t.host===e)return this.paused?this.buffer.push(t):void this.sendMessage(t)}},{key:"sendHistoryRequest",value:function(){this.pubnub.publish({channel:this.calculateChannelName(),message:{type:"GET_HISTORY",host:this.provider.getDataGraph().getHostId()}})}},{key:"handleGetHistory",value:function(){var t=this.provider.getDataGraph(),e=t.getHistory().slice();console.log(e);for(var n=0;e.length>0;){if(n>100){console.log("breaking out. possible infinite loop");break}n++;var r=e.splice(0,30);console.log("sending",r.length,r),this.pubnub.publish({channel:this.calculateChannelName(),message:{type:"SEND_HISTORY",host:t.getHostId(),history:r}},function(t,e){console.log("published",t,e)})}}},{key:"handleReceiveHistory",value:function(t){var e=this;t.history.forEach(function(t){return e.provider.getDataGraph().process(t)})}},{key:"handleMessage",value:function(t){if(!this.paused){if(t.channel!==this.calculateLoggerChannelName()){var e=this.provider.getDataGraph();if("GET_HISTORY"===t.message.type)return t.message.host!==e.getHostId()?this.handleGetHistory():void 0;if("SEND_HISTORY"===t.message.type)return t.message.host!==e.getHostId()?this.handleReceiveHistory(t.message):void 0;var n=t.message;return n.host?n.timestamp?void(n.host&&n.host===e.getHostId()||(console.log("REMOTE",n),e.process(n))):console.error("received a message without a timestamp",n):console.log("received a message without a host",n)}var r;t.publisher!==this.pubnub.getUUID()&&(t.message.length?(r=console).log.apply(r,["REMOTE LOGGER"].concat(Object(Rt.a)(t.message))):console.log("REMOTE LOGGER",t.message))}}},{key:"getLogger",value:function(){return new Nt(this.provider.getDocId(),this.pubnub)}}]),t}(),Nt=function(){function t(e,n){Object(i.a)(this,t),this.count=0,this.docid=e,this.pubnub=n||new It.a(Tt)}return Object(c.a)(t,[{key:"calculateLoggerChannelName",value:function(){return"metadoc-log-"+this.docid+"_"+F.getServerID()}},{key:"log",value:function(){var t;(t=console).log.apply(t,["LOGGER"].concat(Array.prototype.slice.call(arguments))),this.pubnub.publish({channel:this.calculateLoggerChannelName(),message:Array.from(arguments).concat(this.count++)})}},{key:"error",value:function(){var t;(t=console).log.apply(t,["LOGGER ERROR"].concat(Array.prototype.slice.call(arguments))),this.pubnub.publish({channel:this.calculateLoggerChannelName(),message:Array.from(arguments).concat(this.count++)})}}]),t}(),Gt=function(){function t(){Object(i.a)(this,t)}return Object(c.a)(t,[{key:"log",value:function(){var t;(t=console).log.apply(t,["DUMMY LOGGER"].concat(Array.prototype.slice.call(arguments)))}},{key:"error",value:function(){var t;(t=console).log.apply(t,["DUMMY LOGGER ERROR"].concat(Array.prototype.slice.call(arguments)))}}]),t}(),At=function(t){function e(){var t,n;Object(i.a)(this,e);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=Object(u.a)(this,(t=Object(p.a)(e)).call.apply(t,[this].concat(a)))).clickedScrim=function(t){t.target===n.scrim&&n.props.onScrimClick&&n.props.onScrimClick(t)},n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"render",value:function(){var t=this;if(!this.props.visible)return a.a.createElement("div",null);var e={};return this.props.width&&(e.width=this.props.width),this.props.height&&(e.height=this.props.height),a.a.createElement("div",{className:"ac-dialog-scrim",ref:function(e){return t.scrim=e},onClick:this.clickedScrim},a.a.createElement("div",{className:"ac-dialog-body",style:e},this.props.children))}}]),e}(r.Component),Ft=function(t){function e(){var t,n;Object(i.a)(this,e);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=Object(u.a)(this,(t=Object(p.a)(e)).call.apply(t,[this].concat(a)))).cancel=function(){d.b.hide()},n.okay=function(){d.b.hide(),n.props.provider.createNewDocument(n.props.docid)},n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"render",value:function(){return a.a.createElement(At,{visible:!0,onScrimClick:this.cancel},a.a.createElement(d.f,{grow:!0},a.a.createElement("h3",null,'Document "',a.a.createElement("b",null,this.props.docid),'" not found'),a.a.createElement(d.f,{grow:!0},"Create a new document?"),a.a.createElement(d.c,null,a.a.createElement("button",{onClick:this.cancel},"cancel"),a.a.createElement("button",{onClick:this.okay},"okay"))))}}]),e}(r.Component),Bt=n(23),Ut=Bt.DocGraph,Ht=Bt.CommandGenerator,Vt=Bt.toDocGraphFromObjectGraph,Wt=Bt.toObjectGraphFromDocGraph,Kt=function(t){function e(t){var n;return Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this,t))).getDocTitle=function(){return"untitled"},n.getDocHistory=function(){return n.getDataGraph().getHistory()},n.getDocGraph=function(){var t=n.getDataGraph().getObjectByProperty("type","root");return Wt(n.getDataGraph(),t)},n.onRawChange=function(t){return n.rawlisteners.push(t)},n.getRawGraph=function(){return n.coalescer},n.getDataGraph=function(){return n.syncdoc},n.getSceneRoot=function(){return n.getDataGraph().getObjectByProperty("type","root")},n.hasChildren=function(t){return t&&n.getDataGraph().hasPropertyValue(t,"children")},n.getChildren=function(t){var e=n.getDataGraph();return it(e,e.getPropertyValue(t,"children"))},n.isExpanded=function(t){return"undefined"===typeof n.expanded[t]&&(n.expanded[t]=!0),n.expanded[t]},n.save=function(t){t&&t.preventDefault();var e={history:n.getDocHistory(),type:n.getDocType(),id:n.getDocId(),graph:n.getDocGraph(),title:n.getDocTitle()},r=JSON.stringify(e);G.add("saving");var a={type:n.getDocType(),title:n.getDocTitle()},o=H()+n.getDocId()+"?"+w(a);return console.log("saving ".concat(r.length," chars to ").concat(o),e),F.fetch(o,{method:"POST",body:r,headers:{"Content-Type":"application/json"}}).then(function(t){return t.json()}).then(function(t){console.log("got back result",t),k({mode:n.mode,doc:n.getDocId(),doctype:n.getDocType()}),G.add(t.message),n.fire(B.SAVED,!0)}).catch(function(t){return console.log("error",t)})},n.docLoaded=function(){return Promise.resolve()},n.toggleConnected=function(){n.connected=!n.connected,n.pubnub&&(n.connected?n.pubnub.unpause():n.pubnub.pause()),n.fire("CONNECTED",n.connected)},n.isConnected=function(){return n.connected},n.pauseQueue=function(){return n.coalescer.pause()},n.unpauseQueue=function(){return n.coalescer.unpause()},n.performUndo=function(t){t&&t.preventDefault&&t.preventDefault(),n.undoqueue.canUndo()?n.undoqueue.undo():console.warn("at beginnning of the undo queue")},n.performRedo=function(t){t&&t.preventDefault&&t.preventDefault(),n.undoqueue.canRedo()&&n.undoqueue.redo()},n.options=t||{},n.mode=t.mode||"edit",n.datalisteners=[],n.rawlisteners=[],n.expanded={},t.doc?n.loadDoc(t.doc):n.createNewDocument(),n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"toggleItemCollapsed",value:function(t){var e=this.isExpanded(t);this.expanded[t]=!e,this.fire(B.EXPANDED_CHANGED,t)}},{key:"setPropertyValue",value:function(t,e,n){var r=this.cmd.setProperty(t,e.key,n);r.prevValue=e.value,this.getRawGraph().process(r),this.fire(B.PROPERTY_CHANGED,{provider:this,child:t,propKey:e.key,oldValue:e.value,newValue:n})}},{key:"loadDoc",value:function(t){var e=this;return F.getJSON(H()+t).then(function(n){if(console.log("got the payload",n),!n.id)return e.showMissingDocDialog(t);var r=e.makeDocFromServerHistory(n.history);return e.setupDocFlow(r,t)}).catch(function(n){return console.error("there was an error loading doc",t,n),console.log("trying to load again without the history"),F.getJSON(H()+t).then(function(n){console.log("got the payload",n);var r=e.makeDocFromServerGraph(n.graph);return e.setupDocFlow(r,t)})}).catch(function(n){console.error("there was an error loading doc",t,n);var r=new Ut;e.makeEmptyRoot(r),e.setupDocFlow(r,e.genID("doc"))})}},{key:"createNewDocument",value:function(t){t||(t=this.genID("doc"));var e=new Ut;this.makeEmptyRoot(e),this.setupDocFlow(e,t)}},{key:"setupDocFlow",value:function(t,e){var n=this;return this.pubnub&&this.pubnub.shutdown(),this.pubnub=null,this.syncdoc=t,this.cmd=new Ht(this.syncdoc),this.root=this.getSceneRoot(),this.docid=e,this.undoqueue=new Mt(t),this.coalescer=new Dt(this.syncdoc),this.coalescer.onChange(function(t){return n.undoqueue.submit(t)}),this.coalescer.onRawChange(function(t){return n.rawlisteners.forEach(function(e){return e(t)})}),this.syncdoc.onChange(function(t){return n.rawlisteners.forEach(function(e){return e(t)})}),this.syncdoc.onChange(function(t){n.fire(B.STRUCTURE_CHANGED,{provider:n}),n.fire(B.PROPERTY_CHANGED,{provider:n})}),this.fire(B.STRUCTURE_CHANGED,{provider:this}),this.fire(B.CLEAR_DIRTY,!0),I.clearSelection(),this.pubnub=new xt(this,this.syncdoc),this.pubnub.unpause(),this.pubnub.start(),this.docLoaded().then(function(){n.fire(B.DOCUMENT_SWAPPED,{provider:n}),k({mode:n.mode,doc:n.getDocId(),doctype:n.getDocType()}),n.connected=!0,n.fire("CONNECTED",n.connected)})}},{key:"reloadDocument",value:function(){var t=this;return F.getJSON(H()+this.docid).then(function(e){if(e.type!==t.getDocType())throw new Error("incorrect doctype for this provider",e.type);var n=t.makeDocFromServerHistory(e.history);t.setupDocFlow(n,t.docid)}).catch(function(e){console.error("couldn't reload the doc",e);var n=new Ut;t.makeEmptyRoot(n),t.setupDocFlow(n,t.genID("doc"))})}},{key:"duplicateDocument",value:function(t){var e=this,n=this.genID("doc");this.save().then(function(){e.docid=n,e.setDocTitle(t);var r=e.getDocGraph(),a=new Ut;Vt(r,a);return e.syncdoc=a,e.save()}).then(function(){return G.add("duplicating doc"),e.loadDoc(n)})}},{key:"makeDocFromServerHistory",value:function(t){var e=new Ut;return t.forEach(function(t){return e.process(t)}),e}},{key:"showMissingDocDialog",value:function(t){d.b.show(a.a.createElement(Ft,{docid:t,provider:this}))}},{key:"makeDocFromServerGraph",value:function(t){console.log("Making Doc from Server Graph",t);var e=new Ut;return Vt(t,e),e}}]),e}(Q),Zt=function(){function t(){var e=this;Object(i.a)(this,t),this.keyDown=function(n){var r=e.bindings.filter(function(t){return t.key===n.keyCode}).filter(function(e){var r=!0;return e.modifiers.forEach(function(e){e!==t.MODIFIERS.COMMAND||n.metaKey||(r=!1),e!==t.MODIFIERS.SHIFT||n.shiftKey||(r=!1)}),n.shiftKey&&!e.modifiers.some(function(e){return e===t.MODIFIERS.SHIFT})&&(r=!1),r});r.length>0&&e.dispatchEvents(r,n)},this.bindings=[],this.listeners={}}return Object(c.a)(t,[{key:"addKeyBinding",value:function(t){this.bindings.push(t)}},{key:"addListener",value:function(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)}},{key:"attachKeyEvents",value:function(t){t.addEventListener("keydown",this.keyDown)}},{key:"dispatchEvents",value:function(t,e){var n=this;t.forEach(function(t){n.listeners[t.id]&&n.listeners[t.id].forEach(function(t){return t?t(e):null})})}}]),t}();Zt.KEYS={S:83,Z:90,C:67,V:86,X:88,LEFT_ARROW:37,RIGHT_ARROW:39},Zt.MODIFIERS={COMMAND:"COMMAND",SHIFT:"SHIFT"};var qt=function(){function t(){Object(i.a)(this,t)}return Object(c.a)(t,[{key:"make",value:function(t,e){return st(t,t.createObject({type:"rect",title:"second rect",x:100,y:100,rx:20,ry:20,width:100,height:100,fillColor:"#ff00ff",parent:e.id}))}},{key:"draw",value:function(t,e,n,r){if(t.fillStyle="gray",t.fillStyle=n.fillColor,n.rx>0||n.ry>0){var a={x:n.x,y:n.y},o={x:n.x+n.width,y:n.y},s={x:n.x+n.width,y:n.y+n.height},i={x:n.x,y:n.y+n.height};t.beginPath(),t.moveTo(a.x+n.rx,a.y),t.lineTo(o.x-n.rx,o.y),t.quadraticCurveTo(o.x,o.y,o.x,o.y+n.ry),t.lineTo(s.x,s.y-n.ry),t.quadraticCurveTo(s.x,s.y,s.x-n.rx,s.y),t.lineTo(i.x+n.rx,i.y),t.quadraticCurveTo(i.x,i.y,i.x,i.y-n.ry),t.lineTo(a.x,a.y+n.ry),t.quadraticCurveTo(a.x,a.y,a.x+n.rx,a.y),t.closePath(),t.fill()}else t.fillRect(n.x,n.y,n.width,n.height);r&&(t.strokeStyle="red",t.strokeRect(n.x+.5,n.y+.5,n.width,n.height))}},{key:"isInside",value:function(t,e){return!(t.x<e.x)&&(!(t.x>e.x+e.width)&&(!(t.y<e.y)&&!(t.y>e.y+e.height)))}},{key:"getBounds",value:function(t,e){return{x:t.x,y:t.y,width:e.width,height:e.height}}},{key:"toSVGString",value:function(t){return'<rect x="'.concat(t.x,'" y="').concat(t.y,'" width="').concat(t.width,'" height="').concat(t.height,'" fill="').concat(t.fillColor,'"/>')}}]),t}(),Qt=function(){function t(){Object(i.a)(this,t)}return Object(c.a)(t,[{key:"make",value:function(t,e){return st(t,ot(t,{type:"circle",title:"circle",x:100,y:100,radius:50,fillColor:"#ffff00",parent:e.id}))}},{key:"draw",value:function(t,e,n,r){t.fillStyle="gray",t.fillStyle=n.fillColor,t.beginPath(),t.arc(n.x,n.y,n.radius,0,2*Math.PI),t.fill(),r&&(t.strokeStyle="red",t.strokeRect(n.x-n.radius+.5,n.y-n.radius+.5,2*n.radius,2*n.radius))}},{key:"isInside",value:function(t,e){return Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2)<Math.pow(e.radius,2)}},{key:"getBounds",value:function(t,e,n){return{x:t.x,y:t.y,width:2*e.radius,height:2*e.radius}}},{key:"toSVGString",value:function(t){return'<circle cx="'.concat(t.x,'" cy="').concat(t.y,'" r="').concat(t.radius,'" fill="').concat(t.fillColor,'"/>')}}]),t}(),zt=function(){function t(){Object(i.a)(this,t)}return Object(c.a)(t,[{key:"make",value:function(t,e){return st(t,t.createObject({type:"text",title:"text",text:"title text",horizontalAlign:_t.CENTER,verticalAlign:Lt.BASELINE,autoFit:!0,fontSize:30,fontFamily:te.SANSSERIF,fontWeight:ee.NORMAL,fontStyle:ne.NORMAL,x:100,y:100,width:200,height:120,fillColor:"#ff00ff",parent:e.id}))}},{key:"draw",value:function(t,e,n,r){var a=this.calculateLines(n,t),o=a.lines,s=a.size_px,i=a.total_height,c=a.total_width;o.forEach(function(t,e){var r=o.length*s;t.xoff=0,n.horizontalAlign===_t.LEFT&&(t.xoff=0),n.horizontalAlign===_t.CENTER&&(t.xoff=(c-t.width)/2),n.horizontalAlign===_t.RIGHT&&(t.xoff=c-t.width),n.verticalAlign===Lt.TOP&&(t.yoff=0),n.verticalAlign===Lt.CENTER&&(t.yoff=(i-r)/2),n.verticalAlign===Lt.BASELINE&&(t.yoff=i-r),n.verticalAlign===Lt.BOTTOM&&(t.yoff=i-r),t.yoff+=(e+1)*t.height}),t.fillStyle=n.fillColor,o.forEach(function(e,r){return t.fillText(e.text,n.x+e.xoff,n.y+e.yoff)}),r&&(t.strokeStyle="red",t.strokeRect(n.x+.5,n.y+.5,c,i))}},{key:"calculateLines",value:function(t,e){var n=parseFloat(t.fontSize);e.font="normal ".concat(n,"px sans-serif");var r=t.text.split("\n").map(function(t){return{text:t,width:e.measureText(t).width,height:n}}),a=0,o=0;return t.autoFit?(a=r.reduce(function(t,e){return Math.max(t,e.width)},0),o=r.reduce(function(t,e){return t+e.height},0)):(a=t.width,o=t.height),{total_width:a,total_height:o,lines:r,size_px:n}}},{key:"insideRect",value:function(t,e,n,r,a){return!(t.x<e)&&(!(t.x>e+r)&&(!(t.y<n)&&!(t.y>n+a)))}},{key:"isInside",value:function(t,e,n){var r=n.getContext("2d"),a=this.calculateLines(e,r),o=a.total_width,s=a.total_height;return this.insideRect(t,e.x,e.y,o,s)}},{key:"getBounds",value:function(t,e,n){var r=n.getContext("2d"),a=this.calculateLines(e,r),o=a.total_width,s=a.total_height;return{x:t.x,y:t.y,width:o,height:s}}},{key:"toSVGString",value:function(t){return'<text x="'.concat(t.x,'" y="').concat(t.y,'"\n                     fill="').concat(t.fillColor,'" fontSize="').concat(t.fontSize,'"\n                     fontFamily="').concat(t.fontFamily,'"\n                >').concat(t.text,"</text>")}}]),t}(),Jt=function(){function t(){Object(i.a)(this,t)}return Object(c.a)(t,[{key:"make",value:function(t,e){return st(t,t.createObject({type:"image",title:"image",x:100,y:100,width:50,height:50,asset:0,parent:e.id}))}},{key:"draw",value:function(t,e,n,r,a){if(n.asset){var o=e.getPropertyValue(n.asset,"src");a.isImageCached(o)?t.drawImage(a.getCachedImage(o),n.x,n.y,n.width,n.height):(a.requestImageCache(o),t.fillStyle="aqua",t.fillRect(n.x,n.y,n.width,n.height))}else t.fillStyle="aqua",t.fillRect(n.x,n.y,n.width,n.height);r&&(t.strokeStyle="red",t.strokeRect(n.x+.5,n.y+.5,n.width,n.height))}},{key:"isInside",value:function(t,e){return!(t.x<e.x)&&(!(t.x>e.x+e.width)&&(!(t.y<e.y)&&!(t.y>e.y+e.height)))}},{key:"toSVGString",value:function(t,e){console.log("serializing",t,e);var n=st(e.getDataGraph(),t.asset);return console.log("asset is",n),'<image xlinkHref="'.concat(n.src,'"\n                      width="').concat(t.width,'" height="').concat(t.height,'"\n        />')}}]),t}(),$t={title:{key:"title",name:"Title",type:_.STRING},x:{key:"x",name:"X",type:_.NUMBER},y:{key:"y",name:"Y",type:_.NUMBER},rx:{key:"rx",name:"RX",type:_.NUMBER},ry:{key:"ry",name:"RY",type:_.NUMBER},fillColor:{key:"fillColor",name:"color",type:_.COLOR,custom:!0},width:{key:"width",name:"Width",type:_.NUMBER},height:{key:"height",name:"Height",type:_.NUMBER},radius:{key:"radius",name:"Radius",type:_.NUMBER},text:{key:"text",name:"text",type:_.STRING,hints:{multiline:!0}},src:{key:"src",name:"src",type:_.STRING},asset:{key:"asset",name:"asset",type:_.ENUM},subtype:{key:"subtype",name:"kind",type:_.STRING,locked:!0},format:{key:"format",name:"format",type:_.STRING,locked:!0},autoFit:{key:"autoFit",name:"Size to Fit",type:_.BOOLEAN,locked:!1},fontSize:{key:"fontSize",name:"Font Size",type:_.STRING,locked:!1},fontFamily:{key:"fontFamily",name:"Font Family",type:_.ENUM,locked:!0},fontWeight:{key:"fontWeight",name:"Font Weight",type:_.ENUM,locked:!0},fontStyle:{key:"fontStyle",name:"Font Style",type:_.ENUM,locked:!0},horizontalAlign:{key:"horizontalAlign",name:"H Align",type:_.ENUM,locked:!1},verticalAlign:{key:"verticalAlign",name:"V Align",type:_.ENUM,locked:!1},pageSize:{key:"pageSize",name:"Size",type:_.STRING,locked:!1,custom:!0}},Xt={rect:new qt,circle:new Qt,text:new zt,image:new Jt},Yt={page:"file",layer:"sticky-note",rect:"square",circle:"circle",text:"font",plane:"plane",image:"image",model:"cube",cut:"cut",copy:"copy",paste:"paste",delete:"close"},Lt={TOP:"TOP",BASELINE:"BASELINE",CENTER:"CENTER",BOTTOM:"BOTTOM"},_t={LEFT:"LEFT",CENTER:"CENTER",RIGHT:"RIGHT"},te={SERIF:"serif",SANSSERIF:"sans-serif",MONOSPACE:"monospace"},ee={NORMAL:"normal",BOLD:"bold"},ne={NORMAL:"normal",ITALIC:"italic",OBLIQUE:"oblique"};function re(t){return"rect"===t||("circle"===t||("text"===t||"image"===t))}var ae,oe,se,ie,ce,ue,pe,le,de,fe,me,ve,be=n(1),he=function(){function t(){Object(i.a)(this,t)}return Object(c.a)(t,[{key:"updateProperty",value:function(t,e,n,r){if("tx"===n.name&&(t.position.x=parseFloat(n.value)),"ty"===n.name&&(t.position.y=parseFloat(n.value)),"tz"===n.name&&(t.position.z=parseFloat(n.value)),"rx"===n.name&&(t.rotation.x=parseFloat(n.value)),"ry"===n.name&&(t.rotation.y=parseFloat(n.value)),"rz"===n.name&&(t.rotation.z=parseFloat(n.value)),"sx"===n.name&&(t.scale.x=parseFloat(n.value)),"sy"===n.name&&(t.scale.y=parseFloat(n.value)),"sz"===n.name&&(t.scale.z=parseFloat(n.value)),"visible"===n.name&&(t.visible=n.value),"color"===n.name){var a=n.value;return 0===a.indexOf("#")&&(a=a.substring(1)),void t.material.color.set(parseInt(a,16))}}},{key:"reset",value:function(t,e){t.position.set(e.tx,e.ty,e.tz),t.visible=e.visible}},{key:"attachAsset",value:function(t,e,n){e.asset!==$e.id?n.assetsManager.getTexture(e.asset).then(function(r){n.getLogger().log("loadded asset",e.asset),n.getLogger().log(r),r||n.getLogger().error("error loading asset",e.asset);var a={color:e.color,side:be.DoubleSide,map:r};e.transparent&&(a.transparent=!0,a.alphaTest=.5),t.material=new be.MeshLambertMaterial(a)}).catch(function(t){n.getLogger().error("error somwhere",t.message,t)}):t.material=new be.MeshLambertMaterial({color:e.color,side:be.DoubleSide})}}]),t}(),ye=0,Oe=function(t){function e(){return Object(i.a)(this,e),Object(u.a)(this,Object(p.a)(e).apply(this,arguments))}return Object(l.a)(e,t),Object(c.a)(e,[{key:"make",value:function(t,e){if(!e.id)throw new Error("can't create cube w/ missing parent");return st(t,t.createObject({type:_e.cube,title:"cube "+ye++,visible:!0,width:.3,height:.3,depth:.3,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,color:"#00ff00",children:t.createArray(),asset:$e.id,transparent:!1,parent:e.id}))}},{key:"makeNode",value:function(t,e){var n=new be.Mesh(new be.BoxGeometry(t.width,t.height,t.depth),new be.MeshLambertMaterial({color:t.color}));return n.name=t.title,n.userData.clickable=!0,n.position.set(t.tx,t.ty,t.tz),n.rotation.set(t.rx,t.ry,t.rz),n.scale.set(t.sx,t.sy,t.sz),n.visible=t.visible,this.attachAsset(n,t,e),n}},{key:"updateProperty",value:function(t,n,r,a){if("width"!==r.name&&"height"!==r.name&&"depth"!==r.name)return r.name===Ye.asset.key||r.name===Ye.transparent.key?this.attachAsset(t,n,a):Object(f.a)(Object(p.a)(e.prototype),"updateProperty",this).call(this,t,n,r,a);t.geometry=new be.BoxGeometry(n.width,n.height,n.depth)}}]),e}(he),ke=function(t){function e(){return Object(i.a)(this,e),Object(u.a)(this,Object(p.a)(e).apply(this,arguments))}return Object(l.a)(e,t),Object(c.a)(e,[{key:"make",value:function(t,e){if(!e.id)throw new Error("can't create sphere w/ missing parent");return st(t,t.createObject({type:"sphere",title:"a sphere",visible:!0,radius:.15,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,color:"#0000ff",children:t.createArray(),asset:$e.id,transparent:!1,parent:e.id}))}},{key:"makeNode",value:function(t,e){var n=new be.Mesh(new be.SphereBufferGeometry(t.radius),new be.MeshLambertMaterial({color:t.color}));return n.name=t.title,n.userData.clickable=!0,n.position.set(t.tx,t.ty,t.tz),n.rotation.set(t.rx,t.ry,t.rz),n.scale.set(t.sx,t.sy,t.sz),n.visible=t.visible,this.attachAsset(n,t,e),n}},{key:"updateProperty",value:function(t,n,r,a){return"radius"===r.name&&(t.geometry=new be.SphereBufferGeometry(r.value)),r.name===Ye.asset.key||r.name===Ye.transparent.key?this.attachAsset(t,n,a):Object(f.a)(Object(p.a)(e.prototype),"updateProperty",this).call(this,t,n,r,a)}}]),e}(he),we=function(t){function e(){return Object(i.a)(this,e),Object(u.a)(this,Object(p.a)(e).apply(this,arguments))}return Object(l.a)(e,t),Object(c.a)(e,[{key:"make",value:function(t,e){if(!e.id)throw new Error("can't create plane w/ missing parent");return st(t,t.createObject({type:"plane",title:"a plane",visible:!0,width:.5,height:.5,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,color:"#ffffff",children:t.createArray(),asset:$e.id,transparent:!1,parent:e.id}))}},{key:"makeNode",value:function(t,e){var n=new be.Mesh(new be.PlaneBufferGeometry(t.width,t.height),new be.MeshLambertMaterial({color:t.color,side:be.DoubleSide}));return this.attachAsset(n,t,e),n.userData.clickable=!0,n.position.set(t.tx,t.ty,t.tz),n.rotation.set(t.rx,t.ry,t.rz),n.scale.set(t.sx,t.sy,t.sz),n.visible=t.visible,n}},{key:"updateProperty",value:function(t,n,r,a){return"width"===r.name&&(t.geometry=new be.PlaneBufferGeometry(r.value,n.height)),"height"===r.name&&(t.geometry=new be.PlaneBufferGeometry(n.width,r.value)),r.name===Ye.asset.key||r.name===Ye.transparent.key?this.attachAsset(t,n,a):Object(f.a)(Object(p.a)(e.prototype),"updateProperty",this).call(this,t,n,r,a)}}]),e}(he),ge=n(1),Se=function(){function t(t){this.manager=void 0!==t?t:ge.DefaultLoadingManager,this.dracoLoader=null}function e(){var t={};return{get:function(e){return t[e]},add:function(e,n){t[e]=n},remove:function(e){delete t[e]},removeAll:function(){t={}}}}t.prototype={constructor:t,crossOrigin:"anonymous",load:function(t,e,n,r){var a,o=this;a=void 0!==this.resourcePath?this.resourcePath:void 0!==this.path?this.path:ge.LoaderUtils.extractUrlBase(t),o.manager.itemStart(t);var s=function(e){r?r(e):console.error(e),o.manager.itemError(t),o.manager.itemEnd(t)},i=new ge.FileLoader(o.manager);i.setPath(this.path),i.setResponseType("arraybuffer"),i.load(t,function(n){try{o.parse(n,a,function(n){e(n),o.manager.itemEnd(t)},s)}catch(r){s(r)}},n,s)},setCrossOrigin:function(t){return this.crossOrigin=t,this},setPath:function(t){return this.path=t,this},setResourcePath:function(t){return this.resourcePath=t,this},setDRACOLoader:function(t){return this.dracoLoader=t,this},parse:function(t,e,i,c){var f,m={};if("string"===typeof t)f=t;else if(ge.LoaderUtils.decodeText(new Uint8Array(t,0,4))===s){try{m[n.KHR_BINARY_GLTF]=new u(t)}catch(O){return void(c&&c(O))}f=m[n.KHR_BINARY_GLTF].content}else f=ge.LoaderUtils.decodeText(new Uint8Array(t));var v=JSON.parse(f);if(void 0===v.asset||v.asset.version[0]<2)c&&c(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported. Use LegacyGLTFLoader instead."));else{if(v.extensionsUsed)for(var b=0;b<v.extensionsUsed.length;++b){var h=v.extensionsUsed[b],y=v.extensionsRequired||[];switch(h){case n.KHR_LIGHTS_PUNCTUAL:m[h]=new a(v);break;case n.KHR_MATERIALS_UNLIT:m[h]=new o(v);break;case n.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:m[h]=new d(v);break;case n.KHR_DRACO_MESH_COMPRESSION:m[h]=new p(v,this.dracoLoader);break;case n.MSFT_TEXTURE_DDS:m[n.MSFT_TEXTURE_DDS]=new r;break;case n.KHR_TEXTURE_TRANSFORM:m[n.KHR_TEXTURE_TRANSFORM]=new l(v);break;default:y.indexOf(h)>=0&&console.warn('THREE.GLTFLoader: Unknown extension "'+h+'".')}}new U(v,m,{path:e||this.resourcePath||"",crossOrigin:this.crossOrigin,manager:this.manager}).parse(i,c)}}};var n={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",MSFT_TEXTURE_DDS:"MSFT_texture_dds"};function r(){if(!ge.DDSLoader)throw new Error("THREE.GLTFLoader: Attempting to load .dds texture without importing THREE.DDSLoader");this.name=n.MSFT_TEXTURE_DDS,this.ddsLoader=new ge.DDSLoader}function a(t){this.name=n.KHR_LIGHTS_PUNCTUAL;var e=t.extensions&&t.extensions[n.KHR_LIGHTS_PUNCTUAL]||{};this.lightDefs=e.lights||[]}function o(){this.name=n.KHR_MATERIALS_UNLIT}a.prototype.loadLight=function(t){var e,n=this.lightDefs[t],r=new ge.Color(16777215);void 0!==n.color&&r.fromArray(n.color);var a=void 0!==n.range?n.range:0;switch(n.type){case"directional":(e=new ge.DirectionalLight(r)).target.position.set(0,0,-1),e.add(e.target);break;case"point":(e=new ge.PointLight(r)).distance=a;break;case"spot":(e=new ge.SpotLight(r)).distance=a,n.spot=n.spot||{},n.spot.innerConeAngle=void 0!==n.spot.innerConeAngle?n.spot.innerConeAngle:0,n.spot.outerConeAngle=void 0!==n.spot.outerConeAngle?n.spot.outerConeAngle:Math.PI/4,e.angle=n.spot.outerConeAngle,e.penumbra=1-n.spot.innerConeAngle/n.spot.outerConeAngle,e.target.position.set(0,0,-1),e.add(e.target);break;default:throw new Error('THREE.GLTFLoader: Unexpected light type, "'+n.type+'".')}return e.position.set(0,0,0),e.decay=2,void 0!==n.intensity&&(e.intensity=n.intensity),e.name=n.name||"light_"+t,Promise.resolve(e)},o.prototype.getMaterialType=function(){return ge.MeshBasicMaterial},o.prototype.extendParams=function(t,e,n){var r=[];t.color=new ge.Color(1,1,1),t.opacity=1;var a=e.pbrMetallicRoughness;if(a){if(Array.isArray(a.baseColorFactor)){var o=a.baseColorFactor;t.color.fromArray(o),t.opacity=o[3]}void 0!==a.baseColorTexture&&r.push(n.assignTexture(t,"map",a.baseColorTexture))}return Promise.all(r)};var s="glTF",i=12,c={JSON:1313821514,BIN:5130562};function u(t){this.name=n.KHR_BINARY_GLTF,this.content=null,this.body=null;var e=new DataView(t,0,i);if(this.header={magic:ge.LoaderUtils.decodeText(new Uint8Array(t.slice(0,4))),version:e.getUint32(4,!0),length:e.getUint32(8,!0)},this.header.magic!==s)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected. Use LegacyGLTFLoader instead.");for(var r=new DataView(t,i),a=0;a<r.byteLength;){var o=r.getUint32(a,!0);a+=4;var u=r.getUint32(a,!0);if(a+=4,u===c.JSON){var p=new Uint8Array(t,i+a,o);this.content=ge.LoaderUtils.decodeText(p)}else if(u===c.BIN){var l=i+a;this.body=t.slice(l,l+o)}a+=o}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}function p(t,e){if(!e)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=n.KHR_DRACO_MESH_COMPRESSION,this.json=t,this.dracoLoader=e}function l(){this.name=n.KHR_TEXTURE_TRANSFORM}function d(){return{name:n.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,specularGlossinessParams:["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"],getMaterialType:function(){return ge.ShaderMaterial},extendParams:function(t,e,n){var r=e.extensions[this.name],a=ge.ShaderLib.standard,o=ge.UniformsUtils.clone(a.uniforms),s=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),i=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),c=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),u=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),p=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb;","material.specularRoughness = clamp( 1.0 - glossinessFactor, 0.04, 1.0 );","material.specularColor = specularFactor.rgb;"].join("\n"),l=a.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",s).replace("#include <metalnessmap_pars_fragment>",i).replace("#include <roughnessmap_fragment>",c).replace("#include <metalnessmap_fragment>",u).replace("#include <lights_physical_fragment>",p);delete o.roughness,delete o.metalness,delete o.roughnessMap,delete o.metalnessMap,o.specular={value:(new ge.Color).setHex(1118481)},o.glossiness={value:.5},o.specularMap={value:null},o.glossinessMap={value:null},t.vertexShader=a.vertexShader,t.fragmentShader=l,t.uniforms=o,t.defines={STANDARD:""},t.color=new ge.Color(1,1,1),t.opacity=1;var d=[];if(Array.isArray(r.diffuseFactor)){var f=r.diffuseFactor;t.color.fromArray(f),t.opacity=f[3]}if(void 0!==r.diffuseTexture&&d.push(n.assignTexture(t,"map",r.diffuseTexture)),t.emissive=new ge.Color(0,0,0),t.glossiness=void 0!==r.glossinessFactor?r.glossinessFactor:1,t.specular=new ge.Color(1,1,1),Array.isArray(r.specularFactor)&&t.specular.fromArray(r.specularFactor),void 0!==r.specularGlossinessTexture){var m=r.specularGlossinessTexture;d.push(n.assignTexture(t,"glossinessMap",m)),d.push(n.assignTexture(t,"specularMap",m))}return Promise.all(d)},createMaterial:function(t){var e=new ge.ShaderMaterial({defines:t.defines,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader,uniforms:t.uniforms,fog:!0,lights:!0,opacity:t.opacity,transparent:t.transparent});return e.isGLTFSpecularGlossinessMaterial=!0,e.color=t.color,e.map=void 0===t.map?null:t.map,e.lightMap=null,e.lightMapIntensity=1,e.aoMap=void 0===t.aoMap?null:t.aoMap,e.aoMapIntensity=1,e.emissive=t.emissive,e.emissiveIntensity=1,e.emissiveMap=void 0===t.emissiveMap?null:t.emissiveMap,e.bumpMap=void 0===t.bumpMap?null:t.bumpMap,e.bumpScale=1,e.normalMap=void 0===t.normalMap?null:t.normalMap,t.normalScale&&(e.normalScale=t.normalScale),e.displacementMap=null,e.displacementScale=1,e.displacementBias=0,e.specularMap=void 0===t.specularMap?null:t.specularMap,e.specular=t.specular,e.glossinessMap=void 0===t.glossinessMap?null:t.glossinessMap,e.glossiness=t.glossiness,e.alphaMap=null,e.envMap=void 0===t.envMap?null:t.envMap,e.envMapIntensity=1,e.refractionRatio=.98,e.extensions.derivatives=!0,e},cloneMaterial:function(t){var e=t.clone();e.isGLTFSpecularGlossinessMaterial=!0;for(var n=this.specularGlossinessParams,r=0,a=n.length;r<a;r++)e[n[r]]=t[n[r]];return e},refreshUniforms:function(t,e,n,r,a,o){if(!0===a.isGLTFSpecularGlossinessMaterial){var s,i=a.uniforms,c=a.defines;i.opacity.value=a.opacity,i.diffuse.value.copy(a.color),i.emissive.value.copy(a.emissive).multiplyScalar(a.emissiveIntensity),i.map.value=a.map,i.specularMap.value=a.specularMap,i.alphaMap.value=a.alphaMap,i.lightMap.value=a.lightMap,i.lightMapIntensity.value=a.lightMapIntensity,i.aoMap.value=a.aoMap,i.aoMapIntensity.value=a.aoMapIntensity,a.map?s=a.map:a.specularMap?s=a.specularMap:a.displacementMap?s=a.displacementMap:a.normalMap?s=a.normalMap:a.bumpMap?s=a.bumpMap:a.glossinessMap?s=a.glossinessMap:a.alphaMap?s=a.alphaMap:a.emissiveMap&&(s=a.emissiveMap),void 0!==s&&(s.isWebGLRenderTarget&&(s=s.texture),!0===s.matrixAutoUpdate&&s.updateMatrix(),i.uvTransform.value.copy(s.matrix)),a.envMap&&(i.envMap.value=a.envMap,i.envMapIntensity.value=a.envMapIntensity,i.flipEnvMap.value=a.envMap.isCubeTexture?-1:1,i.reflectivity.value=a.reflectivity,i.refractionRatio.value=a.refractionRatio,i.maxMipLevel.value=t.properties.get(a.envMap).__maxMipLevel),i.specular.value.copy(a.specular),i.glossiness.value=a.glossiness,i.glossinessMap.value=a.glossinessMap,i.emissiveMap.value=a.emissiveMap,i.bumpMap.value=a.bumpMap,i.normalMap.value=a.normalMap,i.displacementMap.value=a.displacementMap,i.displacementScale.value=a.displacementScale,i.displacementBias.value=a.displacementBias,null!==i.glossinessMap.value&&void 0===c.USE_GLOSSINESSMAP&&(c.USE_GLOSSINESSMAP="",c.USE_ROUGHNESSMAP=""),null===i.glossinessMap.value&&void 0!==c.USE_GLOSSINESSMAP&&(delete c.USE_GLOSSINESSMAP,delete c.USE_ROUGHNESSMAP)}}}}function f(t,e,n,r){ge.Interpolant.call(this,t,e,n,r)}p.prototype.decodePrimitive=function(t,e){var n=this.json,r=this.dracoLoader,a=t.extensions[this.name].bufferView,o=t.extensions[this.name].attributes,s={},i={},c={};for(var u in o){var p=M[u]||u.toLowerCase();s[p]=o[u]}for(u in t.attributes){p=M[u]||u.toLowerCase();if(void 0!==o[u]){var l=n.accessors[t.attributes[u]],d=g[l.componentType];c[p]=d,i[p]=!0===l.normalized}}return e.getDependency("bufferView",a).then(function(t){return new Promise(function(e){r.decodeDracoFile(t,function(t){for(var n in t.attributes){var r=t.attributes[n],a=i[n];void 0!==a&&(r.normalized=a)}e(t)},s,c)})})},l.prototype.extendTexture=function(t,e){return t=t.clone(),void 0!==e.offset&&t.offset.fromArray(e.offset),void 0!==e.rotation&&(t.rotation=e.rotation),void 0!==e.scale&&t.repeat.fromArray(e.scale),void 0!==e.texCoord&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),t.needsUpdate=!0,t},f.prototype=Object.create(ge.Interpolant.prototype),f.prototype.constructor=f,f.prototype.copySampleValue_=function(t){for(var e=this.resultBuffer,n=this.sampleValues,r=this.valueSize,a=t*r*3+r,o=0;o!==r;o++)e[o]=n[a+o];return e},f.prototype.beforeStart_=f.prototype.copySampleValue_,f.prototype.afterEnd_=f.prototype.copySampleValue_,f.prototype.interpolate_=function(t,e,n,r){for(var a=this.resultBuffer,o=this.sampleValues,s=this.valueSize,i=2*s,c=3*s,u=r-e,p=(n-e)/u,l=p*p,d=l*p,f=t*c,m=f-c,v=-2*d+3*l,b=d-l,h=1-v,y=b-l+p,O=0;O!==s;O++){var k=o[m+O+s],w=o[m+O+i]*u,g=o[f+O+s],S=o[f+O]*u;a[O]=h*k+y*w+v*g+b*S}return a};var m,v=0,b=1,h=2,y=3,O=4,k=5,w=6,g=(Number,ge.Matrix3,ge.Matrix4,ge.Vector2,ge.Vector3,ge.Vector4,ge.Texture,{5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array}),S={9728:ge.NearestFilter,9729:ge.LinearFilter,9984:ge.NearestMipMapNearestFilter,9985:ge.LinearMipMapNearestFilter,9986:ge.NearestMipMapLinearFilter,9987:ge.LinearMipMapLinearFilter},C={33071:ge.ClampToEdgeWrapping,33648:ge.MirroredRepeatWrapping,10497:ge.RepeatWrapping},E=(ge.BackSide,ge.FrontSide,ge.NeverDepth,ge.LessDepth,ge.EqualDepth,ge.LessEqualDepth,ge.GreaterEqualDepth,ge.NotEqualDepth,ge.GreaterEqualDepth,ge.AlwaysDepth,ge.AddEquation,ge.SubtractEquation,ge.ReverseSubtractEquation,ge.ZeroFactor,ge.OneFactor,ge.SrcColorFactor,ge.OneMinusSrcColorFactor,ge.SrcAlphaFactor,ge.OneMinusSrcAlphaFactor,ge.DstAlphaFactor,ge.OneMinusDstAlphaFactor,ge.DstColorFactor,ge.OneMinusDstColorFactor,ge.SrcAlphaSaturateFactor,{SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16}),M={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},j={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},D={CUBICSPLINE:void 0,LINEAR:ge.InterpolateLinear,STEP:ge.InterpolateDiscrete},R="OPAQUE",P="MASK",I="BLEND",T={"image/png":ge.RGBAFormat,"image/jpeg":ge.RGBFormat};function x(t,e){return"string"!==typeof t||""===t?"":/^(https?:)?\/\//i.test(t)?t:/^data:.*,.*$/i.test(t)?t:/^blob:.*$/i.test(t)?t:e+t}function N(t,e,n){for(var r in n.extensions)void 0===t[r]&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[r]=n.extensions[r])}function G(t,e){void 0!==e.extras&&("object"===typeof e.extras?t.userData=e.extras:console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function A(t,e){if(t.updateMorphTargets(),void 0!==e.weights)for(var n=0,r=e.weights.length;n<r;n++)t.morphTargetInfluences[n]=e.weights[n];if(e.extras&&Array.isArray(e.extras.targetNames)){var a=e.extras.targetNames;if(t.morphTargetInfluences.length===a.length){t.morphTargetDictionary={};for(n=0,r=a.length;n<r;n++)t.morphTargetDictionary[a[n]]=n}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function F(t){for(var e="",n=Object.keys(t).sort(),r=0,a=n.length;r<a;r++)e+=n[r]+":"+t[n[r]]+";";return e}function B(t){if(t.isInterleavedBufferAttribute){for(var e=t.count,n=t.itemSize,r=t.array.slice(0,e*n),a=0,o=0;a<e;++a)r[o++]=t.getX(a),n>=2&&(r[o++]=t.getY(a)),n>=3&&(r[o++]=t.getZ(a)),n>=4&&(r[o++]=t.getW(a));return new ge.BufferAttribute(r,n,t.normalized)}return t.clone()}function U(t,n,r){this.json=t||{},this.extensions=n||{},this.options=r||{},this.cache=new e,this.primitiveCache={},this.textureLoader=new ge.TextureLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.fileLoader=new ge.FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer")}function H(t,e,n){var r=e.attributes,a=[];function o(e,r){return n.getDependency("accessor",e).then(function(e){t.addAttribute(r,e)})}for(var s in r){var i=M[s]||s.toLowerCase();i in t.attributes||a.push(o(r[s],i))}if(void 0!==e.indices&&!t.index){var c=n.getDependency("accessor",e.indices).then(function(e){t.setIndex(e)});a.push(c)}return G(t,e),Promise.all(a).then(function(){return void 0!==e.targets?function(t,e,n){for(var r=!1,a=!1,o=0,s=e.length;o<s&&(void 0!==(u=e[o]).POSITION&&(r=!0),void 0!==u.NORMAL&&(a=!0),!r||!a);o++);if(!r&&!a)return Promise.resolve(t);var i=[],c=[];for(o=0,s=e.length;o<s;o++){var u=e[o];if(r){var p=void 0!==u.POSITION?n.getDependency("accessor",u.POSITION):t.attributes.position;i.push(p)}a&&(p=void 0!==u.NORMAL?n.getDependency("accessor",u.NORMAL):t.attributes.normal,c.push(p))}return Promise.all([Promise.all(i),Promise.all(c)]).then(function(n){for(var o=n[0],s=n[1],i=0,c=o.length;i<c;i++)t.attributes.position!==o[i]&&(o[i]=B(o[i]));for(i=0,c=s.length;i<c;i++)t.attributes.normal!==s[i]&&(s[i]=B(s[i]));for(i=0,c=e.length;i<c;i++){var u=e[i],p="morphTarget"+i;if(r&&void 0!==u.POSITION){var l=o[i];l.name=p;for(var d=t.attributes.position,f=0,m=l.count;f<m;f++)l.setXYZ(f,l.getX(f)+d.getX(f),l.getY(f)+d.getY(f),l.getZ(f)+d.getZ(f))}if(a&&void 0!==u.NORMAL){var v=s[i];v.name=p;var b=t.attributes.normal;for(f=0,m=v.count;f<m;f++)v.setXYZ(f,v.getX(f)+b.getX(f),v.getY(f)+b.getY(f),v.getZ(f)+b.getZ(f))}}return r&&(t.morphAttributes.position=o),a&&(t.morphAttributes.normal=s),t})}(t,e.targets,n):t})}return U.prototype.parse=function(t,e){var n=this,r=this.json,a=this.extensions;this.cache.removeAll(),this.markDefs(),Promise.all([this.getDependencies("scene"),this.getDependencies("animation"),this.getDependencies("camera")]).then(function(e){var o={scene:e[0][r.scene||0],scenes:e[0],animations:e[1],cameras:e[2],asset:r.asset,parser:n,userData:{}};N(a,o,r),t(o)}).catch(e)},U.prototype.markDefs=function(){for(var t=this.json.nodes||[],e=this.json.skins||[],n=this.json.meshes||[],r={},a={},o=0,s=e.length;o<s;o++)for(var i=e[o].joints,c=0,u=i.length;c<u;c++)t[i[c]].isBone=!0;for(var p=0,l=t.length;p<l;p++){var d=t[p];void 0!==d.mesh&&(void 0===r[d.mesh]&&(r[d.mesh]=a[d.mesh]=0),r[d.mesh]++,void 0!==d.skin&&(n[d.mesh].isSkinnedMesh=!0))}this.json.meshReferences=r,this.json.meshUses=a},U.prototype.getDependency=function(t,e){var r=t+":"+e,a=this.cache.get(r);if(!a){switch(t){case"scene":a=this.loadScene(e);break;case"node":a=this.loadNode(e);break;case"mesh":a=this.loadMesh(e);break;case"accessor":a=this.loadAccessor(e);break;case"bufferView":a=this.loadBufferView(e);break;case"buffer":a=this.loadBuffer(e);break;case"material":a=this.loadMaterial(e);break;case"texture":a=this.loadTexture(e);break;case"skin":a=this.loadSkin(e);break;case"animation":a=this.loadAnimation(e);break;case"camera":a=this.loadCamera(e);break;case"light":a=this.extensions[n.KHR_LIGHTS_PUNCTUAL].loadLight(e);break;default:throw new Error("Unknown type: "+t)}this.cache.add(r,a)}return a},U.prototype.getDependencies=function(t){var e=this.cache.get(t);if(!e){var n=this,r=this.json[t+("mesh"===t?"es":"s")]||[];e=Promise.all(r.map(function(e,r){return n.getDependency(t,r)})),this.cache.add(t,e)}return e},U.prototype.loadBuffer=function(t){var e=this.json.buffers[t],r=this.fileLoader;if(e.type&&"arraybuffer"!==e.type)throw new Error("THREE.GLTFLoader: "+e.type+" buffer type is not supported.");if(void 0===e.uri&&0===t)return Promise.resolve(this.extensions[n.KHR_BINARY_GLTF].body);var a=this.options;return new Promise(function(t,n){r.load(x(e.uri,a.path),t,void 0,function(){n(new Error('THREE.GLTFLoader: Failed to load buffer "'+e.uri+'".'))})})},U.prototype.loadBufferView=function(t){var e=this.json.bufferViews[t];return this.getDependency("buffer",e.buffer).then(function(t){var n=e.byteLength||0,r=e.byteOffset||0;return t.slice(r,r+n)})},U.prototype.loadAccessor=function(t){var e=this,n=this.json,r=this.json.accessors[t];if(void 0===r.bufferView&&void 0===r.sparse)return Promise.resolve(null);var a=[];return void 0!==r.bufferView?a.push(this.getDependency("bufferView",r.bufferView)):a.push(null),void 0!==r.sparse&&(a.push(this.getDependency("bufferView",r.sparse.indices.bufferView)),a.push(this.getDependency("bufferView",r.sparse.values.bufferView))),Promise.all(a).then(function(t){var a,o,s=t[0],i=E[r.type],c=g[r.componentType],u=c.BYTES_PER_ELEMENT,p=u*i,l=r.byteOffset||0,d=void 0!==r.bufferView?n.bufferViews[r.bufferView].byteStride:void 0,f=!0===r.normalized;if(d&&d!==p){var m="InterleavedBuffer:"+r.bufferView+":"+r.componentType,v=e.cache.get(m);v||(a=new c(s),v=new ge.InterleavedBuffer(a,d/u),e.cache.add(m,v)),o=new ge.InterleavedBufferAttribute(v,i,l/u,f)}else a=null===s?new c(r.count*i):new c(s,l,r.count*i),o=new ge.BufferAttribute(a,i,f);if(void 0!==r.sparse){var b=E.SCALAR,h=g[r.sparse.indices.componentType],y=r.sparse.indices.byteOffset||0,O=r.sparse.values.byteOffset||0,k=new h(t[1],y,r.sparse.count*b),w=new c(t[2],O,r.sparse.count*i);null!==s&&o.setArray(o.array.slice());for(var S=0,C=k.length;S<C;S++){var M=k[S];if(o.setX(M,w[S*i]),i>=2&&o.setY(M,w[S*i+1]),i>=3&&o.setZ(M,w[S*i+2]),i>=4&&o.setW(M,w[S*i+3]),i>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return o})},U.prototype.loadTexture=function(t){var e,r=this,a=this.json,o=this.options,s=this.textureLoader,i=window.URL||window.webkitURL,c=a.textures[t],u=c.extensions||{},p=(e=u[n.MSFT_TEXTURE_DDS]?a.images[u[n.MSFT_TEXTURE_DDS].source]:a.images[c.source]).uri,l=!1;return void 0!==e.bufferView&&(p=r.getDependency("bufferView",e.bufferView).then(function(t){l=!0;var n=new Blob([t],{type:e.mimeType});return p=i.createObjectURL(n)})),Promise.resolve(p).then(function(t){var e=ge.Loader.Handlers.get(t);return e||(e=u[n.MSFT_TEXTURE_DDS]?r.extensions[n.MSFT_TEXTURE_DDS].ddsLoader:s),new Promise(function(n,r){e.load(x(t,o.path),n,void 0,r)})}).then(function(t){!0===l&&i.revokeObjectURL(p),t.flipY=!1,void 0!==c.name&&(t.name=c.name),e.mimeType in T&&(t.format=T[e.mimeType]);var n=(a.samplers||{})[c.sampler]||{};return t.magFilter=S[n.magFilter]||ge.LinearFilter,t.minFilter=S[n.minFilter]||ge.LinearMipMapLinearFilter,t.wrapS=C[n.wrapS]||ge.RepeatWrapping,t.wrapT=C[n.wrapT]||ge.RepeatWrapping,t})},U.prototype.assignTexture=function(t,e,r){var a=this;return this.getDependency("texture",r.index).then(function(o){if(!o.isCompressedTexture)switch(e){case"aoMap":case"emissiveMap":case"metalnessMap":case"normalMap":case"roughnessMap":o.format=ge.RGBFormat}if(a.extensions[n.KHR_TEXTURE_TRANSFORM]){var s=void 0!==r.extensions?r.extensions[n.KHR_TEXTURE_TRANSFORM]:void 0;s&&(o=a.extensions[n.KHR_TEXTURE_TRANSFORM].extendTexture(o,s))}t[e]=o})},U.prototype.assignFinalMaterial=function(t){var e=t.geometry,r=t.material,a=this.extensions,o=void 0!==e.attributes.tangent,s=void 0!==e.attributes.color,i=void 0===e.attributes.normal,c=!0===t.isSkinnedMesh,u=Object.keys(e.morphAttributes).length>0,p=u&&void 0!==e.morphAttributes.normal;if(t.isPoints){var l="PointsMaterial:"+r.uuid,d=this.cache.get(l);d||(d=new ge.PointsMaterial,ge.Material.prototype.copy.call(d,r),d.color.copy(r.color),d.map=r.map,d.lights=!1,this.cache.add(l,d)),r=d}else if(t.isLine){l="LineBasicMaterial:"+r.uuid;var f=this.cache.get(l);f||(f=new ge.LineBasicMaterial,ge.Material.prototype.copy.call(f,r),f.color.copy(r.color),f.lights=!1,this.cache.add(l,f)),r=f}if(o||s||i||c||u){l="ClonedMaterial:"+r.uuid+":";r.isGLTFSpecularGlossinessMaterial&&(l+="specular-glossiness:"),c&&(l+="skinning:"),o&&(l+="vertex-tangents:"),s&&(l+="vertex-colors:"),i&&(l+="flat-shading:"),u&&(l+="morph-targets:"),p&&(l+="morph-normals:");var m=this.cache.get(l);m||(m=r.isGLTFSpecularGlossinessMaterial?a[n.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].cloneMaterial(r):r.clone(),c&&(m.skinning=!0),o&&(m.vertexTangents=!0),s&&(m.vertexColors=ge.VertexColors),i&&(m.flatShading=!0),u&&(m.morphTargets=!0),p&&(m.morphNormals=!0),this.cache.add(l,m)),r=m}r.aoMap&&void 0===e.attributes.uv2&&void 0!==e.attributes.uv&&(console.log("THREE.GLTFLoader: Duplicating UVs to support aoMap."),e.addAttribute("uv2",new ge.BufferAttribute(e.attributes.uv.array,2))),r.isGLTFSpecularGlossinessMaterial&&(t.onBeforeRender=a[n.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].refreshUniforms),t.material=r},U.prototype.loadMaterial=function(t){var e,r=this.json,a=this.extensions,o=r.materials[t],s={},i=o.extensions||{},c=[];if(i[n.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){var u=a[n.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];e=u.getMaterialType(),c.push(u.extendParams(s,o,this))}else if(i[n.KHR_MATERIALS_UNLIT]){var p=a[n.KHR_MATERIALS_UNLIT];e=p.getMaterialType(),c.push(p.extendParams(s,o,this))}else{e=ge.MeshStandardMaterial;var l=o.pbrMetallicRoughness||{};if(s.color=new ge.Color(1,1,1),s.opacity=1,Array.isArray(l.baseColorFactor)){var d=l.baseColorFactor;s.color.fromArray(d),s.opacity=d[3]}void 0!==l.baseColorTexture&&c.push(this.assignTexture(s,"map",l.baseColorTexture)),s.metalness=void 0!==l.metallicFactor?l.metallicFactor:1,s.roughness=void 0!==l.roughnessFactor?l.roughnessFactor:1,void 0!==l.metallicRoughnessTexture&&(c.push(this.assignTexture(s,"metalnessMap",l.metallicRoughnessTexture)),c.push(this.assignTexture(s,"roughnessMap",l.metallicRoughnessTexture)))}!0===o.doubleSided&&(s.side=ge.DoubleSide);var f=o.alphaMode||R;return f===I?s.transparent=!0:(s.transparent=!1,f===P&&(s.alphaTest=void 0!==o.alphaCutoff?o.alphaCutoff:.5)),void 0!==o.normalTexture&&e!==ge.MeshBasicMaterial&&(c.push(this.assignTexture(s,"normalMap",o.normalTexture)),s.normalScale=new ge.Vector2(1,1),void 0!==o.normalTexture.scale&&s.normalScale.set(o.normalTexture.scale,o.normalTexture.scale)),void 0!==o.occlusionTexture&&e!==ge.MeshBasicMaterial&&(c.push(this.assignTexture(s,"aoMap",o.occlusionTexture)),void 0!==o.occlusionTexture.strength&&(s.aoMapIntensity=o.occlusionTexture.strength)),void 0!==o.emissiveFactor&&e!==ge.MeshBasicMaterial&&(s.emissive=(new ge.Color).fromArray(o.emissiveFactor)),void 0!==o.emissiveTexture&&e!==ge.MeshBasicMaterial&&c.push(this.assignTexture(s,"emissiveMap",o.emissiveTexture)),Promise.all(c).then(function(){var t;return t=e===ge.ShaderMaterial?a[n.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(s):new e(s),void 0!==o.name&&(t.name=o.name),t.map&&(t.map.encoding=ge.sRGBEncoding),t.emissiveMap&&(t.emissiveMap.encoding=ge.sRGBEncoding),t.specularMap&&(t.specularMap.encoding=ge.sRGBEncoding),G(t,o),o.extensions&&N(a,t,o),t})},U.prototype.loadGeometries=function(t){var e=this,r=this.extensions,a=this.primitiveCache;function o(t){return r[n.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(t,e).then(function(n){return H(n,t,e)})}for(var s,i,c=[],u=0,p=t.length;u<p;u++){var l,d=t[u],f=(i=void 0,(i=(s=d).extensions&&s.extensions[n.KHR_DRACO_MESH_COMPRESSION])?"draco:"+i.bufferView+":"+i.indices+":"+F(i.attributes):s.indices+":"+F(s.attributes)+":"+s.mode),m=a[f];if(m)c.push(m.promise);else l=d.extensions&&d.extensions[n.KHR_DRACO_MESH_COMPRESSION]?o(d):H(new ge.BufferGeometry,d,e),a[f]={primitive:d,promise:l},c.push(l)}return Promise.all(c)},U.prototype.loadMesh=function(t){for(var e=this,n=this.json,r=(this.extensions,n.meshes[t]),a=r.primitives,o=[],s=0,i=a.length;s<i;s++){var c=void 0===a[s].material?m=m||new ge.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:ge.FrontSide}):this.getDependency("material",a[s].material);o.push(c)}return Promise.all(o).then(function(n){return e.loadGeometries(a).then(function(o){for(var s=[],i=0,c=o.length;i<c;i++){var u,p=o[i],l=a[i],d=n[i];if(l.mode===O||l.mode===k||l.mode===w||void 0===l.mode)!0===(u=!0===r.isSkinnedMesh?new ge.SkinnedMesh(p,d):new ge.Mesh(p,d)).isSkinnedMesh&&u.normalizeSkinWeights(),l.mode===k?u.drawMode=ge.TriangleStripDrawMode:l.mode===w&&(u.drawMode=ge.TriangleFanDrawMode);else if(l.mode===b)u=new ge.LineSegments(p,d);else if(l.mode===y)u=new ge.Line(p,d);else if(l.mode===h)u=new ge.LineLoop(p,d);else{if(l.mode!==v)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+l.mode);u=new ge.Points(p,d)}Object.keys(u.geometry.morphAttributes).length>0&&A(u,r),u.name=r.name||"mesh_"+t,o.length>1&&(u.name+="_"+i),G(u,r),e.assignFinalMaterial(u),s.push(u)}if(1===s.length)return s[0];var f=new ge.Group;for(i=0,c=s.length;i<c;i++)f.add(s[i]);return f})})},U.prototype.loadCamera=function(t){var e,n=this.json.cameras[t],r=n[n.type];if(r)return"perspective"===n.type?e=new ge.PerspectiveCamera(ge.Math.radToDeg(r.yfov),r.aspectRatio||1,r.znear||1,r.zfar||2e6):"orthographic"===n.type&&(e=new ge.OrthographicCamera(r.xmag/-2,r.xmag/2,r.ymag/2,r.ymag/-2,r.znear,r.zfar)),void 0!==n.name&&(e.name=n.name),G(e,n),Promise.resolve(e);console.warn("THREE.GLTFLoader: Missing camera parameters.")},U.prototype.loadSkin=function(t){var e=this.json.skins[t],n={joints:e.joints};return void 0===e.inverseBindMatrices?Promise.resolve(n):this.getDependency("accessor",e.inverseBindMatrices).then(function(t){return n.inverseBindMatrices=t,n})},U.prototype.loadAnimation=function(t){for(var e=this.json.animations[t],n=[],r=[],a=[],o=[],s=[],i=0,c=e.channels.length;i<c;i++){var u=e.channels[i],p=e.samplers[u.sampler],l=u.target,d=void 0!==l.node?l.node:l.id,m=void 0!==e.parameters?e.parameters[p.input]:p.input,v=void 0!==e.parameters?e.parameters[p.output]:p.output;n.push(this.getDependency("node",d)),r.push(this.getDependency("accessor",m)),a.push(this.getDependency("accessor",v)),o.push(p),s.push(l)}return Promise.all([Promise.all(n),Promise.all(r),Promise.all(a),Promise.all(o),Promise.all(s)]).then(function(n){for(var r=n[0],a=n[1],o=n[2],s=n[3],i=n[4],c=[],u=0,p=r.length;u<p;u++){var l=r[u],d=a[u],m=o[u],v=s[u],b=i[u];if(void 0!==l){var h;switch(l.updateMatrix(),l.matrixAutoUpdate=!0,j[b.path]){case j.weights:h=ge.NumberKeyframeTrack;break;case j.rotation:h=ge.QuaternionKeyframeTrack;break;case j.position:case j.scale:default:h=ge.VectorKeyframeTrack}var y=l.name?l.name:l.uuid,O=void 0!==v.interpolation?D[v.interpolation]:ge.InterpolateLinear,k=[];j[b.path]===j.weights?l.traverse(function(t){!0===t.isMesh&&t.morphTargetInfluences&&k.push(t.name?t.name:t.uuid)}):k.push(y);for(var w=0,g=k.length;w<g;w++){var S=new h(k[w]+"."+j[b.path],d.array,m.array,O);"CUBICSPLINE"===v.interpolation&&(S.createInterpolant=function(t){return new f(this.times,this.values,this.getValueSize()/3,t)},S.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),c.push(S)}}}var C=void 0!==e.name?e.name:"animation_"+t;return new ge.AnimationClip(C,void 0,c)})},U.prototype.loadNode=function(t){var e=this.json,r=this.extensions,a=this,o=e.meshReferences,s=e.meshUses,i=e.nodes[t];return(!0===i.isBone?Promise.resolve(new ge.Bone):void 0!==i.mesh?a.getDependency("mesh",i.mesh).then(function(t){var e;if(o[i.mesh]>1){var n=s[i.mesh]++;(e=t.clone()).name+="_instance_"+n,e.onBeforeRender=t.onBeforeRender;for(var r=0,a=e.children.length;r<a;r++)e.children[r].name+="_instance_"+n,e.children[r].onBeforeRender=t.children[r].onBeforeRender}else e=t;return void 0!==i.weights&&e.traverse(function(t){if(t.isMesh)for(var e=0,n=i.weights.length;e<n;e++)t.morphTargetInfluences[e]=i.weights[e]}),e}):void 0!==i.camera?a.getDependency("camera",i.camera):i.extensions&&i.extensions[n.KHR_LIGHTS_PUNCTUAL]&&void 0!==i.extensions[n.KHR_LIGHTS_PUNCTUAL].light?a.getDependency("light",i.extensions[n.KHR_LIGHTS_PUNCTUAL].light):Promise.resolve(new ge.Object3D)).then(function(t){if(void 0!==i.name&&(t.name=ge.PropertyBinding.sanitizeNodeName(i.name)),G(t,i),i.extensions&&N(r,t,i),void 0!==i.matrix){var e=new ge.Matrix4;e.fromArray(i.matrix),t.applyMatrix(e)}else void 0!==i.translation&&t.position.fromArray(i.translation),void 0!==i.rotation&&t.quaternion.fromArray(i.rotation),void 0!==i.scale&&t.scale.fromArray(i.scale);return t})},U.prototype.loadScene=function(){function t(e,n,r,a){var o=r.nodes[e];return a.getDependency("node",e).then(function(t){return void 0===o.skin?t:a.getDependency("skin",o.skin).then(function(t){for(var n=[],r=0,o=(e=t).joints.length;r<o;r++)n.push(a.getDependency("node",e.joints[r]));return Promise.all(n)}).then(function(n){for(var r=!0===t.isGroup?t.children:[t],a=0,o=r.length;a<o;a++){for(var s=r[a],i=[],c=[],u=0,p=n.length;u<p;u++){var l=n[u];if(l){i.push(l);var d=new ge.Matrix4;void 0!==e.inverseBindMatrices&&d.fromArray(e.inverseBindMatrices.array,16*u),c.push(d)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',e.joints[u])}s.bind(new ge.Skeleton(i,c),s.matrixWorld)}return t});var e}).then(function(e){n.add(e);var s=[];if(o.children)for(var i=o.children,c=0,u=i.length;c<u;c++){var p=i[c];s.push(t(p,e,r,a))}return Promise.all(s)})}return function(e){var n=this.json,r=this.extensions,a=this.json.scenes[e],o=new ge.Scene;void 0!==a.name&&(o.name=a.name),G(o,a),a.extensions&&N(r,o,a);for(var s=a.nodes||[],i=[],c=0,u=s.length;c<u;c++)i.push(t(s[c],o,n,this));return Promise.all(i).then(function(){return o})}}(),t}(),Ce=n(1),Ee=function(){function t(t){this.timeLoaded=0,this.manager=t||Ce.DefaultLoadingManager,this.materials=null,this.verbosity=0,this.attributeOptions={},this.drawMode=Ce.TrianglesDrawMode,this.nativeAttributeMap={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"}}return t.prototype={constructor:t,load:function(t,e,n,r){var a=this,o=new Ce.FileLoader(a.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.load(t,function(t){a.decodeDracoFile(t,e)},n,r)},setPath:function(t){return this.path=t,this},setVerbosity:function(t){return this.verbosity=t,this},setDrawMode:function(t){return this.drawMode=t,this},setSkipDequantization:function(t,e){var n=!0;return"undefined"!==typeof e&&(n=e),this.getAttributeOptions(t).skipDequantization=n,this},decodeDracoFile:function(e,n,r,a){var o=this;t.getDecoderModule().then(function(t){o.decodeDracoFileInternal(e,t.decoder,n,r,a)})},decodeDracoFileInternal:function(t,e,n,r,a){var o=new e.DecoderBuffer;o.Init(new Int8Array(t),t.byteLength);var s=new e.Decoder,i=s.GetEncodedGeometryType(o);if(i==e.TRIANGULAR_MESH)this.verbosity>0&&console.log("Loaded a mesh.");else{if(i!=e.POINT_CLOUD){var c="THREE.DRACOLoader: Unknown geometry type.";throw console.error(c),new Error(c)}this.verbosity>0&&console.log("Loaded a point cloud.")}n(this.convertDracoGeometryTo3JS(e,s,i,o,r,a))},addAttributeToGeometry:function(t,e,n,r,a,o,s,i){if(0===o.ptr){var c="THREE.DRACOLoader: No attribute "+r;throw console.error(c),new Error(c)}var u,p,l=o.num_components(),d=n.num_points()*l;switch(a){case Float32Array:u=new t.DracoFloat32Array,e.GetAttributeFloatForAllPoints(n,o,u),i[r]=new Float32Array(d),p=Ce.Float32BufferAttribute;break;case Int8Array:u=new t.DracoInt8Array,e.GetAttributeInt8ForAllPoints(n,o,u),i[r]=new Int8Array(d),p=Ce.Int8BufferAttribute;break;case Int16Array:u=new t.DracoInt16Array,e.GetAttributeInt16ForAllPoints(n,o,u),i[r]=new Int16Array(d),p=Ce.Int16BufferAttribute;break;case Int32Array:u=new t.DracoInt32Array,e.GetAttributeInt32ForAllPoints(n,o,u),i[r]=new Int32Array(d),p=Ce.Int32BufferAttribute;break;case Uint8Array:u=new t.DracoUInt8Array,e.GetAttributeUInt8ForAllPoints(n,o,u),i[r]=new Uint8Array(d),p=Ce.Uint8BufferAttribute;break;case Uint16Array:u=new t.DracoUInt16Array,e.GetAttributeUInt16ForAllPoints(n,o,u),i[r]=new Uint16Array(d),p=Ce.Uint16BufferAttribute;break;case Uint32Array:u=new t.DracoUInt32Array,e.GetAttributeUInt32ForAllPoints(n,o,u),i[r]=new Uint32Array(d),p=Ce.Uint32BufferAttribute;break;default:c="THREE.DRACOLoader: Unexpected attribute type.";throw console.error(c),new Error(c)}for(var f=0;f<d;f++)i[r][f]=u.GetValue(f);s.addAttribute(r,new p(i[r],l)),t.destroy(u)},convertDracoGeometryTo3JS:function(t,e,n,r,a,o){var s,i;!0===this.getAttributeOptions("position").skipDequantization&&e.SkipAttributeTransform(t.POSITION);var c=performance.now();if(n===t.TRIANGULAR_MESH?(s=new t.Mesh,i=e.DecodeBufferToMesh(r,s)):(s=new t.PointCloud,i=e.DecodeBufferToPointCloud(r,s)),!i.ok()||0==s.ptr){var u="THREE.DRACOLoader: Decoding failed: ";throw u+=i.error_msg(),console.error(u),t.destroy(e),t.destroy(s),new Error(u)}var p,l=performance.now();t.destroy(r),n==t.TRIANGULAR_MESH?(p=s.num_faces(),this.verbosity>0&&console.log("Number of faces loaded: "+p.toString())):p=0;var d=s.num_points(),f=s.num_attributes();this.verbosity>0&&(console.log("Number of points loaded: "+d.toString()),console.log("Number of attributes loaded: "+f.toString()));var m=e.GetAttributeId(s,t.POSITION);if(-1==m){u="THREE.DRACOLoader: No position attribute found.";throw console.error(u),t.destroy(e),t.destroy(s),new Error(u)}var v=e.GetAttribute(s,m),b={},h=new Ce.BufferGeometry;if(a)for(var y in a){var O=o[y],k=a[y],w=e.GetAttributeByUniqueId(s,k);this.addAttributeToGeometry(t,e,s,y,O,w,h,b)}else for(var y in this.nativeAttributeMap){var g=e.GetAttributeId(s,t[this.nativeAttributeMap[y]]);if(-1!==g){this.verbosity>0&&console.log("Loaded "+y+" attribute.");w=e.GetAttribute(s,g);this.addAttributeToGeometry(t,e,s,y,Float32Array,w,h,b)}}if(n==t.TRIANGULAR_MESH)if(this.drawMode===Ce.TriangleStripDrawMode){var S=new t.DracoInt32Array;e.GetTriangleStripsFromMesh(s,S);b.indices=new Uint32Array(S.size());for(var C=0;C<S.size();++C)b.indices[C]=S.GetValue(C);t.destroy(S)}else{var E=3*p;b.indices=new Uint32Array(E);var M=new t.DracoInt32Array;for(C=0;C<p;++C){e.GetFaceFromMesh(s,C,M);var j=3*C;b.indices[j]=M.GetValue(0),b.indices[j+1]=M.GetValue(1),b.indices[j+2]=M.GetValue(2)}t.destroy(M)}h.drawMode=this.drawMode,n==t.TRIANGULAR_MESH&&h.setIndex(new(b.indices.length>65535?Ce.Uint32BufferAttribute:Ce.Uint16BufferAttribute)(b.indices,1));var D=new t.AttributeQuantizationTransform;if(D.InitFromAttribute(v)){h.attributes.position.isQuantized=!0,h.attributes.position.maxRange=D.range(),h.attributes.position.numQuantizationBits=D.quantization_bits(),h.attributes.position.minValues=new Float32Array(3);for(C=0;C<3;++C)h.attributes.position.minValues[C]=D.min_value(C)}return t.destroy(D),t.destroy(e),t.destroy(s),this.decode_time=l-c,this.import_time=performance.now()-l,this.verbosity>0&&(console.log("Decode time: "+this.decode_time),console.log("Import time: "+this.import_time)),h},isVersionSupported:function(e,n){t.getDecoderModule().then(function(t){n(t.decoder.isVersionSupported(e))})},getAttributeOptions:function(t){return"undefined"===typeof this.attributeOptions[t]&&(this.attributeOptions[t]={}),this.attributeOptions[t]}},t.decoderPath="./",t.decoderConfig={},t.decoderModulePromise=null,t.setDecoderPath=function(e){t.decoderPath=e},t.setDecoderConfig=function(e){var n=Ce.DRACOLoader.decoderConfig.wasmBinary;t.decoderConfig=e||{},t.releaseDecoderModule(),n&&(t.decoderConfig.wasmBinary=n)},t.releaseDecoderModule=function(){t.decoderModulePromise=null},t.getDecoderModule=function(){var e=this,n=t.decoderPath,r=t.decoderConfig,a=t.decoderModulePromise;return a||("undefined"!==typeof DracoDecoderModule?a=Promise.resolve():"object"!==typeof WebAssembly||"js"===r.type?a=t._loadScript(n+"draco_decoder.js"):(r.wasmBinaryFile=n+"draco_decoder.wasm",a=t._loadScript(n+"draco_wasm_wrapper.js").then(function(){return t._loadArrayBuffer(r.wasmBinaryFile)}).then(function(t){r.wasmBinary=t})),a=a.then(function(){return new Promise(function(t){r.onModuleLoaded=function(n){e.timeLoaded=performance.now(),t({decoder:n})},DracoDecoderModule(r)})}),t.decoderModulePromise=a,a)},t._loadScript=function(t){var e=document.getElementById("decoder_script");null!==e&&e.parentNode.removeChild(e);var n=document.getElementsByTagName("head")[0],r=document.createElement("script");return r.id="decoder_script",r.type="text/javascript",r.src=t,new Promise(function(t){r.onload=t,n.appendChild(r)})},t._loadArrayBuffer=function(t){var e=new Ce.FileLoader;return e.setResponseType("arraybuffer"),new Promise(function(n,r){e.load(t,n,void 0,r)})},t}(),Me=n(1);var je={retarget:(pe=new Me.Vector3,le=new Me.Quaternion,de=new Me.Vector3,fe=new Me.Matrix4,me=new Me.Matrix4,ve=new Me.Matrix4,function(t,e,n){(n=n||{}).preserveMatrix=void 0===n.preserveMatrix||n.preserveMatrix,n.preservePosition=void 0===n.preservePosition||n.preservePosition,n.preserveHipPosition=void 0!==n.preserveHipPosition&&n.preserveHipPosition,n.useTargetMatrix=void 0!==n.useTargetMatrix&&n.useTargetMatrix,n.hip=void 0!==n.hip?n.hip:"hip",n.names=n.names||{};var r,a,o,s,i,c,u=e.isObject3D?e.skeleton.bones:this.getBones(e),p=t.isObject3D?t.skeleton.bones:this.getBones(t);if(t.isObject3D?t.skeleton.pose():(n.useTargetMatrix=!0,n.preserveMatrix=!1),n.preservePosition)for(i=[],c=0;c<p.length;c++)i.push(p[c].position.clone());if(n.preserveMatrix)for(t.updateMatrixWorld(),t.matrixWorld.identity(),c=0;c<t.children.length;++c)t.children[c].updateMatrixWorld(!0);if(n.offsets)for(r=[],c=0;c<p.length;++c)a=p[c],o=n.names[a.name]||a.name,n.offsets&&n.offsets[o]&&(a.matrix.multiply(n.offsets[o]),a.matrix.decompose(a.position,a.quaternion,a.scale),a.updateMatrixWorld()),r.push(a.matrixWorld.clone());for(c=0;c<p.length;++c){if(a=p[c],o=n.names[a.name]||a.name,s=this.getBoneByName(o,u),ve.copy(a.matrixWorld),s){if(s.updateMatrixWorld(),n.useTargetMatrix?me.copy(s.matrixWorld):(me.getInverse(t.matrixWorld),me.multiply(s.matrixWorld)),de.setFromMatrixScale(me),me.scale(de.set(1/de.x,1/de.y,1/de.z)),ve.makeRotationFromQuaternion(le.setFromRotationMatrix(me)),t.isObject3D){var l=p.indexOf(a),d=r?r[l]:fe.getInverse(t.skeleton.boneInverses[l]);ve.multiply(d)}ve.copyPosition(me)}a.parent&&a.parent.isBone?(a.matrix.getInverse(a.parent.matrixWorld),a.matrix.multiply(ve)):a.matrix.copy(ve),n.preserveHipPosition&&o===n.hip&&a.matrix.setPosition(pe.set(0,a.position.y,0)),a.matrix.decompose(a.position,a.quaternion,a.scale),a.updateMatrixWorld()}if(n.preservePosition)for(c=0;c<p.length;++c)a=p[c],(o=n.names[a.name]||a.name)!==n.hip&&a.position.copy(i[c]);n.preserveMatrix&&t.updateMatrixWorld(!0)}),retargetClip:function(t,e,n,r){(r=r||{}).useFirstFramePosition=void 0!==r.useFirstFramePosition&&r.useFirstFramePosition,r.fps=void 0!==r.fps?r.fps:30,r.names=r.names||[],e.isObject3D||(e=this.getHelperFromSkeleton(e));var a,o,s,i,c,u,p=Math.round(n.duration*(r.fps/1e3)*1e3),l=1/r.fps,d=[],f=new Me.AnimationMixer(e),m=this.getBones(t.skeleton),v=[];for(f.clipAction(n).play(),f.update(0),e.updateMatrixWorld(),c=0;c<p;++c){var b=c*l;for(this.retarget(t,e,r),u=0;u<m.length;++u)i=r.names[m[u].name]||m[u].name,this.getBoneByName(i,e.skeleton)&&(o=m[u],s=v[u]=v[u]||{bone:o},r.hip===i&&(s.pos||(s.pos={times:new Float32Array(p),values:new Float32Array(3*p)}),r.useFirstFramePosition&&(0===c&&(a=o.position.clone()),o.position.sub(a)),s.pos.times[c]=b,o.position.toArray(s.pos.values,3*c)),s.quat||(s.quat={times:new Float32Array(p),values:new Float32Array(4*p)}),s.quat.times[c]=b,o.quaternion.toArray(s.quat.values,4*c));f.update(l),e.updateMatrixWorld()}for(c=0;c<v.length;++c)(s=v[c])&&(s.pos&&d.push(new Me.VectorKeyframeTrack(".bones["+s.bone.name+"].position",s.pos.times,s.pos.values)),d.push(new Me.QuaternionKeyframeTrack(".bones["+s.bone.name+"].quaternion",s.quat.times,s.quat.values)));return f.uncacheAction(n),new Me.AnimationClip(n.name,-1,d)},getHelperFromSkeleton:function(t){var e=new Me.SkeletonHelper(t.bones[0]);return e.skeleton=t,e},getSkeletonOffsets:(ae=new Me.Vector3,oe=new Me.Vector3,se=new Me.Vector3,ie=new Me.Vector3,ce=new Me.Vector2,ue=new Me.Vector2,function(t,e,n){(n=n||{}).hip=void 0!==n.hip?n.hip:"hip",n.names=n.names||{},e.isObject3D||(e=this.getHelperFromSkeleton(e));var r,a,o,s,i=Object.keys(n.names),c=Object.values(n.names),u=e.isObject3D?e.skeleton.bones:this.getBones(e),p=t.isObject3D?t.skeleton.bones:this.getBones(t),l=[];for(t.skeleton.pose(),s=0;s<p.length;++s)if(r=p[s],o=n.names[r.name]||r.name,(a=this.getBoneByName(o,u))&&o!==n.hip){var d=this.getNearestBone(r.parent,i),f=this.getNearestBone(a.parent,c);d.updateMatrixWorld(),f.updateMatrixWorld(),ae.setFromMatrixPosition(d.matrixWorld),oe.setFromMatrixPosition(r.matrixWorld),se.setFromMatrixPosition(f.matrixWorld),ie.setFromMatrixPosition(a.matrixWorld),ce.subVectors(new Me.Vector2(oe.x,oe.y),new Me.Vector2(ae.x,ae.y)).normalize(),ue.subVectors(new Me.Vector2(ie.x,ie.y),new Me.Vector2(se.x,se.y)).normalize();var m=ce.angle()-ue.angle(),v=(new Me.Matrix4).makeRotationFromEuler(new Me.Euler(0,0,m));r.matrix.multiply(v),r.matrix.decompose(r.position,r.quaternion,r.scale),r.updateMatrixWorld(),l[o]=v}return l}),renameBones:function(t,e){for(var n=this.getBones(t),r=0;r<n.length;++r){var a=n[r];e[a.name]&&(a.name=e[a.name])}return this},getBones:function(t){return Array.isArray(t)?t:t.bones},getBoneByName:function(t,e){for(var n=0,r=this.getBones(e);n<r.length;n++)if(t===r[n].name)return r[n]},getNearestBone:function(t,e){for(;t.isBone;){if(-1!==e.indexOf(t.name))return t;t=t.parent}},findBoneTrackData:function(t,e){for(var n=/\[(.*)\]\.(.*)/,r={name:t},a=0;a<e.length;++a){var o=n.exec(e[a].name);o&&t===o[1]&&(r[o[2]]=a)}return r},getEqualsBonesNames:function(t,e){var n=this.getBones(t),r=this.getBones(e),a=[];t:for(var o=0;o<n.length;o++)for(var s=n[o].name,i=0;i<r.length;i++)if(s===r[i].name){a.push(s);continue t}return a},clone:function(t){var e=new Map,n=new Map,r=t.clone();return function t(e,n,r){r(e,n);for(var a=0;a<e.children.length;a++)t(e.children[a],n.children[a],r)}(t,r,function(t,r){e.set(r,t),n.set(t,r)}),r.traverse(function(t){if(t.isSkinnedMesh){var r=t,a=e.get(t),o=a.skeleton.bones;r.skeleton=a.skeleton.clone(),r.bindMatrix.copy(a.bindMatrix),r.skeleton.bones=o.map(function(t){return n.get(t)}),r.bind(r.skeleton,r.bindMatrix)}}),r}},De=function(t){function e(){return Object(i.a)(this,e),Object(u.a)(this,Object(p.a)(e).apply(this,arguments))}return Object(l.a)(e,t),Object(c.a)(e,[{key:"make",value:function(t,e){if(!e.id)throw new Error("can't create model w/ missing parent");return st(t,t.createObject({type:"model",title:"a model",visible:!0,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,color:"#ffffff",children:t.createArray(),asset:$e.id,transparent:!1,parent:e.id}))}},{key:"makeNode",value:function(t,e){var n=new be.Group;n.name=t.title;var r=new be.Mesh(new be.SphereBufferGeometry(1),new be.MeshLambertMaterial({color:"red",transparent:!0,opacity:.2}));return r.material.visible=!0,r.userData.clickable=!0,n.userData.clicker=r,n.add(r),n.position.set(t.tx,t.ty,t.tz),n.rotation.set(t.rx,t.ry,t.rz),n.scale.set(t.sx,t.sy,t.sz),n.visible=t.visible,this.attachAsset(n,t,e),n.enter=function(t,e){n.userData.clicker.visible=!1,n.userData.model?n.userData.currentClip&&(n.userData.action=n.userData.mixer.clipAction(n.userData.currentClip),n.userData.action.play()):n.userData.shouldPlay=!0},n.exit=function(r,a){e.accessObject(t.id).asset===$e.id&&(n.userData.clicker.visible=!0)},n.tick=function(t,e){var r=t.deltaTime/1e3;n.userData.mixer&&n.userData.mixer.update(r)},n.useClip=function(t){if(n.userData.model){var e=be.AnimationClip.findByName(n.userData.clips,t);e&&(n.userData.currentClip=e)}else n.userData.currentClipName=t},n.play=function(){n.userData.currentClip&&(n.userData.mixer.stopAllAction(),n.userData.action=n.userData.mixer.clipAction(n.userData.currentClip),n.userData.action.play())},n.stop=function(){n.userData.mixer&&n.userData.mixer.stopAllAction()},n}},{key:"updateProperty",value:function(t,n,r,a){return r.name===Ye.asset.key?this.attachAsset(t,n,a):Object(f.a)(Object(p.a)(e.prototype),"updateProperty",this).call(this,t,n,r,a)}},{key:"setClips",value:function(t){t.mixer&&(t.mixer.stopAllAction(),t.mixer.uncacheRoot(t.mixer.getRoot()),t.mixer=null),t.clips.forEach(function(t){t.validate()&&t.optimize()}),t.clips.length&&(t.currentClip=t.clips[0],t.mixer=new be.AnimationMixer(t.model))}},{key:"attachAsset",value:function(t,e,n){var r=this;if(e.asset===$e.id)return console.log("REMOVE NODE CHILDREN"),t.userData.model&&(t.remove(t.userData.model),delete t.userData.model),void(t.userData.clicker.visible=!0);t.userData.shouldPlay=!1,t.userData.currentClip=null,t.userData.model=null,t.userData.currentClipName=null,n.assetsManager.getGLTF(e.asset).then(function(e){t.userData.model&&t.remove(t.userData.model),t.userData.model=e.scene||e.scenes[0],t.userData.model=je.clone(t.userData.model),t.userData.clips=e.animations||[],t.add(t.userData.model),t.userData.model.updateMatrixWorld();var n=t.userData.model;if(t.userData.boundingBox=(new be.Box3).setFromObject(n),t.userData.boundingBoxSize=t.userData.boundingBox.getSize(new be.Vector3).length(),t.userData.BoundingBoxCenter=t.userData.boundingBox.getCenter(new be.Vector3),t.userData.mixer=null,r.setClips(t.userData),t.userData.currentClipName){var a=be.AnimationClip.findByName(t.userData.clips,t.userData.currentClipName);a&&(t.userData.currentClip=a),t.userData.currentClipName=null}t.userData.shouldPlay&&t.userData.currentClip&&(t.userData.action=t.userData.mixer.clipAction(t.userData.currentClip),t.userData.action.play(),t.userData.shouldPlay=!1),t.userData.clicker.geometry=new be.SphereBufferGeometry(t.userData.boundingBoxSize/2),t.userData.clicker.visible=!1})}}]),e}(he);var Re=function(){function t(){Object(i.a)(this,t)}return Object(c.a)(t,[{key:"make",value:function(t,e){if(!e.id)throw new Error("can't create sphere w/ missing parent");return st(t,t.createObject({type:_e.bg360,title:"background",visible:!0,asset:$e.id,transparent:!1,parent:e.id,imageOffsetAngle:0,imageCropStartAngle:0,imageCropEndAngle:1}))}},{key:"makeNode",value:function(t,e){var n=new be.MeshLambertMaterial({color:"white",side:be.BackSide}),r=new be.Mesh(new be.SphereBufferGeometry(20,50,50),n);return this.attachAsset(r,t,e),function(t,e,n){e.onBeforeCompile=function(e){e.uniforms.imageOffsetAngle={value:n.imageOffsetAngle},e.uniforms.imageCropStartAngle={value:n.imageCropStartAngle},e.uniforms.imageCropEndAngle={value:n.imageCropEndAngle},e.vertexShader="\n            uniform float imageOffsetAngle;\n            varying float vImageOffsetAngle;\n            uniform float imageCropStartAngle;            \n            varying float vImageCropStartAngle;            \n            uniform float imageCropEndAngle;            \n            varying float vImageCropEndAngle;            \n        "+e.vertexShader,e.vertexShader=e.vertexShader.replace("#include <begin_vertex>","\n            #include <begin_vertex>\n            vImageOffsetAngle = imageOffsetAngle;\n            vImageCropStartAngle = imageCropStartAngle;\n            vImageCropEndAngle = imageCropEndAngle;\n        "),e.fragmentShader="\n                varying float vImageOffsetAngle;\n                varying float vImageCropStartAngle;\n                varying float vImageCropEndAngle;\n            "+e.fragmentShader,e.fragmentShader=e.fragmentShader.replace("#include <dithering_fragment>","\n            if(vUv.x < vImageCropStartAngle) discard;\n            if(vUv.x > vImageCropEndAngle)  discard;\n            // gl_FragColor.r = vUv.x;\n            // vec3 jv = vec3(cos(gl_FragCoord.x/50.0)); \n            // vec3 empty = vec3(0.0,0.0,0.0);//vec3(jv,jv,jv)\n            // gl_FragColor.rgb = mix(empty,diffuseColor.rgb,jv);\n        "),t.userData.matShader=e}}(r,n,t),r.name=t.title,r.userData.clickable=!0,r.visible=t.visible,r}},{key:"updateProperty",value:function(t,e,n,r){if(n.name===Ye.asset.key||n.name===Ye.transparent.key)return this.attachAsset(t,e,r);t.userData.matShader?("imageOffsetAngle"===n.name&&(t.userData.matShader.uniforms.imageOffsetAngle.value=n.value),"imageCropStartAngle"===n.name&&(t.userData.matShader.uniforms.imageCropStartAngle.value=n.value),"imageCropEndAngle"===n.name&&(t.userData.matShader.uniforms.imageCropEndAngle.value=n.value)):console.warn("BG360: no shader reference?!")}},{key:"attachAsset",value:function(t,e,n){e.asset!==$e.id?n.assetsManager.getTexture(e.asset).then(function(r){n.getLogger().log("loadded asset",e.asset),n.getLogger().log(r),r||n.getLogger().error("error loading asset",e.asset);var a={side:be.DoubleSide,map:r};e.transparent&&(a.transparent=!0,a.alphaTest=.5),t.material=new be.MeshLambertMaterial(a)}).catch(function(t){n.getLogger().error("error somwhere",t.message,t)}):t.material=new be.MeshLambertMaterial({side:be.DoubleSide})}}]),t}(),Pe=n(25),Ie=function(t){function e(){return Object(i.a)(this,e),Object(u.a)(this,Object(p.a)(e).apply(this,arguments))}return Object(l.a)(e,t),Object(c.a)(e,[{key:"make",value:function(t,e){if(!e.id)throw new Error("can't create sphere w/ missing parent");return st(t,t.createObject({type:_e.text,title:"some text",visible:!0,text:"cool <b>formatted</b> <i>text</i>",cssStyle:"color:black; \nbackground-color:white;\nwidth: 10em;\nfont-size: 200%;\n",tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,children:t.createArray(),parent:e.id}))}},{key:"makeNode",value:function(t){var e=document.createElement("div");e.innerHTML=t.text,e.id="div_".concat(t.id),e.classList.add("weblayer-div"),t.cssStyle&&e.setAttribute("style",t.cssStyle);var n=new Pe.a(e,{pixelRatio:window.devicePixelRatio,onLayerCreate:function(e){e.mesh.material.side=be.DoubleSide,e.mesh.userData.graphid=t.id,e.mesh.userData.clickable=!0}});n.refresh(!0),n.userData.clickable=!0;var r=new be.Object3D;return r.previewUpdate=function(){n.update()},r.setText=function(t){t!==r.userData.text&&(r.userData.text=t,r.userData.div.innerHTML=t)},r.add(n),r.userData.divLayer=n,r.userData.text=t.text,r.userData.div=e,r.name=t.title,r.userData.clickable=!0,r.position.set(t.tx,t.ty,t.tz),r.rotation.set(t.rx,t.ry,t.rz),r.scale.set(t.sx,t.sy,t.sz),r.visible=t.visible,this.regenerateText(r,t),r}},{key:"updateProperty",value:function(t,n,r,a){return r.name===Ye.text.key&&this.regenerateText(t,n),r.name===Ye.cssStyle.key&&this.regenerateText(t,n),Object(f.a)(Object(p.a)(e.prototype),"updateProperty",this).call(this,t,n,r,a)}},{key:"regenerateText",value:function(t,e){t.userData.div.innerHTML=e.text,e.cssStyle&&t.userData.div.setAttribute("style",e.cssStyle),t.userData.divLayer.refresh(!0)}}]),e}(he),Te=function(t){function e(){return Object(i.a)(this,e),Object(u.a)(this,Object(p.a)(e).apply(this,arguments))}return Object(l.a)(e,t),Object(c.a)(e,[{key:"make",value:function(t,e){if(!e.id)throw new Error("can't create Image2D with missing parent");return st(t,t.createObject({type:_e.img2d,title:"image",visible:!0,width:.5,ratio:1,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,asset:$e.id,transparent:!1,parent:e.id}))}},{key:"makeNode",value:function(t,e){var n=new be.Mesh(new be.PlaneBufferGeometry(t.width,t.width*t.ratio),new be.MeshLambertMaterial({color:"white",side:be.DoubleSide}));return n.name=t.title,n.userData.clickable=!0,n.position.set(t.tx,t.ty,t.tz),n.rotation.set(t.rx,t.ry,t.rz),n.scale.set(t.sx,t.sy,t.sz),n.visible=t.visible,this.attachAsset(n,t,e),n}},{key:"updateProperty",value:function(t,n,r,a){return r.name===Ye.asset.key||r.name===Ye.transparent.key?this.attachAsset(t,n,a):r.name!==Ye.width.key&&"ratio"!==r.name?Object(f.a)(Object(p.a)(e.prototype),"updateProperty",this).call(this,t,n,r,a):void(t.geometry=new be.PlaneBufferGeometry(n.width,n.width*(1/n.ratio)))}}]),e}(he),xe=0,Ne=function(t){function e(){return Object(i.a)(this,e),Object(u.a)(this,Object(p.a)(e).apply(this,arguments))}return Object(l.a)(e,t),Object(c.a)(e,[{key:"make",value:function(t,e){if(!e.id)throw new Error("can't create cube w/ missing parent");return st(t,t.createObject({type:_e.group,title:"group "+xe++,visible:!0,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,color:"#00ff00",children:t.createArray(),parent:e.id}))}},{key:"makeNode",value:function(t){var e=new be.Group;return e.name=t.title,e.userData.clickable=!0,e.position.set(t.tx,t.ty,t.tz),e.rotation.set(t.rx,t.ry,t.rz),e.scale.set(t.sx,t.sy,t.sz),e.visible=t.visible,e}},{key:"updateProperty",value:function(t,n,r,a){return Object(f.a)(Object(p.a)(e.prototype),"updateProperty",this).call(this,t,n,r,a)}}]),e}(he),Ge={vertexShader:"\n                uniform float uTime;\n                uniform float uScale;\n                uniform bool reverseTime;\n                uniform float fadeIn;\n                uniform float fadeOut;\n    \n                attribute vec3 positionStart;\n                attribute float startTime;\n                attribute vec3 velocity;\n                attribute vec3 acceleration;\n                attribute vec3 color;\n                attribute vec3 endColor;\n                attribute float size;\n                attribute float lifeTime;\n    \n                varying vec4 vColor;\n                varying vec4 vEndColor;\n                varying float lifeLeft;\n                varying float alpha;\n    \n                void main() {\n                    vColor = vec4( color, 1.0 );\n                    vEndColor = vec4( endColor, 1.0);\n                    vec3 newPosition;\n                    float timeElapsed = uTime - startTime;\n                    if(reverseTime) timeElapsed = lifeTime - timeElapsed;\n                    if(timeElapsed < fadeIn) {\n                        alpha = timeElapsed/fadeIn;\n                    }\n                    if(timeElapsed >= fadeIn && timeElapsed <= (lifeTime - fadeOut)) {\n                        alpha = 1.0;\n                    }\n                    if(timeElapsed > (lifeTime - fadeOut)) {\n                        alpha = 1.0 - (timeElapsed - (lifeTime-fadeOut))/fadeOut;\n                    }\n                    \n                    lifeLeft = 1.0 - ( timeElapsed / lifeTime );\n                    gl_PointSize = ( uScale * size );// * lifeLeft;\n                    newPosition = positionStart \n                        + (velocity * timeElapsed)\n                        + (acceleration * 0.5 * timeElapsed * timeElapsed)\n                        ;\n                    if (lifeLeft < 0.0) { \n                        lifeLeft = 0.0; \n                        gl_PointSize = 0.;\n                    }\n                    //while active use the new position\n                    if( timeElapsed > 0.0 ) {\n                        gl_Position = projectionMatrix * modelViewMatrix * vec4( newPosition, 1.0 );\n                    } else {\n                        //if dead use the initial position and set point size to 0\n                        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n                        lifeLeft = 0.0;\n                        gl_PointSize = 0.;\n                    }\n                }\n                ",fragmentShader:"\n                varying vec4 vColor;\n                varying vec4 vEndColor;\n                varying float lifeLeft;\n                varying float alpha;\n                uniform sampler2D tSprite;\n                void main() {\n                    // color based on particle texture and the lifeLeft. \n                    // if lifeLeft is 0 then make invisible\n                    vec4 tex = texture2D( tSprite, gl_PointCoord );\n                    vec4 color = mix(vColor, vEndColor, 1.0-lifeLeft);\n                    gl_FragColor = vec4( color.rgb*tex.rgb, alpha * tex.a);\n                }\n    \n            "},Ae=["positionStart","startTime","velocity","acceleration","color","endColor","size","lifeTime"],Fe=function(t){function e(t){var n,r;for(Object(i.a)(this,e),t=t||{},(n=Object(u.a)(this,Object(p.a)(e).call(this))).blending=t.blending?t.blending:be.NormalBlending,n.PARTICLE_COUNT=t.maxParticles||1e6,n.PARTICLE_CURSOR=0,n.time=0,n.offset=0,n.count=0,n.DPR=window.devicePixelRatio,n.particleUpdate=!1,n.onTick=t.onTick,n.reverseTime=t.reverseTime,n.fadeIn=t.fadeIn||1,0===n.fadeIn&&(n.fadeIn=.001),n.fadeOut=t.fadeOut||1,0===n.fadeOut&&(n.fadeOut=.001),n.rand=[],r=1e5;r>0;r--)n.rand.push(Math.random()-.5);if(n.i=r,n.sprite=t.particleSpriteTex||null,!n.sprite){var a=document.createElement("canvas");a.width=16,a.height=16;var o=a.getContext("2d");o.fillStyle="black",o.fillRect(0,0,a.width,a.height),o.fillStyle="rgba(255,255,255,0.5)",o.beginPath(),o.arc(8,8,8,0,2*Math.PI),o.fill(),n.sprite=new be.CanvasTexture(a)}return n.sprite.wrapS=n.sprite.wrapT=be.RepeatWrapping,n.material=new be.ShaderMaterial({transparent:!0,depthWrite:!1,uniforms:{uTime:{value:0},uScale:{value:1},tSprite:{value:n.sprite},reverseTime:{value:n.reverseTime},fadeIn:{value:n.fadeIn},fadeOut:{value:n.fadeOut}},blending:n.blending,vertexShader:Ge.vertexShader,fragmentShader:Ge.fragmentShader}),n.material.defaultAttributeValues.particlePositionsStartTime=[0,0,0,0],n.material.defaultAttributeValues.particleVelColSizeLife=[0,0,0,0],n.geometry=new be.BufferGeometry,n.geometry.addAttribute("position",new be.BufferAttribute(new Float32Array(3*n.PARTICLE_COUNT),3).setDynamic(!0)),n.geometry.addAttribute("positionStart",new be.BufferAttribute(new Float32Array(3*n.PARTICLE_COUNT),3).setDynamic(!0)),n.geometry.addAttribute("velocity",new be.BufferAttribute(new Float32Array(3*n.PARTICLE_COUNT),3).setDynamic(!0)),n.geometry.addAttribute("acceleration",new be.BufferAttribute(new Float32Array(3*n.PARTICLE_COUNT),3).setDynamic(!0)),n.geometry.addAttribute("color",new be.BufferAttribute(new Float32Array(3*n.PARTICLE_COUNT),3).setDynamic(!0)),n.geometry.addAttribute("endColor",new be.BufferAttribute(new Float32Array(3*n.PARTICLE_COUNT),3).setDynamic(!0)),n.geometry.addAttribute("startTime",new be.BufferAttribute(new Float32Array(n.PARTICLE_COUNT),1).setDynamic(!0)),n.geometry.addAttribute("size",new be.BufferAttribute(new Float32Array(n.PARTICLE_COUNT),1).setDynamic(!0)),n.geometry.addAttribute("lifeTime",new be.BufferAttribute(new Float32Array(n.PARTICLE_COUNT),1).setDynamic(!0)),n.particleSystem=new be.Points(n.geometry,n.material),n.particleSystem.frustumCulled=!1,n.add(n.particleSystem),n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"geometryUpdate",value:function(){var t=this;!0===this.particleUpdate&&(this.particleUpdate=!1,Ae.forEach(function(e){var n=t.geometry.getAttribute(e);t.offset+t.count<t.PARTICLE_COUNT?(n.updateRange.offset=t.offset*n.itemSize,n.updateRange.count=t.count*n.itemSize):(n.updateRange.offset=0,n.updateRange.count=-1),n.needsUpdate=!0}),this.offset=0,this.count=0)}},{key:"random",value:function(){return++this.i>=this.rand.length?this.rand[this.i=1]:this.rand[this.i]}},{key:"update",value:function(t){this.time=t/1e3,this.material.uniforms.uTime.value=this.time,this.onTick&&this.onTick(this,this.time),this.geometryUpdate()}},{key:"dispose",value:function(){this.material.dispose(),this.sprite.dispose(),this.geometry.dispose()}},{key:"updateSprite",value:function(t){if(t){var e=this.sprite;this.sprite=t,this.sprite.wrapS=this.sprite.wrapT=be.RepeatWrapping,this.material.uniforms.tSprite.value=t,e&&e.dispose()}}},{key:"spawnParticle",value:function(t){var e=new be.Vector3,n=new be.Vector3,r=new be.Vector3,a=new be.Color,o=new be.Color,s=this.geometry.getAttribute("positionStart"),i=this.geometry.getAttribute("startTime"),c=this.geometry.getAttribute("velocity"),u=this.geometry.getAttribute("acceleration"),p=this.geometry.getAttribute("color"),l=this.geometry.getAttribute("endColor"),d=this.geometry.getAttribute("size"),f=this.geometry.getAttribute("lifeTime");e=void 0!==(t=t||{}).position?e.copy(t.position):e.set(0,0,0),n=void 0!==t.velocity?n.copy(t.velocity):n.set(0,0,0),r=void 0!==t.acceleration?r.copy(t.acceleration):r.set(0,0,0),a=void 0!==t.color?a.copy(t.color):a.set(16777215),o=void 0!==t.endColor?o.copy(t.endColor):o.copy(a);var m=void 0!==t.lifetime?t.lifetime:5,v=void 0!==t.size?t.size:10,b=void 0!==t.sizeRandomness?t.sizeRandomness:0;void 0!==this.DPR&&(v*=this.DPR);var h=this.PARTICLE_CURSOR;s.array[3*h+0]=e.x,s.array[3*h+1]=e.y,s.array[3*h+2]=e.z,c.array[3*h+0]=n.x,c.array[3*h+1]=n.y,c.array[3*h+2]=n.z,u.array[3*h+0]=r.x,u.array[3*h+1]=r.y,u.array[3*h+2]=r.z,p.array[3*h+0]=a.r,p.array[3*h+1]=a.g,p.array[3*h+2]=a.b,l.array[3*h+0]=o.r,l.array[3*h+1]=o.g,l.array[3*h+2]=o.b,d.array[h]=v+this.random()*b,f.array[h]=m,i.array[h]=this.time+.02*this.random(),0===this.offset&&(this.offset=this.PARTICLE_CURSOR),this.count++,this.PARTICLE_CURSOR++,this.PARTICLE_CURSOR>=this.PARTICLE_COUNT&&(this.PARTICLE_CURSOR=0),this.particleUpdate=!0}}]),e}(be.Object3D),Be=function(t,e){return Math.random()*(e-t)+t},Ue=0,He=function(t){function e(){return Object(i.a)(this,e),Object(u.a)(this,Object(p.a)(e).apply(this,arguments))}return Object(l.a)(e,t),Object(c.a)(e,[{key:"make",value:function(t,e){if(!e.id)throw new Error("can't create cube w/ missing parent");return st(t,t.createObject({type:_e.particles,title:"particles "+Ue++,visible:!0,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,children:t.createArray(),pointSize:10,lifetime:3,startColor:"#ff0000",endColor:"#0000ff",parent:e.id,texture:$e.id}))}},{key:"makeNode",value:function(t,e){var n={velocity:new be.Vector3(0,1,0),position:new be.Vector3(0,0,0),size:t.pointSize,lifetime:t.lifetime,color:new be.Color(1,0,1),endColor:new be.Color(0,1,1)},r=new Fe({maxParticles:1e4,position:new be.Vector3(0,0,0),positionRandomness:0,baseVelocity:new be.Vector3(0,0,-1),velocity:new be.Vector3(0,0,0),velocityRandomness:1,acceleration:new be.Vector3(0,0,0),baseColor:new be.Color(1,1,.5),color:new be.Color(1,0,0),colorRandomness:.5,lifetime:3,size:10,sizeRandomness:1,blending:be.AdditiveBlending,onTick:function(t,e){n.velocity.set(Be(-1,1),1,Be(-1,1)),t.spawnParticle(n)}});return r.tick=function(t){r.update(t.time)},this.attachTexture(r,t,e),r.userData.options=n,r.name=t.title,r.userData.clickable=!1,r.position.set(t.tx,t.ty,t.tz),r.rotation.set(t.rx,t.ry,t.rz),r.scale.set(t.sx,t.sy,t.sz),r.visible=t.visible,r}},{key:"updateProperty",value:function(t,n,r,a){return r.name===Ye.pointSize.key?t.userData.options.size=n.pointSize:r.name===Ye.lifetime.key?t.userData.options.lifetime=n.lifetime:r.name===Ye.startColor.key?t.userData.options.color.set(n.startColor):r.name===Ye.endColor.key?t.userData.options.endColor.set(n.endColor):r.name===Ye.texture.key?this.attachTexture(t,n,a):Object(f.a)(Object(p.a)(e.prototype),"updateProperty",this).call(this,t,n,r,a)}},{key:"attachTexture",value:function(t,e,n){if(e.asset!==$e.id){var r=n.accessObject(e.texture);if(r.exists()){var a=n.assetsManager.getAssetURL(r);n.getLogger().log("ParticlesDef: loading the asset url",a);var o=(new be.TextureLoader).load(a);t.updateSprite(o)}}else t.updateSprite(null)}}]),e}(he),Ve=0,We=function(t){function e(){return Object(i.a)(this,e),Object(u.a)(this,Object(p.a)(e).apply(this,arguments))}return Object(l.a)(e,t),Object(c.a)(e,[{key:"make",value:function(t,e){if(!e.id)throw new Error("can't localanchor w/ missing parent");return st(t,t.createObject({type:_e.localanchor,title:"localanchor "+Ve++,visible:!0,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,color:"#00ff00",children:t.createArray(),recType:fn.SCENE_START,parent:e.id}))}},{key:"makeNode",value:function(t,e){var n=new be.Group;n.name=t.title,n.userData.clickable=!0,n.position.set(t.tx,t.ty,t.tz),n.rotation.set(t.rx,t.ry,t.rz),n.scale.set(t.sx,t.sy,t.sz),n.visible=t.visible;var r=new be.Mesh(new be.SphereBufferGeometry(1),new be.MeshLambertMaterial({color:"blue",transparent:!0,opacity:.2}));r.material.visible=!0,r.userData.clickable=!0,n.userData.clicker=r,n.add(r);var a=new be.Mesh(new be.PlaneBufferGeometry(1,1),new be.MeshLambertMaterial({color:"white",transparent:!0,opacity:.5,side:be.DoubleSide}));return a.rotation.x=sn(90),n.add(a),n.userData.preview=a,n.enter=function(e,o){r.visible=!1,n.visible=!1,a.visible=!1,n.userData.info={recType:t.recType,object:t,node:n,callback:function(e){o.fireEventAtTarget(t,"recognized",e),n.visible=!0}},o.sgp.startLocalAnchor(n.userData.info)},n.exit=function(t,e){r.visible=!0,a.visible=!0,e.sgp.stopLocalAnchor(n.userData.info)},n}},{key:"updateProperty",value:function(t,n,r,a){return Object(f.a)(Object(p.a)(e.prototype),"updateProperty",this).call(this,t,n,r,a)}}]),e}(he),Ke=0,Ze=function(t){function e(){return Object(i.a)(this,e),Object(u.a)(this,Object(p.a)(e).apply(this,arguments))}return Object(l.a)(e,t),Object(c.a)(e,[{key:"make",value:function(t,e){if(!e.id)throw new Error("can't imageanchor w/ missing parent");return st(t,t.createObject({type:_e.imageanchor,title:"image anchor "+Ke++,visible:!0,reactivate:!1,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,color:"#00ff00",children:t.createArray(),targetImage:null,imageRealworldWidth:1,recType:fn.SCENE_START,parent:e.id}))}},{key:"makeNode",value:function(t,e){var n=new be.Group;n.name=t.title,n.userData.clickable=!0,n.position.set(t.tx,t.ty,t.tz),n.rotation.set(t.rx,t.ry,t.rz),n.scale.set(t.sx,t.sy,t.sz),n.visible=t.visible;var r=new be.Mesh(new be.SphereBufferGeometry(1),new be.MeshLambertMaterial({color:"red",transparent:!0,opacity:.2}));r.material.visible=!0,r.userData.clickable=!0,n.userData.clicker=r,n.add(r);var a=new be.Mesh(new be.PlaneBufferGeometry(1,1),new be.MeshLambertMaterial({color:"white",transparent:!0,opacity:.5,side:be.DoubleSide}));return a.rotation.x=sn(90),n.add(a),n.userData.preview=a,this.updateImagePreview(n,t,e),n.enter=function(e,o){r.visible=!1,n.visible=!1,a.visible=!1,n.userData.info={image:o.sgp.getGraphObjectById(t.targetImage),imageRealworldWidth:t.imageRealworldWidth,reactivate:t.reactivate,recType:t.recType,object:t,node:n,callback:function(e){o.fireEventAtTarget(t,"recognized",e),n.visible=!0}},o.sgp.startImageRecognizer(n.userData.info)},n.exit=function(t,e){r.visible=!0,a.visible=!0,e.sgp.stopImageRecognizer(n.userData.info)},n}},{key:"updateProperty",value:function(t,n,r,a){return r.name===Ye.targetImage.key?this.updateImagePreview(t,n,a):r.name===Ye.imageRealworldWidth.key?this.updateImagePreview(t,n,a):Object(f.a)(Object(p.a)(e.prototype),"updateProperty",this).call(this,t,n,r,a)}},{key:"updateImagePreview",value:function(t,e,n){var r=n.accessObject(e.targetImage);if(r.exists()){var a=n.assetsManager.getAssetURL(r);n.getLogger().log("ImageAnchor loading the asset url",a);var o=(new be.TextureLoader).load(a);t.userData.preview.material=new be.MeshLambertMaterial({color:"white",transparent:!0,opacity:.5,side:be.DoubleSide,map:o});var s=r.height/r.width;t.userData.preview.geometry=new be.PlaneBufferGeometry(1,s);var i=e.imageRealworldWidth;t.userData.preview.scale.set(i,i,i)}n.accessObject(e.targetImage).exists()?(t.userData.preview.visible=!0,t.userData.clicker.visible=!1):(t.userData.preview.visible=!1,t.userData.clicker.visible=!0)}}]),e}(he),qe=0,Qe=function(t){function e(){return Object(i.a)(this,e),Object(u.a)(this,Object(p.a)(e).apply(this,arguments))}return Object(l.a)(e,t),Object(c.a)(e,[{key:"make",value:function(t,e){if(!e.id)throw new Error("can't create geo anchor w/ missing parent");return st(t,t.createObject({type:_e.geoanchor,title:"geo anchor "+qe++,visible:!0,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,color:"#00ff00",children:t.createArray(),targetGeoLocation:null,recType:fn.SCENE_START,parent:e.id}))}},{key:"makeNode",value:function(t){var e=new be.Group;e.name=t.title,e.userData.clickable=!0,e.position.set(t.tx,t.ty,t.tz),e.rotation.set(t.rx,t.ry,t.rz),e.scale.set(t.sx,t.sy,t.sz),e.visible=t.visible;var n=new be.Mesh(new be.SphereBufferGeometry(1),new be.MeshLambertMaterial({color:"red",transparent:!0,opacity:.2}));return n.material.visible=!0,n.userData.clickable=!0,e.userData.clicker=n,e.add(n),e.enter=function(r,a){n.visible=!1,e.visible=!1,e.userData.info={location:a.sgp.getGraphObjectById(t.targetGeoLocation),recType:t.recType,object:t,node:e,callback:function(n){a.fireEventAtTarget(t,"localized",n),e.visible=!0}},a.sgp.startGeoTracker(e.userData.info)},e.exit=function(t,r){n.visible=!0,r.sgp.stopGeoTracker(e.userData.info)},e}}]),e}(he),ze=0,Je=function(t){function e(){return Object(i.a)(this,e),Object(u.a)(this,Object(p.a)(e).apply(this,arguments))}return Object(l.a)(e,t),Object(c.a)(e,[{key:"make",value:function(t,e){if(!e.id)throw new Error("can't add hudanchor w/ missing parent");return st(t,t.createObject({type:_e.hudanchor,title:"hud anchor "+ze++,visible:!0,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,children:t.createArray(),parent:e.id}))}},{key:"makeNode",value:function(t,e){var n=new be.Group;n.name=t.title,n.userData.clickable=!0,n.position.set(t.tx,t.ty,t.tz),n.rotation.set(t.rx,t.ry,t.rz),n.scale.set(t.sx,t.sy,t.sz),n.visible=t.visible;var r=new be.Mesh(new be.SphereBufferGeometry(1),new be.MeshLambertMaterial({color:"red",transparent:!0,opacity:.2}));return r.material.visible=!0,r.userData.clickable=!0,n.userData.clicker=r,n.add(r),n.enter=function(t,e){n.parent.remove(n),n.position.z=0,r.visible=!1,e.sgp.getCamera().add(n)},n.exit=function(e,a){a.sgp.getCamera().remove(n),r.visible=!0,a.sgp.getThreeObject(t.parent).add(n),n.position.set(t.tx,t.ty,t.tz),n.rotation.set(t.rx,t.ry,t.rz),n.scale.set(t.sx,t.sy,t.sz)},n}},{key:"updateProperty",value:function(t,n,r,a){return Object(f.a)(Object(p.a)(e.prototype),"updateProperty",this).call(this,t,n,r,a)}}]),e}(he),$e={id:-30,title:"NONE"},Xe={incrementValue:.1},Ye={title:{key:"title",name:"Title",type:_.STRING},description:{key:"description",name:"Description",type:_.STRING},width:{key:"width",name:"Width",type:_.NUMBER,hints:Xe},height:{key:"height",name:"Height",type:_.NUMBER,hints:Xe},depth:{key:"depth",name:"Depth",type:_.NUMBER,hints:Xe},radius:{key:"radius",name:"Radius",type:_.NUMBER,hints:Xe},tx:{key:"tx",name:"TX",type:_.NUMBER,hints:Xe},ty:{key:"ty",name:"TY",type:_.NUMBER,hints:Xe},tz:{key:"tz",name:"TZ",type:_.NUMBER,hints:Xe},rx:{key:"rx",name:"RX",type:_.NUMBER,hints:Xe},ry:{key:"ry",name:"RY",type:_.NUMBER,hints:Xe},rz:{key:"rz",name:"RZ",type:_.NUMBER,hints:Xe},sx:{key:"sx",name:"SX",type:_.NUMBER,hints:Xe},sy:{key:"sy",name:"SY",type:_.NUMBER,hints:Xe},sz:{key:"sz",name:"SZ",type:_.NUMBER,hints:Xe},color:{key:"color",name:"Color",type:_.COLOR,custom:!0},defaultFloor:{key:"defaultFloor",name:"Default Floor",type:_.BOOLEAN},src:{key:"src",name:"src",type:_.STRING,locked:!0},asset:{key:"asset",name:"asset",type:_.ENUM},subtype:{key:"subtype",name:"kind",type:_.STRING,locked:!0},format:{key:"format",name:"format",type:_.STRING,locked:!0},imageOffsetAngle:{key:"imageOffsetAngle",name:"Image Offset Angle",type:_.NUMBER,hints:{incrementValue:.05}},imageCropStartAngle:{key:"imageCropStartAngle",name:"Image Crop Start Angle",type:_.NUMBER,hints:{incrementValue:.05}},imageCropEndAngle:{key:"imageCropEndAngle",name:"Image Crop End Angle",type:_.NUMBER,hints:{incrementValue:.05}},transparent:{key:"transparent",name:"Transparent",type:_.BOOLEAN},imageRealworldWidth:{key:"imageRealworldWidth",name:"Image width in meters",type:_.NUMBER,hints:{incrementValue:.01}},recType:{key:"recType",name:"Recognition Type",type:_.ENUM},targetImage:{key:"targetImage",name:"Image to Recognize",type:_.ENUM},targetGeoLocation:{key:"targetGeoLocation",name:"Target Location",type:_.ENUM},splashImage:{key:"splashImage",name:"Splash Image",type:_.ENUM},text:{key:"text",name:"Text",type:_.STRING,hints:{multiline:!0}},fontSize:{key:"fontSize",name:"Font Size",type:_.NUMBER},padding:{key:"padding",name:"Padding",type:_.NUMBER},borderWidth:{key:"borderWidth",name:"Border width",type:_.NUMBER},borderRadius:{key:"borderRadius",name:"Corner Size",type:_.NUMBER},horizontalAlign:{key:"horizontalAlign",name:"H Align",type:_.ENUM,locked:!1},textColor:{key:"textColor",name:"Text Color",type:_.COLOR,custom:!0},backgroundColor:{key:"backgroundColor",name:"BG Color",type:_.COLOR,custom:!0},borderColor:{key:"borderColor",name:"Border Color",type:_.COLOR,custom:!0},startColor:{key:"startColor",name:"Start",type:_.COLOR,custom:!0},endColor:{key:"endColor",name:"End",type:_.COLOR,custom:!0},drawBackground:{key:"drawBackground",name:"BG?",type:_.BOOLEAN},scriptBody:{key:"scriptBody",name:"code",type:_.STRING,hints:{multiline:!0}},defaultScene:{key:"defaultScene",name:"Start Scene",type:_.ENUM},visible:{key:"visible",name:"Visible",type:_.BOOLEAN},reactivate:{key:"reactivate",name:"Reactivate Image Search",type:_.BOOLEAN},pointSize:{key:"pointSize",name:"Point Size",type:_.NUMBER},lifetime:{key:"lifetime",name:"Lifetime",type:_.NUMBER,hints:Xe},texture:{key:"texture",name:"texture",type:_.ENUM},cssStyle:{key:"cssStyle",name:"Style",type:_.STRING,hints:{multiline:!0}},latitude:{key:"latitude",name:"Latitude",type:_.NUMBER},longitude:{key:"longitude",name:"Longitude",type:_.NUMBER},altitude:{key:"altitude",name:"altitude",type:_.NUMBER},useAltitude:{key:"useAltitude",name:"use altitude?",type:_.BOOLEAN},autoRecenter:{key:"autoRecenter",name:"Recenter on Load",type:_.BOOLEAN}},Le=["#ffffff","#ff0000","#ffff00","#00ff00","#00ffff","#0000ff","#ff00ff","#000000"],_e={cube:"cube",sphere:"sphere",plane:"plane",model:"model",bg360:"bg360",text:"text",img2d:"img2d",group:"group",particles:"particles",localanchor:"localanchor",imageanchor:"imageanchor",geoanchor:"geoanchor",hudanchor:"hudanchor"},tn={SCENE:"scene",ASSET:"asset",BEHAVIOR:"behavior",BEHAVIOR_SCRIPT:"behavior_script",ASSETS_LIST:"assets",BEHAVIORS_LIST:"behaviors",ROOT:"root"},en={LEFT:"LEFT",CENTER:"CENTER",RIGHT:"RIGHT"};function nn(t){return t===_e.cube||(t===_e.sphere||(t===_e.plane||(t===_e.model||(t===_e.text||(t===_e.bg360||(t===_e.img2d||(t===_e.group||(t===_e.particles||(t===_e.localanchor||(t===_e.imageanchor||(t===_e.geoanchor||t===_e.hudanchor)))))))))))}function rn(t){return t===_e.group||(t===_e.localanchor||(t===_e.imageanchor||(t===_e.geoanchor||(t===_e.hudanchor||t===tn.SCENE))))}function an(t){return t!==tn.ROOT&&(t!==tn.ASSETS_LIST&&t!==tn.BEHAVIORS_LIST)}function on(t){if(t===_e.cube)return new Oe;if(t===_e.sphere)return new ke;if(t===_e.plane)return new we;if(t===_e.model)return new De;if(t===_e.bg360)return new Re;if(t===_e.text)return new Ie;if(t===_e.img2d)return new Te;if(t===_e.group)return new Ne;if(t===_e.particles)return new He;if(t===_e.localanchor)return new We;if(t===_e.imageanchor)return new Ze;if(t===_e.geoanchor)return new Qe;if(t===_e.hudanchor)return new Je;throw new Error("unknown 3d object type ".concat(t))}var sn=function(t){return t*Math.PI/180},cn={PNG:"image/png",JPEG:"image/jpeg",GIF:"image/gif",MP3:"audio/mpeg",AAC:"audio/aac",WAV:"audio/wav",JAVASCRIPT:"text/javascript",GLB:"model/gltf-binary",MP4:"video/mp4",MOV:"video/quicktime"},un={BEHAVIOR:"behavior",IMAGE:"image",GLTF:"gltf",AUDIO:"audio",VIDEO:"video",GEOLOCATION:"geolocation"};function pn(t){return!!t&&(t.toLowerCase()===cn.PNG||(t.toLowerCase()===cn.JPEG||t.toLowerCase()===cn.GIF))}var ln={plane:"plane",cube:"square",sphere:"circle",model:"cube",asset:"file",assets:"archive",behavior:"superpowers",behavior_script:"superpowers",scene:"globe",bg360:"image",img2d:"image",image:"image",text:"font",audio:"music",video:"video-camera",group:"object-group",particles:"certificate",gltf:"cube",localanchor:"anchor",imageanchor:"anchor",geoanchor:"globe",geolocation:"globe",hudanchor:"eye",cut:"cut",copy:"copy",paste:"paste",delete:"close"};function dn(t){return Function('"use strict";\n    const toRadians = (deg) => Math.PI/180*deg; \n    return('.concat(t,")"))()}var fn={SCENE_START:"SCENE_START"},mn=n(1),vn=function(t,e){var n,r,a,o,s;this.object=t,this.domElement=void 0!==e?e:document,this.enabled=!0,this.target=new mn.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.25,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.enableKeys=!0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={ORBIT:mn.MOUSE.LEFT,ZOOM:mn.MOUSE.MIDDLE,PAN:mn.MOUSE.RIGHT},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=function(){return m.phi},this.getAzimuthalAngle=function(){return m.theta},this.saveState=function(){i.target0.copy(i.target),i.position0.copy(i.object.position),i.zoom0=i.object.zoom},this.reset=function(){i.target.copy(i.target0),i.object.position.copy(i.position0),i.object.zoom=i.zoom0,i.object.updateProjectionMatrix(),i.dispatchEvent(c),i.update(),d=l.NONE},this.update=(n=new mn.Vector3,r=(new mn.Quaternion).setFromUnitVectors(t.up,new mn.Vector3(0,1,0)),a=r.clone().inverse(),o=new mn.Vector3,s=new mn.Quaternion,function(){var t=i.object.position;return n.copy(t).sub(i.target),n.applyQuaternion(r),m.setFromVector3(n),i.autoRotate&&d===l.NONE&&R(2*Math.PI/60/60*i.autoRotateSpeed),m.theta+=v.theta,m.phi+=v.phi,m.theta=Math.max(i.minAzimuthAngle,Math.min(i.maxAzimuthAngle,m.theta)),m.phi=Math.max(i.minPolarAngle,Math.min(i.maxPolarAngle,m.phi)),m.makeSafe(),m.radius*=b,m.radius=Math.max(i.minDistance,Math.min(i.maxDistance,m.radius)),i.target.add(h),n.setFromSpherical(m),n.applyQuaternion(a),t.copy(i.target).add(n),i.object.lookAt(i.target),!0===i.enableDamping?(v.theta*=1-i.dampingFactor,v.phi*=1-i.dampingFactor):v.set(0,0,0),b=1,h.set(0,0,0),!!(y||o.distanceToSquared(i.object.position)>f||8*(1-s.dot(i.object.quaternion))>f)&&(i.dispatchEvent(c),o.copy(i.object.position),s.copy(i.object.quaternion),y=!1,!0)}),this.dispose=function(){i.domElement.removeEventListener("contextmenu",q,!1),i.domElement.removeEventListener("mousedown",F,!1),i.domElement.removeEventListener("wheel",H,!1),i.domElement.removeEventListener("touchstart",W,!1),i.domElement.removeEventListener("touchend",Z,!1),i.domElement.removeEventListener("touchmove",K,!1),document.removeEventListener("mousemove",B,!1),document.removeEventListener("mouseup",U,!1),window.removeEventListener("keydown",V,!1)};var i=this,c={type:"change"},u={type:"start"},p={type:"end"},l={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},d=l.NONE,f=1e-6,m=new mn.Spherical,v=new mn.Spherical,b=1,h=new mn.Vector3,y=!1,O=new mn.Vector2,k=new mn.Vector2,w=new mn.Vector2,g=new mn.Vector2,S=new mn.Vector2,C=new mn.Vector2,E=new mn.Vector2,M=new mn.Vector2,j=new mn.Vector2;function D(){return Math.pow(.95,i.zoomSpeed)}function R(t){v.theta-=t}function P(t){v.phi-=t}var I,T=(I=new mn.Vector3,function(t,e){I.setFromMatrixColumn(e,0),I.multiplyScalar(-t),h.add(I)}),x=function(){var t=new mn.Vector3;return function(e,n){t.setFromMatrixColumn(n,1),t.multiplyScalar(e),h.add(t)}}(),N=function(){var t=new mn.Vector3;return function(e,n){var r=i.domElement===document?i.domElement.body:i.domElement;if(i.object.isPerspectiveCamera){var a=i.object.position;t.copy(a).sub(i.target);var o=t.length();o*=Math.tan(i.object.fov/2*Math.PI/180),T(2*e*o/r.clientHeight,i.object.matrix),x(2*n*o/r.clientHeight,i.object.matrix)}else i.object.isOrthographicCamera?(T(e*(i.object.right-i.object.left)/i.object.zoom/r.clientWidth,i.object.matrix),x(n*(i.object.top-i.object.bottom)/i.object.zoom/r.clientHeight,i.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),i.enablePan=!1)}}();function G(t){i.object.isPerspectiveCamera?b/=t:i.object.isOrthographicCamera?(i.object.zoom=Math.max(i.minZoom,Math.min(i.maxZoom,i.object.zoom*t)),i.object.updateProjectionMatrix(),y=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),i.enableZoom=!1)}function A(t){i.object.isPerspectiveCamera?b*=t:i.object.isOrthographicCamera?(i.object.zoom=Math.max(i.minZoom,Math.min(i.maxZoom,i.object.zoom/t)),i.object.updateProjectionMatrix(),y=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),i.enableZoom=!1)}function F(t){if(!1!==i.enabled){switch(t.preventDefault(),t.button){case i.mouseButtons.ORBIT:if(!1===i.enableRotate)return;!function(t){O.set(t.clientX,t.clientY)}(t),d=l.ROTATE;break;case i.mouseButtons.ZOOM:if(!1===i.enableZoom)return;!function(t){E.set(t.clientX,t.clientY)}(t),d=l.DOLLY;break;case i.mouseButtons.PAN:if(!1===i.enablePan)return;!function(t){g.set(t.clientX,t.clientY)}(t),d=l.PAN}d!==l.NONE&&(document.addEventListener("mousemove",B,!1),document.addEventListener("mouseup",U,!1),i.dispatchEvent(u))}}function B(t){if(!1!==i.enabled)switch(t.preventDefault(),d){case l.ROTATE:if(!1===i.enableRotate)return;!function(t){k.set(t.clientX,t.clientY),w.subVectors(k,O);var e=i.domElement===document?i.domElement.body:i.domElement;R(2*Math.PI*w.x/e.clientWidth*i.rotateSpeed),P(2*Math.PI*w.y/e.clientHeight*i.rotateSpeed),O.copy(k),i.update()}(t);break;case l.DOLLY:if(!1===i.enableZoom)return;!function(t){M.set(t.clientX,t.clientY),j.subVectors(M,E),j.y>0?G(D()):j.y<0&&A(D()),E.copy(M),i.update()}(t);break;case l.PAN:if(!1===i.enablePan)return;!function(t){S.set(t.clientX,t.clientY),C.subVectors(S,g),N(C.x,C.y),g.copy(S),i.update()}(t)}}function U(t){!1!==i.enabled&&(document.removeEventListener("mousemove",B,!1),document.removeEventListener("mouseup",U,!1),i.dispatchEvent(p),d=l.NONE)}function H(t){!1===i.enabled||!1===i.enableZoom||d!==l.NONE&&d!==l.ROTATE||(t.preventDefault(),t.stopPropagation(),function(t){t.deltaY<0?A(D()):t.deltaY>0&&G(D()),i.update()}(t),i.dispatchEvent(u),i.dispatchEvent(p))}function V(t){!1!==i.enabled&&!1!==i.enableKeys&&!1!==i.enablePan&&function(t){switch(t.keyCode){case i.keys.UP:N(0,i.keyPanSpeed),i.update();break;case i.keys.BOTTOM:N(0,-i.keyPanSpeed),i.update();break;case i.keys.LEFT:N(i.keyPanSpeed,0),i.update();break;case i.keys.RIGHT:N(-i.keyPanSpeed,0),i.update()}}(t)}function W(t){if(!1!==i.enabled){switch(t.touches.length){case 1:if(!1===i.enableRotate)return;!function(t){O.set(t.touches[0].pageX,t.touches[0].pageY)}(t),d=l.TOUCH_ROTATE;break;case 2:if(!1===i.enableZoom)return;!function(t){var e=t.touches[0].pageX-t.touches[1].pageX,n=t.touches[0].pageY-t.touches[1].pageY,r=Math.sqrt(e*e+n*n);E.set(0,r)}(t),d=l.TOUCH_DOLLY;break;case 3:if(!1===i.enablePan)return;!function(t){g.set(t.touches[0].pageX,t.touches[0].pageY)}(t),d=l.TOUCH_PAN;break;default:d=l.NONE}d!==l.NONE&&i.dispatchEvent(u)}}function K(t){if(!1!==i.enabled)switch(t.preventDefault(),t.stopPropagation(),t.touches.length){case 1:if(!1===i.enableRotate)return;if(d!==l.TOUCH_ROTATE)return;!function(t){k.set(t.touches[0].pageX,t.touches[0].pageY),w.subVectors(k,O);var e=i.domElement===document?i.domElement.body:i.domElement;R(2*Math.PI*w.x/e.clientWidth*i.rotateSpeed),P(2*Math.PI*w.y/e.clientHeight*i.rotateSpeed),O.copy(k),i.update()}(t);break;case 2:if(!1===i.enableZoom)return;if(d!==l.TOUCH_DOLLY)return;!function(t){var e=t.touches[0].pageX-t.touches[1].pageX,n=t.touches[0].pageY-t.touches[1].pageY,r=Math.sqrt(e*e+n*n);M.set(0,r),j.subVectors(M,E),j.y>0?A(D()):j.y<0&&G(D()),E.copy(M),i.update()}(t);break;case 3:if(!1===i.enablePan)return;if(d!==l.TOUCH_PAN)return;!function(t){S.set(t.touches[0].pageX,t.touches[0].pageY),C.subVectors(S,g),N(C.x,C.y),g.copy(S),i.update()}(t);break;default:d=l.NONE}}function Z(t){!1!==i.enabled&&(i.dispatchEvent(p),d=l.NONE)}function q(t){!1!==i.enabled&&t.preventDefault()}i.domElement.addEventListener("contextmenu",q,!1),i.domElement.addEventListener("mousedown",F,!1),i.domElement.addEventListener("wheel",H,!1),i.domElement.addEventListener("touchstart",W,!1),i.domElement.addEventListener("touchend",Z,!1),i.domElement.addEventListener("touchmove",K,!1),this.update()};(vn.prototype=Object.create(mn.EventDispatcher.prototype)).constructor=mn.OrbitControls,Object.defineProperties(vn.prototype,{center:{get:function(){return console.warn("THREE.OrbitControls: .center has been renamed to .target"),this.target}},noZoom:{get:function(){return console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),!this.enableZoom},set:function(t){console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),this.enableZoom=!t}},noRotate:{get:function(){return console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),!this.enableRotate},set:function(t){console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),this.enableRotate=!t}},noPan:{get:function(){return console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),!this.enablePan},set:function(t){console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),this.enablePan=!t}},noKeys:{get:function(){return console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),!this.enableKeys},set:function(t){console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),this.enableKeys=!t}},staticMoving:{get:function(){return console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),!this.enableDamping},set:function(t){console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),this.enableDamping=!t}},dynamicDampingFactor:{get:function(){return console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor},set:function(t){console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor=t}}});var bn=vn,hn=function(t){function e(){var t,n;Object(i.a)(this,e);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=Object(u.a)(this,(t=Object(p.a)(e)).call.apply(t,[this].concat(a)))).renderThree=function(t){var e=(t-n.prevTime)/1e3;n.checkAspectRatio(),n.controls.update(),n.mixer&&n.mixer.update(e),n.renderer.render(n.scene,n.camera),n.prevTime=t},n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"componentDidMount",value:function(){this.initThreeJS()}},{key:"componentWillReceiveProps",value:function(t,e){this.props.asset&&t.asset.id!==this.props.asset.id&&this.swapModel(t.asset)}},{key:"swapModel",value:function(t){var e=this;this.model&&this.scene.remove(this.model);var n=this.props.provider.assetsManager.getAssetURL(t);if(this.props.provider.getLogger().log("GLTFAssetView loading the url",n),n){var r=new Se;r.setCrossOrigin("anonymous");var a=new Ee;Ee.setDecoderPath("./draco/"),r.setDRACOLoader(a),r.load(n,function(t){console.log("loaded",n);var r=t.scene||t.scenes[0];e.model=je.clone(r),(r=e.model).updateMatrixWorld();var a=t.animations||[];e.setClips(a);var o=(new be.Box3).setFromObject(r),s=o.getSize(new be.Vector3).length(),i=o.getCenter(new be.Vector3);e.controls.reset(),r.position.x+=r.position.x-i.x,r.position.y+=r.position.y-i.y,r.position.z+=r.position.z-i.z,e.controls.maxDistance=10*s,e.camera.near=s/100,e.camera.far=100*s,e.camera.updateProjectionMatrix(),e.camera.position.copy(i),e.camera.position.x+=s/2,e.camera.position.y+=s/5,e.camera.position.z+=s/2,e.camera.lookAt(i),e.controls.enabled=!0,e.playAllClips(),e.scene.add(r)})}else this.props.provider.getLogger().error("GLTFAssetView url is empty!")}},{key:"render",value:function(){var t=this;return a.a.createElement("div",{id:"gltf-viewer",ref:function(e){return t.sceneContainer=e}})}},{key:"initThreeJS",value:function(){this.scene=new be.Scene,this.scene.background=new be.Color(0),this.camera=new be.PerspectiveCamera(70,window.innerWidth/window.innerHeight,.1,1e3),this.scene.add(this.camera),this.renderer=new be.WebGLRenderer({antialias:!0}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.gammaOutput=!0,this.sceneContainer.appendChild(this.renderer.domElement),this.clips=[],this.mixer=null,this.model=null,this.controls=new bn(this.camera,this.renderer.domElement),this.controls.screenSpacePanning=!0,this.renderer.setAnimationLoop(this.renderThree);var t=new be.DirectionalLight(16777215,1);t.position.set(1,1,1).normalize(),this.scene.add(t),this.scene.add(new be.AmbientLight(16777215,.2)),this.swapModel(this.props.asset)}},{key:"playAllClips",value:function(){var t=this;this.clips.forEach(function(e){t.mixer.clipAction(e).reset().play()})}},{key:"setClips",value:function(t){this.mixer&&(this.mixer.stopAllAction(),this.mixer.uncacheRoot(this.mixer.getRoot()),this.mixer=null),t.forEach(function(t){t.validate()&&t.optimize()}),t.length&&(this.clips=t,this.mixer=new be.AnimationMixer(this.model))}},{key:"checkAspectRatio",value:function(){if(this.renderer&&this.renderer.domElement&&this.sceneContainer){var t=this.sceneContainer.clientWidth,e=this.sceneContainer.clientHeight,n=t/e;Math.abs(this.camera.aspect-n)>.001&&(this.camera.aspect=n,this.camera.updateProjectionMatrix(),this.renderer.setSize(t-4,e-4))}}}]),e}(r.Component),yn=n(22),On=(n(62),function(t){function e(t,n){var r;return Object(i.a)(this,e),(r=Object(u.a)(this,Object(p.a)(e).call(this,t,n))).loadCurrentLocation=function(){navigator.geolocation.getCurrentPosition(function(t){console.log("success",t);var e=t.coords;r.props.provider.quick_setPropertyValue(r.props.asset.id,"latitude",e.latitude),r.props.provider.quick_setPropertyValue(r.props.asset.id,"longitude",e.longitude)},function(t){console.log("error",t)})},r.onMapClick=function(t){r.props.provider.quick_setPropertyValue(r.props.asset.id,"latitude",t.latlng.lat),r.props.provider.quick_setPropertyValue(r.props.asset.id,"longitude",t.latlng.lng)},r.updateLocation=function(t){var e=r.props.provider.accessObject(r.props.asset.id),n=Object(yn.b)({lat:e.latitude,lon:e.longitude});r.marker.setLatLng(n),r.mymap.panTo(n)},r}return Object(l.a)(e,t),Object(c.a)(e,[{key:"render",value:function(){var t=this;return a.a.createElement("div",null,a.a.createElement(d.c,null,a.a.createElement("button",{onClick:this.loadCurrentLocation},"set to current location")),a.a.createElement("div",{id:"mapid",ref:function(e){return t.div=e},style:{width:"400px",height:"400px",border:"1px solid black"}}))}},{key:"componentWillReceiveProps",value:function(t,e){t.asset.id!==this.props.asset.id&&this.updateLocation()}},{key:"componentDidMount",value:function(){this.mymap=Object(yn.c)("mapid").setView([this.props.asset.longitude,this.props.asset.latitude],18),Object(yn.e)("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw",{maxZoom:18,attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery \xa9 <a href="https://www.mapbox.com/">Mapbox</a>',id:"mapbox.streets"}).addTo(this.mymap),this.mymap.on("click",this.onMapClick);var t=Object(yn.a)({className:"map-icon"});this.marker=Object(yn.d)([this.props.asset.longitude,this.props.asset.latitude],{title:"this is the geo location",icon:t}).addTo(this.mymap),this.props.provider.on(B.PROPERTY_CHANGED,this.updateLocation),this.updateLocation()}},{key:"componentWillUnmount",value:function(){this.props.provider.off(B.PROPERTY_CHANGED,this.updateLocation)}}]),e}(r.Component)),kn=function(t){function e(){return Object(i.a)(this,e),Object(u.a)(this,Object(p.a)(e).apply(this,arguments))}return Object(l.a)(e,t),Object(c.a)(e,[{key:"render",value:function(){var t=st(this.props.provider.getDataGraph(),this.props.asset);return a.a.createElement("div",{id:"asset-view"},a.a.createElement("h3",null,t.subtype," : ",a.a.createElement("b",null,t.title)),this.renderAsset(t))}},{key:"renderAsset",value:function(t){var e=this.props.provider.assetsManager.getAssetURL(t);return t.subtype===un.IMAGE?a.a.createElement("img",{src:e,alt:t.title}):t.subtype===un.AUDIO?a.a.createElement("audio",{src:e,controls:!0}):t.subtype===un.VIDEO?a.a.createElement("video",{src:e,controls:!0,playsInline:!0,crossOrigin:"anonymous"}):t.subtype===un.BEHAVIOR?a.a.createElement("div",null,e):t.subtype===un.GLTF?a.a.createElement(hn,{asset:t,provider:this.props.provider}):t.subtype===un.GEOLOCATION?a.a.createElement(On,{asset:t,provider:this.props.provider}):a.a.createElement("div",null,"unknown type")}}]),e}(r.Component);function wn(t,e,n,r,a){F.supportsAssetUpload()||(t=r);var o=a.accessObject(a.getDataGraph().createObject({type:tn.ASSET,subtype:un.IMAGE,assetId:t,format:n,src:e,width:100,height:100,title:r,parent:0}));a.accessObject(a.getAssetsObject()).insertChildLast(o),a.requestImageCache(a.assetsManager.getAssetURL(o)).then(function(t){o.set("width",t.width),o.set("height",t.height)})}function gn(t,e){G.add("uploading "+t.name),F.uploadFile(t).then(function(n){return G.add("uploaded"),!1===n.success?console.log("there was an error uploading! :("):wn(null,V()+n.asset.id,n.asset.mimeType,t.name,e)})}function Sn(t,e){G.add("uploading "+t.name),e.uploadFile(t).then(function(n){if(G.add("uploaded"),!1===n.success)return console.log("there was an error uploading! :(");var r=V()+n.asset.id,a=e.getDataGraph(),o=st(a,a.createObject({type:tn.ASSET,subtype:un.GLTF,format:cn.GLB,src:r,title:t.name,parent:0}));e.accessObject(e.getAssetsObject()).insertChildLast(o)})}function Cn(t,e,n,r,a){if(r||(r=e.substring(e.lastIndexOf("/")+1)),!n){var o=r.substring(r.lastIndexOf(".")+1);n="audio/unknown","mp3"===o.toLowerCase()&&(n=cn.MP3),"aac"===o.toLowerCase()&&(n=cn.AAC)}F.supportsAssetUpload()||(t=r);var s=a.getDataGraph(),i=st(s,s.createObject({type:tn.ASSET,subtype:un.AUDIO,assetId:t,format:n,src:e,title:r,parent:0}));a.accessObject(a.getAssetsObject()).insertChildLast(i)}var En=function(t){function e(t){var n;return Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this,t))).cancel=function(){d.b.hide()},n.okay=function(){var t,e,r,a,o;d.b.hide(),"remote"===n.state.view?(console.log("adding the url",n.state.url),t=n.state.url,e=n.props.provider,r=t.substring(t.lastIndexOf("/")+1),a=r.substring(r.lastIndexOf(".")+1),o="image/unknown","png"===a.toLowerCase()&&(o=cn.PNG),"jpg"===a.toLowerCase()&&(o=cn.JPEG),"jpeg"===a.toLowerCase()&&(o=cn.JPEG),wn(null,t,o,r,e)):(console.log("the file input is",n.fileInput),at(n.fileInput.current.files).forEach(function(t){gn(t,n.props.provider)}))},n.switchLocal=function(){return n.setState({view:"local"})},n.switchRemote=function(){return n.setState({view:"remote"})},n.selectedFile=function(t){n.setState({fileInput:t.target.value})},n.typedURL=function(t){n.setState({url:t.target.value})},n.state={view:"local",url:""},n.fileInput=a.a.createRef(),n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"render",value:function(){return a.a.createElement(At,{visible:!0,onScrimClick:this.cancel},a.a.createElement(d.f,{grow:!0},a.a.createElement("h3",null,"add image to assets"),a.a.createElement(d.f,{grow:!0},a.a.createElement(S,null,a.a.createElement(M,{onClick:this.switchLocal,selected:"local"===this.state.view},"local"),a.a.createElement(M,{onClick:this.switchRemote,selected:"remote"===this.state.view},"remote")),this.renderSelectedPanel()),a.a.createElement(d.c,null,a.a.createElement("button",{onClick:this.cancel},"cancel"),a.a.createElement("button",{onClick:this.okay},"okay"))))}},{key:"renderSelectedPanel",value:function(){return"local"===this.state.view?a.a.createElement(d.c,null,a.a.createElement("label",null,"File",a.a.createElement("input",{key:"f1",type:"file",onChange:this.selectedFile,ref:this.fileInput}))):a.a.createElement(d.c,null,a.a.createElement("label",null,"URL",a.a.createElement("input",{key:"f2",value:this.state.url,type:"input",onChange:this.typedURL})))}}]),e}(r.Component),Mn=function(t){function e(t){var n;return Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this,t))).redraw=function(){if(n.canvas){var t=n.canvas.getContext("2d"),e=n.props.provider.getPageSize(n.props.page).as(mt.PIXEL,1,vt);n.canvas.width=e.width,n.canvas.height=e.height,t.fillStyle="white",t.fillRect(0,0,n.canvas.width,n.canvas.height),t.save(),t.scale(n.state.scale,n.state.scale);var r=n.props.provider.getRawGraph(),a=n.props.page;a&&n.drawPage(t,r,a),t.restore()}},n.handleKeypress=function(t){"ArrowRight"===t.key&&n.props.onNext(),"ArrowLeft"===t.key&&n.props.onPrev()},n.state={scale:1},n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"componentDidMount",value:function(){this.canvas.focus(),this.redraw()}},{key:"componentDidUpdate",value:function(t){this.redraw()}},{key:"drawPage",value:function(t,e,n){var r=this;it(e,n.children).forEach(function(n){return r.drawLayer(t,e,st(e,n))})}},{key:"drawLayer",value:function(t,e,n){var r=this;it(e,n.children).forEach(function(n){return r.drawShape(t,e,st(e,n))})}},{key:"drawShape",value:function(t,e,n){var r=this.props.provider.getShapeDef(n.type);r&&r.draw(t,e,n,I.getSelection()===n.id,this.props.provider)}},{key:"render",value:function(){var t=this;return a.a.createElement("canvas",{tabIndex:-1,width:100,height:100,ref:function(e){return t.canvas=e},style:{width:"100vw"},onClick:this.props.onNext,onKeyDown:this.handleKeypress})}}]),e}(r.Component),jn=function(t){function e(t){var n;return Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this,t))).docSwapped=function(){return n.setState({pageIndex:0})},n.onNext=function(){var t=n.getPages();n.state.pageIndex===t.length-1&&(n.state.pageIndex=-1),n.setState({pageIndex:n.state.pageIndex+1})},n.onPrev=function(){var t=n.getPages();0===n.state.pageIndex&&(n.state.pageIndex=t.length),n.setState({pageIndex:n.state.pageIndex-1})},n.state={pageIndex:-1},n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"componentDidMount",value:function(){this.props.provider.on(B.DOCUMENT_SWAPPED,this.docSwapped)}},{key:"getPages",value:function(){var t=this.props.provider;return t.accessObject(t.getSceneRoot()).array("children").map(function(e){return t.accessObject(e)}).filter(function(t){return"page"===t.type})}},{key:"render",value:function(){var t=this.props.provider,e=this.getPages();if(this.state.pageIndex<0)return a.a.createElement("div",null,"no pages loaded");var n=e[this.state.pageIndex];return a.a.createElement(Mn,{page:n,provider:t,onNext:this.onNext,onPrev:this.onPrev})}}]),e}(r.Component);function Dn(t,e,n){var r=t,a=e.createObject();return e.getPropertiesForObject(r).forEach(function(t){if("children"===t){var o=function(t,e,n){for(var r=e.createArray(),a=e.getArrayLength(t),o=0;o<a;o++){var s=e.getElementAt(t,o),i=Dn(s,e,n);e.insertElement(r,o,i)}return r}(e.getPropertyValue(r,t),e,a);e.createProperty(a,t,o)}else{var s=e.getPropertyValue(r,t);"parent"===t&&(s=n),e.createProperty(a,t,s)}}),a}var Rn=function(){function t(e){Object(i.a)(this,t),this.graph=e}return Object(c.a)(t,[{key:"object",value:function(t){var e=this;if(t&&t.id&&t.exists&&t.exists())return console.log("someone created a graphaccessor on an existing object"),t;if(this.graph.hasObject(t)){var n={};return this.graph.getPropertiesForObject(t).forEach(function(r){n[r]=e.graph.getPropertyValue(t,r)}),n.id=t,n.exists=function(){return!0},n.set=function(r,a){return e.graph.setProperty(t,r,a),n},n.props=function(){var n={};return e.graph.getPropertiesForObject(t).forEach(function(r){n[r]=e.graph.getPropertyValue(t,r)}),n},n.array=function(t){for(var r=n[t],a=e.graph.getArrayLength(r),o=[],s=0;s<a;s++)o.push(e.graph.getElementAt(r,s));return o},n.getChildren=function(){return n.children?n.array("children").map(function(t){return e.object(t)}):[]},n.insertChildLast=function(t){e.graph.setProperty(t.id,"parent",n.id);var r=e.graph.getPropertyValue(n.id,"children"),a=e.graph.getArrayLength(r),o=e.graph.getElementAt(r,a-1);e.graph.insertAfter(r,o,t.id)},n.insertFirstChild=function(t){e.graph.setProperty(t.id,"parent",n.id);var r=e.graph.getPropertyValue(n.id,"children");e.graph.insertAfter(r,null,t.id)},n.child=function(t){return e.object(n.array("children")[t])},n.removeFromParent=function(){var t=e.object(n.parent),r=t.array("children").findIndex(function(t){return t===n.id});r>=0?e.graph.removeElement(t.children,r):console.error("could not find index for child",n,"in children",t.children)},n.getParent=function(){return e.object(n.parent)},n.clone=function(){var t=Dn(n.id,e.graph,n.parent);return e.object(t)},n.find=function(t,e){return e||(e=[]),t(n)&&e.push(n),n.children&&n.getChildren().forEach(function(n){n.find(t,e)}),e},n}return{exists:function(){return!1}}}}]),t}(),Pn=function(t){var e="---";t.value&&t.provider&&(e=t.provider.getDataGraph().getPropertyValue(t.value,"title"));return a.a.createElement("b",null,e)},In=[{name:"1024 x 768 pixels",value:"1024x768px"},{name:"VGA (640x480)",value:"640x480px"},{name:"A4 paper",value:"210x297mm"},{name:"16:9",value:"300x169mm"},{name:"4:3",value:"225x169mm"}],Tn=function(t){var e="---";if(t.value&&t.provider){var n=In.find(function(e){return e.value===t.value});e=n?n.name:t.value}return a.a.createElement("b",null,e)},xn=function(t){function e(t){var n;return Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this,t))).getApp=function(){return"view"===n.mode?a.a.createElement(jn,{provider:Object(m.a)(Object(m.a)(n))}):a.a.createElement(Nn,{provider:Object(m.a)(Object(m.a)(n))})},n.getTitle=function(){return"MetaDoc"},n.getRendererForItem=function(t){if(!n.getDataGraph().getObjectById(t))return a.a.createElement("div",null,"???");var e=n.getDataGraph().getPropertyValue(t,"type"),r=n.getDataGraph().getPropertyValue(t,"title");return Yt[e]?a.a.createElement("div",null,a.a.createElement("i",{className:"fa fa-".concat(Yt[e])})," ",r):a.a.createElement("div",null,r)},n.addShape=function(t){var e=n.getDataGraph(),r=n.getSelectedLayer();if(!r)return console.error("no layer!");ct(e,r,t.make(e,r))},n.addRect=function(){return n.addShape(n.getShapeDef("rect"))},n.addCircle=function(){return n.addShape(n.getShapeDef("circle"))},n.addText=function(){return n.addShape(n.getShapeDef("text"))},n.addImage=function(){return n.addShape(n.getShapeDef("image"))},n.addImageAssetFromFile=function(t){n.uploadFile(t).then(function(e){console.log("uploaded file with answer",e);var r=V()+e.id,a=n.getDataGraph(),o=st(a,a.createObject({type:"asset",subtype:"image",format:t.type,src:r,width:100,height:100,title:t.name,parent:0})),s=st(a,n.getAssetsObject());ut(a,s,o),n.requestImageCache(r).then(function(t){a.setProperty(o.id,"width",t.width),a.setProperty(o.id,"height",t.height)})})},n.addImageAssetFromURL=function(t){var e=t.substring(t.lastIndexOf("/")+1),r=e.substring(e.lastIndexOf(".")+1),a="image/unknown";"png"===r.toLowerCase()&&(a="image/png"),"jpg"===r.toLowerCase()&&(a="image/jpeg"),"jpeg"===r.toLowerCase()&&(a="image/jpeg");var o=n.getDataGraph(),s=st(o,o.createObject({type:"asset",subtype:"image",format:a,src:t,width:100,height:100,title:e,parent:0})),i=st(o,n.getAssetsObject());ut(o,i,s),n.requestImageCache(t).then(function(t){o.setProperty(s.id,"width",t.width),o.setProperty(s.id,"height",t.height)})},n.deleteSelection=function(){var t=n.getDataGraph(),e=n.getSelectedShape();e&&(pt(t,e),I.clearSelection())},n.deleteSelectedAsset=function(){var t=n.getDataGraph();pt(t,st(t,I.getSelection())),I.clearSelection()},n.cutSelection=function(){var t=n.getDataGraph(),e=I.getSelection();if(e){var r=st(t,e);I.setClipboard(r.id),pt(t,r),I.clearSelection()}},n.copySelection=function(){var t=n.getDataGraph(),e=I.getSelection();if(e){var r=st(t,e);I.setClipboard(r.id)}},n.pasteSelection=function(t){if(t.target&&"input"===t.target.getAttribute("type"))return console.log("pasting into an input field. don't intercept");var e=n.getDataGraph(),r=st(e,I.getClipboard()),a=null;if(re(r.type)&&(a=n.getSelectedLayer()),"layer"===r.type&&(a=n.getSelectedPage()),"page"===r.type&&(a=st(e,n.getSceneRoot())),!a)return console.error("no parent to ad too! bad obj type?",r.type);var o=function(t,e){var n=e.id,r=t.createObject();return t.getPropertiesForObject(n).forEach(function(e){t.createProperty(r,e,t.getPropertyValue(n,e))}),st(t,r)}(e,r);e.setProperty(o.id,"parent",a.id),ct(e,a,o)},n.exportSVG=function(){var t=n.getSelectedPage(),e=n.renderSVGWrapper(n.renderSVGChildren(t)),r=document.createElement("a");r.href="data:image/svg+xml,"+encodeURIComponent(e),r.download="test.svg",document.body.appendChild(r),r.click()},n.exportPNG=function(){var t=n.getSelectedPage(),e=document.createElement("canvas"),r=e.getContext("2d"),a=n.getRawGraph(),o=n.getPageSize(t).as(mt.PIXEL,1,vt);e.width=o.width,e.height=o.height,r.fillStyle="white",r.fillRect(0,0,e.width,e.height),t&&n.accessObject(t.id).getChildren().forEach(function(t){t.getChildren().forEach(function(t){var e=n.getShapeDef(t.type);e&&e.draw(r,a,t,!1,Object(m.a)(Object(m.a)(n)))})});var s=document.createElement("a");s.href=e.toDataURL("image/png"),s.download="test.png",document.body.appendChild(s),s.click()},n.newView=function(){return window.open("./?mode=metadoc&doctype=".concat(n.getDocType(),"&doc=").concat(n.getDocId()))},n.openPresentationView=function(){return window.open("./?mode=view&doctype=".concat(n.getDocType(),"&doc=").concat(n.getDocId()))},n.getAssetsObject=function(){return n.getDataGraph().getObjectByProperty("type","assets")},n.showAddImageAssetDialog=function(){return d.b.show(a.a.createElement(En,{provider:Object(m.a)(Object(m.a)(n))}))},n.accessObject=function(t){return new Rn(n.getDataGraph()).object(t)},n.imagecache={},n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"getDocType",value:function(){return"metadoc"}},{key:"makeEmptyRoot",value:function(t){var e=st(t,t.createObject({type:"root",title:"root",pageSize:"640 x 480 px",children:t.createArray(),parent:0})),n=st(t,t.createObject({type:"page",title:"page 1",children:t.createArray(),parent:0})),r=st(t,t.createObject({type:"layer",title:"layer 1",children:t.createArray(),parent:0})),a=Xt.rect.make(t,r),o=st(t,t.createObject({type:"assets",title:"Assets",children:t.createArray(),parent:0}));ct(t,r,a),ct(t,n,r),ct(t,e,n),ut(t,e,o)}},{key:"setPropertyValue",value:function(t,n,r){if(Object(f.a)(Object(p.a)(e.prototype),"setPropertyValue",this).call(this,t,n,r),n.key===$t.asset.key){var a=st(this.getDataGraph(),r);Object(f.a)(Object(p.a)(e.prototype),"setPropertyValue",this).call(this,t,{key:"width"},a.width),Object(f.a)(Object(p.a)(e.prototype),"setPropertyValue",this).call(this,t,{key:"height"},a.height)}}},{key:"getProperties",value:function(t){var e=this;var n=[];if(!t)return n;var r=this.syncdoc.getPropertiesForObject(t);return r&&r.forEach(function(r){if("type"!==r&&"children"!==r&&"parent"!==r){var a=e.syncdoc.getPropertyValue(t,r);if($t[r])return n.push(function(t,e){var n={};return Object.keys(t).forEach(function(e){return n[e]=t[e]}),n.value=e,n}($t[r],a));console.log("unknown property",r)}}),n}},{key:"createCustomEditor",value:function(t,e,n,r,o){if(e.key===$t.fillColor.key)return a.a.createElement(d.c,null,["#ffffff","#ff0000","#ffff00","#00ff00","#00ffff","#0000ff","#ff00ff","#000000"].map(function(t){return a.a.createElement("button",{key:t,onClick:function(){return o(t)},style:{color:t,padding:"1px",margin:0,borderWidth:0},className:"fa fa-square"})}));if(e.key===$t.pageSize.key){var s=st(this.getDataGraph(),t);return a.a.createElement(X,{def:e,provider:this,obj:t,value:s.pageSize,onChange:o})}return a.a.createElement("i",null,"no custom editor for ",e.key)}},{key:"getValuesForEnum",value:function(t,e){if(t===$t.asset.key){var n=this.getDataGraph().getPropertyValue(this.getAssetsObject(),"children");return it(this.getDataGraph(),n)}return t===$t.fontFamily.key?Object.keys(te).map(function(t){return te[t]}):t===$t.verticalAlign.key?Object.keys(Lt).map(function(t){return Lt[t]}):t===$t.horizontalAlign.key?Object.keys(_t).map(function(t){return _t[t]}):t===$t.pageSize.key?In.map(function(t){return t.value}):void 0}},{key:"getRendererForEnum",value:function(t,e){return t===$t.asset.key?Pn:t===$t.pageSize.key?Tn:void 0}},{key:"getPageSize",value:function(t){var e=this.getSceneRoot(),n=st(this.getDataGraph(),e);return console.log("parsing",n),function(t){t.value&&(t=t.value);var e=t.trim().match(/(\d+)\s*x\s*(\d+)\s*(px|mm)/);return"px"===e[3]?new bt(parseInt(e[1]),parseInt(e[2]),mt.PIXEL):"mm"===e[3]?new bt(parseInt(e[1]),parseInt(e[2]),mt.MILLIMETER):new bt(100,100,mt.PIXEL)}(n.pageSize)}},{key:"getShapeDef",value:function(t){return Xt[t]}},{key:"getSelectedRoot",value:function(){return st(this.getDataGraph(),this.getSceneRoot())}},{key:"getSelectedPage",value:function(){var t=I.getSelection();if(!t)return null;for(;;){var e=this.getDataGraph().getPropertyValue(t,"type");if("root"===e)return null;if("page"===e)return st(this.getDataGraph(),t);if(!(t=this.getDataGraph().getPropertyValue(t,"parent")))break}}},{key:"getSelectedLayer",value:function(){var t=I.getSelection();if(!t)return null;for(;;){var e=this.getDataGraph().getPropertyValue(t,"type");if("root"===e)return null;if("layer"===e)return st(this.getDataGraph(),t);if(!(t=this.getDataGraph().getPropertyValue(t,"parent")))break}console.log(st(this.getDataGraph(),t))}},{key:"getSelectedShape",value:function(){var t=I.getSelection();if(!t)return null;var e=this.getDataGraph().getPropertyValue(t,"type");return Xt[e]?st(this.getDataGraph(),t):null}},{key:"calculateContextMenu",value:function(t){var e=st(this.getDataGraph(),t);return"assets"===e.type?[{title:"Add Image",icon:"image",fun:this.showAddImageAssetDialog}]:"asset"===e.type?[{title:"delete",icon:"close",fun:this.deleteSelectedAsset}]:[{title:"delete",icon:"close",fun:this.deleteSelection},{title:"rect",icon:Yt.rect,fun:this.addRect},{title:"circle",icon:Yt.circle,fun:this.addCircle},{title:"text",icon:Yt.text,fun:this.addText},{title:"image",icon:Yt.image,fun:this.addImage},{title:"cut",icon:Yt.cut,fun:this.cutSelection},{title:"copy",icon:Yt.copy,fun:this.copySelection},{title:"paste",icon:Yt.paste,fun:this.pasteSelection}]}},{key:"renderSVGWrapper",value:function(t){return'<svg id="svg-canvas" viewBox="0 0 1000 1000" \n                xmlns="http://www.w3.org/2000/svg" \n                xmlnsXlink="http://www.w3.org/1999/xlink">\n                '.concat(t,"</svg>")}},{key:"renderSVGChildren",value:function(t){var e=this;return"page"===t.type?it(this.getDataGraph(),t.children).map(function(t){return"<g>".concat(e.renderSVGChildren(st(e.getDataGraph(),t)),"</g>")}).join(""):"layer"===t.type?it(this.getDataGraph(),t.children).map(function(t){return e.renderSVGChildren(st(e.getDataGraph(),t))}).join(""):Xt[t.type]?Xt[t.type].toSVGString(t,this):""}},{key:"canAddChild",value:function(t,e){var n=st(this.getDataGraph(),t),r=st(this.getDataGraph(),e);return!("layer"!==n.type||!re(r.type))||("page"===n.type&&"layer"===r.type||"root"===n.type&&"page"===r.type)}},{key:"canBeSibling",value:function(t,e){var n=st(this.getDataGraph(),t),r=st(this.getDataGraph(),e);return"layer"===n.type&&"layer"===r.type||("page"===n.type&&"page"===r.type||!(!re(n.type)||!re(r.type)))}},{key:"canAddExternalChild",value:function(t,e){return"assets"===st(this.getDataGraph(),t).type}},{key:"acceptDrop",value:function(t,e){var n=this;"assets"===st(this.getDataGraph(),e).type&&at(t.dataTransfer.files).forEach(function(t){return n.addImageAssetFromFile(t)})}},{key:"isImageCached",value:function(t){return!!this.imagecache[t]&&this.imagecache[t].complete}},{key:"requestImageCache",value:function(t){var e=this,n=new Image;return this.imagecache[t]=n,new Promise(function(r,a){n.src=t,n.onload=function(){e.fire(B.STRUCTURE_CHANGED,{provider:e}),r(n)}})}},{key:"getCachedImage",value:function(t){return this.imagecache[t]}}]),e}(Kt),Nn=function(t){function e(t){var n;return Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this,t))).canvasSelected=function(t){return I.setSelection(t)},n.showAddPopup=function(t){var e=[{title:"page",icon:Yt.page,fun:function(){return n.addPage()}},{title:"layer",icon:Yt.layer,fun:function(){return n.addLayer()}},{title:"rect",icon:Yt.rect,fun:function(){return n.props.provider.addRect()}},{title:"circle",icon:Yt.circle,fun:function(){return n.props.provider.addCircle()}},{title:"text",icon:Yt.text,fun:function(){return n.props.provider.addText()}},{title:"image",icon:Yt.image,fun:function(){return n.props.provider.addImage()}}];d.e.show(a.a.createElement(j,{actions:e}),t.target)},n.addPage=function(){var t=n.props.provider.getDataGraph(),e=n.props.provider.getSelectedRoot(),r=st(t,ot(t,{type:"page",title:"new page",parent:e.id,children:t.createArray()}));ct(t,e,r)},n.addLayer=function(){var t=n.props.provider.getDataGraph(),e=n.props.provider.getSelectedPage(),r=st(t,ot(t,{type:"layer",title:"new layer",parent:e.id,children:t.createArray()}));ct(t,e,r)},n.zoomIn=function(){return n.setState({zoom:n.state.zoom+1})},n.zoomOut=function(){return n.setState({zoom:n.state.zoom-1})},n.state={connected:!1,zoom:0,mode:"canvas"},n.im=new Zt,n.im.addKeyBinding({id:"save",key:Zt.KEYS.S,modifiers:[Zt.MODIFIERS.COMMAND]}),n.im.addKeyBinding({id:"undo",key:Zt.KEYS.Z,modifiers:[Zt.MODIFIERS.COMMAND]}),n.im.addKeyBinding({id:"redo",key:Zt.KEYS.Z,modifiers:[Zt.MODIFIERS.COMMAND,Zt.MODIFIERS.SHIFT]}),n.im.addListener("save",n.props.provider.save),n.im.addListener("undo",n.props.provider.performUndo),n.im.addListener("redo",n.props.provider.performRedo),n.im.addKeyBinding({id:"cut",key:Zt.KEYS.X,modifiers:[Zt.MODIFIERS.COMMAND]}),n.im.addKeyBinding({id:"copy",key:Zt.KEYS.C,modifiers:[Zt.MODIFIERS.COMMAND]}),n.im.addKeyBinding({id:"paste",key:Zt.KEYS.V,modifiers:[Zt.MODIFIERS.COMMAND]}),n.im.addListener("cut",n.props.provider.cutSelection),n.im.addListener("copy",n.props.provider.copySelection),n.im.addListener("paste",n.props.provider.pasteSelection),n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"componentDidMount",value:function(){var t=this;this.im.attachKeyEvents(document),this.props.provider.on("CONNECTED",function(){return t.setState({connected:t.props.provider.isConnected()})}),I.on(R,function(){var e=I.getSelection();if(e&&st(t.props.provider.getDataGraph(),e).type===$t.asset.key)return void t.setState({mode:"asset"});t.setState({mode:"canvas"})})}},{key:"render",value:function(){var t=this.props.provider;return a.a.createElement(D,null,a.a.createElement(S,{left:!0,top:!0},a.a.createElement("label",null,t.getTitle())),a.a.createElement(C,{scroll:!0,left:!0,middle:!0},a.a.createElement(ft,{root:t.getSceneRoot(),provider:t})),a.a.createElement(S,{left:!0,bottom:!0},a.a.createElement("button",{className:"fa fa-plus",onClick:this.showAddPopup}),a.a.createElement("button",{className:"fa fa-close",onClick:t.deleteSelection}),a.a.createElement("button",{className:"fa fa-file-image-o",onClick:t.showAddImageAssetDialog})),a.a.createElement(S,{center:!0,top:!0},a.a.createElement("button",{className:"fa fa-save",onClick:t.save}),a.a.createElement("button",{className:"fa fa-download",onClick:t.exportSVG}," SVG"),a.a.createElement("button",{className:"fa fa-download",onClick:t.exportPNG}," PNG"),a.a.createElement("button",{className:"fa fa-undo",onClick:t.performUndo}),a.a.createElement("button",{className:"fa fa-repeat",onClick:t.performRedo}),a.a.createElement("button",{className:"fa fa-search-plus",onClick:this.zoomIn}),a.a.createElement("button",{className:"fa fa-search-minus",onClick:this.zoomOut}),a.a.createElement(E,null),a.a.createElement("button",{className:"fa fa-cut",onClick:t.cutSelection}),a.a.createElement("button",{className:"fa fa-copy",onClick:t.copySelection}),a.a.createElement("button",{className:"fa fa-paste",onClick:t.pasteSelection}),a.a.createElement(E,null),a.a.createElement("button",{className:"fa fa-play",onClick:t.openPresentationView}),a.a.createElement("button",{className:"fa fa-plus",onClick:t.newView}," view"),a.a.createElement("button",{className:"fa fa-superpowers",onClick:t.toggleConnected},this.state.connected?"disconnect":"connect")),a.a.createElement(C,{center:!0,middle:!0,scroll:!0},this.renderCenterPane(this.state.mode)),a.a.createElement(C,{scroll:!0,right:!0},a.a.createElement(et,{provider:t})),a.a.createElement(S,{right:!0,top:!0}),a.a.createElement(S,{right:!0,bottom:!0}))}},{key:"renderCenterPane",value:function(t){if("canvas"===t)return a.a.createElement(ht,{prov:this.props.provider,onSelect:this.canvasSelected,scale:Math.pow(2,this.state.zoom)});var e=I.getSelection();return a.a.createElement(kn,{provider:this.props.provider,asset:e})}}]),e}(r.Component),Gn=n(1),An=function(t,e){Gn.Object3D.call(this),e=void 0!==e?e:document,this.visible=!1;var n=new Fn;this.add(n);var r=new Bn;this.add(r);var a=this;A("camera",t),A("object",void 0),A("enabled",!0),A("axis",null),A("mode","translate"),A("translationSnap",null),A("rotationSnap",null),A("space","world"),A("size",1),A("dragging",!1),A("showX",!0),A("showY",!0),A("showZ",!0);var o={type:"change"},s={type:"mouseDown"},i={type:"mouseUp",mode:a.mode},c={type:"objectChange"},u=new Gn.Raycaster,p=new Gn.Vector3,l=new Gn.Vector3,d=new Gn.Quaternion,f={X:new Gn.Vector3(1,0,0),Y:new Gn.Vector3(0,1,0),Z:new Gn.Vector3(0,0,1)},m=new Gn.Quaternion,v=new Gn.Vector3,b=new Gn.Vector3,h=new Gn.Vector3,y=new Gn.Vector3,O=0,k=new Gn.Vector3,w=new Gn.Quaternion,g=new Gn.Vector3,S=new Gn.Vector3,C=new Gn.Quaternion,E=new Gn.Vector3,M=new Gn.Vector3,j=new Gn.Quaternion,D=new Gn.Vector3,R=new Gn.Vector3,P=new Gn.Quaternion,I=new Gn.Vector3,T=new Gn.Vector3,x=new Gn.Vector3,N=new Gn.Quaternion,G=new Gn.Vector3;function A(t,e){var s=e;Object.defineProperty(a,t,{get:function(){return void 0!==s?s:e},set:function(e){s!==e&&(s=e,r[t]=e,n[t]=e,a.dispatchEvent({type:t+"-changed",value:e}),a.dispatchEvent(o))}}),a[t]=e,r[t]=e,n[t]=e}function F(t){var n=t.changedTouches?t.changedTouches[0]:t,r=e.getBoundingClientRect();return{x:(n.clientX-r.left)/r.width*2-1,y:-(n.clientY-r.top)/r.height*2+1,button:t.button}}function B(t){t.preventDefault()}function U(t){a.enabled&&a.pointerHover(F(t))}function H(t){a.enabled&&(t.preventDefault(),document.addEventListener("mousemove",V,!1),a.pointerHover(F(t)),a.pointerDown(F(t)))}function V(t){a.enabled&&(t.preventDefault(),a.pointerMove(F(t)))}function W(t){a.enabled&&(t.preventDefault(),document.removeEventListener("mousemove",V,!1),a.pointerUp(F(t)))}A("parentQuaternion",C),A("worldPosition",R),A("worldPositionStart",M),A("worldQuaternion",P),A("worldQuaternionStart",j),A("cameraPosition",k),A("cameraQuaternion",w),A("pointStart",b),A("pointEnd",h),A("rotationAxis",y),A("rotationAngle",O),A("eye",T),e.addEventListener("mousedown",H,!1),e.addEventListener("touchstart",H,!1),e.addEventListener("mousemove",U,!1),e.addEventListener("touchmove",U,!1),e.addEventListener("touchmove",V,!1),document.addEventListener("mouseup",W,!1),e.addEventListener("touchend",W,!1),e.addEventListener("touchcancel",W,!1),e.addEventListener("touchleave",W,!1),e.addEventListener("contextmenu",B,!1),this.dispose=function(){e.removeEventListener("mousedown",H),e.removeEventListener("touchstart",H),e.removeEventListener("mousemove",U),e.removeEventListener("touchmove",U),e.removeEventListener("touchmove",V),document.removeEventListener("mouseup",W),e.removeEventListener("touchend",W),e.removeEventListener("touchcancel",W),e.removeEventListener("touchleave",W),e.removeEventListener("contextmenu",B)},this.attach=function(t){this.object=t,this.visible=!0},this.detach=function(){this.object=void 0,this.visible=!1,this.axis=null},this.updateMatrixWorld=function(){void 0!==this.object&&(this.object.updateMatrixWorld(),this.object.parent.matrixWorld.decompose(S,C,E),this.object.matrixWorld.decompose(R,P,I)),this.camera.updateMatrixWorld(),this.camera.matrixWorld.decompose(k,w,g),this.camera instanceof Gn.PerspectiveCamera?T.copy(k).sub(R).normalize():this.camera instanceof Gn.OrthographicCamera&&T.copy(k).normalize(),Gn.Object3D.prototype.updateMatrixWorld.call(this)},this.pointerHover=function(t){if(void 0!==this.object&&!0!==this.dragging&&(void 0===t.button||0===t.button)){u.setFromCamera(t,this.camera);var e=u.intersectObjects(n.picker[this.mode].children,!0)[0]||!1;this.axis=e?e.object.name:null}},this.pointerDown=function(t){if(void 0!==this.object&&!0!==this.dragging&&(void 0===t.button||0===t.button)&&(0===t.button||void 0===t.button)&&null!==this.axis){u.setFromCamera(t,this.camera);var e=u.intersectObjects([r],!0)[0]||!1;if(e){var n=this.space;if("scale"===this.mode?n="local":"E"!==this.axis&&"XYZE"!==this.axis&&"XYZ"!==this.axis||(n="world"),"local"===n&&"rotate"===this.mode){var a=this.rotationSnap;"X"===this.axis&&a&&(this.object.rotation.x=Math.round(this.object.rotation.x/a)*a),"Y"===this.axis&&a&&(this.object.rotation.y=Math.round(this.object.rotation.y/a)*a),"Z"===this.axis&&a&&(this.object.rotation.z=Math.round(this.object.rotation.z/a)*a)}this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),x.copy(this.object.position),N.copy(this.object.quaternion),G.copy(this.object.scale),this.object.matrixWorld.decompose(M,j,D),b.copy(e.point).sub(M),"local"===n&&b.applyQuaternion(j.clone().inverse())}this.dragging=!0,s.mode=this.mode,this.dispatchEvent(s)}},this.pointerMove=function(t){var e=this.axis,n=this.mode,a=this.object,s=this.space;if("scale"===n?s="local":"E"!==e&&"XYZE"!==e&&"XYZ"!==e||(s="world"),void 0!==a&&null!==e&&!1!==this.dragging&&(void 0===t.button||0===t.button)){u.setFromCamera(t,this.camera);var i=u.intersectObjects([r],!0)[0]||!1;if(!1!==i){if(h.copy(i.point).sub(M),"local"===s&&h.applyQuaternion(j.clone().inverse()),"translate"===n)-1===e.search("X")&&(h.x=b.x),-1===e.search("Y")&&(h.y=b.y),-1===e.search("Z")&&(h.z=b.z),"local"===s?a.position.copy(h).sub(b).applyQuaternion(N):a.position.copy(h).sub(b),a.position.add(x),this.translationSnap&&("local"===s&&(a.position.applyQuaternion(d.copy(N).inverse()),-1!==e.search("X")&&(a.position.x=Math.round(a.position.x/this.translationSnap)*this.translationSnap),-1!==e.search("Y")&&(a.position.y=Math.round(a.position.y/this.translationSnap)*this.translationSnap),-1!==e.search("Z")&&(a.position.z=Math.round(a.position.z/this.translationSnap)*this.translationSnap),a.position.applyQuaternion(N)),"world"===s&&(a.parent&&a.position.add(p.setFromMatrixPosition(a.parent.matrixWorld)),-1!==e.search("X")&&(a.position.x=Math.round(a.position.x/this.translationSnap)*this.translationSnap),-1!==e.search("Y")&&(a.position.y=Math.round(a.position.y/this.translationSnap)*this.translationSnap),-1!==e.search("Z")&&(a.position.z=Math.round(a.position.z/this.translationSnap)*this.translationSnap),a.parent&&a.position.sub(p.setFromMatrixPosition(a.parent.matrixWorld))));else if("scale"===n){if(-1!==e.search("XYZ")){var k=h.length()/b.length();h.dot(b)<0&&(k*=-1),p.set(k,k,k)}else p.copy(h).divide(b),-1===e.search("X")&&(p.x=1),-1===e.search("Y")&&(p.y=1),-1===e.search("Z")&&(p.z=1);a.scale.copy(G).multiply(p)}else if("rotate"===n){var w=20/R.distanceTo(p.setFromMatrixPosition(this.camera.matrixWorld)),g="local"===this.space?P:m,S=f[e];"E"===e?(p.copy(h).cross(b),y.copy(T),O=h.angleTo(b)*(p.dot(T)<0?1:-1)):"XYZE"===e?(p.copy(h).sub(b).cross(T).normalize(),y.copy(p),O=h.sub(b).dot(p.cross(T))*w):"X"!==e&&"Y"!==e&&"Z"!==e||(v.copy(S).applyQuaternion(g),y.copy(S),p=S.clone(),l=h.clone().sub(b),"local"===s&&(p.applyQuaternion(g),l.applyQuaternion(j)),O=l.dot(p.cross(T).normalize())*w),this.rotationSnap&&(O=Math.round(O/this.rotationSnap)*this.rotationSnap),this.rotationAngle=O,"local"===s?(a.quaternion.copy(N),a.quaternion.multiply(d.setFromAxisAngle(y,O))):(a.quaternion.copy(d.setFromAxisAngle(y,O)),a.quaternion.multiply(N))}this.dispatchEvent(o),this.dispatchEvent(c)}}},this.pointerUp=function(t){void 0!==t.button&&0!==t.button||(this.dragging&&null!==this.axis&&(i.mode=this.mode,this.dispatchEvent(i)),this.dragging=!1,void 0===t.button&&(this.axis=null))},this.getMode=function(){return a.mode},this.setMode=function(t){a.mode=t},this.setTranslationSnap=function(t){a.translationSnap=t},this.setRotationSnap=function(t){a.rotationSnap=t},this.setSize=function(t){a.size=t},this.setSpace=function(t){a.space=t},this.update=function(){console.warn("TransformControls: update function has been depricated.")}};An.prototype=Object.assign(Object.create(Gn.Object3D.prototype),{constructor:An,isTransformControls:!0});var Fn=function(){Gn.Object3D.call(this),this.type="TransformControlsGizmo";var t=new Gn.MeshBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,side:Gn.DoubleSide,fog:!1}),e=new Gn.LineBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,linewidth:1,fog:!1}),n=t.clone();n.opacity=.15;var r=t.clone();r.opacity=.33;var a=t.clone();a.color.set(16711680);var o=t.clone();o.color.set(65280);var s=t.clone();s.color.set(255);var i=t.clone();i.opacity=.25;var c=i.clone();c.color.set(16776960);var u=i.clone();u.color.set(65535);var p=i.clone();p.color.set(16711935),t.clone().color.set(16776960);var l=e.clone();l.color.set(16711680);var d=e.clone();d.color.set(65280);var f=e.clone();f.color.set(255);var m=e.clone();m.color.set(65535);var v=e.clone();v.color.set(16711935);var b=e.clone();b.color.set(16776960);var h=e.clone();h.color.set(7895160);var y=b.clone();y.opacity=.25;var O=new Gn.CylinderBufferGeometry(0,.05,.2,12,1,!1),k=new Gn.BoxBufferGeometry(.125,.125,.125),w=new Gn.BufferGeometry;w.addAttribute("position",new Gn.Float32BufferAttribute([0,0,0,1,0,0],3));var g,S=function(t,e){for(var n=new Gn.BufferGeometry,r=[],a=0;a<=64*e;++a)r.push(0,Math.cos(a/32*Math.PI)*t,Math.sin(a/32*Math.PI)*t);return n.addAttribute("position",new Gn.Float32BufferAttribute(r,3)),n},C={X:[[new Gn.Mesh(O,a),[1,0,0],[0,0,-Math.PI/2],null,"fwd"],[new Gn.Mesh(O,a),[1,0,0],[0,0,Math.PI/2],null,"bwd"],[new Gn.Line(w,l)]],Y:[[new Gn.Mesh(O,o),[0,1,0],null,null,"fwd"],[new Gn.Mesh(O,o),[0,1,0],[Math.PI,0,0],null,"bwd"],[new Gn.Line(w,d),null,[0,0,Math.PI/2]]],Z:[[new Gn.Mesh(O,s),[0,0,1],[Math.PI/2,0,0],null,"fwd"],[new Gn.Mesh(O,s),[0,0,1],[-Math.PI/2,0,0],null,"bwd"],[new Gn.Line(w,f),null,[0,-Math.PI/2,0]]],XYZ:[[new Gn.Mesh(new Gn.OctahedronBufferGeometry(.1,0),i),[0,0,0],[0,0,0]]],XY:[[new Gn.Mesh(new Gn.PlaneBufferGeometry(.295,.295),c),[.15,.15,0]],[new Gn.Line(w,b),[.18,.3,0],null,[.125,1,1]],[new Gn.Line(w,b),[.3,.18,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new Gn.Mesh(new Gn.PlaneBufferGeometry(.295,.295),u),[0,.15,.15],[0,Math.PI/2,0]],[new Gn.Line(w,m),[0,.18,.3],[0,0,Math.PI/2],[.125,1,1]],[new Gn.Line(w,m),[0,.3,.18],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new Gn.Mesh(new Gn.PlaneBufferGeometry(.295,.295),p),[.15,0,.15],[-Math.PI/2,0,0]],[new Gn.Line(w,v),[.18,0,.3],null,[.125,1,1]],[new Gn.Line(w,v),[.3,0,.18],[0,-Math.PI/2,0],[.125,1,1]]]},E={X:[[new Gn.Mesh(new Gn.CylinderBufferGeometry(.2,0,1,4,1,!1),n),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new Gn.Mesh(new Gn.CylinderBufferGeometry(.2,0,1,4,1,!1),n),[0,.6,0]]],Z:[[new Gn.Mesh(new Gn.CylinderBufferGeometry(.2,0,1,4,1,!1),n),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new Gn.Mesh(new Gn.OctahedronBufferGeometry(.2,0),n)]],XY:[[new Gn.Mesh(new Gn.PlaneBufferGeometry(.4,.4),n),[.2,.2,0]]],YZ:[[new Gn.Mesh(new Gn.PlaneBufferGeometry(.4,.4),n),[0,.2,.2],[0,Math.PI/2,0]]],XZ:[[new Gn.Mesh(new Gn.PlaneBufferGeometry(.4,.4),n),[.2,0,.2],[-Math.PI/2,0,0]]]},M={START:[[new Gn.Mesh(new Gn.OctahedronBufferGeometry(.01,2),r),null,null,null,"helper"]],END:[[new Gn.Mesh(new Gn.OctahedronBufferGeometry(.01,2),r),null,null,null,"helper"]],DELTA:[[new Gn.Line((g=new Gn.BufferGeometry,g.addAttribute("position",new Gn.Float32BufferAttribute([0,0,0,1,1,1],3)),g),r),null,null,null,"helper"]],X:[[new Gn.Line(w,r.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new Gn.Line(w,r.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new Gn.Line(w,r.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},j={X:[[new Gn.Line(S(1,.5),l)],[new Gn.Mesh(new Gn.OctahedronBufferGeometry(.04,0),a),[0,0,.99],null,[1,3,1]]],Y:[[new Gn.Line(S(1,.5),d),null,[0,0,-Math.PI/2]],[new Gn.Mesh(new Gn.OctahedronBufferGeometry(.04,0),o),[0,0,.99],null,[3,1,1]]],Z:[[new Gn.Line(S(1,.5),f),null,[0,Math.PI/2,0]],[new Gn.Mesh(new Gn.OctahedronBufferGeometry(.04,0),s),[.99,0,0],null,[1,3,1]]],E:[[new Gn.Line(S(1.25,1),y),null,[0,Math.PI/2,0]],[new Gn.Mesh(new Gn.CylinderBufferGeometry(.03,0,.15,4,1,!1),y),[1.17,0,0],[0,0,-Math.PI/2],[1,1,.001]],[new Gn.Mesh(new Gn.CylinderBufferGeometry(.03,0,.15,4,1,!1),y),[-1.17,0,0],[0,0,Math.PI/2],[1,1,.001]],[new Gn.Mesh(new Gn.CylinderBufferGeometry(.03,0,.15,4,1,!1),y),[0,-1.17,0],[Math.PI,0,0],[1,1,.001]],[new Gn.Mesh(new Gn.CylinderBufferGeometry(.03,0,.15,4,1,!1),y),[0,1.17,0],[0,0,0],[1,1,.001]]],XYZE:[[new Gn.Line(S(1,1),h),null,[0,Math.PI/2,0]]]},D={AXIS:[[new Gn.Line(w,r.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},R={X:[[new Gn.Mesh(new Gn.TorusBufferGeometry(1,.1,4,24),n),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new Gn.Mesh(new Gn.TorusBufferGeometry(1,.1,4,24),n),[0,0,0],[Math.PI/2,0,0]]],Z:[[new Gn.Mesh(new Gn.TorusBufferGeometry(1,.1,4,24),n),[0,0,0],[0,0,-Math.PI/2]]],E:[[new Gn.Mesh(new Gn.TorusBufferGeometry(1.25,.1,2,24),n)]],XYZE:[[new Gn.Mesh(new Gn.SphereBufferGeometry(.7,10,8),n)]]},P={X:[[new Gn.Mesh(k,a),[.8,0,0],[0,0,-Math.PI/2]],[new Gn.Line(w,l),null,null,[.8,1,1]]],Y:[[new Gn.Mesh(k,o),[0,.8,0]],[new Gn.Line(w,d),null,[0,0,Math.PI/2],[.8,1,1]]],Z:[[new Gn.Mesh(k,s),[0,0,.8],[Math.PI/2,0,0]],[new Gn.Line(w,f),null,[0,-Math.PI/2,0],[.8,1,1]]],XY:[[new Gn.Mesh(k,c),[.85,.85,0],null,[2,2,.2]],[new Gn.Line(w,b),[.855,.98,0],null,[.125,1,1]],[new Gn.Line(w,b),[.98,.855,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new Gn.Mesh(k,u),[0,.85,.85],null,[.2,2,2]],[new Gn.Line(w,m),[0,.855,.98],[0,0,Math.PI/2],[.125,1,1]],[new Gn.Line(w,m),[0,.98,.855],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new Gn.Mesh(k,p),[.85,0,.85],null,[2,.2,2]],[new Gn.Line(w,v),[.855,0,.98],null,[.125,1,1]],[new Gn.Line(w,v),[.98,0,.855],[0,-Math.PI/2,0],[.125,1,1]]],XYZX:[[new Gn.Mesh(new Gn.BoxBufferGeometry(.125,.125,.125),i),[1.1,0,0]]],XYZY:[[new Gn.Mesh(new Gn.BoxBufferGeometry(.125,.125,.125),i),[0,1.1,0]]],XYZZ:[[new Gn.Mesh(new Gn.BoxBufferGeometry(.125,.125,.125),i),[0,0,1.1]]]},I={X:[[new Gn.Mesh(new Gn.CylinderBufferGeometry(.2,0,.8,4,1,!1),n),[.5,0,0],[0,0,-Math.PI/2]]],Y:[[new Gn.Mesh(new Gn.CylinderBufferGeometry(.2,0,.8,4,1,!1),n),[0,.5,0]]],Z:[[new Gn.Mesh(new Gn.CylinderBufferGeometry(.2,0,.8,4,1,!1),n),[0,0,.5],[Math.PI/2,0,0]]],XY:[[new Gn.Mesh(k,n),[.85,.85,0],null,[3,3,.2]]],YZ:[[new Gn.Mesh(k,n),[0,.85,.85],null,[.2,3,3]]],XZ:[[new Gn.Mesh(k,n),[.85,0,.85],null,[3,.2,3]]],XYZX:[[new Gn.Mesh(new Gn.BoxBufferGeometry(.2,.2,.2),n),[1.1,0,0]]],XYZY:[[new Gn.Mesh(new Gn.BoxBufferGeometry(.2,.2,.2),n),[0,1.1,0]]],XYZZ:[[new Gn.Mesh(new Gn.BoxBufferGeometry(.2,.2,.2),n),[0,0,1.1]]]},T={X:[[new Gn.Line(w,r.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new Gn.Line(w,r.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new Gn.Line(w,r.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},x=function(t){var e=new Gn.Object3D;for(var n in t)for(var r=t[n].length;r--;){var a=t[n][r][0].clone(),o=t[n][r][1],s=t[n][r][2],i=t[n][r][3],c=t[n][r][4];a.name=n,a.tag=c,o&&a.position.set(o[0],o[1],o[2]),s&&a.rotation.set(s[0],s[1],s[2]),i&&a.scale.set(i[0],i[1],i[2]),a.updateMatrix();var u=a.geometry.clone();u.applyMatrix(a.matrix),a.geometry=u,a.position.set(0,0,0),a.rotation.set(0,0,0),a.scale.set(1,1,1),e.add(a)}return e},N=new Gn.Vector3(0,0,0),G=new Gn.Euler,A=new Gn.Vector3(0,1,0),F=new Gn.Vector3(0,0,0),B=new Gn.Matrix4,U=new Gn.Quaternion,H=new Gn.Quaternion,V=new Gn.Quaternion,W=new Gn.Vector3(1,0,0),K=new Gn.Vector3(0,1,0),Z=new Gn.Vector3(0,0,1);this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=x(C)),this.add(this.gizmo.rotate=x(j)),this.add(this.gizmo.scale=x(P)),this.add(this.picker.translate=x(E)),this.add(this.picker.rotate=x(R)),this.add(this.picker.scale=x(I)),this.add(this.helper.translate=x(M)),this.add(this.helper.rotate=x(D)),this.add(this.helper.scale=x(T)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1,this.updateMatrixWorld=function(){var t=this.space;"scale"===this.mode&&(t="local");var e="local"===t?this.worldQuaternion:V;this.gizmo.translate.visible="translate"===this.mode,this.gizmo.rotate.visible="rotate"===this.mode,this.gizmo.scale.visible="scale"===this.mode,this.helper.translate.visible="translate"===this.mode,this.helper.rotate.visible="rotate"===this.mode,this.helper.scale.visible="scale"===this.mode;var n=[];n=(n=(n=n.concat(this.picker[this.mode].children)).concat(this.gizmo[this.mode].children)).concat(this.helper[this.mode].children);for(var r=0;r<n.length;r++){var a=n[r];a.visible=!0,a.rotation.set(0,0,0),a.position.copy(this.worldPosition);var o=this.worldPosition.distanceTo(this.cameraPosition);if(a.scale.set(1,1,1).multiplyScalar(o*this.size/7),"helper"!==a.tag){if(a.quaternion.copy(e),"translate"===this.mode||"scale"===this.mode){"X"!==a.name&&"XYZX"!==a.name||Math.abs(A.copy(W).applyQuaternion(e).dot(this.eye))>.99&&(a.scale.set(1e-10,1e-10,1e-10),a.visible=!1),"Y"!==a.name&&"XYZY"!==a.name||Math.abs(A.copy(K).applyQuaternion(e).dot(this.eye))>.99&&(a.scale.set(1e-10,1e-10,1e-10),a.visible=!1),"Z"!==a.name&&"XYZZ"!==a.name||Math.abs(A.copy(Z).applyQuaternion(e).dot(this.eye))>.99&&(a.scale.set(1e-10,1e-10,1e-10),a.visible=!1),"XY"===a.name&&Math.abs(A.copy(Z).applyQuaternion(e).dot(this.eye))<.2&&(a.scale.set(1e-10,1e-10,1e-10),a.visible=!1),"YZ"===a.name&&Math.abs(A.copy(W).applyQuaternion(e).dot(this.eye))<.2&&(a.scale.set(1e-10,1e-10,1e-10),a.visible=!1),"XZ"===a.name&&Math.abs(A.copy(K).applyQuaternion(e).dot(this.eye))<.2&&(a.scale.set(1e-10,1e-10,1e-10),a.visible=!1),-1!==a.name.search("X")&&(A.copy(W).applyQuaternion(e).dot(this.eye)<-.4?"fwd"===a.tag?a.visible=!1:a.scale.x*=-1:"bwd"===a.tag&&(a.visible=!1)),-1!==a.name.search("Y")&&(A.copy(K).applyQuaternion(e).dot(this.eye)<-.4?"fwd"===a.tag?a.visible=!1:a.scale.y*=-1:"bwd"===a.tag&&(a.visible=!1)),-1!==a.name.search("Z")&&(A.copy(Z).applyQuaternion(e).dot(this.eye)<-.4?"fwd"===a.tag?a.visible=!1:a.scale.z*=-1:"bwd"===a.tag&&(a.visible=!1))}else"rotate"===this.mode&&(H.copy(e),A.copy(this.eye).applyQuaternion(U.copy(e).inverse()),-1!==a.name.search("E")&&a.quaternion.setFromRotationMatrix(B.lookAt(this.eye,F,K)),"X"===a.name&&(U.setFromAxisAngle(W,Math.atan2(-A.y,A.z)),U.multiplyQuaternions(H,U),a.quaternion.copy(U)),"Y"===a.name&&(U.setFromAxisAngle(K,Math.atan2(A.x,A.z)),U.multiplyQuaternions(H,U),a.quaternion.copy(U)),"Z"===a.name&&(U.setFromAxisAngle(Z,Math.atan2(A.y,A.x)),U.multiplyQuaternions(H,U),a.quaternion.copy(U)));a.visible=a.visible&&(-1===a.name.indexOf("X")||this.showX),a.visible=a.visible&&(-1===a.name.indexOf("Y")||this.showY),a.visible=a.visible&&(-1===a.name.indexOf("Z")||this.showZ),a.visible=a.visible&&(-1===a.name.indexOf("E")||this.showX&&this.showY&&this.showZ),a.material._opacity=a.material._opacity||a.material.opacity,a.material._color=a.material._color||a.material.color.clone(),a.material.color.copy(a.material._color),a.material.opacity=a.material._opacity,this.enabled?this.axis&&(a.name===this.axis?(a.material.opacity=1,a.material.color.lerp(new Gn.Color(1,1,1),.5)):this.axis.split("").some(function(t){return a.name===t})?(a.material.opacity=1,a.material.color.lerp(new Gn.Color(1,1,1),.5)):(a.material.opacity*=.25,a.material.color.lerp(new Gn.Color(1,1,1),.5))):(a.material.opacity*=.5,a.material.color.lerp(new Gn.Color(1,1,1),.5))}else a.visible=!1,"AXIS"===a.name?(a.position.copy(this.worldPositionStart),a.visible=!!this.axis,"X"===this.axis&&(U.setFromEuler(G.set(0,0,0)),a.quaternion.copy(e).multiply(U),Math.abs(A.copy(W).applyQuaternion(e).dot(this.eye))>.9&&(a.visible=!1)),"Y"===this.axis&&(U.setFromEuler(G.set(0,0,Math.PI/2)),a.quaternion.copy(e).multiply(U),Math.abs(A.copy(K).applyQuaternion(e).dot(this.eye))>.9&&(a.visible=!1)),"Z"===this.axis&&(U.setFromEuler(G.set(0,Math.PI/2,0)),a.quaternion.copy(e).multiply(U),Math.abs(A.copy(Z).applyQuaternion(e).dot(this.eye))>.9&&(a.visible=!1)),"XYZE"===this.axis&&(U.setFromEuler(G.set(0,Math.PI/2,0)),A.copy(this.rotationAxis),a.quaternion.setFromRotationMatrix(B.lookAt(F,A,K)),a.quaternion.multiply(U),a.visible=this.dragging),"E"===this.axis&&(a.visible=!1)):"START"===a.name?(a.position.copy(this.worldPositionStart),a.visible=this.dragging):"END"===a.name?(a.position.copy(this.worldPosition),a.visible=this.dragging):"DELTA"===a.name?(a.position.copy(this.worldPositionStart),a.quaternion.copy(this.worldQuaternionStart),N.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),N.applyQuaternion(this.worldQuaternionStart.clone().inverse()),a.scale.copy(N),a.visible=this.dragging):(a.quaternion.copy(e),this.dragging?a.position.copy(this.worldPositionStart):a.position.copy(this.worldPosition),this.axis&&(a.visible=-1!==this.axis.search(a.name)))}Gn.Object3D.prototype.updateMatrixWorld.call(this)}};Fn.prototype=Object.assign(Object.create(Gn.Object3D.prototype),{constructor:Fn,isTransformControlsGizmo:!0});var Bn=function(){Gn.Mesh.call(this,new Gn.PlaneBufferGeometry(1e5,1e5,2,2),new Gn.MeshBasicMaterial({visible:!1,wireframe:!0,side:Gn.DoubleSide,transparent:!0,opacity:.1})),this.type="TransformControlsPlane";var t=new Gn.Vector3(1,0,0),e=new Gn.Vector3(0,1,0),n=new Gn.Vector3(0,0,1),r=new Gn.Vector3,a=new Gn.Vector3,o=new Gn.Vector3,s=new Gn.Matrix4,i=new Gn.Quaternion;this.updateMatrixWorld=function(){var c=this.space;switch(this.position.copy(this.worldPosition),"scale"===this.mode&&(c="local"),t.set(1,0,0).applyQuaternion("local"===c?this.worldQuaternion:i),e.set(0,1,0).applyQuaternion("local"===c?this.worldQuaternion:i),n.set(0,0,1).applyQuaternion("local"===c?this.worldQuaternion:i),o.copy(e),this.mode){case"translate":case"scale":switch(this.axis){case"X":o.copy(this.eye).cross(t),a.copy(t).cross(o);break;case"Y":o.copy(this.eye).cross(e),a.copy(e).cross(o);break;case"Z":o.copy(this.eye).cross(n),a.copy(n).cross(o);break;case"XY":a.copy(n);break;case"YZ":a.copy(t);break;case"XZ":o.copy(n),a.copy(e);break;case"XYZ":case"E":a.set(0,0,0)}break;case"rotate":default:a.set(0,0,0)}0===a.length()?this.quaternion.copy(this.cameraQuaternion):(s.lookAt(r.set(0,0,0),a,o),this.quaternion.setFromRotationMatrix(s)),Gn.Object3D.prototype.updateMatrixWorld.call(this)}};Bn.prototype=Object.assign(Object.create(Gn.Mesh.prototype),{constructor:Bn,isTransformControlsPlane:!0});var Un=An;var Hn=function(){function t(){Object(i.a)(this,t)}return Object(c.a)(t,[{key:"make",value:function(t,e){if(!e.id)throw new Error("can't create scene w/ missing parent");return st(t,ot(t,{type:"scene",title:function t(e,n,r){var a=e+" "+n;return r.getChildren().find(function(t){return t.title==a})?t(e,n+1,r):a}("Scene ",0,e),autoRecenter:!0,defaultFloor:!1,parent:e.id,children:t.createArray()}))}},{key:"makeNode",value:function(t,e){var n=new be.Group;return n.name=t.title,this.setDefaultFloor(n,t.defaultFloor),n.start=function(){n.userData.sceneAnchor=new be.Group,n.userData.sceneAnchor.name="SceneAnchor",n.children.slice().forEach(function(t){var r,a=e.accessObject(t.userData.graphid);a.exists()&&((r=a.type)!==_e.geoanchor&&r!==_e.localanchor&&r!==_e.imageanchor&&r!==_e.hudanchor&&a.type!==_e.geoanchor&&a.type!==_e.localanchor&&a.type!==_e.imageanchor&&a.type!==_e.hudanchor&&n.userData.sceneAnchor.add(t))}),n.add(n.userData.sceneAnchor)},n.stop=function(){n.userData.sceneAnchor.children.slice().forEach(function(t){return n.add(t)}),n.remove(n.userData.sceneAnchor)},n}},{key:"updateProperty",value:function(t,e,n,r){console.log("update property",t.name,n.name,n.value),n.name===Ye.defaultFloor.key&&(console.log("setting the floor too",n.value),this.setDefaultFloor(t,n.value))}},{key:"setDefaultFloor",value:function(t,e){if(!0===e){var n=new be.Mesh(new be.PlaneBufferGeometry(100,100,10,10),new be.MeshLambertMaterial({color:"blue"}));n.name="defaultFloor",n.rotation.x=-90*Math.PI/180,t.parts={},t.parts.floor=n,t.add(n)}else t.parts&&t.parts.floor&&(t.remove(t.parts.floor),delete t.parts.floor)}},{key:"getFloorPart",value:function(t){return t&&t.parts?t.parts.floor:null}}]),t}(),Vn=function(t){function e(t){var n;return Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this,t))).add=function(t){n.setState({notification:t,visible:!0}),setTimeout(n.hide,2e3)},n.hide=function(){return n.setState({visible:!1})},n.state={notification:"saved",visible:!1},n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"componentWillMount",value:function(){G.onAdd(this.add)}},{key:"componentWillUnmount",value:function(){G.offAdd(this.add)}},{key:"render",value:function(){return a.a.createElement("div",{style:{position:"absolute",bottom:"10px",left:"10px",backgroundColor:"rgba(0,0,0,0.6)",borderRadius:"1em",color:"white",fontSize:"24pt",padding:"1em",display:this.state.visible?"block":"none"}},this.state.notification)}}]),e}(r.Component),Wn=function(){function t(){Object(i.a)(this,t)}return Object(c.a)(t,[{key:"getCurrentScene",value:function(){throw new Error("getCurrentScene not implemented")}},{key:"getSceneObjects",value:function(t){throw new Error("getSceneObjects not implemented")}},{key:"getBehaviorsForObject",value:function(t){throw new Error("getBehaviorsForObject(obj) not implemented")}},{key:"getThreeObject",value:function(t){throw new Error("getThreeObject(id) not implemented")}},{key:"getParsedBehaviorAsset",value:function(t){throw new Error("getParsedBehaviorAsset(behavior) not implemented")}},{key:"getAllBehaviors",value:function(){throw new Error("getAllBehaviors() not implemented")}},{key:"getAllScenes",value:function(){throw new Error("getAllScenes not implemented")}},{key:"navigateScene",value:function(t){throw new Error("navigateScene(id) not implemented")}},{key:"playMediaAsset",value:function(t){throw new Error("playMediaAsset(id) not implemented")}},{key:"stopMediaAsset",value:function(t){throw new Error("stopMediaAsset(id) not implemented")}},{key:"getGraphObjectByName",value:function(t){throw new Error("getGraphObjectByName(name) not implemented")}},{key:"getGraphObjectById",value:function(t){throw new Error("getGraphObjectById(id) not implemented")}},{key:"getCamera",value:function(){throw new Error("getCamera() not implemented")}},{key:"getTweenManager",value:function(){throw new Error("getTweenManager() not implemented")}},{key:"startLocalAnchor",value:function(t){throw new Error("startLocalAnchor not implemented")}},{key:"stopLocalAnchor",value:function(t){throw new Error("stopLocalAnchor not implemented")}},{key:"startImageRecognizer",value:function(t){throw new Error("startImageRecognizer not implemented")}},{key:"stopImageRecognizer",value:function(t){throw new Error("stopImageRecognizer not implemented")}},{key:"startGeoTracker",value:function(t){throw new Error("startGeoTracker not implemented")}},{key:"stopGeoTracker",value:function(t){throw new Error("stopGeoTracker not implemented")}},{key:"startWorldInfo",value:function(t){throw new Error("startWorldInformation not implemented")}},{key:"stopWorldInfo",value:function(t){throw new Error("stopWorldInformation not implemented")}}]),t}(),Kn=function(){function t(e,n,r){Object(i.a)(this,t),this.manager=e,this.sgp=n,this.logger=this.manager.logger,this.tween=n.getTweenManager(),this.camera=n.getCamera(),this.globalStorage=this.manager.storage,this.behavior=r}return Object(c.a)(t,[{key:"getThreeObjectByTitle",value:function(t){var e=this.sgp.getGraphObjectByName(t);if(!e)throw new Error("three object '".concat(t,"' not found"));return this.sgp.getThreeObject(e)}},{key:"getObjectByTitle",value:function(t){var e=this.sgp.getGraphObjectByName(t);if(!e||!e.exists())throw new Error("object '".concat(t,"' not found"));return e}},{key:"getAssetByTitle",value:function(t){var e=this.sgp.getGraphObjectByName(t);if(!e||!e.exists())throw new Error("asset '".concat(t,"' not found"));var n=this._event&&this._event.data&&this._event.data.event&&this._event.data.event.isTrusted;return new qn(this.manager,e,n)}},{key:"getAssetById",value:function(t){var e=this.getObjectById(t);if(!e||!e.exists())throw new Error("asset '".concat(t,"' not found"));var n=this._event&&this._event.data&&this._event.data.event&&this._event.data.event.isTrusted;return new qn(this.manager,e,n)}},{key:"getObjectById",value:function(t){var e=this.sgp.getGraphObjectById(t);if(!e||!e.exists())throw new Error("object '".concat(t,"' not found"));return e}},{key:"getThreeObjectById",value:function(t){return this.sgp.getThreeObject(t)}},{key:"playSound",value:function(t){this.playMedia(t)}},{key:"playMedia",value:function(t){var e=this.sgp.getGraphObjectById(t);if(!e||!e.exists())throw new Error("asset '".concat(t,"' not found"));var n=this._event&&this._event.data&&this._event.data.event&&this._event.data.event.isTrusted;this.manager.sgp.playMediaAsset(e,n)}},{key:"stopMedia",value:function(t){var e=this.sgp.getGraphObjectById(t);if(!e||!e.exists())throw new Error("asset '".concat(t,"' not found"));this.manager.sgp.stopMediaAsset(e)}},{key:"getCurrentScene",value:function(){var t=this.sgp.getCurrentScene();if(!t||!t.exists())throw new Error("current scene not found");return t}},{key:"navigateScene",value:function(t){this.manager.fireSceneLifecycleEvent("exit",this.getCurrentScene()),this.sgp.navigateScene(t),this.manager.fireSceneLifecycleEvent("enter",this.getCurrentScene())}},{key:"fireEvent",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;null==n&&(n=this.sgp.getGraphObjectById(this.behavior.parent)),this.manager.fireEventAtTarget(n,t,e)}},{key:"sendMessage",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;null==n&&(n=this.sgp.getGraphObjectById(this.behavior.parent)),this.manager.fireMessageAtTarget(n,t,e)}},{key:"captureEvent",value:function(){this.manager.captureEvent()}},{key:"globals",get:function(){return{THREE:be,GLTFLoader:Se,GPUParticles:Fe,WebLayer3D:Pe.a}}},{key:"properties",get:function(){return this.behavior.props()}}]),t}(),Zn=function(){function t(e,n){Object(i.a)(this,t),this.sgp=e,this.logger=n,this.running=!1,this.storage={},this.logger=n,this.logger.log("ScriptManager created"),this.system_cache={},this.bubbling=!0,window.THREE||(window.THREE=be),window.GLTFLoader||(window.GLTFLoader=Se),window.GPUParticles||(window.GPUParticles=Fe),window.WebLayer3D||(window.WebLayer3D=Pe.a)}return Object(c.a)(t,[{key:"fireLifecycleEvent",value:function(t){var e=this;this.logger.log("doing ".concat(t," event"));var n={type:t};this.sgp.getAllScenes().forEach(function(r){r.find(function(r){if(r.type===tn.BEHAVIOR){n.target=e.sgp.getThreeObject(r.parent),n.graphTarget=e.sgp.getGraphObjectById(r.parent);var a=e.sgp.getParsedBehaviorAsset(r),o=e.getSystemFacadeFromCache(r);o.code=a,a[t]&&a[t].call(o,n)}else n.target=e.sgp.getThreeObject(r),n.graphTarget=r,n.target&&n.target[t]&&n.target[t](n,e)})})}},{key:"fireSceneLifecycleEvent",value:function(t,e,n){var r=this;"tick"!==t&&this.logger.log("doing ".concat(t," event"));var a={type:t,time:n?n-this.startTime:-1,deltaTime:n?n-this.lastTime:0,session:this.session};n&&(this.lastTime=n),e.find(function(e){if("tick"!==t&&r.logger.log("calling ".concat(t," on ").concat(e.type," ").concat(e.id)),e.type===tn.BEHAVIOR){a.target=r.sgp.getThreeObject(e.parent),a.graphTarget=r.sgp.getGraphObjectById(e.parent);var n=r.sgp.getParsedBehaviorAsset(e),o=r.getSystemFacadeFromCache(e);o.code=n,n[t]&&n[t].call(o,a)}else a.target=r.sgp.getThreeObject(e),a.graphTarget=e,a.target&&a.target[t]&&a.target[t](a,r)})}},{key:"tick",value:function(t,e){if(this.running){0===this.startTime&&(this.startTime=t,this.lastTime=t);try{this.session=e,this.fireSceneLifecycleEvent("tick",this.sgp.getCurrentScene(),t)}catch(n){this.logger.error("error in script",n.message),this.logger.log(n),this.stopRunning()}}}},{key:"startRunning",value:function(){this.running=!0,this.startTime=0,this.lastTime=0,this.storage={},this.logger.log("ScriptManager starting");try{this.fireLifecycleEvent("start")}catch(t){this.logger.error("error in script",t.message),this.logger.error(t),this.stopRunning()}}},{key:"startFirstScene",value:function(){try{this.fireSceneLifecycleEvent("enter",this.sgp.getCurrentScene())}catch(t){this.logger.error("error in script",t.message),this.logger.error(t),this.stopRunning()}}},{key:"stopRunning",value:function(){try{this.fireSceneLifecycleEvent("exit",this.sgp.getCurrentScene()),this.fireLifecycleEvent("stop"),this.running=!1,this.storage={},this.destroyListeners()}catch(t){this.running=!1,this.logger.error("error stopping scripts",t.message),this.logger.error(t)}this.logger.log("script manager stopping")}},{key:"isRunning",value:function(){return this.running}},{key:"fireMessageAtTarget",value:function(t,e,n){var r=this;if(this.running)try{var a={type:"message",name:e,data:n,time:this.lastTime,target:this.sgp.getThreeObject(t),graphTarget:t};this.sgp.getBehaviorsForObject(t).forEach(function(t){var e=r.getSystemFacadeFromCache(t),n=r.sgp.getParsedBehaviorAsset(t);e._event=a,e.code=n,n.message&&n.message.call(e,a),e._event=null})}catch(o){this.logger.error("error in '"+e+"' message",o.message),this.logger.error(o),this.stopRunning()}}},{key:"performClickAction",value:function(t,e){this.fireEventAtTarget(t,"click",{event:e})}},{key:"captureEvent",value:function(){this.bubbling=!1}},{key:"fireEventAtTarget",value:function(t,e,n){var r=this;if(this.running)try{!function(){r.bubbling=!0;for(var a={type:e,data:n,time:r.lastTime,target:r.sgp.getThreeObject(t),graphTarget:t},o=r.sgp.getCurrentScene();r.bubbling&&t.id!==o.id&&t.type!==tn.SCENE;){r.sgp.getBehaviorsForObject(t).forEach(function(t){var n=r.getSystemFacadeFromCache(t),o=r.sgp.getParsedBehaviorAsset(t);n._event=a,o[e]&&(n.code=o,o[e].call(n,a)),n._event=null}),t=r.sgp.getGraphObjectById(t.parent)}}()}catch(a){this.logger.error("error in '"+e+"' event",a.message),this.logger.error(a),this.stopRunning()}}},{key:"destroyListeners",value:function(){this.listeners={}}},{key:"on",value:function(t,e,n){this.listeners||(this.listeners={}),this.listeners[t.id]||(this.listeners[t.id]={}),this.listeners[t.id][e]||(this.listeners[t.id][e]=[]),this.listeners[t.id][e].push(n)}},{key:"getSystemFacadeFromCache",value:function(t){return this.system_cache[t.id]||(this.system_cache[t.id]=new Kn(this,this.sgp,t)),this.system_cache[t.id]}}]),t}(),qn=function(){function t(e,n,r){Object(i.a)(this,t),this.manager=e,this.obj=n,this.trusted=r}return Object(c.a)(t,[{key:"play",value:function(){this.manager.sgp.playMediaAsset(this.obj,this.trusted)}},{key:"stop",value:function(){this.manager.sgp.stopMediaAsset(this.obj)}}]),t}(),Qn=function(){function t(){Object(i.a)(this,t),this.running=!1}return Object(c.a)(t,[{key:"update",value:function(t){throw new Error("update not implemented")}},{key:"start",value:function(){this.running=!0}},{key:"isAlive",value:function(){return this.running}},{key:"kill",value:function(){this.running=!1}}]),t}(),zn=function(t){function e(t){var n;return Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this))).type="wait",n.duration=t,n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"update",value:function(t){t/=1e3,this.startTime||(this.startTime=t),(t-this.startTime)/this.duration>=1&&(this.running=!1)}}]),e}(Qn),Jn=function(t){function e(t){var n;return Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this))).type="action",n.fn=t,n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"start",value:function(){var t=this.fn();return this.running=!1,t}}]),e}(Qn),$n=function(t){function e(t){var n;return Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this))).type="forever",n.fn=t,n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"start",value:function(){this.running=!0,this.startTime=Date.now()/1e3}},{key:"update",value:function(t){var e=t/1e3-this.startTime;this.fn(e)}}]),e}(Qn),Xn={SINGLE:"single",COMPOUND:"compound"},Yn={LINEAR:"linear",ELASTIC:"elastic"};function Ln(t,e,n){return(e-t)*n+t}var _n=function(t){function e(t){var n;if(Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this))).type="prop",n.target=t.target,n.duration=t.duration,"undefined"===typeof n.duration)throw new Error("duration is missing");if(n.property=t.property,"undefined"===typeof n.property)throw new Error("property is missing");return n.propertyType=t.propertyType||Xn.SINGLE,n.from=t.from,n.to=t.to,n.lerp_type=t.lerpType||Yn.LINEAR,n.loop=t.loop,"undefined"===typeof n.loop&&(n.loop=1),n.loopCount=0,n.reversed=!1,n.autoReverse=t.autoReverse,"undefined"===typeof n.autoReverse&&(n.autoReverse=!1),n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"update",value:function(t){t/=1e3,this.startTime||(this.startTime=t);var e=(t-this.startTime)/this.duration;if(e>1&&(e=1),this.setPropertyValue(this.from,this.to,e),1===e){if(this.loopCount++,this.autoReverse&&(this.reversed=!this.reversed),-1!==this.loop&&this.loopCount>=this.loop)return void(this.running=!1);this.startTime=t}}},{key:"setPropertyValue",value:function(t,e,n,r,a){var o=this;this.propertyType===Xn.SINGLE&&(this.target[this.property]=this.lerp(this.from,this.to,this.reversed?1-n:n)),this.propertyType===Xn.COMPOUND&&Object.keys(this.from).forEach(function(t){o.target[o.property][t]=o.lerp(o.from[t],o.to[t],o.reversed?1-n:n)})}},{key:"lerp",value:function(t,e,n){return this.lerp_type===Yn.LINEAR?Ln(t,e,n):this.lerp_type===Yn.ELASTIC?Ln(t,e,function(t){return Math.pow(2,-10*t)*Math.sin((t-.075)*(2*Math.PI)/.3)+1}(n)):(console.log("invalid LERP_TYPE"),t)}}]),e}(Qn),tr=function(t){function e(t){var n;if(Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this))).type="clip",n.target=t.target,n.name=t.name,n.loop=t.loop,n.autoReverse=t.autoReverse,"undefined"===typeof n.autoReverse&&(n.autoReverse=!1),"undefined"===typeof n.loop&&(n.loop=1),"undefined"===typeof n.name)throw new Error("name is missing");return n.speed=t.speed,"undefined"===typeof n.speed&&(n.speed=1),n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"start",value:function(){this.running=!0,this.mixer=new be.AnimationMixer(this.target.scene),this.action=this.mixer.clipAction(be.AnimationClip.findByName(this.target.animations,this.name)),1===this.loop&&this.action.setLoop(be.LoopOnce,1),-1===this.loop&&this.action.setLoop(this.autoReverse?be.LoopPingPong:be.LoopRepeat,1/0),this.loop>1&&this.action.setLoop(be.LoopRepeat,this.loop),this.action.play(),this.action.setEffectiveTimeScale(this.speed),this.startTime=Date.now()/1e3,this.prevTime=this.startTime}},{key:"update",value:function(t){var e=t/1e3-this.prevTime;this.mixer.update(e),this.prevTime=t/1e3}},{key:"kill",value:function(){this.action.stop(),this.running=!1}}]),e}(Qn),er=function(t){function e(){var t;return Object(i.a)(this,e),(t=Object(u.a)(this,Object(p.a)(e).call(this))).subs=[],t}return Object(l.a)(e,t),Object(c.a)(e,[{key:"and",value:function(t){return t instanceof Qn?this.subs.push(t):this.subs.push(new Jn(t)),this}},{key:"start",value:function(){return this.running=!0,this.subs.forEach(function(t){return t.start()}),this}},{key:"update",value:function(t){this.subs.forEach(function(e){e.isAlive()&&e.update(t)})}},{key:"isAlive",value:function(){return void 0!==this.subs.find(function(t){return!0===t.isAlive()})}}]),e}(Qn),nr=function(t){function e(){var t;return Object(i.a)(this,e),(t=Object(u.a)(this,Object(p.a)(e).call(this))).subs=[],t.n=-1,t}return Object(l.a)(e,t),Object(c.a)(e,[{key:"then",value:function(t){return t instanceof Qn?this.subs.push(t):this.subs.push(new Jn(t)),this}},{key:"wait",value:function(t){return this.subs.push(new zn(t)),this}},{key:"start",value:function(){return this.running=!0,this._startNext(),this}},{key:"_startNext",value:function(){if(this.n=this.n+1,this.n>this.subs.length-1)return this.running=!1,this.n=-1,null;var t=this.subs[this.n],e=t.start();return t.isAlive()?t:e?(console.log("the next swapped itself",e),this.subs[this.n]=e,this.n=this.n-1,this._startNext()):this._startNext()}},{key:"update",value:function(t){var e=this.subs[this.n];e.update(t),e.isAlive()||this._startNext()}},{key:"isAlive",value:function(){return void 0!==this.subs.find(function(t){return!0===t.isAlive()})}}]),e}(Qn),rr=function(){function t(){Object(i.a)(this,t),this.subs=[]}return Object(c.a)(t,[{key:"parallel",value:function(){var t=new er;return this.subs.push(t),t}},{key:"sequence",value:function(){var t=new nr;return this.subs.push(t),t}},{key:"action",value:function(t){var e=new Jn(t);return this.subs.push(e),e}},{key:"prop",value:function(t){var e=new _n(t);return this.subs.push(e),e}},{key:"isAlive",value:function(){return this.subs.find(function(t){return!0===t.isAlive()})}},{key:"update",value:function(t){var e=Date.now();this.subs.forEach(function(t){t.isAlive()&&t.update(e)})}},{key:"forever",value:function(t){var e=new $n(t);return this.subs.push(e),e}},{key:"clip",value:function(t){var e=new tr(t);return this.subs.push(e),e}},{key:"wait",value:function(t){var e=new zn(t);return this.subs.push(e),e}}]),t}(),ar=n(14),or=n.n(ar),sr=n(19),ir=n(15),cr=n(13),ur=new Map,pr=ir.a(),lr=[0,0,0],dr=[0,0,-1],fr=null,mr=null,vr=new be.Color(14548957),br=new be.Color(16737894),hr=new be.MeshStandardMaterial({color:vr}),yr=!0,Or=0,kr=function(t){function e(t,n){var r;return Object(i.a)(this,e),r=Object(u.a)(this,Object(p.a)(e).call(this)),Or?(n.error("XRWorldInfo called more than once - very bad"),Object(u.a)(r,Or)):(Or=Object(m.a)(Object(m.a)(r)),r.engine=t,r.session=t.session,r.logger=n,r._floorPos=cr.b(),r.session.updateWorldSensingState({illuminationDetectionState:{enabled:!0},meshDetectionState:{enabled:!0,normals:!0}}),r._handleHitResults=r.handleHitResults.bind(Object(m.a)(Object(m.a)(r))),(mr=new be.Mesh(new be.RingGeometry(.04,.05,36,64),hr)).geometry.applyMatrix((new be.Matrix4).makeRotationX(be.Math.degToRad(-90))),(fr=new be.Object3D).add(mr),fr.matrixAutoUpdate=!1,fr.visible=!1,r)}return Object(l.a)(e,t),Object(c.a)(e,[{key:"refreshWorldInfo",value:function(t){var e=this;if(this.visible){var n=t.worldInformation;n&&n.meshes&&(ur.forEach(function(t){t.seen=!1}),n.meshes.forEach(function(t){var n=ur.get(t.uid);n?e.handleUpdateNode(t,n):e.handleNewNode(t)}),ur.forEach(function(t){t.seen||e.handleRemoveNode(t)}),yr&&(yr=!1,this.session.requestFrameOfReference("head-model").then(function(t){e.session.requestFrameOfReference("eye-level").then(function(n){e.floorUpdate(t,n),e.session.requestHitTest(lr,dr,t).then(e._handleHitResults).catch(function(t){e.logger.error("Error testing hits",t)})})})))}}},{key:"handleHitResults",value:function(t){var e=this;if(t&&t.length>0){var n=t[0];this.session.requestFrameOfReference("head-model").then(function(t){e.session.requestFrameOfReference("eye-level").then(function(e){t.getTransformTo(e,pr),ir.e(pr,pr,n.hitMatrix);var r=fr;r.matrix.fromArray(pr),fr.visible=!0,mr.material.color=vr,r.updateMatrixWorld(!0)})})}else mr.material.color=br;yr=!0}},{key:"handleUpdateNode",value:function(t,e){if(e.seen=!0,!(t.timeStamp<=e.ts))if(t.vertexCountChanged){var n=this.newMeshNode(t);e.threeMesh.geometry.dispose(),e.node.remove(e.threeMesh),e.node.add(n),e.threeMesh=n}else{if(t.vertexPositionsChanged){var r=e.threeMesh.geometry.attributes.position;r.array.length!=t.vertexPositions.length&&this.logger.error("position and vertex arrays are different sizes",r,t),r.setArray(t.vertexPositions),r.needsUpdate=!0}if(t.textureCoordinatesChanged){var a=e.threeMesh.geometry.attributes.uv;a.array.length!=t.textureCoordinates.length&&this.logger.error("uv and vertex arrays are different sizes",a,t),a.setArray(t.textureCoordinates),a.needsUpdate=!0}if(t.triangleIndicesChanged){var o=e.threeMesh.geometry.index;o.array.length!=t.triangleIndices&&this.logger.error("uv and vertex arrays are different sizes",o,t),o.setArray(t.triangleIndices),o.needsUpdate=!0}if(t.vertexNormalsChanged&&t.vertexNormals.length>0){var s=e.threeMesh.geometry.attributes.normals;s.array.length!=t.vertexNormals&&this.logger.error("uv and vertex arrays are different sizes",s,t),s.setArray(t.vertexNormals),s.needsUpdate=!0}}}},{key:"handleRemoveNode",value:function(t){this.remove(t.node),t.threeMesh.geometry.dispose(),this.engine._removeAnchorForNode(t.node,this.logger),ur.delete(t.worldMesh.uid)}},{key:"handleNewNode",value:function(t){var e=new be.Group,n=this.newMeshNode(t);e.add(n),this.add(e),this.engine.addAnchoredNode(t,e,this.logger),ur.set(t.uid,{ts:t.timeStamp,worldMesh:t,node:e,seen:!0,threeMesh:n})}},{key:"newMeshNode",value:function(t){var e=new be.Group,n=new be.BufferGeometry,r=new be.BufferAttribute(t.triangleIndices,1);r.dynamic=!0,n.setIndex(r);var a=new be.BufferAttribute(t.vertexPositions,3);a.dynamic=!0,n.addAttribute("position",a);var o=new be.BufferAttribute(t.textureCoordinates,2);if(o.dynamic=!0,n.addAttribute("uv",o),t.vertexNormals.length>0){var s=new be.BufferAttribute(t.vertexNormals,3);s.dynamic=!0,n.addAttribute("normal",s)}else n.computeVertexNormals();var i=new be.MeshPhongMaterial({color:"#11FF11",wireframe:!0}),c=new be.MeshPhongMaterial({color:"#009900",transparent:!0,opacity:.25});return e.add(new be.Mesh(n,c)),e.add(new be.Mesh(n,i)),e.geometry=n,e}},{key:"floorUpdate",value:function(t,e){var n=cr.b(),r=cr.b(),a=cr.b(),o=0;t.getTransformTo(e,pr),ir.c(n,pr),ur.forEach(function(t){var e=t.worldMesh;cr.e(r,e._center.x,e._center.y,e._center.z),cr.g(r,r,e.modelMatrix);var s=r[1]-n[1];s>-.5||(s<-2||(n[0]-r[0])*(n[0]-r[0])+(n[2]-r[2])*(n[2]-r[2])-e._extent[0]*e._extent[0]-e._extent[1]*e._extent[1]-9>0||o<s||(o=s,cr.e(a,n[0],r[1],n[2])))}),o&&(cr.f(a,this._floorPos)<.01||(cr.a(this._floorPos,a),ir.b(pr,this._floorPos),this.logger.log("************** floor is at "+this._floorPos[1])))}},{key:"floorPos",get:function(){return this._floorPos}}]),e}(be.Group),wr=window.Cesium,gr=window.XRGeospatialAnchor,Sr=function(){function t(){Object(i.a)(this,t),this.imageDetectorMap={},this.geoAnchorMap={},this._workingMatrix=ir.a(),this._identity=ir.a(),this._vec=cr.b(),this.lastFrameTime=0,this.worldInfo=0,this.heightAboveFloor=1.1}return Object(c.a)(t,[{key:"getContext",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this.device=0,this.session=0,this.xrCanvas=0,this.xrContext=0,this.canvas=e,this.context=0,this.xrCanvas=document.createElement("canvas"),this.xrContext=this.xrCanvas.getContext("xrpresent"),this._anchoredNodes=new Map,this.projectionMatrix=0;var n=this;return new Promise(function(e,r){navigator.xr.requestDevice().then(function(a){n.device=a,n.device.requestSession({outputContext:n.xrContext,alignEUS:!0,geolocation:!0,worldSensing:!0}).then(function(r){n.session=r,gr.useEstimatedElevation(!0,t.heightAboveFloor),t.updateGeoElevationLoop(),n.session.nonStandard_setNumberOfTrackedImages(4),n.canvas||(n.canvas=document.createElement("canvas")),n.context||(n.context=n.canvas.getContext("webgl",{compatibleXRDevice:n.device})),n.session.baseLayer=new window.XRWebGLLayer(n.session,n.context),e(n.context)}).catch(function(t){console.error("Session setup error",t),r()})}).catch(function(t){console.error("Error",t),r()})})}},{key:"updateGeoElevationLoop",value:function(){var t=Object(sr.a)(or.a.mark(function t(){var e,n=this;return or.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return e=function(t){return new Promise(function(e){return setTimeout(e,t)})},t.next=3,gr.useEstimatedElevation(!0,this.heightAboveFloor);case 3:return t.next=5,e(100);case 5:setTimeout(function(){return n.updateGeoElevationLoop()},1);case 6:case"end":return t.stop()}},t,this)}));return function(){return t.apply(this,arguments)}}()},{key:"setAnimationLoop",value:function(t){var e=this;t?(this.session.requestFrameOfReference("head-model").then(function(t){e.headFrameOfReference=t}).catch(function(t){console.error("Error finding head frame of reference",t)}),this.session.requestFrameOfReference("eye-level").then(function(t){e.eyeLevelFrameOfReference=t}).catch(function(t){console.error("Error finding eye frame of reference",t)}),this.userAnimationCallback=t,this.__handleAnimationFrame=this._handleAnimationFrame.bind(this),this.session.requestAnimationFrame(this.__handleAnimationFrame)):console.error("Supply a callback")}},{key:"_handleAnimationFrame",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(this.lastFrameTime=t,this.session&&!this.session.ended&&(this.session.requestAnimationFrame(this.__handleAnimationFrame),this.headFrameOfReference&&this.eyeLevelFrameOfReference)){var n=e.getDevicePose(this.eyeLevelFrameOfReference);if(n){var r=!0,a=!1,o=void 0;try{for(var s,i=e.views[Symbol.iterator]();!(r=(s=i.next()).done);r=!0){var c=s.value;this.worldInfo&&this.worldInfo.visible&&this.worldInfo.refreshWorldInfo(e),this.userAnimationCallback(this.session.baseLayer.getViewport(c),c.projectionMatrix,n.getViewMatrix(c),t,e),this.projectionMatrix=c.projectionMatrix;break}}catch(u){a=!0,o=u}finally{try{r||null==i.return||i.return()}finally{if(a)throw o}}}else console.log("No pose")}}},{key:"getTime",value:function(){return this.lastFrameTime}},{key:"addAnchoredNode",value:function(t,e,n){return t&&t.uid?(this._anchoredNodes.set(t.uid,{anchor:t,node:e}),e.anchor=t,e.matrixAutoUpdate=!1,e.matrix.fromArray(t.modelMatrix),e.updateMatrixWorld(!0),t._handleAnchorUpdateCallback=this._handleAnchorUpdate.bind(this,n),t._handleAnchorDeleteCallback=this._handleAnchorDelete.bind(this,n),t.addEventListener("update",t._handleAnchorUpdateCallback),t.addEventListener("removed",t._handleAnchorDeleteCallback),n.log("done adding anchored node"),e):(console.error("not a valid anchor",t),void n.error("not a valid anchor ".concat(y(t))))}},{key:"createSceneAnchor",value:function(){var t=Object(sr.a)(or.a.mark(function t(e,n){var r,a;return or.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(n.log("Creating Scene Anchor"),this.session){t.next=4;break}return n.log("no session"),t.abrupt("return");case 4:return t.next=6,this.session.requestFrameOfReference("eye-level");case 6:return r=t.sent,t.next=9,this.session.requestFrameOfReference("head-model");case 9:return t.sent.getTransformTo(r,this._workingMatrix),ir.c(this._vec,this._workingMatrix),ir.b(this._workingMatrix,this._vec),t.next=15,this.session.addAnchor(this._workingMatrix,r);case 15:return a=t.sent,this.addAnchoredNode(a,e,n),t.abrupt("return",a);case 18:case"end":return t.stop()}},t,this)}));return function(e,n){return t.apply(this,arguments)}}()},{key:"updateAnchoredSceneNode",value:function(t,e,n){n.log("Replacing the scene node on the existing scene anchor"),this._removeAnchorFromNode(t),this.addAnchoredNode(t,e,n)}},{key:"removeSceneAnchor",value:function(t,e){e.log("Removing Scene Anchor"),this.session.removeAnchor(t),this._removeAnchorFromNode(t)}},{key:"createLocalAnchorFromHitTest",value:function(t,e,n,r){var a=this;if(this.session)if(this.projectionMatrix)if(this.canvas&&this.canvas.width&&this.canvas.height)if(t.node){var o=e/this.canvas.width*2-1,s=e/this.canvas.height*2,i=cr.b();ir.d(this._workingMatrix,this.projectionMatrix);var c=cr.c(o,s,.5);cr.g(c,c,this._workingMatrix),cr.d(c,c),this.session.requestFrameOfReference("head-model").then(function(e){a.session.requestFrameOfReference("eye-level").then(function(n){a.session.requestHitTest(i,c,e).then(function(n){n.length<1?r.error("No hit returned from hit test"):a.session.addAnchor(n[0],e).then(function(e){a._removeAnchorForNode(t.node),a.addAnchoredNode(e,t.node,r),r.log("made anchor in local coords: "+t.node.position.x+" "+t.node.position.y+" "+t.node.position.z)})})})})}else r.error("missing threejs node");else r.error("No canvas or canvas size");else r.error("No projection matrix");else r.error("no session")}},{key:"createFloorAnchorFromHitTest",value:function(t,e,n,r){var a=this;if(r.log("trying to make floor anchor at "+e+" "+n),this.worldInfo)if(this.session)if(this.projectionMatrix)if(this.canvas&&this.canvas.width&&this.canvas.height)if(t.node){this.worldInfo.floorPos;this.session.requestFrameOfReference("head-model").then(function(e){a.session.requestFrameOfReference("eye-level").then(function(n){e.getTransformTo(n,a._workingMatrix),ir.b(a._workingMatrix,a.worldInfo.floorPos),a.session.addAnchor(a._workingMatrix,n).then(function(e){a._removeAnchorForNode(t.node),a.addAnchoredNode(e,t.node,r),r.log("made floor anchor")})})})}else r.error("missing threejs node");else r.error("No canvas or canvas size");else r.error("No projection matrix");else r.error("no session");else r.error("no world info")}},{key:"stopLocalAnchor",value:function(t,e){console.log("Stopping local anchor"),this._anchoredNodes&&(t.node?this._removeAnchorFromNode(t.node):e.error("missing threejs node"))}},{key:"sleeper",value:function(t){return new Promise(function(e){return setTimeout(e,t)})}},{key:"_fetchImage",value:function(t,e){return new Promise(function(n,r){var a=new Image;a.crossOrigin="Anonymous",a.src=t.image.src,e.log("Loading image",a.src),a.onload=function(){n(a)}})}},{key:"createDetectionImage",value:function(t,e){var n=this;return e.log("creating/find an image recognizer"),new Promise(function(r,a){if(!t.image||!t.node)return e.log("createDetectionImage: missing image or threejs node"),void a("createDetectionImage: missing image or threejs node");if(!n.session)return e.log("no session"),void a("no session");var o=t.imageRealworldWidth||1;if(n.imageDetectorMap[t.image.src]){var s=n.imageDetectorMap[t.image.src];return o!=s.realWorldWidth?(e.log("can't create the same image with different real world width"),void a("can't create the same image with different real world width")):(e.log("createDetectionImage: already created, returning it"),void r(s.name))}n._fetchImage(t,e).then(function(s){e.log("got the image",y(s));var i,c=Object(Rt.a)(Array(10)).map(function(t){return(~~(36*Math.random())).toString(36)}).join(""),u=document.createElement("canvas"),p=u.getContext("2d");u.width=s.width,u.height=s.height,p.drawImage(s,0,0);try{i=p.getImageData(0,0,s.width,s.height)}catch(l){e.log("error drawing image ".concat(y(l))),e.log("name ".concat(l.name)),e.log("name ".concat(l.message)),e.log("local url is "+document.documentURI),e.log("image url from "+s.src),G.add("error drawing image",l.toString()),a(new Error("foo"))}e.log("calling createDetectionImage with image width and height ".concat(s.width," ").concat(s.height)),n.session.nonStandard_createDetectionImage(c,i.data,s.width,s.height,o).then(function(){n.imageDetectorMap[t.image.src]={name:c,realWorldWidth:o,anchor:null},r(c)}).catch(function(t){e.error("error creating detection image: ".concat(t)),a(t)})}).catch(function(t){e.error("error creating detection image: ".concat(t)),a(t)})})}},{key:"startImageRecognizer",value:function(t,e,n){var r=this;if(n.log("starting Image Recognizer"),t.image&&t.node)if(this.session){var a=t.callback,o=t.node;if(this.imageDetectorMap[t.image.src]){var s=this.imageDetectorMap[t.image.src];if(s.anchor){if(!t.reactivate)return n.log("Found existing anchor: use it"),n.log("remove from previous node"),this._removeAnchorFromNode(s.anchor),n.log("add our node"),this.addAnchoredNode(s.anchor,o,n),void(a&&a(t));n.log("Found existing anchor: reactivate"),this.session.removeAnchor(s.anchor),n.log("remove from previous node"),this._removeAnchorFromNode(s.anchor),s.anchor=null}o.anchorName=null,n.log("activate detection image"),this.session.nonStandard_activateDetectionImage(s.name).then(function(s){n.log("found detection image"),o.anchorName=e,o.anchorStyle="image",r.addAnchoredNode(s,o,n),a&&a(t)}).catch(function(t){n.error("error activating detection image: ".concat(t))})}else n.error("not detection object for image",t.image.src)}else n.log("no session");else n.log("missing image or threejs node")}},{key:"stopImageRecognizer",value:function(t,e){if(console.log("Stopping image recognizer"),this._anchoredNodes)if(this.imageDetectorMap[t.image.src]){var n=this.imageDetectorMap[t.image.src];n.anchor&&(console.log("already found the image, removing it"),this._removeAnchorFromNode(n.anchor),n.anchor=null),console.log("deactivating the image"),this.session.nonStandard_deactivateDetectionImage(n.name).then(function(){}).catch(function(t){e.error("error deactivating detection image: ".concat(t))})}else e.error("no detection object for image",t.image.src)}},{key:"createGeoAnchor",value:function(t,e){var n=this;return e.log("creating or reusing a geospatial anchor"),new Promise(function(r,a){if(!t.node)return e.log("Missing threejs node"),void a("Missing threejs node");if(!n.session)return e.log("no session"),void a("no session");if(n.geoAnchorMap[t.location.id])return e.log("found geoanchor: already created, returning it"),void r();var o=t.location;if(0!=o.latitude||0!=o.longitude){var s=new wr.Cartographic(o.longitude*Math.PI/180,o.latitude*Math.PI/180,o.altitude);o.useAltitude?(e.log("XRGeoAnchor: Placing an object at specified lla and specified altitude"),e.log(y(s)),gr.createGeoAnchor(s).then(function(e){n.geoAnchorMap[t.location.id]={anchor:e},r()}).catch(function(t){e.error("error creating geospatial anchor: ".concat(t)),a(t)})):gr.getDefaultElevation(s).then(function(o){s.height=o,e.log("XRGeoAnchor: Placing an object at specified lla and estimated altitude"),e.log(y(s)),gr.createGeoAnchor(s).then(function(e){n.geoAnchorMap[t.location.id]={anchor:e},r()}).catch(function(t){e.error("error creating geospatial anchor: ".concat(t)),a(t)})}).catch(function(t){e.error("error getting default elevation: ".concat(t)),a(t)})}else gr.getDeviceCartographic().then(function(o){gr.getDefaultElevation().then(function(s){var i=new wr.Cartographic(o.longitude,o.latitude,s);e.log("XRGeoAnchor: Placing an object at your lla"),e.log(y(i)),gr.createGeoAnchor(i).then(function(e){n.geoAnchorMap[t.location.id]={anchor:e},r()}).catch(function(t){e.error("error creating geospatial anchor: ".concat(t)),a(t)})}).catch(function(t){e.error("error getting default elevation: ".concat(t)),a(t)})}).catch(function(t){e.error("error getting device cartographic location: ".concat(t)),a(t)})})}},{key:"addGeoAnchoredNode",value:function(t,e){if(e.log("adding a geotracked node"),t.node)if(this.session)if(this.geoAnchorMap[t.location.id]){var n=this.geoAnchorMap[t.location.id],r=t.callback,a=t.node;this._removeAnchorFromNode(n.anchor),e.log("add our node"),this.addAnchoredNode(n.anchor,a,e),r&&r(t)}else e.error("not geolocation anchor for object",t.location.id);else e.log("no session");else e.log("Missing threejs node")}},{key:"stopGeoTracker",value:function(t,e){t&&t.node&&this._removeAnchorForNode(t.node)}},{key:"_handleAnchorDelete",value:function(t,e){t.log("delete anchor");var n=e.source;this._removeAnchorFromNode(n)}},{key:"_removeAnchorForNode",value:function(t){var e=this;this._anchoredNodes.forEach(function(n){n.node!=t||e._removeAnchorFromNode(t.anchor)})}},{key:"_removeAnchorFromNode",value:function(t){var e=this._anchoredNodes.get(t.uid);e&&(e.node.anchor=null,t.removeEventListener("update",t._handleAnchorUpdateCallback),t.removeEventListener("removed",t._handleAnchorDeleteCallback),t._handleAnchorUpdateCallback=null,t._handleAnchorDeleteCallback=null,this._anchoredNodes.delete(t.uid))}},{key:"_handleAnchorUpdate",value:function(t,e){var n=e.source,r=this._anchoredNodes.get(n.uid);if(r){var a=r.node;a.matrixAutoUpdate=!1,a.matrix.fromArray(n.modelMatrix),a.updateMatrixWorld(!0)}}},{key:"startWorldInfo",value:function(t){return this.worldInfo||(this.worldInfo=new kr(this,t)),this.worldInfo.visible=!0,this.worldInfo}},{key:"stopWorldInfo",value:function(){this.worldInfo&&(this.worldInfo.visible=!1)}}],[{key:"supportsARKit",value:function(){return navigator.xr&&navigator.xr._mozillaXRViewer?(console.log("*** Found mozilla xr viewer"),!0):(console.log("*** Did not find WebXR"),!1)}}]),t}(),Cr=n(23),Er=Cr.SET_PROPERTY,Mr=Cr.INSERT_ELEMENT,jr=Cr.DELETE_ELEMENT,Dr=function(t){function e(t){var n;return Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this))).canvas=t,n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"logger",value:function(){return this.canvas.props.provider.getLogger()}},{key:"getCurrentScene",value:function(){var t=this.canvas.props.provider.getSelectedSceneObject();return t&&t.exists()?t:(this.logger.error("the current scene is null"),null)}},{key:"getSceneObjects",value:function(t){return t.getChildren().filter(function(t){return nn(t.type)})}},{key:"getBehaviorsForObject",value:function(t){return t.getChildren().filter(function(t){return t.type===tn.BEHAVIOR})}},{key:"getThreeObject",value:function(t){return t.id?this.canvas.findNode(t.id):this.canvas.findNode(t)}},{key:"getParsedBehaviorAsset",value:function(t){var e=this.canvas.props.provider,n=e.accessObject(t.behavior);return e.getCachedBehaviorAsset(n.id)}},{key:"getAllBehaviors",value:function(){return this.canvas.props.provider.accessObject(this.canvas.props.provider.getSceneRoot()).find(function(t){return t.type===tn.BEHAVIOR})}},{key:"getAllScenes",value:function(){return this.canvas.props.provider.accessObject(this.canvas.props.provider.getSceneRoot()).find(function(t){return t.type===tn.SCENE})}},{key:"navigateScene",value:function(t){this.canvas.props.provider.accessObject(t).exists()?I.setSelection(t):this.canvas.props.provider.getLogger().error("cannot navigate to a scene that doesn't exist",t)}},{key:"playMediaAsset",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.canvas.props.provider.assetsManager.playMediaAsset(t,e)}},{key:"stopMediaAsset",value:function(t){this.canvas.props.provider.assetsManager.stopMediaAsset(t)}},{key:"getGraphObjectByName",value:function(t){var e=this.canvas.props.provider.accessObject(this.canvas.props.provider.getSceneRoot()).find(function(e){return e.title===t});return!e||e.length<1?null:e[0]}},{key:"getGraphObjectById",value:function(t){return this.canvas.props.provider.accessObject(t)}},{key:"getCamera",value:function(){return this.canvas.camera}},{key:"getTweenManager",value:function(){return this.canvas.tweenManager}},{key:"startLocalAnchor",value:function(t){return this.canvas.startLocalAnchor(t)}},{key:"stopLocalAnchor",value:function(t){return this.canvas.stopLocalAnchor(t)}},{key:"startImageRecognizer",value:function(t){return this.canvas.startImageRecognizer(t)}},{key:"stopImageRecognizer",value:function(t){return this.canvas.stopImageRecognizer(t)}},{key:"startGeoTracker",value:function(t){return this.canvas.startGeoTracker(t)}},{key:"stopGeoTracker",value:function(t){return this.canvas.stopGeoTracker(t)}}]),e}(Wn),Rr=.1,Pr=function(t){function e(t){var n;return Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this,t))).moveCameraForward=function(){n.camera.position.z+=-Rr},n.moveCameraBackward=function(){n.camera.position.z+=Rr},n.handleKeyPress=function(t){"ArrowUp"===t.key&&(n.camera.position.z-=Rr),"ArrowDown"===t.key&&(n.camera.position.z+=Rr),"a"===t.key&&(n.camera.position.x-=Rr),"d"===t.key&&(n.camera.position.x+=Rr),"ArrowLeft"===t.key&&(n.camera.rotation.y+=.1),"ArrowRight"===t.key&&(n.camera.rotation.y-=.1)},n.recenterOnSelection=function(){var t=I.getSelection();if(t){var e=n.props.provider.accessObject(t);if(nn(e.type)){var r=n.findNode(t);if(!r)return;n.orbitControls.target0.copy(r.position);var a=r.position.clone().sub(new be.Vector3(0,0,-2));n.orbitControls.position0.copy(a),n.orbitControls.reset()}e.type===tn.SCENE&&(n.orbitControls.saveState(),n.orbitControls.target0.set(0,0,0),n.orbitControls.position0.set(1,6,6),n.orbitControls.reset())}},n.pauseQueue=function(t){n.props.provider.pauseQueue()},n.unpauseQueue=function(t){n.props.provider.unpauseQueue()},n.transformChanged=function(t){var e=I.getSelection();if(e){var r=n.props.provider.accessObject(e);if(!nn(r.type))return;if(r.type===_e.bg360)return;var a=n.findNode(e);if(!a)return;var o=n.props.provider;o.quick_setPropertyValue(e,"tx",a.position.x),o.quick_setPropertyValue(e,"ty",a.position.y),o.quick_setPropertyValue(e,"tz",a.position.z)}},n.transformDraggingChanged=function(t){n.orbitControls.enabled=!t.value},n.docSwapped=function(t){n.scenes.forEach(function(t){return n.scene.remove(t)}),n.scenes=[],n.obj_node_map={},n.setState({scene:-1});var e=n.props.provider.getDocGraph();n.rebuildNode(e,"");var r=n.props.provider.getSelectedSceneObject();if(!r.exists())return n.props.provider.getLogger().error("no selected scene found");var a=n.findNode(r.id);n.setCurrentSceneWrapper(a,!1)},n.selectionChanged=function(){n.transformControls.detach();var t=I.getSelection();if(t){var e=n.props.provider.accessObject(t);if(e.type===tn.SCENE)return n.setCurrentSceneWrapper(n.findNode(t),!0);if(nn(e.type)){var r=n.props.provider.findSceneObjectParent(e);n.setCurrentSceneWrapper(n.findNode(r.id),!0);var a=n.findNode(t);if(!a)return;n.transformControls.attach(a)}else console.log("selected something not an object or scene")}},n.clickedCanvas=function(t){n.canvas.focus();var e=n.canvas.getBoundingClientRect(),r={x:(t.clientX-e.left)/e.width*2-1,y:-(t.clientY-e.top)/e.height*2+1};n.raycaster.setFromCamera(r,n.camera);var a=n.raycaster.intersectObjects(n.getCurrentSceneWrapper().children,!0);if(a&&a.length>=1){var o=function t(e){return e?e.userData.graphid?e:t(e.parent):null}(a[0].object);n.state.running?n.scriptManager.performClickAction(n.props.provider.accessObject(o.userData.graphid),t):I.setSelection(o.userData.graphid)}else I.clearSelection()},n.obj_node_map={},n.previewUpdateNodes=[],n.scenes=[],n.state={scene:-1,running:t.running},n.current_scene_wrapper=null,n.scriptManager=new Zn(new Dr(Object(m.a)(Object(m.a)(n))),n.props.provider.getLogger()),n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"rebuildNode",value:function(t,e){var n=this;if(t.type===tn.SCENE){var r=(new Hn).makeNode(t,this.props.provider);this.insertNodeMapping(t.id,r),this.addSceneWrapper(r)}if(nn(t.type)){var a=on(t.type).makeNode(t,this.props.provider);this.insertNodeMapping(t.id,a),this.findNode(t.parent).add(a)}t.children&&t.children.forEach(function(t){n.rebuildNode(t,e+"   ")})}},{key:"checkAspectRatio",value:function(){if(this.canvas){var t=this.wrapper.clientWidth,e=this.wrapper.clientHeight,n=t/e;Math.abs(this.camera.aspect-n)>.001&&(this.camera.aspect=n,this.camera.updateProjectionMatrix(),this.renderer.setSize(t-4,e-4))}}},{key:"componentDidMount",value:function(){var t=this,e=this.canvas;this.props.provider.getLogger().log("mounting VRCanvas"),Sr.supportsARKit()?(this.xr=new Sr,this.xr.getContext(e).then(function(n){t.setupRenderer(e,n),t.xr.setAnimationLoop(t.animationLoopWithCamera.bind(t))}).catch(function(t){console.error("Error",t)})):(this.setupRenderer(e,0),this.renderer.setAnimationLoop(this.animationLoop.bind(this)))}},{key:"componentWillUnmount",value:function(){this.saveOrbitControlsState(),this.transformControls.removeEventListener("change",this.transformChanged),this.transformControls.removeEventListener("mouseDown",this.pauseQueue),this.transformControls.removeEventListener("mouseUp",this.unpauseQueue),this.props.provider.off(B.DOCUMENT_SWAPPED,this.docSwapped),I.off(R,this.selectionChanged)}},{key:"setupRenderer",value:function(t,e){var n=this;this.scene=new be.Scene,this.camera=new be.PerspectiveCamera(50,t.width/t.height,.1,1e3),this.renderer=new be.WebGLRenderer({antialias:!1,canvas:t,context:e}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.gammaOutput=!0,this.audioListener=new be.AudioListener,this.props.provider.setAudioListener(this.audioListener),this.camera.add(this.audioListener),this.xr||(this.scene.background=new be.Color(0)),this.scene.add(this.camera),this.camera.position.set(1,6,6),this.transformControls=new Un(this.camera,this.renderer.domElement),this.transformControls.addEventListener("change",this.transformChanged),this.transformControls.addEventListener("dragging-changed",this.transformDraggingChanged),this.transformControls.addEventListener("mouseDown",this.pauseQueue),this.transformControls.addEventListener("mouseUp",this.unpauseQueue),this.scene.add(this.transformControls),this.orbitControls=new bn(this.camera,this.renderer.domElement),this.orbitControls.update(),this.raycaster=new be.Raycaster;var r=new be.DirectionalLight(16777215,1);r.position.set(1,1,1).normalize(),this.scene.add(r),this.scene.add(new be.AmbientLight(16777215,.4)),this.tweenManager=new rr,this.props.provider.onRawChange(function(t){return n.updateScene(t)}),this.props.provider.on(B.DOCUMENT_SWAPPED,this.docSwapped),I.on(R,this.selectionChanged),this.docSwapped()}},{key:"animationLoop",value:function(t,e){this.checkAspectRatio();var n=null;this.xr&&(n=this.xr.session),this.state.running&&this.scriptManager.tick(t,n),this.tweenManager&&this.tweenManager.update(t),this.orbitControls&&this.orbitControls.update(),this.previewUpdateNodes.forEach(function(t){return t.previewUpdate()}),this.renderer.render(this.scene,this.camera)}},{key:"animationLoopWithCamera",value:function(t,e,n,r,a){this.scene&&this.camera&&(this.camera.matrix.fromArray(n),this.camera.matrixWorldNeedsUpdate=!0,this.camera.updateMatrixWorld(),this.camera.projectionMatrix.fromArray(e),this.animationLoop(r,a))}},{key:"insertNodeMapping",value:function(t,e){if("string"!==typeof t)throw new Error("cannot map an object to an object. invalid call in insertNodeMapping");this.obj_node_map[t]=e,e.userData.graphid=t,e.previewUpdate&&this.previewUpdateNodes.push(e)}},{key:"removeNodeMapping",value:function(t,e){delete this.obj_node_map[t],delete e.userData.graphid,this.previewUpdateNodes=this.previewUpdateNodes.filter(function(t){return t!==e})}},{key:"findNode",value:function(t){return this.obj_node_map[t]||console.warn("could not find node for id",t),this.obj_node_map[t]}},{key:"updateScene",value:function(t){var e=this.props.provider;if(t.type!==Mr)if(t.type!==Er)if(t.type!==jr)   ;else{this.transformControls.detach();var n=this.findNode(t.value);n&&(this.removeNodeMapping(t.value,n),nn(e.accessObject(t.value).type)&&n.parent.remove(n))}else{if("parent"===t.name)return;var r=this.findNode(t.object);if(r){var a=e.accessObject(t.object);if("scene"===a.type)return void(new Hn).updateProperty(r,a,t,this.props.provider);if(nn(a.type))return on(a.type).updateProperty(r,a,t,this.props.provider)}else console.log("could not find the node for object id:",t)}else{var o=t.value,s=e.accessObject(t.value);if(s.type===tn.SCENE)return this.populateNode(o);if(nn(s.type))return this.populateNode(o);if(s.type===tn.ASSET)return;if(s.type===tn.ASSETS_LIST)return;if(s.type===tn.BEHAVIOR_SCRIPT)return;if(s.type===tn.BEHAVIOR)return;if(s.type===tn.BEHAVIORS_LIST)return;console.warn("unknown object type",s)}}},{key:"shouldComponentUpdate",value:function(t,e,n){return"running"in t&&t.running!==this.props.running&&(this.setState({running:t.running}),!1===t.running?(this.scriptManager.stopRunning(),this.stopAllMedia(),this.resetSceneGraph(),this.stopRecognizers()):(this.startRecognizers(),this.scriptManager.startRunning(),this.scriptManager.startFirstScene()),!1)}},{key:"render",value:function(){var t=this;return a.a.createElement("div",{style:{borderWidth:0,boxSizing:"border-box",height:"100%",display:"flex",flexDirection:"column"}},a.a.createElement("button",{onClick:this.recenterOnSelection},"recenter on selection"),a.a.createElement("div",{style:{boxSizing:"border-box",borderWidth:0,margin:0,padding:0,flex:1,overflow:"auto"},ref:function(e){return t.wrapper=e}},a.a.createElement("canvas",{ref:function(e){return t.canvas=e},style:{boxSizing:"border-box",margin:0,padding:0,width:"100px",height:"100px",borderWidth:0},onClick:this.clickedCanvas,className:"editable-canvas",onKeyDown:this.handleKeyPress,tabIndex:0}),a.a.createElement(Vn,null)))}},{key:"populateNode",value:function(t){var e=this.props.provider.accessObject(t);if(nn(e.type)){var n=on(e.type).makeNode(e,this.props.provider);this.insertNodeMapping(t,n);var r=this.findNode(e.parent);return r?(r.add(n),this.rebuildParentLink(e),n):null}if(e.type===tn.SCENE){var a=(new Hn).makeNode(e,this.props.provider);return this.insertNodeMapping(t,a),this.addSceneWrapper(a),this.setCurrentSceneWrapper(a,!0),a}console.warn("cannot populate node for type",e.type)}},{key:"rebuildParentLink",value:function(t){var e=this;t.getChildren().forEach(function(n){var r=e.findNode(n.id);r.parent||e.findNode(t.id).add(r),e.rebuildParentLink(n)})}},{key:"addSceneWrapper",value:function(t){this.scenes.push(t),this.scene.add(t)}},{key:"saveOrbitControlsState",value:function(){var t=this.scenes.find(function(t){return t.visible});this.orbitControls.saveState();var e=t.userData.graphid;this.props.provider.orbit_state[e]={target:this.orbitControls.target0.clone(),position:this.orbitControls.position0.clone()}}},{key:"restoreOrbitControlsState",value:function(t){var e=t.userData.graphid;if(this.props.provider.orbit_state[e]){var n=this.props.provider.orbit_state[e];this.orbitControls.target0.copy(n.target),this.orbitControls.position0.copy(n.position),this.orbitControls.reset()}}},{key:"setCurrentSceneWrapper",value:function(t,e){if(!t)return this.props.provider.getLogger().error("invalid scene. cannot setCurrentSceneWrapper");var n=this.getCurrentSceneWrapper(),r=t!==n;r&&e&&this.saveOrbitControlsState(),this.current_scene_wrapper=t,this.scenes.forEach(function(e){e.visible=e===t}),r&&this.restoreOrbitControlsState(t)}},{key:"dumpScenes",value:function(){var t=this;this.scenes.forEach(function(e){console.log("scene"),t.dump(e,"")})}},{key:"dump",value:function(t,e){var n=this;console.log(e+"",t.type,t.id,"vis",t.visible),"Mesh"===t.type&&console.log(e+"  ",t.geometry.type),t.children&&t.children.forEach(function(t){return n.dump(t,e+"  ")})}},{key:"getCurrentSceneWrapper",value:function(){return this.current_scene_wrapper}},{key:"resetSceneGraph",value:function(){var t=this;Object.keys(this.obj_node_map).forEach(function(e){var n=t.props.provider.accessObject(e),r=t.obj_node_map[e];if("scene"!==n.type&&nn(n.type)){var a=on(n.type);a.reset&&a.reset(r,n,t.props.provider.getDataGraph())}})}},{key:"stopAllMedia",value:function(){this.props.provider.assetsManager.stopAllMedia()}},{key:"startRecognizers",value:function(){}},{key:"stopRecognizers",value:function(){}},{key:"startLocalAnchor",value:function(t){this.props.provider.getLogger().log("NOTHING DONE TO start local anchor")}},{key:"stopLocalAnchor",value:function(t){this.props.provider.getLogger().log("NOTHING DONE TO stop local anchor")}},{key:"startImageRecognizer",value:function(t){this.props.provider.getLogger().log("NOTHING DONE TO start image recognizer")}},{key:"stopImageRecognizer",value:function(t){this.props.provider.getLogger().log("NOTHING DONE TO stop image recognizer")}},{key:"startGeoTracker",value:function(t){this.props.provider.getLogger().log("NOTHING DONE TO start geo recognizer")}},{key:"stopGeoTracker",value:function(t){this.props.provider.getLogger().log("NOTHING DONE TO stop geo recognizer")}},{key:"startWorldInfo",value:function(t){this.props.provider.getLogger().log("NOTHING DONE TO start world info")}},{key:"stopWorldInfo",value:function(t){this.props.provider.getLogger().log("NOTHING DONE TO stop world info")}}]),e}(r.Component),Ir=(n(64),n(9)),Tr=function(t,e,n){return t.addEventListener(e,n)},xr=function(t,e,n){return t.removeEventListener(e,n)},Nr=function(t){return t*Math.PI/180},Gr=function(t){function e(t,n){var r;return Object(i.a)(this,e),(r=Object(u.a)(this,Object(p.a)(e).call(this))).startHover=function(){return r.arrow.material.color.set(16777215)},r.endHover=function(){return r.arrow.material.color.set(16776960)},r.beginDrag=function(t){r.startPoint=r.parent.position.clone(),r.startPoint.copy(t.intersection.point),r.parent.target.parent.worldToLocal(r.startPoint),r.oldFilter=r.parent.pointer.intersectionFilter,r.parent.pointer.intersectionFilter=function(t){return t.userData.draggable},r.startPosition=r.parent.target.position.clone(),r.plane.visible=!0,Tr(r.plane,Ir.d,r.updateDrag),Tr(r.plane,Ir.f,r.endDrag)},r.updateDrag=function(t){r.endPoint=t.intersection.point.clone(),r.parent.target.parent.worldToLocal(r.endPoint),"X"===r.axis&&(r.endPoint.y=r.startPoint.y,r.endPoint.z=r.startPoint.z),"Y"===r.axis&&(r.endPoint.x=r.startPoint.x,r.endPoint.z=r.startPoint.z),"Z"===r.axis&&(r.endPoint.x=r.startPoint.x,r.endPoint.y=r.startPoint.y);var e=r.endPoint.clone().sub(r.startPoint),n=r.startPosition.clone().add(e);r.parent.target.position.copy(n),r.parent.position.copy(n)},r.endDrag=function(t){xr(r.plane,Ir.d,r.updateDrag),xr(r.plane,Ir.f,r.endDrag),r.parent.pointer.intersectionFilter=r.oldFilter,r.plane.visible=!1,r.parent.dispatchEvent({type:"change",start:r.startPosition.clone(),end:r.parent.position.clone()})},r.axis=t,r.control=n,r.makePlane(),r.makeArrow(),r.makeInputGrabber(),r}return Object(l.a)(e,t),Object(c.a)(e,[{key:"makePlane",value:function(){this.plane=new be.Mesh(new be.PlaneBufferGeometry(100,100,100,100),new be.MeshBasicMaterial({visible:!0,wireframe:!0,side:be.DoubleSide})),"Z"===this.axis&&(this.plane.rotation.y=Nr(90)),this.plane.userData.draggable=!0,this.plane.visible=!1,this.add(this.plane)}},{key:"makeArrow",value:function(){this.arrow=new be.Mesh(new be.CylinderBufferGeometry(.02,.02,4),new be.MeshLambertMaterial({color:"yellow"})),"X"===this.axis&&(this.arrow.rotation.z=Nr(90)),"Y"===this.axis&&(this.arrow.rotation.z=Nr(180)),"Z"===this.axis&&(this.arrow.rotation.x=Nr(90)),this.add(this.arrow)}},{key:"makeInputGrabber",value:function(){this.input=new be.Mesh(new be.CylinderBufferGeometry(.1,.1,4),new be.MeshLambertMaterial({color:"green",visible:!1})),"X"===this.axis&&(this.input.rotation.z=Nr(90)),"Y"===this.axis&&(this.input.rotation.z=Nr(180)),"Z"===this.axis&&(this.input.rotation.x=Nr(90)),this.input.userData.clickable=!0,this.add(this.input)}},{key:"attach",value:function(){Tr(this.input,Ir.b,this.startHover),Tr(this.input,Ir.c,this.endHover),Tr(this.input,Ir.e,this.beginDrag)}},{key:"detach",value:function(){xr(this.input,Ir.b,this.startHover),xr(this.input,Ir.c,this.endHover),xr(this.input,Ir.e,this.beginDrag)}}]),e}(be.Group),Ar=function(t){function e(){var t;return Object(i.a)(this,e),(t=Object(u.a)(this,Object(p.a)(e).call(this))).handles=[],t.handles.push(new Gr("X",Object(m.a)(Object(m.a)(t)))),t.handles.push(new Gr("Y",Object(m.a)(Object(m.a)(t)))),t.handles.push(new Gr("Z",Object(m.a)(Object(m.a)(t)))),t.handles.forEach(function(e){return t.add(e)}),t.visible=!1,t}return Object(l.a)(e,t),Object(c.a)(e,[{key:"attach",value:function(t,e){this.target=t,this.pointer=e,this.position.copy(t.position),this.visible=!0,this.handles.forEach(function(t){return t.attach()})}},{key:"detach",value:function(){this.target=null,this.pointer=null,this.visible=!1,this.handles.forEach(function(t){return t.attach()})}}]),e}(be.Group),Fr=function(t,e,n){return t.addEventListener(e,n)},Br=function(t){function e(t,n){var r;if(Object(i.a)(this,e),r=Object(u.a)(this,Object(p.a)(e).call(this)),!t)throw new Error("cannot pass empty scene to Panel2D()");if(!n)throw new Error("cannot pass empty camera to Panel2D()");r.type="panel2d",r.listeners={},r.scene=t,r.camera=n,r.canvas=document.createElement("canvas"),r.canvas.width=256,r.canvas.height=512,r.canvasTexture=new be.CanvasTexture(r.canvas),r.redrawHandler=function(t){return r.redraw()};var a=r.canvas.getContext("2d");a.fillStyle="red",a.fillRect(0,0,r.canvas.width,r.canvas.height),r.mesh=new be.Mesh(new be.PlaneGeometry(1,2),new be.MeshBasicMaterial({color:"white",map:r.canvasTexture})),r.mesh.userData.clickable=!0,r.comps=[],r.add(r.mesh);var o=null;return Fr(r.mesh,Ir.d,function(t){var e=t.intersection.uv,n=new be.Vector2(256*e.x,512-512*e.y);o&&!o.contains(n)&&(o.fire(Ir.c),o=null);var a=r.findAt(n);o!==a&&(o&&o.fire(Ir.c),o=null),a&&a.fire(Ir.b),o=a}),Fr(r.mesh,Ir.a,function(t){var e=t.intersection.uv,n=new be.Vector2(256*e.x,512-512*e.y),a=r.findAt(n);a&&a.fire(Ir.a)}),r.header=new be.Mesh(new be.BoxGeometry(1,.1,.1),new be.MeshBasicMaterial({color:"goldenrod"})),r.header.userData.clickable=!0,r.header.position.set(0,1.1,0),r.add(r.header),Fr(r.header,Ir.b,function(t){return r.header.material.color.set("yellow")}),Fr(r.header,Ir.c,function(t){return r.header.material.color.set("goldenrod")}),Fr(r.header,Ir.e,function(t){return r.startDrag()}),r}return Object(l.a)(e,t),Object(c.a)(e,[{key:"fire",value:function(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].forEach(function(t){return t(e)})}},{key:"findAt",value:function(t){for(var e=0;e<this.comps.length;e++){var n=this.comps[e],r=n.findAt({x:t.x-n.x,y:t.y-n.y});if(r)return r}return null}},{key:"add",value:function(t){t instanceof be.Object3D?Object(f.a)(Object(p.a)(e.prototype),"add",this).call(this,t):(this.comps.push(t),Fr(t,"changed",this.redrawHandler))}},{key:"redraw",value:function(){var t=this.canvas.getContext("2d");t.fillStyle="white",t.fillRect(0,0,this.canvas.width,this.canvas.height),this.comps.forEach(function(e){return e.draw(t)}),this.canvasTexture.needsUpdate=!0}},{key:"startDrag",value:function(){var t=this;this.header.userData.clickable=!1,this.mesh.userData.clickable=!1,this.dragSphere=new be.Mesh(new be.SphereGeometry(4,32,32),new be.MeshLambertMaterial({color:"green",wireframe:!0,side:be.BackSide})),this.dragSphere.userData.clickable=!0,this.scene.add(this.dragSphere),Fr(this.dragSphere,Ir.d,function(e){return t.moveDrag(e)}),Fr(this.dragSphere,Ir.f,function(e){return t.endDrag(e)})}},{key:"endDrag",value:function(){this.scene.remove(this.dragSphere),this.dragSphere.userData.clickable=!1,this.header.userData.clickable=!0,this.mesh.userData.clickable=!0}},{key:"moveDrag",value:function(t){this.position.copy(t.point),this.position.add(new be.Vector3(0,-1,0)),this.lookAt(this.camera.position)}}]),e}(be.Object3D),Ur=function(){function t(){Object(i.a)(this,t),this.listeners={}}return Object(c.a)(t,[{key:"set",value:function(t,e){return this[t]=e,this.fire("changed",{type:"changed",target:this}),this}},{key:"get",value:function(t){return this[t]}},{key:"addEventListener",value:function(t,e){return this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e),this}},{key:"on",value:function(t,e){return this.addEventListener(t,e),this}},{key:"setAll",value:function(t){var e=this;return Object.keys(t).forEach(function(n){return e.set(n,t[n])}),this}},{key:"fire",value:function(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].forEach(function(t){return t(e)})}}]),t}(),Hr=function(t){function e(){var t;return Object(i.a)(this,e),(t=Object(u.a)(this,Object(p.a)(e).call(this))).type="button",t.text="foo",t.x=0,t.y=0,t.fsize=20,t.w=t.text.length*t.fsize,t.h=20,t.normalBg="white",t.hoverBg="red",t.bg=t.normalBg,t.on(Ir.b,function(){t.bg=t.hoverBg,t.fire("changed",{type:"changed",target:Object(m.a)(Object(m.a)(t))})}),t.on(Ir.c,function(){t.bg=t.normalBg,t.fire("changed",{type:"changed",target:Object(m.a)(Object(m.a)(t))})}),t}return Object(l.a)(e,t),Object(c.a)(e,[{key:"draw",value:function(t){t.font="".concat(this.fsize,"px sans-serif");var e=t.measureText(this.text);this.w=5+e.width+5,this.h=0+this.fsize+4,t.fillStyle=this.bg,t.fillRect(this.x,this.y,this.w,this.h),t.fillStyle="black",t.fillText(this.text,this.x+3,this.y+this.fsize-2),t.strokeStyle="black",t.strokeRect(this.x,this.y,this.w,this.h)}},{key:"contains",value:function(t){return!(t.x<this.x)&&(!(t.x>this.x+this.w)&&(!(t.y<this.y)&&!(t.y>this.y+this.h)))}},{key:"findAt",value:function(t){return t.x<0?null:t.x>0+this.w?null:t.y<0?null:t.y>0+this.h?null:this}},{key:"set",value:function(t,n){Object(f.a)(Object(p.a)(e.prototype),"set",this).call(this,t,n),"normalBg"===t&&(this.bg=this.normalBg)}}]),e}(Ur),Vr=function(t){function e(){var t;return Object(i.a)(this,e),(t=Object(u.a)(this,Object(p.a)(e).call(this))).type="group",t.x=0,t.y=0,t.w=100,t.h=100,t.bg="gray",t.visible=!0,t.comps=[],t.padding=5,t.border=1,t.layout=function(t){console.log("not laying out anything")},t}return Object(l.a)(e,t),Object(c.a)(e,[{key:"draw",value:function(t){this.visible&&(this.layout(this),t.fillStyle=this.bg,t.fillRect(this.x,this.y,this.w,this.h),this.border>0&&(t.strokeStyle="black",t.strokeRect(this.x,this.y,this.w,this.h)),t.save(),t.translate(this.x+this.padding,this.y+this.padding),this.comps.forEach(function(e){return e.draw(t)}),t.restore())}},{key:"contains",value:function(t){return!(t.x<this.x)&&(!(t.x>this.x+this.w)&&(!(t.y<this.y)&&!(t.y>this.y+this.h)))}},{key:"findAt",value:function(t){if(!this.visible)return null;for(var e=0;e<this.comps.length;e++){var n=this.comps[e],r=n.findAt({x:t.x-n.x-5,y:t.y-n.y-5});if(r)return r}return null}},{key:"childSet",value:function(t,e){return this.childProps[t]=e,this.comps.forEach(function(n){return n.set(t,e)}),this}},{key:"add",value:function(t){return this.comps.push(t),this.fire("changed",{type:"changed",target:this}),this}}]),e}(Ur),Wr=function(t){return Math.PI/180*t},Kr=new be.Vector3(0,1,0),Zr=function(){function t(e,n){var r=this;Object(i.a)(this,t),this.stagePos=e,this.stageRot=n,this.states={touchpad:!1},this.listeners={},this.keystates={ArrowLeft:{current:!1,previous:!1},ArrowRight:{current:!1,previous:!1},ArrowUp:{current:!1,previous:!1},ArrowDown:{current:!1,previous:!1}},this.dir=new be.Vector3(0,0,1),document.addEventListener("keydown",function(t){r.keystates[t.key]&&(r.keystates[t.key].current=!0)}),document.addEventListener("keyup",function(t){r.keystates[t.key]&&(r.keystates[t.key].current=!1)})}return Object(c.a)(t,[{key:"addEventListener",value:function(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)}},{key:"_fire",value:function(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].forEach(function(t){return t(e)})}},{key:"updateKeys",value:function(){var t=this;!1===this.keystates.ArrowLeft.current&&!0===this.keystates.ArrowLeft.previous&&this.rotateLeft(),!1===this.keystates.ArrowRight.current&&!0===this.keystates.ArrowRight.previous&&this.rotateRight(),!1===this.keystates.ArrowUp.current&&!0===this.keystates.ArrowUp.previous&&this.moveForward(),!1===this.keystates.ArrowDown.current&&!0===this.keystates.ArrowDown.previous&&this.moveBackward(),Object.keys(this.keystates).forEach(function(e){t.keystates[e].previous=t.keystates[e].current})}},{key:"rotateLeft",value:function(){this.dir.applyAxisAngle(Kr,Wr(30)),this.stageRot.rotation.y-=Wr(30)}},{key:"rotateRight",value:function(){this.dir.applyAxisAngle(Kr,-Wr(30)),this.stageRot.rotation.y+=Wr(30)}},{key:"moveForward",value:function(){this.stagePos.position.add(this.dir),this._fire("move",this.stagePos.position)}},{key:"moveBackward",value:function(){this.stagePos.position.sub(this.dir),this._fire("move",this.stagePos.position)}},{key:"update",value:function(){this.scanGamepads(),this.updateKeys()}},{key:"scanGamepads",value:function(){for(var t=navigator.getGamepads(),e=0;e<t.length;e++){var n=t[e];if(n&&("Daydream Controller"===n.id||"Gear VR Controller"===n.id||"Oculus Go Controller"===n.id||"OpenVR Gamepad"===n.id||n.id.startsWith("Oculus Touch")||n.id.startsWith("Spatial Controller"))){if(n.buttons.length<2)return;var r=n.buttons[0];if(r.pressed&&n.axes&&2===n.axes.length){var a=n.axes[0]<-.5,o=n.axes[0]>.5,s=n.axes[1]<-.5,i=n.axes[1]>.5;s&&!1===this.states.touchpad&&!0===r.pressed&&this.moveForward(),i&&!1===this.states.touchpad&&!0===r.pressed&&this.moveBackward(),a&&!1===this.states.touchpad&&!0===r.pressed&&this.rotateLeft(),o&&!1===this.states.touchpad&&!0===r.pressed&&this.rotateRight()}n.buttons[1].pressed&&console.log("trigger"),!1===this.states.touchpad&&!0===r.pressed&&console.log("pressed"),!0===this.states.touchpad&&!1===r.pressed&&console.log("released"),this.states.touchpad=r.pressed}}}}]),t}();function qr(t){var e=t.accessObject(t.getSceneRoot()),n=(new Hn).make(t.getDataGraph(),e);e.insertFirstChild(n),I.setSelection(n.id)}function Qr(t){I.isEmpty()||(t.accessObject(I.getSelection()).removeFromParent(),I.clearSelection())}function zr(t){var e=Object.assign({},t.options,{mode:"edit",switcher:!1,doc:t.genID("doc")});document.location="./?".concat(w(e))}function Jr(t){var e=[];return F.supportsAssetUpload()?e=e.concat([{title:"image",enabled:F.isLoggedIn(),icon:ln.image,fun:function(){return t.showAddImageAssetDialog()}},{title:"server image",enabled:F.isLoggedIn(),icon:ln.image,fun:function(){return t.showAddServerImageDialog()}},{divider:!0},{title:"GLTF model",enabled:F.isLoggedIn(),icon:ln.model,fun:function(){return t.showAddGLTFAssetDialog()}},{title:"GLB model",enabled:F.isLoggedIn(),icon:ln.model,fun:function(){return t.showAddGLBAssetDialog()}},{divider:!0},{title:"audio file",enabled:F.isLoggedIn(),icon:ln.audio,fun:function(){return t.showAddAudioAssetDialog()}},{title:"existing asset on server",enabled:F.isLoggedIn(),icon:ln.assets,fun:function(){return t.showOpenAssetDialog()}}]):e.push({title:"add asset from glitch",icon:ln.assets,fun:function(){return t.showOpenAssetDialog()}}),e.push({title:"geo location",icon:ln.geoanchor,fun:function(){return t.showAddGeoLocationAssetDialog()}}),e}var $r=n(23),Xr=$r.SET_PROPERTY,Yr=$r.CREATE_OBJECT,Lr=$r.INSERT_ELEMENT,_r=$r.DELETE_ELEMENT,ta=function(t){function e(t,n){var r;return Object(i.a)(this,e),(r=Object(u.a)(this,Object(p.a)(e).call(this))).editor=t,r.provider=n,r}return Object(l.a)(e,t),Object(c.a)(e,[{key:"getCurrentScene",value:function(){return this.provider.accessObject(this.editor.currentScene)}},{key:"getSceneObjects",value:function(t){return t.getChildren().filter(function(t){return nn(t.type)})}},{key:"getBehaviorsForObject",value:function(t){return t.getChildren().filter(function(t){return t.type===tn.BEHAVIOR})}},{key:"getThreeObject",value:function(t){return this.editor.findNode(t)}},{key:"getParsedBehaviorAsset",value:function(t){var e=this.provider.accessObject(t.behavior);return this.provider.getCachedBehaviorAsset(e.id)}},{key:"getAllBehaviors",value:function(){return this.provider.accessObject(this.provider.getSceneRoot()).find(function(t){return t.type===tn.BEHAVIOR})}},{key:"getAllScenes",value:function(){return this.provider.accessObject(this.provider.getSceneRoot()).find(function(t){return t.type===tn.SCENE})}},{key:"navigateScene",value:function(t){if(this.provider.accessObject(t).exists())return this.editor.swapScene(t);this.provider.getLogger().error("cannot navigate to scene that does not exist",t)}},{key:"playMediaAsset",value:function(t,e){this.provider.assetsManager.playMediaAsset(t,e)}},{key:"stopMediaAsset",value:function(t){this.provider.assetsManager.stopMediaAsset(t)}},{key:"getGraphObjectByName",value:function(t){var e=this.provider.accessObject(this.provider.getSceneRoot()).find(function(e){return e.title===t});return!e||e.length<1?null:e[0]}},{key:"getGraphObjectById",value:function(t){return this.provider.accessObject(t)}},{key:"getCamera",value:function(){return this.editor.camera}},{key:"getTweenManager",value:function(){return this.editor.tweenManager}},{key:"startLocalAnchor",value:function(t){this.provider.getLogger().log("NOTHING DONE TO start local anchor")}},{key:"stopLocalAnchor",value:function(t){this.provider.getLogger().log("NOTHING DONE TO stop local anchor")}},{key:"startImageRecognizer",value:function(t){this.provider.getLogger().log("NOTHING DONE TO start image recognizer")}},{key:"stopImageRecognizer",value:function(t){this.provider.getLogger().log("NOTHING DONE TO stop image recognizer")}},{key:"startGeoTracker",value:function(t){this.provider.getLogger().log("NOTHING DONE TO start geo recognizer")}},{key:"stopGeoTracker",value:function(t){this.provider.getLogger().log("NOTHING DONE TO stop geo recognizer")}},{key:"startWorldInformation",value:function(t){return this.provider.getLogger().log("NOTHING DONE TO start world information"),0}},{key:"stopWorldInformation",value:function(t){return this.provider.getLogger().log("NOTHING DONE TO stop world information"),0}}]),e}(Wn),ea=function(t){function e(t){var n;Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this,t))).standardViewClickHandler=function(t){n.scriptManager.isRunning()?n.scriptManager.performClickAction(n.props.provider.accessObject(t.target.userData.graphid),t):I.setSelection(t.target.userData.graphid)},n.obj_node_map={},n.previewUpdateNodes=[];var r=b({});if(!r.doc)throw new Error("doc not specified");return n.logger=new Nt(r.doc),n.scriptManager=new Zn(new ta(Object(m.a)(Object(m.a)(n)),n.props.provider),n.logger),n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"shouldComponentUpdate",value:function(t,e,n){return!1}},{key:"render",value:function(){var t=this;return a.a.createElement("div",null,a.a.createElement("div",{id:"overlay"},a.a.createElement("div",{id:"inner"},a.a.createElement("h1",null,"Application Name"),a.a.createElement("div",{id:"loading-indicator"},a.a.createElement("label",null,"loading..."),a.a.createElement("br",null),a.a.createElement("progress",{max:"100",value:"0",id:"progress"})),a.a.createElement("button",{id:"enter-button",disabled:!0},"VR not supported, play anyway"))),a.a.createElement("div",{ref:function(e){return t.wrapper=e}}),a.a.createElement(d.a,null))}},{key:"componentDidMount",value:function(){this.sceneWrappers={},this.initScene(),this.renderer.setAnimationLoop(this.render3.bind(this))}},{key:"render3",value:function(t){this.tweenManager&&this.tweenManager.update(t),this.previewUpdateNodes.forEach(function(t){return t.previewUpdate()}),this.pointer&&this.pointer.tick(t),this.stats&&this.stats.update(t),this.controller&&this.controller.update(t),this.scriptManager.isRunning()&&this.scriptManager.tick(t),this.renderer.render(this.scene,this.camera)}},{key:"initScene",value:function(){var t=this,e=function(t){return document.querySelector(t)},n=function(t,e,n){return t.addEventListener(e,n)},r=this.wrapper;this.tweenManager=new rr,this.scene=new be.Scene,this.stageRot=new be.Group,this.scene.add(this.stageRot),this.stagePos=new be.Group,this.stageRot.add(this.stagePos),this.camera=new be.PerspectiveCamera(70,window.innerWidth/window.innerHeight,.1,50),this.renderer=new be.WebGLRenderer({antialias:!0});var a=this.renderer;a.setPixelRatio(window.devicePixelRatio),a.setSize(window.innerWidth,window.innerHeight),a.gammaOutput=!0,a.vr.enabled=!0,r.appendChild(a.domElement),this.vrmanager=new Ir.h(a),this.audioListener=new be.AudioListener,this.props.provider.setAudioListener(this.audioListener),this.camera.add(this.audioListener),this.initContent(),window.addEventListener("resize",function(){t.camera.aspect=window.innerWidth/window.innerHeight,t.camera.updateProjectionMatrix(),t.renderer.setSize(window.innerWidth,window.innerHeight)},!1),n(e("#enter-button"),"click",function(){e("#overlay").style.display="none"}),this.vrmanager.addEventListener(Ir.j,function(){console.log("VR detected"),e("#enter-button").removeAttribute("disabled",!1),e("#enter-button").innerText="enter vr",n(e("#enter-button"),"click",function(){return t.vrmanager.enterVR()})});e("#loading-indicator").style.display="none",e("#enter-button").style.display="block",e("#enter-button").removeAttribute("disabled"),this.props.provider.onRawChange(this.updateSceneOp.bind(this)),this.props.provider.on(B.DOCUMENT_SWAPPED,this.documentSwapped.bind(this)),I.on(R,this.selectionChanged.bind(this)),n(this.pointer,Ir.a,function(){return I.clearSelection()}),this.controller=new Zr(this.stagePos,this.stageRot),this.loadScene()}},{key:"selectionChanged",value:function(){var t=I.getSelection();if(null===t&&this.controls)return this.controls.detach(this.selectedNode);var e=this.findNode(t);this.selectedNode!==e&&this.controls&&this.controls.detach(this.selectedNode),this.selectedNode=e,this.selectedNode&&this.controls&&this.controls.attach(this.selectedNode,this.pointer)}},{key:"initContent",value:function(){var t=this;this.xr||(this.scene.background=new be.Color(0));var e=new be.DirectionalLight(16777215,1);e.position.set(1,1,1).normalize(),this.scene.add(e),this.scene.add(new be.AmbientLight(16777215,.2)),this.stats=new Ir.i({renderer:this.renderer}),this.props.editable&&this.camera.add(this.stats),this.scene.add(this.camera),this.camera.matrixAutoUpdate=!1,this.pointer=new Ir.g(this,{intersectionFilter:function(t){return t.userData.clickable},cameraFollowMouse:!1,mouseSimulatesController:!1,enableLaser:!0,laserLength:20});var n=new be.Mesh(new be.CylinderBufferGeometry(.1,.1,1),new be.MeshLambertMaterial({color:"aqua"}));if(n.position.z=-.5,n.rotation.x=sn(-90),this.pointer.controller1.add(n),this.props.editable&&(this.controls=new Ar,this.controls.name="Controls",h(this.controls,"change",function(e){var n=I.getSelection();if(n){var r=t.findNode(n),a=t.props.provider;a.quick_setPropertyValue(n,"tx",r.position.x),a.quick_setPropertyValue(n,"ty",r.position.y),a.quick_setPropertyValue(n,"tz",r.position.z)}})),this.props.editable){this.tools=new Br(this.scene,this.camera),this.tools.position.set(-1,0,-3),this.scene.add(this.tools),this.tools.add((new Hr).setAll({x:5,y:5,text:"add box"}).on(Ir.a,function(){var e=t.props.provider.accessObject(t.currentScene);t.props.provider.add3DObject(_e.cube,e)})),this.tools.add((new Hr).setAll({x:5,y:35,text:"add sphere"}).on(Ir.a,function(){var e=t.props.provider.accessObject(t.currentScene);t.props.provider.add3DObject(_e.sphere,e)})),this.tools.add((new Hr).setAll({x:5,y:65,text:"delete"}).on(Ir.a,function(){Qr(t.props.provider)})),this.tools.add((new Hr).setAll({x:5,y:95,text:"save"}).on(Ir.a,this.props.provider.save));var r=(new Hr).setAll({x:5,y:125,text:"run"}).on(Ir.a,function(){t.scriptManager.isRunning()?(r.set("text","run"),t.scriptManager.stopRunning()):(r.set("text","stop"),t.scriptManager.startRunning(),t.scriptManager.startFirstScene())});this.tools.add(r);var a=(new Vr).setAll({x:5,y:155,w:235,h:35,layout:function(t){var e=0;t.comps.forEach(function(n){n.x=e,n.y=0,e+=n.w+t.padding})}});Le.forEach(function(e){a.add((new Hr).setAll({text:" ",normalBg:e}).on(Ir.a,function(){return t.props.provider.setColor(e)}))}),this.tools.add(a),this.tools.redraw()}}},{key:"updateSceneOp",value:function(t){if(t.type===Yr&&t.defaults&&"scene"===t.defaults.type){var e=this.findNode(t.id);if(e)   ;else{var n=this.props.provider.accessObject(t.id);e=(new Hn).makeNode(n,this.props.provider),this.insertNodeMapping(t.id,e),this.sceneWrappers[t.id]=e,this.stagePos.add(e),this.swapScene(t.id)}}if(t.type!==Lr)if(t.type!==Xr)if(t.type!==_r)   ;else{var r=this.props.provider.accessObject(t.value);if(nn(r.type)){var a=this.findNode(r.id);this.findNode(r.parent).remove(a)}}else{var o=this.props.provider.accessObject(t.object);if("asset"===o.type)return;if("assets"===o.type)return;var s=this.findNode(t.object);if(s){if("parent"===t.name)return;if("scene"===o.type)return(new Hn).updateProperty(s,o,t,this.props.provider);if(nn(o.type))return on(o.type).updateProperty(s,o,t,this.props.provider)}else console.log("could not find the node for object id:",t)}else{var i=this.props.provider.accessObject(t.value);if("scene"===i.type)return;if(nn(i.type)){var c=on(i.type).makeNode(i,this.props.provider);return h(c,Ir.a,this.standardViewClickHandler),this.insertNodeMapping(i.id,c),void this.findNode(i.parent).add(c)}if(i.type===tn.ASSETS_LIST)return;if(i.type===tn.ASSET)return;if(i.type===tn.BEHAVIORS_LIST)return;if(i.type===tn.BEHAVIOR)return;if(i.type===tn.BEHAVIOR_SCRIPT)return;console.warn("unknown object type",i)}}},{key:"documentSwapped",value:function(){var t=this;console.log("totally new document!"),Object.keys(this.sceneWrappers).forEach(function(e){var n=t.sceneWrappers[e];t.controls&&n.remove(t.controls),t.stagePos.remove(n)}),this.sceneWrappers={},this.obj_node_map={};var e=this.props.provider.getDocGraph();console.log("we are building the graph"),this.rebuildNode(e,"")}},{key:"rebuildNode",value:function(t,e){var n=this;if(console.log(e,"rebuilding",t.type),t.type===tn.SCENE){var r=(new Hn).makeNode(t,this.props.provider);this.insertNodeMapping(t.id,r),this.sceneWrappers[t.id]=r,this.stagePos.add(r),this.swapScene(t.id)}if(nn(t.type)){var a=on(t.type).makeNode(t,this.props.provider);h(a,Ir.a,this.standardViewClickHandler),this.insertNodeMapping(t.id,a),this.findNode(t.parent).add(a)}t.children&&t.children.forEach(function(t){n.rebuildNode(t,e+"   ")})}},{key:"swapScene",value:function(t){var e=this;this.currentScene=t,console.log("swapping to the scene",t),Object.keys(this.sceneWrappers).forEach(function(n){var r=e.sceneWrappers[n];r.visible=n===t,e.controls&&r.remove(e.controls)}),this.controls&&this.sceneWrappers[t].add(this.controls),this.sceneWrappers[t].position.x=0,this.sceneWrappers[t].position.z=0}},{key:"loadScene",value:function(){}},{key:"insertNodeMapping",value:function(t,e){if("string"!==typeof t)throw new Error("cannot map an object to an object. invalid call in insertNodeMapping");this.obj_node_map[t]=e,e.previewUpdate&&this.previewUpdateNodes.push(e),e.userData.graphid=t}},{key:"findNode",value:function(t){return this.obj_node_map[t]||console.warn("could not find node for id",t),this.obj_node_map[t]}}]),e}(r.Component),na=function(t){function e(){var t,n;Object(i.a)(this,e);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=Object(u.a)(this,(t=Object(p.a)(e)).call.apply(t,[this].concat(a)))).cancel=function(){d.b.hide()},n.okay=function(){d.b.hide(),at(n.fileinput.files).forEach(function(t){console.log("got the file",t)})},n.selectedFile=function(t){console.log("selected a file",t.target)},n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"render",value:function(){var t=this;return a.a.createElement(At,{visible:!0,onScrimClick:this.cancel},a.a.createElement(d.f,null,a.a.createElement("h3",null,"add GLTF file assets"),a.a.createElement("p",null,"chose ",a.a.createElement("b",null,"the directory")," containing the GLTF file"),a.a.createElement("input",{type:"file",ref:function(e){return t.fileinput=e},onChange:this.selectedFile,multiple:!0,webkitdirectory:"true"}),a.a.createElement(d.c,null,a.a.createElement("button",{onClick:this.cancel},"cancel"),a.a.createElement("button",{onClick:this.okay},"okay"))))}}]),e}(r.Component),ra=function(t){function e(){var t,n;Object(i.a)(this,e);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=Object(u.a)(this,(t=Object(p.a)(e)).call.apply(t,[this].concat(a)))).cancel=function(){d.b.hide()},n.okay=function(){d.b.hide(),at(n.fileinput.files).forEach(function(t){Sn(t,n.props.provider)})},n.selectedFile=function(t){console.log("selected a file",t.target)},n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"render",value:function(){var t=this;return a.a.createElement(At,{visible:!0,onScrimClick:this.cancel},a.a.createElement(d.f,null,a.a.createElement("h3",null,"add GLB to assets"),a.a.createElement("p",null,"choose a GLB file"),a.a.createElement("input",{type:"file",ref:function(e){return t.fileinput=e},onChange:this.selectedFile,multiple:!0}),a.a.createElement(d.c,null,a.a.createElement("button",{onClick:this.cancel},"cancel"),a.a.createElement("button",{onClick:this.okay},"okay"))))}}]),e}(r.Component),aa=function(t){function e(t){var n;return Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this,t))).cancel=function(){d.b.hide()},n.okay=function(){d.b.hide(),"remote"===n.state.view?(console.log("adding the url",n.state.url),Cn(null,n.state.url,n.props.provider)):(console.log("the file input is",n.fileInput),at(n.fileInput.current.files).forEach(function(t){!function(t,e){G.add("uploading"),e.uploadFile(t).then(function(n){if(G.add("uploaded"),console.log("uploaded file with answer",n),!1===n.success)return console.log("there was an error uploading! :(");var r=V()+n.asset.id,a=e.getDataGraph(),o=st(a,a.createObject({type:tn.ASSET,subtype:un.AUDIO,format:n.asset.mimeType,src:r,title:t.name,parent:0}));e.accessObject(e.getAssetsObject()).insertChildLast(o)})}(t,n.props.provider)}))},n.switchLocal=function(){return n.setState({view:"local"})},n.switchRemote=function(){return n.setState({view:"remote"})},n.selectedFile=function(t){n.setState({fileInput:t.target.value})},n.typedURL=function(t){n.setState({url:t.target.value})},n.state={view:"local",url:""},n.fileInput=a.a.createRef(),n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"render",value:function(){return a.a.createElement(At,{visible:!0,onScrimClick:this.cancel},a.a.createElement(d.f,{grow:!0},a.a.createElement("h3",null,"add audio to assets"),a.a.createElement(d.f,{grow:!0},a.a.createElement(S,null,a.a.createElement(M,{onClick:this.switchLocal,selected:"local"===this.state.view},"local"),a.a.createElement(M,{onClick:this.switchRemote,selected:"remote"===this.state.view},"remote")),this.renderSelectedPanel()),a.a.createElement(d.c,null,a.a.createElement("button",{onClick:this.cancel},"cancel"),a.a.createElement("button",{onClick:this.okay},"okay"))))}},{key:"renderSelectedPanel",value:function(){return"local"===this.state.view?a.a.createElement(d.c,null,a.a.createElement("label",null,"File",a.a.createElement("input",{key:"f1",type:"file",onChange:this.selectedFile,ref:this.fileInput}))):a.a.createElement(d.c,null,a.a.createElement("label",null,"URL",a.a.createElement("input",{key:"f2",value:this.state.url,type:"input",onChange:this.typedURL})))}}]),e}(r.Component),oa=function(t){function e(){var t,n;Object(i.a)(this,e);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=Object(u.a)(this,(t=Object(p.a)(e)).call.apply(t,[this].concat(a)))).cancel=function(){d.b.hide()},n.okay=function(){d.b.hide(),n.props.onAnyway()},n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"render",value:function(){return a.a.createElement(At,{visible:!0,onScrimClick:this.cancel,width:"600px",height:"auto"},a.a.createElement(d.f,{grow:!0},a.a.createElement("h3",null,"Warning. Your document has unsaved changes."),a.a.createElement("p",null,"Press cancel to go back"),a.a.createElement("p",null,"Press continue to continue anyway and lose the unsaved changes"),a.a.createElement(d.c,null,a.a.createElement("button",{onClick:this.cancel},"cancel"),a.a.createElement("button",{onClick:this.okay},"continue!"))))}}]),e}(r.Component),sa=function(t){function e(t){var n;return Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this,t))).refreshList=function(){n.props.provider.loadDocList().then(function(t){return n.setState({docList:t})})},n.dismiss=function(){d.b.hide()},n.state={docList:[]},n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"componentDidMount",value:function(){this.refreshList()}},{key:"generateDocUrl",value:function(t){var e=Object.assign({},this.props.provider.options,{mode:"edit",switcher:!1,doc:t.id});return"./?".concat(w(e))}},{key:"deleteDoc",value:function(t){var e=this;return this.props.provider.removeDoc(t).then(function(t){console.log("removed?",t),e.refreshList()})}},{key:"render",value:function(){var t=this;return a.a.createElement(At,{visible:!0,onScrimClick:this.dismiss},a.a.createElement("h3",null,"Open document"),a.a.createElement(d.f,{scroll:!0,style:{flex:1}},a.a.createElement("ul",null,this.state.docList.map(function(e,n){return a.a.createElement("li",{key:n},a.a.createElement("b",null,e.title),a.a.createElement("a",{className:"button",href:t.generateDocUrl(e)},"open"),t.renderDeleteButton(e))}))),a.a.createElement(d.c,{className:"footer"},a.a.createElement("button",{onClick:this.dismiss},"dismiss")))}},{key:"renderDeleteButton",value:function(t){var e=this;return F.supportsDocDelete()?a.a.createElement("button",{onClick:function(){return e.deleteDoc(t)}},"delete"):""}}]),e}(r.Component),ia=function(t){function e(t){var n;return Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this,t))).refreshList=function(){n.props.provider.loadAssetList().then(function(t){n.props.filter&&(t=t.filter(n.props.filter)),n.setState({assetList:t})})},n.okay=function(){d.b.hide()},n.state={assetList:[]},n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"componentDidMount",value:function(){this.refreshList()}},{key:"addAsset",value:function(t){return d.b.hide(),pn(t.mimeType)?wn(t.id,t.url,t.mimeType,t.title,this.props.provider):!(e=t.mimeType)||e.toLowerCase()!==cn.MP3&&e.toLowerCase()!==cn.AAC&&e.toLowerCase()!==cn.WAV?function(t){return!!t&&(t.toLowerCase()===cn.MP4||t.toLowerCase()===cn.MOV)}(t.mimeType)?function(t,e,n,r,a){r||(r=e.substring(e.lastIndexOf("/")+1)),F.supportsAssetUpload()||(t=r);var o=a.accessObject(a.getDataGraph().createObject({type:tn.ASSET,subtype:un.VIDEO,assetId:t,format:n,src:e,title:r,parent:0}));a.accessObject(a.getAssetsObject()).insertChildLast(o)}(t.id,t.url,t.mimeType,t.title,this.props.provider):function(t){return!!t&&t.toLowerCase()===cn.GLB}(t.mimeType)?function(t,e,n,r,a){r||(r=e.substring(e.lastIndexOf("/")+1)),F.supportsAssetUpload()||(t=r);var o=a.accessObject(a.getDataGraph().createObject({type:tn.ASSET,subtype:un.GLTF,assetId:t,format:n,src:e,title:r,parent:0}));a.accessObject(a.getAssetsObject()).insertChildLast(o)}(t.id,t.url,t.mimeType,t.title,this.props.provider):void console.log("can't add this type",t.mimeType):Cn(t.id,t.url,t.mimeType,t.title,this.props.provider);var e}},{key:"deleteAsset",value:function(t){var e=this;return this.props.provider.removeAssetSource(t).then(function(t){console.log("removed?",t),e.refreshList()})}},{key:"render",value:function(){var t=this;return a.a.createElement(At,{visible:!0,onScrimClick:this.okay},a.a.createElement("h3",null,"Add Asset"),a.a.createElement(d.f,{scroll:!0,grow:!0},a.a.createElement("ul",null,this.state.assetList.map(function(e,n){return a.a.createElement("li",{key:n},a.a.createElement("b",null,e.title," "),a.a.createElement("i",null," ",e.mimeType),a.a.createElement("button",{onClick:function(){return t.addAsset(e)}},"add"),t.renderDeleteButton(e))}))),a.a.createElement(d.c,{className:"footer"},a.a.createElement("button",{onClick:this.okay},"close")))}},{key:"renderDeleteButton",value:function(t){var e=this;return F.supportsAssetUpload()?a.a.createElement("button",{onClick:function(){return e.deleteAsset(t)}},"delete"):""}}]),e}(r.Component),ca=n(43),ua=n.n(ca),pa=(n(74),n(76),function(t){function e(t){var n;return Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this,t))).swap=function(){var t=n.props.provider.accessObject(I.getSelection());t.exists()&&t.type===tn.BEHAVIOR_SCRIPT&&n.refresh()},n.changeText=function(t){return n.setState({text:t})},n.save=function(t){n.props.provider.updateBehaviorAssetContents(n.state.id,n.state.text)},n.refresh=function(){var t=I.getSelection(),e=n.props.provider.accessObject(t);console.log("id",t,e.exists(),e.type),e.exists()&&e.type===tn.BEHAVIOR_SCRIPT&&n.props.provider.fetchBehaviorAssetContents(t).then(function(e){n.setState({id:t,text:e})})},n.state={id:null,text:"empty"},n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"componentDidMount",value:function(){this.refresh(),this.props.provider.on(B.PROPERTY_CHANGED,this.refresh),I.on(R,this.swap)}},{key:"componentWillUnmount",value:function(){this.props.provider.off(B.PROPERTY_CHANGED,this.refresh),I.off(R,this.swap)}},{key:"render",value:function(){return null===this.state.id?a.a.createElement("div",null,"loading"):a.a.createElement(ua.a,{mode:"javascript",theme:"github",name:"script-editor",value:this.state.text,onChange:this.changeText,onBlur:this.save,showGutter:!0,width:"100%",height:"100%"})}}]),e}(r.Component)),la=function(t){function e(t){var n;return Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this,t))).refreshList=function(){n.props.provider.loadScriptList().then(function(t){return n.setState({scripts:t})})},n.okay=function(){return d.b.hide()},n.state={scripts:[]},n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"componentDidMount",value:function(){this.refreshList()}},{key:"addScript",value:function(t){d.b.hide(),console.log("URL is",t.url),t.url=t.name,console.log("Now URL is",t.url);var e=this.props.provider.addBehaviorAssetFromURL(t);this.props.onAdd&&this.props.onAdd(e)}},{key:"deleteScript",value:function(t){var e=this;return this.props.provider.removeBehaviorAssetSource(t.name).then(function(){return e.refreshList()})}},{key:"render",value:function(){var t=this;return a.a.createElement(At,{visible:!0,onScrimClick:this.okay},a.a.createElement("h3",null,"Choose Behavior Script"),a.a.createElement(d.f,{scroll:!0},a.a.createElement("ul",{className:"behaviors-list"},this.state.scripts.map(function(e,n){return a.a.createElement(d.c,{key:e.name},a.a.createElement(d.f,null,a.a.createElement("div",null,a.a.createElement("i",null,e.name)," -  ",a.a.createElement("b",null,e.title)),a.a.createElement("p",null,e.description)),a.a.createElement(E,null),a.a.createElement("button",{onClick:function(){return t.addScript(e)}},"add"),t.renderDeleteButton(e))}))),a.a.createElement(d.c,{className:"footer"},a.a.createElement("button",{onClick:this.okay},"close")))}},{key:"renderDeleteButton",value:function(t){var e=this;return F.supportsScriptEdit()?a.a.createElement("button",{onClick:function(){return e.deleteScript(t)}},"delete"):""}}]),e}(r.Component),da="\n/*\n #title untitled behavior\n #description does something\n*/\n({\n  // defines a target property. must be a scene\n    properties: {\n        scene: { \n            type:'enum', \n            title: 'target scene', \n            value:null, \n            hints: {\n                type:'node',\n                nodeType:'scene'\n            }\n        },\n    },\n    start: function(evt) {\n        //called when the program starts\n    },\n    click: function(evt) {\n        //called when object is clicked on\n        //this.navigateScene(this.properties.scene)\n    }\n})\n",fa="\n/*\n #title scene script\n #description does something\n*/\n({\n    // defines a target property. must be a scene\n    properties: {\n        scene: { \n            type:'enum', \n            title: 'target scene', \n            value:null, \n            hints: {\n                type:'node',\n                nodeType:'scene'\n            }\n        },\n    },\n    start: function(evt) {\n        //called when the program starts\n    },\n    enter: function(evt) {\n        //called when entering a scene\n    },\n    tick: function(evt) {\n        //called on every frame\n    },\n    exit: function(evt) {\n        //called when exiting a scene\n    },\n    stop: function(evt) {\n        //called when the program stops\n    },\n})\n",ma=n(44),va=n.n(ma),ba=function(t){function e(){return Object(i.a)(this,e),Object(u.a)(this,Object(p.a)(e).apply(this,arguments))}return Object(l.a)(e,t),Object(c.a)(e,[{key:"componentDidMount",value:function(){this.canvas&&this.redraw()}},{key:"componentWillReceiveProps",value:function(t){this.canvas&&this.redraw()}},{key:"redraw",value:function(){va.a.toCanvas(this.canvas,this.props.url,{width:this.props.width,height:this.props.height})}},{key:"render",value:function(){var t=this,e={};return this.props.style&&Object.assign(e,this.props.style),a.a.createElement("canvas",{width:this.props.width,height:this.props.height,ref:function(e){return t.canvas=e},style:e})}}]),e}(r.Component),ha=function(t){function e(){var t,n;Object(i.a)(this,e);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=Object(u.a)(this,(t=Object(p.a)(e)).call.apply(t,[this].concat(a)))).okay=function(){d.b.hide()},n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"render",value:function(){var t=null;this.props.url&&(t=this.props.url);var e=t.replace("https","wxrv");return e=e.replace("http","wxrv"),a.a.createElement(At,{visible:!0,onScrimClick:this.okay},a.a.createElement(d.f,{grow:!0},a.a.createElement("h3",null,this.props.text?this.props.text:"Scan"),a.a.createElement(d.f,{grow:!0},a.a.createElement("label",null,a.a.createElement("a",{href:t},t)),a.a.createElement(ba,{url:e,width:160,height:160})),a.a.createElement(d.c,null,a.a.createElement("button",{onClick:this.okay},"dismiss"))))}}]),e}(r.Component),ya=function(t){function e(t){var n;return Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this,t))).cancel=function(){d.b.hide()},n.okay=function(){d.b.hide(),F.doPasswordLogin(n.state.field)},n.keyDown=function(t){"Enter"===t.key&&n.okay()},n.state={field:""},n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"render",value:function(){var t=this;return a.a.createElement(At,{visible:!0,onScrimClick:this.cancel,width:"600px",height:"auto"},a.a.createElement(d.f,{grow:!0},a.a.createElement("h3",null,"login with the password from your env file"),a.a.createElement("label",null,"password"),a.a.createElement("input",{type:"password",value:this.state.field,onKeyDown:this.keyDown,onChange:function(e){t.setState({field:e.target.value})}}),a.a.createElement(d.c,null,a.a.createElement(E,null),a.a.createElement("button",{onClick:this.cancel},"cancel"),a.a.createElement("button",{onClick:this.okay},"okay"))))}}]),e}(r.Component),Oa=function(t){function e(t){var n;return Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this,t))).cancel=function(){d.b.hide()},n.okay=function(){d.b.hide(),console.log("opening window with the data",n.state.data),F.login(n.state.data)},n.state={data:null},n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"componentDidMount",value:function(){var t=this;console.log("opening dialog"),F.getJSON(U.BASE+"auth/github/login").then(function(e){console.log("got the data",e),t.setState({data:e})})}},{key:"render",value:function(){return a.a.createElement(At,{visible:!0,onScrimClick:this.cancel},a.a.createElement(d.f,{grow:!0},a.a.createElement("h3",null,"Github Auth"),a.a.createElement("p",null,"To log into MrEd you need a github account. Press the button below to log into github and approve MrEd's access. The app will only use Github for authentication. It does not have access to any of your projects or code."),a.a.createElement("button",{onClick:this.okay},"Open Github"),a.a.createElement(d.c,null,a.a.createElement("button",{onClick:this.cancel},"cancel"))))}}]),e}(r.Component),ka=function(t){function e(t,n){var r;return Object(i.a)(this,e),(r=Object(u.a)(this,Object(p.a)(e).call(this,t,n))).state={error:!1},r}return Object(l.a)(e,t),Object(c.a)(e,[{key:"componentDidCatch",value:function(t,e){this.setState({error:!0});var n=this.props.logger;n?(n.error("an error occurred at the react level"),n.error(t),n.error(e)):console.log("NO LOGGER!")}},{key:"render",value:function(){return!0===this.state.error?a.a.createElement("div",null,a.a.createElement("h1",null,"An error happened. Please look at the console")):this.props.children}}]),e}(r.Component),wa=function(t){console.log("parsing",t);var e=0,n=[],r=null,a=[],o=[],s=[],i=[],c=0;if(71!==t[0]||73!==t[1]||70!==t[2]||56!==t[3]||57!==t[4]&&55!==t[4]||97!==t[5])throw new Error("parseGIF: no GIF89a");e+=+!!(128&t[10])*Math.pow(2,1+(7&t[10]))*3+13;for(var u=t.subarray(0,e);t[e]&&59!==t[e];){var p=e,l=t[e];if(33===l){var d=t[++e];if(-1===[1,254,249,255].indexOf(d))throw new Error("parseGIF: unknown label");for(249===d&&n.push(10*(t[e+3]+(t[e+4]<<8))),255===d&&(c=t[e+15]+(t[e+16]<<8));t[++e];)e+=t[e];249===d&&(r=t.subarray(p,e+1),o.push(r[3]>>2&7),s.push(1&r[3]),i.push(r[6]))}else{if(44!==l)throw new Error("parseGIF: unknown blockId");for(e+=9,e+=+!!(128&t[e])*(3*Math.pow(2,1+(7&t[e])))+1;t[++e];)e+=t[e];var f=t.subarray(p,e+1);a.push(URL.createObjectURL(new Blob([u,r,f])))}e++}return{delayTimes:n,loopCnt:c,frames:a,disposals:o,transparencies:s,transparentColors:i}},ga=function(t){function e(t,n,r,a,o){var s;return Object(i.a)(this,e),(s=Object(u.a)(this,Object(p.a)(e).call(this,document.createElement("canvas")))).image.width=t[0].width,s.image.height=t[0].height,s._ctx=s.image.getContext("2d"),s.generateMipmaps=!1,s.isVideoTexture=!0,s.minFilter=be.NearestFilter,s.frames=t,s.delays=n,s.disposals=r,s.transparencies=a,s.transparent=!1,s.transparencies.forEach(function(t){t&&(s.transparent=!0)}),s.transparentColors=o,s.frame=0,s.frameStartTime=Date.now(),s.firstDrawCount=0,s.playing=!0,s}return Object(l.a)(e,t),Object(c.a)(e,[{key:"update",value:function(){if(this.frames&&this.delays&&this.disposals&&(!(this.firstDrawCount>this.frames.length)||this.playing)){var t=Date.now();t-this.frameStartTime>this.delays[this.frame]&&(2===this.disposals[this.frame]&&this._ctx.clearRect(0,0,this.image.width,this.image.width),this.frame=(this.frame+1)%this.frames.length,this.frameStartTime=t,this._ctx.drawImage(this.frames[this.frame],0,0,this.image.width,this.image.height),this.needsUpdate=!0,this.firstDrawCount+=1)}}}]),e}(be.Texture);var Sa=function(){function t(e){Object(i.a)(this,t),this.provider=e,this.assets_url_map={},this.videocache={},this.audiocache={}}return Object(c.a)(t,[{key:"cacheAssetsList",value:function(){var t=this;return F.getJSON("".concat(V(),"list")).then(function(e){e&&e.forEach&&(F.supportsAssetUpload()?e.forEach(function(e){t.assets_url_map[e.id]=V()+e.id}):(e.forEach(function(e){t.assets_url_map[e.title]=e.url}),console.log("cached the assets",t.assets_url_map)))})}},{key:"getAssetURL",value:function(t){return F.supportsAssetUpload()&&!F.isLoggedIn()?V()+t.assetId:t.assetId?this.assets_url_map[t.assetId]:t.src}},{key:"playMediaAsset",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=this.provider.getLogger();if(t.subtype===un.AUDIO){n.log("playing the audio asset",t);var r=this.getAssetURL(t);if(n.log("playing the audio from the url",r),this.audiocache[t.id]){var a=this.audiocache[t.id];a.isPlaying&&a.stop(),a.play()}else{var o=new be.Audio(this.provider.getAudioListener());(new be.AudioLoader).load(r,function(t){o.setBuffer(t),o.setLoop(!1),o.setVolume(.5),o.play()}),this.audiocache[t.id]=o}}if(t.subtype===un.VIDEO){n.log("playing the media asset",t);var s=this.getAssetURL(t);n.log("playing the url yaeah",s);var i=this.videocache[s];i&&(e&&(i.muted=!1),i.play())}}},{key:"stopMediaAsset",value:function(t){t.subtype===un.AUDIO&&this.audiocache[t.id]&&(this.audiocache[t.id].stop(),delete this.audiocache[t.id],this.audiocache[t.id]=null),t.subtype===un.VIDEO&&this.videocache[t.id]&&(this.videocache[t.id].stop(),delete this.videocache[t.id],this.videocache[t.id]=null)}},{key:"stopAllMedia",value:function(){var t=this,e=this.videocache;Object.keys(e).forEach(function(t){var n=e[t];n.pause&&n.pause()}),Object.keys(this.audiocache).forEach(function(e){t.audiocache[e].stop&&t.audiocache[e].stop()})}},{key:"getTexture",value:function(t){var e=this,n=this.provider.accessObject(t);if(!n.exists())return this.provider.getLogger().error("==== invalid asset reference",t),Promise.resolve(null);var r,a=this.getAssetURL(n);return a?(this.provider.getLogger().log("loading asset url",a),n.subtype===un.IMAGE?(this.provider.getLogger().log("asset info",n),"image/gif"===n.format?function(t,e){return new Promise(function(n,r){fetch(t,{mode:"cors"}).then(function(t){return t.arrayBuffer()}).then(function(t){return new Uint8Array(t)}).then(function(t){if(e&&t.length<100){e.getLogger().log("array length is too short",String.fromCharCode(115));for(var n="",r=0;r<t.length;r++)n+=String.fromCharCode(t[r]);e.getLogger().log(n)}return t}).then(function(t){return wa(t,[t])}).then(function(e){console.log("result of gif parsing is",e);for(var r=e.frames,a=e.delayTimes,o=e.disposals,s=e.transparencies,i=e.transparentColors,c=0,u=function(e){var u=new Image;u.crossOrigin="anonymous",u.onload=function(u){if(c++,r[e]=u.target,c===r.length){var p=new ga(r,a,o,s,i);p.image.src=t,p.encoding=be.sRGBEncoding,p.minFilter=be.LinearFilter,n(p)}},u.src=r[e]},p=0;p<r.length;p++)u(p)}).catch(r)})}(a,this.provider):new Promise(function(t,n){(new be.TextureLoader).load(a,function(e){return t(e)},function(t){return console.log("Progress",t)},function(t){e.provider.getLogger().error("error loading texture",t),n(t)})})):n.subtype===un.VIDEO?(this.videocache[a]?r=this.videocache[a]:((r=document.createElement("video")).crossOrigin="anonymous",r.preload="auto",r.muted=!0,r.setAttribute("playsinline",""),r.src=a,this.videocache[a]=r),Promise.resolve(new be.VideoTexture(r))):Promise.resolve(null)):(this.provider.getLogger().error("==== null url from asset",n),Promise.resolve(null))}},{key:"getGLTF",value:function(t){var e=this,n=this.provider.accessObject(t);if(!n.exists())return this.provider.getLogger().error("==== invalid asset reference",t),Promise.resolve(null);var r=this.getAssetURL(n);if(!r)return this.provider.getLogger().error("==== null url from asset",n),Promise.resolve(null);this.provider.getLogger().log("ModelDef loading the model asset url",r);var a=new Se;a.setCrossOrigin("anonymous");var o=new Ee;return Ee.setDecoderPath("./draco/"),a.setDRACOLoader(o),new Promise(function(t,n){a.load(r,function(e){return t(e)},function(t){return console.log("Progress",t)},function(t){e.provider.getLogger().error("error loading texture",t),n(t)})})}}]),t}(),Ca=function(t){function e(t){var n;return Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this,t))).edited=function(t){n.setState({newTitle:t.target.value})},n.dismiss=function(){d.b.hide()},n.saveAs=function(){d.b.hide(),n.props.provider.duplicateDocument(n.state.newTitle)},n.state={newTitle:"Copy of "+t.provider.getDocTitle()},n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"render",value:function(){return a.a.createElement(At,{visible:!0,onScrimClick:this.dismiss,width:"600px",height:"auto"},a.a.createElement("h3",null,"Save Document As"),a.a.createElement(d.c,null,a.a.createElement("label",null,"title"),a.a.createElement("input",{type:"text",value:this.state.newTitle,onChange:this.edited,style:{flex:1}})),a.a.createElement(d.c,{className:"footer"},a.a.createElement(E,null),a.a.createElement("button",{onClick:this.dismiss},"cancel"),a.a.createElement("button",{onClick:this.saveAs},"save as")))}}]),e}(r.Component),Ea=function(t){function e(){var t,n;Object(i.a)(this,e);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=Object(u.a)(this,(t=Object(p.a)(e)).call.apply(t,[this].concat(a)))).dismiss=function(){d.b.hide()},n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"render",value:function(){return a.a.createElement(At,{visible:!0,onScrimClick:this.cancel},a.a.createElement(d.f,{grow:!0},a.a.createElement("h3",null,"Warning. There were errors loading some assets"),a.a.createElement("ul",null,this.props.provider.badAssets.map(function(t,e){return a.a.createElement("li",{key:e},a.a.createElement("b",null,t.title),a.a.createElement("br",null),t.src)})),a.a.createElement(d.c,null,a.a.createElement("button",{onClick:this.dismiss},"keep going anyway"))))}}]),e}(r.Component),Ma=function(t){function e(t){var n;return Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this,t))).getApp=function(){return"edit"===n.mode?a.a.createElement(ja,{provider:Object(m.a)(Object(m.a)(n))}):"vredit"===n.mode?a.a.createElement(ea,{provider:Object(m.a)(Object(m.a)(n)),editable:!0}):"embed-view"===n.mode?a.a.createElement(ea,{provider:Object(m.a)(Object(m.a)(n)),editable:!1}):"vrview"===n.mode?a.a.createElement(ea,{provider:Object(m.a)(Object(m.a)(n)),editable:!1}):void console.log("no mode!")},n.getTitle=function(){return"MrEd"},n.getDocTitle=function(){return n.accessObject(n.getSceneRoot()).title},n.setDocTitle=function(t){return n.accessObject(n.getSceneRoot()).set("title",t)},n.getLogger=function(){return n.pubnub?n.pubnub.getLogger():new Gt},n.docLoaded=function(){return n.accessObject(n.getBehaviorsObject()).getChildren().filter(function(t){return t.type===tn.BEHAVIOR_SCRIPT}).forEach(function(t){n.fetchBehaviorAssetContents(t.id).then(function(e){try{var r=dn(e);r.text=e,n.setCachedBehaviorAsset(t.id,r)}catch(a){console.error(a)}})}),n.assetsManager.cacheAssetsList().then(function(){Promise.all(n.accessObject(n.getAssetsObject()).getChildren().map(function(t){return t.subtype===un.VIDEO?n.assetsManager.getTexture(t.id).then(function(e){e||(n.getLogger().error("error loading a texture",t),n.addAssetLoadingError(t))}):t.subtype===un.IMAGE?n.assetsManager.getTexture(t.id).then(function(e){e||(n.getLogger().error("error loading a texture",t),n.addAssetLoadingError(t))}):t.subtype===un.GLTF?n.assetsManager.getGLTF(t.id).then(function(e){e||(n.getLogger().error("error loading a model",t),n.addAssetLoadingError(t))}):Promise.resolve("all good")})).then(function(t){console.log("fully loaded all assets now"),console.log("error count is",n.badAssets.length),n.badAssets.length>0&&n.showBadAssetsDialog()})})},n.getRendererForItem=function(t){var e=n.accessObject(t);return e.exists()?e.type===tn.ASSET?a.a.createElement("div",null,a.a.createElement("i",{className:"fa fa-".concat(ln[e.subtype])})," ",e.title):ln[e.type]?a.a.createElement("div",null,a.a.createElement("i",{className:"fa fa-".concat(ln[e.type])})," ",e.title):a.a.createElement("div",null,e.title):a.a.createElement("div",null,"???")},n.getAssetsObject=function(){return n.getDataGraph().getObjectByProperty("type",tn.ASSETS_LIST)},n.getBehaviorsObject=function(){return n.getDataGraph().getObjectByProperty("type",tn.BEHAVIORS_LIST)},n.editIn2D=function(){n.save().then(function(){var t=Object.assign({},n.options,{mode:"edit",switcher:!1,doc:n.getDocId()}),e=document.location,r="".concat(e.protocol,"//").concat(e.host).concat(e.pathname,"?").concat(w(t));d.b.show(a.a.createElement(ha,{text:"Edit in 2D",url:r}))})},n.editInVR=function(){n.save().then(function(){var t=Object.assign({},n.options,{mode:"vredit",switcher:!1,doc:n.getDocId()}),e=document.location,r="".concat(e.protocol,"//").concat(e.host).concat(e.pathname,"?").concat(w(t));d.b.show(a.a.createElement(ha,{text:"Edit in AR/VR",url:r}))})},n.viewInVR=function(){n.save().then(function(){var t=Object.assign({},n.options,{mode:"play",switcher:!1,doc:n.getDocId()}),e=document.location,r="".concat(e.protocol,"//").concat(e.host).concat(e.pathname,"?").concat(w(t));d.b.show(a.a.createElement(ha,{text:"View in AR/VR",url:r}))})},n.add3DObject=function(t,e){var r=on(t).make(n.getDataGraph(),e);e.insertFirstChild(r),I.setSelection(r.id),G.add("added "+t)},n.cutSelection=function(t){if(t&&t.target){if("input"===t.target.getAttribute("type"))return;if("INPUT"===t.target.nodeName)return;if("TEXTAREA"===t.target.nodeName)return}if(!I.isEmpty()){var e=n.accessObject(I.getSelection());I.setClipboard(e.id),e.removeFromParent(),I.clearSelection()}},n.copySelection=function(t){if(t&&t.target){if("input"===t.target.getAttribute("type"))return;if("INPUT"===t.target.nodeName)return;if("TEXTAREA"===t.target.nodeName)return}if(!I.isEmpty()){var e=n.accessObject(I.getSelection());I.setClipboard(e.id)}},n.pasteSelection=function(t){if(t&&t.target){if("input"===t.target.getAttribute("type"))return;if("INPUT"===t.target.nodeName)return;if("TEXTAREA"===t.target.nodeName)return}var e=n.accessObject(I.getClipboard()),r=null;if(nn(e.type)&&(r=n.getSelectedSceneObject()),"scene"===e.type&&(r=n.accessObject(n.getSceneRoot())),!r)return console.error("no parent to ad too! bad obj type?",e.type);r.insertChildLast(e.clone())},n.setColor=function(t){I.isEmpty()||n.accessObject(I.getSelection()).set("color",t)},n.showAddImageAssetDialog=function(){return d.b.show(a.a.createElement(En,{provider:Object(m.a)(Object(m.a)(n))}))},n.showAddAudioAssetDialog=function(){return d.b.show(a.a.createElement(aa,{provider:Object(m.a)(Object(m.a)(n))}))},n.showAddGLTFAssetDialog=function(){return d.b.show(a.a.createElement(na,{provider:Object(m.a)(Object(m.a)(n))}))},n.showAddGLBAssetDialog=function(){return d.b.show(a.a.createElement(ra,{provider:Object(m.a)(Object(m.a)(n))}))},n.showOpenDocumentDialog=function(){return d.b.show(a.a.createElement(sa,{provider:Object(m.a)(Object(m.a)(n))}))},n.showOpenAssetDialog=function(){return d.b.show(a.a.createElement(ia,{provider:Object(m.a)(Object(m.a)(n))}))},n.showAddServerImageDialog=function(){return d.b.show(a.a.createElement(ia,{provider:Object(m.a)(Object(m.a)(n)),filter:function(t){return pn(t.mimeType)}}))},n.showOpenBehaviorDialog=function(){return d.b.show(a.a.createElement(la,{provider:Object(m.a)(Object(m.a)(n))}))},n.showAddGeoLocationAssetDialog=function(){var t,e,r,a;t={latitude:0,longitude:0,altitude:0,useAltitude:!1},e="new geo location",r=Object(m.a)(Object(m.a)(n)),a=r.accessObject(r.getDataGraph().createObject({type:tn.ASSET,subtype:un.GEOLOCATION,title:e,latitude:t.latitude,longitude:t.longitude,altitude:t.altitude,useAltitude:t.useAltitude,parent:0})),r.accessObject(r.getAssetsObject()).insertChildLast(a)},n.showPasswordDialog=function(){return d.b.show(a.a.createElement(ya,{provider:Object(m.a)(Object(m.a)(n))}))},n.showGithubDialog=function(){return d.b.show(a.a.createElement(Oa,{provider:Object(m.a)(Object(m.a)(n))}))},n.accessObject=function(t){return new Rn(n.getDataGraph()).object(t)},n.addBehaviorAssetFromURL=function(t){var e=n.getDataGraph(),r=st(e,e.createObject({type:tn.BEHAVIOR_SCRIPT,title:t.title,description:t.description,src:t.url,parent:0}));return n.accessObject(n.getBehaviorsObject()).insertChildLast(r),I.setSelection(r.id),r},n.addCustomBehaviorAsset=function(t){var e=Math.floor(1e8*Math.random()),r="behavior_".concat(e,".js"),a="".concat(W()).concat(r),o=t||da;return console.log("posting it to",a),F.fetch(a,{method:"POST",body:o}).then(function(t){return t.json()}).then(function(t){console.log("got back the answer",t);var e=n.getDataGraph(),a=st(e,e.createObject({type:tn.BEHAVIOR_SCRIPT,title:t.script.title,description:t.script.description,src:r,parent:0}));return n.accessObject(n.getBehaviorsObject()).insertChildLast(a),I.setSelection(a.id),a}).catch(function(t){return console.error(t)})},n.addSceneScript=function(t){n.addCustomBehaviorAsset(fa).then(function(e){return n.addBehaviorToObject(e,t)})},n.addBehaviorToObject=function(t,e){return n.fetchBehaviorAssetContents(t.id).then(function(r){try{var a={type:tn.BEHAVIOR,title:t.title,description:t.description,parent:0,behavior:t.id},o=dn(r);n.setCachedBehaviorAsset(t.id,o),o.properties&&Object.keys(o.properties).forEach(function(t){a[t]=o.properties[t].value});var s=n.getDataGraph(),i=st(s,s.createObject(a));return n.accessObject(e).insertChildLast(i),i}catch(c){console.error(c)}})},n.imagecache={},n.behaviorCache={},n.orbit_state={},n.badAssets=[],n.assetsManager=new Sa(Object(m.a)(Object(m.a)(n))),n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"getDocType",value:function(){return"vr"}},{key:"makeEmptyRoot",value:function(t){var e=st(t,t.createObject({type:tn.ROOT,title:"Untitled Project",splashImage:$e.id,defaultScene:$e.id,children:t.createArray()})),n=new Rn(t).object(e.id),r=(new Hn).make(t,n),a=(new Oe).make(t,r),o=st(t,t.createObject({type:tn.ASSETS_LIST,title:"Assets",children:t.createArray(),parent:0})),s=st(t,t.createObject({type:tn.BEHAVIORS_LIST,title:"Behaviors",children:t.createArray(),parent:0}));ct(t,e,r),ct(t,r,a),ut(t,e,s),ut(t,e,o)}},{key:"addAssetLoadingError",value:function(t){this.badAssets.push(t)}},{key:"getProperties",value:function(t){var e=this;var n=[];if(!t)return n;n.push({key:"id",name:"ID",type:_.STRING,value:t,locked:!0});var r=this.accessObject(t);if(r.type===tn.BEHAVIOR){var a=this.getCachedBehaviorPropDefs(r.behavior);a?Object.keys(a).forEach(function(t){var e=a[t],o={key:t,name:t,type:e.type,value:r[t]};e.hints&&(o.hints=e.hints),n.push(o)}):console.warn("Missing prop defs for behavior object"),n.push({key:"behavior",name:"Script",type:_.STRING,value:r.behavior,locked:!0,custom:!0})}var o=this.syncdoc.getPropertiesForObject(t);return o&&o.forEach(function(a){if("type"!==a&&"children"!==a&&"parent"!==a){var o=e.syncdoc.getPropertyValue(t,a);if(Ye[a]){var s=function(t,e){var n={};return Object.keys(t).forEach(function(e){return n[e]=t[e]}),n.value=e,n}(Ye[a],o);return r.type===tn.BEHAVIOR_SCRIPT&&("title"!==a&&"description"!==a||(s.locked=!0)),r.type===tn.ASSET&&r.subtype===un.IMAGE&&("width"!==a&&"height"!==a||(s.locked=!0)),n.push(s)}}}),nn(r.type)&&(n.push({key:"scale",name:"Scale",type:_.GROUP,group:["sx","sy","sz"],custom:!0}),n.push({key:"translation",name:"Translation",type:_.GROUP,group:["tx","ty","tz"],custom:!0}),n.push({key:"rotation",name:"Rotation",type:_.GROUP,group:["rx","ry","rz"],custom:!0})),n}},{key:"setPropertyValue",value:function(t,n,r){var a=this;if("scale"!==n.key&&"translation"!==n.key&&"rotation"!==n.key){if(Object(f.a)(Object(p.a)(e.prototype),"setPropertyValue",this).call(this,t,n,r),n.key===Ye.asset.key){var o=this.accessObject(r);if(o.subtype===un.IMAGE){var s=o.height/o.width*this.accessObject(t).width;Object(f.a)(Object(p.a)(e.prototype),"setPropertyValue",this).call(this,t,{key:"height"},s)}o.subtype===un.GLTF&&console.log("adjusting to a gtlf")}}else n.group.forEach(function(n){return Object(f.a)(Object(p.a)(e.prototype),"setPropertyValue",a).call(a,t,{key:n},r[n])})}},{key:"getValuesForEnum",value:function(t,e,n){var r=this.accessObject(e);if(r.exists()&&r.type===tn.BEHAVIOR&&n.hasHints()){var a=n.getHints();if("node"===a.type)return this.accessObject(this.getSceneRoot()).find(function(t){return t.type===a.nodeType}).map(function(t){return t.id});if("audio"===a.type)return this.accessObject(this.getAssetsObject()).getChildren().filter(function(t){return t.subtype===un.AUDIO}).map(function(t){return t.id});if("video"===a.type)return this.accessObject(this.getAssetsObject()).getChildren().filter(function(t){return t.subtype===un.VIDEO}).map(function(t){return t.id});if("media"===a.type)return this.accessObject(this.getAssetsObject()).getChildren().filter(function(t){return t.subtype===un.AUDIO||t.subtype===un.VIDEO}).map(function(t){return t.id})}if(t===Ye.asset.key){var o=this.accessObject(this.getAssetsObject()).getChildren();if(Pa(r.type)&&Ia(r.type))return xa(o.filter(function(t){return t.subtype===un.VIDEO||t.subtype===un.IMAGE}).map(function(t){return t.id}));if(Ia(r.type))return xa(o.filter(function(t){return t.subtype===un.VIDEO}).map(function(t){return t.id}));if(r.type===_e.model)return xa(o.filter(function(t){return t.subtype===un.GLTF}).map(function(t){return t.id}));if(Pa(r.type))return xa(o.filter(function(t){return t.subtype===un.IMAGE}).map(function(t){return t.id}))}if(t===Ye.horizontalAlign.key)return Object.keys(en).map(function(t){return en[t]});if(t===Ye.defaultScene.key)return xa(this.accessObject(this.getSceneRoot()).getChildren().filter(function(t){return t.type===tn.SCENE}).map(function(t){return t.id}));if(t===Ye.texture.key){var s=this.accessObject(this.getAssetsObject()).getChildren();return xa(s=s.filter(function(t){return t.subtype===un.IMAGE}).map(function(t){return t.id}))}if(t===Ye.targetImage.key){var i=this.accessObject(this.getAssetsObject()).getChildren();return i=i.filter(function(t){return t.subtype===un.IMAGE}).map(function(t){return t.id})}if(t===Ye.targetGeoLocation.key){var c=this.accessObject(this.getAssetsObject()).getChildren();return c=c.filter(function(t){return t.subtype===un.GEOLOCATION}).map(function(t){return t.id})}return t===Ye.recType.key?Object.keys(fn):t===Ye.splashImage.key?xa(this.accessObject(this.getAssetsObject()).getChildren().filter(function(t){return t.subtype===un.IMAGE}).map(function(t){return t.id})):void 0}},{key:"getRendererForEnum",value:function(t,e){var n=this.accessObject(e);if(n.exists()&&n.type===tn.BEHAVIOR)return Da;switch(t){case Ye.asset.key:case Ye.defaultScene.key:case Ye.texture.key:case Ye.targetImage.key:case Ye.targetGeoLocation.key:case Ye.splashImage.key:return Da;default:return null}}},{key:"getSelectedSceneObject",value:function(){var t=I.getSelection();if(null===t)return this.getFirstSceneObject();var e=this.accessObject(t);return e.exists()?e.type===tn.SCENE?e:nn(e.type)?this.findSceneObjectParent(e):e.type===tn.BEHAVIOR?this.findSceneObjectParent(e):(this.getLogger().error("We shouldn't ever get here"),this.accessObject(0)):e}},{key:"getFirstSceneObject",value:function(){return this.accessObject(this.getSceneRoot()).getChildren()[0]}},{key:"findSceneObjectParent",value:function(t){return null===t?null:t.exists()?t.type===tn.SCENE?t:(t=this.accessObject(t.parent),this.findSceneObjectParent(t)):null}},{key:"quick_setPropertyValue",value:function(t,e,n){var r=this.getDataGraph().getPropertyValue(t,e),a=this.cmd.setProperty(t,e,n);a.prevValue=r,a.value!==a.prevValue&&(this.getRawGraph().process(a),this.fire(B.PROPERTY_CHANGED,{provider:this,child:t,propKey:e,oldValue:r,newValue:n}))}},{key:"calculateContextMenu",value:function(t){var e=this,n=[],r=this.accessObject(t);return an(r.type)&&n.push({title:"delete",icon:ln.delete,fun:function(){return Qr(e)}}),r.type===tn.ASSETS_LIST?Jr(this):(r.type===tn.BEHAVIORS_LIST&&n.push({title:"Add Behavior from Server",enabled:F.isLoggedIn(),icon:ln.behavior_script,fun:function(){return e.showOpenBehaviorDialog()}}),rn(r.type)&&(n.push({divider:!0}),Object.keys(_e).forEach(function(t){return n.push({title:t,icon:ln[t],fun:function(){return e.add3DObject(t,r)}})})),r.type===tn.ROOT&&n.push({title:"scene",icon:ln.scene,fun:function(){return qr(e)}}),function(t){return!!nn(t)||t===tn.SCENE}(r.type)&&(n.push({divider:!0}),this.accessObject(this.getBehaviorsObject()).getChildren().filter(function(t){return t.type===tn.BEHAVIOR_SCRIPT}).forEach(function(r){n.push({title:r.title,icon:ln.behavior_script,fun:function(){return e.addBehaviorToObject(r,t)}})}),n.push({title:"Add Behavior from server",icon:ln.behavior_script,enabled:F.isLoggedIn(),fun:function(){d.b.show(a.a.createElement(la,{provider:e,onAdd:function(n){e.addBehaviorToObject(n,t).then(function(t){I.setSelection(t.id)})}}))}})),r.type===tn.SCENE&&(n.push({divider:!0}),F.scriptEditingSupported&&n.push({title:"Add Scene script",icon:ln.behavior,fun:function(){return e.addSceneScript(t)}})),r.type===tn.BEHAVIOR&&(n.push({divider:!0}),n.push({title:"view code",icon:ln.behavior,fun:function(){return I.setSelection(r.behavior)}})),an(r.type)&&(n.push({divider:!0}),n.push({title:"cut",icon:ln.cut,fun:this.cutSelection}),n.push({title:"copy",icon:ln.copy,fun:this.copySelection}),n.push({title:"paste",icon:ln.paste,fun:this.pasteSelection})),n)}},{key:"canBeMoved",value:function(t){var e=this.accessObject(t);return e.type!==tn.ROOT&&(e.type!==tn.BEHAVIORS_LIST&&e.type!==tn.ASSETS_LIST)}},{key:"canAddChild",value:function(t,e){var n=this.accessObject(t),r=this.accessObject(e);return n.type===tn.ROOT&&r.type===tn.SCENE||(!(n.type!==tn.SCENE||!nn(r.type))||(!(!nn(n.type)||r.type!==tn.BEHAVIOR)||!(!rn(n.type)||!nn(r.type))))}},{key:"canBeSibling",value:function(t,e){var n=this.accessObject(t),r=this.accessObject(e);return n.type===tn.SCENE&&r.type===tn.SCENE||!(!nn(n.type)||!nn(r.type))}},{key:"canAddExternalChild",value:function(t,e){return this.accessObject(t).type===tn.ASSETS_LIST}},{key:"acceptDrop",value:function(t,e){var n=this;this.accessObject(e).type===tn.ASSETS_LIST&&at(t.dataTransfer.files).forEach(function(t){return pn(t.type)?gn(t,n):function(t){if(!t)return!1;if(console.log("looking at the file",t,"type",t.type,"type"),!t.type||""===t.type||0===t.type.length){if(console.log("no mimetype. check extension"),t.name.toLowerCase().indexOf(".gltf")>0)return!0;if(t.name.toLowerCase().indexOf(".glb")>0)return!0}return"image/gltf"===t.type.toLowerCase()}(t)?Sn(t,n):void 0})}},{key:"requestImageCache",value:function(t){var e=this,n=new Image;return n.crossOrigin="anonymous",this.imagecache[t]=n,new Promise(function(r,a){n.src=t,n.onload=function(){e.fire(B.STRUCTURE_CHANGED,{provider:e}),r(n)}})}},{key:"createCustomEditor",value:function(t,e,n,r,o){return e.key===Ye.color.key||e.key===Ye.backgroundColor.key||e.key===Ye.borderColor.key||e.key===Ye.textColor.key||e.key===Ye.startColor.key||e.key===Ye.endColor.key?a.a.createElement(Na,{def:e,item:t,onChange:o,value:r}):"scale"===e.key?a.a.createElement(Ra,{def:e,item:t,onChange:o,provider:this}):"translation"===e.key?a.a.createElement(Ra,{def:e,item:t,onChange:o,provider:this}):"rotation"===e.key?a.a.createElement(Ra,{def:e,item:t,onChange:o,provider:this}):"behavior"===e.key?a.a.createElement("button",{onClick:function(){return I.setSelection(r)}},"view code"):a.a.createElement("i",null,"no custom editor for ",e.key)}},{key:"loadDocList",value:function(){return F.getJSON("".concat(H(),"list"))}},{key:"removeDoc",value:function(t){return F.fetch("".concat(H(),"delete/").concat(t.id),{method:"POST",body:t.id}).then(function(t){return t.json()})}},{key:"loadAssetList",value:function(){return F.getJSON("".concat(V(),"list"))}},{key:"removeAssetSource",value:function(t){return F.fetch("".concat(V(),"delete/").concat(t.id),{method:"POST",body:t.id}).then(function(t){return t.json()})}},{key:"loadScriptList",value:function(){return F.getJSON("".concat(W(),"list"))}},{key:"removeBehaviorAssetSource",value:function(t){var e="".concat(W(),"delete/").concat(t);return console.log("removing",e),F.fetch(e,{method:"POST",body:t}).then(function(t){return t.json()})}},{key:"fetchBehaviorAssetContents",value:function(t){var e=this.accessObject(t),n=W()+e.src;return F.fetch(n,{method:"GET"}).then(function(t){return t.text()})}},{key:"updateBehaviorAssetContents",value:function(t,e){if(F.supportsScriptEdit())try{var n=dn(e);n.text=e,this.setCachedBehaviorAsset(t,n);var r=this.accessObject(t),a=W()+r.src;return F.fetch(a,{method:"POST",body:e}).then(function(t){return t.json()}).then(function(t){r.set("title",t.script.title),r.set("description",t.script.description)})}catch(o){console.error("error parsing the script",o),G.add("error parsing")}}},{key:"getCachedBehaviorPropDefs",value:function(t){return this.behaviorCache[t]?this.behaviorCache[t].properties:(console.error("no parsed behavior in the cache",t),null)}},{key:"getCachedBehaviorAsset",value:function(t){return this.behaviorCache[t]}},{key:"setCachedBehaviorAsset",value:function(t,e){this.behaviorCache[t]=e}},{key:"setAudioListener",value:function(t){this.audioListener=t}},{key:"getAudioListener",value:function(){return this.audioListener}},{key:"showBadAssetsDialog",value:function(){d.b.show(a.a.createElement(Ea,{provider:this}))}}]),e}(Kt),ja=function(t){function e(t){var n;return Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this,t))).showSaveAsDialog=function(){d.b.show(a.a.createElement(Ca,{provider:n.props.provider}))},n.selectionChanged=function(){if(!I.isEmpty()){var t=n.props.provider.accessObject(I.getSelection());if(t.type===tn.BEHAVIOR_SCRIPT)return n.setState({mode:"script"});if(t.type===Ye.asset.key)return n.setState({mode:"asset"})}n.setState({mode:"canvas"})},n.toggleRunning=function(){n.setState({running:!n.state.running})},n.newDoc=function(){n.state.dirty?(console.log("can't create new becausue dirty"),d.b.show(a.a.createElement(oa,{onAnyway:function(){console.log("we are doing it anyway"),zr(n.props.provider)}}))):zr(n.props.provider)},n.showOpenDocumentDialog=function(){n.state.dirty?d.b.show(a.a.createElement(oa,{onAnyway:function(){console.log("we are doing it anyway"),n.props.provider.showOpenDocumentDialog()}})):n.props.provider.showOpenDocumentDialog()},n.state={mode:"canvas",user:null,running:!1,connected:!1,dirty:!0},n.im=new Zt,n.im.addKeyBinding({id:"save",key:Zt.KEYS.S,modifiers:[Zt.MODIFIERS.COMMAND]}),n.im.addKeyBinding({id:"undo",key:Zt.KEYS.Z,modifiers:[Zt.MODIFIERS.COMMAND]}),n.im.addKeyBinding({id:"redo",key:Zt.KEYS.Z,modifiers:[Zt.MODIFIERS.COMMAND,Zt.MODIFIERS.SHIFT]}),n.im.addListener("save",n.props.provider.save),n.im.addListener("undo",n.props.provider.performUndo),n.im.addListener("redo",n.props.provider.performRedo),n.im.addKeyBinding({id:"cut",key:Zt.KEYS.X,modifiers:[Zt.MODIFIERS.COMMAND]}),n.im.addKeyBinding({id:"copy",key:Zt.KEYS.C,modifiers:[Zt.MODIFIERS.COMMAND]}),n.im.addKeyBinding({id:"paste",key:Zt.KEYS.V,modifiers:[Zt.MODIFIERS.COMMAND]}),n.im.addListener("cut",n.props.provider.cutSelection),n.im.addListener("copy",n.props.provider.copySelection),n.im.addListener("paste",n.props.provider.pasteSelection),n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"componentDidMount",value:function(){var t=this;this.im.attachKeyEvents(document),I.on(R,this.selectionChanged),F.on(A,function(){return t.setState({user:F.getUsername()})}),F.on("CONNECTED",function(){return t.setState({connected:!0})}),F.isConnected()&&this.setState({connected:!0}),this.props.provider.on(B.CLEAR_DIRTY,function(){t.setState({dirty:!1})}),this.props.provider.on(B.PROPERTY_CHANGED,function(){t.setState({dirty:!0})}),this.props.provider.on(B.SAVED,function(){t.setState({dirty:!1})})}},{key:"componentWillUnmount",value:function(){I.off(R,this.selectionChanged)}},{key:"render",value:function(){if(!1===this.state.connected)return a.a.createElement("div",null,a.a.createElement("h1",null,"connecting to server"),a.a.createElement(d.a,null));var t=this.props.provider,e=a.a.createElement("div",null,"doc id: ",a.a.createElement("b",null,t.getDocId())),n=null;return t.pubnub&&(n=t.getLogger()),t.getDataGraph()?a.a.createElement(ka,{logger:n},a.a.createElement(D,{bottomText:e},a.a.createElement(S,{left:!0,top:!0},a.a.createElement("label",null,t.getTitle()," ",this.state.dirty?"dirty":"clean")),a.a.createElement(C,{scroll:!0,left:!0,middle:!0},a.a.createElement(ft,{root:t.getSceneRoot(),provider:t})),a.a.createElement(S,{left:!0,bottom:!0},a.a.createElement("button",{className:"fa fa-cube",onClick:function(e){return function(t,e){var n=e.getSelectedSceneObject(),r=Object.keys(_e).map(function(t){return{title:t,icon:ln[t],fun:function(){return e.add3DObject(t,n)}}});d.e.show(a.a.createElement(j,{actions:r}),t.target)}(e,t)}}),a.a.createElement("button",{className:"fa fa-globe",onClick:function(e){return qr(t)}}),a.a.createElement("button",{className:"fa fa-archive",onClick:function(e){return function(t,e){var n=Jr(e);d.e.show(a.a.createElement(j,{actions:n}),t.target)}(e,t)}}),a.a.createElement("button",{className:"fa fa-superpowers",onClick:function(e){return function(t,e){var n=[{title:"Add Behavior from Server",enabled:F.isLoggedIn(),icon:ln.behavior_script,fun:function(){return e.showOpenBehaviorDialog()}}];F.supportsScriptEdit()&&n.push({title:"custom behavior",enabled:F.isLoggedIn(),icon:ln.behavior_script,fun:function(){return e.addCustomBehaviorAsset()}}),d.e.show(a.a.createElement(j,{actions:n}),t.target)}(e,t)}})),a.a.createElement(S,{center:!0,top:!0},a.a.createElement("button",{className:"fa fa-file",onClick:this.newDoc,title:"new project"}),a.a.createElement("button",{className:"fa fa-save",onClick:function(){return t.save()},title:"save project"}),a.a.createElement("button",{className:"fa fa-clone",onClick:this.showSaveAsDialog,title:"duplicate project"}),a.a.createElement("button",{onClick:function(){return t.editIn2D()}},"2D Edit"),a.a.createElement("button",{onClick:function(){return t.editInVR()}},"AR Edit"),a.a.createElement("button",{onClick:function(){return t.viewInVR()}},"XR View"),a.a.createElement(E,null),a.a.createElement(Ta,{onClick:this.toggleRunning,active:this.state.running}),a.a.createElement(E,null),a.a.createElement("button",{className:"fa fa-cut",onClick:t.cutSelection}),a.a.createElement("button",{className:"fa fa-copy",onClick:t.copySelection}),a.a.createElement("button",{className:"fa fa-paste",onClick:t.pasteSelection}),a.a.createElement("button",{className:"fa fa-undo",onClick:t.performUndo}),a.a.createElement("button",{className:"fa fa-repeat",onClick:t.performRedo})),a.a.createElement(C,{center:!0,middle:!0,scroll:!0,transparent:!0},this.renderCenterPane(this.state.mode)),a.a.createElement(C,{scroll:!0,right:!0},a.a.createElement(et,{provider:t})),a.a.createElement(S,{right:!0,top:!0},this.renderLoginButton()),a.a.createElement(S,{right:!0,bottom:!0}),a.a.createElement(d.a,null),a.a.createElement(d.d,null))):a.a.createElement("div",null,a.a.createElement("h1",null,"connecting to server"),a.a.createElement(d.a,null))}},{key:"renderCenterPane",value:function(t){return"script"===t?a.a.createElement(pa,{provider:this.props.provider}):"canvas"===t?a.a.createElement(Pr,{provider:this.props.provider,running:this.state.running}):a.a.createElement(kn,{provider:this.props.provider,asset:I.getSelection()})}},{key:"renderLoginButton",value:function(){var t=this,e=[];return F.supportsAuth()&&(F.isLoggedIn()?e.push(a.a.createElement("button",{key:"logout",className:"fa fa-user",onClick:F.logout,title:"logout"},"logout")):e.push(a.a.createElement("button",{key:"login",className:"fa fa-user",onClick:function(){F.supportsPassword()?t.props.provider.showPasswordDialog():t.props.provider.showGithubDialog()},title:"login"}))),F.supportsDocList()&&e.push(a.a.createElement("button",{key:"open",className:"fa fa-folder-open",onClick:this.showOpenDocumentDialog,title:"open"})),e}}]),e}(r.Component),Da=function(t){var e="---";return t.value&&t.provider&&(e=t.provider.accessObject(t.value).title),t.value===$e.id&&(e=$e.title),a.a.createElement("b",null,e)},Ra=function(t){function e(t){var n;return Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this,t))).syncChanged=function(t){return n.setState({sync:!n.state.sync})},n.changed=function(t,e){var r=n.props.provider.accessObject(n.props.item),a=n.props.def.getGroupKeys(),o={};a.forEach(function(t){return o[t]=r[t]});var s=parseFloat(t.target.value);o[e]=s,n.state.sync&&a.forEach(function(t){return o[t]=s}),n.props.onChange(o)},n.state={sync:!1},n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"render",value:function(){var t=this,e=this.props.provider.accessObject(this.props.item),n=this.props.def.getGroupKeys().map(function(n){return a.a.createElement("input",{key:n,type:"number",value:e[n],onChange:function(e){t.changed(e,n)},step:.1})});return a.a.createElement(d.c,{className:"scale-editor"},a.a.createElement("input",{type:"checkbox",checked:this.state.sync,onChange:this.syncChanged}),n)}}]),e}(r.Component);function Pa(t){return t===_e.plane||t===_e.bg360||t===_e.img2d||t===_e.cube||t===_e.sphere}function Ia(t){return t===_e.plane||t===_e.bg360||t===_e.img2d}var Ta=function(t){var e=t.active?"run-button active fa fa-stop":"run-button fa fa-play";return a.a.createElement("button",{onClick:t.onClick,className:e})};function xa(t){return t.push($e.id),t}var Na=function(t){function e(){var t,n;Object(i.a)(this,e);for(var r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];return(n=Object(u.a)(this,(t=Object(p.a)(e)).call.apply(t,[this].concat(o)))).showPopup=function(t){d.e.show(a.a.createElement(Ga,{onChange:n.props.onChange,value:n.props.value}),t.target)},n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"render",value:function(){return a.a.createElement("button",{style:{backgroundColor:this.props.value},onClick:this.showPopup},this.props.value)}}]),e}(r.Component),Ga=function(t){function e(t){var n;return Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this,t))).onChange=function(t){n.setState({value:t.target.value});var e=t.target.value;e.indexOf("#")>=0&&7===e.length&&n.props.onChange(e)},n.done=function(){n.props.onChange(n.state.value),d.e.hide()},n.state={value:t.value},n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"render",value:function(){var t=this;return a.a.createElement(d.f,{style:{width:"130px",height:"100px",backgroundColor:"white"}},a.a.createElement(d.c,null,Le.map(function(e){return a.a.createElement("button",{key:e,onClick:function(){t.props.onChange(e)},style:{color:e,padding:"1px",margin:0,borderWidth:0},className:"fa fa-square"})})),a.a.createElement("input",{type:"text",value:this.state.value,onChange:this.onChange}),a.a.createElement("button",{onClick:this.done},"done"))}}]),e}(r.Component),Aa=n(45),Fa=n.n(Aa),Ba=function(t){return document.querySelector(t)};function Ua(t,e){t.find=function(e,n){return n||(n=[]),e(t)&&n.push(t),t.children&&t.children.forEach(function(t){t.find(e,n)}),n},t.exists=function(){return!0},t.getParent=function(){return e[t.parent]}}var Ha=function(t){function e(t){var n;Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this,t))).clickedStart=function(){console.log("clicked. play the sample audio"),Ba("#overlay").style.display="none",Ba("#test-audio").play();var t=n.canvas;Sr.supportsARKit()?(n.xr=new Sr,n.xr.getContext(t).then(function(e){n.initThreeJS(t,e),n.xr.setAnimationLoop(n.renderThreeWithCamera.bind(Object(m.a)(Object(m.a)(n)))),n.startScene()}).catch(function(t){console.error("Error",t)})):(n.initThreeJS(t,0),n.renderer.setAnimationLoop(n.renderThree.bind(Object(m.a)(Object(m.a)(n)))),n.startScene())},n.clickedCanvas=function(t){n.logger.log("clicked on the canvas"),n.canvas.focus();var e=n.canvas.getBoundingClientRect(),r={x:(t.clientX-e.left)/e.width*2-1,y:-(t.clientY-e.top)/e.height*2+1};n.raycaster.setFromCamera(r,n.camera);var a=n.three_map[n.current_scene.id],o=n.raycaster.intersectObjects(a.children,!0);if(o&&o.length>=1){var s=o.find(function(t){return t.distance>0});if(s){var i=function t(e){return e?e.userData.graphid?e:t(e.parent):null}(s.object),c=n.obj_map[i.userData.graphid];n.scriptManager.performClickAction(c,t)}}},n.renderThreeWithCamera=function(t,e,r,a,o){n.scene&&n.camera&&(n.camera.matrix.fromArray(r),n.camera.matrixWorldNeedsUpdate=!0,n.camera.updateMatrixWorld(),n.camera.projectionMatrix.fromArray(e),n.renderThree(a,o))},n.renderThree=function(t,e){n.tweenManager&&n.tweenManager.update(t),n.previewUpdateNodes.forEach(function(t){return t.previewUpdate()}),n.pointer&&n.pointer.tick(t),n.stats&&n.stats.update(t),n.controller&&n.controller.update(t);var r=null;n.xr&&(r=n.xr.session),n.scriptManager.tick(t,r),n.renderer.render(n.scene,n.camera)},n.state={docLoaded:!1,title:"Loading...",showErrors:!1,splashImage:null};var r=b({});if(!r.doc)throw new Error("doc not specified");return new Q(t.options),n.obj_map={},n.three_map={},n.title_map={},n.previewUpdateNodes=[],n.current_scene=null,n.root=null,n.behavior_map={},n.behavior_assets={},n.assets_url_map={},n.pendingAssets=[],n.badAssets=[],n.sceneAnchor=null,n.logger=new Nt(r.doc),n.scriptManager=new Zn(new Va(Object(m.a)(Object(m.a)(n))),n.logger),n.provider={accessObject:function(t){return n.obj_map[t]?n.obj_map[t]:{exists:function(){return!1}}},getLogger:function(){return n.logger},getAudioListener:function(){return n.audioListener}},n.assetsManager=new Sa(n.provider),n.provider.assetsManager=n.assetsManager,n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"getLogger",value:function(){return this.logger}},{key:"componentDidMount",value:function(){this.logger.log("mounted ImmersivePlayer"),this.loadDocument(),Ba("#progress").value=0}},{key:"loadDocument",value:function(){var t=this,e=b({});this.logger.log("loading assets"),this.assetsManager.cacheAssetsList().then(function(){t.logger.log("loading document"),F.getJSON(H()+e.doc).then(function(e){if(t.logger.log("loaded payload",t.root),t.root=e.graph,t.root.children.forEach(function(e){if(e.type===tn.ASSETS_LIST)return t.initAssets(e)}),t.logger.log("the title is",t.root.title),t.root.splashImage&&t.root.splashImage!==$e.id){t.logger.log("the splash image is",t.root.splashImage);var n=t.provider.accessObject(t.root.splashImage);t.logger.log("the asset is",n);var r=t.assetsManager.getAssetURL(n);t.logger.log("the url is",r),t.setState({splashImage:r})}t.setState({title:t.root.title});var a=t.root.children.find(function(t){return t.type===tn.ASSETS_LIST});t.validateAssets(a).then(function(){console.log("fully validated!"),Ba("#progress").value=100,Ba("#loading-indicator").style.display="none",t.setState({docLoaded:!0})})})})}},{key:"startScene",value:function(){var t=this;this.buildRoot(this.root),this.logger.log(this.root),Promise.all(this.pendingAssets).then(function(){if(t.logger.log("all assets loaded now. starting script manager"),t.scriptManager.startRunning(),t.root.defaultScene&&t.root.defaultScene!==$e.id){var e=t.root.children.find(function(e){return e.id===t.root.defaultScene});if(!e)return t.logger.error("cannot find the default scene");t.setCurrentScene(e)}else{var n=t.root.children[0];t.setCurrentScene(n)}t.scriptManager.startFirstScene()})}},{key:"render",value:function(){var t=this;return a.a.createElement("div",null,a.a.createElement("audio",{id:"test-audio",src:Fa.a}),a.a.createElement("div",{id:"overlay"},a.a.createElement("div",{id:"inner"},a.a.createElement("h1",{id:"title"},this.state.title),a.a.createElement("h2",null,a.a.createElement("button",{onClick:this.clickedStart,disabled:!this.state.docLoaded},"click to start")),a.a.createElement("div",{id:"loading-indicator"},a.a.createElement("label",null,"loading..."),a.a.createElement("br",null),a.a.createElement("progress",{max:"100",value:"0",id:"progress"})),this.renderSplashImage()),this.renderErrors()),a.a.createElement(ka,{logger:this.logger},a.a.createElement("canvas",{ref:function(e){return t.canvas=e},width:600,height:400,onClick:this.clickedCanvas})))}},{key:"buildRoot",value:function(t){var e=this;t.children.forEach(function(t){return Ua(t,e.obj_map),t.type===tn.SCENE?e.initObject(t):t.type===tn.BEHAVIORS_LIST?e.initBehaviors(t):void 0})}},{key:"initObject",value:function(t){var e=this;Ua(t,this.obj_map),this.obj_map[t.id]=t,t.title&&(this.title_map[t.title]=t);var n=null;if(t.type===tn.SCENE){var r=(new Hn).makeNode(t,this.provider);this.three_map[t.id]=r,r.userData.graphid=t.id,this.scenes.add(r),r.visible=!1,n=r}return t.props=function(){return t},nn(t.type)&&((n=on(t.type).makeNode(t,this.provider)).previewUpdate&&this.previewUpdateNodes.push(n),this.three_map[t.id]=n,n.userData.graphid=t.id,h(n,"click",function(n){e.scriptManager.performClickAction(t,n)})),t.type===tn.BEHAVIOR&&(this.behavior_map[t.id]=t),t.children&&t.children.forEach(function(t){var r=e.initObject(t);r&&n.add(r)}),n}},{key:"initThreeJS",value:function(t,e){var n=this;this.tweenManager=new rr,this.scene=new be.Scene,this.camera=new be.PerspectiveCamera(70,window.innerWidth/window.innerHeight,.1,50),this.renderer=new be.WebGLRenderer({antialias:!0,canvas:t,context:e}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.gammaOutput=!0,this.renderer.vr.enabled=!0,this.vrmanager=new Ir.h(this.renderer),this.audioListener=new be.AudioListener,this.camera.add(this.audioListener),this.xr||(this.scene.background=new be.Color(0)),this.camera.matrixAutoUpdate=!1,this.scene.add(this.camera),window.addEventListener("resize",function(){var t=document.documentElement;n.camera.aspect=t.clientWidth/t.clientHeight,n.camera.updateProjectionMatrix(),n.renderer.setSize(t.clientWidth,t.clientHeight)},!1);var r=new be.DirectionalLight(16777215,1);r.position.set(1,1,1).normalize(),this.scene.add(r),this.scene.add(new be.AmbientLight(16777215,.2)),this.scenes=new be.Group,this.scene.add(this.scenes),this.raycaster=new be.Raycaster}},{key:"initAssets",value:function(t){var e=this;t.children.forEach(function(t){e.logger.log("initing asset",t),Ua(t,e.obj_map),e.obj_map[t.id]=t,t.title&&(e.title_map[t.title]=t),e.assets_url_map[t.id]=t.url})}},{key:"initBehaviors",value:function(t){var e=this;t.children.forEach(function(t){if(Ua(t,e.obj_map),e.obj_map[t.id]=t,t.type===tn.BEHAVIOR_SCRIPT){var n=W()+t.src;e.logger.log("loading behavior",t,"from",n);var r=F.fetch(n,{method:"GET"}).then(function(t){return t.text()}).then(function(n){var r=dn(n);return r.text=n,e.behavior_assets[t.id]=r,n}).catch(function(t){e.logger.error("error loading behavior",t)});e.pendingAssets.push(r)}})}},{key:"setCurrentScene",value:function(t){var e=this,n=this.three_map[t.id];if(n&&this.xr){var r=n.userData.sceneAnchor;r?(r.children?(this.logger.log("scene has children: ",n.children.length),this.logger.log("scene anchor has children: ",r.children.length)):this.logger.log("no sceneNode children?"),!this.sceneAnchor||this.sceneAnchor&&t.autoRecenter?(this.sceneAnchor&&(this.xr.removeSceneAnchor(this.sceneAnchor,this.logger),this.sceneAnchor=null),this.xr.createSceneAnchor(r,this.logger).then(function(t){e.sceneAnchor=t}).catch(function(t){e.logger.error("error creating new scene anchor: ".concat(t))})):this.xr.updateAnchoredSceneNode(this.sceneAnchor,r,this.logger)):this.logger.error("no sceneNode? so no children?")}this.scenes.children.forEach(function(t){return t.visible=!1}),this.three_map[t.id]&&(this.three_map[t.id].visible=!0),this.current_scene=t}},{key:"renderSplashImage",value:function(){return this.state.splashImage?a.a.createElement("img",{src:this.state.splashImage,width:"80%",height:"auto"}):""}},{key:"validateAssets",value:function(t){var e=this;return Promise.all(t.children.map(function(t){return t.subtype===un.VIDEO?e.assetsManager.getTexture(t.id).then(function(n){n||(e.getLogger().error("error loading a texture",t),e.addAssetLoadingError(t))}):t.subtype===un.IMAGE?e.assetsManager.getTexture(t.id).then(function(n){n||(e.getLogger().error("error loading a texture",t),e.addAssetLoadingError(t))}):t.subtype===un.GLTF?e.assetsManager.getGLTF(t.id).then(function(n){n||(e.getLogger().error("error loading a model",t),e.addAssetLoadingError(t))}):Promise.resolve("all good")})).then(function(t){console.log("fully loaded all assets now"),console.log("error count is",e.badAssets.length),e.badAssets.length>0&&e.showBadAssetsDialog()})}},{key:"showBadAssetsDialog",value:function(){this.logger.log("showing a bad assets dialog"),this.setState({showErrors:!0})}},{key:"addAssetLoadingError",value:function(t){this.badAssets.push(t)}},{key:"renderErrors",value:function(){var t=this;return this.state.showErrors?a.a.createElement("div",{id:"errors-dialog"},a.a.createElement("h3",null,"Bad or Missing Assets"),a.a.createElement("ul",null,this.badAssets.map(function(t,e){return a.a.createElement("li",{key:e},a.a.createElement("b",null,t.title)," ",a.a.createElement("i",null,t.src))})),a.a.createElement("button",{onClick:function(){return t.setState({showErrors:!1})}},"dismiss")):""}}]),e}(r.Component),Va=function(t){function e(t){var n;return Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this))).player=t,n.logger=n.player.logger,n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"getCurrentScene",value:function(){return this.player.current_scene||this.logger.error("the current scene is null"),this.player.current_scene}},{key:"getSceneObjects",value:function(t){return t.children.filter(function(t){return nn(t.type)})}},{key:"getBehaviorsForObject",value:function(t){return t.children?t.children.filter(function(t){return t.type===tn.BEHAVIOR}):[]}},{key:"getThreeObject",value:function(t){if(t){if(t.id)return this.player.three_map[t.id]}else this.logger.error("getThreeObject got invalid obj");return this.player.three_map[t]}},{key:"getParsedBehaviorAsset",value:function(t){return this.player.behavior_assets[t.behavior]}},{key:"getAllBehaviors",value:function(){var t=this;return Object.keys(this.player.behavior_map).map(function(e){return t.player.behavior_map[e]})}},{key:"getAllScenes",value:function(){var t=this;return Object.keys(this.player.obj_map).map(function(e){return t.player.obj_map[e]}).filter(function(t){return t.type===tn.SCENE})}},{key:"navigateScene",value:function(t){this.logger.log("navigating to ",t);var e=this.player.obj_map[t];if(!e)return this.logger.error("couldn't find scene for",t);this.player.setCurrentScene(e)}},{key:"playMediaAsset",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.player.assetsManager.playMediaAsset(t,e)}},{key:"stopMediaAsset",value:function(t){this.player.assetsManager.stopMediaAsset(t)}},{key:"getGraphObjectByName",value:function(t){return this.player.title_map[t]}},{key:"getGraphObjectById",value:function(t){return this.player.obj_map[t]}},{key:"getCamera",value:function(){return this.player.camera}},{key:"getTweenManager",value:function(){return this.player.tweenManager}},{key:"startLocalAnchor",value:function(t){this.logger.log("starting vanilla anchor"),this.player.xr&&this.player.xr.session?"floor"==t.style?this.player.xr.createFloorAnchorFromHitTest(t,t.screenx||0,t.screeny||0,this.logger):"ray"==t.style&&this.player.xr.createLocalAnchorFromHitTest(t,t.screenx||0,t.screeny||0,this.logger):this.logger.log("XR is not active?")}},{key:"stopLocalAnchor",value:function(t){this.logger.log("stopping vanilla anchor"),this.player.xr&&this.player.xr.session?this.player.xr.stopLocalAnchor(t,this.logger):this.logger.log("XR is not active?")}},{key:"startImageRecognizer",value:function(t){var e=this;return this.logger.log("starting the image recognizer"),new Promise(function(n,r){e.player.xr&&e.player.xr.session?e.player.xr.createDetectionImage(t,e.logger).then(function(n){e.player.xr.startImageRecognizer(t,n,e.logger)}):e.logger.log("XR is not active?")})}},{key:"stopImageRecognizer",value:function(t){this.logger.log("stopping the image recognizer"),this.player.xr&&this.player.xr.session?this.player.xr.stopImageRecognizer(t,this.logger):this.logger.log("XR is not active?")}},{key:"startGeoTracker",value:function(t){var e=this;return new Promise(function(n,r){e.player.xr&&e.player.xr.session?e.player.xr.createGeoAnchor(t,e.logger).then(function(){e.player.xr.addGeoAnchoredNode(t,e.logger)}):e.logger.log("XR is not active?")})}},{key:"stopGeoTracker",value:function(t){this.player.xr&&this.player.xr.session?this.player.xr.stopGeoTracker(t,this.logger):this.logger.log("XR is not active?")}},{key:"startWorldInfo",value:function(t){this.player.xr&&this.player.xr.session?(this.stopWorldInfo(t),this.worldInfoMesh=this.player.xr.startWorldInfo(this.logger),this.player.scene.add(this.worldInfoMesh)):this.logger.log("XR is not active?")}},{key:"stopWorldInfo",value:function(t){this.player.xr&&this.player.xr.session?this.worldInfoMesh&&(this.player.scene.remove(this.worldInfoMesh),this.worldInfoMesh=0,this.player.xr.stopWorldInfo()):this.logger.log("XR is not active?")}}]),e}(Wn),Wa=function(t){function e(t){var n;Object(i.a)(this,e),(n=Object(u.a)(this,Object(p.a)(e).call(this,t))).showProviderList=function(t){d.e.show(a.a.createElement(d.f,null,n.providers.map(function(t){return a.a.createElement("button",{key:t,onClick:function(){return n.openNewProvider(t)}},t)})),t.target)},n.state={switcher:!1},n.providers=["vr","metadoc"];var r=n.props.options.switcher;return"undefined"===typeof r||!0!==r&&"true"!==r||(n.state.switcher=!0),n}return Object(l.a)(e,t),Object(c.a)(e,[{key:"getApp",value:function(){var t=this.props.options.doctype||"vr";return"vr"===t?"play"===this.props.options.mode?a.a.createElement(Ha,{options:this.props.options}):(this.provider=new Ma(this.props.options),this.provider.getApp()):"metadoc"===t?(this.provider=new xn(this.props.options),this.provider.getApp()):void 0}},{key:"openNewProvider",value:function(t){d.e.hide(),window.open("./?mode=edit&doctype=".concat(t))}},{key:"render",value:function(){return this.state.switcher?a.a.createElement(d.f,{fill:!0},a.a.createElement("button",{style:{position:"absolute",zIndex:10},onClick:this.showProviderList},a.a.createElement("img",{src:"icon.png",alt:"switch apps",height:"20",style:{padding:"0em"}})),a.a.createElement("div",{style:{position:"relative",flex:"1"}},this.getApp()),a.a.createElement(d.a,null),a.a.createElement(d.d,null)):this.getApp()}}]),e}(r.Component),Ka=b({mode:"edit"});console.log("options is",Ka),s.a.render(a.a.createElement(Wa,{options:Ka}),document.getElementById("root"))}},[[47,2,1]]]);
//# sourceMappingURL=main.117bc591.chunk.js.map