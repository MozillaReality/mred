(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{112:function(e,t,r){},114:function(e,t,r){"use strict";r.r(t);var n=r(0),i=r.n(n),a=r(39),s=r.n(a),o=(r(51),r(53),r(3)),c=r(4),u=r(6),l=r(5),h=r(7),p=r(11),d=r(9),f=r(22),v=f.SET_PROPERTY,m=f.CREATE_PROPERTY,y=f.DELETE_PROPERTY,g=f.CREATE_OBJECT,b=f.DELETE_OBJECT,w=f.INSERT_ELEMENT,O=f.DELETE_ELEMENT,k=function(){function e(t){Object(o.a)(this,e),this.graph=t,this.history=[],this.current=-1}return Object(c.a)(e,[{key:"submit",value:function(e){this.history.push(e),this.current=this.history.length-1}},{key:"canUndo",value:function(){return this.current>=0}},{key:"canRedo",value:function(){return this.current<this.history.length-1}},{key:"undo",value:function(){var e=this.history[this.current];if(this.current--,e.type!==v)if(e.type!==m)if(e.type!==g){if(e.type!==w)throw new Error("undo for type not supported: ".concat(e.type));var t={type:O,host:this.graph.getHostId(),seq:this.graph.nextSeq(),timestamp:Date.now(),array:e.array,entry:e.entryid};this.graph.process(t)}else{var r={type:b,host:this.graph.getHostId(),seq:this.graph.nextSeq(),timestamp:Date.now(),id:e.id};this.graph.process(r)}else{var n={type:y,host:this.graph.getHostId(),seq:this.graph.nextSeq(),timestamp:Date.now(),object:e.object,name:e.name};this.graph.process(n)}else{if(!e.prevValue)return void console.warn("undoing set property without a previous value!",e);var i={type:v,host:this.graph.getHostId(),seq:this.graph.nextSeq(),timestamp:Date.now(),object:e.object,name:e.name,value:e.prevValue};this.graph.process(i)}}},{key:"redo",value:function(){this.current++;var e=this.history[this.current];if(e.type!==v)if(e.type!==m)if(e.type!==g){if(e.type!==w)throw new Error("redo for type not supported: ".concat(e.type));console.log("redoing",e);var t={type:e.type,host:e.host,seq:this.graph.nextSeq(),timestamp:Date.now(),array:e.array,value:e.value,entryid:this.graph.makeGUID(),prev:-1};this.graph.process(t)}else{var r={type:e.type,host:e.host,seq:this.graph.nextSeq(),timestamp:Date.now(),id:e.id};this.graph.process(r)}else{var n={type:e.type,host:e.host,seq:this.graph.nextSeq(),timestamp:Date.now(),object:e.object,name:e.name,value:e.value};this.graph.process(n)}else{var i={type:e.type,host:e.host,seq:this.graph.nextSeq(),timestamp:Date.now(),object:e.object,name:e.name,value:e.value};this.graph.process(i)}}},{key:"dump",value:function(){return this.history.map(function(e,t){return t+" "+e.type+" "+e.name+" => "+e.value})}}]),e}(),A=r(22).SET_PROPERTY,S=function(){function e(t){var r=this;Object(o.a)(this,e),this.onChange=function(e){return r.listeners.push(e)},this.onRawChange=function(e){return r.rawlisteners.push(e)},this.fire=function(e){return r.listeners.forEach(function(t){return t(e)})},this.fireRaw=function(e){return r.rawlisteners.forEach(function(t){return t(e)})},this.getPropertiesForObject=function(e){return r.graph.getPropertiesForObject(e)},this.getArrayLength=function(e){return r.graph.getArrayLength(e)},this.getElementAt=function(e,t){return r.graph.getElementAt(e,t)},this.getHostId=function(){return r.graph.getHostId()},this.graph=t,this.listeners=[],this.rawlisteners=[],this.paused=!1,this.buffer=[],this.first={},this.last={}}return Object(c.a)(e,[{key:"pause",value:function(){this.paused=!0}},{key:"unpause",value:function(){var e=this;this.paused=!1,this.buffer=[],Object.keys(this.last).forEach(function(t){Object.keys(e.last[t]).forEach(function(r){var n=e.last[t][r];n.prevValue=e.first[t][r].value,e.fire(n),e.graph.process(n)})}),this.first={},this.last={}}},{key:"getPropertyValue",value:function(e,t){return this.paused&&this.last[e]&&this.last[e][t]?this.last[e][t].value:this.graph.getPropertyValue(e,t)}},{key:"bufferOp",value:function(e){this.first[e.object]||(this.first[e.object]={}),this.first[e.object][e.name]||(this.first[e.object][e.name]=e),this.last[e.object]||(this.last[e.object]={}),this.last[e.object][e.name]=e,this.buffer.push(e),this.fireRaw(e)}},{key:"process",value:function(e){e.type===A&&this.paused?this.bufferOp(e):(this.fire(e),this.graph.process(e))}}]),e}(),x=r(2),M=r(28),C=r.n(M),j=r(13),E="USER_CHANGE",P=new(function(){function e(){var t=this;Object(o.a)(this,e),this.login=function(e){t.win=window.open(e.url,"_blank"),window.addEventListener("message",t.authCallback),t.win&&t.win.focus()},this.logout=function(){localStorage.clear(),t.doclistSupported=!1,t.fire(E)},this.authCallback=function(e){t.setUserData(e.data.payload),t.win.close(),window.removeEventListener("message",t.authCallback),t.doclistSupported=!0,t.fire(E),j.add("login succeeded")},this.listeners={},this.supported=!1,this.doclistSupported=!1,this.docDeleteSupported=!1,this.assetUploadSupported=!1,this.scriptEditingSupported=!1,this.passwordSupported=!1,this.connected=!1,this.serverID=Object(x.n)("serverid")}return Object(c.a)(e,[{key:"on",value:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}},{key:"fire",value:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].forEach(function(e){return e(t)})}},{key:"init",value:function(){var e=this;this.isLoggedIn()&&(this.doclistSupported=!0),fetch(Object(x.q)()).then(function(e){return e.json()}).then(function(t){console.info("Server Info:",t),!0===t.authentication&&(e.supported=!0),!0===t.passwordSupported&&(e.passwordSupported=!0),!0===t.assetUpload&&(e.assetUploadSupported=!0),!0===t.scriptEditing&&(e.scriptEditingSupported=!0),!0===t.docDeleteSupported&&(e.docDeleteSupported=!0),e.serverID=Object(x.q)().replace(/[.:\/]/g,""),e.getJSON(Object(x.t)()).then(function(t){t.success?(e.fire(E),e.doclistSupported=!0):e.logout(),e.connected=!0,e.fire("CONNECTED")}).then(function(){e.connected=!0,e.fire("CONNECTED")})})}},{key:"isConnected",value:function(){return this.connected}},{key:"isLoggedIn",value:function(){return!!localStorage.getItem("access-token")}},{key:"supportsPassword",value:function(){return this.passwordSupported}},{key:"supportsAuth",value:function(){return this.supported}},{key:"supportsDocList",value:function(){return this.doclistSupported}},{key:"supportsAssetUpload",value:function(){return this.assetUploadSupported}},{key:"supportsScriptEdit",value:function(){return this.scriptEditingSupported}},{key:"supportsDocDelete",value:function(){return this.docDeleteSupported}},{key:"doPasswordLogin",value:function(e){var t=this;return localStorage.setItem("access-token",e),this.getJSON(Object(x.t)()).then(function(e){!0===e.success?(console.log("the logged in response is",e),t.doclistSupported=!0,j.add("login succeeded"),t.fire(E)):(j.add("login failed"),localStorage.clear(),t.doclistSupported=!1,t.fire(E))})}},{key:"setUserData",value:function(e){localStorage.setItem("access-token",e.accessToken)}},{key:"getAccessToken",value:function(){return localStorage.getItem("access-token")}},{key:"getUsername",value:function(){return this.getAccessToken()}},{key:"getServerID",value:function(){return this.serverID}},{key:"fetch",value:function(e){function t(t,r){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e,t){return t.mode="cors",t.cache="no-cache",t.headers||(t.headers={}),t.headers["access-key"]=P.getAccessToken(),console.log("fetching",e,"with options",t),fetch(e,t).then(function(e){if(404===e.status)throw new Error(e.statusText+" "+e.url);return e})})},{key:"getJSON",value:function(e){return this.fetch(e,{method:"GET",headers:{"Content-Type":"application/json"}}).then(function(e){return e.json()})}},{key:"uploadFile",value:function(e){var t=Object(x.o)()+e.name;return this.fetch(t,{method:"POST",body:e}).then(function(e){return e.json()})}}]),e}()),D=r(41),R=r.n(D);var L={publishKey:"pub-c-1cba58da-c59a-4b8b-b756-09e9b33b1edd",subscribeKey:"sub-c-39263f3a-f6fb-11e7-847e-5ef6eb1f4733"},I=function(){function e(t,r){var n=this;if(Object(o.a)(this,e),!t)throw new Error("created PubnubSyncWrapper without a provider");if(!r)throw new Error("created PubnubSyncWrapper without a graph");this.paused=!1,this.buffer=[],this.provider=t,r.onChange(function(e){return n.handleGraphChange(e)}),this.pubnub=new C.a(L),this.logger=new T(this.provider.getDocId(),this.pubnub)}return Object(c.a)(e,[{key:"calculateChannelName",value:function(){return"metadoc-docupdate-"+this.provider.getDocId()+"_"+P.getServerID()}},{key:"calculateLoggerChannelName",value:function(){return"metadoc-log-"+this.provider.getDocId()+"_"+P.getServerID()}},{key:"start",value:function(){var e=this;this.pubnub.addListener({status:function(t){"PNSubscribeOperation"===t.operation&&"PNConnectedCategory"===t.category&&e.sendHistoryRequest()},message:function(t){return e.handleMessage(t)}}),this.pubnub.subscribe({channels:[this.calculateChannelName(),this.calculateLoggerChannelName()]})}},{key:"pause",value:function(){this.paused=!0}},{key:"unpause",value:function(){var e=this;this.paused=!1,this.buffer.forEach(function(t){return e.sendMessage(t)}),this.buffer=[]}},{key:"shutdown",value:function(){this.pubnub.unsubscribe({channels:[this.calculateChannelName()]}),this.pubnub.stop()}},{key:"sendMessage",value:function(e){var t,r;console.log("PN_SEND:",(r="".concat((t=e).type," ").concat(t.uuid," |  "),t.name&&(r+="".concat(t.name," = ").concat(t.value,"  prev = ").concat(t.prevValue)),r)),this.pubnub.publish({channel:this.calculateChannelName(),message:e},function(e,t){})}},{key:"handleGraphChange",value:function(e){var t=this.provider.getDataGraph().getHostId();if(e.host===t)return this.paused?this.buffer.push(e):void this.sendMessage(e)}},{key:"sendHistoryRequest",value:function(){this.pubnub.publish({channel:this.calculateChannelName(),message:{type:"GET_HISTORY",host:this.provider.getDataGraph().getHostId()}})}},{key:"handleGetHistory",value:function(){var e=this.provider.getDataGraph(),t=e.getHistory().slice();console.log(t);for(var r=0;t.length>0;){if(r>100){console.log("breaking out. possible infinite loop");break}r++;var n=t.splice(0,30);console.log("sending",n.length,n),this.pubnub.publish({channel:this.calculateChannelName(),message:{type:"SEND_HISTORY",host:e.getHostId(),history:n}},function(e,t){console.log("published",e,t)})}}},{key:"handleReceiveHistory",value:function(e){var t=this;e.history.forEach(function(e){return t.provider.getDataGraph().process(e)})}},{key:"handleMessage",value:function(e){if(!this.paused){if(e.channel===this.calculateLoggerChannelName())return e.publisher,void this.pubnub.getUUID();var t=this.provider.getDataGraph();if("GET_HISTORY"===e.message.type)return e.message.host!==t.getHostId()?this.handleGetHistory():void 0;if("SEND_HISTORY"===e.message.type)return e.message.host!==t.getHostId()?this.handleReceiveHistory(e.message):void 0;var r=e.message;return r.host?r.timestamp?void(r.host&&r.host===t.getHostId()||(console.log("REMOTE",r),t.process(r))):console.error("received a message without a timestamp",r):console.log("received a message without a host",r)}}},{key:"getLogger",value:function(){return this.logger}}]),e}(),T=function(){function e(t,r){var n=this;Object(o.a)(this,e),this.count=0,this.docid=t,this.listeners={},this.pubnub=r||new C.a(L),this.pubnub.addListener({message:function(e){if(e.publisher!==n.pubnub.getUUID()){var t=e.message;t.remote=!0,n.getListeners(t.type).forEach(function(e){return e(t)})}}}),this.pubnub.subscribe({channels:[this.calculateLoggerChannelName()]})}return Object(c.a)(e,[{key:"addEventListener",value:function(e,t){this.getListeners(e).push(t)}},{key:"calculateLoggerChannelName",value:function(){return"metadoc-log-"+this.docid+"_"+P.getServerID()}},{key:"log",value:function(){this.fire("log",this.makePayload(Array.from(arguments)))}},{key:"error",value:function(){this.fire("error",this.makePayload(Array.from(arguments)))}},{key:"getListeners",value:function(e){return this.listeners||(this.listeners={}),this.listeners[e]||(this.listeners[e]=[]),this.listeners[e]}},{key:"fire",value:function(e,t){t.type=e,this.pubnub.publish({channel:this.calculateLoggerChannelName(),message:JSON.parse(R()(t))}),this.getListeners(e).forEach(function(e){return e(t)})}},{key:"makePayload",value:function(e){return{data:e,count:this.count++}}}]),e}(),N=function(){function e(){Object(o.a)(this,e),this.listeners={},this.count=0}return Object(c.a)(e,[{key:"addEventListener",value:function(e,t){this.getListeners(e).push(t)}},{key:"getListeners",value:function(e){return this.listeners||(this.listeners={}),this.listeners[e]||(this.listeners[e]=[]),this.listeners[e]}},{key:"fire",value:function(e,t){t.type=e,this.getListeners(e).forEach(function(e){return e(t)})}},{key:"log",value:function(){this.fire("log",this.makePayload(Array.from(arguments)))}},{key:"error",value:function(){this.fire("error",this.makePayload(Array.from(arguments)))}},{key:"makePayload",value:function(e){return{data:e,count:this.count++}}}]),e}();function G(e){return Array.prototype.slice.call(e)}function B(e,t){var r={};return e.getPropertiesForObject(t).forEach(function(n){r[n]=e.getPropertyValue(t,n)}),r.id=t,r}function F(e,t){for(var r=e.getArrayLength(t),n=[],i=0;i<r;i++)n.push(e.getElementAt(t,i));return n}function U(e,t,r){e.setProperty(r.id,"parent",t.id);var n=e.getPropertyValue(t.id,"children");e.insertAfter(n,null,r.id)}function z(e,t,r){e.setProperty(r.id,"parent",t.id);var n=e.getPropertyValue(t.id,"children"),i=e.getArrayLength(n),a=e.getElementAt(n,i-1);e.insertAfter(n,a,r.id)}var H=r(8),W=function(e){function t(){var e,r;Object(o.a)(this,t);for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return(r=Object(u.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(i)))).cancel=function(){H.b.hide()},r.okay=function(){H.b.hide(),r.props.provider.createNewDocument(r.props.docid)},r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){return i.a.createElement(x.a,{visible:!0,onScrimClick:this.cancel},i.a.createElement("header",null,'Document "',i.a.createElement("b",null,this.props.docid),'" not found'),i.a.createElement("section",null,"Create a new document?"),i.a.createElement("footer",null,i.a.createElement("button",{onClick:this.cancel},"cancel"),i.a.createElement("button",{onClick:this.okay},"okay")))}}]),t}(n.Component),V=r(22),Y=V.DocGraph,X=V.CommandGenerator,Z=V.toDocGraphFromObjectGraph,K=V.toObjectGraphFromDocGraph,q=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).getDocTitle=function(){return"untitled"},r.getDocHistory=function(){return r.getDataGraph().getHistory()},r.getDocGraph=function(){var e=r.getDataGraph().getObjectByProperty("type","root");return K(r.getDataGraph(),e)},r.onRawChange=function(e){return r.rawlisteners.push(e)},r.getRawGraph=function(){return r.coalescer},r.getDataGraph=function(){return r.syncdoc},r.getSceneRoot=function(){return r.getDataGraph().getObjectByProperty("type","root")},r.hasChildren=function(e){return e&&r.getDataGraph().hasPropertyValue(e,"children")},r.getChildren=function(e){var t=r.getDataGraph();return F(t,t.getPropertyValue(e,"children"))},r.isExpanded=function(e){return"undefined"===typeof r.expanded[e]&&(r.expanded[e]=!0),r.expanded[e]},r.save=function(e){e&&e.preventDefault();var t={history:r.getDocHistory(),type:r.getDocType(),id:r.getDocId(),graph:r.getDocGraph(),title:r.getDocTitle()},n=JSON.stringify(t);j.add("saving");var i={type:r.getDocType(),title:r.getDocTitle()},a=Object(x.p)()+r.getDocId()+"?"+Object(x.x)(i);return console.log("saving ".concat(n.length," chars to ").concat(a),t),P.fetch(a,{method:"POST",body:n,headers:{"Content-Type":"application/json"}}).then(function(e){return e.json()}).then(function(e){console.log("got back result",e),Object(x.w)({mode:r.mode,doc:r.getDocId(),doctype:r.getDocType()}),j.add(e.message),r.fire(x.j.SAVED,!0)}).catch(function(e){return console.log("error",e)})},r.docLoaded=function(){return Promise.resolve()},r.toggleConnected=function(){r.connected=!r.connected,r.pubnub&&(r.connected?r.pubnub.unpause():r.pubnub.pause()),r.fire("CONNECTED",r.connected)},r.isConnected=function(){return r.connected},r.pauseQueue=function(){return r.coalescer.pause()},r.unpauseQueue=function(){return r.coalescer.unpause()},r.performUndo=function(e){e&&e.preventDefault&&e.preventDefault(),r.undoqueue.canUndo()?r.undoqueue.undo():console.warn("at beginnning of the undo queue")},r.performRedo=function(e){e&&e.preventDefault&&e.preventDefault(),r.undoqueue.canRedo()&&r.undoqueue.redo()},r.options=e||{},r.mode=e.mode||"edit",r.datalisteners=[],r.rawlisteners=[],r.expanded={},e.doc?r.loadDoc(e.doc):r.createNewDocument(),r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"toggleItemCollapsed",value:function(e){var t=this.isExpanded(e);this.expanded[e]=!t,this.fire(x.j.EXPANDED_CHANGED,e)}},{key:"setPropertyValue",value:function(e,t,r){var n=this.cmd.setProperty(e,t.key,r);n.prevValue=t.value,this.getRawGraph().process(n),this.fire(x.j.PROPERTY_CHANGED,{provider:this,child:e,propKey:t.key,oldValue:t.value,newValue:r})}},{key:"loadDoc",value:function(e){var t=this;return P.getJSON(Object(x.p)()+e).then(function(r){if(console.log("got the payload",r),!r.id)return t.showMissingDocDialog(e);var n=t.makeDocFromServerHistory(r.history);return t.setupDocFlow(n,e)}).catch(function(r){return console.error("there was an error loading doc",e,r),console.log("trying to load again without the history"),P.getJSON(Object(x.p)()+e).then(function(r){console.log("got the payload",r);var n=t.makeDocFromServerGraph(r.graph);return t.setupDocFlow(n,e)})}).catch(function(r){console.error("there was an error loading doc",e,r);var n=new Y;t.makeEmptyRoot(n),t.setupDocFlow(n,t.genID("doc"))})}},{key:"createNewDocument",value:function(e){e||(e=this.genID("doc"));var t=new Y;this.makeEmptyRoot(t),this.setupDocFlow(t,e)}},{key:"setupDocFlow",value:function(e,t){var r=this;return this.pubnub&&this.pubnub.shutdown(),this.pubnub=null,this.syncdoc=e,this.cmd=new X(this.syncdoc),this.root=this.getSceneRoot(),this.docid=t,this.undoqueue=new k(e),this.coalescer=new S(this.syncdoc),this.coalescer.onChange(function(e){return r.undoqueue.submit(e)}),this.coalescer.onRawChange(function(e){return r.rawlisteners.forEach(function(t){return t(e)})}),this.syncdoc.onChange(function(e){return r.rawlisteners.forEach(function(t){return t(e)})}),this.syncdoc.onChange(function(e){r.fire(x.j.STRUCTURE_CHANGED,{provider:r}),r.fire(x.j.PROPERTY_CHANGED,{provider:r})}),this.fire(x.j.STRUCTURE_CHANGED,{provider:this}),this.fire(x.j.CLEAR_DIRTY,!0),x.h.clearSelection(),this.pubnub=new I(this,this.syncdoc),this.pubnub.unpause(),this.pubnub.start(),this.docLoaded().then(function(){r.fire(x.j.DOCUMENT_SWAPPED,{provider:r}),Object(x.w)({mode:r.mode,doc:r.getDocId(),doctype:r.getDocType()}),r.connected=!0,r.fire("CONNECTED",r.connected)})}},{key:"reloadDocument",value:function(){var e=this;return P.getJSON(Object(x.p)()+this.docid).then(function(t){if(t.type!==e.getDocType())throw new Error("incorrect doctype for this provider",t.type);var r=e.makeDocFromServerHistory(t.history);e.setupDocFlow(r,e.docid)}).catch(function(t){console.error("couldn't reload the doc",t);var r=new Y;e.makeEmptyRoot(r),e.setupDocFlow(r,e.genID("doc"))})}},{key:"duplicateDocument",value:function(e){var t=this,r=this.genID("doc");this.save().then(function(){t.docid=r,t.setDocTitle(e);var n=t.getDocGraph(),i=new Y;return Z(n,i),t.syncdoc=i,t.save()}).then(function(){return j.add("duplicating doc"),t.loadDoc(r)})}},{key:"makeDocFromServerHistory",value:function(e){var t=new Y;return e.forEach(function(e){return t.process(e)}),t}},{key:"showMissingDocDialog",value:function(e){H.b.show(i.a.createElement(W,{docid:e,provider:this}))}},{key:"makeDocFromServerGraph",value:function(e){console.log("Making Doc from Server Graph",e);var t=new Y;return Z(e,t),t}}]),t}(x.l),Q=r(1),J=r(1),$=function(e,t){J.Object3D.call(this),t=void 0!==t?t:document,this.visible=!1;var r=new _;this.add(r);var n=new ee;this.add(n);var i=this;N("camera",e),N("object",void 0),N("enabled",!0),N("axis",null),N("mode","translate"),N("translationSnap",null),N("rotationSnap",null),N("space","world"),N("size",1),N("dragging",!1),N("showX",!0),N("showY",!0),N("showZ",!0);var a={type:"change"},s={type:"mouseDown"},o={type:"mouseUp",mode:i.mode},c={type:"objectChange"},u=new J.Raycaster,l=new J.Vector3,h=new J.Vector3,p=new J.Quaternion,d={X:new J.Vector3(1,0,0),Y:new J.Vector3(0,1,0),Z:new J.Vector3(0,0,1)},f=new J.Quaternion,v=new J.Vector3,m=new J.Vector3,y=new J.Vector3,g=new J.Vector3,b=0,w=new J.Vector3,O=new J.Quaternion,k=new J.Vector3,A=new J.Vector3,S=new J.Quaternion,x=new J.Vector3,M=new J.Vector3,C=new J.Quaternion,j=new J.Vector3,E=new J.Vector3,P=new J.Quaternion,D=new J.Vector3,R=new J.Vector3,L=new J.Vector3,I=new J.Quaternion,T=new J.Vector3;function N(e,t){var s=t;Object.defineProperty(i,e,{get:function(){return void 0!==s?s:t},set:function(t){s!==t&&(s=t,n[e]=t,r[e]=t,i.dispatchEvent({type:e+"-changed",value:t}),i.dispatchEvent(a))}}),i[e]=t,n[e]=t,r[e]=t}function G(e){var r=e.changedTouches?e.changedTouches[0]:e,n=t.getBoundingClientRect();return{x:(r.clientX-n.left)/n.width*2-1,y:-(r.clientY-n.top)/n.height*2+1,button:e.button}}function B(e){e.preventDefault()}function F(e){i.enabled&&i.pointerHover(G(e))}function U(e){i.enabled&&(e.preventDefault(),document.addEventListener("mousemove",z,!1),i.pointerHover(G(e)),i.pointerDown(G(e)))}function z(e){i.enabled&&(e.preventDefault(),i.pointerMove(G(e)))}function H(e){i.enabled&&(e.preventDefault(),document.removeEventListener("mousemove",z,!1),i.pointerUp(G(e)))}N("parentQuaternion",S),N("worldPosition",E),N("worldPositionStart",M),N("worldQuaternion",P),N("worldQuaternionStart",C),N("cameraPosition",w),N("cameraQuaternion",O),N("pointStart",m),N("pointEnd",y),N("rotationAxis",g),N("rotationAngle",b),N("eye",R),t.addEventListener("mousedown",U,!1),t.addEventListener("touchstart",U,!1),t.addEventListener("mousemove",F,!1),t.addEventListener("touchmove",F,!1),t.addEventListener("touchmove",z,!1),document.addEventListener("mouseup",H,!1),t.addEventListener("touchend",H,!1),t.addEventListener("touchcancel",H,!1),t.addEventListener("touchleave",H,!1),t.addEventListener("contextmenu",B,!1),this.dispose=function(){t.removeEventListener("mousedown",U),t.removeEventListener("touchstart",U),t.removeEventListener("mousemove",F),t.removeEventListener("touchmove",F),t.removeEventListener("touchmove",z),document.removeEventListener("mouseup",H),t.removeEventListener("touchend",H),t.removeEventListener("touchcancel",H),t.removeEventListener("touchleave",H),t.removeEventListener("contextmenu",B)},this.attach=function(e){this.object=e,this.visible=!0},this.detach=function(){this.object=void 0,this.visible=!1,this.axis=null},this.updateMatrixWorld=function(){void 0!==this.object&&(this.object.updateMatrixWorld(),this.object.parent.matrixWorld.decompose(A,S,x),this.object.matrixWorld.decompose(E,P,D)),this.camera.updateMatrixWorld(),this.camera.matrixWorld.decompose(w,O,k),this.camera instanceof J.PerspectiveCamera?R.copy(w).sub(E).normalize():this.camera instanceof J.OrthographicCamera&&R.copy(w).normalize(),J.Object3D.prototype.updateMatrixWorld.call(this)},this.pointerHover=function(e){if(void 0!==this.object&&!0!==this.dragging&&(void 0===e.button||0===e.button)){u.setFromCamera(e,this.camera);var t=u.intersectObjects(r.picker[this.mode].children,!0)[0]||!1;this.axis=t?t.object.name:null}},this.pointerDown=function(e){if(void 0!==this.object&&!0!==this.dragging&&(void 0===e.button||0===e.button)&&(0===e.button||void 0===e.button)&&null!==this.axis){u.setFromCamera(e,this.camera);var t=u.intersectObjects([n],!0)[0]||!1;if(t){var r=this.space;if("scale"===this.mode?r="local":"E"!==this.axis&&"XYZE"!==this.axis&&"XYZ"!==this.axis||(r="world"),"local"===r&&"rotate"===this.mode){var i=this.rotationSnap;"X"===this.axis&&i&&(this.object.rotation.x=Math.round(this.object.rotation.x/i)*i),"Y"===this.axis&&i&&(this.object.rotation.y=Math.round(this.object.rotation.y/i)*i),"Z"===this.axis&&i&&(this.object.rotation.z=Math.round(this.object.rotation.z/i)*i)}this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),L.copy(this.object.position),I.copy(this.object.quaternion),T.copy(this.object.scale),this.object.matrixWorld.decompose(M,C,j),m.copy(t.point).sub(M),"local"===r&&m.applyQuaternion(C.clone().inverse())}this.dragging=!0,s.mode=this.mode,this.dispatchEvent(s)}},this.pointerMove=function(e){var t=this.axis,r=this.mode,i=this.object,s=this.space;if("scale"===r?s="local":"E"!==t&&"XYZE"!==t&&"XYZ"!==t||(s="world"),void 0!==i&&null!==t&&!1!==this.dragging&&(void 0===e.button||0===e.button)){u.setFromCamera(e,this.camera);var o=u.intersectObjects([n],!0)[0]||!1;if(!1!==o){if(y.copy(o.point).sub(M),"local"===s&&y.applyQuaternion(C.clone().inverse()),"translate"===r)-1===t.search("X")&&(y.x=m.x),-1===t.search("Y")&&(y.y=m.y),-1===t.search("Z")&&(y.z=m.z),"local"===s?i.position.copy(y).sub(m).applyQuaternion(I):i.position.copy(y).sub(m),i.position.add(L),this.translationSnap&&("local"===s&&(i.position.applyQuaternion(p.copy(I).inverse()),-1!==t.search("X")&&(i.position.x=Math.round(i.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(i.position.y=Math.round(i.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(i.position.z=Math.round(i.position.z/this.translationSnap)*this.translationSnap),i.position.applyQuaternion(I)),"world"===s&&(i.parent&&i.position.add(l.setFromMatrixPosition(i.parent.matrixWorld)),-1!==t.search("X")&&(i.position.x=Math.round(i.position.x/this.translationSnap)*this.translationSnap),-1!==t.search("Y")&&(i.position.y=Math.round(i.position.y/this.translationSnap)*this.translationSnap),-1!==t.search("Z")&&(i.position.z=Math.round(i.position.z/this.translationSnap)*this.translationSnap),i.parent&&i.position.sub(l.setFromMatrixPosition(i.parent.matrixWorld))));else if("scale"===r){if(-1!==t.search("XYZ")){var w=y.length()/m.length();y.dot(m)<0&&(w*=-1),l.set(w,w,w)}else l.copy(y).divide(m),-1===t.search("X")&&(l.x=1),-1===t.search("Y")&&(l.y=1),-1===t.search("Z")&&(l.z=1);i.scale.copy(T).multiply(l)}else if("rotate"===r){var O=20/E.distanceTo(l.setFromMatrixPosition(this.camera.matrixWorld)),k="local"===this.space?P:f,A=d[t];"E"===t?(l.copy(y).cross(m),g.copy(R),b=y.angleTo(m)*(l.dot(R)<0?1:-1)):"XYZE"===t?(l.copy(y).sub(m).cross(R).normalize(),g.copy(l),b=y.sub(m).dot(l.cross(R))*O):"X"!==t&&"Y"!==t&&"Z"!==t||(v.copy(A).applyQuaternion(k),g.copy(A),l=A.clone(),h=y.clone().sub(m),"local"===s&&(l.applyQuaternion(k),h.applyQuaternion(C)),b=h.dot(l.cross(R).normalize())*O),this.rotationSnap&&(b=Math.round(b/this.rotationSnap)*this.rotationSnap),this.rotationAngle=b,"local"===s?(i.quaternion.copy(I),i.quaternion.multiply(p.setFromAxisAngle(g,b))):(i.quaternion.copy(p.setFromAxisAngle(g,b)),i.quaternion.multiply(I))}this.dispatchEvent(a),this.dispatchEvent(c)}}},this.pointerUp=function(e){void 0!==e.button&&0!==e.button||(this.dragging&&null!==this.axis&&(o.mode=this.mode,this.dispatchEvent(o)),this.dragging=!1,void 0===e.button&&(this.axis=null))},this.getMode=function(){return i.mode},this.setMode=function(e){i.mode=e},this.setTranslationSnap=function(e){i.translationSnap=e},this.setRotationSnap=function(e){i.rotationSnap=e},this.setSize=function(e){i.size=e},this.setSpace=function(e){i.space=e},this.update=function(){console.warn("TransformControls: update function has been depricated.")}};$.prototype=Object.assign(Object.create(J.Object3D.prototype),{constructor:$,isTransformControls:!0});var _=function(){J.Object3D.call(this),this.type="TransformControlsGizmo";var e=new J.MeshBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,side:J.DoubleSide,fog:!1}),t=new J.LineBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,linewidth:1,fog:!1}),r=e.clone();r.opacity=.15;var n=e.clone();n.opacity=.33;var i=e.clone();i.color.set(16711680);var a=e.clone();a.color.set(65280);var s=e.clone();s.color.set(255);var o=e.clone();o.opacity=.25;var c=o.clone();c.color.set(16776960);var u=o.clone();u.color.set(65535);var l=o.clone();l.color.set(16711935),e.clone().color.set(16776960);var h=t.clone();h.color.set(16711680);var p=t.clone();p.color.set(65280);var d=t.clone();d.color.set(255);var f=t.clone();f.color.set(65535);var v=t.clone();v.color.set(16711935);var m=t.clone();m.color.set(16776960);var y=t.clone();y.color.set(7895160);var g=m.clone();g.opacity=.25;var b=new J.CylinderBufferGeometry(0,.05,.2,12,1,!1),w=new J.BoxBufferGeometry(.125,.125,.125),O=new J.BufferGeometry;O.addAttribute("position",new J.Float32BufferAttribute([0,0,0,1,0,0],3));var k,A=function(e,t){for(var r=new J.BufferGeometry,n=[],i=0;i<=64*t;++i)n.push(0,Math.cos(i/32*Math.PI)*e,Math.sin(i/32*Math.PI)*e);return r.addAttribute("position",new J.Float32BufferAttribute(n,3)),r},S={X:[[new J.Mesh(b,i),[1,0,0],[0,0,-Math.PI/2],null,"fwd"],[new J.Mesh(b,i),[1,0,0],[0,0,Math.PI/2],null,"bwd"],[new J.Line(O,h)]],Y:[[new J.Mesh(b,a),[0,1,0],null,null,"fwd"],[new J.Mesh(b,a),[0,1,0],[Math.PI,0,0],null,"bwd"],[new J.Line(O,p),null,[0,0,Math.PI/2]]],Z:[[new J.Mesh(b,s),[0,0,1],[Math.PI/2,0,0],null,"fwd"],[new J.Mesh(b,s),[0,0,1],[-Math.PI/2,0,0],null,"bwd"],[new J.Line(O,d),null,[0,-Math.PI/2,0]]],XYZ:[[new J.Mesh(new J.OctahedronBufferGeometry(.1,0),o),[0,0,0],[0,0,0]]],XY:[[new J.Mesh(new J.PlaneBufferGeometry(.295,.295),c),[.15,.15,0]],[new J.Line(O,m),[.18,.3,0],null,[.125,1,1]],[new J.Line(O,m),[.3,.18,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new J.Mesh(new J.PlaneBufferGeometry(.295,.295),u),[0,.15,.15],[0,Math.PI/2,0]],[new J.Line(O,f),[0,.18,.3],[0,0,Math.PI/2],[.125,1,1]],[new J.Line(O,f),[0,.3,.18],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new J.Mesh(new J.PlaneBufferGeometry(.295,.295),l),[.15,0,.15],[-Math.PI/2,0,0]],[new J.Line(O,v),[.18,0,.3],null,[.125,1,1]],[new J.Line(O,v),[.3,0,.18],[0,-Math.PI/2,0],[.125,1,1]]]},x={X:[[new J.Mesh(new J.CylinderBufferGeometry(.2,0,1,4,1,!1),r),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new J.Mesh(new J.CylinderBufferGeometry(.2,0,1,4,1,!1),r),[0,.6,0]]],Z:[[new J.Mesh(new J.CylinderBufferGeometry(.2,0,1,4,1,!1),r),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new J.Mesh(new J.OctahedronBufferGeometry(.2,0),r)]],XY:[[new J.Mesh(new J.PlaneBufferGeometry(.4,.4),r),[.2,.2,0]]],YZ:[[new J.Mesh(new J.PlaneBufferGeometry(.4,.4),r),[0,.2,.2],[0,Math.PI/2,0]]],XZ:[[new J.Mesh(new J.PlaneBufferGeometry(.4,.4),r),[.2,0,.2],[-Math.PI/2,0,0]]]},M={START:[[new J.Mesh(new J.OctahedronBufferGeometry(.01,2),n),null,null,null,"helper"]],END:[[new J.Mesh(new J.OctahedronBufferGeometry(.01,2),n),null,null,null,"helper"]],DELTA:[[new J.Line((k=new J.BufferGeometry,k.addAttribute("position",new J.Float32BufferAttribute([0,0,0,1,1,1],3)),k),n),null,null,null,"helper"]],X:[[new J.Line(O,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new J.Line(O,n.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new J.Line(O,n.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},C={X:[[new J.Line(A(1,.5),h)],[new J.Mesh(new J.OctahedronBufferGeometry(.04,0),i),[0,0,.99],null,[1,3,1]]],Y:[[new J.Line(A(1,.5),p),null,[0,0,-Math.PI/2]],[new J.Mesh(new J.OctahedronBufferGeometry(.04,0),a),[0,0,.99],null,[3,1,1]]],Z:[[new J.Line(A(1,.5),d),null,[0,Math.PI/2,0]],[new J.Mesh(new J.OctahedronBufferGeometry(.04,0),s),[.99,0,0],null,[1,3,1]]],E:[[new J.Line(A(1.25,1),g),null,[0,Math.PI/2,0]],[new J.Mesh(new J.CylinderBufferGeometry(.03,0,.15,4,1,!1),g),[1.17,0,0],[0,0,-Math.PI/2],[1,1,.001]],[new J.Mesh(new J.CylinderBufferGeometry(.03,0,.15,4,1,!1),g),[-1.17,0,0],[0,0,Math.PI/2],[1,1,.001]],[new J.Mesh(new J.CylinderBufferGeometry(.03,0,.15,4,1,!1),g),[0,-1.17,0],[Math.PI,0,0],[1,1,.001]],[new J.Mesh(new J.CylinderBufferGeometry(.03,0,.15,4,1,!1),g),[0,1.17,0],[0,0,0],[1,1,.001]]],XYZE:[[new J.Line(A(1,1),y),null,[0,Math.PI/2,0]]]},j={AXIS:[[new J.Line(O,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},E={X:[[new J.Mesh(new J.TorusBufferGeometry(1,.1,4,24),r),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new J.Mesh(new J.TorusBufferGeometry(1,.1,4,24),r),[0,0,0],[Math.PI/2,0,0]]],Z:[[new J.Mesh(new J.TorusBufferGeometry(1,.1,4,24),r),[0,0,0],[0,0,-Math.PI/2]]],E:[[new J.Mesh(new J.TorusBufferGeometry(1.25,.1,2,24),r)]],XYZE:[[new J.Mesh(new J.SphereBufferGeometry(.7,10,8),r)]]},P={X:[[new J.Mesh(w,i),[.8,0,0],[0,0,-Math.PI/2]],[new J.Line(O,h),null,null,[.8,1,1]]],Y:[[new J.Mesh(w,a),[0,.8,0]],[new J.Line(O,p),null,[0,0,Math.PI/2],[.8,1,1]]],Z:[[new J.Mesh(w,s),[0,0,.8],[Math.PI/2,0,0]],[new J.Line(O,d),null,[0,-Math.PI/2,0],[.8,1,1]]],XY:[[new J.Mesh(w,c),[.85,.85,0],null,[2,2,.2]],[new J.Line(O,m),[.855,.98,0],null,[.125,1,1]],[new J.Line(O,m),[.98,.855,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new J.Mesh(w,u),[0,.85,.85],null,[.2,2,2]],[new J.Line(O,f),[0,.855,.98],[0,0,Math.PI/2],[.125,1,1]],[new J.Line(O,f),[0,.98,.855],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new J.Mesh(w,l),[.85,0,.85],null,[2,.2,2]],[new J.Line(O,v),[.855,0,.98],null,[.125,1,1]],[new J.Line(O,v),[.98,0,.855],[0,-Math.PI/2,0],[.125,1,1]]],XYZX:[[new J.Mesh(new J.BoxBufferGeometry(.125,.125,.125),o),[1.1,0,0]]],XYZY:[[new J.Mesh(new J.BoxBufferGeometry(.125,.125,.125),o),[0,1.1,0]]],XYZZ:[[new J.Mesh(new J.BoxBufferGeometry(.125,.125,.125),o),[0,0,1.1]]]},D={X:[[new J.Mesh(new J.CylinderBufferGeometry(.2,0,.8,4,1,!1),r),[.5,0,0],[0,0,-Math.PI/2]]],Y:[[new J.Mesh(new J.CylinderBufferGeometry(.2,0,.8,4,1,!1),r),[0,.5,0]]],Z:[[new J.Mesh(new J.CylinderBufferGeometry(.2,0,.8,4,1,!1),r),[0,0,.5],[Math.PI/2,0,0]]],XY:[[new J.Mesh(w,r),[.85,.85,0],null,[3,3,.2]]],YZ:[[new J.Mesh(w,r),[0,.85,.85],null,[.2,3,3]]],XZ:[[new J.Mesh(w,r),[.85,0,.85],null,[3,.2,3]]],XYZX:[[new J.Mesh(new J.BoxBufferGeometry(.2,.2,.2),r),[1.1,0,0]]],XYZY:[[new J.Mesh(new J.BoxBufferGeometry(.2,.2,.2),r),[0,1.1,0]]],XYZZ:[[new J.Mesh(new J.BoxBufferGeometry(.2,.2,.2),r),[0,0,1.1]]]},R={X:[[new J.Line(O,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new J.Line(O,n.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new J.Line(O,n.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},L=function(e){var t=new J.Object3D;for(var r in e)for(var n=e[r].length;n--;){var i=e[r][n][0].clone(),a=e[r][n][1],s=e[r][n][2],o=e[r][n][3],c=e[r][n][4];i.name=r,i.tag=c,a&&i.position.set(a[0],a[1],a[2]),s&&i.rotation.set(s[0],s[1],s[2]),o&&i.scale.set(o[0],o[1],o[2]),i.updateMatrix();var u=i.geometry.clone();u.applyMatrix(i.matrix),i.geometry=u,i.position.set(0,0,0),i.rotation.set(0,0,0),i.scale.set(1,1,1),t.add(i)}return t},I=new J.Vector3(0,0,0),T=new J.Euler,N=new J.Vector3(0,1,0),G=new J.Vector3(0,0,0),B=new J.Matrix4,F=new J.Quaternion,U=new J.Quaternion,z=new J.Quaternion,H=new J.Vector3(1,0,0),W=new J.Vector3(0,1,0),V=new J.Vector3(0,0,1);this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=L(S)),this.add(this.gizmo.rotate=L(C)),this.add(this.gizmo.scale=L(P)),this.add(this.picker.translate=L(x)),this.add(this.picker.rotate=L(E)),this.add(this.picker.scale=L(D)),this.add(this.helper.translate=L(M)),this.add(this.helper.rotate=L(j)),this.add(this.helper.scale=L(R)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1,this.updateMatrixWorld=function(){var e=this.space;"scale"===this.mode&&(e="local");var t="local"===e?this.worldQuaternion:z;this.gizmo.translate.visible="translate"===this.mode,this.gizmo.rotate.visible="rotate"===this.mode,this.gizmo.scale.visible="scale"===this.mode,this.helper.translate.visible="translate"===this.mode,this.helper.rotate.visible="rotate"===this.mode,this.helper.scale.visible="scale"===this.mode;var r=[];r=(r=(r=r.concat(this.picker[this.mode].children)).concat(this.gizmo[this.mode].children)).concat(this.helper[this.mode].children);for(var n=0;n<r.length;n++){var i=r[n];i.visible=!0,i.rotation.set(0,0,0),i.position.copy(this.worldPosition);var a=this.worldPosition.distanceTo(this.cameraPosition);if(i.scale.set(1,1,1).multiplyScalar(a*this.size/7),"helper"!==i.tag){if(i.quaternion.copy(t),"translate"===this.mode||"scale"===this.mode){"X"!==i.name&&"XYZX"!==i.name||Math.abs(N.copy(H).applyQuaternion(t).dot(this.eye))>.99&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),"Y"!==i.name&&"XYZY"!==i.name||Math.abs(N.copy(W).applyQuaternion(t).dot(this.eye))>.99&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),"Z"!==i.name&&"XYZZ"!==i.name||Math.abs(N.copy(V).applyQuaternion(t).dot(this.eye))>.99&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),"XY"===i.name&&Math.abs(N.copy(V).applyQuaternion(t).dot(this.eye))<.2&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),"YZ"===i.name&&Math.abs(N.copy(H).applyQuaternion(t).dot(this.eye))<.2&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),"XZ"===i.name&&Math.abs(N.copy(W).applyQuaternion(t).dot(this.eye))<.2&&(i.scale.set(1e-10,1e-10,1e-10),i.visible=!1),-1!==i.name.search("X")&&(N.copy(H).applyQuaternion(t).dot(this.eye)<-.4?"fwd"===i.tag?i.visible=!1:i.scale.x*=-1:"bwd"===i.tag&&(i.visible=!1)),-1!==i.name.search("Y")&&(N.copy(W).applyQuaternion(t).dot(this.eye)<-.4?"fwd"===i.tag?i.visible=!1:i.scale.y*=-1:"bwd"===i.tag&&(i.visible=!1)),-1!==i.name.search("Z")&&(N.copy(V).applyQuaternion(t).dot(this.eye)<-.4?"fwd"===i.tag?i.visible=!1:i.scale.z*=-1:"bwd"===i.tag&&(i.visible=!1))}else"rotate"===this.mode&&(U.copy(t),N.copy(this.eye).applyQuaternion(F.copy(t).inverse()),-1!==i.name.search("E")&&i.quaternion.setFromRotationMatrix(B.lookAt(this.eye,G,W)),"X"===i.name&&(F.setFromAxisAngle(H,Math.atan2(-N.y,N.z)),F.multiplyQuaternions(U,F),i.quaternion.copy(F)),"Y"===i.name&&(F.setFromAxisAngle(W,Math.atan2(N.x,N.z)),F.multiplyQuaternions(U,F),i.quaternion.copy(F)),"Z"===i.name&&(F.setFromAxisAngle(V,Math.atan2(N.y,N.x)),F.multiplyQuaternions(U,F),i.quaternion.copy(F)));i.visible=i.visible&&(-1===i.name.indexOf("X")||this.showX),i.visible=i.visible&&(-1===i.name.indexOf("Y")||this.showY),i.visible=i.visible&&(-1===i.name.indexOf("Z")||this.showZ),i.visible=i.visible&&(-1===i.name.indexOf("E")||this.showX&&this.showY&&this.showZ),i.material._opacity=i.material._opacity||i.material.opacity,i.material._color=i.material._color||i.material.color.clone(),i.material.color.copy(i.material._color),i.material.opacity=i.material._opacity,this.enabled?this.axis&&(i.name===this.axis?(i.material.opacity=1,i.material.color.lerp(new J.Color(1,1,1),.5)):this.axis.split("").some(function(e){return i.name===e})?(i.material.opacity=1,i.material.color.lerp(new J.Color(1,1,1),.5)):(i.material.opacity*=.25,i.material.color.lerp(new J.Color(1,1,1),.5))):(i.material.opacity*=.5,i.material.color.lerp(new J.Color(1,1,1),.5))}else i.visible=!1,"AXIS"===i.name?(i.position.copy(this.worldPositionStart),i.visible=!!this.axis,"X"===this.axis&&(F.setFromEuler(T.set(0,0,0)),i.quaternion.copy(t).multiply(F),Math.abs(N.copy(H).applyQuaternion(t).dot(this.eye))>.9&&(i.visible=!1)),"Y"===this.axis&&(F.setFromEuler(T.set(0,0,Math.PI/2)),i.quaternion.copy(t).multiply(F),Math.abs(N.copy(W).applyQuaternion(t).dot(this.eye))>.9&&(i.visible=!1)),"Z"===this.axis&&(F.setFromEuler(T.set(0,Math.PI/2,0)),i.quaternion.copy(t).multiply(F),Math.abs(N.copy(V).applyQuaternion(t).dot(this.eye))>.9&&(i.visible=!1)),"XYZE"===this.axis&&(F.setFromEuler(T.set(0,Math.PI/2,0)),N.copy(this.rotationAxis),i.quaternion.setFromRotationMatrix(B.lookAt(G,N,W)),i.quaternion.multiply(F),i.visible=this.dragging),"E"===this.axis&&(i.visible=!1)):"START"===i.name?(i.position.copy(this.worldPositionStart),i.visible=this.dragging):"END"===i.name?(i.position.copy(this.worldPosition),i.visible=this.dragging):"DELTA"===i.name?(i.position.copy(this.worldPositionStart),i.quaternion.copy(this.worldQuaternionStart),I.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),I.applyQuaternion(this.worldQuaternionStart.clone().inverse()),i.scale.copy(I),i.visible=this.dragging):(i.quaternion.copy(t),this.dragging?i.position.copy(this.worldPositionStart):i.position.copy(this.worldPosition),this.axis&&(i.visible=-1!==this.axis.search(i.name)))}J.Object3D.prototype.updateMatrixWorld.call(this)}};_.prototype=Object.assign(Object.create(J.Object3D.prototype),{constructor:_,isTransformControlsGizmo:!0});var ee=function(){J.Mesh.call(this,new J.PlaneBufferGeometry(1e5,1e5,2,2),new J.MeshBasicMaterial({visible:!1,wireframe:!0,side:J.DoubleSide,transparent:!0,opacity:.1})),this.type="TransformControlsPlane";var e=new J.Vector3(1,0,0),t=new J.Vector3(0,1,0),r=new J.Vector3(0,0,1),n=new J.Vector3,i=new J.Vector3,a=new J.Vector3,s=new J.Matrix4,o=new J.Quaternion;this.updateMatrixWorld=function(){var c=this.space;switch(this.position.copy(this.worldPosition),"scale"===this.mode&&(c="local"),e.set(1,0,0).applyQuaternion("local"===c?this.worldQuaternion:o),t.set(0,1,0).applyQuaternion("local"===c?this.worldQuaternion:o),r.set(0,0,1).applyQuaternion("local"===c?this.worldQuaternion:o),a.copy(t),this.mode){case"translate":case"scale":switch(this.axis){case"X":a.copy(this.eye).cross(e),i.copy(e).cross(a);break;case"Y":a.copy(this.eye).cross(t),i.copy(t).cross(a);break;case"Z":a.copy(this.eye).cross(r),i.copy(r).cross(a);break;case"XY":i.copy(r);break;case"YZ":i.copy(e);break;case"XZ":a.copy(r),i.copy(t);break;case"XYZ":case"E":i.set(0,0,0)}break;case"rotate":default:i.set(0,0,0)}0===i.length()?this.quaternion.copy(this.cameraQuaternion):(s.lookAt(n.set(0,0,0),i,a),this.quaternion.setFromRotationMatrix(s)),J.Object3D.prototype.updateMatrixWorld.call(this)}};ee.prototype=Object.assign(Object.create(J.Mesh.prototype),{constructor:ee,isTransformControlsPlane:!0});var te,re,ne,ie,ae,se,oe,ce,ue,le,he,pe,de=$,fe=function(){function e(){Object(o.a)(this,e)}return Object(c.a)(e,[{key:"updateProperty",value:function(e,t,r,n){if("tx"===r.name&&(e.position.x=parseFloat(r.value)),"ty"===r.name&&(e.position.y=parseFloat(r.value)),"tz"===r.name&&(e.position.z=parseFloat(r.value)),"rx"===r.name&&(e.rotation.x=parseFloat(r.value)),"ry"===r.name&&(e.rotation.y=parseFloat(r.value)),"rz"===r.name&&(e.rotation.z=parseFloat(r.value)),"sx"===r.name&&(e.scale.x=parseFloat(r.value)),"sy"===r.name&&(e.scale.y=parseFloat(r.value)),"sz"===r.name&&(e.scale.z=parseFloat(r.value)),"visible"===r.name&&(e.visible=r.value),"color"===r.name){var i=r.value;0===i.indexOf("#")&&(i=i.substring(1)),e.material.color.set(parseInt(i,16))}}},{key:"reset",value:function(e,t){e.position.set(t.tx,t.ty,t.tz),e.visible=t.visible}},{key:"attachAsset",value:function(e,t,r){t.asset!==qe.id?r.assetsManager.getTexture(t.asset).then(function(n){r.getLogger().log("loadded asset",t.asset),r.getLogger().log(n),n||r.getLogger().error("error loading asset",t.asset);var i={color:t.color,side:Q.DoubleSide,map:n};t.transparent&&(i.transparent=!0,i.alphaTest=.5),e.material=new Q.MeshLambertMaterial(i)}).catch(function(e){r.getLogger().error("error somwhere",e.message,e)}):e.material=new Q.MeshLambertMaterial({color:t.color,side:Q.DoubleSide})}}]),e}(),ve=0,me=function(e){function t(){return Object(o.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create cube w/ missing parent");return B(e,e.createObject({type:_e.cube,title:"cube "+ve++,visible:!0,width:.3,height:.3,depth:.3,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,color:"#00ff00",children:e.createArray(),asset:qe.id,transparent:!1,parent:t.id}))}},{key:"makeNode",value:function(e,t){var r=new Q.Mesh(new Q.BoxGeometry(e.width,e.height,e.depth),new Q.MeshLambertMaterial({color:e.color}));return r.name=e.title,r.userData.clickable=!0,r.position.set(e.tx,e.ty,e.tz),r.rotation.set(e.rx,e.ry,e.rz),r.scale.set(e.sx,e.sy,e.sz),r.visible=e.visible,this.attachAsset(r,e,t),r}},{key:"updateProperty",value:function(e,r,n,i){if("width"!==n.name&&"height"!==n.name&&"depth"!==n.name)return n.name===Je.asset.key||n.name===Je.transparent.key?this.attachAsset(e,r,i):Object(p.a)(Object(l.a)(t.prototype),"updateProperty",this).call(this,e,r,n,i);e.geometry=new Q.BoxGeometry(r.width,r.height,r.depth)}}]),t}(fe),ye=0,ge=function(e){function t(){return Object(o.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create sphere w/ missing parent");return B(e,e.createObject({type:_e.sphere,title:"sphere "+ye++,visible:!0,radius:.15,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,color:"#0000ff",children:e.createArray(),asset:qe.id,transparent:!1,parent:t.id}))}},{key:"makeNode",value:function(e,t){var r=new Q.Mesh(new Q.SphereBufferGeometry(e.radius),new Q.MeshLambertMaterial({color:e.color}));return r.name=e.title,r.userData.clickable=!0,r.position.set(e.tx,e.ty,e.tz),r.rotation.set(e.rx,e.ry,e.rz),r.scale.set(e.sx,e.sy,e.sz),r.visible=e.visible,this.attachAsset(r,e,t),r}},{key:"updateProperty",value:function(e,r,n,i){return"radius"===n.name&&(e.geometry=new Q.SphereBufferGeometry(n.value)),n.name===Je.asset.key||n.name===Je.transparent.key?this.attachAsset(e,r,i):Object(p.a)(Object(l.a)(t.prototype),"updateProperty",this).call(this,e,r,n,i)}}]),t}(fe),be=function(e){function t(){return Object(o.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create plane w/ missing parent");return B(e,e.createObject({type:"plane",title:"a plane",visible:!0,width:.5,height:.5,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,color:"#ffffff",children:e.createArray(),asset:qe.id,transparent:!1,parent:t.id}))}},{key:"makeNode",value:function(e,t){var r=new Q.Mesh(new Q.PlaneBufferGeometry(e.width,e.height),new Q.MeshLambertMaterial({color:e.color,side:Q.DoubleSide}));return this.attachAsset(r,e,t),r.userData.clickable=!0,r.position.set(e.tx,e.ty,e.tz),r.rotation.set(e.rx,e.ry,e.rz),r.scale.set(e.sx,e.sy,e.sz),r.visible=e.visible,r}},{key:"updateProperty",value:function(e,r,n,i){return"width"===n.name&&(e.geometry=new Q.PlaneBufferGeometry(n.value,r.height)),"height"===n.name&&(e.geometry=new Q.PlaneBufferGeometry(r.width,n.value)),n.name===Je.asset.key||n.name===Je.transparent.key?this.attachAsset(e,r,i):Object(p.a)(Object(l.a)(t.prototype),"updateProperty",this).call(this,e,r,n,i)}}]),t}(fe),we=r(1);var Oe={retarget:(oe=new we.Vector3,ce=new we.Quaternion,ue=new we.Vector3,le=new we.Matrix4,he=new we.Matrix4,pe=new we.Matrix4,function(e,t,r){(r=r||{}).preserveMatrix=void 0===r.preserveMatrix||r.preserveMatrix,r.preservePosition=void 0===r.preservePosition||r.preservePosition,r.preserveHipPosition=void 0!==r.preserveHipPosition&&r.preserveHipPosition,r.useTargetMatrix=void 0!==r.useTargetMatrix&&r.useTargetMatrix,r.hip=void 0!==r.hip?r.hip:"hip",r.names=r.names||{};var n,i,a,s,o,c,u=t.isObject3D?t.skeleton.bones:this.getBones(t),l=e.isObject3D?e.skeleton.bones:this.getBones(e);if(e.isObject3D?e.skeleton.pose():(r.useTargetMatrix=!0,r.preserveMatrix=!1),r.preservePosition)for(o=[],c=0;c<l.length;c++)o.push(l[c].position.clone());if(r.preserveMatrix)for(e.updateMatrixWorld(),e.matrixWorld.identity(),c=0;c<e.children.length;++c)e.children[c].updateMatrixWorld(!0);if(r.offsets)for(n=[],c=0;c<l.length;++c)i=l[c],a=r.names[i.name]||i.name,r.offsets&&r.offsets[a]&&(i.matrix.multiply(r.offsets[a]),i.matrix.decompose(i.position,i.quaternion,i.scale),i.updateMatrixWorld()),n.push(i.matrixWorld.clone());for(c=0;c<l.length;++c){if(i=l[c],a=r.names[i.name]||i.name,s=this.getBoneByName(a,u),pe.copy(i.matrixWorld),s){if(s.updateMatrixWorld(),r.useTargetMatrix?he.copy(s.matrixWorld):(he.getInverse(e.matrixWorld),he.multiply(s.matrixWorld)),ue.setFromMatrixScale(he),he.scale(ue.set(1/ue.x,1/ue.y,1/ue.z)),pe.makeRotationFromQuaternion(ce.setFromRotationMatrix(he)),e.isObject3D){var h=l.indexOf(i),p=n?n[h]:le.getInverse(e.skeleton.boneInverses[h]);pe.multiply(p)}pe.copyPosition(he)}i.parent&&i.parent.isBone?(i.matrix.getInverse(i.parent.matrixWorld),i.matrix.multiply(pe)):i.matrix.copy(pe),r.preserveHipPosition&&a===r.hip&&i.matrix.setPosition(oe.set(0,i.position.y,0)),i.matrix.decompose(i.position,i.quaternion,i.scale),i.updateMatrixWorld()}if(r.preservePosition)for(c=0;c<l.length;++c)i=l[c],(a=r.names[i.name]||i.name)!==r.hip&&i.position.copy(o[c]);r.preserveMatrix&&e.updateMatrixWorld(!0)}),retargetClip:function(e,t,r,n){(n=n||{}).useFirstFramePosition=void 0!==n.useFirstFramePosition&&n.useFirstFramePosition,n.fps=void 0!==n.fps?n.fps:30,n.names=n.names||[],t.isObject3D||(t=this.getHelperFromSkeleton(t));var i,a,s,o,c,u,l=Math.round(r.duration*(n.fps/1e3)*1e3),h=1/n.fps,p=[],d=new we.AnimationMixer(t),f=this.getBones(e.skeleton),v=[];for(d.clipAction(r).play(),d.update(0),t.updateMatrixWorld(),c=0;c<l;++c){var m=c*h;for(this.retarget(e,t,n),u=0;u<f.length;++u)o=n.names[f[u].name]||f[u].name,this.getBoneByName(o,t.skeleton)&&(a=f[u],s=v[u]=v[u]||{bone:a},n.hip===o&&(s.pos||(s.pos={times:new Float32Array(l),values:new Float32Array(3*l)}),n.useFirstFramePosition&&(0===c&&(i=a.position.clone()),a.position.sub(i)),s.pos.times[c]=m,a.position.toArray(s.pos.values,3*c)),s.quat||(s.quat={times:new Float32Array(l),values:new Float32Array(4*l)}),s.quat.times[c]=m,a.quaternion.toArray(s.quat.values,4*c));d.update(h),t.updateMatrixWorld()}for(c=0;c<v.length;++c)(s=v[c])&&(s.pos&&p.push(new we.VectorKeyframeTrack(".bones["+s.bone.name+"].position",s.pos.times,s.pos.values)),p.push(new we.QuaternionKeyframeTrack(".bones["+s.bone.name+"].quaternion",s.quat.times,s.quat.values)));return d.uncacheAction(r),new we.AnimationClip(r.name,-1,p)},getHelperFromSkeleton:function(e){var t=new we.SkeletonHelper(e.bones[0]);return t.skeleton=e,t},getSkeletonOffsets:(te=new we.Vector3,re=new we.Vector3,ne=new we.Vector3,ie=new we.Vector3,ae=new we.Vector2,se=new we.Vector2,function(e,t,r){(r=r||{}).hip=void 0!==r.hip?r.hip:"hip",r.names=r.names||{},t.isObject3D||(t=this.getHelperFromSkeleton(t));var n,i,a,s,o=Object.keys(r.names),c=Object.values(r.names),u=t.isObject3D?t.skeleton.bones:this.getBones(t),l=e.isObject3D?e.skeleton.bones:this.getBones(e),h=[];for(e.skeleton.pose(),s=0;s<l.length;++s)if(n=l[s],a=r.names[n.name]||n.name,(i=this.getBoneByName(a,u))&&a!==r.hip){var p=this.getNearestBone(n.parent,o),d=this.getNearestBone(i.parent,c);p.updateMatrixWorld(),d.updateMatrixWorld(),te.setFromMatrixPosition(p.matrixWorld),re.setFromMatrixPosition(n.matrixWorld),ne.setFromMatrixPosition(d.matrixWorld),ie.setFromMatrixPosition(i.matrixWorld),ae.subVectors(new we.Vector2(re.x,re.y),new we.Vector2(te.x,te.y)).normalize(),se.subVectors(new we.Vector2(ie.x,ie.y),new we.Vector2(ne.x,ne.y)).normalize();var f=ae.angle()-se.angle(),v=(new we.Matrix4).makeRotationFromEuler(new we.Euler(0,0,f));n.matrix.multiply(v),n.matrix.decompose(n.position,n.quaternion,n.scale),n.updateMatrixWorld(),h[a]=v}return h}),renameBones:function(e,t){for(var r=this.getBones(e),n=0;n<r.length;++n){var i=r[n];t[i.name]&&(i.name=t[i.name])}return this},getBones:function(e){return Array.isArray(e)?e:e.bones},getBoneByName:function(e,t){for(var r=0,n=this.getBones(t);r<n.length;r++)if(e===n[r].name)return n[r]},getNearestBone:function(e,t){for(;e.isBone;){if(-1!==t.indexOf(e.name))return e;e=e.parent}},findBoneTrackData:function(e,t){for(var r=/\[(.*)\]\.(.*)/,n={name:e},i=0;i<t.length;++i){var a=r.exec(t[i].name);a&&e===a[1]&&(n[a[2]]=i)}return n},getEqualsBonesNames:function(e,t){var r=this.getBones(e),n=this.getBones(t),i=[];e:for(var a=0;a<r.length;a++)for(var s=r[a].name,o=0;o<n.length;o++)if(s===n[o].name){i.push(s);continue e}return i},clone:function(e){var t=new Map,r=new Map,n=e.clone();return function e(t,r,n){n(t,r);for(var i=0;i<t.children.length;i++)e(t.children[i],r.children[i],n)}(e,n,function(e,n){t.set(n,e),r.set(e,n)}),n.traverse(function(e){if(e.isSkinnedMesh){var n=e,i=t.get(e),a=i.skeleton.bones;n.skeleton=i.skeleton.clone(),n.bindMatrix.copy(i.bindMatrix),n.skeleton.bones=a.map(function(e){return r.get(e)}),n.bind(n.skeleton,n.bindMatrix)}}),n}},ke=function(e){function t(){return Object(o.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create model w/ missing parent");return B(e,e.createObject({type:"model",title:"a model",visible:!0,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,color:"#ffffff",children:e.createArray(),asset:qe.id,transparent:!1,parent:t.id}))}},{key:"makeNode",value:function(e,t){var r=new Q.Group;r.name=e.title;var n=new Q.Mesh(new Q.SphereBufferGeometry(1),new Q.MeshLambertMaterial({color:"red",transparent:!0,opacity:.2}));return n.material.visible=!0,n.userData.clickable=!0,r.userData.clicker=n,r.add(n),r.position.set(e.tx,e.ty,e.tz),r.rotation.set(e.rx,e.ry,e.rz),r.scale.set(e.sx,e.sy,e.sz),r.visible=e.visible,this.attachAsset(r,e,t),r.enter=function(e,t){r.userData.clicker.visible=!1,r.userData.model?r.userData.currentClip&&(r.userData.action=r.userData.mixer.clipAction(r.userData.currentClip),r.userData.action.play()):r.userData.shouldPlay=!0},r.exit=function(n,i){t.accessObject(e.id).asset===qe.id&&(r.userData.clicker.visible=!0)},r.tick=function(e,t){var n=e.deltaTime/1e3;r.userData.mixer&&r.userData.mixer.update(n)},r.useClip=function(e){if(r.userData.model){var t=Q.AnimationClip.findByName(r.userData.clips,e);t&&(r.userData.currentClip=t)}else r.userData.currentClipName=e},r.play=function(){r.userData.currentClip&&(r.userData.mixer.stopAllAction(),r.userData.action=r.userData.mixer.clipAction(r.userData.currentClip),r.userData.action.play())},r.stop=function(){r.userData.mixer&&r.userData.mixer.stopAllAction()},r}},{key:"updateProperty",value:function(e,r,n,i){return n.name===Je.asset.key?this.attachAsset(e,r,i):Object(p.a)(Object(l.a)(t.prototype),"updateProperty",this).call(this,e,r,n,i)}},{key:"setClips",value:function(e){e.mixer&&(e.mixer.stopAllAction(),e.mixer.uncacheRoot(e.mixer.getRoot()),e.mixer=null),e.clips.forEach(function(e){e.validate()&&e.optimize()}),e.clips.length&&(e.currentClip=e.clips[0],e.mixer=new Q.AnimationMixer(e.model))}},{key:"attachAsset",value:function(e,t,r){var n=this;if(t.asset===qe.id)return console.log("REMOVE NODE CHILDREN"),e.userData.model&&(e.remove(e.userData.model),delete e.userData.model),void(e.userData.clicker.visible=!0);e.userData.shouldPlay=!1,e.userData.currentClip=null,e.userData.model=null,e.userData.currentClipName=null,r.assetsManager.getGLTF(t.asset).then(function(t){e.userData.model&&e.remove(e.userData.model),e.userData.model=t.scene||t.scenes[0],e.userData.model=Oe.clone(e.userData.model),e.userData.clips=t.animations||[],e.add(e.userData.model),e.userData.model.updateMatrixWorld();var r=e.userData.model;if(e.userData.boundingBox=(new Q.Box3).setFromObject(r),e.userData.boundingBoxSize=e.userData.boundingBox.getSize(new Q.Vector3).length(),e.userData.BoundingBoxCenter=e.userData.boundingBox.getCenter(new Q.Vector3),e.userData.mixer=null,n.setClips(e.userData),e.userData.currentClipName){var i=Q.AnimationClip.findByName(e.userData.clips,e.userData.currentClipName);i&&(e.userData.currentClip=i),e.userData.currentClipName=null}e.userData.shouldPlay&&e.userData.currentClip&&(e.userData.action=e.userData.mixer.clipAction(e.userData.currentClip),e.userData.action.play(),e.userData.shouldPlay=!1),e.userData.clicker.geometry=new Q.SphereBufferGeometry(e.userData.boundingBoxSize/2),e.userData.clicker.visible=!1}).catch(function(e){console.log("error loading GLTF")})}}]),t}(fe);var Ae=function(){function e(){Object(o.a)(this,e)}return Object(c.a)(e,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create sphere w/ missing parent");return B(e,e.createObject({type:_e.bg360,title:"background",visible:!0,asset:qe.id,transparent:!1,parent:t.id,imageOffsetAngle:0,imageCropStartAngle:0,imageCropEndAngle:1}))}},{key:"makeNode",value:function(e,t){var r=new Q.MeshLambertMaterial({color:"white",side:Q.BackSide}),n=new Q.Mesh(new Q.SphereBufferGeometry(20,50,50),r);return this.attachAsset(n,e,t),function(e,t,r){t.onBeforeCompile=function(t){t.uniforms.imageOffsetAngle={value:r.imageOffsetAngle},t.uniforms.imageCropStartAngle={value:r.imageCropStartAngle},t.uniforms.imageCropEndAngle={value:r.imageCropEndAngle},t.vertexShader="\n            uniform float imageOffsetAngle;\n            varying float vImageOffsetAngle;\n            uniform float imageCropStartAngle;            \n            varying float vImageCropStartAngle;            \n            uniform float imageCropEndAngle;            \n            varying float vImageCropEndAngle;            \n        "+t.vertexShader,t.vertexShader=t.vertexShader.replace("#include <begin_vertex>","\n            #include <begin_vertex>\n            vImageOffsetAngle = imageOffsetAngle;\n            vImageCropStartAngle = imageCropStartAngle;\n            vImageCropEndAngle = imageCropEndAngle;\n        "),t.fragmentShader="\n                varying float vImageOffsetAngle;\n                varying float vImageCropStartAngle;\n                varying float vImageCropEndAngle;\n            "+t.fragmentShader,t.fragmentShader=t.fragmentShader.replace("#include <dithering_fragment>","\n            if(vUv.x < vImageCropStartAngle) discard;\n            if(vUv.x > vImageCropEndAngle)  discard;\n            // gl_FragColor.r = vUv.x;\n            // vec3 jv = vec3(cos(gl_FragCoord.x/50.0)); \n            // vec3 empty = vec3(0.0,0.0,0.0);//vec3(jv,jv,jv)\n            // gl_FragColor.rgb = mix(empty,diffuseColor.rgb,jv);\n        "),e.userData.matShader=t}}(n,r,e),n.name=e.title,n.userData.clickable=!0,n.visible=e.visible,n}},{key:"updateProperty",value:function(e,t,r,n){if(r.name===Je.asset.key||r.name===Je.transparent.key)return this.attachAsset(e,t,n);e.userData.matShader?("imageOffsetAngle"===r.name&&(e.userData.matShader.uniforms.imageOffsetAngle.value=r.value),"imageCropStartAngle"===r.name&&(e.userData.matShader.uniforms.imageCropStartAngle.value=r.value),"imageCropEndAngle"===r.name&&(e.userData.matShader.uniforms.imageCropEndAngle.value=r.value)):console.warn("BG360: no shader reference?!")}},{key:"attachAsset",value:function(e,t,r){t.asset!==qe.id?r.assetsManager.getTexture(t.asset).then(function(n){r.getLogger().log("loadded asset",t.asset),r.getLogger().log(n),n||r.getLogger().error("error loading asset",t.asset);var i={side:Q.DoubleSide,map:n};t.transparent&&(i.transparent=!0,i.alphaTest=.5),e.material=new Q.MeshLambertMaterial(i)}).catch(function(e){r.getLogger().error("error somwhere",e.message,e)}):e.material=new Q.MeshLambertMaterial({side:Q.DoubleSide})}}]),e}(),Se=r(24),xe=function(e){function t(){return Object(o.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create sphere w/ missing parent");return B(e,e.createObject({type:_e.text,title:"some text",visible:!0,text:"cool <b>formatted</b> <i>text</i>",cssStyle:"color:black; \nbackground-color:white;\nwidth: 10em;\nfont-size: 200%;\n",tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,children:e.createArray(),parent:t.id}))}},{key:"makeNode",value:function(e){var t=document.createElement("div");t.innerHTML=e.text,t.id="div_".concat(e.id),t.classList.add("weblayer-div"),e.cssStyle&&t.setAttribute("style",e.cssStyle);var r=new Se.a(t,{pixelRatio:window.devicePixelRatio,onLayerCreate:function(t){t.mesh.material.side=Q.DoubleSide,t.mesh.userData.graphid=e.id,t.mesh.userData.clickable=!0}});r.refresh(!0),r.userData.clickable=!0;var n=new Q.Object3D;return n.previewUpdate=function(){r.update()},n.setText=function(e){e!==n.userData.text&&(n.userData.text=e,n.userData.div.innerHTML=e)},n.add(r),n.userData.divLayer=r,n.userData.text=e.text,n.userData.div=t,n.name=e.title,n.userData.clickable=!0,n.position.set(e.tx,e.ty,e.tz),n.rotation.set(e.rx,e.ry,e.rz),n.scale.set(e.sx,e.sy,e.sz),n.visible=e.visible,this.regenerateText(n,e),n}},{key:"updateProperty",value:function(e,r,n,i){return n.name===Je.text.key&&this.regenerateText(e,r),n.name===Je.cssStyle.key&&this.regenerateText(e,r),Object(p.a)(Object(l.a)(t.prototype),"updateProperty",this).call(this,e,r,n,i)}},{key:"regenerateText",value:function(e,t){e.userData.div.innerHTML=t.text,t.cssStyle&&e.userData.div.setAttribute("style",t.cssStyle),e.userData.divLayer.refresh(!0)}}]),t}(fe),Me=function(e){function t(){return Object(o.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create Image2D with missing parent");return B(e,e.createObject({type:_e.img2d,title:"image",visible:!0,width:.5,ratio:1,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,asset:qe.id,transparent:!1,parent:t.id}))}},{key:"makeNode",value:function(e,t){var r=new Q.Mesh(new Q.PlaneBufferGeometry(e.width,e.width*e.ratio),new Q.MeshLambertMaterial({color:"white",side:Q.DoubleSide}));return r.name=e.title,r.userData.clickable=!0,r.position.set(e.tx,e.ty,e.tz),r.rotation.set(e.rx,e.ry,e.rz),r.scale.set(e.sx,e.sy,e.sz),r.visible=e.visible,this.attachAsset(r,e,t),r}},{key:"updateProperty",value:function(e,r,n,i){return n.name===Je.asset.key||n.name===Je.transparent.key?this.attachAsset(e,r,i):n.name!==Je.width.key&&"ratio"!==n.name?Object(p.a)(Object(l.a)(t.prototype),"updateProperty",this).call(this,e,r,n,i):void(e.geometry=new Q.PlaneBufferGeometry(r.width,r.width*(1/r.ratio)))}}]),t}(fe),Ce=0,je=function(e){function t(){return Object(o.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create cube w/ missing parent");return B(e,e.createObject({type:_e.group,title:"group "+Ce++,visible:!0,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,color:"#00ff00",children:e.createArray(),parent:t.id}))}},{key:"makeNode",value:function(e){var t=new Q.Group;return t.name=e.title,t.userData.clickable=!0,t.position.set(e.tx,e.ty,e.tz),t.rotation.set(e.rx,e.ry,e.rz),t.scale.set(e.sx,e.sy,e.sz),t.visible=e.visible,t}},{key:"updateProperty",value:function(e,r,n,i){return Object(p.a)(Object(l.a)(t.prototype),"updateProperty",this).call(this,e,r,n,i)}}]),t}(fe),Ee={vertexShader:"\n                uniform float uTime;\n                uniform float uScale;\n                uniform bool reverseTime;\n                uniform float fadeIn;\n                uniform float fadeOut;\n    \n                attribute vec3 positionStart;\n                attribute float startTime;\n                attribute vec3 velocity;\n                attribute vec3 acceleration;\n                attribute vec3 color;\n                attribute vec3 endColor;\n                attribute float size;\n                attribute float lifeTime;\n    \n                varying vec4 vColor;\n                varying vec4 vEndColor;\n                varying float lifeLeft;\n                varying float alpha;\n    \n                void main() {\n                    vColor = vec4( color, 1.0 );\n                    vEndColor = vec4( endColor, 1.0);\n                    vec3 newPosition;\n                    float timeElapsed = uTime - startTime;\n                    if(reverseTime) timeElapsed = lifeTime - timeElapsed;\n                    if(timeElapsed < fadeIn) {\n                        alpha = timeElapsed/fadeIn;\n                    }\n                    if(timeElapsed >= fadeIn && timeElapsed <= (lifeTime - fadeOut)) {\n                        alpha = 1.0;\n                    }\n                    if(timeElapsed > (lifeTime - fadeOut)) {\n                        alpha = 1.0 - (timeElapsed - (lifeTime-fadeOut))/fadeOut;\n                    }\n                    \n                    lifeLeft = 1.0 - ( timeElapsed / lifeTime );\n                    gl_PointSize = ( uScale * size );// * lifeLeft;\n                    newPosition = positionStart \n                        + (velocity * timeElapsed)\n                        + (acceleration * 0.5 * timeElapsed * timeElapsed)\n                        ;\n                    if (lifeLeft < 0.0) { \n                        lifeLeft = 0.0; \n                        gl_PointSize = 0.;\n                    }\n                    //while active use the new position\n                    if( timeElapsed > 0.0 ) {\n                        gl_Position = projectionMatrix * modelViewMatrix * vec4( newPosition, 1.0 );\n                    } else {\n                        //if dead use the initial position and set point size to 0\n                        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n                        lifeLeft = 0.0;\n                        gl_PointSize = 0.;\n                    }\n                }\n                ",fragmentShader:"\n                varying vec4 vColor;\n                varying vec4 vEndColor;\n                varying float lifeLeft;\n                varying float alpha;\n                uniform sampler2D tSprite;\n                void main() {\n                    // color based on particle texture and the lifeLeft. \n                    // if lifeLeft is 0 then make invisible\n                    vec4 tex = texture2D( tSprite, gl_PointCoord );\n                    vec4 color = mix(vColor, vEndColor, 1.0-lifeLeft);\n                    gl_FragColor = vec4( color.rgb*tex.rgb, alpha * tex.a);\n                }\n    \n            "},Pe=["positionStart","startTime","velocity","acceleration","color","endColor","size","lifeTime"],De=function(e){function t(e){var r,n;for(Object(o.a)(this,t),e=e||{},(r=Object(u.a)(this,Object(l.a)(t).call(this))).blending=e.blending?e.blending:Q.NormalBlending,r.PARTICLE_COUNT=e.maxParticles||1e6,r.PARTICLE_CURSOR=0,r.time=0,r.offset=0,r.count=0,r.DPR=window.devicePixelRatio,r.particleUpdate=!1,r.onTick=e.onTick,r.reverseTime=e.reverseTime,r.fadeIn=e.fadeIn||1,0===r.fadeIn&&(r.fadeIn=.001),r.fadeOut=e.fadeOut||1,0===r.fadeOut&&(r.fadeOut=.001),r.rand=[],n=1e5;n>0;n--)r.rand.push(Math.random()-.5);if(r.i=n,r.sprite=e.particleSpriteTex||null,!r.sprite){var i=document.createElement("canvas");i.width=16,i.height=16;var a=i.getContext("2d");a.fillStyle="black",a.fillRect(0,0,i.width,i.height),a.fillStyle="rgba(255,255,255,0.5)",a.beginPath(),a.arc(8,8,8,0,2*Math.PI),a.fill(),r.sprite=new Q.CanvasTexture(i)}return r.sprite.wrapS=r.sprite.wrapT=Q.RepeatWrapping,r.material=new Q.ShaderMaterial({transparent:!0,depthWrite:!1,uniforms:{uTime:{value:0},uScale:{value:1},tSprite:{value:r.sprite},reverseTime:{value:r.reverseTime},fadeIn:{value:r.fadeIn},fadeOut:{value:r.fadeOut}},blending:r.blending,vertexShader:Ee.vertexShader,fragmentShader:Ee.fragmentShader}),r.material.defaultAttributeValues.particlePositionsStartTime=[0,0,0,0],r.material.defaultAttributeValues.particleVelColSizeLife=[0,0,0,0],r.geometry=new Q.BufferGeometry,r.geometry.addAttribute("position",new Q.BufferAttribute(new Float32Array(3*r.PARTICLE_COUNT),3).setDynamic(!0)),r.geometry.addAttribute("positionStart",new Q.BufferAttribute(new Float32Array(3*r.PARTICLE_COUNT),3).setDynamic(!0)),r.geometry.addAttribute("velocity",new Q.BufferAttribute(new Float32Array(3*r.PARTICLE_COUNT),3).setDynamic(!0)),r.geometry.addAttribute("acceleration",new Q.BufferAttribute(new Float32Array(3*r.PARTICLE_COUNT),3).setDynamic(!0)),r.geometry.addAttribute("color",new Q.BufferAttribute(new Float32Array(3*r.PARTICLE_COUNT),3).setDynamic(!0)),r.geometry.addAttribute("endColor",new Q.BufferAttribute(new Float32Array(3*r.PARTICLE_COUNT),3).setDynamic(!0)),r.geometry.addAttribute("startTime",new Q.BufferAttribute(new Float32Array(r.PARTICLE_COUNT),1).setDynamic(!0)),r.geometry.addAttribute("size",new Q.BufferAttribute(new Float32Array(r.PARTICLE_COUNT),1).setDynamic(!0)),r.geometry.addAttribute("lifeTime",new Q.BufferAttribute(new Float32Array(r.PARTICLE_COUNT),1).setDynamic(!0)),r.particleSystem=new Q.Points(r.geometry,r.material),r.particleSystem.frustumCulled=!1,r.add(r.particleSystem),r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"geometryUpdate",value:function(){var e=this;!0===this.particleUpdate&&(this.particleUpdate=!1,Pe.forEach(function(t){var r=e.geometry.getAttribute(t);e.offset+e.count<e.PARTICLE_COUNT?(r.updateRange.offset=e.offset*r.itemSize,r.updateRange.count=e.count*r.itemSize):(r.updateRange.offset=0,r.updateRange.count=-1),r.needsUpdate=!0}),this.offset=0,this.count=0)}},{key:"random",value:function(){return++this.i>=this.rand.length?this.rand[this.i=1]:this.rand[this.i]}},{key:"update",value:function(e){this.time=e/1e3,this.material.uniforms.uTime.value=this.time,this.onTick&&this.onTick(this,this.time),this.geometryUpdate()}},{key:"dispose",value:function(){this.material.dispose(),this.sprite.dispose(),this.geometry.dispose()}},{key:"updateSprite",value:function(e){if(e){var t=this.sprite;this.sprite=e,this.sprite.wrapS=this.sprite.wrapT=Q.RepeatWrapping,this.material.uniforms.tSprite.value=e,t&&t.dispose()}}},{key:"spawnParticle",value:function(e){var t=new Q.Vector3,r=new Q.Vector3,n=new Q.Vector3,i=new Q.Color,a=new Q.Color,s=this.geometry.getAttribute("positionStart"),o=this.geometry.getAttribute("startTime"),c=this.geometry.getAttribute("velocity"),u=this.geometry.getAttribute("acceleration"),l=this.geometry.getAttribute("color"),h=this.geometry.getAttribute("endColor"),p=this.geometry.getAttribute("size"),d=this.geometry.getAttribute("lifeTime");t=void 0!==(e=e||{}).position?t.copy(e.position):t.set(0,0,0),r=void 0!==e.velocity?r.copy(e.velocity):r.set(0,0,0),n=void 0!==e.acceleration?n.copy(e.acceleration):n.set(0,0,0),i=void 0!==e.color?i.copy(e.color):i.set(16777215),a=void 0!==e.endColor?a.copy(e.endColor):a.copy(i);var f=void 0!==e.lifetime?e.lifetime:5,v=void 0!==e.size?e.size:10,m=void 0!==e.sizeRandomness?e.sizeRandomness:0;void 0!==this.DPR&&(v*=this.DPR);var y=this.PARTICLE_CURSOR;s.array[3*y+0]=t.x,s.array[3*y+1]=t.y,s.array[3*y+2]=t.z,c.array[3*y+0]=r.x,c.array[3*y+1]=r.y,c.array[3*y+2]=r.z,u.array[3*y+0]=n.x,u.array[3*y+1]=n.y,u.array[3*y+2]=n.z,l.array[3*y+0]=i.r,l.array[3*y+1]=i.g,l.array[3*y+2]=i.b,h.array[3*y+0]=a.r,h.array[3*y+1]=a.g,h.array[3*y+2]=a.b,p.array[y]=v+this.random()*m,d.array[y]=f,o.array[y]=this.time+.02*this.random(),0===this.offset&&(this.offset=this.PARTICLE_CURSOR),this.count++,this.PARTICLE_CURSOR++,this.PARTICLE_CURSOR>=this.PARTICLE_COUNT&&(this.PARTICLE_CURSOR=0),this.particleUpdate=!0}}]),t}(Q.Object3D),Re=function(e,t){return Math.random()*(t-e)+e},Le=0,Ie=function(e){function t(){return Object(o.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create cube w/ missing parent");return B(e,e.createObject({type:_e.particles,title:"particles "+Le++,visible:!0,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,children:e.createArray(),pointSize:10,lifetime:3,startColor:"#ff0000",endColor:"#0000ff",parent:t.id,texture:qe.id}))}},{key:"makeNode",value:function(e,t){var r={velocity:new Q.Vector3(0,1,0),position:new Q.Vector3(0,0,0),size:e.pointSize,lifetime:e.lifetime,color:new Q.Color(1,0,1),endColor:new Q.Color(0,1,1)},n=new De({maxParticles:1e4,position:new Q.Vector3(0,0,0),positionRandomness:0,baseVelocity:new Q.Vector3(0,0,-1),velocity:new Q.Vector3(0,0,0),velocityRandomness:1,acceleration:new Q.Vector3(0,0,0),baseColor:new Q.Color(1,1,.5),color:new Q.Color(1,0,0),colorRandomness:.5,lifetime:3,size:10,sizeRandomness:1,blending:Q.AdditiveBlending,onTick:function(e,t){r.velocity.set(Re(-1,1),1,Re(-1,1)),e.spawnParticle(r)}});return n.tick=function(e){n.update(e.time)},this.attachTexture(n,e,t),n.userData.options=r,n.name=e.title,n.userData.clickable=!1,n.position.set(e.tx,e.ty,e.tz),n.rotation.set(e.rx,e.ry,e.rz),n.scale.set(e.sx,e.sy,e.sz),n.visible=e.visible,n}},{key:"updateProperty",value:function(e,r,n,i){return n.name===Je.pointSize.key?e.userData.options.size=r.pointSize:n.name===Je.lifetime.key?e.userData.options.lifetime=r.lifetime:n.name===Je.startColor.key?e.userData.options.color.set(r.startColor):n.name===Je.endColor.key?e.userData.options.endColor.set(r.endColor):n.name===Je.texture.key?this.attachTexture(e,r,i):Object(p.a)(Object(l.a)(t.prototype),"updateProperty",this).call(this,e,r,n,i)}},{key:"attachTexture",value:function(e,t,r){if(t.asset!==qe.id){var n=r.accessObject(t.texture);if(n.exists()){var i=r.assetsManager.getAssetURL(n);r.getLogger().log("ParticlesDef: loading the asset url",i);var a=(new Q.TextureLoader).load(i);e.updateSprite(a)}}else e.updateSprite(null)}}]),t}(fe),Te={uniforms:{color:{type:"c",value:null},tDiffuse:{type:"t",value:null},textureMatrix:{type:"m4",value:null}},vertexShader:["uniform mat4 textureMatrix;","varying vec4 vUv;","void main() {","   vUv = textureMatrix * vec4( position, 1.0 );","   gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform vec3 color;","uniform sampler2D tDiffuse;","varying vec4 vUv;","float blendOverlay( float base, float blend ) {","   return( base < 0.5 ? ( 2.0 * base * blend ) : ( 1.0 - 2.0 * ( 1.0 - base ) * ( 1.0 - blend ) ) );","}","vec3 blendOverlay( vec3 base, vec3 blend ) {","   return vec3( blendOverlay( base.r, blend.r ), blendOverlay( base.g, blend.g ), blendOverlay( base.b, blend.b ) );","}","void main() {","   vec4 base = texture2DProj( tDiffuse, vUv );","   gl_FragColor = vec4( blendOverlay( base.rgb, color ), 1.0 );","}"].join("\n")},Ne=function(e){function t(e){var r;Object(o.a)(this,t);e.childrenMode;var n=void 0!==e.color?new Q.Color(e.color):new Q.Color(16777215),i=void 0!==e.clear?new Q.Color(e.clear):new Q.Color(16711680),a=e.textureWidth||512,s=e.textureHeight||512,c=e.clipBias||0,h=Te,p=void 0!==e.recursion?e.recursion:1,f=new Q.Plane,v=new Q.Vector3,m=new Q.Vector3,y=new Q.Vector3,g=new Q.Matrix4,b=(new Q.Vector3(0,0,-1),new Q.Vector4),w=new Q.Vector4,O=new Q.Vector3,k=(new Q.Vector3,new Q.Vector4),A=new Q.Vector2,S=new Q.Matrix4,x=new Q.PerspectiveCamera,M={minFilter:Q.LinearFilter,magFilter:Q.LinearFilter,format:Q.RGBFormat,stencilBuffer:!1},C=new Q.WebGLRenderTarget(a,s,M);Q.Math.isPowerOfTwo(a)&&Q.Math.isPowerOfTwo(s)||(C.texture.generateMipmaps=!1);var j=new Q.ShaderMaterial({side:Q.DoubleSide,uniforms:Q.UniformsUtils.clone(h.uniforms),fragmentShader:h.fragmentShader,vertexShader:h.vertexShader});j.uniforms.tDiffuse.value=C.texture,j.uniforms.color.value=n,j.uniforms.textureMatrix.value=S;var E=new Q.PlaneBufferGeometry(e.width,e.height);r=Object(u.a)(this,Object(l.a)(t).call(this,E,j));var P=new Q.Scene,D=new Q.PointLight(16777215,1,1e3);D.intensity=2;var R=new Q.DirectionalLight;P.add(D),P.add(R);var L=Object(d.a)(Object(d.a)(r)),I=Object(d.a)(Object(d.a)(r));return I.renderer=I.camera=0,I.onBeforeRender=function(e,t,r){I.renderer=e,I.camera=r},I.repaint=function(){var e=I.renderer,t=I.camera;if(e&&t){if("recursion"in t.userData){if(t.userData.recursion===p)return;t.userData.recursion++}m.setFromMatrixPosition(I.matrixWorld),y.setFromMatrixPosition(t.matrixWorld),O.subVectors(m,y),g.extractRotation(I.matrixWorld);var r=O.dot(v)<0?1:-1;v.set(0,0,r),v.applyMatrix4(g),x=t.clone();var n=g.getInverse(I.matrixWorld);x.applyMatrix(n),x.userData.recursion=0,S.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),S.multiply(x.projectionMatrix),S.multiply(x.matrixWorldInverse),S.multiply(I.matrixWorld),f.setFromNormalAndCoplanarPoint(v,m),f.applyMatrix4(x.matrixWorldInverse),b.set(f.normal.x,f.normal.y,f.normal.z,f.constant);var a=x.projectionMatrix;k.x=(Math.sign(b.x)+a.elements[8])/a.elements[0],k.y=(Math.sign(b.y)+a.elements[9])/a.elements[5],k.z=-1,k.w=(1+a.elements[10])/a.elements[14],b.multiplyScalar(2/b.dot(k)),a.elements[2]=b.x,a.elements[6]=b.y,a.elements[10]=b.z+1-c,a.elements[14]=b.w,L.children.slice().forEach(function(e){L.remove(e),P.add(e),e.visible=!0});var s=e.getRenderTarget(),o=e.vr.enabled,u=e.shadowMap.autoUpdate,l=e.getClearColor(),h=e.getClearAlpha();e.vr.enabled=!1,e.shadowMap.autoUpdate=!1,e.setRenderTarget(C),e.setClearColor(i),e.setClearAlpha(0),e.clear(),e.render(P,x),e.setClearColor(l,h),e.setClearAlpha(h),e.vr.enabled=o,e.shadowMap.autoUpdate=u,e.setRenderTarget(s),P.children.slice().forEach(function(e){P.remove(e),L.add(e),e.visible=!1});var d=t.bounds;if(void 0!==d){e.getSize(A);var M=e.getPixelRatio();w.x=d.x*A.width*M,w.y=d.y*A.height*M,w.z=d.z*A.width*M,w.w=d.w*A.height*M,e.state.viewport(w)}}},r}return Object(h.a)(t,e),t}(Q.Mesh),Ge=0,Be=function(e){function t(){return Object(o.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create portal w/ missing parent");return B(e,e.createObject({type:_e.portal,title:"portal "+Ge++,visible:!0,width:1,height:2,depth:.1,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,clipBias:.001,recursion:1,textureWidth:512,textureHeight:512,color:"#00ffff",clear:"#ff0000",children:e.createArray(),transparent:!1,parent:t.id}))}},{key:"makeNode",value:function(e,t){var r=new Ne({width:e.width||1,height:e.height||1,clipBias:.001,textureWidth:512,textureHeight:512,color:e.color||"purple",clear:e.clear||"red",recursion:1});return r.name=e.title,r.userData.clickable=!0,r.position.set(e.tx,e.ty,e.tz),r.rotation.set(e.rx,e.ry,e.rz),r.scale.set(e.sx,e.sy,e.sz),r.visible=e.visible,r.tick=function(e){r.repaint()},r}},{key:"updateProperty",value:function(e,r,n,i){return Object(p.a)(Object(l.a)(t.prototype),"updateProperty",this).call(this,e,r,n,i)}}]),t}(fe),Fe=0,Ue=function(e){function t(){return Object(o.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't localanchor w/ missing parent");return B(e,e.createObject({type:_e.localanchor,title:"localanchor "+Fe++,visible:!0,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,color:"#00ff00",children:e.createArray(),recType:pt.SCENE_START,parent:t.id}))}},{key:"makeNode",value:function(e,t){var r=new Q.Group;r.name=e.title,r.userData.clickable=!0,r.position.set(e.tx,e.ty,e.tz),r.rotation.set(e.rx,e.ry,e.rz),r.scale.set(e.sx,e.sy,e.sz),r.visible=!0;var n=new Q.Mesh(new Q.SphereBufferGeometry(1),new Q.MeshLambertMaterial({color:"green",transparent:!0,opacity:.2}));return n.material.visible=!0,n.userData.clickable=!0,r.userData.clicker=n,r.add(n),r.enter=function(t,i){n.visible=!1,r.visible=!0,r.userData.info={recType:e.recType,object:e,node:r,callback:function(e){r.visible=!0}},i.sgp.startLocalAnchor(r.userData.info)},r.exit=function(e,t){n.visible=!0,t.sgp.stopLocalAnchor(r.userData.info)},r}},{key:"updateProperty",value:function(e,r,n,i){return Object(p.a)(Object(l.a)(t.prototype),"updateProperty",this).call(this,e,r,n,i)}}]),t}(fe),ze=0,He=function(e){function t(){return Object(o.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't imageanchor w/ missing parent");return B(e,e.createObject({type:_e.imageanchor,title:"image anchor "+ze++,visible:!0,reactivate:!1,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,color:"#00ff00",children:e.createArray(),targetImage:null,imageRealworldWidth:1,recType:pt.SCENE_START,parent:t.id}))}},{key:"makeNode",value:function(e,t){var r=new Q.Group;r.name=e.title,r.userData.clickable=!0,r.position.set(e.tx,e.ty,e.tz),r.rotation.set(e.rx,e.ry,e.rz),r.scale.set(e.sx,e.sy,e.sz),r.visible=e.visible;var n=new Q.Mesh(new Q.SphereBufferGeometry(1),new Q.MeshLambertMaterial({color:"red",transparent:!0,opacity:.2}));n.material.visible=!0,n.userData.clickable=!0,r.userData.clicker=n,r.add(n);var i=new Q.Mesh(new Q.PlaneBufferGeometry(1,1),new Q.MeshLambertMaterial({color:"white",transparent:!0,opacity:.5,side:Q.DoubleSide}));return i.rotation.x=st(90),r.add(i),r.userData.preview=i,this.updateImagePreview(r,e,t),r.enter=function(t,a){n.visible=!1,r.visible=!1,i.visible=!1,r.userData.info={image:a.sgp.getGraphObjectById(e.targetImage),imageRealworldWidth:e.imageRealworldWidth,reactivate:e.reactivate,recType:e.recType,object:e,node:r,callback:function(t){a.fireEventAtTarget(e,"recognized",t),r.visible=!0}},a.sgp.startImageRecognizer(r.userData.info)},r.exit=function(e,t){n.visible=!0,i.visible=!0,t.sgp.stopImageRecognizer(r.userData.info)},r}},{key:"updateProperty",value:function(e,r,n,i){return n.name===Je.targetImage.key?this.updateImagePreview(e,r,i):n.name===Je.imageRealworldWidth.key?this.updateImagePreview(e,r,i):Object(p.a)(Object(l.a)(t.prototype),"updateProperty",this).call(this,e,r,n,i)}},{key:"updateImagePreview",value:function(e,t,r){var n=r.accessObject(t.targetImage);if(n.exists()){var i=r.assetsManager.getAssetURL(n);r.getLogger().log("ImageAnchor loading the asset url",i);var a=(new Q.TextureLoader).load(i);e.userData.preview.material=new Q.MeshLambertMaterial({color:"white",transparent:!0,opacity:.5,side:Q.DoubleSide,map:a});var s=n.height/n.width;e.userData.preview.geometry=new Q.PlaneBufferGeometry(1,s);var o=t.imageRealworldWidth;e.userData.preview.scale.set(o,o,o)}r.accessObject(t.targetImage).exists()?(e.userData.preview.visible=!0,e.userData.clicker.visible=!1):(e.userData.preview.visible=!1,e.userData.clicker.visible=!0)}}]),t}(fe),We=0,Ve=function(e){function t(){return Object(o.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create geo anchor w/ missing parent");return B(e,e.createObject({type:_e.geoanchor,title:"geo anchor "+We++,visible:!0,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,color:"#00ff00",children:e.createArray(),targetGeoLocation:null,recType:pt.SCENE_START,parent:t.id}))}},{key:"makeNode",value:function(e){var t=new Q.Group;t.name=e.title,t.userData.clickable=!0,t.position.set(e.tx,e.ty,e.tz),t.rotation.set(e.rx,e.ry,e.rz),t.scale.set(e.sx,e.sy,e.sz),t.visible=e.visible;var r=new Q.Mesh(new Q.SphereBufferGeometry(1),new Q.MeshLambertMaterial({color:"red",transparent:!0,opacity:.2}));return r.material.visible=!0,r.userData.clickable=!0,t.userData.clicker=r,t.add(r),t.enter=function(n,i){r.visible=!1,t.visible=!1,t.userData.info={location:i.sgp.getGraphObjectById(e.targetGeoLocation),recType:e.recType,object:e,node:t,callback:function(r){i.fireEventAtTarget(e,"localized",r),t.visible=!0}},i.sgp.startGeoTracker(t.userData.info)},t.exit=function(e,n){r.visible=!0,n.sgp.stopGeoTracker(t.userData.info)},t}}]),t}(fe),Ye=0,Xe=function(e){function t(){return Object(o.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't add hudanchor w/ missing parent");return B(e,e.createObject({type:_e.hudanchor,title:"hud anchor "+Ye++,visible:!0,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,children:e.createArray(),parent:t.id}))}},{key:"makeNode",value:function(e,t){var r=new Q.Group;r.name=e.title,r.userData.clickable=!0,r.position.set(e.tx,e.ty,e.tz),r.rotation.set(e.rx,e.ry,e.rz),r.scale.set(e.sx,e.sy,e.sz),r.visible=e.visible;var n=new Q.Mesh(new Q.SphereBufferGeometry(1),new Q.MeshLambertMaterial({color:"red",transparent:!0,opacity:.2}));return n.material.visible=!0,n.userData.clickable=!0,r.userData.clicker=n,r.add(n),r.enter=function(e,t){r.parent.remove(r),r.position.z=0,n.visible=!1,t.sgp.getCamera().add(r)},r.exit=function(t,i){i.sgp.getCamera().remove(r),n.visible=!0,i.sgp.getThreeObject(e.parent).add(r),r.position.set(e.tx,e.ty,e.tz),r.rotation.set(e.rx,e.ry,e.rz),r.scale.set(e.sx,e.sy,e.sz)},r}},{key:"updateProperty",value:function(e,r,n,i){return Object(p.a)(Object(l.a)(t.prototype),"updateProperty",this).call(this,e,r,n,i)}}]),t}(fe),Ze=0,Ke=function(e){function t(){return Object(o.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(c.a)(t,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create cube w/ missing parent");return B(e,e.createObject({type:_e.clone,title:"clone "+Ze++,visible:!0,tx:0,ty:0,tz:0,rx:0,ry:0,rz:0,sx:1,sy:1,sz:1,children:e.createArray(),cloneTarget:qe.id,parent:t.id}))}},{key:"makeNode",value:function(e,t){var r=new Q.Group;r.name=e.title;var n=new Q.Mesh(new Q.SphereBufferGeometry(1),new Q.MeshLambertMaterial({color:"red",transparent:!0,opacity:.2}));return n.material.visible=!0,n.userData.clickable=!0,r.userData.clicker=n,r.add(r.userData.clicker),r.position.set(e.tx,e.ty,e.tz),r.rotation.set(e.rx,e.ry,e.rz),r.scale.set(e.sx,e.sy,e.sz),r.visible=e.visible,r.enter=function(t,i){n.visible=!1;var a=i.sgp.getGraphObjectById(e.cloneTarget),s=i.sgp.getThreeObject(a).clone();r.add(s),r.userData.theClone=s,r.userData.cloneTarget=a,r.userData.theClone.enter&&r.userData.theClone.enter(t,i),r.userData.cloneTarget.find(function(r){return i.fireSceneLifecycleEventAtChild("enter",t,r,e.id)})},r.tick=function(t,n){r.userData.theClone.tick&&r.userData.theClone.tick(t,n),r.userData.cloneTarget.find(function(r){return n.fireSceneLifecycleEventAtChild("tick",t,r,e.id)})},r.exit=function(t,i){r.userData.theClone.exit&&r.userData.theClone.exit(t,i),r.userData.cloneTarget.find(function(r){return i.fireSceneLifecycleEventAtChild("exit",t,r,e.id)}),n.visible=!0,r.remove(r.userData.theClone),r.userData.theClone=null},r}}]),t}(fe),qe={id:-30,title:"NONE"},Qe={incrementValue:.1},Je={title:{key:"title",name:"Title",type:x.d.STRING},description:{key:"description",name:"Description",type:x.d.STRING},width:{key:"width",name:"Width",type:x.d.NUMBER,hints:Qe},height:{key:"height",name:"Height",type:x.d.NUMBER,hints:Qe},depth:{key:"depth",name:"Depth",type:x.d.NUMBER,hints:Qe},radius:{key:"radius",name:"Radius",type:x.d.NUMBER,hints:Qe},tx:{key:"tx",name:"TX",type:x.d.NUMBER,hints:Qe},ty:{key:"ty",name:"TY",type:x.d.NUMBER,hints:Qe},tz:{key:"tz",name:"TZ",type:x.d.NUMBER,hints:Qe},rx:{key:"rx",name:"RX",type:x.d.NUMBER,hints:Qe},ry:{key:"ry",name:"RY",type:x.d.NUMBER,hints:Qe},rz:{key:"rz",name:"RZ",type:x.d.NUMBER,hints:Qe},sx:{key:"sx",name:"SX",type:x.d.NUMBER,hints:Qe},sy:{key:"sy",name:"SY",type:x.d.NUMBER,hints:Qe},sz:{key:"sz",name:"SZ",type:x.d.NUMBER,hints:Qe},color:{key:"color",name:"Color",type:x.d.COLOR,custom:!0},defaultFloor:{key:"defaultFloor",name:"Default Floor",type:x.d.BOOLEAN},src:{key:"src",name:"src",type:x.d.STRING,locked:!0},asset:{key:"asset",name:"asset",type:x.d.ENUM},subtype:{key:"subtype",name:"kind",type:x.d.STRING,locked:!0},format:{key:"format",name:"format",type:x.d.STRING,locked:!0},imageOffsetAngle:{key:"imageOffsetAngle",name:"Image Offset Angle",type:x.d.NUMBER,hints:{incrementValue:.05}},imageCropStartAngle:{key:"imageCropStartAngle",name:"Image Crop Start Angle",type:x.d.NUMBER,hints:{incrementValue:.05}},imageCropEndAngle:{key:"imageCropEndAngle",name:"Image Crop End Angle",type:x.d.NUMBER,hints:{incrementValue:.05}},transparent:{key:"transparent",name:"Transparent",type:x.d.BOOLEAN},imageRealworldWidth:{key:"imageRealworldWidth",name:"Image width in meters",type:x.d.NUMBER,hints:{incrementValue:.01}},recType:{key:"recType",name:"Recognition Type",type:x.d.ENUM},targetImage:{key:"targetImage",name:"Image to Recognize",type:x.d.ENUM},targetGeoLocation:{key:"targetGeoLocation",name:"Target Location",type:x.d.ENUM},splashImage:{key:"splashImage",name:"Splash Image",type:x.d.ENUM},text:{key:"text",name:"Text",type:x.d.STRING,hints:{multiline:!0}},fontSize:{key:"fontSize",name:"Font Size",type:x.d.NUMBER},padding:{key:"padding",name:"Padding",type:x.d.NUMBER},borderWidth:{key:"borderWidth",name:"Border width",type:x.d.NUMBER},borderRadius:{key:"borderRadius",name:"Corner Size",type:x.d.NUMBER},horizontalAlign:{key:"horizontalAlign",name:"H Align",type:x.d.ENUM,locked:!1},textColor:{key:"textColor",name:"Text Color",type:x.d.COLOR,custom:!0},backgroundColor:{key:"backgroundColor",name:"BG Color",type:x.d.COLOR,custom:!0},borderColor:{key:"borderColor",name:"Border Color",type:x.d.COLOR,custom:!0},startColor:{key:"startColor",name:"Start",type:x.d.COLOR,custom:!0},endColor:{key:"endColor",name:"End",type:x.d.COLOR,custom:!0},drawBackground:{key:"drawBackground",name:"BG?",type:x.d.BOOLEAN},scriptBody:{key:"scriptBody",name:"code",type:x.d.STRING,hints:{multiline:!0}},defaultScene:{key:"defaultScene",name:"Start Scene",type:x.d.ENUM},visible:{key:"visible",name:"Visible",type:x.d.BOOLEAN},reactivate:{key:"reactivate",name:"Reactivate Image Search",type:x.d.BOOLEAN},pointSize:{key:"pointSize",name:"Point Size",type:x.d.NUMBER},lifetime:{key:"lifetime",name:"Lifetime",type:x.d.NUMBER,hints:Qe},texture:{key:"texture",name:"texture",type:x.d.ENUM},cssStyle:{key:"cssStyle",name:"Style",type:x.d.STRING,hints:{multiline:!0}},latitude:{key:"latitude",name:"Latitude",type:x.d.NUMBER},longitude:{key:"longitude",name:"Longitude",type:x.d.NUMBER},altitude:{key:"altitude",name:"altitude",type:x.d.NUMBER},useAltitude:{key:"useAltitude",name:"use altitude?",type:x.d.BOOLEAN},autoRecenter:{key:"autoRecenter",name:"Recenter on Load",type:x.d.BOOLEAN},cloneTarget:{key:"cloneTarget",name:"clone target",type:x.d.ENUM}},$e=["#ffffff","#ff0000","#ffff00","#00ff00","#00ffff","#0000ff","#ff00ff","#000000"],_e={cube:"cube",sphere:"sphere",plane:"plane",model:"model",bg360:"bg360",text:"text",img2d:"img2d",group:"group",particles:"particles",portal:"portal",localanchor:"localanchor",imageanchor:"imageanchor",geoanchor:"geoanchor",hudanchor:"hudanchor",clone:"clone"},et={SCENE:"scene",ASSET:"asset",BEHAVIOR:"behavior",BEHAVIOR_SCRIPT:"behavior_script",ASSETS_LIST:"assets",BEHAVIORS_LIST:"behaviors",ROOT:"root"},tt={LEFT:"LEFT",CENTER:"CENTER",RIGHT:"RIGHT"};function rt(e){return e===_e.cube||(e===_e.sphere||(e===_e.plane||(e===_e.model||(e===_e.text||(e===_e.bg360||(e===_e.img2d||(e===_e.group||(e===_e.particles||(e===_e.portal||(e===_e.localanchor||(e===_e.imageanchor||(e===_e.geoanchor||(e===_e.hudanchor||e===_e.clone)))))))))))))}function nt(e){return e===_e.group||(e===_e.portal||(e===_e.localanchor||(e===_e.imageanchor||(e===_e.geoanchor||(e===_e.hudanchor||e===et.SCENE)))))}function it(e){return e!==et.ROOT&&(e!==et.ASSETS_LIST&&e!==et.BEHAVIORS_LIST)}function at(e){if(e===_e.cube)return new me;if(e===_e.sphere)return new ge;if(e===_e.plane)return new be;if(e===_e.model)return new ke;if(e===_e.bg360)return new Ae;if(e===_e.text)return new xe;if(e===_e.img2d)return new Me;if(e===_e.group)return new je;if(e===_e.particles)return new Ie;if(e===_e.portal)return new Be;if(e===_e.localanchor)return new Ue;if(e===_e.imageanchor)return new He;if(e===_e.geoanchor)return new Ve;if(e===_e.hudanchor)return new Xe;if(e===_e.clone)return new Ke;throw new Error("unknown 3d object type ".concat(e))}var st=function(e){return e*Math.PI/180},ot={PNG:"image/png",JPEG:"image/jpeg",GIF:"image/gif",MP3:"audio/mpeg",AAC:"audio/aac",WAV:"audio/wav",JAVASCRIPT:"text/javascript",GLB:"model/gltf-binary",MP4:"video/mp4",MOV:"video/quicktime"},ct={BEHAVIOR:"behavior",IMAGE:"image",GLTF:"gltf",AUDIO:"audio",VIDEO:"video",GEOLOCATION:"geolocation"};function ut(e){return!!e&&(e.toLowerCase()===ot.PNG||(e.toLowerCase()===ot.JPEG||e.toLowerCase()===ot.GIF))}var lt={plane:"fa fa-plane",cube:"fa fa-square",sphere:"fa fa-circle",model:"fa fa-cube",asset:"fa fa-file",assets:"fa fa-archive",behavior:"fab fa-superpowers",behavior_script:"fab fa-superpowers",scene:"fa fa-globe",bg360:"fa fa-image",img2d:"fa fa-image",image:"fa fa-file-image",text:"fa fa-font",audio:"fa fa-file-audio",video:"fas fa-file-video",group:"fa fa-object-group",particles:"fa fa-certificate",portal:"fa fa-object-group",gltf:"fa fa-cube",localanchor:"fa fa-anchor",imageanchor:"fa fa-anchor",geoanchor:"fa fa-globe",geolocation:"fas fa-globe-americas",hudanchor:"fa fa-eye",cut:"fa fa-cut",copy:"fa fa-copy",paste:"fa fa-paste",delete:"fa fa-close"};function ht(e){return Function('"use strict";\n    const toRadians = (deg) => Math.PI/180*deg; \n    return('.concat(e,")"))()}var pt={SCENE_START:"SCENE_START"};var dt=function(){function e(){Object(o.a)(this,e)}return Object(c.a)(e,[{key:"make",value:function(e,t){if(!t.id)throw new Error("can't create scene w/ missing parent");return B(e,function(e,t){return e.createObject(t)}(e,{type:"scene",title:function e(t,r,n){var i=t+" "+r;return n.getChildren().find(function(e){return e.title===i})?e(t,r+1,n):i}("Scene ",0,t),autoRecenter:!0,defaultFloor:!1,parent:t.id,children:e.createArray()}))}},{key:"makeNode",value:function(e,t){var r=new Q.Group;return r.name=e.title,this.setDefaultFloor(r,e.defaultFloor),r.start=function(){r.userData.sceneAnchor=new Q.Group,r.userData.sceneAnchor.name="SceneAnchor",r.children.slice().forEach(function(e){var n,i=t.accessObject(e.userData.graphid);i.exists()&&((n=i.type)!==_e.geoanchor&&n!==_e.localanchor&&n!==_e.imageanchor&&n!==_e.hudanchor&&i.type!==_e.geoanchor&&i.type!==_e.localanchor&&i.type!==_e.imageanchor&&i.type!==_e.hudanchor&&r.userData.sceneAnchor.add(e))}),r.add(r.userData.sceneAnchor)},r.stop=function(){r.userData.sceneAnchor.children.slice().forEach(function(e){return r.add(e)}),r.remove(r.userData.sceneAnchor)},r}},{key:"updateProperty",value:function(e,t,r,n){console.log("update property",e.name,r.name,r.value),r.name===Je.defaultFloor.key&&(console.log("setting the floor too",r.value),this.setDefaultFloor(e,r.value))}},{key:"setDefaultFloor",value:function(e,t){if(!0===t){var r=new Q.Mesh(new Q.PlaneBufferGeometry(100,100,10,10),new Q.MeshLambertMaterial({color:"blue"}));r.name="defaultFloor",r.rotation.x=-90*Math.PI/180,e.parts={},e.parts.floor=r,e.add(r)}else e.parts&&e.parts.floor&&(e.remove(e.parts.floor),delete e.parts.floor)}},{key:"getFloorPart",value:function(e){return e&&e.parts?e.parts.floor:null}}]),e}(),ft=r(1),vt=function(){function e(e){this.manager=void 0!==e?e:ft.DefaultLoadingManager,this.dracoLoader=null}function t(){var e={};return{get:function(t){return e[t]},add:function(t,r){e[t]=r},remove:function(t){delete e[t]},removeAll:function(){e={}}}}e.prototype={constructor:e,crossOrigin:"anonymous",load:function(e,t,r,n){var i,a=this;i=void 0!==this.resourcePath?this.resourcePath:void 0!==this.path?this.path:ft.LoaderUtils.extractUrlBase(e),a.manager.itemStart(e);var s=function(t){n?n(t):console.error(t),a.manager.itemError(e),a.manager.itemEnd(e)},o=new ft.FileLoader(a.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.load(e,function(r){try{a.parse(r,i,function(r){t(r),a.manager.itemEnd(e)},s)}catch(n){s(n)}},r,s)},setCrossOrigin:function(e){return this.crossOrigin=e,this},setPath:function(e){return this.path=e,this},setResourcePath:function(e){return this.resourcePath=e,this},setDRACOLoader:function(e){return this.dracoLoader=e,this},parse:function(e,t,o,c){var d,f={};if("string"===typeof e)d=e;else if(ft.LoaderUtils.decodeText(new Uint8Array(e,0,4))===s){try{f[r.KHR_BINARY_GLTF]=new u(e)}catch(b){return void(c&&c(b))}d=f[r.KHR_BINARY_GLTF].content}else d=ft.LoaderUtils.decodeText(new Uint8Array(e));var v=JSON.parse(d);if(void 0===v.asset||v.asset.version[0]<2)c&&c(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported. Use LegacyGLTFLoader instead."));else{if(v.extensionsUsed)for(var m=0;m<v.extensionsUsed.length;++m){var y=v.extensionsUsed[m],g=v.extensionsRequired||[];switch(y){case r.KHR_LIGHTS_PUNCTUAL:f[y]=new i(v);break;case r.KHR_MATERIALS_UNLIT:f[y]=new a(v);break;case r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:f[y]=new p(v);break;case r.KHR_DRACO_MESH_COMPRESSION:f[y]=new l(v,this.dracoLoader);break;case r.MSFT_TEXTURE_DDS:f[r.MSFT_TEXTURE_DDS]=new n;break;case r.KHR_TEXTURE_TRANSFORM:f[r.KHR_TEXTURE_TRANSFORM]=new h(v);break;default:g.indexOf(y)>=0&&console.warn('THREE.GLTFLoader: Unknown extension "'+y+'".')}}new F(v,f,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,manager:this.manager}).parse(o,c)}}};var r={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",MSFT_TEXTURE_DDS:"MSFT_texture_dds"};function n(){if(!ft.DDSLoader)throw new Error("THREE.GLTFLoader: Attempting to load .dds texture without importing THREE.DDSLoader");this.name=r.MSFT_TEXTURE_DDS,this.ddsLoader=new ft.DDSLoader}function i(e){this.name=r.KHR_LIGHTS_PUNCTUAL;var t=e.extensions&&e.extensions[r.KHR_LIGHTS_PUNCTUAL]||{};this.lightDefs=t.lights||[]}function a(){this.name=r.KHR_MATERIALS_UNLIT}i.prototype.loadLight=function(e){var t,r=this.lightDefs[e],n=new ft.Color(16777215);void 0!==r.color&&n.fromArray(r.color);var i=void 0!==r.range?r.range:0;switch(r.type){case"directional":(t=new ft.DirectionalLight(n)).target.position.set(0,0,-1),t.add(t.target);break;case"point":(t=new ft.PointLight(n)).distance=i;break;case"spot":(t=new ft.SpotLight(n)).distance=i,r.spot=r.spot||{},r.spot.innerConeAngle=void 0!==r.spot.innerConeAngle?r.spot.innerConeAngle:0,r.spot.outerConeAngle=void 0!==r.spot.outerConeAngle?r.spot.outerConeAngle:Math.PI/4,t.angle=r.spot.outerConeAngle,t.penumbra=1-r.spot.innerConeAngle/r.spot.outerConeAngle,t.target.position.set(0,0,-1),t.add(t.target);break;default:throw new Error('THREE.GLTFLoader: Unexpected light type, "'+r.type+'".')}return t.position.set(0,0,0),t.decay=2,void 0!==r.intensity&&(t.intensity=r.intensity),t.name=r.name||"light_"+e,Promise.resolve(t)},a.prototype.getMaterialType=function(){return ft.MeshBasicMaterial},a.prototype.extendParams=function(e,t,r){var n=[];e.color=new ft.Color(1,1,1),e.opacity=1;var i=t.pbrMetallicRoughness;if(i){if(Array.isArray(i.baseColorFactor)){var a=i.baseColorFactor;e.color.fromArray(a),e.opacity=a[3]}void 0!==i.baseColorTexture&&n.push(r.assignTexture(e,"map",i.baseColorTexture))}return Promise.all(n)};var s="glTF",o=12,c={JSON:1313821514,BIN:5130562};function u(e){this.name=r.KHR_BINARY_GLTF,this.content=null,this.body=null;var t=new DataView(e,0,o);if(this.header={magic:ft.LoaderUtils.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==s)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected. Use LegacyGLTFLoader instead.");for(var n=new DataView(e,o),i=0;i<n.byteLength;){var a=n.getUint32(i,!0);i+=4;var u=n.getUint32(i,!0);if(i+=4,u===c.JSON){var l=new Uint8Array(e,o+i,a);this.content=ft.LoaderUtils.decodeText(l)}else if(u===c.BIN){var h=o+i;this.body=e.slice(h,h+a)}i+=a}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}function l(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=r.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t}function h(){this.name=r.KHR_TEXTURE_TRANSFORM}function p(){return{name:r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,specularGlossinessParams:["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"],getMaterialType:function(){return ft.ShaderMaterial},extendParams:function(e,t,r){var n=t.extensions[this.name],i=ft.ShaderLib.standard,a=ft.UniformsUtils.clone(i.uniforms),s=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),o=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),c=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),u=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),l=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb;","material.specularRoughness = clamp( 1.0 - glossinessFactor, 0.04, 1.0 );","material.specularColor = specularFactor.rgb;"].join("\n"),h=i.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",s).replace("#include <metalnessmap_pars_fragment>",o).replace("#include <roughnessmap_fragment>",c).replace("#include <metalnessmap_fragment>",u).replace("#include <lights_physical_fragment>",l);delete a.roughness,delete a.metalness,delete a.roughnessMap,delete a.metalnessMap,a.specular={value:(new ft.Color).setHex(1118481)},a.glossiness={value:.5},a.specularMap={value:null},a.glossinessMap={value:null},e.vertexShader=i.vertexShader,e.fragmentShader=h,e.uniforms=a,e.defines={STANDARD:""},e.color=new ft.Color(1,1,1),e.opacity=1;var p=[];if(Array.isArray(n.diffuseFactor)){var d=n.diffuseFactor;e.color.fromArray(d),e.opacity=d[3]}if(void 0!==n.diffuseTexture&&p.push(r.assignTexture(e,"map",n.diffuseTexture)),e.emissive=new ft.Color(0,0,0),e.glossiness=void 0!==n.glossinessFactor?n.glossinessFactor:1,e.specular=new ft.Color(1,1,1),Array.isArray(n.specularFactor)&&e.specular.fromArray(n.specularFactor),void 0!==n.specularGlossinessTexture){var f=n.specularGlossinessTexture;p.push(r.assignTexture(e,"glossinessMap",f)),p.push(r.assignTexture(e,"specularMap",f))}return Promise.all(p)},createMaterial:function(e){var t=new ft.ShaderMaterial({defines:e.defines,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:e.uniforms,fog:!0,lights:!0,opacity:e.opacity,transparent:e.transparent});return t.isGLTFSpecularGlossinessMaterial=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=1,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t.refractionRatio=.98,t.extensions.derivatives=!0,t},cloneMaterial:function(e){var t=e.clone();t.isGLTFSpecularGlossinessMaterial=!0;for(var r=this.specularGlossinessParams,n=0,i=r.length;n<i;n++)t[r[n]]=e[r[n]];return t},refreshUniforms:function(e,t,r,n,i,a){if(!0===i.isGLTFSpecularGlossinessMaterial){var s,o=i.uniforms,c=i.defines;o.opacity.value=i.opacity,o.diffuse.value.copy(i.color),o.emissive.value.copy(i.emissive).multiplyScalar(i.emissiveIntensity),o.map.value=i.map,o.specularMap.value=i.specularMap,o.alphaMap.value=i.alphaMap,o.lightMap.value=i.lightMap,o.lightMapIntensity.value=i.lightMapIntensity,o.aoMap.value=i.aoMap,o.aoMapIntensity.value=i.aoMapIntensity,i.map?s=i.map:i.specularMap?s=i.specularMap:i.displacementMap?s=i.displacementMap:i.normalMap?s=i.normalMap:i.bumpMap?s=i.bumpMap:i.glossinessMap?s=i.glossinessMap:i.alphaMap?s=i.alphaMap:i.emissiveMap&&(s=i.emissiveMap),void 0!==s&&(s.isWebGLRenderTarget&&(s=s.texture),!0===s.matrixAutoUpdate&&s.updateMatrix(),o.uvTransform.value.copy(s.matrix)),i.envMap&&(o.envMap.value=i.envMap,o.envMapIntensity.value=i.envMapIntensity,o.flipEnvMap.value=i.envMap.isCubeTexture?-1:1,o.reflectivity.value=i.reflectivity,o.refractionRatio.value=i.refractionRatio,o.maxMipLevel.value=e.properties.get(i.envMap).__maxMipLevel),o.specular.value.copy(i.specular),o.glossiness.value=i.glossiness,o.glossinessMap.value=i.glossinessMap,o.emissiveMap.value=i.emissiveMap,o.bumpMap.value=i.bumpMap,o.normalMap.value=i.normalMap,o.displacementMap.value=i.displacementMap,o.displacementScale.value=i.displacementScale,o.displacementBias.value=i.displacementBias,null!==o.glossinessMap.value&&void 0===c.USE_GLOSSINESSMAP&&(c.USE_GLOSSINESSMAP="",c.USE_ROUGHNESSMAP=""),null===o.glossinessMap.value&&void 0!==c.USE_GLOSSINESSMAP&&(delete c.USE_GLOSSINESSMAP,delete c.USE_ROUGHNESSMAP)}}}}function d(e,t,r,n){ft.Interpolant.call(this,e,t,r,n)}l.prototype.decodePrimitive=function(e,t){var r=this.json,n=this.dracoLoader,i=e.extensions[this.name].bufferView,a=e.extensions[this.name].attributes,s={},o={},c={};for(var u in a){var l=M[u]||u.toLowerCase();s[l]=a[u]}for(u in e.attributes){l=M[u]||u.toLowerCase();if(void 0!==a[u]){var h=r.accessors[e.attributes[u]],p=k[h.componentType];c[l]=p,o[l]=!0===h.normalized}}return t.getDependency("bufferView",i).then(function(e){return new Promise(function(t){n.decodeDracoFile(e,function(e){for(var r in e.attributes){var n=e.attributes[r],i=o[r];void 0!==i&&(n.normalized=i)}t(e)},s,c)})})},h.prototype.extendTexture=function(e,t){return e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),void 0!==t.texCoord&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),e.needsUpdate=!0,e},d.prototype=Object.create(ft.Interpolant.prototype),d.prototype.constructor=d,d.prototype.copySampleValue_=function(e){for(var t=this.resultBuffer,r=this.sampleValues,n=this.valueSize,i=e*n*3+n,a=0;a!==n;a++)t[a]=r[i+a];return t},d.prototype.beforeStart_=d.prototype.copySampleValue_,d.prototype.afterEnd_=d.prototype.copySampleValue_,d.prototype.interpolate_=function(e,t,r,n){for(var i=this.resultBuffer,a=this.sampleValues,s=this.valueSize,o=2*s,c=3*s,u=n-t,l=(r-t)/u,h=l*l,p=h*l,d=e*c,f=d-c,v=-2*p+3*h,m=p-h,y=1-v,g=m-h+l,b=0;b!==s;b++){var w=a[f+b+s],O=a[f+b+o]*u,k=a[d+b+s],A=a[d+b]*u;i[b]=y*w+g*O+v*k+m*A}return i};var f,v=0,m=1,y=2,g=3,b=4,w=5,O=6,k=(Number,ft.Matrix3,ft.Matrix4,ft.Vector2,ft.Vector3,ft.Vector4,ft.Texture,{5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array}),A={9728:ft.NearestFilter,9729:ft.LinearFilter,9984:ft.NearestMipMapNearestFilter,9985:ft.LinearMipMapNearestFilter,9986:ft.NearestMipMapLinearFilter,9987:ft.LinearMipMapLinearFilter},S={33071:ft.ClampToEdgeWrapping,33648:ft.MirroredRepeatWrapping,10497:ft.RepeatWrapping},x=(ft.BackSide,ft.FrontSide,ft.NeverDepth,ft.LessDepth,ft.EqualDepth,ft.LessEqualDepth,ft.GreaterEqualDepth,ft.NotEqualDepth,ft.GreaterEqualDepth,ft.AlwaysDepth,ft.AddEquation,ft.SubtractEquation,ft.ReverseSubtractEquation,ft.ZeroFactor,ft.OneFactor,ft.SrcColorFactor,ft.OneMinusSrcColorFactor,ft.SrcAlphaFactor,ft.OneMinusSrcAlphaFactor,ft.DstAlphaFactor,ft.OneMinusDstAlphaFactor,ft.DstColorFactor,ft.OneMinusDstColorFactor,ft.SrcAlphaSaturateFactor,{SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16}),M={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},C={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},j={CUBICSPLINE:void 0,LINEAR:ft.InterpolateLinear,STEP:ft.InterpolateDiscrete},E="OPAQUE",P="MASK",D="BLEND",R={"image/png":ft.RGBAFormat,"image/jpeg":ft.RGBFormat};function L(e,t){return"string"!==typeof e||""===e?"":/^(https?:)?\/\//i.test(e)?e:/^data:.*,.*$/i.test(e)?e:/^blob:.*$/i.test(e)?e:t+e}function I(e,t,r){for(var n in r.extensions)void 0===e[n]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[n]=r.extensions[n])}function T(e,t){void 0!==t.extras&&("object"===typeof t.extras?e.userData=t.extras:console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function N(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(var r=0,n=t.weights.length;r<n;r++)e.morphTargetInfluences[r]=t.weights[r];if(t.extras&&Array.isArray(t.extras.targetNames)){var i=t.extras.targetNames;if(e.morphTargetInfluences.length===i.length){e.morphTargetDictionary={};for(r=0,n=i.length;r<n;r++)e.morphTargetDictionary[i[r]]=r}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function G(e){for(var t="",r=Object.keys(e).sort(),n=0,i=r.length;n<i;n++)t+=r[n]+":"+e[r[n]]+";";return t}function B(e){if(e.isInterleavedBufferAttribute){for(var t=e.count,r=e.itemSize,n=e.array.slice(0,t*r),i=0,a=0;i<t;++i)n[a++]=e.getX(i),r>=2&&(n[a++]=e.getY(i)),r>=3&&(n[a++]=e.getZ(i)),r>=4&&(n[a++]=e.getW(i));return new ft.BufferAttribute(n,r,e.normalized)}return e.clone()}function F(e,r,n){this.json=e||{},this.extensions=r||{},this.options=n||{},this.cache=new t,this.primitiveCache={},this.textureLoader=new ft.TextureLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.fileLoader=new ft.FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer")}function U(e,t,r){var n=t.attributes,i=[];function a(t,n){return r.getDependency("accessor",t).then(function(t){e.addAttribute(n,t)})}for(var s in n){var o=M[s]||s.toLowerCase();o in e.attributes||i.push(a(n[s],o))}if(void 0!==t.indices&&!e.index){var c=r.getDependency("accessor",t.indices).then(function(t){e.setIndex(t)});i.push(c)}return T(e,t),Promise.all(i).then(function(){return void 0!==t.targets?function(e,t,r){for(var n=!1,i=!1,a=0,s=t.length;a<s&&(void 0!==(u=t[a]).POSITION&&(n=!0),void 0!==u.NORMAL&&(i=!0),!n||!i);a++);if(!n&&!i)return Promise.resolve(e);var o=[],c=[];for(a=0,s=t.length;a<s;a++){var u=t[a];if(n){var l=void 0!==u.POSITION?r.getDependency("accessor",u.POSITION):e.attributes.position;o.push(l)}i&&(l=void 0!==u.NORMAL?r.getDependency("accessor",u.NORMAL):e.attributes.normal,c.push(l))}return Promise.all([Promise.all(o),Promise.all(c)]).then(function(r){for(var a=r[0],s=r[1],o=0,c=a.length;o<c;o++)e.attributes.position!==a[o]&&(a[o]=B(a[o]));for(o=0,c=s.length;o<c;o++)e.attributes.normal!==s[o]&&(s[o]=B(s[o]));for(o=0,c=t.length;o<c;o++){var u=t[o],l="morphTarget"+o;if(n&&void 0!==u.POSITION){var h=a[o];h.name=l;for(var p=e.attributes.position,d=0,f=h.count;d<f;d++)h.setXYZ(d,h.getX(d)+p.getX(d),h.getY(d)+p.getY(d),h.getZ(d)+p.getZ(d))}if(i&&void 0!==u.NORMAL){var v=s[o];v.name=l;var m=e.attributes.normal;for(d=0,f=v.count;d<f;d++)v.setXYZ(d,v.getX(d)+m.getX(d),v.getY(d)+m.getY(d),v.getZ(d)+m.getZ(d))}}return n&&(e.morphAttributes.position=a),i&&(e.morphAttributes.normal=s),e})}(e,t.targets,r):e})}return F.prototype.parse=function(e,t){var r=this,n=this.json,i=this.extensions;this.cache.removeAll(),this.markDefs(),Promise.all([this.getDependencies("scene"),this.getDependencies("animation"),this.getDependencies("camera")]).then(function(t){var a={scene:t[0][n.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:n.asset,parser:r,userData:{}};I(i,a,n),e(a)}).catch(t)},F.prototype.markDefs=function(){for(var e=this.json.nodes||[],t=this.json.skins||[],r=this.json.meshes||[],n={},i={},a=0,s=t.length;a<s;a++)for(var o=t[a].joints,c=0,u=o.length;c<u;c++)e[o[c]].isBone=!0;for(var l=0,h=e.length;l<h;l++){var p=e[l];void 0!==p.mesh&&(void 0===n[p.mesh]&&(n[p.mesh]=i[p.mesh]=0),n[p.mesh]++,void 0!==p.skin&&(r[p.mesh].isSkinnedMesh=!0))}this.json.meshReferences=n,this.json.meshUses=i},F.prototype.getDependency=function(e,t){var n=e+":"+t,i=this.cache.get(n);if(!i){switch(e){case"scene":i=this.loadScene(t);break;case"node":i=this.loadNode(t);break;case"mesh":i=this.loadMesh(t);break;case"accessor":i=this.loadAccessor(t);break;case"bufferView":i=this.loadBufferView(t);break;case"buffer":i=this.loadBuffer(t);break;case"material":i=this.loadMaterial(t);break;case"texture":i=this.loadTexture(t);break;case"skin":i=this.loadSkin(t);break;case"animation":i=this.loadAnimation(t);break;case"camera":i=this.loadCamera(t);break;case"light":i=this.extensions[r.KHR_LIGHTS_PUNCTUAL].loadLight(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(n,i)}return i},F.prototype.getDependencies=function(e){var t=this.cache.get(e);if(!t){var r=this,n=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(n.map(function(t,n){return r.getDependency(e,n)})),this.cache.add(e,t)}return t},F.prototype.loadBuffer=function(e){var t=this.json.buffers[e],n=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[r.KHR_BINARY_GLTF].body);var i=this.options;return new Promise(function(e,r){n.load(L(t.uri,i.path),e,void 0,function(){r(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})},F.prototype.loadBufferView=function(e){var t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(e){var r=t.byteLength||0,n=t.byteOffset||0;return e.slice(n,n+r)})},F.prototype.loadAccessor=function(e){var t=this,r=this.json,n=this.json.accessors[e];if(void 0===n.bufferView&&void 0===n.sparse)return Promise.resolve(null);var i=[];return void 0!==n.bufferView?i.push(this.getDependency("bufferView",n.bufferView)):i.push(null),void 0!==n.sparse&&(i.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),i.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(i).then(function(e){var i,a,s=e[0],o=x[n.type],c=k[n.componentType],u=c.BYTES_PER_ELEMENT,l=u*o,h=n.byteOffset||0,p=void 0!==n.bufferView?r.bufferViews[n.bufferView].byteStride:void 0,d=!0===n.normalized;if(p&&p!==l){var f="InterleavedBuffer:"+n.bufferView+":"+n.componentType,v=t.cache.get(f);v||(i=new c(s),v=new ft.InterleavedBuffer(i,p/u),t.cache.add(f,v)),a=new ft.InterleavedBufferAttribute(v,o,h/u,d)}else i=null===s?new c(n.count*o):new c(s,h,n.count*o),a=new ft.BufferAttribute(i,o,d);if(void 0!==n.sparse){var m=x.SCALAR,y=k[n.sparse.indices.componentType],g=n.sparse.indices.byteOffset||0,b=n.sparse.values.byteOffset||0,w=new y(e[1],g,n.sparse.count*m),O=new c(e[2],b,n.sparse.count*o);null!==s&&a.setArray(a.array.slice());for(var A=0,S=w.length;A<S;A++){var M=w[A];if(a.setX(M,O[A*o]),o>=2&&a.setY(M,O[A*o+1]),o>=3&&a.setZ(M,O[A*o+2]),o>=4&&a.setW(M,O[A*o+3]),o>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return a})},F.prototype.loadTexture=function(e){var t,n=this,i=this.json,a=this.options,s=this.textureLoader,o=window.URL||window.webkitURL,c=i.textures[e],u=c.extensions||{},l=(t=u[r.MSFT_TEXTURE_DDS]?i.images[u[r.MSFT_TEXTURE_DDS].source]:i.images[c.source]).uri,h=!1;return void 0!==t.bufferView&&(l=n.getDependency("bufferView",t.bufferView).then(function(e){h=!0;var r=new Blob([e],{type:t.mimeType});return l=o.createObjectURL(r)})),Promise.resolve(l).then(function(e){var t=ft.Loader.Handlers.get(e);return t||(t=u[r.MSFT_TEXTURE_DDS]?n.extensions[r.MSFT_TEXTURE_DDS].ddsLoader:s),new Promise(function(r,n){t.load(L(e,a.path),r,void 0,n)})}).then(function(e){!0===h&&o.revokeObjectURL(l),e.flipY=!1,void 0!==c.name&&(e.name=c.name),t.mimeType in R&&(e.format=R[t.mimeType]);var r=(i.samplers||{})[c.sampler]||{};return e.magFilter=A[r.magFilter]||ft.LinearFilter,e.minFilter=A[r.minFilter]||ft.LinearMipMapLinearFilter,e.wrapS=S[r.wrapS]||ft.RepeatWrapping,e.wrapT=S[r.wrapT]||ft.RepeatWrapping,e})},F.prototype.assignTexture=function(e,t,n){var i=this;return this.getDependency("texture",n.index).then(function(a){if(!a.isCompressedTexture)switch(t){case"aoMap":case"emissiveMap":case"metalnessMap":case"normalMap":case"roughnessMap":a.format=ft.RGBFormat}if(i.extensions[r.KHR_TEXTURE_TRANSFORM]){var s=void 0!==n.extensions?n.extensions[r.KHR_TEXTURE_TRANSFORM]:void 0;s&&(a=i.extensions[r.KHR_TEXTURE_TRANSFORM].extendTexture(a,s))}e[t]=a})},F.prototype.assignFinalMaterial=function(e){var t=e.geometry,n=e.material,i=this.extensions,a=void 0!==t.attributes.tangent,s=void 0!==t.attributes.color,o=void 0===t.attributes.normal,c=!0===e.isSkinnedMesh,u=Object.keys(t.morphAttributes).length>0,l=u&&void 0!==t.morphAttributes.normal;if(e.isPoints){var h="PointsMaterial:"+n.uuid,p=this.cache.get(h);p||(p=new ft.PointsMaterial,ft.Material.prototype.copy.call(p,n),p.color.copy(n.color),p.map=n.map,p.lights=!1,this.cache.add(h,p)),n=p}else if(e.isLine){h="LineBasicMaterial:"+n.uuid;var d=this.cache.get(h);d||(d=new ft.LineBasicMaterial,ft.Material.prototype.copy.call(d,n),d.color.copy(n.color),d.lights=!1,this.cache.add(h,d)),n=d}if(a||s||o||c||u){h="ClonedMaterial:"+n.uuid+":";n.isGLTFSpecularGlossinessMaterial&&(h+="specular-glossiness:"),c&&(h+="skinning:"),a&&(h+="vertex-tangents:"),s&&(h+="vertex-colors:"),o&&(h+="flat-shading:"),u&&(h+="morph-targets:"),l&&(h+="morph-normals:");var f=this.cache.get(h);f||(f=n.isGLTFSpecularGlossinessMaterial?i[r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].cloneMaterial(n):n.clone(),c&&(f.skinning=!0),a&&(f.vertexTangents=!0),s&&(f.vertexColors=ft.VertexColors),o&&(f.flatShading=!0),u&&(f.morphTargets=!0),l&&(f.morphNormals=!0),this.cache.add(h,f)),n=f}n.aoMap&&void 0===t.attributes.uv2&&void 0!==t.attributes.uv&&(console.log("THREE.GLTFLoader: Duplicating UVs to support aoMap."),t.addAttribute("uv2",new ft.BufferAttribute(t.attributes.uv.array,2))),n.isGLTFSpecularGlossinessMaterial&&(e.onBeforeRender=i[r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].refreshUniforms),e.material=n},F.prototype.loadMaterial=function(e){var t,n=this.json,i=this.extensions,a=n.materials[e],s={},o=a.extensions||{},c=[];if(o[r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){var u=i[r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];t=u.getMaterialType(),c.push(u.extendParams(s,a,this))}else if(o[r.KHR_MATERIALS_UNLIT]){var l=i[r.KHR_MATERIALS_UNLIT];t=l.getMaterialType(),c.push(l.extendParams(s,a,this))}else{t=ft.MeshStandardMaterial;var h=a.pbrMetallicRoughness||{};if(s.color=new ft.Color(1,1,1),s.opacity=1,Array.isArray(h.baseColorFactor)){var p=h.baseColorFactor;s.color.fromArray(p),s.opacity=p[3]}void 0!==h.baseColorTexture&&c.push(this.assignTexture(s,"map",h.baseColorTexture)),s.metalness=void 0!==h.metallicFactor?h.metallicFactor:1,s.roughness=void 0!==h.roughnessFactor?h.roughnessFactor:1,void 0!==h.metallicRoughnessTexture&&(c.push(this.assignTexture(s,"metalnessMap",h.metallicRoughnessTexture)),c.push(this.assignTexture(s,"roughnessMap",h.metallicRoughnessTexture)))}!0===a.doubleSided&&(s.side=ft.DoubleSide);var d=a.alphaMode||E;return d===D?s.transparent=!0:(s.transparent=!1,d===P&&(s.alphaTest=void 0!==a.alphaCutoff?a.alphaCutoff:.5)),void 0!==a.normalTexture&&t!==ft.MeshBasicMaterial&&(c.push(this.assignTexture(s,"normalMap",a.normalTexture)),s.normalScale=new ft.Vector2(1,1),void 0!==a.normalTexture.scale&&s.normalScale.set(a.normalTexture.scale,a.normalTexture.scale)),void 0!==a.occlusionTexture&&t!==ft.MeshBasicMaterial&&(c.push(this.assignTexture(s,"aoMap",a.occlusionTexture)),void 0!==a.occlusionTexture.strength&&(s.aoMapIntensity=a.occlusionTexture.strength)),void 0!==a.emissiveFactor&&t!==ft.MeshBasicMaterial&&(s.emissive=(new ft.Color).fromArray(a.emissiveFactor)),void 0!==a.emissiveTexture&&t!==ft.MeshBasicMaterial&&c.push(this.assignTexture(s,"emissiveMap",a.emissiveTexture)),Promise.all(c).then(function(){var e;return e=t===ft.ShaderMaterial?i[r.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(s):new t(s),void 0!==a.name&&(e.name=a.name),e.map&&(e.map.encoding=ft.sRGBEncoding),e.emissiveMap&&(e.emissiveMap.encoding=ft.sRGBEncoding),e.specularMap&&(e.specularMap.encoding=ft.sRGBEncoding),T(e,a),a.extensions&&I(i,e,a),e})},F.prototype.loadGeometries=function(e){var t=this,n=this.extensions,i=this.primitiveCache;function a(e){return n[r.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then(function(r){return U(r,e,t)})}for(var s,o,c=[],u=0,l=e.length;u<l;u++){var h,p=e[u],d=(o=void 0,(o=(s=p).extensions&&s.extensions[r.KHR_DRACO_MESH_COMPRESSION])?"draco:"+o.bufferView+":"+o.indices+":"+G(o.attributes):s.indices+":"+G(s.attributes)+":"+s.mode),f=i[d];if(f)c.push(f.promise);else h=p.extensions&&p.extensions[r.KHR_DRACO_MESH_COMPRESSION]?a(p):U(new ft.BufferGeometry,p,t),i[d]={primitive:p,promise:h},c.push(h)}return Promise.all(c)},F.prototype.loadMesh=function(e){for(var t=this,r=this.json,n=(this.extensions,r.meshes[e]),i=n.primitives,a=[],s=0,o=i.length;s<o;s++){var c=void 0===i[s].material?f=f||new ft.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:ft.FrontSide}):this.getDependency("material",i[s].material);a.push(c)}return Promise.all(a).then(function(r){return t.loadGeometries(i).then(function(a){for(var s=[],o=0,c=a.length;o<c;o++){var u,l=a[o],h=i[o],p=r[o];if(h.mode===b||h.mode===w||h.mode===O||void 0===h.mode)!0===(u=!0===n.isSkinnedMesh?new ft.SkinnedMesh(l,p):new ft.Mesh(l,p)).isSkinnedMesh&&u.normalizeSkinWeights(),h.mode===w?u.drawMode=ft.TriangleStripDrawMode:h.mode===O&&(u.drawMode=ft.TriangleFanDrawMode);else if(h.mode===m)u=new ft.LineSegments(l,p);else if(h.mode===g)u=new ft.Line(l,p);else if(h.mode===y)u=new ft.LineLoop(l,p);else{if(h.mode!==v)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+h.mode);u=new ft.Points(l,p)}Object.keys(u.geometry.morphAttributes).length>0&&N(u,n),u.name=n.name||"mesh_"+e,a.length>1&&(u.name+="_"+o),T(u,n),t.assignFinalMaterial(u),s.push(u)}if(1===s.length)return s[0];var d=new ft.Group;for(o=0,c=s.length;o<c;o++)d.add(s[o]);return d})})},F.prototype.loadCamera=function(e){var t,r=this.json.cameras[e],n=r[r.type];if(n)return"perspective"===r.type?t=new ft.PerspectiveCamera(ft.Math.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===r.type&&(t=new ft.OrthographicCamera(n.xmag/-2,n.xmag/2,n.ymag/2,n.ymag/-2,n.znear,n.zfar)),void 0!==r.name&&(t.name=r.name),T(t,r),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")},F.prototype.loadSkin=function(e){var t=this.json.skins[e],r={joints:t.joints};return void 0===t.inverseBindMatrices?Promise.resolve(r):this.getDependency("accessor",t.inverseBindMatrices).then(function(e){return r.inverseBindMatrices=e,r})},F.prototype.loadAnimation=function(e){for(var t=this.json.animations[e],r=[],n=[],i=[],a=[],s=[],o=0,c=t.channels.length;o<c;o++){var u=t.channels[o],l=t.samplers[u.sampler],h=u.target,p=void 0!==h.node?h.node:h.id,f=void 0!==t.parameters?t.parameters[l.input]:l.input,v=void 0!==t.parameters?t.parameters[l.output]:l.output;r.push(this.getDependency("node",p)),n.push(this.getDependency("accessor",f)),i.push(this.getDependency("accessor",v)),a.push(l),s.push(h)}return Promise.all([Promise.all(r),Promise.all(n),Promise.all(i),Promise.all(a),Promise.all(s)]).then(function(r){for(var n=r[0],i=r[1],a=r[2],s=r[3],o=r[4],c=[],u=0,l=n.length;u<l;u++){var h=n[u],p=i[u],f=a[u],v=s[u],m=o[u];if(void 0!==h){var y;switch(h.updateMatrix(),h.matrixAutoUpdate=!0,C[m.path]){case C.weights:y=ft.NumberKeyframeTrack;break;case C.rotation:y=ft.QuaternionKeyframeTrack;break;case C.position:case C.scale:default:y=ft.VectorKeyframeTrack}var g=h.name?h.name:h.uuid,b=void 0!==v.interpolation?j[v.interpolation]:ft.InterpolateLinear,w=[];C[m.path]===C.weights?h.traverse(function(e){!0===e.isMesh&&e.morphTargetInfluences&&w.push(e.name?e.name:e.uuid)}):w.push(g);for(var O=0,k=w.length;O<k;O++){var A=new y(w[O]+"."+C[m.path],p.array,f.array,b);"CUBICSPLINE"===v.interpolation&&(A.createInterpolant=function(e){return new d(this.times,this.values,this.getValueSize()/3,e)},A.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),c.push(A)}}}var S=void 0!==t.name?t.name:"animation_"+e;return new ft.AnimationClip(S,void 0,c)})},F.prototype.loadNode=function(e){var t=this.json,n=this.extensions,i=this,a=t.meshReferences,s=t.meshUses,o=t.nodes[e];return(!0===o.isBone?Promise.resolve(new ft.Bone):void 0!==o.mesh?i.getDependency("mesh",o.mesh).then(function(e){var t;if(a[o.mesh]>1){var r=s[o.mesh]++;(t=e.clone()).name+="_instance_"+r,t.onBeforeRender=e.onBeforeRender;for(var n=0,i=t.children.length;n<i;n++)t.children[n].name+="_instance_"+r,t.children[n].onBeforeRender=e.children[n].onBeforeRender}else t=e;return void 0!==o.weights&&t.traverse(function(e){if(e.isMesh)for(var t=0,r=o.weights.length;t<r;t++)e.morphTargetInfluences[t]=o.weights[t]}),t}):void 0!==o.camera?i.getDependency("camera",o.camera):o.extensions&&o.extensions[r.KHR_LIGHTS_PUNCTUAL]&&void 0!==o.extensions[r.KHR_LIGHTS_PUNCTUAL].light?i.getDependency("light",o.extensions[r.KHR_LIGHTS_PUNCTUAL].light):Promise.resolve(new ft.Object3D)).then(function(e){if(void 0!==o.name&&(e.name=ft.PropertyBinding.sanitizeNodeName(o.name)),T(e,o),o.extensions&&I(n,e,o),void 0!==o.matrix){var t=new ft.Matrix4;t.fromArray(o.matrix),e.applyMatrix(t)}else void 0!==o.translation&&e.position.fromArray(o.translation),void 0!==o.rotation&&e.quaternion.fromArray(o.rotation),void 0!==o.scale&&e.scale.fromArray(o.scale);return e})},F.prototype.loadScene=function(){function e(t,r,n,i){var a=n.nodes[t];return i.getDependency("node",t).then(function(e){return void 0===a.skin?e:i.getDependency("skin",a.skin).then(function(e){for(var r=[],n=0,a=(t=e).joints.length;n<a;n++)r.push(i.getDependency("node",t.joints[n]));return Promise.all(r)}).then(function(r){for(var n=!0===e.isGroup?e.children:[e],i=0,a=n.length;i<a;i++){for(var s=n[i],o=[],c=[],u=0,l=r.length;u<l;u++){var h=r[u];if(h){o.push(h);var p=new ft.Matrix4;void 0!==t.inverseBindMatrices&&p.fromArray(t.inverseBindMatrices.array,16*u),c.push(p)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[u])}s.bind(new ft.Skeleton(o,c),s.matrixWorld)}return e});var t}).then(function(t){r.add(t);var s=[];if(a.children)for(var o=a.children,c=0,u=o.length;c<u;c++){var l=o[c];s.push(e(l,t,n,i))}return Promise.all(s)})}return function(t){var r=this.json,n=this.extensions,i=this.json.scenes[t],a=new ft.Scene;void 0!==i.name&&(a.name=i.name),T(a,i),i.extensions&&I(n,a,i);for(var s=i.nodes||[],o=[],c=0,u=s.length;c<u;c++)o.push(e(s[c],a,r,this));return Promise.all(o).then(function(){return a})}}(),e}(),mt=function(){function e(){Object(o.a)(this,e)}return Object(c.a)(e,[{key:"getCurrentScene",value:function(){throw new Error("getCurrentScene not implemented")}},{key:"getSceneObjects",value:function(e){throw new Error("getSceneObjects not implemented")}},{key:"getBehaviorsForObject",value:function(e){throw new Error("getBehaviorsForObject(obj) not implemented")}},{key:"getThreeObject",value:function(e){throw new Error("getThreeObject(id) not implemented")}},{key:"getParsedBehaviorAsset",value:function(e){throw new Error("getParsedBehaviorAsset(behavior) not implemented")}},{key:"getAllBehaviors",value:function(){throw new Error("getAllBehaviors() not implemented")}},{key:"getAllScenes",value:function(){throw new Error("getAllScenes not implemented")}},{key:"navigateScene",value:function(e){throw new Error("navigateScene(id) not implemented")}},{key:"playMediaAsset",value:function(e){throw new Error("playMediaAsset(id) not implemented")}},{key:"stopMediaAsset",value:function(e){throw new Error("stopMediaAsset(id) not implemented")}},{key:"isMediaAssetPlaying",value:function(e){throw new Error("isMediaAssetPlaying(id) not implemented")}},{key:"setMediaVolume",value:function(e,t){throw new Error("setMediaVolume(asset,vol) not implemented")}},{key:"getGraphObjectByName",value:function(e){throw new Error("getGraphObjectByName(name) not implemented")}},{key:"getGraphObjectById",value:function(e){throw new Error("getGraphObjectById(id) not implemented")}},{key:"getCamera",value:function(){throw new Error("getCamera() not implemented")}},{key:"getTweenManager",value:function(){throw new Error("getTweenManager() not implemented")}},{key:"getFloorNear",value:function(e){throw new Error("getFloorNear not implemented")}},{key:"startLocalAnchor",value:function(e){throw new Error("startLocalAnchor not implemented")}},{key:"stopLocalAnchor",value:function(e){throw new Error("stopLocalAnchor not implemented")}},{key:"startImageRecognizer",value:function(e){throw new Error("startImageRecognizer not implemented")}},{key:"stopImageRecognizer",value:function(e){throw new Error("stopImageRecognizer not implemented")}},{key:"startGeoTracker",value:function(e){throw new Error("startGeoTracker not implemented")}},{key:"stopGeoTracker",value:function(e){throw new Error("stopGeoTracker not implemented")}},{key:"startWorldInfo",value:function(e){throw new Error("startWorldInformation not implemented")}},{key:"stopWorldInfo",value:function(e){throw new Error("stopWorldInformation not implemented")}}]),e}(),yt=function(){function e(t,r,n){Object(o.a)(this,e),this.manager=t,this.sgp=r,this.logger=this.manager.logger,this.tween=r.getTweenManager(),this.camera=r.getCamera(),this.globalStorage=this.manager.storage,this.behavior=n}return Object(c.a)(e,[{key:"getThreeObjectByTitle",value:function(e){var t=this.sgp.getGraphObjectByName(e);if(!t)throw new Error("three object '".concat(e,"' not found"));return this.sgp.getThreeObject(t)}},{key:"getObjectByTitle",value:function(e){var t=this.sgp.getGraphObjectByName(e);if(!t||!t.exists())throw new Error("object '".concat(e,"' not found"));return t}},{key:"getAssetByTitle",value:function(e){var t=this.sgp.getGraphObjectByName(e);if(!t||!t.exists())throw new Error("asset '".concat(e,"' not found"));var r=this._event&&this._event.data&&this._event.data.event&&this._event.data.event.isTrusted;return new bt(this.manager,t,r)}},{key:"getAssetById",value:function(e){var t=this.getObjectById(e);if(!t||!t.exists())throw new Error("asset '".concat(e,"' not found"));var r=this._event&&this._event.data&&this._event.data.event&&this._event.data.event.isTrusted;return new bt(this.manager,t,r)}},{key:"getObjectById",value:function(e){var t=this.sgp.getGraphObjectById(e);if(!t||!t.exists())throw new Error("object '".concat(e,"' not found"));return t}},{key:"getThreeObjectById",value:function(e){return this.sgp.getThreeObject(e)}},{key:"getCurrentScene",value:function(){var e=this.sgp.getCurrentScene();if(!e||!e.exists())throw new Error("current scene not found");return e}},{key:"navigateScene",value:function(e){this.manager.fireSceneLifecycleEvent("exit",this.getCurrentScene()),this.sgp.navigateScene(e),this.manager.fireSceneLifecycleEvent("enter",this.getCurrentScene())}},{key:"fireEvent",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;null==r&&(r=this.sgp.getGraphObjectById(this.behavior.parent)),this.manager.fireEventAtTarget(r,e,t)}},{key:"sendMessage",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;null==r&&(r=this.sgp.getGraphObjectById(this.behavior.parent)),this.manager.fireMessageAtTarget(r,e,t)}},{key:"captureEvent",value:function(){this.manager.captureEvent()}},{key:"globals",get:function(){return{THREE:Q,GLTFLoader:vt,GPUParticles:De,WebLayer3D:Se.a}}},{key:"properties",get:function(){return this.behavior.props()}}]),e}(),gt=function(){function e(t,r){Object(o.a)(this,e),this.sgp=t,this.logger=r,this.running=!1,this.storage={},this.logger=r,this.logger.log("ScriptManager created"),this.system_cache={},this.bubbling=!0,window.THREE||(window.THREE=Q),window.GLTFLoader||(window.GLTFLoader=vt),window.GPUParticles||(window.GPUParticles=De),window.WebLayer3D||(window.WebLayer3D=Se.a)}return Object(c.a)(e,[{key:"fireLifecycleEvent",value:function(e){var t=this;this.logger.log("doing ".concat(e," event"));var r={type:e};this.sgp.getAllScenes().forEach(function(n){n.find(function(n){if(n.type===et.BEHAVIOR){r.target=t.sgp.getThreeObject(n.parent),r.graphTarget=t.sgp.getGraphObjectById(n.parent);var i=t.sgp.getParsedBehaviorAsset(n),a=t.getSystemFacadeFromCache(n);a.code=i,i[e]&&i[e].call(a,r)}else r.target=t.sgp.getThreeObject(n),r.graphTarget=n,r.target&&r.target[e]&&r.target[e](r,t);return!0})})}},{key:"fireSceneLifecycleEvent",value:function(e,t,r){var n=this;"tick"!==e&&this.logger.log("doing ".concat(e," event"));var i={type:e,time:r?r-this.startTime:-1,deltaTime:r?r-this.lastTime:0,session:this.session};r&&(this.lastTime=r),t.find(function(t){var r=t.parent;return n.fireSceneLifecycleEventAtChild(e,i,t,r),!0})}},{key:"fireSceneLifecycleEventAtChild",value:function(e,t,r,n){if(r.type===et.BEHAVIOR){t.target=this.sgp.getThreeObject(n),t.graphTarget=this.sgp.getGraphObjectById(n);var i=this.sgp.getParsedBehaviorAsset(r),a=this.getSystemFacadeFromCache(r);a.code=i,i[e]&&i[e].call(a,t)}else t.target=this.sgp.getThreeObject(r),t.graphTarget=r,t.target&&t.target[e]&&t.target[e](t,this),r.type===_e.clone&&"tick"!==e&&console.log("also doing ".concat(e," event on a clone"))}},{key:"tick",value:function(e,t){if(this.running){0===this.startTime&&(this.startTime=e,this.lastTime=e);try{this.session=t,this.fireSceneLifecycleEvent("tick",this.sgp.getCurrentScene(),e)}catch(r){this.logger.error("error in script",r.message),this.logger.log(r),this.stopRunning()}}}},{key:"startRunning",value:function(){this.running=!0,this.startTime=0,this.lastTime=0,this.storage={},this.logger.log("ScriptManager starting");try{this.fireLifecycleEvent("start")}catch(e){this.logger.error("error in script",e.message),this.logger.error(e),this.stopRunning()}}},{key:"startFirstScene",value:function(){try{this.fireSceneLifecycleEvent("enter",this.sgp.getCurrentScene())}catch(e){this.logger.error("error in script",e.message),this.logger.error(e),this.stopRunning()}}},{key:"stopRunning",value:function(){try{this.fireSceneLifecycleEvent("exit",this.sgp.getCurrentScene()),this.fireLifecycleEvent("stop"),this.running=!1,this.storage={},this.destroyListeners()}catch(e){this.running=!1,this.logger.error("error stopping scripts",e.message),this.logger.error(e)}this.logger.log("script manager stopping")}},{key:"isRunning",value:function(){return this.running}},{key:"fireMessageAtTarget",value:function(e,t,r){var n=this;if(this.running)try{var i={type:"message",name:t,data:r,time:this.lastTime,target:this.sgp.getThreeObject(e),graphTarget:e};this.sgp.getBehaviorsForObject(e).forEach(function(e){var t=n.getSystemFacadeFromCache(e),r=n.sgp.getParsedBehaviorAsset(e);t._event=i,t.code=r,r.message&&r.message.call(t,i),t._event=null})}catch(a){this.logger.error("error in '"+t+"' message",a.message),this.logger.error(a),this.stopRunning()}}},{key:"performClickAction",value:function(e,t){this.fireEventAtTarget(e,"click",{event:t})}},{key:"captureEvent",value:function(){this.bubbling=!1}},{key:"fireEventAtTarget",value:function(e,t,r){var n=this;if(this.running)try{!function(){n.bubbling=!0;for(var i={type:t,data:r,time:n.lastTime,target:n.sgp.getThreeObject(e),graphTarget:e},a=n.sgp.getCurrentScene();n.bubbling&&e.id!==a.id&&e.type!==et.SCENE;){n.sgp.getBehaviorsForObject(e).forEach(function(e){var r=n.getSystemFacadeFromCache(e),a=n.sgp.getParsedBehaviorAsset(e);r._event=i,a[t]&&(r.code=a,a[t].call(r,i)),r._event=null}),e=n.sgp.getGraphObjectById(e.parent)}}()}catch(i){this.logger.error("error in '"+t+"' event",i.message),this.logger.error(i),this.stopRunning()}}},{key:"destroyListeners",value:function(){this.listeners={}}},{key:"on",value:function(e,t,r){this.listeners||(this.listeners={}),this.listeners[e.id]||(this.listeners[e.id]={}),this.listeners[e.id][t]||(this.listeners[e.id][t]=[]),this.listeners[e.id][t].push(r)}},{key:"getSystemFacadeFromCache",value:function(e){return this.system_cache[e.id]||(this.system_cache[e.id]=new yt(this,this.sgp,e)),this.system_cache[e.id]}}]),e}(),bt=function(){function e(t,r,n){Object(o.a)(this,e),this.manager=t,this.obj=r,this.trusted=n}return Object(c.a)(e,[{key:"play",value:function(){this.manager.sgp.playMediaAsset(this.obj,this.trusted)}},{key:"isPlaying",value:function(){return this.manager.sgp.isMediaAssetPlaying(this.obj)}},{key:"stop",value:function(){this.manager.sgp.stopMediaAsset(this.obj)}},{key:"setVolume",value:function(e){this.manager.sgp.setMediaVolume(this.obj,e)}},{key:"getType",value:function(){return this.obj.subtype}}]),e}(),wt=function(){function e(){Object(o.a)(this,e),this.running=!1}return Object(c.a)(e,[{key:"update",value:function(e){throw new Error("update not implemented")}},{key:"start",value:function(){this.running=!0}},{key:"isAlive",value:function(){return this.running}},{key:"kill",value:function(){this.running=!1}}]),e}(),Ot=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this))).type="wait",r.duration=e,r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"update",value:function(e){e/=1e3,this.startTime||(this.startTime=e),(e-this.startTime)/this.duration>=1&&(this.running=!1)}}]),t}(wt),kt=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this))).type="action",r.fn=e,r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"start",value:function(){var e=this.fn();return this.running=!1,e}}]),t}(wt),At=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this))).type="forever",r.fn=e,r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"start",value:function(){this.running=!0,this.startTime=Date.now()/1e3}},{key:"update",value:function(e){var t=e/1e3-this.startTime;this.fn(t)}}]),t}(wt),St={SINGLE:"single",COMPOUND:"compound"},xt={LINEAR:"linear",ELASTIC:"elastic"};function Mt(e,t,r){return(t-e)*r+e}var Ct=function(e){function t(e){var r;if(Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this))).type="prop",r.target=e.target,r.duration=e.duration,"undefined"===typeof r.duration)throw new Error("duration is missing");if(r.property=e.property,"undefined"===typeof r.property)throw new Error("property is missing");return r.propertyType=e.propertyType||St.SINGLE,r.from=e.from,r.to=e.to,r.lerp_type=e.lerpType||xt.LINEAR,r.loop=e.loop,"undefined"===typeof r.loop&&(r.loop=1),r.loopCount=0,r.reversed=!1,r.autoReverse=e.autoReverse,"undefined"===typeof r.autoReverse&&(r.autoReverse=!1),r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"update",value:function(e){e/=1e3,this.startTime||(this.startTime=e);var t=(e-this.startTime)/this.duration;if(t>1&&(t=1),this.setPropertyValue(this.from,this.to,t),1===t){if(this.loopCount++,this.autoReverse&&(this.reversed=!this.reversed),-1!==this.loop&&this.loopCount>=this.loop)return void(this.running=!1);this.startTime=e}}},{key:"setPropertyValue",value:function(e,t,r,n,i){var a=this;this.propertyType===St.SINGLE&&(this.target[this.property]=this.lerp(this.from,this.to,this.reversed?1-r:r)),this.propertyType===St.COMPOUND&&Object.keys(this.from).forEach(function(e){a.target[a.property][e]=a.lerp(a.from[e],a.to[e],a.reversed?1-r:r)})}},{key:"lerp",value:function(e,t,r){return this.lerp_type===xt.LINEAR?Mt(e,t,r):this.lerp_type===xt.ELASTIC?Mt(e,t,function(e){return Math.pow(2,-10*e)*Math.sin((e-.075)*(2*Math.PI)/.3)+1}(r)):(console.log("invalid LERP_TYPE"),e)}}]),t}(wt),jt=function(e){function t(e){var r;if(Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this))).type="clip",r.target=e.target,r.name=e.name,r.loop=e.loop,r.autoReverse=e.autoReverse,"undefined"===typeof r.autoReverse&&(r.autoReverse=!1),"undefined"===typeof r.loop&&(r.loop=1),"undefined"===typeof r.name)throw new Error("name is missing");return r.speed=e.speed,"undefined"===typeof r.speed&&(r.speed=1),r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"start",value:function(){this.running=!0,this.mixer=new Q.AnimationMixer(this.target.scene),this.action=this.mixer.clipAction(Q.AnimationClip.findByName(this.target.animations,this.name)),1===this.loop&&this.action.setLoop(Q.LoopOnce,1),-1===this.loop&&this.action.setLoop(this.autoReverse?Q.LoopPingPong:Q.LoopRepeat,1/0),this.loop>1&&this.action.setLoop(Q.LoopRepeat,this.loop),this.action.play(),this.action.setEffectiveTimeScale(this.speed),this.startTime=Date.now()/1e3,this.prevTime=this.startTime}},{key:"update",value:function(e){var t=e/1e3-this.prevTime;this.mixer.update(t),this.prevTime=e/1e3}},{key:"kill",value:function(){this.action.stop(),this.running=!1}}]),t}(wt),Et=function(e){function t(){var e;return Object(o.a)(this,t),(e=Object(u.a)(this,Object(l.a)(t).call(this))).subs=[],e}return Object(h.a)(t,e),Object(c.a)(t,[{key:"and",value:function(e){return e instanceof wt?this.subs.push(e):this.subs.push(new kt(e)),this}},{key:"start",value:function(){return this.running=!0,this.subs.forEach(function(e){return e.start()}),this}},{key:"update",value:function(e){this.subs.forEach(function(t){t.isAlive()&&t.update(e)})}},{key:"isAlive",value:function(){return void 0!==this.subs.find(function(e){return!0===e.isAlive()})}}]),t}(wt),Pt=function(e){function t(){var e;return Object(o.a)(this,t),(e=Object(u.a)(this,Object(l.a)(t).call(this))).subs=[],e.n=-1,e}return Object(h.a)(t,e),Object(c.a)(t,[{key:"then",value:function(e){return e instanceof wt?this.subs.push(e):this.subs.push(new kt(e)),this}},{key:"wait",value:function(e){return this.subs.push(new Ot(e)),this}},{key:"start",value:function(){return this.running=!0,this._startNext(),this}},{key:"_startNext",value:function(){if(this.n=this.n+1,this.n>this.subs.length-1)return this.running=!1,this.n=-1,null;var e=this.subs[this.n],t=e.start();return e.isAlive()?e:t?(console.log("the next swapped itself",t),this.subs[this.n]=t,this.n=this.n-1,this._startNext()):this._startNext()}},{key:"update",value:function(e){var t=this.subs[this.n];t.update(e),t.isAlive()||this._startNext()}},{key:"isAlive",value:function(){return void 0!==this.subs.find(function(e){return!0===e.isAlive()})}}]),t}(wt),Dt=function(){function e(){Object(o.a)(this,e),this.subs=[]}return Object(c.a)(e,[{key:"parallel",value:function(){var e=new Et;return this.subs.push(e),e}},{key:"sequence",value:function(){var e=new Pt;return this.subs.push(e),e}},{key:"action",value:function(e){var t=new kt(e);return this.subs.push(t),t}},{key:"prop",value:function(e){var t=new Ct(e);return this.subs.push(t),t}},{key:"isAlive",value:function(){return this.subs.find(function(e){return!0===e.isAlive()})}},{key:"update",value:function(e){var t=Date.now();this.subs.forEach(function(e){e.isAlive()&&e.update(t)})}},{key:"forever",value:function(e){var t=new At(e);return this.subs.push(t),t}},{key:"clip",value:function(e){var t=new jt(e);return this.subs.push(t),t}},{key:"wait",value:function(e){var t=new Ot(e);return this.subs.push(t),t}}]),e}(),Rt=r(45),Lt=r(14),It=r.n(Lt),Tt=r(17),Nt=r(12),Gt=window.Cesium,Bt=window.XRGeospatialAnchor,Ft=function(){function e(){Object(o.a)(this,e),this.imageDetectorMap={},this.geoAnchorMap={},this._workingMatrix=Nt.mat4.create(),this._identity=Nt.mat4.create(),this._vec=Nt.vec3.create(),this.lastFrameTime=0,this.heightAboveFloor=1.1}return Object(c.a)(e,[{key:"getContext",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this.device=0,this.session=0,this.xrCanvas=0,this.xrContext=0,this.canvas=t,this.context=0,this.xrCanvas=document.createElement("canvas"),this.xrContext=this.xrCanvas.getContext("xrpresent"),this._anchoredNodes=new Map,this.projectionMatrix=0;var r=this;return new Promise(function(t,n){navigator.xr.requestDevice().then(function(i){r.device=i,r.device.requestSession({outputContext:r.xrContext,alignEUS:!0,geolocation:!0,worldSensing:!0}).then(function(n){r.session=n,Bt.useEstimatedElevation(!0,e.heightAboveFloor),e.updateGeoElevationLoop(),r.session.nonStandard_setNumberOfTrackedImages(4),r.canvas||(r.canvas=document.createElement("canvas")),r.context||(r.context=r.canvas.getContext("webgl",{compatibleXRDevice:r.device})),r.session.baseLayer=new window.XRWebGLLayer(r.session,r.context),t(r.context)}).catch(function(e){console.error("Session setup error",e),n()})}).catch(function(e){console.error("Error",e),n()})})}},{key:"updateGeoElevationLoop",value:function(){var e=Object(Tt.a)(It.a.mark(function e(){var t,r=this;return It.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=function(e){return new Promise(function(t){return setTimeout(t,e)})},e.next=3,Bt.useEstimatedElevation(!0,this.heightAboveFloor);case 3:return e.next=5,t(100);case 5:setTimeout(function(){return r.updateGeoElevationLoop()},1);case 6:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"setAnimationLoop",value:function(e){var t=this;e?(this.session.requestFrameOfReference("head-model").then(function(e){t.headFrameOfReference=e}).catch(function(e){console.error("Error finding head frame of reference",e)}),this.session.requestFrameOfReference("eye-level").then(function(e){t.eyeLevelFrameOfReference=e}).catch(function(e){console.error("Error finding eye frame of reference",e)}),this.userAnimationCallback=e,this.__handleAnimationFrame=this._handleAnimationFrame.bind(this),this.session.requestAnimationFrame(this.__handleAnimationFrame)):console.error("Supply a callback")}},{key:"_handleAnimationFrame",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(this.lastFrameTime=e,this.session&&!this.session.ended&&(this.session.requestAnimationFrame(this.__handleAnimationFrame),this.headFrameOfReference&&this.eyeLevelFrameOfReference)){var r=t.getDevicePose(this.eyeLevelFrameOfReference);if(r){var n=!0,i=!1,a=void 0;try{for(var s,o=t.views[Symbol.iterator]();!(n=(s=o.next()).done);n=!0){var c=s.value;this.userAnimationCallback(this.session.baseLayer.getViewport(c),c.projectionMatrix,r.getViewMatrix(c),e,t),this.projectionMatrix=c.projectionMatrix;break}}catch(u){i=!0,a=u}finally{try{n||null==o.return||o.return()}finally{if(i)throw a}}}else console.log("No pose")}}},{key:"getTime",value:function(){return this.lastFrameTime}},{key:"addAnchoredNode",value:function(e,t,r){return e&&e.uid?(this._anchoredNodes.set(e.uid,{anchor:e,node:t}),t.anchor=e,t.matrixAutoUpdate=!1,t.matrix.fromArray(e.modelMatrix),t.updateMatrixWorld(!0),e._handleAnchorUpdateCallback=this._handleAnchorUpdate.bind(this,r),e._handleAnchorDeleteCallback=this._handleAnchorDelete.bind(this,r),e.addEventListener("update",e._handleAnchorUpdateCallback),e.addEventListener("removed",e._handleAnchorDeleteCallback),r.log("done adding anchored node"),t):(console.error("not a valid anchor",e),void r.error("not a valid anchor",e))}},{key:"createSceneAnchor",value:function(){var e=Object(Tt.a)(It.a.mark(function e(t,r){var n,i;return It.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r.log("Creating Scene Anchor"),this.session){e.next=4;break}return r.log("no session"),e.abrupt("return");case 4:return e.next=6,this.session.requestFrameOfReference("eye-level");case 6:return n=e.sent,e.next=9,this.session.requestFrameOfReference("head-model");case 9:return e.sent.getTransformTo(n,this._workingMatrix),Nt.mat4.getTranslation(this._vec,this._workingMatrix),Nt.mat4.fromTranslation(this._workingMatrix,this._vec),e.next=15,this.session.addAnchor(this._workingMatrix,n);case 15:return i=e.sent,this.addAnchoredNode(i,t,r),e.abrupt("return",i);case 18:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"updateAnchoredSceneNode",value:function(e,t,r){r.log("Replacing the scene node on the existing scene anchor"),this._removeAnchorFromNode(e),this.addAnchoredNode(e,t,r)}},{key:"removeSceneAnchor",value:function(e,t){t.log("Removing Scene Anchor"),this.session.removeAnchor(e),this._removeAnchorFromNode(e)}},{key:"updateRayAnchor",value:function(e,t){var r=this;if(this.projectionMatrix)if(this.canvas&&this.canvas.width&&this.canvas.height){var n=this.screenx||0,i=this.screeny||0,a=n/this.canvas.width*2-1,s=i/this.canvas.height*2,o=Nt.vec3.create();Nt.mat4.invert(this._workingMatrix,this.projectionMatrix);var c=Nt.vec3.fromValues(a,s,.5);Nt.vec3.transformMat4(c,c,this._workingMatrix),Nt.vec3.normalize(c,c),this.session.requestFrameOfReference("head-model").then(function(n){r.session.requestFrameOfReference("eye-level").then(function(i){r.session.requestHitTest(o,c,n).then(function(i){i.length<1?t.error("No hit returned from hit test"):r.session.addAnchor(i[0],n).then(function(n){r._removeAnchorForNode(e.node),r.addAnchoredNode(n,e.node,t),t.log("made anchor in local coords: "+e.node.position.x+" "+e.node.position.y+" "+e.node.position.z)})})})})}else t.error("No canvas or canvas size");else t.error("No projection matrix")}},{key:"updatePointAnchor",value:function(e,t){var r=this,n=e.point;this.session.requestFrameOfReference("head-model").then(function(i){r.session.requestFrameOfReference("eye-level").then(function(a){i.getTransformTo(a,r._workingMatrix),Nt.mat4.fromTranslation(r._workingMatrix,n),t.log(r._workingMatrix),r.session.addAnchor(r._workingMatrix,a).then(function(i){r._removeAnchorForNode(e.node),r.addAnchoredNode(i,e.node,t),t.log("updated anchor in local coords: "+e.node.position.x+" "+e.node.position.y+" "+e.node.position.z),t.log(n)})})})}},{key:"stopAnchor",value:function(e,t){console.log("Stopping anchor of various flavors"),this._anchoredNodes&&(e.node?this._removeAnchorFromNode(e.node):t.error("missing threejs node"))}},{key:"sleeper",value:function(e){return new Promise(function(t){return setTimeout(t,e)})}},{key:"_fetchImage",value:function(e,t){return new Promise(function(r,n){var i=new Image;i.crossOrigin="Anonymous",i.src=e.image.src,t.log("Loading image",i.src),i.onload=function(){r(i)}})}},{key:"createDetectionImage",value:function(e,t){var r=this;return t.log("creating/find an image recognizer"),new Promise(function(n,i){if(!e.image||!e.node)return t.log("createDetectionImage: missing image or threejs node"),void i("createDetectionImage: missing image or threejs node");if(!r.session)return t.log("no session"),void i("no session");var a=e.imageRealworldWidth||1;if(r.imageDetectorMap[e.image.src]){var s=r.imageDetectorMap[e.image.src];return a!==s.realWorldWidth?(t.log("can't create the same image with different real world width"),void i("can't create the same image with different real world width")):(t.log("createDetectionImage: already created, returning it"),void n(s.name))}r._fetchImage(e,t).then(function(s){t.log("got the image",s);var o,c=Object(Rt.a)(Array(10)).map(function(e){return(~~(36*Math.random())).toString(36)}).join(""),u=document.createElement("canvas"),l=u.getContext("2d");u.width=s.width,u.height=s.height,l.drawImage(s,0,0);try{o=l.getImageData(0,0,s.width,s.height)}catch(h){t.log("error drawing image",h),t.log("name",h.name),t.log("name",h.message),t.log("local url is "+document.documentURI),t.log("image url from "+s.src),j.add("error drawing image",h.toString()),i(new Error("foo"))}t.log("calling createDetectionImage with image width and height ".concat(s.width," ").concat(s.height)),r.session.nonStandard_createDetectionImage(c,o.data,s.width,s.height,a).then(function(){r.imageDetectorMap[e.image.src]={name:c,realWorldWidth:a,anchor:null},n(c)}).catch(function(e){t.error("error creating detection image: ".concat(e)),i(e)})}).catch(function(e){t.error("error creating detection image: ".concat(e)),i(e)})})}},{key:"startImageRecognizer",value:function(e,t,r){var n=this;if(r.log("starting Image Recognizer"),e.image&&e.node)if(this.session){var i=e.callback,a=e.node;if(this.imageDetectorMap[e.image.src]){var s=this.imageDetectorMap[e.image.src];if(s.anchor){if(!e.reactivate)return r.log("Found existing anchor: use it"),r.log("remove from previous node"),this._removeAnchorFromNode(s.anchor),r.log("add our node"),this.addAnchoredNode(s.anchor,a,r),void(i&&i(e));r.log("Found existing anchor: reactivate"),this.session.removeAnchor(s.anchor),r.log("remove from previous node"),this._removeAnchorFromNode(s.anchor),s.anchor=null}a.anchorName=null,r.log("activate detection image"),this.session.nonStandard_activateDetectionImage(s.name).then(function(s){r.log("found detection image"),a.anchorName=t,a.anchorStyle="image",n.addAnchoredNode(s,a,r),i&&i(e)}).catch(function(e){r.error("error activating detection image: ".concat(e))})}else r.error("not detection object for image",e.image.src)}else r.log("no session");else r.log("missing image or threejs node")}},{key:"stopImageRecognizer",value:function(e,t){if(console.log("Stopping image recognizer"),this._anchoredNodes)if(this.imageDetectorMap[e.image.src]){var r=this.imageDetectorMap[e.image.src];r.anchor&&(console.log("already found the image, removing it"),this._removeAnchorFromNode(r.anchor),r.anchor=null),console.log("deactivating the image"),this.session.nonStandard_deactivateDetectionImage(r.name).then(function(){}).catch(function(e){t.error("error deactivating detection image: ".concat(e))})}else t.error("no detection object for image",e.image.src)}},{key:"createGeoAnchor",value:function(e,t){var r=this;return t.log("creating or reusing a geospatial anchor"),new Promise(function(n,i){if(!e.node)return t.log("Missing threejs node"),void i("Missing threejs node");if(!e.location||!e.location.id)return t.log("User must attach a geo location first"),void i("Missing geo location");if(!r.session)return t.log("no session"),void i("no session");if(r.geoAnchorMap[e.location.id])return t.log("found geoanchor: already created, returning it"),void n();var a=e.location;if(0!==a.latitude||0!==a.longitude){var s=new Gt.Cartographic(a.longitude*Math.PI/180,a.latitude*Math.PI/180,a.altitude);a.useAltitude?(t.log("XRGeoAnchor: Placing an object at specified lla and specified altitude"),t.log(s),Bt.createGeoAnchor(s).then(function(t){r.geoAnchorMap[e.location.id]={anchor:t},n()}).catch(function(e){t.error("error creating geospatial anchor: ".concat(e)),i(e)})):Bt.getDefaultElevation(s).then(function(a){s.height=a,t.log("XRGeoAnchor: Placing an object at specified lla and estimated altitude"),t.log(s),Bt.createGeoAnchor(s).then(function(t){r.geoAnchorMap[e.location.id]={anchor:t},n()}).catch(function(e){t.error("error creating geospatial anchor: ".concat(e)),i(e)})}).catch(function(e){t.error("error getting default elevation: ".concat(e)),i(e)})}else Bt.getDeviceCartographic().then(function(a){Bt.getDefaultElevation().then(function(s){var o=new Gt.Cartographic(a.longitude,a.latitude,s);t.log("XRGeoAnchor: Placing an object at your lla"),t.log(o),Bt.createGeoAnchor(o).then(function(t){r.geoAnchorMap[e.location.id]={anchor:t},n()}).catch(function(e){t.error("error creating geospatial anchor: ".concat(e)),i(e)})}).catch(function(e){t.error("error getting default elevation: ".concat(e)),i(e)})}).catch(function(e){t.error("error getting device cartographic location: ".concat(e)),i(e)})})}},{key:"addGeoAnchoredNode",value:function(e,t){if(t.log("adding a geotracked node"),e.node)if(this.session)if(this.geoAnchorMap[e.location.id]){var r=this.geoAnchorMap[e.location.id],n=e.callback,i=e.node;this._removeAnchorFromNode(r.anchor),t.log("add our node"),this.addAnchoredNode(r.anchor,i,t),n&&n(e)}else t.error("not geolocation anchor for object",e.location.id);else t.log("no session");else t.log("Missing threejs node")}},{key:"stopGeoTracker",value:function(e,t){e&&e.node&&this._removeAnchorForNode(e.node)}},{key:"_handleAnchorDelete",value:function(e,t){e.log("delete anchor");var r=t.source;this._removeAnchorFromNode(r)}},{key:"_removeAnchorForNode",value:function(e){var t=this;this._anchoredNodes.forEach(function(r){r.node===e&&t._removeAnchorFromNode(e.anchor)})}},{key:"_removeAnchorFromNode",value:function(e){var t=this._anchoredNodes.get(e.uid);t&&(t.node.anchor=null,e.removeEventListener("update",e._handleAnchorUpdateCallback),e.removeEventListener("removed",e._handleAnchorDeleteCallback),e._handleAnchorUpdateCallback=null,e._handleAnchorDeleteCallback=null,this._anchoredNodes.delete(e.uid))}},{key:"_handleAnchorUpdate",value:function(e,t){var r=t.source,n=this._anchoredNodes.get(r.uid);if(n){var i=n.node;i.matrixAutoUpdate=!1,i.matrix.fromArray(r.modelMatrix),i.updateMatrixWorld(!0)}}}],[{key:"supportsARKit",value:function(){return navigator.xr&&navigator.xr._mozillaXRViewer?(console.log("*** Found mozilla xr viewer"),!0):(console.log("*** Did not find WebXR"),!1)}}]),e}(),Ut=r(1),zt=function(e,t){var r,n,i,a,s;this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.target=new Ut.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.25,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.enableKeys=!0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={ORBIT:Ut.MOUSE.LEFT,ZOOM:Ut.MOUSE.MIDDLE,PAN:Ut.MOUSE.RIGHT},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=function(){return f.phi},this.getAzimuthalAngle=function(){return f.theta},this.saveState=function(){o.target0.copy(o.target),o.position0.copy(o.object.position),o.zoom0=o.object.zoom},this.reset=function(){o.target.copy(o.target0),o.object.position.copy(o.position0),o.object.zoom=o.zoom0,o.object.updateProjectionMatrix(),o.dispatchEvent(c),o.update(),p=h.NONE},this.update=(r=new Ut.Vector3,n=(new Ut.Quaternion).setFromUnitVectors(e.up,new Ut.Vector3(0,1,0)),i=n.clone().inverse(),a=new Ut.Vector3,s=new Ut.Quaternion,function(){var e=o.object.position;return r.copy(e).sub(o.target),r.applyQuaternion(n),f.setFromVector3(r),o.autoRotate&&p===h.NONE&&E(2*Math.PI/60/60*o.autoRotateSpeed),f.theta+=v.theta,f.phi+=v.phi,f.theta=Math.max(o.minAzimuthAngle,Math.min(o.maxAzimuthAngle,f.theta)),f.phi=Math.max(o.minPolarAngle,Math.min(o.maxPolarAngle,f.phi)),f.makeSafe(),f.radius*=m,f.radius=Math.max(o.minDistance,Math.min(o.maxDistance,f.radius)),o.target.add(y),r.setFromSpherical(f),r.applyQuaternion(i),e.copy(o.target).add(r),o.object.lookAt(o.target),!0===o.enableDamping?(v.theta*=1-o.dampingFactor,v.phi*=1-o.dampingFactor):v.set(0,0,0),m=1,y.set(0,0,0),!!(g||a.distanceToSquared(o.object.position)>d||8*(1-s.dot(o.object.quaternion))>d)&&(o.dispatchEvent(c),a.copy(o.object.position),s.copy(o.object.quaternion),g=!1,!0)}),this.dispose=function(){o.domElement.removeEventListener("contextmenu",Y,!1),o.domElement.removeEventListener("mousedown",G,!1),o.domElement.removeEventListener("wheel",U,!1),o.domElement.removeEventListener("touchstart",H,!1),o.domElement.removeEventListener("touchend",V,!1),o.domElement.removeEventListener("touchmove",W,!1),document.removeEventListener("mousemove",B,!1),document.removeEventListener("mouseup",F,!1),window.removeEventListener("keydown",z,!1)};var o=this,c={type:"change"},u={type:"start"},l={type:"end"},h={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},p=h.NONE,d=1e-6,f=new Ut.Spherical,v=new Ut.Spherical,m=1,y=new Ut.Vector3,g=!1,b=new Ut.Vector2,w=new Ut.Vector2,O=new Ut.Vector2,k=new Ut.Vector2,A=new Ut.Vector2,S=new Ut.Vector2,x=new Ut.Vector2,M=new Ut.Vector2,C=new Ut.Vector2;function j(){return Math.pow(.95,o.zoomSpeed)}function E(e){v.theta-=e}function P(e){v.phi-=e}var D,R=(D=new Ut.Vector3,function(e,t){D.setFromMatrixColumn(t,0),D.multiplyScalar(-e),y.add(D)}),L=function(){var e=new Ut.Vector3;return function(t,r){e.setFromMatrixColumn(r,1),e.multiplyScalar(t),y.add(e)}}(),I=function(){var e=new Ut.Vector3;return function(t,r){var n=o.domElement===document?o.domElement.body:o.domElement;if(o.object.isPerspectiveCamera){var i=o.object.position;e.copy(i).sub(o.target);var a=e.length();a*=Math.tan(o.object.fov/2*Math.PI/180),R(2*t*a/n.clientHeight,o.object.matrix),L(2*r*a/n.clientHeight,o.object.matrix)}else o.object.isOrthographicCamera?(R(t*(o.object.right-o.object.left)/o.object.zoom/n.clientWidth,o.object.matrix),L(r*(o.object.top-o.object.bottom)/o.object.zoom/n.clientHeight,o.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),o.enablePan=!1)}}();function T(e){o.object.isPerspectiveCamera?m/=e:o.object.isOrthographicCamera?(o.object.zoom=Math.max(o.minZoom,Math.min(o.maxZoom,o.object.zoom*e)),o.object.updateProjectionMatrix(),g=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),o.enableZoom=!1)}function N(e){o.object.isPerspectiveCamera?m*=e:o.object.isOrthographicCamera?(o.object.zoom=Math.max(o.minZoom,Math.min(o.maxZoom,o.object.zoom/e)),o.object.updateProjectionMatrix(),g=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),o.enableZoom=!1)}function G(e){if(!1!==o.enabled){switch(e.preventDefault(),e.button){case o.mouseButtons.ORBIT:if(!1===o.enableRotate)return;!function(e){b.set(e.clientX,e.clientY)}(e),p=h.ROTATE;break;case o.mouseButtons.ZOOM:if(!1===o.enableZoom)return;!function(e){x.set(e.clientX,e.clientY)}(e),p=h.DOLLY;break;case o.mouseButtons.PAN:if(!1===o.enablePan)return;!function(e){k.set(e.clientX,e.clientY)}(e),p=h.PAN}p!==h.NONE&&(document.addEventListener("mousemove",B,!1),document.addEventListener("mouseup",F,!1),o.dispatchEvent(u))}}function B(e){if(!1!==o.enabled)switch(e.preventDefault(),p){case h.ROTATE:if(!1===o.enableRotate)return;!function(e){w.set(e.clientX,e.clientY),O.subVectors(w,b);var t=o.domElement===document?o.domElement.body:o.domElement;E(2*Math.PI*O.x/t.clientWidth*o.rotateSpeed),P(2*Math.PI*O.y/t.clientHeight*o.rotateSpeed),b.copy(w),o.update()}(e);break;case h.DOLLY:if(!1===o.enableZoom)return;!function(e){M.set(e.clientX,e.clientY),C.subVectors(M,x),C.y>0?T(j()):C.y<0&&N(j()),x.copy(M),o.update()}(e);break;case h.PAN:if(!1===o.enablePan)return;!function(e){A.set(e.clientX,e.clientY),S.subVectors(A,k),I(S.x,S.y),k.copy(A),o.update()}(e)}}function F(e){!1!==o.enabled&&(document.removeEventListener("mousemove",B,!1),document.removeEventListener("mouseup",F,!1),o.dispatchEvent(l),p=h.NONE)}function U(e){!1===o.enabled||!1===o.enableZoom||p!==h.NONE&&p!==h.ROTATE||(e.preventDefault(),e.stopPropagation(),function(e){e.deltaY<0?N(j()):e.deltaY>0&&T(j()),o.update()}(e),o.dispatchEvent(u),o.dispatchEvent(l))}function z(e){!1!==o.enabled&&!1!==o.enableKeys&&!1!==o.enablePan&&function(e){switch(e.keyCode){case o.keys.UP:I(0,o.keyPanSpeed),o.update();break;case o.keys.BOTTOM:I(0,-o.keyPanSpeed),o.update();break;case o.keys.LEFT:I(o.keyPanSpeed,0),o.update();break;case o.keys.RIGHT:I(-o.keyPanSpeed,0),o.update()}}(e)}function H(e){if(!1!==o.enabled){switch(e.touches.length){case 1:if(!1===o.enableRotate)return;!function(e){b.set(e.touches[0].pageX,e.touches[0].pageY)}(e),p=h.TOUCH_ROTATE;break;case 2:if(!1===o.enableZoom)return;!function(e){var t=e.touches[0].pageX-e.touches[1].pageX,r=e.touches[0].pageY-e.touches[1].pageY,n=Math.sqrt(t*t+r*r);x.set(0,n)}(e),p=h.TOUCH_DOLLY;break;case 3:if(!1===o.enablePan)return;!function(e){k.set(e.touches[0].pageX,e.touches[0].pageY)}(e),p=h.TOUCH_PAN;break;default:p=h.NONE}p!==h.NONE&&o.dispatchEvent(u)}}function W(e){if(!1!==o.enabled)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:if(!1===o.enableRotate)return;if(p!==h.TOUCH_ROTATE)return;!function(e){w.set(e.touches[0].pageX,e.touches[0].pageY),O.subVectors(w,b);var t=o.domElement===document?o.domElement.body:o.domElement;E(2*Math.PI*O.x/t.clientWidth*o.rotateSpeed),P(2*Math.PI*O.y/t.clientHeight*o.rotateSpeed),b.copy(w),o.update()}(e);break;case 2:if(!1===o.enableZoom)return;if(p!==h.TOUCH_DOLLY)return;!function(e){var t=e.touches[0].pageX-e.touches[1].pageX,r=e.touches[0].pageY-e.touches[1].pageY,n=Math.sqrt(t*t+r*r);M.set(0,n),C.subVectors(M,x),C.y>0?N(j()):C.y<0&&T(j()),x.copy(M),o.update()}(e);break;case 3:if(!1===o.enablePan)return;if(p!==h.TOUCH_PAN)return;!function(e){A.set(e.touches[0].pageX,e.touches[0].pageY),S.subVectors(A,k),I(S.x,S.y),k.copy(A),o.update()}(e);break;default:p=h.NONE}}function V(e){!1!==o.enabled&&(o.dispatchEvent(l),p=h.NONE)}function Y(e){!1!==o.enabled&&e.preventDefault()}o.domElement.addEventListener("contextmenu",Y,!1),o.domElement.addEventListener("mousedown",G,!1),o.domElement.addEventListener("wheel",U,!1),o.domElement.addEventListener("touchstart",H,!1),o.domElement.addEventListener("touchend",V,!1),o.domElement.addEventListener("touchmove",W,!1),this.update()};(zt.prototype=Object.create(Ut.EventDispatcher.prototype)).constructor=Ut.OrbitControls,Object.defineProperties(zt.prototype,{center:{get:function(){return console.warn("THREE.OrbitControls: .center has been renamed to .target"),this.target}},noZoom:{get:function(){return console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),!this.enableZoom},set:function(e){console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),this.enableZoom=!e}},noRotate:{get:function(){return console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),!this.enableRotate},set:function(e){console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),this.enableRotate=!e}},noPan:{get:function(){return console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),!this.enablePan},set:function(e){console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),this.enablePan=!e}},noKeys:{get:function(){return console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),!this.enableKeys},set:function(e){console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),this.enableKeys=!e}},staticMoving:{get:function(){return console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),!this.enableDamping},set:function(e){console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),this.enableDamping=!e}},dynamicDampingFactor:{get:function(){return console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor},set:function(e){console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor=e}}});var Ht=zt,Wt=r(22),Vt=Wt.SET_PROPERTY,Yt=Wt.INSERT_ELEMENT,Xt=Wt.DELETE_ELEMENT,Zt=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this))).canvas=e,r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"logger",value:function(){return this.canvas.props.provider.getLogger()}},{key:"getCurrentScene",value:function(){var e=this.canvas.props.provider.getSelectedSceneObject();return e&&e.exists()?e:(this.logger.error("the current scene is null"),null)}},{key:"getSceneObjects",value:function(e){return e.getChildren().filter(function(e){return rt(e.type)})}},{key:"getBehaviorsForObject",value:function(e){return e.getChildren().filter(function(e){return e.type===et.BEHAVIOR})}},{key:"getThreeObject",value:function(e){return e.id?this.canvas.findNode(e.id):this.canvas.findNode(e)}},{key:"getParsedBehaviorAsset",value:function(e){var t=this.canvas.props.provider,r=t.accessObject(e.behavior);return t.getCachedBehaviorAsset(r.id)}},{key:"getAllBehaviors",value:function(){return this.canvas.props.provider.accessObject(this.canvas.props.provider.getSceneRoot()).find(function(e){return e.type===et.BEHAVIOR})}},{key:"getAllScenes",value:function(){return this.canvas.props.provider.accessObject(this.canvas.props.provider.getSceneRoot()).find(function(e){return e.type===et.SCENE})}},{key:"navigateScene",value:function(e){this.canvas.props.provider.accessObject(e).exists()?x.h.setSelection(e):this.canvas.props.provider.getLogger().error("cannot navigate to a scene that doesn't exist",e)}},{key:"playMediaAsset",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.canvas.props.provider.assetsManager.playMediaAsset(e,t)}},{key:"stopMediaAsset",value:function(e){this.canvas.props.provider.assetsManager.stopMediaAsset(e)}},{key:"setMediaVolume",value:function(e,t){this.canvas.props.provider.assetsManager.setMediaVolume(e,t)}},{key:"isMediaAssetPlaying",value:function(e){return this.canvas.props.provider.assetsManager.isMediaAssetPlaying(e)}},{key:"getGraphObjectByName",value:function(e){var t=this.canvas.props.provider.accessObject(this.canvas.props.provider.getSceneRoot()).find(function(t){return t.title===e});return!t||t.length<1?null:t[0]}},{key:"getGraphObjectById",value:function(e){return this.canvas.props.provider.accessObject(e)}},{key:"getCamera",value:function(){return this.canvas.camera}},{key:"getTweenManager",value:function(){return this.canvas.tweenManager}},{key:"getFloorNear",value:function(e){return this.canvas.getFloorNear(e)}},{key:"startLocalAnchor",value:function(e){return this.canvas.startLocalAnchor(e)}},{key:"stopLocalAnchor",value:function(e){return this.canvas.stopLocalAnchor(e)}},{key:"startImageRecognizer",value:function(e){return this.canvas.startImageRecognizer(e)}},{key:"stopImageRecognizer",value:function(e){return this.canvas.stopImageRecognizer(e)}},{key:"startGeoTracker",value:function(e){return this.canvas.startGeoTracker(e)}},{key:"stopGeoTracker",value:function(e){return this.canvas.stopGeoTracker(e)}}]),t}(mt),Kt=.1,qt=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).moveCameraForward=function(){r.camera.position.z+=-Kt},r.moveCameraBackward=function(){r.camera.position.z+=Kt},r.handleKeyPress=function(e){"ArrowUp"===e.key&&(r.camera.position.z-=Kt),"ArrowDown"===e.key&&(r.camera.position.z+=Kt),"a"===e.key&&(r.camera.position.x-=Kt),"d"===e.key&&(r.camera.position.x+=Kt),"ArrowLeft"===e.key&&(r.camera.rotation.y+=.1),"ArrowRight"===e.key&&(r.camera.rotation.y-=.1)},r.recenterOnSelection=function(){var e=x.h.getSelection();if(e){var t=r.props.provider.accessObject(e);if(rt(t.type)){var n=r.findNode(e);if(!n)return;r.orbitControls.target0.copy(n.position);var i=n.position.clone().sub(new Q.Vector3(0,0,-2));r.orbitControls.position0.copy(i),r.orbitControls.reset()}t.type===et.SCENE&&(r.orbitControls.saveState(),r.orbitControls.target0.set(0,0,0),r.orbitControls.position0.set(1,6,6),r.orbitControls.reset())}},r.pauseQueue=function(e){r.props.provider.pauseQueue()},r.unpauseQueue=function(e){r.props.provider.unpauseQueue()},r.transformChanged=function(e){var t=x.h.getSelection();if(t){var n=r.props.provider.accessObject(t);if(!rt(n.type))return;if(n.type===_e.bg360)return;var i=r.findNode(t);if(!i)return;var a=r.props.provider;a.quick_setPropertyValue(t,"tx",i.position.x),a.quick_setPropertyValue(t,"ty",i.position.y),a.quick_setPropertyValue(t,"tz",i.position.z)}},r.transformDraggingChanged=function(e){r.orbitControls.enabled=!e.value},r.docSwapped=function(e){r.scenes.forEach(function(e){return r.scene.remove(e)}),r.scenes=[],r.obj_node_map={},r.setState({scene:-1});var t=r.props.provider.getDocGraph();r.rebuildNode(t,"");var n=r.props.provider.getSelectedSceneObject();if(!n.exists())return r.props.provider.getLogger().error("no selected scene found");var i=r.findNode(n.id);r.setCurrentSceneWrapper(i,!1)},r.selectionChanged=function(){r.transformControls.detach();var e=x.h.getSelection();if(e){var t=r.props.provider.accessObject(e);if(t.type===et.SCENE)return r.setCurrentSceneWrapper(r.findNode(e),!0);if(rt(t.type)){var n=r.props.provider.findSceneObjectParent(t);r.setCurrentSceneWrapper(r.findNode(n.id),!0);var i=r.findNode(e);if(!i)return;r.transformControls.attach(i)}else console.log("selected something not an object or scene")}},r.clickedCanvas=function(e){r.canvas.focus();var t=r.canvas.getBoundingClientRect(),n={x:(e.clientX-t.left)/t.width*2-1,y:-(e.clientY-t.top)/t.height*2+1};r.raycaster.setFromCamera(n,r.camera);var i=r.raycaster.intersectObjects(r.getCurrentSceneWrapper().children,!0);if(i&&i.length>=1){var a=function e(t){return t?t.userData.graphid?t:e(t.parent):null}(i[0].object);r.state.running?r.scriptManager.performClickAction(r.props.provider.accessObject(a.userData.graphid),e):x.h.setSelection(a.userData.graphid)}else x.h.clearSelection()},r.obj_node_map={},r.previewUpdateNodes=[],r.scenes=[],r.state={scene:-1,running:e.running},r.current_scene_wrapper=null,r.scriptManager=new gt(new Zt(Object(d.a)(Object(d.a)(r))),r.props.provider.getLogger()),r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"rebuildNode",value:function(e,t){var r=this;if(e.type===et.SCENE){var n=(new dt).makeNode(e,this.props.provider);this.insertNodeMapping(e.id,n),this.addSceneWrapper(n)}if(rt(e.type)){var i=at(e.type).makeNode(e,this.props.provider);this.insertNodeMapping(e.id,i),this.findNode(e.parent).add(i)}e.children&&e.children.forEach(function(e){r.rebuildNode(e,t+"   ")})}},{key:"checkAspectRatio",value:function(){if(this.canvas){var e=this.wrapper.clientWidth,t=this.wrapper.clientHeight,r=e/t;Math.abs(this.camera.aspect-r)>.001&&(this.camera.aspect=r,this.camera.updateProjectionMatrix(),this.renderer.setSize(e-4,t-4))}}},{key:"componentDidMount",value:function(){var e=this,t=this.canvas;this.props.provider.getLogger().log("mounting VRCanvas"),Ft.supportsARKit()?(this.xr=new Ft,this.xr.getContext(t).then(function(r){e.setupRenderer(t,r),e.xr.setAnimationLoop(e.animationLoopWithCamera.bind(e))}).catch(function(e){console.error("Error",e)})):(this.setupRenderer(t,0),this.renderer.setAnimationLoop(this.animationLoop.bind(this)))}},{key:"componentWillUnmount",value:function(){this.saveOrbitControlsState(),this.transformControls.removeEventListener("change",this.transformChanged),this.transformControls.removeEventListener("mouseDown",this.pauseQueue),this.transformControls.removeEventListener("mouseUp",this.unpauseQueue),this.props.provider.off(x.j.DOCUMENT_SWAPPED,this.docSwapped),x.h.off(x.g.CHANGED,this.selectionChanged)}},{key:"setupRenderer",value:function(e,t){var r=this;this.scene=new Q.Scene,this.camera=new Q.PerspectiveCamera(50,e.width/e.height,.1,1e3),this.renderer=new Q.WebGLRenderer({antialias:!1,canvas:e,context:t}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.gammaOutput=!0,this.audioListener=new Q.AudioListener,this.props.provider.setAudioListener(this.audioListener),this.camera.add(this.audioListener),this.xr||(this.scene.background=new Q.Color(0)),this.scene.add(this.camera),this.camera.position.set(1,6,6),this.transformControls=new de(this.camera,this.renderer.domElement),this.transformControls.addEventListener("change",this.transformChanged),this.transformControls.addEventListener("dragging-changed",this.transformDraggingChanged),this.transformControls.addEventListener("mouseDown",this.pauseQueue),this.transformControls.addEventListener("mouseUp",this.unpauseQueue),this.scene.add(this.transformControls),this.orbitControls=new Ht(this.camera,this.renderer.domElement),this.orbitControls.update(),this.raycaster=new Q.Raycaster;var n=new Q.DirectionalLight(16777215,1);n.position.set(1,1,1).normalize(),this.scene.add(n),this.scene.add(new Q.AmbientLight(16777215,.4)),this.tweenManager=new Dt,this.props.provider.onRawChange(function(e){return r.updateScene(e)}),this.props.provider.on(x.j.DOCUMENT_SWAPPED,this.docSwapped),x.h.on(x.g.CHANGED,this.selectionChanged),this.docSwapped()}},{key:"animationLoop",value:function(e,t){this.checkAspectRatio();var r=null;this.xr&&(r=this.xr.session),this.state.running&&this.scriptManager.tick(e,r),this.tweenManager&&this.tweenManager.update(e),this.orbitControls&&this.orbitControls.update(),this.previewUpdateNodes.forEach(function(e){return e.previewUpdate()}),this.renderer.render(this.scene,this.camera)}},{key:"animationLoopWithCamera",value:function(e,t,r,n,i){this.scene&&this.camera&&(this.camera.matrix.fromArray(r),this.camera.matrixWorldNeedsUpdate=!0,this.camera.updateMatrixWorld(),this.camera.projectionMatrix.fromArray(t),this.animationLoop(n,i))}},{key:"insertNodeMapping",value:function(e,t){if("string"!==typeof e)throw new Error("cannot map an object to an object. invalid call in insertNodeMapping");this.obj_node_map[e]=t,t.userData.graphid=e,t.previewUpdate&&this.previewUpdateNodes.push(t)}},{key:"removeNodeMapping",value:function(e,t){delete this.obj_node_map[e],delete t.userData.graphid,this.previewUpdateNodes=this.previewUpdateNodes.filter(function(e){return e!==t})}},{key:"findNode",value:function(e){return this.obj_node_map[e]||console.warn("could not find node for id",e),this.obj_node_map[e]}},{key:"updateScene",value:function(e){var t=this.props.provider;if(e.type!==Yt)if(e.type!==Vt)if(e.type!==Xt)   ;else{this.transformControls.detach();var r=this.findNode(e.value);r&&(this.removeNodeMapping(e.value,r),rt(t.accessObject(e.value).type)&&r.parent.remove(r))}else{if("parent"===e.name)return;var n=this.findNode(e.object);if(n){var i=t.accessObject(e.object);if("scene"===i.type)return void(new dt).updateProperty(n,i,e,this.props.provider);if(rt(i.type))return at(i.type).updateProperty(n,i,e,this.props.provider)}else console.log("could not find the node for object id:",e)}else{var a=e.value,s=t.accessObject(e.value);if(s.type===et.SCENE)return this.populateNode(a);if(rt(s.type))return this.populateNode(a);if(s.type===et.ASSET)return;if(s.type===et.ASSETS_LIST)return;if(s.type===et.BEHAVIOR_SCRIPT)return;if(s.type===et.BEHAVIOR)return;if(s.type===et.BEHAVIORS_LIST)return;console.warn("unknown object type",s)}}},{key:"shouldComponentUpdate",value:function(e,t,r){return"running"in e&&e.running!==this.props.running&&(this.setState({running:e.running}),!1===e.running?(this.scriptManager.stopRunning(),this.stopAllMedia(),this.resetSceneGraph(),this.stopRecognizers()):(this.startRecognizers(),this.scriptManager.startRunning(),this.scriptManager.startFirstScene()),!1)}},{key:"render",value:function(){var e=this;return i.a.createElement("div",{style:{borderWidth:0,boxSizing:"border-box",height:"100%",display:"flex",flexDirection:"column"}},i.a.createElement("button",{onClick:this.recenterOnSelection},"recenter on selection"),i.a.createElement("div",{style:{boxSizing:"border-box",borderWidth:0,margin:0,padding:0,flex:1,overflow:"auto"},ref:function(t){return e.wrapper=t}},i.a.createElement("canvas",{ref:function(t){return e.canvas=t},style:{boxSizing:"border-box",margin:0,padding:0,width:"100px",height:"100px",borderWidth:0},onClick:this.clickedCanvas,className:"editable-canvas",onKeyDown:this.handleKeyPress,tabIndex:0})))}},{key:"populateNode",value:function(e){var t=this.props.provider.accessObject(e);if(rt(t.type)){var r=at(t.type).makeNode(t,this.props.provider);this.insertNodeMapping(e,r);var n=this.findNode(t.parent);return n?(n.add(r),this.rebuildParentLink(t),r):null}if(t.type===et.SCENE){var i=(new dt).makeNode(t,this.props.provider);return this.insertNodeMapping(e,i),this.addSceneWrapper(i),this.setCurrentSceneWrapper(i,!0),i}console.warn("cannot populate node for type",t.type)}},{key:"rebuildParentLink",value:function(e){var t=this;e.getChildren().forEach(function(r){var n=t.findNode(r.id);n.parent||t.findNode(e.id).add(n),t.rebuildParentLink(r)})}},{key:"addSceneWrapper",value:function(e){this.scenes.push(e),this.scene.add(e)}},{key:"saveOrbitControlsState",value:function(){var e=this.scenes.find(function(e){return e.visible});this.orbitControls.saveState();var t=e.userData.graphid;this.props.provider.orbit_state[t]={target:this.orbitControls.target0.clone(),position:this.orbitControls.position0.clone()}}},{key:"restoreOrbitControlsState",value:function(e){var t=e.userData.graphid;if(this.props.provider.orbit_state[t]){var r=this.props.provider.orbit_state[t];this.orbitControls.target0.copy(r.target),this.orbitControls.position0.copy(r.position),this.orbitControls.reset()}}},{key:"setCurrentSceneWrapper",value:function(e,t){if(!e)return this.props.provider.getLogger().error("invalid scene. cannot setCurrentSceneWrapper");var r=this.getCurrentSceneWrapper(),n=e!==r;n&&t&&this.saveOrbitControlsState(),this.current_scene_wrapper=e,this.scenes.forEach(function(t){t.visible=t===e}),n&&this.restoreOrbitControlsState(e)}},{key:"dumpScenes",value:function(){var e=this;this.scenes.forEach(function(t){console.log("scene"),e.dump(t,"")})}},{key:"dump",value:function(e,t){var r=this;console.log(t+"",e.type,e.id,"vis",e.visible),"Mesh"===e.type&&console.log(t+"  ",e.geometry.type),e.children&&e.children.forEach(function(e){return r.dump(e,t+"  ")})}},{key:"getCurrentSceneWrapper",value:function(){return this.current_scene_wrapper}},{key:"resetSceneGraph",value:function(){var e=this;Object.keys(this.obj_node_map).forEach(function(t){var r=e.props.provider.accessObject(t),n=e.obj_node_map[t];if("scene"!==r.type&&rt(r.type)){var i=at(r.type);i.reset&&i.reset(n,r,e.props.provider.getDataGraph())}})}},{key:"stopAllMedia",value:function(){this.props.provider.assetsManager.stopAllMedia()}},{key:"startRecognizers",value:function(){}},{key:"stopRecognizers",value:function(){}},{key:"getFloorNear",value:function(e){this.props.provider.getLogger().log("NOTHING DONE TO get floor near")}},{key:"startLocalAnchor",value:function(e){this.props.provider.getLogger().log("NOTHING DONE TO start local anchor")}},{key:"stopLocalAnchor",value:function(e){this.props.provider.getLogger().log("NOTHING DONE TO stop local anchor")}},{key:"startImageRecognizer",value:function(e){this.props.provider.getLogger().log("NOTHING DONE TO start image recognizer")}},{key:"stopImageRecognizer",value:function(e){this.props.provider.getLogger().log("NOTHING DONE TO stop image recognizer")}},{key:"startGeoTracker",value:function(e){this.props.provider.getLogger().log("NOTHING DONE TO start geo recognizer")}},{key:"stopGeoTracker",value:function(e){this.props.provider.getLogger().log("NOTHING DONE TO stop geo recognizer")}},{key:"startWorldInfo",value:function(e){this.props.provider.getLogger().log("NOTHING DONE TO start world info")}},{key:"stopWorldInfo",value:function(e){this.props.provider.getLogger().log("NOTHING DONE TO stop world info")}}]),t}(n.Component),Qt=r(10),Jt=function(e,t,r){return e.addEventListener(t,r)},$t=function(e,t,r){return e.removeEventListener(t,r)},_t=function(e){return e*Math.PI/180},er=function(e){function t(e,r){var n;return Object(o.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this))).startHover=function(){return n.arrow.material.color.set(16777215)},n.endHover=function(){return n.arrow.material.color.set(16776960)},n.beginDrag=function(e){n.startPoint=n.parent.position.clone(),n.startPoint.copy(e.intersection.point),n.parent.target.parent.worldToLocal(n.startPoint),n.oldFilter=n.parent.pointer.intersectionFilter,n.parent.pointer.intersectionFilter=function(e){return e.userData.draggable},n.startPosition=n.parent.target.position.clone(),n.plane.visible=!0,Jt(n.plane,Qt.d,n.updateDrag),Jt(n.plane,Qt.f,n.endDrag)},n.updateDrag=function(e){n.endPoint=e.intersection.point.clone(),n.parent.target.parent.worldToLocal(n.endPoint),"X"===n.axis&&(n.endPoint.y=n.startPoint.y,n.endPoint.z=n.startPoint.z),"Y"===n.axis&&(n.endPoint.x=n.startPoint.x,n.endPoint.z=n.startPoint.z),"Z"===n.axis&&(n.endPoint.x=n.startPoint.x,n.endPoint.y=n.startPoint.y);var t=n.endPoint.clone().sub(n.startPoint),r=n.startPosition.clone().add(t);n.parent.target.position.copy(r),n.parent.position.copy(r)},n.endDrag=function(e){$t(n.plane,Qt.d,n.updateDrag),$t(n.plane,Qt.f,n.endDrag),n.parent.pointer.intersectionFilter=n.oldFilter,n.plane.visible=!1,n.parent.dispatchEvent({type:"change",start:n.startPosition.clone(),end:n.parent.position.clone()})},n.axis=e,n.control=r,n.makePlane(),n.makeArrow(),n.makeInputGrabber(),n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"makePlane",value:function(){this.plane=new Q.Mesh(new Q.PlaneBufferGeometry(100,100,100,100),new Q.MeshBasicMaterial({visible:!0,wireframe:!0,side:Q.DoubleSide})),"Z"===this.axis&&(this.plane.rotation.y=_t(90)),this.plane.userData.draggable=!0,this.plane.visible=!1,this.add(this.plane)}},{key:"makeArrow",value:function(){this.arrow=new Q.Mesh(new Q.CylinderBufferGeometry(.02,.02,4),new Q.MeshLambertMaterial({color:"yellow"})),"X"===this.axis&&(this.arrow.rotation.z=_t(90)),"Y"===this.axis&&(this.arrow.rotation.z=_t(180)),"Z"===this.axis&&(this.arrow.rotation.x=_t(90)),this.add(this.arrow)}},{key:"makeInputGrabber",value:function(){this.input=new Q.Mesh(new Q.CylinderBufferGeometry(.1,.1,4),new Q.MeshLambertMaterial({color:"green",visible:!1})),"X"===this.axis&&(this.input.rotation.z=_t(90)),"Y"===this.axis&&(this.input.rotation.z=_t(180)),"Z"===this.axis&&(this.input.rotation.x=_t(90)),this.input.userData.clickable=!0,this.add(this.input)}},{key:"attach",value:function(){Jt(this.input,Qt.b,this.startHover),Jt(this.input,Qt.c,this.endHover),Jt(this.input,Qt.e,this.beginDrag)}},{key:"detach",value:function(){$t(this.input,Qt.b,this.startHover),$t(this.input,Qt.c,this.endHover),$t(this.input,Qt.e,this.beginDrag)}}]),t}(Q.Group),tr=function(e){function t(){var e;return Object(o.a)(this,t),(e=Object(u.a)(this,Object(l.a)(t).call(this))).handles=[],e.handles.push(new er("X",Object(d.a)(Object(d.a)(e)))),e.handles.push(new er("Y",Object(d.a)(Object(d.a)(e)))),e.handles.push(new er("Z",Object(d.a)(Object(d.a)(e)))),e.handles.forEach(function(t){return e.add(t)}),e.visible=!1,e}return Object(h.a)(t,e),Object(c.a)(t,[{key:"attach",value:function(e,t){this.target=e,this.pointer=t,this.position.copy(e.position),this.visible=!0,this.handles.forEach(function(e){return e.attach()})}},{key:"detach",value:function(){this.target=null,this.pointer=null,this.visible=!1,this.handles.forEach(function(e){return e.attach()})}}]),t}(Q.Group),rr=function(e,t,r){return e.addEventListener(t,r)},nr=function(e){function t(e,r){var n;if(Object(o.a)(this,t),n=Object(u.a)(this,Object(l.a)(t).call(this)),!e)throw new Error("cannot pass empty scene to Panel2D()");if(!r)throw new Error("cannot pass empty camera to Panel2D()");n.type="panel2d",n.listeners={},n.scene=e,n.camera=r,n.canvas=document.createElement("canvas"),n.canvas.width=256,n.canvas.height=512,n.canvasTexture=new Q.CanvasTexture(n.canvas),n.redrawHandler=function(e){return n.redraw()};var i=n.canvas.getContext("2d");i.fillStyle="red",i.fillRect(0,0,n.canvas.width,n.canvas.height),n.mesh=new Q.Mesh(new Q.PlaneGeometry(1,2),new Q.MeshBasicMaterial({color:"white",map:n.canvasTexture})),n.mesh.userData.clickable=!0,n.comps=[],n.add(n.mesh);var a=null;return rr(n.mesh,Qt.d,function(e){var t=e.intersection.uv,r=new Q.Vector2(256*t.x,512-512*t.y);a&&!a.contains(r)&&(a.fire(Qt.c),a=null);var i=n.findAt(r);a!==i&&(a&&a.fire(Qt.c),a=null),i&&i.fire(Qt.b),a=i}),rr(n.mesh,Qt.a,function(e){var t=e.intersection.uv,r=new Q.Vector2(256*t.x,512-512*t.y),i=n.findAt(r);i&&i.fire(Qt.a)}),n.header=new Q.Mesh(new Q.BoxGeometry(1,.1,.1),new Q.MeshBasicMaterial({color:"goldenrod"})),n.header.userData.clickable=!0,n.header.position.set(0,1.1,0),n.add(n.header),rr(n.header,Qt.b,function(e){return n.header.material.color.set("yellow")}),rr(n.header,Qt.c,function(e){return n.header.material.color.set("goldenrod")}),rr(n.header,Qt.e,function(e){return n.startDrag()}),n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"fire",value:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].forEach(function(e){return e(t)})}},{key:"findAt",value:function(e){for(var t=0;t<this.comps.length;t++){var r=this.comps[t],n=r.findAt({x:e.x-r.x,y:e.y-r.y});if(n)return n}return null}},{key:"add",value:function(e){e instanceof Q.Object3D?Object(p.a)(Object(l.a)(t.prototype),"add",this).call(this,e):(this.comps.push(e),rr(e,"changed",this.redrawHandler))}},{key:"redraw",value:function(){var e=this.canvas.getContext("2d");e.fillStyle="white",e.fillRect(0,0,this.canvas.width,this.canvas.height),this.comps.forEach(function(t){return t.draw(e)}),this.canvasTexture.needsUpdate=!0}},{key:"startDrag",value:function(){var e=this;this.header.userData.clickable=!1,this.mesh.userData.clickable=!1,this.dragSphere=new Q.Mesh(new Q.SphereGeometry(4,32,32),new Q.MeshLambertMaterial({color:"green",wireframe:!0,side:Q.BackSide})),this.dragSphere.userData.clickable=!0,this.scene.add(this.dragSphere),rr(this.dragSphere,Qt.d,function(t){return e.moveDrag(t)}),rr(this.dragSphere,Qt.f,function(t){return e.endDrag(t)})}},{key:"endDrag",value:function(){this.scene.remove(this.dragSphere),this.dragSphere.userData.clickable=!1,this.header.userData.clickable=!0,this.mesh.userData.clickable=!0}},{key:"moveDrag",value:function(e){this.position.copy(e.point),this.position.add(new Q.Vector3(0,-1,0)),this.lookAt(this.camera.position)}}]),t}(Q.Object3D),ir=function(){function e(){Object(o.a)(this,e),this.listeners={}}return Object(c.a)(e,[{key:"set",value:function(e,t){return this[e]=t,this.fire("changed",{type:"changed",target:this}),this}},{key:"get",value:function(e){return this[e]}},{key:"addEventListener",value:function(e,t){return this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t),this}},{key:"on",value:function(e,t){return this.addEventListener(e,t),this}},{key:"setAll",value:function(e){var t=this;return Object.keys(e).forEach(function(r){return t.set(r,e[r])}),this}},{key:"fire",value:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].forEach(function(e){return e(t)})}}]),e}(),ar=function(e){function t(){var e;return Object(o.a)(this,t),(e=Object(u.a)(this,Object(l.a)(t).call(this))).type="button",e.text="foo",e.x=0,e.y=0,e.fsize=20,e.w=e.text.length*e.fsize,e.h=20,e.normalBg="white",e.hoverBg="red",e.bg=e.normalBg,e.on(Qt.b,function(){e.bg=e.hoverBg,e.fire("changed",{type:"changed",target:Object(d.a)(Object(d.a)(e))})}),e.on(Qt.c,function(){e.bg=e.normalBg,e.fire("changed",{type:"changed",target:Object(d.a)(Object(d.a)(e))})}),e}return Object(h.a)(t,e),Object(c.a)(t,[{key:"draw",value:function(e){e.font="".concat(this.fsize,"px sans-serif");var t=e.measureText(this.text);this.w=5+t.width+5,this.h=0+this.fsize+4,e.fillStyle=this.bg,e.fillRect(this.x,this.y,this.w,this.h),e.fillStyle="black",e.fillText(this.text,this.x+3,this.y+this.fsize-2),e.strokeStyle="black",e.strokeRect(this.x,this.y,this.w,this.h)}},{key:"contains",value:function(e){return!(e.x<this.x)&&(!(e.x>this.x+this.w)&&(!(e.y<this.y)&&!(e.y>this.y+this.h)))}},{key:"findAt",value:function(e){return e.x<0?null:e.x>0+this.w?null:e.y<0?null:e.y>0+this.h?null:this}},{key:"set",value:function(e,r){Object(p.a)(Object(l.a)(t.prototype),"set",this).call(this,e,r),"normalBg"===e&&(this.bg=this.normalBg)}}]),t}(ir),sr=function(e){function t(){var e;return Object(o.a)(this,t),(e=Object(u.a)(this,Object(l.a)(t).call(this))).type="group",e.x=0,e.y=0,e.w=100,e.h=100,e.bg="gray",e.visible=!0,e.comps=[],e.padding=5,e.border=1,e.layout=function(e){console.log("not laying out anything")},e}return Object(h.a)(t,e),Object(c.a)(t,[{key:"draw",value:function(e){this.visible&&(this.layout(this),e.fillStyle=this.bg,e.fillRect(this.x,this.y,this.w,this.h),this.border>0&&(e.strokeStyle="black",e.strokeRect(this.x,this.y,this.w,this.h)),e.save(),e.translate(this.x+this.padding,this.y+this.padding),this.comps.forEach(function(t){return t.draw(e)}),e.restore())}},{key:"contains",value:function(e){return!(e.x<this.x)&&(!(e.x>this.x+this.w)&&(!(e.y<this.y)&&!(e.y>this.y+this.h)))}},{key:"findAt",value:function(e){if(!this.visible)return null;for(var t=0;t<this.comps.length;t++){var r=this.comps[t],n=r.findAt({x:e.x-r.x-5,y:e.y-r.y-5});if(n)return n}return null}},{key:"childSet",value:function(e,t){return this.childProps[e]=t,this.comps.forEach(function(r){return r.set(e,t)}),this}},{key:"add",value:function(e){return this.comps.push(e),this.fire("changed",{type:"changed",target:this}),this}}]),t}(ir),or=function(e){return Math.PI/180*e},cr=new Q.Vector3(0,1,0),ur=function(){function e(t,r){var n=this;Object(o.a)(this,e),this.stagePos=t,this.stageRot=r,this.states={touchpad:!1},this.listeners={},this.keystates={ArrowLeft:{current:!1,previous:!1},ArrowRight:{current:!1,previous:!1},ArrowUp:{current:!1,previous:!1},ArrowDown:{current:!1,previous:!1}},this.dir=new Q.Vector3(0,0,1),document.addEventListener("keydown",function(e){n.keystates[e.key]&&(n.keystates[e.key].current=!0)}),document.addEventListener("keyup",function(e){n.keystates[e.key]&&(n.keystates[e.key].current=!1)})}return Object(c.a)(e,[{key:"addEventListener",value:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}},{key:"_fire",value:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].forEach(function(e){return e(t)})}},{key:"updateKeys",value:function(){var e=this;!1===this.keystates.ArrowLeft.current&&!0===this.keystates.ArrowLeft.previous&&this.rotateLeft(),!1===this.keystates.ArrowRight.current&&!0===this.keystates.ArrowRight.previous&&this.rotateRight(),!1===this.keystates.ArrowUp.current&&!0===this.keystates.ArrowUp.previous&&this.moveForward(),!1===this.keystates.ArrowDown.current&&!0===this.keystates.ArrowDown.previous&&this.moveBackward(),Object.keys(this.keystates).forEach(function(t){e.keystates[t].previous=e.keystates[t].current})}},{key:"rotateLeft",value:function(){this.dir.applyAxisAngle(cr,or(30)),this.stageRot.rotation.y-=or(30)}},{key:"rotateRight",value:function(){this.dir.applyAxisAngle(cr,-or(30)),this.stageRot.rotation.y+=or(30)}},{key:"moveForward",value:function(){this.stagePos.position.add(this.dir),this._fire("move",this.stagePos.position)}},{key:"moveBackward",value:function(){this.stagePos.position.sub(this.dir),this._fire("move",this.stagePos.position)}},{key:"update",value:function(){this.scanGamepads(),this.updateKeys()}},{key:"scanGamepads",value:function(){for(var e=navigator.getGamepads(),t=0;t<e.length;t++){var r=e[t];if(r&&("Daydream Controller"===r.id||"Gear VR Controller"===r.id||"Oculus Go Controller"===r.id||"OpenVR Gamepad"===r.id||r.id.startsWith("Oculus Touch")||r.id.startsWith("Spatial Controller"))){if(r.buttons.length<2)return;var n=r.buttons[0];if(n.pressed&&r.axes&&2===r.axes.length){var i=r.axes[0]<-.5,a=r.axes[0]>.5,s=r.axes[1]<-.5,o=r.axes[1]>.5;s&&!1===this.states.touchpad&&!0===n.pressed&&this.moveForward(),o&&!1===this.states.touchpad&&!0===n.pressed&&this.moveBackward(),i&&!1===this.states.touchpad&&!0===n.pressed&&this.rotateLeft(),a&&!1===this.states.touchpad&&!0===n.pressed&&this.rotateRight()}r.buttons[1].pressed&&console.log("trigger"),!1===this.states.touchpad&&!0===n.pressed&&console.log("pressed"),!0===this.states.touchpad&&!1===n.pressed&&console.log("released"),this.states.touchpad=n.pressed}}}}]),e}();function lr(e){x.h.isEmpty()||(e.accessObject(x.h.getSelection()).removeFromParent(),x.h.clearSelection())}function hr(e){var t=Object.assign({},e.options,{mode:"edit",doc:e.genID("doc")});delete t.AuthModule,document.location="./?".concat(Object(x.x)(t))}function pr(e){var t=[];return P.supportsAssetUpload()?t=t.concat([{title:"image",enabled:P.isLoggedIn(),icon:lt.image,fun:function(){return e.showAddImageAssetDialog()}},{title:"server image",enabled:P.isLoggedIn(),icon:lt.image,fun:function(){return e.showAddServerImageDialog()}},{divider:!0},{title:"GLTF model",enabled:P.isLoggedIn(),icon:lt.model,fun:function(){return e.showAddGLTFAssetDialog()}},{title:"GLB model",enabled:P.isLoggedIn(),icon:lt.model,fun:function(){return e.showAddGLBAssetDialog()}},{divider:!0},{title:"audio file",enabled:P.isLoggedIn(),icon:lt.audio,fun:function(){return e.showAddAudioAssetDialog()}},{title:"existing asset on server",enabled:P.isLoggedIn(),icon:lt.assets,fun:function(){return e.showOpenAssetDialog()}}]):t.push({title:"add asset from glitch",icon:lt.assets,fun:function(){return e.showOpenAssetDialog()}}),t.push({title:"geo location",icon:lt.geoanchor,fun:function(){return e.showAddGeoLocationAssetDialog()}}),t}var dr=r(22),fr=dr.SET_PROPERTY,vr=dr.CREATE_OBJECT,mr=dr.INSERT_ELEMENT,yr=dr.DELETE_ELEMENT,gr=function(e){function t(e,r){var n;return Object(o.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this))).editor=e,n.provider=r,n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"getCurrentScene",value:function(){return this.provider.accessObject(this.editor.currentScene)}},{key:"getSceneObjects",value:function(e){return e.getChildren().filter(function(e){return rt(e.type)})}},{key:"getBehaviorsForObject",value:function(e){return e.getChildren().filter(function(e){return e.type===et.BEHAVIOR})}},{key:"getThreeObject",value:function(e){return this.editor.findNode(e)}},{key:"getParsedBehaviorAsset",value:function(e){var t=this.provider.accessObject(e.behavior);return this.provider.getCachedBehaviorAsset(t.id)}},{key:"getAllBehaviors",value:function(){return this.provider.accessObject(this.provider.getSceneRoot()).find(function(e){return e.type===et.BEHAVIOR})}},{key:"getAllScenes",value:function(){return this.provider.accessObject(this.provider.getSceneRoot()).find(function(e){return e.type===et.SCENE})}},{key:"navigateScene",value:function(e){if(this.provider.accessObject(e).exists())return this.editor.swapScene(e);this.provider.getLogger().error("cannot navigate to scene that does not exist",e)}},{key:"playMediaAsset",value:function(e,t){this.provider.assetsManager.playMediaAsset(e,t)}},{key:"stopMediaAsset",value:function(e){this.provider.assetsManager.stopMediaAsset(e)}},{key:"getGraphObjectByName",value:function(e){var t=this.provider.accessObject(this.provider.getSceneRoot()).find(function(t){return t.title===e});return!t||t.length<1?null:t[0]}},{key:"getGraphObjectById",value:function(e){return this.provider.accessObject(e)}},{key:"getCamera",value:function(){return this.editor.camera}},{key:"getTweenManager",value:function(){return this.editor.tweenManager}},{key:"getFloorNear",value:function(e){this.provider.getLogger().log("NOTHING DONE TO get floor near")}},{key:"startLocalAnchor",value:function(e){this.provider.getLogger().log("NOTHING DONE TO start local anchor")}},{key:"stopLocalAnchor",value:function(e){this.provider.getLogger().log("NOTHING DONE TO stop local anchor")}},{key:"startImageRecognizer",value:function(e){this.provider.getLogger().log("NOTHING DONE TO start image recognizer")}},{key:"stopImageRecognizer",value:function(e){this.provider.getLogger().log("NOTHING DONE TO stop image recognizer")}},{key:"startGeoTracker",value:function(e){this.provider.getLogger().log("NOTHING DONE TO start geo recognizer")}},{key:"stopGeoTracker",value:function(e){this.provider.getLogger().log("NOTHING DONE TO stop geo recognizer")}},{key:"startWorldInformation",value:function(e){return this.provider.getLogger().log("NOTHING DONE TO start world information"),0}},{key:"stopWorldInformation",value:function(e){return this.provider.getLogger().log("NOTHING DONE TO stop world information"),0}}]),t}(mt),br=function(e){function t(e){var r;Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).standardViewClickHandler=function(e){r.scriptManager.isRunning()?r.scriptManager.performClickAction(r.props.provider.accessObject(e.target.userData.graphid),e):x.h.setSelection(e.target.userData.graphid)},r.obj_node_map={},r.previewUpdateNodes=[];var n=Object(x.v)({});if(!n.doc)throw new Error("doc not specified");return r.logger=new T(n.doc),r.scriptManager=new gt(new gr(Object(d.a)(Object(d.a)(r)),r.props.provider),r.logger),r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"shouldComponentUpdate",value:function(e,t,r){return!1}},{key:"render",value:function(){var e=this;return i.a.createElement("div",null,i.a.createElement("div",{id:"overlay"},i.a.createElement("div",{id:"inner"},i.a.createElement("h1",null,"Application Name"),i.a.createElement("div",{id:"loading-indicator"},i.a.createElement("label",null,"loading..."),i.a.createElement("br",null),i.a.createElement("progress",{max:"100",value:"0",id:"progress"})),i.a.createElement("button",{id:"enter-button",disabled:!0},"VR not supported, play anyway"))),i.a.createElement("div",{ref:function(t){return e.wrapper=t}}),i.a.createElement(H.a,null))}},{key:"componentDidMount",value:function(){this.sceneWrappers={},this.initScene(),this.renderer.setAnimationLoop(this.render3.bind(this))}},{key:"render3",value:function(e){this.tweenManager&&this.tweenManager.update(e),this.previewUpdateNodes.forEach(function(e){return e.previewUpdate()}),this.pointer&&this.pointer.tick(e),this.stats&&this.stats.update(e),this.controller&&this.controller.update(e),this.scriptManager.isRunning()&&this.scriptManager.tick(e),this.renderer.render(this.scene,this.camera)}},{key:"initScene",value:function(){var e=this,t=function(e){return document.querySelector(e)},r=function(e,t,r){return e.addEventListener(t,r)},n=this.wrapper;this.tweenManager=new Dt,this.scene=new Q.Scene,this.stageRot=new Q.Group,this.scene.add(this.stageRot),this.stagePos=new Q.Group,this.stageRot.add(this.stagePos),this.camera=new Q.PerspectiveCamera(70,window.innerWidth/window.innerHeight,.1,50),this.renderer=new Q.WebGLRenderer({antialias:!0});var i=this.renderer;i.setPixelRatio(window.devicePixelRatio),i.setSize(window.innerWidth,window.innerHeight),i.gammaOutput=!0,i.vr.enabled=!0,n.appendChild(i.domElement),this.vrmanager=new Qt.h(i),this.audioListener=new Q.AudioListener,this.props.provider.setAudioListener(this.audioListener),this.camera.add(this.audioListener),this.initContent(),window.addEventListener("resize",function(){e.camera.aspect=window.innerWidth/window.innerHeight,e.camera.updateProjectionMatrix(),e.renderer.setSize(window.innerWidth,window.innerHeight)},!1),r(t("#enter-button"),"click",function(){t("#overlay").style.display="none"}),this.vrmanager.addEventListener(Qt.j,function(){console.log("VR detected"),t("#enter-button").removeAttribute("disabled",!1),t("#enter-button").innerText="enter vr",r(t("#enter-button"),"click",function(){return e.vrmanager.enterVR()})});t("#loading-indicator").style.display="none",t("#enter-button").style.display="block",t("#enter-button").removeAttribute("disabled"),this.props.provider.onRawChange(this.updateSceneOp.bind(this)),this.props.provider.on(x.j.DOCUMENT_SWAPPED,this.documentSwapped.bind(this)),x.h.on(x.g.CHANGED,this.selectionChanged.bind(this)),r(this.pointer,Qt.a,function(){return x.h.clearSelection()}),this.controller=new ur(this.stagePos,this.stageRot),this.loadScene()}},{key:"selectionChanged",value:function(){var e=x.h.getSelection();if(null===e&&this.controls)return this.controls.detach(this.selectedNode);var t=this.findNode(e);this.selectedNode!==t&&this.controls&&this.controls.detach(this.selectedNode),this.selectedNode=t,this.selectedNode&&this.controls&&this.controls.attach(this.selectedNode,this.pointer)}},{key:"initContent",value:function(){var e=this;this.xr||(this.scene.background=new Q.Color(0));var t=new Q.DirectionalLight(16777215,1);t.position.set(1,1,1).normalize(),this.scene.add(t),this.scene.add(new Q.AmbientLight(16777215,.2)),this.stats=new Qt.i({renderer:this.renderer}),this.props.editable&&this.camera.add(this.stats),this.scene.add(this.camera),this.camera.matrixAutoUpdate=!1,this.pointer=new Qt.g(this,{intersectionFilter:function(e){return e.userData.clickable},cameraFollowMouse:!1,mouseSimulatesController:!1,enableLaser:!0,laserLength:20});var r=new Q.Mesh(new Q.CylinderBufferGeometry(.1,.1,1),new Q.MeshLambertMaterial({color:"aqua"}));if(r.position.z=-.5,r.rotation.x=st(-90),this.pointer.controller1.add(r),this.props.editable&&(this.controls=new tr,this.controls.name="Controls",Object(x.u)(this.controls,"change",function(t){var r=x.h.getSelection();if(r){var n=e.findNode(r),i=e.props.provider;i.quick_setPropertyValue(r,"tx",n.position.x),i.quick_setPropertyValue(r,"ty",n.position.y),i.quick_setPropertyValue(r,"tz",n.position.z)}})),this.props.editable){this.tools=new nr(this.scene,this.camera),this.tools.position.set(-1,0,-3),this.scene.add(this.tools),this.tools.add((new ar).setAll({x:5,y:5,text:"add box"}).on(Qt.a,function(){var t=e.props.provider.accessObject(e.currentScene);e.props.provider.add3DObject(_e.cube,t)})),this.tools.add((new ar).setAll({x:5,y:35,text:"add sphere"}).on(Qt.a,function(){var t=e.props.provider.accessObject(e.currentScene);e.props.provider.add3DObject(_e.sphere,t)})),this.tools.add((new ar).setAll({x:5,y:65,text:"delete"}).on(Qt.a,function(){lr(e.props.provider)})),this.tools.add((new ar).setAll({x:5,y:95,text:"save"}).on(Qt.a,this.props.provider.save));var n=(new ar).setAll({x:5,y:125,text:"run"}).on(Qt.a,function(){e.scriptManager.isRunning()?(n.set("text","run"),e.scriptManager.stopRunning()):(n.set("text","stop"),e.scriptManager.startRunning(),e.scriptManager.startFirstScene())});this.tools.add(n);var i=(new sr).setAll({x:5,y:155,w:235,h:35,layout:function(e){var t=0;e.comps.forEach(function(r){r.x=t,r.y=0,t+=r.w+e.padding})}});$e.forEach(function(t){i.add((new ar).setAll({text:" ",normalBg:t}).on(Qt.a,function(){return e.props.provider.setColor(t)}))}),this.tools.add(i),this.tools.redraw()}}},{key:"updateSceneOp",value:function(e){if(e.type===vr&&e.defaults&&"scene"===e.defaults.type){var t=this.findNode(e.id);if(t)   ;else{var r=this.props.provider.accessObject(e.id);t=(new dt).makeNode(r,this.props.provider),this.insertNodeMapping(e.id,t),this.sceneWrappers[e.id]=t,this.stagePos.add(t),this.swapScene(e.id)}}if(e.type!==mr)if(e.type!==fr){if(e.type===yr){var n=this.props.provider.accessObject(e.value);if(rt(n.type)){var i=this.findNode(n.id);this.findNode(n.parent).remove(i)}}}else{var a=this.props.provider.accessObject(e.object);if("asset"===a.type)return;if("assets"===a.type)return;var s=this.findNode(e.object);if(s){if("parent"===e.name)return;if("scene"===a.type)return(new dt).updateProperty(s,a,e,this.props.provider);if(rt(a.type))return at(a.type).updateProperty(s,a,e,this.props.provider)}else console.log("could not find the node for object id:",e)}else{var o=this.props.provider.accessObject(e.value);if("scene"===o.type)return;if(rt(o.type)){var c=at(o.type).makeNode(o,this.props.provider);return Object(x.u)(c,Qt.a,this.standardViewClickHandler),this.insertNodeMapping(o.id,c),void this.findNode(o.parent).add(c)}if(o.type===et.ASSETS_LIST)return;if(o.type===et.ASSET)return;if(o.type===et.BEHAVIORS_LIST)return;if(o.type===et.BEHAVIOR)return;if(o.type===et.BEHAVIOR_SCRIPT)return;console.warn("unknown object type",o)}}},{key:"documentSwapped",value:function(){var e=this;console.log("totally new document!"),Object.keys(this.sceneWrappers).forEach(function(t){var r=e.sceneWrappers[t];e.controls&&r.remove(e.controls),e.stagePos.remove(r)}),this.sceneWrappers={},this.obj_node_map={};var t=this.props.provider.getDocGraph();console.log("we are building the graph"),this.rebuildNode(t,"")}},{key:"rebuildNode",value:function(e,t){var r=this;if(console.log(t,"rebuilding",e.type),e.type===et.SCENE){var n=(new dt).makeNode(e,this.props.provider);this.insertNodeMapping(e.id,n),this.sceneWrappers[e.id]=n,this.stagePos.add(n),this.swapScene(e.id)}if(rt(e.type)){var i=at(e.type).makeNode(e,this.props.provider);Object(x.u)(i,Qt.a,this.standardViewClickHandler),this.insertNodeMapping(e.id,i),this.findNode(e.parent).add(i)}e.children&&e.children.forEach(function(e){r.rebuildNode(e,t+"   ")})}},{key:"swapScene",value:function(e){var t=this;this.currentScene=e,console.log("swapping to the scene",e),Object.keys(this.sceneWrappers).forEach(function(r){var n=t.sceneWrappers[r];n.visible=r===e,t.controls&&n.remove(t.controls)}),this.controls&&this.sceneWrappers[e].add(this.controls),this.sceneWrappers[e].position.x=0,this.sceneWrappers[e].position.z=0}},{key:"loadScene",value:function(){}},{key:"insertNodeMapping",value:function(e,t){if("string"!==typeof e)throw new Error("cannot map an object to an object. invalid call in insertNodeMapping");this.obj_node_map[e]=t,t.previewUpdate&&this.previewUpdateNodes.push(t),t.userData.graphid=e}},{key:"findNode",value:function(e){return this.obj_node_map[e]||console.warn("could not find node for id",e),this.obj_node_map[e]}}]),t}(n.Component);function wr(e,t,r,n,i){P.supportsAssetUpload()||(e=n);var a=i.accessObject(i.getDataGraph().createObject({type:et.ASSET,subtype:ct.IMAGE,assetId:e,format:r,src:t,width:100,height:100,title:n,parent:0}));i.accessObject(i.getAssetsObject()).insertChildLast(a),i.requestImageCache(i.assetsManager.getAssetURL(a)).then(function(e){a.set("width",e.width),a.set("height",e.height)})}function Or(e,t){j.add("uploading "+e.name),P.uploadFile(e).then(function(r){return j.add("uploaded"),!1===r.success?console.log("there was an error uploading! :("):wr(null,Object(x.o)()+r.asset.id,r.asset.mimeType,e.name,t)})}function kr(e,t){j.add("uploading "+e.name),t.uploadFile(e).then(function(r){if(j.add("uploaded"),!1===r.success)return console.log("there was an error uploading! :(");var n=Object(x.o)()+r.asset.id,i=t.getDataGraph(),a=B(i,i.createObject({type:et.ASSET,subtype:ct.GLTF,format:ot.GLB,src:n,title:e.name,parent:0}));t.accessObject(t.getAssetsObject()).insertChildLast(a)})}function Ar(e,t,r,n,i){if(n||(n=t.substring(t.lastIndexOf("/")+1)),!r){var a=n.substring(n.lastIndexOf(".")+1);r="audio/unknown","mp3"===a.toLowerCase()&&(r=ot.MP3),"aac"===a.toLowerCase()&&(r=ot.AAC)}P.supportsAssetUpload()||(e=n);var s=i.getDataGraph(),o=B(s,s.createObject({type:et.ASSET,subtype:ct.AUDIO,assetId:e,format:r,src:t,title:n,parent:0}));i.accessObject(i.getAssetsObject()).insertChildLast(o)}var Sr=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).cancel=function(){H.b.hide()},r.okay=function(){var e,t,n,i,a;H.b.hide(),"remote"===r.state.view?(console.log("adding the url",r.state.url),e=r.state.url,t=r.props.provider,n=e.substring(e.lastIndexOf("/")+1),i=n.substring(n.lastIndexOf(".")+1),a="image/unknown","png"===i.toLowerCase()&&(a=ot.PNG),"jpg"===i.toLowerCase()&&(a=ot.JPEG),"jpeg"===i.toLowerCase()&&(a=ot.JPEG),wr(null,e,a,n,t)):(console.log("the file input is",r.fileInput),G(r.fileInput.current.files).forEach(function(e){Or(e,r.props.provider)}))},r.switchLocal=function(){return r.setState({view:"local"})},r.switchRemote=function(){return r.setState({view:"remote"})},r.selectedFile=function(e){r.setState({fileInput:e.target.value})},r.typedURL=function(e){r.setState({url:e.target.value})},r.state={view:"local",url:""},r.fileInput=i.a.createRef(),r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){return i.a.createElement(x.a,{visible:!0,onScrimClick:this.cancel},i.a.createElement("header",null,"add image to assets"),i.a.createElement("section",null,i.a.createElement(H.c,null,i.a.createElement(x.k,{onClick:this.switchLocal,selected:"local"===this.state.view},"local"),i.a.createElement(x.k,{onClick:this.switchRemote,selected:"remote"===this.state.view},"remote")),this.renderSelectedPanel()),i.a.createElement("footer",null,i.a.createElement("button",{onClick:this.cancel},"cancel"),i.a.createElement("button",{onClick:this.okay},"okay")))}},{key:"renderSelectedPanel",value:function(){return"local"===this.state.view?i.a.createElement(H.c,null,i.a.createElement("label",null,"File",i.a.createElement("input",{key:"f1",type:"file",onChange:this.selectedFile,ref:this.fileInput}))):i.a.createElement(H.c,null,i.a.createElement("label",null,"URL",i.a.createElement("input",{key:"f2",value:this.state.url,type:"input",onChange:this.typedURL})))}}]),t}(n.Component),xr=function(e){function t(){var e,r;Object(o.a)(this,t);for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return(r=Object(u.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(i)))).cancel=function(){H.b.hide()},r.okay=function(){H.b.hide(),G(r.fileinput.files).forEach(function(e){console.log("got the file",e)})},r.selectedFile=function(e){console.log("selected a file",e.target)},r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){var e=this;return i.a.createElement(x.a,{visible:!0,onScrimClick:this.cancel},i.a.createElement("header",null,"add GLTF file assets"),i.a.createElement("section",null,i.a.createElement("p",null,"chose ",i.a.createElement("b",null,"the directory")," containing the GLTF file"),i.a.createElement("input",{type:"file",ref:function(t){return e.fileinput=t},onChange:this.selectedFile,multiple:!0,webkitdirectory:"true"})),i.a.createElement("footer",null,i.a.createElement("button",{onClick:this.cancel},"cancel"),i.a.createElement("button",{onClick:this.okay},"okay")))}}]),t}(n.Component),Mr=function(e){function t(){var e,r;Object(o.a)(this,t);for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return(r=Object(u.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(i)))).cancel=function(){H.b.hide()},r.okay=function(){H.b.hide(),G(r.fileinput.files).forEach(function(e){kr(e,r.props.provider)})},r.selectedFile=function(e){console.log("selected a file",e.target)},r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){var e=this;return i.a.createElement(x.a,{visible:!0,onScrimClick:this.cancel},i.a.createElement("header",null,"add GLB to assets"),i.a.createElement("section",null,i.a.createElement("p",null,"choose a local GLB file"),i.a.createElement("input",{type:"file",ref:function(t){return e.fileinput=t},onChange:this.selectedFile,multiple:!0})),i.a.createElement("footer",null,i.a.createElement("button",{onClick:this.cancel},"cancel"),i.a.createElement("button",{onClick:this.okay},"okay")))}}]),t}(n.Component),Cr=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).cancel=function(){H.b.hide()},r.okay=function(){H.b.hide(),"remote"===r.state.view?(console.log("adding the url",r.state.url),Ar(null,r.state.url,r.props.provider)):(console.log("the file input is",r.fileInput),G(r.fileInput.current.files).forEach(function(e){!function(e,t){j.add("uploading"),t.uploadFile(e).then(function(r){if(j.add("uploaded"),console.log("uploaded file with answer",r),!1===r.success)return console.log("there was an error uploading! :(");var n=Object(x.o)()+r.asset.id,i=t.getDataGraph(),a=B(i,i.createObject({type:et.ASSET,subtype:ct.AUDIO,format:r.asset.mimeType,src:n,title:e.name,parent:0}));t.accessObject(t.getAssetsObject()).insertChildLast(a)})}(e,r.props.provider)}))},r.switchLocal=function(){return r.setState({view:"local"})},r.switchRemote=function(){return r.setState({view:"remote"})},r.selectedFile=function(e){r.setState({fileInput:e.target.value})},r.typedURL=function(e){r.setState({url:e.target.value})},r.state={view:"local",url:""},r.fileInput=i.a.createRef(),r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){return i.a.createElement(x.a,{visible:!0,onScrimClick:this.cancel},i.a.createElement("header",null,"add audio to assets"),i.a.createElement("section",null,i.a.createElement(H.c,null,i.a.createElement(x.k,{onClick:this.switchLocal,selected:"local"===this.state.view},"local"),i.a.createElement(x.k,{onClick:this.switchRemote,selected:"remote"===this.state.view},"remote")),this.renderSelectedPanel()),i.a.createElement("footer",null,i.a.createElement("button",{onClick:this.cancel},"cancel"),i.a.createElement("button",{onClick:this.okay},"okay")))}},{key:"renderSelectedPanel",value:function(){return"local"===this.state.view?i.a.createElement(H.c,null,i.a.createElement("label",null,"File",i.a.createElement("input",{key:"f1",type:"file",onChange:this.selectedFile,ref:this.fileInput}))):i.a.createElement(H.c,null,i.a.createElement("label",null,"URL",i.a.createElement("input",{key:"f2",value:this.state.url,type:"input",onChange:this.typedURL})))}}]),t}(n.Component),jr=function(e){function t(){var e,r;Object(o.a)(this,t);for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return(r=Object(u.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(i)))).cancel=function(){H.b.hide()},r.okay=function(){H.b.hide(),r.props.onAnyway()},r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){return i.a.createElement(x.a,{visible:!0,onScrimClick:this.cancel,width:"600px",height:"auto"},i.a.createElement("header",null,"Warning. Your document has unsaved changes."),i.a.createElement("section",null,i.a.createElement("p",null,"Press cancel to go back"),i.a.createElement("p",null,"Press continue to continue anyway and lose the unsaved changes")),i.a.createElement("footer",null,i.a.createElement("button",{onClick:this.cancel},"cancel"),i.a.createElement("button",{onClick:this.okay},"continue!")))}}]),t}(n.Component),Er=r(1),Pr=function(){function e(e){this.timeLoaded=0,this.manager=e||Er.DefaultLoadingManager,this.materials=null,this.verbosity=0,this.attributeOptions={},this.drawMode=Er.TrianglesDrawMode,this.nativeAttributeMap={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"}}return e.prototype={constructor:e,load:function(e,t,r,n){var i=this,a=new Er.FileLoader(i.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.load(e,function(e){i.decodeDracoFile(e,t)},r,n)},setPath:function(e){return this.path=e,this},setVerbosity:function(e){return this.verbosity=e,this},setDrawMode:function(e){return this.drawMode=e,this},setSkipDequantization:function(e,t){var r=!0;return"undefined"!==typeof t&&(r=t),this.getAttributeOptions(e).skipDequantization=r,this},decodeDracoFile:function(t,r,n,i){var a=this;e.getDecoderModule().then(function(e){a.decodeDracoFileInternal(t,e.decoder,r,n,i)})},decodeDracoFileInternal:function(e,t,r,n,i){var a=new t.DecoderBuffer;a.Init(new Int8Array(e),e.byteLength);var s=new t.Decoder,o=s.GetEncodedGeometryType(a);if(o==t.TRIANGULAR_MESH)this.verbosity>0&&console.log("Loaded a mesh.");else{if(o!=t.POINT_CLOUD){var c="THREE.DRACOLoader: Unknown geometry type.";throw console.error(c),new Error(c)}this.verbosity>0&&console.log("Loaded a point cloud.")}r(this.convertDracoGeometryTo3JS(t,s,o,a,n,i))},addAttributeToGeometry:function(e,t,r,n,i,a,s,o){if(0===a.ptr){var c="THREE.DRACOLoader: No attribute "+n;throw console.error(c),new Error(c)}var u,l,h=a.num_components(),p=r.num_points()*h;switch(i){case Float32Array:u=new e.DracoFloat32Array,t.GetAttributeFloatForAllPoints(r,a,u),o[n]=new Float32Array(p),l=Er.Float32BufferAttribute;break;case Int8Array:u=new e.DracoInt8Array,t.GetAttributeInt8ForAllPoints(r,a,u),o[n]=new Int8Array(p),l=Er.Int8BufferAttribute;break;case Int16Array:u=new e.DracoInt16Array,t.GetAttributeInt16ForAllPoints(r,a,u),o[n]=new Int16Array(p),l=Er.Int16BufferAttribute;break;case Int32Array:u=new e.DracoInt32Array,t.GetAttributeInt32ForAllPoints(r,a,u),o[n]=new Int32Array(p),l=Er.Int32BufferAttribute;break;case Uint8Array:u=new e.DracoUInt8Array,t.GetAttributeUInt8ForAllPoints(r,a,u),o[n]=new Uint8Array(p),l=Er.Uint8BufferAttribute;break;case Uint16Array:u=new e.DracoUInt16Array,t.GetAttributeUInt16ForAllPoints(r,a,u),o[n]=new Uint16Array(p),l=Er.Uint16BufferAttribute;break;case Uint32Array:u=new e.DracoUInt32Array,t.GetAttributeUInt32ForAllPoints(r,a,u),o[n]=new Uint32Array(p),l=Er.Uint32BufferAttribute;break;default:c="THREE.DRACOLoader: Unexpected attribute type.";throw console.error(c),new Error(c)}for(var d=0;d<p;d++)o[n][d]=u.GetValue(d);s.addAttribute(n,new l(o[n],h)),e.destroy(u)},convertDracoGeometryTo3JS:function(e,t,r,n,i,a){var s,o;!0===this.getAttributeOptions("position").skipDequantization&&t.SkipAttributeTransform(e.POSITION);var c=performance.now();if(r===e.TRIANGULAR_MESH?(s=new e.Mesh,o=t.DecodeBufferToMesh(n,s)):(s=new e.PointCloud,o=t.DecodeBufferToPointCloud(n,s)),!o.ok()||0==s.ptr){var u="THREE.DRACOLoader: Decoding failed: ";throw u+=o.error_msg(),console.error(u),e.destroy(t),e.destroy(s),new Error(u)}var l,h=performance.now();e.destroy(n),r==e.TRIANGULAR_MESH?(l=s.num_faces(),this.verbosity>0&&console.log("Number of faces loaded: "+l.toString())):l=0;var p=s.num_points(),d=s.num_attributes();this.verbosity>0&&(console.log("Number of points loaded: "+p.toString()),console.log("Number of attributes loaded: "+d.toString()));var f=t.GetAttributeId(s,e.POSITION);if(-1==f){u="THREE.DRACOLoader: No position attribute found.";throw console.error(u),e.destroy(t),e.destroy(s),new Error(u)}var v=t.GetAttribute(s,f),m={},y=new Er.BufferGeometry;if(i)for(var g in i){var b=a[g],w=i[g],O=t.GetAttributeByUniqueId(s,w);this.addAttributeToGeometry(e,t,s,g,b,O,y,m)}else for(var g in this.nativeAttributeMap){var k=t.GetAttributeId(s,e[this.nativeAttributeMap[g]]);if(-1!==k){this.verbosity>0&&console.log("Loaded "+g+" attribute.");O=t.GetAttribute(s,k);this.addAttributeToGeometry(e,t,s,g,Float32Array,O,y,m)}}if(r==e.TRIANGULAR_MESH)if(this.drawMode===Er.TriangleStripDrawMode){var A=new e.DracoInt32Array;t.GetTriangleStripsFromMesh(s,A);m.indices=new Uint32Array(A.size());for(var S=0;S<A.size();++S)m.indices[S]=A.GetValue(S);e.destroy(A)}else{var x=3*l;m.indices=new Uint32Array(x);var M=new e.DracoInt32Array;for(S=0;S<l;++S){t.GetFaceFromMesh(s,S,M);var C=3*S;m.indices[C]=M.GetValue(0),m.indices[C+1]=M.GetValue(1),m.indices[C+2]=M.GetValue(2)}e.destroy(M)}y.drawMode=this.drawMode,r==e.TRIANGULAR_MESH&&y.setIndex(new(m.indices.length>65535?Er.Uint32BufferAttribute:Er.Uint16BufferAttribute)(m.indices,1));var j=new e.AttributeQuantizationTransform;if(j.InitFromAttribute(v)){y.attributes.position.isQuantized=!0,y.attributes.position.maxRange=j.range(),y.attributes.position.numQuantizationBits=j.quantization_bits(),y.attributes.position.minValues=new Float32Array(3);for(S=0;S<3;++S)y.attributes.position.minValues[S]=j.min_value(S)}return e.destroy(j),e.destroy(t),e.destroy(s),this.decode_time=h-c,this.import_time=performance.now()-h,this.verbosity>0&&(console.log("Decode time: "+this.decode_time),console.log("Import time: "+this.import_time)),y},isVersionSupported:function(t,r){e.getDecoderModule().then(function(e){r(e.decoder.isVersionSupported(t))})},getAttributeOptions:function(e){return"undefined"===typeof this.attributeOptions[e]&&(this.attributeOptions[e]={}),this.attributeOptions[e]}},e.decoderPath="./",e.decoderConfig={},e.decoderModulePromise=null,e.setDecoderPath=function(t){e.decoderPath=t},e.setDecoderConfig=function(t){var r=Er.DRACOLoader.decoderConfig.wasmBinary;e.decoderConfig=t||{},e.releaseDecoderModule(),r&&(e.decoderConfig.wasmBinary=r)},e.releaseDecoderModule=function(){e.decoderModulePromise=null},e.getDecoderModule=function(){var t=this,r=e.decoderPath,n=e.decoderConfig,i=e.decoderModulePromise;return i||("undefined"!==typeof DracoDecoderModule?i=Promise.resolve():"object"!==typeof WebAssembly||"js"===n.type?i=e._loadScript(r+"draco_decoder.js"):(n.wasmBinaryFile=r+"draco_decoder.wasm",i=e._loadScript(r+"draco_wasm_wrapper.js").then(function(){return e._loadArrayBuffer(n.wasmBinaryFile)}).then(function(e){n.wasmBinary=e})),i=i.then(function(){return new Promise(function(e){n.onModuleLoaded=function(r){t.timeLoaded=performance.now(),e({decoder:r})},DracoDecoderModule(n)})}),e.decoderModulePromise=i,i)},e._loadScript=function(e){var t=document.getElementById("decoder_script");null!==t&&t.parentNode.removeChild(t);var r=document.getElementsByTagName("head")[0],n=document.createElement("script");return n.id="decoder_script",n.type="text/javascript",n.src=e,new Promise(function(e){n.onload=e,r.appendChild(n)})},e._loadArrayBuffer=function(e){var t=new Er.FileLoader;return t.setResponseType("arraybuffer"),new Promise(function(r,n){t.load(e,r,void 0,n)})},e}(),Dr=function(e){function t(){var e,r;Object(o.a)(this,t);for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return(r=Object(u.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(i)))).renderThree=function(e){var t=(e-r.prevTime)/1e3;r.checkAspectRatio(),r.controls.update(),r.mixer&&r.mixer.update(t),r.renderer.render(r.scene,r.camera),r.prevTime=e},r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){this.initThreeJS()}},{key:"componentWillReceiveProps",value:function(e,t){this.props.asset&&e.asset.id!==this.props.asset.id&&this.swapModel(e.asset)}},{key:"swapModel",value:function(e){var t=this;this.model&&this.scene.remove(this.model);var r=this.props.provider.assetsManager.getAssetURL(e);if(this.props.provider.getLogger().log("GLTFAssetView loading the url",r),r){var n=new vt;n.setCrossOrigin("anonymous");var i=new Pr;Pr.setDecoderPath("./draco/"),n.setDRACOLoader(i),n.load(r,function(e){console.log("loaded",r);var n=e.scene||e.scenes[0];t.model=Oe.clone(n),(n=t.model).updateMatrixWorld();var i=e.animations||[];t.setClips(i);var a=(new Q.Box3).setFromObject(n),s=a.getSize(new Q.Vector3).length(),o=a.getCenter(new Q.Vector3);t.controls.reset(),n.position.x+=n.position.x-o.x,n.position.y+=n.position.y-o.y,n.position.z+=n.position.z-o.z,t.controls.maxDistance=10*s,t.camera.near=s/100,t.camera.far=100*s,t.camera.updateProjectionMatrix(),t.camera.position.copy(o),t.camera.position.x+=s/2,t.camera.position.y+=s/5,t.camera.position.z+=s/2,t.camera.lookAt(o),t.controls.enabled=!0,t.playAllClips(),t.scene.add(n)})}else this.props.provider.getLogger().error("GLTFAssetView url is empty!")}},{key:"render",value:function(){var e=this;return i.a.createElement("div",{id:"gltf-viewer",ref:function(t){return e.sceneContainer=t}})}},{key:"initThreeJS",value:function(){this.scene=new Q.Scene,this.scene.background=new Q.Color(0),this.camera=new Q.PerspectiveCamera(70,window.innerWidth/window.innerHeight,.1,1e3),this.scene.add(this.camera),this.renderer=new Q.WebGLRenderer({antialias:!0}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.gammaOutput=!0,this.sceneContainer.appendChild(this.renderer.domElement),this.clips=[],this.mixer=null,this.model=null,this.controls=new Ht(this.camera,this.renderer.domElement),this.controls.screenSpacePanning=!0,this.renderer.setAnimationLoop(this.renderThree);var e=new Q.DirectionalLight(16777215,1);e.position.set(1,1,1).normalize(),this.scene.add(e),this.scene.add(new Q.AmbientLight(16777215,.2)),this.swapModel(this.props.asset)}},{key:"playAllClips",value:function(){var e=this;this.clips.forEach(function(t){e.mixer.clipAction(t).reset().play()})}},{key:"setClips",value:function(e){this.mixer&&(this.mixer.stopAllAction(),this.mixer.uncacheRoot(this.mixer.getRoot()),this.mixer=null),e.forEach(function(e){e.validate()&&e.optimize()}),e.length&&(this.clips=e,this.mixer=new Q.AnimationMixer(this.model))}},{key:"checkAspectRatio",value:function(){if(this.renderer&&this.renderer.domElement&&this.sceneContainer){var e=this.sceneContainer.clientWidth,t=this.sceneContainer.clientHeight,r=e/t;Math.abs(this.camera.aspect-r)>.001&&(this.camera.aspect=r,this.camera.updateProjectionMatrix(),this.renderer.setSize(e-4,t-4))}}}]),t}(n.Component),Rr=r(20),Lr=(r(89),function(e){function t(e,r){var n;return Object(o.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this,e,r))).loadCurrentLocation=function(){navigator.geolocation.getCurrentPosition(function(e){console.log("success",e);var t=e.coords;n.props.provider.quick_setPropertyValue(n.props.asset.id,"latitude",t.latitude),n.props.provider.quick_setPropertyValue(n.props.asset.id,"longitude",t.longitude)},function(e){console.log("error",e)})},n.onMapClick=function(e){n.props.provider.quick_setPropertyValue(n.props.asset.id,"latitude",e.latlng.lat),n.props.provider.quick_setPropertyValue(n.props.asset.id,"longitude",e.latlng.lng)},n.updateLocation=function(e){var t=n.props.provider.accessObject(n.props.asset.id),r=Object(Rr.latLng)({lat:t.latitude,lon:t.longitude});n.marker&&n.marker.setLatLng(r),n.mymap&&n.mymap.panTo(r)},n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){var e=this;return this.updateLocation(),i.a.createElement("div",null,i.a.createElement(H.c,null,i.a.createElement("button",{onClick:this.loadCurrentLocation},"set to current location")),i.a.createElement("div",{id:"mapid",ref:function(t){return e.div=t},style:{width:"400px",height:"400px",border:"1px solid black"}}))}},{key:"componentDidMount",value:function(){this.mymap=Object(Rr.map)("mapid").setView([this.props.asset.longitude,this.props.asset.latitude],18),Object(Rr.tileLayer)("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw",{maxZoom:18,attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery \xa9 <a href="https://www.mapbox.com/">Mapbox</a>',id:"mapbox.streets"}).addTo(this.mymap),this.mymap.on("click",this.onMapClick);var e=Object(Rr.divIcon)({className:"map-icon"});this.marker=Object(Rr.marker)([this.props.asset.longitude,this.props.asset.latitude],{title:"this is the geo location",icon:e}).addTo(this.mymap),this.props.provider.on(x.j.PROPERTY_CHANGED,this.updateLocation),this.updateLocation()}},{key:"componentWillUnmount",value:function(){this.props.provider.off(x.j.PROPERTY_CHANGED,this.updateLocation)}}]),t}(n.Component)),Ir=function(e){function t(){return Object(o.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){var e=B(this.props.provider.getDataGraph(),this.props.asset);return i.a.createElement("div",{id:"asset-view"},i.a.createElement("h3",null,e.subtype," : ",i.a.createElement("b",null,e.title)),this.renderAsset(e))}},{key:"renderAsset",value:function(e){var t=this.props.provider.assetsManager.getAssetURL(e);return e.subtype===ct.IMAGE?i.a.createElement("img",{src:t,alt:e.title}):e.subtype===ct.AUDIO?i.a.createElement("audio",{src:t,controls:!0}):e.subtype===ct.VIDEO?i.a.createElement("video",{src:t,controls:!0,playsInline:!0,crossOrigin:"anonymous"}):e.subtype===ct.BEHAVIOR?i.a.createElement("div",null,t):e.subtype===ct.GLTF?i.a.createElement(Dr,{asset:e,provider:this.props.provider}):e.subtype===ct.GEOLOCATION?i.a.createElement(Lr,{asset:e,provider:this.props.provider}):i.a.createElement("div",null,"unknown type")}}]),t}(n.Component);function Tr(e,t,r){var n=e,i=t.createObject();return t.getPropertiesForObject(n).forEach(function(e){if("children"===e){var a=function(e,t,r){for(var n=t.createArray(),i=t.getArrayLength(e),a=0;a<i;a++){var s=t.getElementAt(e,a),o=Tr(s,t,r);t.insertElement(n,a,o)}return n}(t.getPropertyValue(n,e),t,i);t.createProperty(i,e,a)}else{var s=t.getPropertyValue(n,e);"parent"===e&&(s=r),t.createProperty(i,e,s)}}),i}var Nr=function(){function e(t){Object(o.a)(this,e),this.graph=t}return Object(c.a)(e,[{key:"object",value:function(e){var t=this;if(e&&e.id&&e.exists&&e.exists())return console.log("someone created a graphaccessor on an existing object"),e;if(this.graph.hasObject(e)){var r={};return this.graph.getPropertiesForObject(e).forEach(function(n){r[n]=t.graph.getPropertyValue(e,n)}),r.id=e,r.exists=function(){return!0},r.set=function(n,i){return t.graph.setProperty(e,n,i),r},r.props=function(){var r={};return t.graph.getPropertiesForObject(e).forEach(function(n){r[n]=t.graph.getPropertyValue(e,n)}),r},r.array=function(e){for(var n=r[e],i=t.graph.getArrayLength(n),a=[],s=0;s<i;s++)a.push(t.graph.getElementAt(n,s));return a},r.getChildren=function(){return r.children?r.array("children").map(function(e){return t.object(e)}):[]},r.insertChildLast=function(e){t.graph.setProperty(e.id,"parent",r.id);var n=t.graph.getPropertyValue(r.id,"children"),i=t.graph.getArrayLength(n),a=t.graph.getElementAt(n,i-1);t.graph.insertAfter(n,a,e.id)},r.insertFirstChild=function(e){t.graph.setProperty(e.id,"parent",r.id);var n=t.graph.getPropertyValue(r.id,"children");t.graph.insertAfter(n,null,e.id)},r.insertChildAfter=function(e,n){t.graph.setProperty(e.id,"parent",r.id);var i=t.graph.getPropertyValue(r.id,"children");t.graph.insertAfter(i,n.id,e.id)},r.child=function(e){return t.object(r.array("children")[e])},r.removeFromParent=function(){var e=t.object(r.parent),n=e.array("children").findIndex(function(e){return e===r.id});n>=0?t.graph.removeElement(e.children,n):console.error("could not find index for child",r,"in children",e.children)},r.getParent=function(){return t.object(r.parent)},r.clone=function(){var e=Tr(r.id,t.graph,r.parent);return t.object(e)},r.find=function(e,t){return t||(t=[]),e(r)&&t.push(r),r.children&&r.getChildren().forEach(function(r){r.find(e,t)}),t},r}return{exists:function(){return!1}}}}]),e}(),Gr=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).refreshList=function(){r.props.provider.loadDocList().then(function(e){return r.setState({docList:e})})},r.dismiss=function(){H.b.hide()},r.state={docList:[]},r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){this.refreshList()}},{key:"generateDocUrl",value:function(e){var t=Object.assign({},this.props.provider.options,{mode:"edit",doc:e.id});return delete t.AuthModule,"./?".concat(Object(x.x)(t))}},{key:"deleteDoc",value:function(e){var t=this;return this.props.provider.removeDoc(e).then(function(e){console.log("removed?",e),t.refreshList()})}},{key:"render",value:function(){var e=this;return i.a.createElement(x.a,{visible:!0,onScrimClick:this.dismiss},i.a.createElement("header",null,"Open document"),i.a.createElement("section",null,i.a.createElement("ul",null,this.state.docList.map(function(t,r){return i.a.createElement("li",{key:r},i.a.createElement("b",null,t.title),i.a.createElement("a",{className:"button",href:e.generateDocUrl(t)},"open"),e.renderDeleteButton(t))}))),i.a.createElement("footer",null,i.a.createElement("button",{onClick:this.dismiss},"dismiss")))}},{key:"renderDeleteButton",value:function(e){var t=this;return P.supportsDocDelete()?i.a.createElement("button",{onClick:function(){return t.deleteDoc(e)}},"delete"):""}}]),t}(n.Component),Br=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).refreshList=function(){r.props.provider.loadAssetList().then(function(e){r.props.filter&&(e=e.filter(r.props.filter)),r.setState({assetList:e})})},r.okay=function(){H.b.hide()},r.state={assetList:[]},r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){this.refreshList()}},{key:"addAsset",value:function(e){return H.b.hide(),ut(e.mimeType)?wr(e.id,e.url,e.mimeType,e.title,this.props.provider):!(t=e.mimeType)||t.toLowerCase()!==ot.MP3&&t.toLowerCase()!==ot.AAC&&t.toLowerCase()!==ot.WAV?function(e){return!!e&&(e.toLowerCase()===ot.MP4||e.toLowerCase()===ot.MOV)}(e.mimeType)?function(e,t,r,n,i){n||(n=t.substring(t.lastIndexOf("/")+1)),P.supportsAssetUpload()||(e=n);var a=i.accessObject(i.getDataGraph().createObject({type:et.ASSET,subtype:ct.VIDEO,assetId:e,format:r,src:t,title:n,parent:0}));i.accessObject(i.getAssetsObject()).insertChildLast(a)}(e.id,e.url,e.mimeType,e.title,this.props.provider):function(e){return!!e&&e.toLowerCase()===ot.GLB}(e.mimeType)?function(e,t,r,n,i){n||(n=t.substring(t.lastIndexOf("/")+1)),P.supportsAssetUpload()||(e=n);var a=i.accessObject(i.getDataGraph().createObject({type:et.ASSET,subtype:ct.GLTF,assetId:e,format:r,src:t,title:n,parent:0}));i.accessObject(i.getAssetsObject()).insertChildLast(a)}(e.id,e.url,e.mimeType,e.title,this.props.provider):void console.log("can't add this type",e.mimeType):Ar(e.id,e.url,e.mimeType,e.title,this.props.provider);var t}},{key:"deleteAsset",value:function(e){var t=this;return this.props.provider.removeAssetSource(e).then(function(e){console.log("removed?",e),t.refreshList()})}},{key:"render",value:function(){var e=this;return i.a.createElement(x.a,{visible:!0,onScrimClick:this.okay},i.a.createElement("header",null,"Add Asset"),i.a.createElement("section",null,i.a.createElement("ul",null,this.state.assetList.map(function(t,r){return i.a.createElement("li",{key:r},i.a.createElement("b",null,t.title," "),i.a.createElement("i",null," ",t.mimeType),i.a.createElement("button",{onClick:function(){return e.addAsset(t)}},"add"),e.renderDeleteButton(t))}))),i.a.createElement("footer",null,i.a.createElement("button",{onClick:this.okay},"close")))}},{key:"renderDeleteButton",value:function(e){var t=this;return P.supportsAssetUpload()?i.a.createElement("button",{onClick:function(){return t.deleteAsset(e)}},"delete"):""}}]),t}(n.Component),Fr=r(42),Ur=r.n(Fr),zr=(r(99),r(101),function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).swap=function(){var e=r.props.provider.accessObject(x.h.getSelection());e.exists()&&e.type===et.BEHAVIOR_SCRIPT&&r.refresh()},r.changeText=function(e){return r.setState({text:e})},r.save=function(e){r.editor.editor.getSession().getAnnotations().filter(function(e){return"error"===e.type}).length>0?j.add("errors in behavior"):(j.add("saved behavior"),r.props.provider.updateBehaviorAssetContents(r.state.id,r.state.text))},r.refresh=function(){var e=x.h.getSelection(),t=r.props.provider.accessObject(e);t.exists()&&t.type===et.BEHAVIOR_SCRIPT&&r.props.provider.fetchBehaviorAssetContents(e).then(function(t){r.setState({id:e,text:t})})},r.state={id:null,text:"empty"},r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){this.refresh(),this.props.provider.on(x.j.PROPERTY_CHANGED,this.refresh),x.h.on(x.g.CHANGED,this.swap)}},{key:"componentWillUnmount",value:function(){this.props.provider.off(x.j.PROPERTY_CHANGED,this.refresh),x.h.off(x.g.CHANGED,this.swap)}},{key:"render",value:function(){var e=this;return null===this.state.id?i.a.createElement("div",null,"loading"):i.a.createElement(Ur.a,{mode:"javascript",theme:"github",name:"script-editor",value:this.state.text,onChange:this.changeText,onBlur:this.save,showGutter:!0,width:"100%",height:"100%",ref:function(t){return e.editor=t}})}}]),t}(n.Component)),Hr=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).refreshList=function(){r.props.provider.loadScriptList().then(function(e){return r.setState({scripts:e})})},r.okay=function(){return H.b.hide()},r.state={scripts:[]},r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){this.refreshList()}},{key:"addScript",value:function(e){H.b.hide(),console.log("URL is",e.url),e.url=e.name,console.log("Now URL is",e.url);var t=this.props.provider.addBehaviorAssetFromURL(e);this.props.onAdd&&this.props.onAdd(t)}},{key:"deleteScript",value:function(e){var t=this;return this.props.provider.removeBehaviorAssetSource(e.name).then(function(){return t.refreshList()})}},{key:"render",value:function(){var e=this;return i.a.createElement(x.a,{visible:!0,onScrimClick:this.okay},i.a.createElement("header",null,"Choose Behavior Script"),i.a.createElement("section",null,i.a.createElement("ul",{className:"behaviors-list"},this.state.scripts.map(function(t,r){return i.a.createElement(H.c,{key:t.name},i.a.createElement(H.g,null,i.a.createElement("div",null,i.a.createElement("i",null,t.name)," -  ",i.a.createElement("b",null,t.title)),i.a.createElement("p",null,t.description)),i.a.createElement(x.i,null),i.a.createElement("button",{onClick:function(){return e.addScript(t)}},"add"),e.renderDeleteButton(t))}))),i.a.createElement("footer",null,i.a.createElement("button",{onClick:this.okay},"close")))}},{key:"renderDeleteButton",value:function(e){var t=this;return P.supportsScriptEdit()?i.a.createElement("button",{onClick:function(){return t.deleteScript(e)}},"delete"):""}}]),t}(n.Component),Wr="\n/*\n #title untitled behavior\n #description does something\n*/\n({\n  // defines a target property. must be a scene\n    properties: {\n        scene: { \n            type:'enum', \n            title: 'target scene', \n            value:null, \n            hints: {\n                type:'node',\n                nodeType:'scene'\n            }\n        },\n    },\n    start: function(evt) {\n        //called when the program starts\n    },\n    click: function(evt) {\n        //called when object is clicked on\n        //this.navigateScene(this.properties.scene)\n    }\n})\n",Vr="\n/*\n #title scene script\n #description does something\n*/\n({\n    // defines a target property. must be a scene\n    properties: {\n        scene: { \n            type:'enum', \n            title: 'target scene', \n            value:null, \n            hints: {\n                type:'node',\n                nodeType:'scene'\n            }\n        },\n    },\n    start: function(evt) {\n        //called when the program starts\n    },\n    enter: function(evt) {\n        //called when entering a scene\n    },\n    tick: function(evt) {\n        //called on every frame\n    },\n    exit: function(evt) {\n        //called when exiting a scene\n    },\n    stop: function(evt) {\n        //called when the program stops\n    },\n})\n",Yr=function(e){function t(){var e,r;Object(o.a)(this,t);for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return(r=Object(u.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(i)))).okay=function(){H.b.hide()},r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){var e=null;this.props.url&&(e=this.props.url);var t=e.replace("https","wxrv");return t=t.replace("http","wxrv"),i.a.createElement(x.a,{visible:!0,onScrimClick:this.okay},i.a.createElement("header",null,this.props.text?this.props.text:"Scan"),i.a.createElement("section",null,i.a.createElement("label",null,i.a.createElement("a",{href:e},e)),i.a.createElement(x.f,{url:t,width:160,height:160})),i.a.createElement("footer",null,i.a.createElement("button",{onClick:this.okay},"dismiss")))}}]),t}(n.Component),Xr=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).cancel=function(){H.b.hide()},r.okay=function(){H.b.hide(),P.doPasswordLogin(r.state.field)},r.keyDown=function(e){"Enter"===e.key&&r.okay()},r.state={field:""},r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){var e=this;return i.a.createElement(x.a,{visible:!0,onScrimClick:this.cancel,width:"600px",height:"auto"},i.a.createElement("header",null,"login with the password from your env file"),i.a.createElement("section",null,i.a.createElement("label",null,"password"),i.a.createElement("input",{type:"password",value:this.state.field,onKeyDown:this.keyDown,onChange:function(t){e.setState({field:t.target.value})}})),i.a.createElement("footer",null,i.a.createElement("button",{onClick:this.cancel},"cancel"),i.a.createElement("button",{onClick:this.okay},"okay")))}}]),t}(n.Component),Zr=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).cancel=function(){H.b.hide()},r.okay=function(){H.b.hide(),console.log("opening window with the data",r.state.data),P.login(r.state.data)},r.state={data:null},r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){var e=this;console.log("opening dialog"),P.getJSON(Object(x.r)()).then(function(t){console.log("got the data",t),e.setState({data:t})})}},{key:"render",value:function(){return i.a.createElement(x.a,{visible:!0,onScrimClick:this.cancel},i.a.createElement("header",null,"Github Auth"),i.a.createElement("section",null,i.a.createElement("p",null,"To log into MrEd you need a github account. Press the button below to log into github and approve MrEd's access. The app will only use Github for authentication. It does not have access to any of your projects or code."),i.a.createElement("button",{onClick:this.okay},"Open Github")),i.a.createElement("footer",null,i.a.createElement("button",{onClick:this.cancel},"cancel")))}}]),t}(n.Component),Kr=function(e){function t(e,r){var n;return Object(o.a)(this,t),(n=Object(u.a)(this,Object(l.a)(t).call(this,e,r))).state={error:!1},n}return Object(h.a)(t,e),Object(c.a)(t,[{key:"componentDidCatch",value:function(e,t){this.setState({error:!0});var r=this.props.logger;r?(r.error("an error occurred at the react level"),r.error(e),r.error(t)):console.log("NO LOGGER!")}},{key:"render",value:function(){return!0===this.state.error?i.a.createElement("div",null,i.a.createElement("h1",null,"An error happened. Please look at the console")):this.props.children}}]),t}(n.Component),qr=function(e){console.log("parsing",e);var t=0,r=[],n=null,i=[],a=[],s=[],o=[],c=0;if(71!==e[0]||73!==e[1]||70!==e[2]||56!==e[3]||57!==e[4]&&55!==e[4]||97!==e[5])throw new Error("parseGIF: no GIF89a");t+=+!!(128&e[10])*Math.pow(2,1+(7&e[10]))*3+13;for(var u=e.subarray(0,t);e[t]&&59!==e[t];){var l=t,h=e[t];if(33===h){var p=e[++t];if(-1===[1,254,249,255].indexOf(p))throw new Error("parseGIF: unknown label");for(249===p&&r.push(10*(e[t+3]+(e[t+4]<<8))),255===p&&(c=e[t+15]+(e[t+16]<<8));e[++t];)t+=e[t];249===p&&(n=e.subarray(l,t+1),a.push(n[3]>>2&7),s.push(1&n[3]),o.push(n[6]))}else{if(44!==h)throw new Error("parseGIF: unknown blockId");for(t+=9,t+=+!!(128&e[t])*(3*Math.pow(2,1+(7&e[t])))+1;e[++t];)t+=e[t];var d=e.subarray(l,t+1);i.push(URL.createObjectURL(new Blob([u,n,d])))}t++}return{delayTimes:r,loopCnt:c,frames:i,disposals:a,transparencies:s,transparentColors:o}},Qr=function(e){function t(e,r,n,i,a){var s;return Object(o.a)(this,t),(s=Object(u.a)(this,Object(l.a)(t).call(this,document.createElement("canvas")))).image.width=e[0].width,s.image.height=e[0].height,s._ctx=s.image.getContext("2d"),s.generateMipmaps=!1,s.isVideoTexture=!0,s.minFilter=Q.NearestFilter,s.frames=e,s.delays=r,s.disposals=n,s.transparencies=i,s.transparent=!1,s.transparencies.forEach(function(e){e&&(s.transparent=!0)}),s.transparentColors=a,s.frame=0,s.frameStartTime=Date.now(),s.firstDrawCount=0,s.playing=!0,s}return Object(h.a)(t,e),Object(c.a)(t,[{key:"update",value:function(){if(this.frames&&this.delays&&this.disposals&&(!(this.firstDrawCount>this.frames.length)||this.playing)){var e=Date.now();e-this.frameStartTime>this.delays[this.frame]&&(2===this.disposals[this.frame]&&this._ctx.clearRect(0,0,this.image.width,this.image.width),this.frame=(this.frame+1)%this.frames.length,this.frameStartTime=e,this._ctx.drawImage(this.frames[this.frame],0,0,this.image.width,this.image.height),this.needsUpdate=!0,this.firstDrawCount+=1)}}}]),t}(Q.Texture);var Jr=function(){function e(t){Object(o.a)(this,e),this.provider=t,this.assets_url_map={},this.videocache={},this.audiocache={},this.gifcache={}}return Object(c.a)(e,[{key:"cacheAssetsList",value:function(){var e=this;return P.getJSON("".concat(Object(x.o)(),"list")).then(function(t){t&&t.forEach&&(P.supportsAssetUpload()?t.forEach(function(t){e.assets_url_map[t.id]=Object(x.o)()+t.id}):(t.forEach(function(t){e.assets_url_map[t.title]=t.url}),console.log("cached the assets",e.assets_url_map)))})}},{key:"getAssetURL",value:function(e){return P.supportsAssetUpload()&&!P.isLoggedIn()?Object(x.o)()+e.assetId:e.assetId?this.assets_url_map[e.assetId]:e.src}},{key:"playMediaAsset",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=this.provider.getLogger();if(e.subtype===ct.AUDIO){r.log("playing the audio asset",e);var n=this.getAssetURL(e);if(!n)return void r.error("could not find the url for the asset",e);if(r.log("playing the audio from the url",n),this.audiocache[e.id]){var i=this.audiocache[e.id];i.isPlaying&&i.stop(),i.play()}else{var a=new Q.Audio(this.provider.getAudioListener());(new Q.AudioLoader).load(n,function(e){a.setBuffer(e),a.setLoop(!1),a.setVolume(.5),a.play()}),this.audiocache[e.id]=a}}if(e.subtype===ct.VIDEO){var s=this.getAssetURL(e),o=this.videocache[s];o&&(t&&(o.muted=!1),o.play())}if(e.subtype===ct.IMAGE){var c=this.getAssetURL(e),u=this.gifcache[c];u&&(u.playing=!0)}}},{key:"stopMediaAsset",value:function(e){if(e.subtype===ct.AUDIO&&this.audiocache[e.id]&&(this.audiocache[e.id].stop(),delete this.audiocache[e.id],this.audiocache[e.id]=null),e.subtype===ct.VIDEO){var t=this.getAssetURL(e),r=this.videocache[t];r&&r.pause()}if(e.subtype===ct.IMAGE){var n=this.getAssetURL(e),i=this.gifcache[n];i&&(i.playing=!1)}}},{key:"isMediaAssetPlaying",value:function(e){if(e.subtype===ct.AUDIO&&this.audiocache[e.id])return this.audiocache[e.id].isPlaying;if(e.subtype===ct.VIDEO){var t=this.getAssetURL(e),r=this.videocache[t];if(r)return!r.paused}if(e.subtype===ct.IMAGE){var n=this.getAssetURL(e),i=this.gifcache[n];if(i)return i.playing}return!1}},{key:"setMediaVolume",value:function(e,t){if(e.subtype===ct.AUDIO&&this.audiocache[e.id]&&this.audiocache[e.id].setVolume(t),e.subtype===ct.VIDEO){var r=this.getAssetURL(e),n=this.videocache[r];n&&(n.volume=t)}}},{key:"stopAllMedia",value:function(){var e=this,t=this.videocache;Object.keys(t).forEach(function(e){var r=t[e];r.pause&&r.pause()}),Object.keys(this.audiocache).forEach(function(t){e.audiocache[t]&&e.audiocache[t].stop&&e.audiocache[t].stop()})}},{key:"getTexture",value:function(e){var t=this,r=this.provider.accessObject(e);if(!r.exists())return this.provider.getLogger().error("==== invalid asset reference",e),Promise.resolve(null);var n,i=this.getAssetURL(r);return i?(this.provider.getLogger().log("loading asset url",i),r.subtype===ct.IMAGE?(this.provider.getLogger().log("asset info",r),"image/gif"===r.format?this.gifcache[i]?Promise.resolve(this.gifcache[i]):function(e,t){return new Promise(function(r,n){fetch(e,{mode:"cors"}).then(function(e){return e.arrayBuffer()}).then(function(e){return new Uint8Array(e)}).then(function(e){if(t&&e.length<100){t.getLogger().log("array length is too short",String.fromCharCode(115));for(var r="",n=0;n<e.length;n++)r+=String.fromCharCode(e[n]);t.getLogger().log(r)}return e}).then(function(e){return qr(e,[e])}).then(function(t){console.log("result of gif parsing is",t);for(var n=t.frames,i=t.delayTimes,a=t.disposals,s=t.transparencies,o=t.transparentColors,c=0,u=function(t){var u=new Image;u.crossOrigin="anonymous",u.onload=function(u){if(c++,n[t]=u.target,c===n.length){var l=new Qr(n,i,a,s,o);l.image.src=e,l.encoding=Q.sRGBEncoding,l.minFilter=Q.LinearFilter,r(l)}},u.src=n[t]},l=0;l<n.length;l++)u(l)}).catch(n)})}(i,this.provider).then(function(e){return t.gifcache[i]=e,e}):new Promise(function(e,r){(new Q.TextureLoader).load(i,function(t){return e(t)},function(e){return console.log("Progress",e)},function(e){t.provider.getLogger().error("error loading texture",e),r(e)})})):r.subtype===ct.VIDEO?(this.videocache[i]?n=this.videocache[i]:((n=document.createElement("video")).crossOrigin="anonymous",n.preload="auto",n.muted=!0,n.setAttribute("playsinline",""),n.src=i,this.videocache[i]=n),Promise.resolve(new Q.VideoTexture(n))):Promise.resolve(null)):(this.provider.getLogger().error("==== null url from asset",r),Promise.resolve(null))}},{key:"getGLTF",value:function(e){var t=this,r=this.provider.accessObject(e);if(!r.exists())return this.provider.getLogger().error("==== invalid asset reference",e),Promise.resolve(null);var n=this.getAssetURL(r);if(!n)return this.provider.getLogger().error("==== null url from asset",r),Promise.resolve(null);this.provider.getLogger().log("ModelDef loading the model asset url",n);var i=new vt;i.setCrossOrigin("anonymous");var a=new Pr;return Pr.setDecoderPath("./draco/"),i.setDRACOLoader(a),new Promise(function(e,r){i.load(n,function(t){return e(t)},function(e){return console.log("Progress",e)},function(e){t.provider.getLogger().error("error loading texture",e),r(e)})})}}]),e}(),$r=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).edited=function(e){r.setState({newTitle:e.target.value})},r.dismiss=function(){H.b.hide()},r.saveAs=function(){H.b.hide(),r.props.provider.duplicateDocument(r.state.newTitle)},r.state={newTitle:"Copy of "+e.provider.getDocTitle()},r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){return i.a.createElement(x.a,{visible:!0,onScrimClick:this.dismiss,width:"600px",height:"auto"},i.a.createElement("header",null,"Save Document As"),i.a.createElement("section",null,i.a.createElement("label",null,"title"),i.a.createElement("input",{type:"text",value:this.state.newTitle,onChange:this.edited,style:{flex:1}})),i.a.createElement("footer",null,i.a.createElement(x.i,null),i.a.createElement("button",{onClick:this.dismiss},"cancel"),i.a.createElement("button",{onClick:this.saveAs},"save as")))}}]),t}(n.Component),_r=function(e){function t(){var e,r;Object(o.a)(this,t);for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return(r=Object(u.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(i)))).dismiss=function(){H.b.hide()},r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){return i.a.createElement(x.a,{visible:!0,onScrimClick:this.cancel},i.a.createElement("header",null,"Warning. There were errors loading some assets"),i.a.createElement("section",null,i.a.createElement("ul",null,this.props.provider.badAssets.map(function(e,t){return i.a.createElement("li",{key:t},i.a.createElement("b",null,e.title),i.a.createElement("br",null),e.src)}))),i.a.createElement("footer",null,i.a.createElement("button",{onClick:this.dismiss},"keep going anyway")))}}]),t}(n.Component),en=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).add=function(e){r.setState({notification:e,visible:!0}),setTimeout(r.hide,2e3)},r.hide=function(){return r.setState({visible:!1})},r.state={notification:"saved",visible:!1},r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"componentWillMount",value:function(){j.onAdd(this.add)}},{key:"componentWillUnmount",value:function(){j.offAdd(this.add)}},{key:"render",value:function(){return i.a.createElement("div",{style:{position:"absolute",bottom:"10px",left:"10px",backgroundColor:"rgba(0,0,0,0.6)",borderRadius:"1em",color:"white",fontSize:"24pt",padding:"1em",display:this.state.visible?"block":"none"}},this.state.notification)}}]),t}(n.Component),tn=r(43),rn=r.n(tn),nn=(r(112),function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).clearLog=function(){r.setState({messages:[]})},r.state={messages:[]},r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){var e=this;this.props.logger.addEventListener("log",function(t){e.state.messages.push(t),e.setState({messages:e.state.messages})}),this.props.logger.addEventListener("error",function(t){e.state.messages.push(t),e.setState({messages:e.state.messages})})}},{key:"render",value:function(){var e=this;return i.a.createElement("div",{className:"console wide"},i.a.createElement("div",{className:"toolbar gray"},i.a.createElement("button",{className:"action gray fa fa-trash borderless",onClick:this.clearLog}),i.a.createElement("button",{className:"action gray fa fa-exclamation-triangle borderless"}),i.a.createElement("input",{type:"text",placeholder:"filter messages",className:"spacer"})),i.a.createElement("ul",{className:"message-log"},this.state.messages.map(function(t,r){var n=t.remote?"remote":"local";return i.a.createElement("li",{key:r},i.a.createElement("b",{className:"location ".concat(n)},n),i.a.createElement("b",{className:"type ".concat(t.type)},t.type),i.a.createElement("i",null,t.count),e.formatMessage(t))})))}},{key:"formatMessage",value:function(e){var t=e.data.map(function(e,t){return"string"===typeof e||e instanceof String?i.a.createElement("b",{key:t},e):i.a.createElement("b",{key:t},rn()(e,{depth:2}))});return i.a.createElement("span",null,t)}}]),t}(n.Component)),an=function(e){function t(){var e,r;Object(o.a)(this,t);for(var n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return(r=Object(u.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(i)))).okay=function(){H.b.hide()},r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){return i.a.createElement(x.a,{visible:!0,onScrimClick:this.okay},i.a.createElement("header",null,"Property Error"),i.a.createElement("section",null,i.a.createElement("p",null,this.props.text)),i.a.createElement("footer",null,i.a.createElement("button",{onClick:this.okay},"dismiss")))}}]),t}(n.Component),sn=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).getApp=function(){return"edit"===r.mode?i.a.createElement(on,{provider:Object(d.a)(Object(d.a)(r))}):"vredit"===r.mode?i.a.createElement(br,{provider:Object(d.a)(Object(d.a)(r)),editable:!0}):"embed-view"===r.mode?i.a.createElement(br,{provider:Object(d.a)(Object(d.a)(r)),editable:!1}):"vrview"===r.mode?i.a.createElement(br,{provider:Object(d.a)(Object(d.a)(r)),editable:!1}):void console.log("no mode!")},r.getTitle=function(){return"MrEd"},r.getDocTitle=function(){return r.accessObject(r.getSceneRoot()).title},r.setDocTitle=function(e){return r.accessObject(r.getSceneRoot()).set("title",e)},r.getLogger=function(){return r.pubnub?r.pubnub.getLogger():(r.consoleLogger||(r.consoleLogger=new N),r.consoleLogger)},r.docLoaded=function(){return r.accessObject(r.getBehaviorsObject()).getChildren().filter(function(e){return e.type===et.BEHAVIOR_SCRIPT}).forEach(function(e){r.fetchBehaviorAssetContents(e.id).then(function(t){try{var n=ht(t);n.text=t,r.setCachedBehaviorAsset(e.id,n)}catch(i){console.error(i)}})}),r.assetsManager.cacheAssetsList().then(function(){Promise.all(r.accessObject(r.getAssetsObject()).getChildren().map(function(e){return e.subtype===ct.VIDEO?r.assetsManager.getTexture(e.id).then(function(t){t||(r.getLogger().error("error loading a texture",e),r.addAssetLoadingError(e))}):e.subtype===ct.IMAGE?r.assetsManager.getTexture(e.id).then(function(t){t||(r.getLogger().error("error loading a texture",e),r.addAssetLoadingError(e))}):e.subtype===ct.GLTF?r.assetsManager.getGLTF(e.id).then(function(t){t||(r.getLogger().error("error loading a model",e),r.addAssetLoadingError(e))}):Promise.resolve("all good")})).then(function(e){console.log("fully loaded all assets now"),console.log("error count is",r.badAssets.length),r.badAssets.length>0&&r.showBadAssetsDialog()})})},r.getRendererForItem=function(e){var t=r.accessObject(e);return t.exists()?t.type===et.ASSET?i.a.createElement("div",null,i.a.createElement("i",{className:lt[t.subtype]})," ",t.title):lt[t.type]?i.a.createElement("div",null,i.a.createElement("i",{className:lt[t.type]})," ",t.title):i.a.createElement("div",null,t.title):i.a.createElement("div",null,"???")},r.getAssetsObject=function(){return r.getDataGraph().getObjectByProperty("type",et.ASSETS_LIST)},r.getBehaviorsObject=function(){return r.getDataGraph().getObjectByProperty("type",et.BEHAVIORS_LIST)},r.editIn2D=function(){r.save().then(function(){var e=Object.assign({},r.options,{mode:"edit",doc:r.getDocId()});delete e.AuthModule;var t=document.location,n="".concat(t.protocol,"//").concat(t.host).concat(t.pathname,"?").concat(Object(x.x)(e));H.b.show(i.a.createElement(Yr,{text:"Edit in 2D",url:n}))})},r.editInVR=function(){r.save().then(function(){var e=Object.assign({},r.options,{mode:"vredit",doc:r.getDocId()});delete e.AuthModule;var t=document.location,n="".concat(t.protocol,"//").concat(t.host).concat(t.pathname,"?").concat(Object(x.x)(e));H.b.show(i.a.createElement(Yr,{text:"Edit in AR/VR",url:n}))})},r.viewInVR=function(){r.save().then(function(){var e=Object.assign({},r.options,{mode:"play",doc:r.getDocId()});delete e.AuthModule;var t=document.location,n="".concat(t.protocol,"//").concat(t.host).concat(t.pathname,"?").concat(Object(x.x)(e));H.b.show(i.a.createElement(Yr,{text:"View in AR/VR",url:n}))})},r.add3DObject=function(e,t){var n=at(e).make(r.getDataGraph(),t);t.insertFirstChild(n),x.h.setSelection(n.id),j.add("added "+e)},r.cutSelection=function(e){if(e&&e.target){if("input"===e.target.getAttribute("type"))return;if("INPUT"===e.target.nodeName)return;if("TEXTAREA"===e.target.nodeName)return}if(!x.h.isEmpty()){var t=r.accessObject(x.h.getSelection());x.h.setClipboard(t.id),t.removeFromParent(),x.h.clearSelection()}},r.copySelection=function(e){if(e&&e.target){if("input"===e.target.getAttribute("type"))return;if("INPUT"===e.target.nodeName)return;if("TEXTAREA"===e.target.nodeName)return}if(!x.h.isEmpty()){var t=r.accessObject(x.h.getSelection());x.h.setClipboard(t.id)}},r.pasteSelection=function(e){if(e&&e.target){if("input"===e.target.getAttribute("type"))return;if("INPUT"===e.target.nodeName)return;if("TEXTAREA"===e.target.nodeName)return}var t=r.accessObject(x.h.getClipboard()),n=null;if(rt(t.type)&&(n=r.getSelectedSceneObject()),"scene"===t.type&&(n=r.accessObject(r.getSceneRoot())),!n)return console.error("no parent to ad too! bad obj type?",t.type);n.insertChildLast(t.clone())},r.setColor=function(e){x.h.isEmpty()||r.accessObject(x.h.getSelection()).set("color",e)},r.showAddImageAssetDialog=function(){return H.b.show(i.a.createElement(Sr,{provider:Object(d.a)(Object(d.a)(r))}))},r.showAddAudioAssetDialog=function(){return H.b.show(i.a.createElement(Cr,{provider:Object(d.a)(Object(d.a)(r))}))},r.showAddGLTFAssetDialog=function(){return H.b.show(i.a.createElement(xr,{provider:Object(d.a)(Object(d.a)(r))}))},r.showAddGLBAssetDialog=function(){return H.b.show(i.a.createElement(Mr,{provider:Object(d.a)(Object(d.a)(r))}))},r.showOpenDocumentDialog=function(){return H.b.show(i.a.createElement(Gr,{provider:Object(d.a)(Object(d.a)(r))}))},r.showOpenAssetDialog=function(){return H.b.show(i.a.createElement(Br,{provider:Object(d.a)(Object(d.a)(r))}))},r.showAddServerImageDialog=function(){return H.b.show(i.a.createElement(Br,{provider:Object(d.a)(Object(d.a)(r)),filter:function(e){return ut(e.mimeType)}}))},r.showOpenBehaviorDialog=function(){return H.b.show(i.a.createElement(Hr,{provider:Object(d.a)(Object(d.a)(r))}))},r.showAddGeoLocationAssetDialog=function(){var e,t,n,i;e={latitude:0,longitude:0,altitude:0,useAltitude:!1},t="new geo location",n=Object(d.a)(Object(d.a)(r)),i=n.accessObject(n.getDataGraph().createObject({type:et.ASSET,subtype:ct.GEOLOCATION,title:t,latitude:e.latitude,longitude:e.longitude,altitude:e.altitude,useAltitude:e.useAltitude,parent:0})),n.accessObject(n.getAssetsObject()).insertChildLast(i)},r.showPasswordDialog=function(){return H.b.show(i.a.createElement(Xr,{provider:Object(d.a)(Object(d.a)(r))}))},r.showGithubDialog=function(){return H.b.show(i.a.createElement(Zr,{provider:Object(d.a)(Object(d.a)(r))}))},r.accessObject=function(e){return new Nr(r.getDataGraph()).object(e)},r.addBehaviorAssetFromURL=function(e){var t=r.getDataGraph(),n=B(t,t.createObject({type:et.BEHAVIOR_SCRIPT,title:e.title,description:e.description,src:e.url,parent:0}));return r.accessObject(r.getBehaviorsObject()).insertChildLast(n),x.h.setSelection(n.id),n},r.addCustomBehaviorAsset=function(e){var t=Math.floor(1e8*Math.random()),n="behavior_".concat(t,".js"),i="".concat(Object(x.s)()).concat(n),a=e||Wr;return console.log("posting it to",i),P.fetch(i,{method:"POST",body:a}).then(function(e){return e.json()}).then(function(e){console.log("got back the answer",e);var t=r.getDataGraph(),i=B(t,t.createObject({type:et.BEHAVIOR_SCRIPT,title:e.script.title,description:e.script.description,src:n,parent:0}));return r.accessObject(r.getBehaviorsObject()).insertChildLast(i),x.h.setSelection(i.id),i}).catch(function(e){return console.error(e)})},r.addSceneScript=function(e){r.addCustomBehaviorAsset(Vr).then(function(t){return r.addBehaviorToObject(t,e)})},r.addBehaviorToObject=function(e,t){return r.fetchBehaviorAssetContents(e.id).then(function(n){try{var i={type:et.BEHAVIOR,title:e.title,description:e.description,parent:0,behavior:e.id},a=ht(n);r.setCachedBehaviorAsset(e.id,a),a.properties&&Object.keys(a.properties).forEach(function(e){i[e]=a.properties[e].value});var s=r.getDataGraph(),o=B(s,s.createObject(i));return r.accessObject(t).insertChildLast(o),o}catch(c){console.error(c)}})},r.imagecache={},r.behaviorCache={},r.orbit_state={},r.badAssets=[],r.assetsManager=new Jr(Object(d.a)(Object(d.a)(r))),r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"getPopupManager",value:function(){return this.popupManager}},{key:"getDocType",value:function(){return"vr"}},{key:"makeEmptyRoot",value:function(e){var t=B(e,e.createObject({type:et.ROOT,title:"Untitled Project",splashImage:qe.id,defaultScene:qe.id,children:e.createArray()})),r=new Nr(e).object(t.id),n=(new dt).make(e,r),i=(new me).make(e,n),a=B(e,e.createObject({type:et.ASSETS_LIST,title:"Assets",children:e.createArray(),parent:0})),s=B(e,e.createObject({type:et.BEHAVIORS_LIST,title:"Behaviors",children:e.createArray(),parent:0}));U(e,t,n),U(e,n,i),z(e,t,s),z(e,t,a)}},{key:"addAssetLoadingError",value:function(e){this.badAssets.push(e)}},{key:"getProperties",value:function(e){var t=this;var r=[];if(!e)return r;r.push({key:"id",name:"ID",type:x.d.STRING,value:e,locked:!0});var n=this.accessObject(e);if(n.type===et.BEHAVIOR){var i=this.getCachedBehaviorPropDefs(n.behavior);i?Object.keys(i).forEach(function(e){var t=i[e],a={key:e,name:e,type:t.type,value:n[e]};t.hints&&(a.hints=t.hints),r.push(a)}):console.warn("Missing prop defs for behavior object"),r.push({key:"behavior",name:"Script",type:x.d.STRING,value:n.behavior,locked:!0,custom:!0})}var a=this.syncdoc.getPropertiesForObject(e);return a&&a.forEach(function(i){if("type"!==i&&"children"!==i&&"parent"!==i){var a=t.syncdoc.getPropertyValue(e,i);if(Je[i]){var s=function(e,t){var r={};return Object.keys(e).forEach(function(t){return r[t]=e[t]}),r.value=t,r}(Je[i],a);return n.type===et.BEHAVIOR_SCRIPT&&("title"!==i&&"description"!==i||(s.locked=!0)),n.type===et.ASSET&&n.subtype===ct.IMAGE&&("width"!==i&&"height"!==i||(s.locked=!0)),r.push(s)}}}),rt(n.type)&&(r.push({key:"scale",name:"Scale",type:x.d.GROUP,group:["sx","sy","sz"],custom:!0}),r.push({key:"translation",name:"Translation",type:x.d.GROUP,group:["tx","ty","tz"],custom:!0}),r.push({key:"rotation",name:"Rotation",type:x.d.GROUP,group:["rx","ry","rz"],custom:!0})),r}},{key:"setPropertyValue",value:function(e,r,n){var a=this;if("title"===r.key&&this.accessObject(this.getSceneRoot()).find(function(t){return t.title===n&&e!==t.id}).length>0)throw H.b.show(i.a.createElement(an,{text:" You already have an object titled '".concat(n,"'. Titles must be unique.")})),new Error("cannot set title to duplicate value");if("scale"!==r.key&&"translation"!==r.key&&"rotation"!==r.key){if(Object(p.a)(Object(l.a)(t.prototype),"setPropertyValue",this).call(this,e,r,n),r.key===Je.asset.key){var s=this.accessObject(n);if(s.subtype===ct.IMAGE){var o=s.height/s.width*this.accessObject(e).width;Object(p.a)(Object(l.a)(t.prototype),"setPropertyValue",this).call(this,e,{key:"height"},o)}s.subtype===ct.GLTF&&console.log("adjusting to a gtlf")}}else r.group.forEach(function(r){return Object(p.a)(Object(l.a)(t.prototype),"setPropertyValue",a).call(a,e,{key:r},n[r])})}},{key:"getValuesForEnum",value:function(e,t,r){var n=this.accessObject(t);if(n.exists()&&n.type===et.BEHAVIOR&&r.hasHints()){var i=r.getHints();if("node"===i.type)return this.accessObject(this.getSceneRoot()).find(function(e){return e.type===i.nodeType}).map(function(e){return e.id});if("audio"===i.type)return this.accessObject(this.getAssetsObject()).getChildren().filter(function(e){return e.subtype===ct.AUDIO}).map(function(e){return e.id});if("video"===i.type)return this.accessObject(this.getAssetsObject()).getChildren().filter(function(e){return e.subtype===ct.VIDEO}).map(function(e){return e.id});if("media"===i.type)return this.accessObject(this.getAssetsObject()).getChildren().filter(function(e){return e.subtype===ct.AUDIO||e.subtype===ct.VIDEO||e.subtype===ct.IMAGE}).map(function(e){return e.id})}if(e===Je.asset.key){var a=this.accessObject(this.getAssetsObject()).getChildren();if(pn(n.type)&&dn(n.type))return vn(a.filter(function(e){return e.subtype===ct.VIDEO||e.subtype===ct.IMAGE}).map(function(e){return e.id}));if(dn(n.type))return vn(a.filter(function(e){return e.subtype===ct.VIDEO}).map(function(e){return e.id}));if(n.type===_e.model)return vn(a.filter(function(e){return e.subtype===ct.GLTF}).map(function(e){return e.id}));if(pn(n.type))return vn(a.filter(function(e){return e.subtype===ct.IMAGE}).map(function(e){return e.id}))}if(e===Je.horizontalAlign.key)return Object.keys(tt).map(function(e){return tt[e]});if(e===Je.defaultScene.key)return vn(this.accessObject(this.getSceneRoot()).getChildren().filter(function(e){return e.type===et.SCENE}).map(function(e){return e.id}));if(e===Je.texture.key){var s=this.accessObject(this.getAssetsObject()).getChildren();return vn(s=s.filter(function(e){return e.subtype===ct.IMAGE}).map(function(e){return e.id}))}if(e===Je.targetImage.key){var o=this.accessObject(this.getAssetsObject()).getChildren();return o=o.filter(function(e){return e.subtype===ct.IMAGE}).map(function(e){return e.id})}if(e===Je.targetGeoLocation.key){var c=this.accessObject(this.getAssetsObject()).getChildren();return c=c.filter(function(e){return e.subtype===ct.GEOLOCATION}).map(function(e){return e.id})}return e===Je.recType.key?Object.keys(pt):e===Je.splashImage.key?vn(this.accessObject(this.getAssetsObject()).getChildren().filter(function(e){return e.subtype===ct.IMAGE}).map(function(e){return e.id})):e===Je.cloneTarget.key?vn(this.accessObject(this.getSceneRoot()).find(function(e){return rt(e.type)}).map(function(e){return e.id})):void 0}},{key:"getRendererForEnum",value:function(e,t){var r=this.accessObject(t);if(r.exists()&&r.type===et.BEHAVIOR)return ln;switch(e){case Je.asset.key:case Je.defaultScene.key:case Je.texture.key:case Je.targetImage.key:case Je.targetGeoLocation.key:case Je.splashImage.key:case Je.cloneTarget.key:return ln;default:return null}}},{key:"getSelectedSceneObject",value:function(){var e=x.h.getSelection();if(null===e)return this.getFirstSceneObject();var t=this.accessObject(e);return t.exists()?t.type===et.SCENE?t:rt(t.type)?this.findSceneObjectParent(t):t.type===et.BEHAVIOR?this.findSceneObjectParent(t):(this.getLogger().error("We shouldn't ever get here"),this.accessObject(0)):t}},{key:"getFirstSceneObject",value:function(){return this.accessObject(this.getSceneRoot()).getChildren()[0]}},{key:"findSceneObjectParent",value:function(e){return null===e?null:e.exists()?e.type===et.SCENE?e:(e=this.accessObject(e.parent),this.findSceneObjectParent(e)):null}},{key:"quick_setPropertyValue",value:function(e,t,r){var n=this.getDataGraph().getPropertyValue(e,t),i=this.cmd.setProperty(e,t,r);i.prevValue=n,i.value!==i.prevValue&&(this.getRawGraph().process(i),this.fire(x.j.PROPERTY_CHANGED,{provider:this,child:e,propKey:t,oldValue:n,newValue:r}))}},{key:"calculateContextMenu",value:function(e){var t=this,r=[],n=this.accessObject(e);return it(n.type)&&r.push({title:"delete",icon:lt.delete,fun:function(){return lr(t)}}),n.type===et.ASSETS_LIST?pr(this):(n.type===et.BEHAVIORS_LIST&&r.push({title:"Add Behavior from Server",enabled:P.isLoggedIn(),icon:lt.behavior_script,fun:function(){return t.showOpenBehaviorDialog()}}),nt(n.type)&&(r.push({divider:!0}),Object.keys(_e).forEach(function(e){return r.push({title:e,icon:lt[e],fun:function(){return t.add3DObject(e,n)}})})),n.type===et.ROOT&&r.push({title:"scene",icon:lt.scene,fun:function(){return function(e){var t=e.accessObject(e.getSceneRoot()),r=t.getChildren().filter(function(e){return e.type===et.SCENE}),n=null;r.length>=1&&(n=r[r.length-1]);var i=(new dt).make(e.getDataGraph(),t);n?t.insertChildAfter(i,n):t.insertFirstChild(i),x.h.setSelection(i.id)}(t)}}),function(e){return!!rt(e)||e===et.SCENE}(n.type)&&(r.push({divider:!0}),this.accessObject(this.getBehaviorsObject()).getChildren().filter(function(e){return e.type===et.BEHAVIOR_SCRIPT}).forEach(function(n){r.push({title:n.title,icon:lt.behavior_script,fun:function(){return t.addBehaviorToObject(n,e)}})}),r.push({title:"Add Behavior from server",icon:lt.behavior_script,enabled:P.isLoggedIn(),fun:function(){H.b.show(i.a.createElement(Hr,{provider:t,onAdd:function(r){t.addBehaviorToObject(r,e).then(function(e){x.h.setSelection(e.id)})}}))}})),n.type===et.SCENE&&(r.push({divider:!0}),P.scriptEditingSupported&&r.push({title:"Add Scene script",icon:lt.behavior,fun:function(){return t.addSceneScript(e)}})),n.type===et.BEHAVIOR&&(r.push({divider:!0}),r.push({title:"view code",icon:lt.behavior,fun:function(){return x.h.setSelection(n.behavior)}})),it(n.type)&&(r.push({divider:!0}),r.push({title:"cut",icon:lt.cut,fun:this.cutSelection}),r.push({title:"copy",icon:lt.copy,fun:this.copySelection}),r.push({title:"paste",icon:lt.paste,fun:this.pasteSelection})),r)}},{key:"canBeMoved",value:function(e){var t=this.accessObject(e);return t.type!==et.ROOT&&(t.type!==et.BEHAVIORS_LIST&&t.type!==et.ASSETS_LIST)}},{key:"canAddChild",value:function(e,t){var r=this.accessObject(e),n=this.accessObject(t);return r.type===et.ROOT&&n.type===et.SCENE||(!(r.type!==et.SCENE||!rt(n.type))||(!(!rt(r.type)||n.type!==et.BEHAVIOR)||!(!nt(r.type)||!rt(n.type))))}},{key:"canBeSibling",value:function(e,t){var r=this.accessObject(e),n=this.accessObject(t);return r.type===et.SCENE&&n.type===et.SCENE||!(!rt(r.type)||!rt(n.type))}},{key:"canAddExternalChild",value:function(e,t){return this.accessObject(e).type===et.ASSETS_LIST}},{key:"acceptDrop",value:function(e,t){var r=this;this.accessObject(t).type===et.ASSETS_LIST&&G(e.dataTransfer.files).forEach(function(e){return ut(e.type)?Or(e,r):function(e){if(!e)return!1;if(console.log("looking at the file",e,"type",e.type,"type"),!e.type||""===e.type||0===e.type.length){if(console.log("no mimetype. check extension"),e.name.toLowerCase().indexOf(".gltf")>0)return!0;if(e.name.toLowerCase().indexOf(".glb")>0)return!0}return"image/gltf"===e.type.toLowerCase()}(e)?kr(e,r):void 0})}},{key:"moveChildToNewParent",value:function(e,t){e=this.accessObject(e),t=this.accessObject(t),e.removeFromParent(),t.insertFirstChild(e)}},{key:"moveChildAfterSibling",value:function(e,t){e=this.accessObject(e),t=this.accessObject(t),e.removeFromParent(),t.getParent().insertChildAfter(e,t)}},{key:"requestImageCache",value:function(e){var t=this,r=new Image;return r.crossOrigin="anonymous",this.imagecache[e]=r,new Promise(function(n,i){r.src=e,r.onload=function(){t.fire(x.j.STRUCTURE_CHANGED,{provider:t}),n(r)}})}},{key:"createCustomEditor",value:function(e,t,r,n,a){return t.key===Je.color.key||t.key===Je.backgroundColor.key||t.key===Je.borderColor.key||t.key===Je.textColor.key||t.key===Je.startColor.key||t.key===Je.endColor.key?i.a.createElement(mn,{def:t,item:e,onChange:a,value:n}):"scale"===t.key?i.a.createElement(hn,{def:t,item:e,onChange:a,provider:this}):"translation"===t.key?i.a.createElement(hn,{def:t,item:e,onChange:a,provider:this}):"rotation"===t.key?i.a.createElement(hn,{def:t,item:e,onChange:a,provider:this}):"behavior"===t.key?i.a.createElement("button",{onClick:function(){return x.h.setSelection(n)}},"view code"):i.a.createElement("i",null,"no custom editor for ",t.key)}},{key:"loadDocList",value:function(){return P.getJSON("".concat(Object(x.p)(),"list"))}},{key:"removeDoc",value:function(e){return P.fetch("".concat(Object(x.p)(),"delete/").concat(e.id),{method:"POST",body:e.id}).then(function(e){return e.json()})}},{key:"loadAssetList",value:function(){return P.getJSON("".concat(Object(x.o)(),"list"))}},{key:"removeAssetSource",value:function(e){return P.fetch("".concat(Object(x.o)(),"delete/").concat(e.id),{method:"POST",body:e.id}).then(function(e){return e.json()})}},{key:"loadScriptList",value:function(){return P.getJSON("".concat(Object(x.s)(),"list"))}},{key:"removeBehaviorAssetSource",value:function(e){var t="".concat(Object(x.s)(),"delete/").concat(e);return console.log("removing",t),P.fetch(t,{method:"POST",body:e}).then(function(e){return e.json()})}},{key:"fetchBehaviorAssetContents",value:function(e){var t=this.accessObject(e),r=Object(x.s)()+t.src;return P.fetch(r,{method:"GET"}).then(function(e){return e.text()})}},{key:"updateBehaviorAssetContents",value:function(e,t){if(P.supportsScriptEdit())try{var r=ht(t);r.text=t,this.setCachedBehaviorAsset(e,r);var n=this.accessObject(e),i=Object(x.s)()+n.src;return P.fetch(i,{method:"POST",body:t}).then(function(e){return e.json()}).then(function(e){n.set("title",e.script.title),n.set("description",e.script.description)})}catch(a){console.error("error parsing the script",a),j.add("error parsing")}}},{key:"getCachedBehaviorPropDefs",value:function(e){return this.behaviorCache[e]?this.behaviorCache[e].properties:(console.error("no parsed behavior in the cache",e),null)}},{key:"getCachedBehaviorAsset",value:function(e){return this.behaviorCache[e]}},{key:"setCachedBehaviorAsset",value:function(e,t){this.behaviorCache[e]=t}},{key:"setAudioListener",value:function(e){this.audioListener=e}},{key:"getAudioListener",value:function(){return this.audioListener}},{key:"showBadAssetsDialog",value:function(){H.b.show(i.a.createElement(_r,{provider:this}))}}]),t}(q),on=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).showSaveAsDialog=function(){H.b.show(i.a.createElement($r,{provider:r.props.provider}))},r.resizeLeft=function(e){window.addEventListener("mousemove",r.resizeLeftWindow),window.addEventListener("mouseup",r.endResizeLeftWindow)},r.resizeLeftWindow=function(e){r.setState({leftDivider:e.clientX+"px"})},r.endResizeLeftWindow=function(e){window.removeEventListener("mousemove",r.resizeLeftWindow),window.removeEventListener("mouseup",r.endResizeLeftWindow)},r.resizeRight=function(e){window.addEventListener("mousemove",r.resizeRightWindow),window.addEventListener("mouseup",r.endResizeRightWindow)},r.resizeRightWindow=function(e){var t=document.querySelector(".grid").getBoundingClientRect();r.setState({rightDivider:t.width-e.clientX+"px"})},r.endResizeRightWindow=function(e){window.removeEventListener("mousemove",r.resizeRightWindow),window.removeEventListener("mouseup",r.endResizeRightWindow)},r.resizeBottom=function(e){window.addEventListener("mousemove",r.resizeBottomWindow),window.addEventListener("mouseup",r.endResizeBottomWindow)},r.resizeBottomWindow=function(e){var t=document.querySelector(".grid").getBoundingClientRect();r.setState({bottomDivider:t.height-e.clientY+"px"})},r.endResizeBottomWindow=function(e){window.removeEventListener("mousemove",r.resizeBottomWindow),window.removeEventListener("mouseup",r.endResizeBottomWindow)},r.toggleLeftPane=function(e){"0px"===r.state.leftDivider?r.setState({leftDivider:"250px"}):r.setState({leftDivider:"0px"})},r.toggleRightPane=function(e){"0px"===r.state.rightDivider?r.setState({rightDivider:"250px"}):r.setState({rightDivider:"0px"})},r.toggleBottomPane=function(e){"0px"===r.state.bottomDivider?r.setState({bottomDivider:"250px"}):r.setState({bottomDivider:"0px"})},r.selectionChanged=function(){if(!x.h.isEmpty()){var e=r.props.provider.accessObject(x.h.getSelection());if(e.type===et.BEHAVIOR_SCRIPT)return r.setState({mode:"script"});if(e.type===Je.asset.key)return r.setState({mode:"asset"})}r.setState({mode:"canvas"})},r.toggleRunning=function(){r.setState({running:!r.state.running})},r.newDoc=function(){r.state.dirty?(console.log("can't create new becausue dirty"),H.b.show(i.a.createElement(jr,{onAnyway:function(){console.log("we are doing it anyway"),hr(r.props.provider)}}))):hr(r.props.provider)},r.showOpenDocumentDialog=function(){r.state.dirty?H.b.show(i.a.createElement(jr,{onAnyway:function(){console.log("we are doing it anyway"),r.props.provider.showOpenDocumentDialog()}})):r.props.provider.showOpenDocumentDialog()},r.state={mode:"canvas",user:null,running:!1,connected:!1,dirty:!0,leftDivider:"250px",rightDivider:"250px",bottomDivider:"250px"},r.im=new x.b,r.im.addKeyBinding({id:"save",key:x.b.KEYS.S,modifiers:[x.b.MODIFIERS.COMMAND]}),r.im.addKeyBinding({id:"undo",key:x.b.KEYS.Z,modifiers:[x.b.MODIFIERS.COMMAND]}),r.im.addKeyBinding({id:"redo",key:x.b.KEYS.Z,modifiers:[x.b.MODIFIERS.COMMAND,x.b.MODIFIERS.SHIFT]}),r.im.addListener("save",r.props.provider.save),r.im.addListener("undo",r.props.provider.performUndo),r.im.addListener("redo",r.props.provider.performRedo),r.im.addKeyBinding({id:"cut",key:x.b.KEYS.X,modifiers:[x.b.MODIFIERS.COMMAND]}),r.im.addKeyBinding({id:"copy",key:x.b.KEYS.C,modifiers:[x.b.MODIFIERS.COMMAND]}),r.im.addKeyBinding({id:"paste",key:x.b.KEYS.V,modifiers:[x.b.MODIFIERS.COMMAND]}),r.im.addListener("cut",r.props.provider.cutSelection),r.im.addListener("copy",r.props.provider.copySelection),r.im.addListener("paste",r.props.provider.pasteSelection),r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){var e=this;this.im.attachKeyEvents(document),x.h.on(x.g.CHANGED,this.selectionChanged),P.on(E,function(){return e.setState({user:P.getUsername()})}),P.on("CONNECTED",function(){return e.setState({connected:!0})}),P.isConnected()&&this.setState({connected:!0}),this.props.provider.on(x.j.CLEAR_DIRTY,function(){e.setState({dirty:!1})}),this.props.provider.on(x.j.PROPERTY_CHANGED,function(){e.setState({dirty:!0})}),this.props.provider.on(x.j.SAVED,function(){e.setState({dirty:!1})})}},{key:"componentWillUnmount",value:function(){x.h.off(x.g.CHANGED,this.selectionChanged)}},{key:"render",value:function(){if(!1===this.state.connected)return i.a.createElement("div",null,i.a.createElement("h1",null,"connecting to server"),i.a.createElement(H.a,null));var e=this.props.provider,t=null;if(e.pubnub&&(t=e.getLogger()),!e.getDataGraph())return i.a.createElement("div",null,i.a.createElement("h1",null,"connecting to server"),i.a.createElement(H.a,null));var r={gridTemplateColumns:"".concat(this.state.leftDivider," 0px 1fr 0px ").concat(this.state.rightDivider),gridTemplateRows:"2rem 1fr 2rem 0px ".concat(this.state.bottomDivider)};return i.a.createElement(Kr,{logger:t},i.a.createElement("div",{className:"grid",style:r},i.a.createElement("div",{className:"toolbar gray"},this.renderLoginButton(),i.a.createElement(x.i,null),i.a.createElement("button",{className:"fa fa-file green",onClick:this.newDoc,title:"new project"}),i.a.createElement("button",{className:"fa fa-save green",onClick:function(){return e.save()},title:"save project"}),i.a.createElement("button",{className:"fa fa-clone green",onClick:this.showSaveAsDialog,title:"duplicate project"})),i.a.createElement(cn,{onMouseDown:this.resizeLeft}),i.a.createElement("div",{className:"toolbar gray"},i.a.createElement("button",{className:"fa fa-cube yellow",onClick:function(t){return function(e,t){var r=t.getSelectedSceneObject(),n=Object.keys(_e).map(function(e){return{title:e,icon:lt[e],fun:function(){return t.add3DObject(e,r)}}});t.getPopupManager().show(i.a.createElement(x.c,{actions:n}),e.target)}(t,e)}}),i.a.createElement("button",{className:"fa fa-archive yellow",onClick:function(t){return function(e,t){var r=pr(t);t.getPopupManager().show(i.a.createElement(x.c,{actions:r}),e.target)}(t,e)}}),i.a.createElement("button",{className:"fab fa-superpowers yellow",onClick:function(t){return function(e,t){var r=[{title:"Add Behavior from Server",enabled:P.isLoggedIn(),icon:lt.behavior_script,fun:function(){return t.showOpenBehaviorDialog()}}];P.supportsScriptEdit()&&r.push({title:"custom behavior",enabled:P.isLoggedIn(),icon:lt.behavior_script,fun:function(){return t.addCustomBehaviorAsset()}}),t.getPopupManager().show(i.a.createElement(x.c,{actions:r}),e.target)}(t,e)}}),i.a.createElement(x.i,null),i.a.createElement(fn,{onClick:this.toggleRunning,active:this.state.running}),i.a.createElement(x.i,null),i.a.createElement("button",{className:"fa fa-cut purple",onClick:e.cutSelection}),i.a.createElement("button",{className:"fa fa-copy purple",onClick:e.copySelection}),i.a.createElement("button",{className:"fa fa-paste purple",onClick:e.pasteSelection}),i.a.createElement("button",{className:"fas fa-undo purple",onClick:e.performUndo}),i.a.createElement("button",{className:"fas fa-redo purple",onClick:e.performRedo})),i.a.createElement(cn,{onMouseDown:this.resizeRight}),i.a.createElement("div",{className:"toolbar gray"},i.a.createElement("i",{className:"fa fa-horse-head",title:"7/15/2019, 4:49:53 PM"}),i.a.createElement("label",null,"MrEd")),i.a.createElement("div",{className:"panel high-2"},i.a.createElement(x.m,{root:e.getSceneRoot(),provider:e})),i.a.createElement(cn,{onMouseDown:this.resizeLeft}),i.a.createElement("div",{className:"panel"},this.renderCenterPane(this.state.mode)),i.a.createElement(cn,{onMouseDown:this.resizeRight}),i.a.createElement("div",{className:"panel high-2",style:{backgroundColor:"#ecf0f1"}},i.a.createElement(x.e,{provider:e})),i.a.createElement(cn,{onMouseDown:this.resizeLeft}),i.a.createElement("div",{className:"toolbar borderless"},i.a.createElement("button",{className:"borderless gray far"+("0px"!==this.state.leftDivider?" fa-caret-square-left":" fa-caret-square-right"),onClick:this.toggleLeftPane}),i.a.createElement("button",{className:"borderless gray far"+("0px"!==this.state.bottomDivider?" fa-caret-square-down":" fa-caret-square-up"),onClick:this.toggleBottomPane}),i.a.createElement(x.i,null),i.a.createElement("span",{className:"button blue",onClick:function(){return e.viewInVR()}},i.a.createElement("i",{className:"fas fa-external-link-alt"}),i.a.createElement("b",null,"Phone View")),this.props.bottomText,i.a.createElement(x.i,null),i.a.createElement("button",{className:"borderless gray far"+("0px"!==this.state.rightDivider?" fa-caret-square-right":" fa-caret-square-left"),onClick:this.toggleRightPane})),i.a.createElement(cn,{onMouseDown:this.resizeRight}),i.a.createElement(un,{onMouseDown:this.resizeBottom}),i.a.createElement(nn,{logger:this.props.provider.getLogger()}),i.a.createElement(en,null),i.a.createElement(H.a,null),i.a.createElement(H.d,null)))}},{key:"renderCenterPane",value:function(e){return"script"===e?i.a.createElement(zr,{provider:this.props.provider}):"canvas"===e?i.a.createElement(qt,{provider:this.props.provider,running:this.state.running}):i.a.createElement(Ir,{provider:this.props.provider,asset:x.h.getSelection()})}},{key:"renderLoginButton",value:function(){var e=this,t=[];return P.supportsAuth()&&(P.isLoggedIn()?t.push(i.a.createElement("span",{key:"logout",className:"blue button",onClick:P.logout},i.a.createElement("i",{className:"fa fa-user"}),i.a.createElement("b",null,"logout"))):t.push(i.a.createElement("span",{key:"login",className:"blue button",onClick:function(){P.supportsPassword()?e.props.provider.showPasswordDialog():e.props.provider.showGithubDialog()}},i.a.createElement("i",{className:"fa fa-user"}),i.a.createElement("b",null,"login")))),P.supportsDocList()&&t.push(i.a.createElement("button",{key:"open",className:"fa fa-folder-open blue",onClick:this.showOpenDocumentDialog,title:"open"})),t}}]),t}(n.Component),cn=function(e){return i.a.createElement("div",Object.assign({className:"resizer"},e))},un=function(e){return i.a.createElement("div",Object.assign({className:"resizer-h"},e))},ln=function(e){var t="---";return e.value&&e.provider&&(t=e.provider.accessObject(e.value).title),e.value===qe.id&&(t=qe.title),i.a.createElement("b",null,t)},hn=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).syncChanged=function(e){return r.setState({sync:!r.state.sync})},r.changed=function(e,t){var n=r.props.provider.accessObject(r.props.item),i=r.props.def.getGroupKeys(),a={};i.forEach(function(e){return a[e]=n[e]});var s=parseFloat(e.target.value);a[t]=s,r.state.sync&&i.forEach(function(e){return a[e]=s}),r.props.onChange(a)},r.state={sync:!1},r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){var e=this,t=this.props.provider.accessObject(this.props.item),r=this.props.def.getGroupKeys().map(function(r){return i.a.createElement("input",{key:r,type:"number",value:t[r],onChange:function(t){e.changed(t,r)},step:.1})});return i.a.createElement(H.c,{className:"combined"},i.a.createElement("input",{type:"checkbox",checked:this.state.sync,onChange:this.syncChanged}),r)}}]),t}(n.Component);function pn(e){return e===_e.plane||e===_e.bg360||e===_e.img2d||e===_e.cube||e===_e.sphere}function dn(e){return e===_e.plane||e===_e.bg360||e===_e.img2d}var fn=function(e){var t=e.active?"run-button active fa fa-stop":"run-button fa fa-play";return i.a.createElement("button",{onClick:e.onClick,className:t+" blue"})};function vn(e){return e.push(qe.id),e}var mn=function(e){function t(){var e,r;Object(o.a)(this,t);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++)a[s]=arguments[s];return(r=Object(u.a)(this,(e=Object(l.a)(t)).call.apply(e,[this].concat(a)))).showPopup=function(e){r.context.show(i.a.createElement(yn,{onChange:r.props.onChange,value:r.props.value}),e.target)},r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){return i.a.createElement("button",{style:{backgroundColor:this.props.value},onClick:this.showPopup},this.props.value)}}]),t}(n.Component);mn.contextType=H.f;var yn=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).onChange=function(e){r.setState({value:e.target.value});var t=e.target.value;t.indexOf("#")>=0&&7===t.length&&r.props.onChange(t)},r.done=function(){r.props.onChange(r.state.value),r.context.hide()},r.state={value:e.value},r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"render",value:function(){var e=this;return i.a.createElement(H.g,{style:{width:"130px",height:"100px",backgroundColor:"white"}},i.a.createElement(H.c,null,$e.map(function(t){return i.a.createElement("button",{key:t,onClick:function(){e.props.onChange(t)},style:{color:t,padding:"1px",margin:0,borderWidth:0},className:"fa fa-square"})})),i.a.createElement("input",{type:"text",value:this.state.value,onChange:this.onChange}),i.a.createElement("button",{onClick:this.done},"done"))}}]),t}(n.Component);yn.contextType=H.f;var gn=new Map,bn=Nt.mat4.create(),wn=[0,0,0],On=[0,0,-1],kn=null,An=null,Sn=new Q.Color(14548957),xn=new Q.Color(16737894),Mn=new Q.MeshStandardMaterial({color:Sn}),Cn=!0,jn=0,En=function(e){function t(e,r){var n;return Object(o.a)(this,t),n=Object(u.a)(this,Object(l.a)(t).call(this)),jn?(r.error("XRWorldInfo called more than once - very bad"),Object(u.a)(n,jn)):(jn=Object(d.a)(Object(d.a)(n)),n.engine=e,n.session=e.session,n.logger=r,n.visible=!1,n._floorPos=Nt.vec3.create(),n.session.updateWorldSensingState({illuminationDetectionState:{enabled:!0},meshDetectionState:{enabled:!0,normals:!0}}),n._handleHitResults=n.handleHitResults.bind(Object(d.a)(Object(d.a)(n))),(An=new Q.Mesh(new Q.RingGeometry(.04,.05,36,64),Mn)).geometry.applyMatrix((new Q.Matrix4).makeRotationX(Q.Math.degToRad(-90))),(kn=new Q.Object3D).add(An),kn.matrixAutoUpdate=!1,kn.visible=!1,n)}return Object(h.a)(t,e),Object(c.a)(t,[{key:"setVisible",value:function(e){this.visible=e,kn.visible=e,gn.forEach(function(t){t.node.visible=t.mesh.visible=e})}},{key:"refreshWorldInfo",value:function(e){var t=this,r=e.worldInformation;r&&r.meshes&&(gn.forEach(function(e){e.seen=!1}),r.meshes.forEach(function(e){var r=gn.get(e.uid);r?t.handleUpdateNode(e,r):t.handleNewNode(e)}),gn.forEach(function(e){e.seen||t.handleRemoveNode(e)}),Cn&&(Cn=!1,this.session.requestFrameOfReference("head-model").then(function(e){t.session.requestFrameOfReference("eye-level").then(function(r){var n=Nt.vec3.create();e.getTransformTo(r,bn),Nt.mat4.getTranslation(n,bn),t.findFloorNear(n)&&Nt.vec3.squaredDistance(n,t._floorPos)>.01&&(Nt.vec3.copy(t._floorPos,n),t.logger.log("************** floor is at "+t._floorPos[1])),t.session.requestHitTest(wn,On,e).then(t._handleHitResults).catch(function(e){t.logger.error("Error testing hits",e)})})})))}},{key:"handleHitResults",value:function(e){var t=this;if(e&&e.length>0){var r=e[0];this.session.requestFrameOfReference("head-model").then(function(e){t.session.requestFrameOfReference("eye-level").then(function(n){e.getTransformTo(n,bn),Nt.mat4.multiply(bn,bn,r.hitMatrix);var i=kn;i.matrix.fromArray(bn),kn.visible=t.visible,An.material.color=Sn,i.updateMatrixWorld(!0)})})}else An.material.color=xn;Cn=!0}},{key:"handleUpdateNode",value:function(e,t){if(t.seen=!0,!(e.timeStamp<=t.ts)){if(e.vertexCountChanged){var r=this.newMeshNode(e);t.threeMesh.geometry.dispose(),t.node.remove(t.threeMesh),t.node.add(r),t.threeMesh=r}else{if(e.vertexPositionsChanged){var n=t.threeMesh.geometry.attributes.position;n.array.length!==e.vertexPositions.length&&this.logger.error("position and vertex arrays are different sizes",n,e),n.setArray(e.vertexPositions),n.needsUpdate=!0}if(e.textureCoordinatesChanged){var i=t.threeMesh.geometry.attributes.uv;i.array.length!==e.textureCoordinates.length&&this.logger.error("uv and vertex arrays are different sizes",i,e),i.setArray(e.textureCoordinates),i.needsUpdate=!0}if(e.triangleIndicesChanged){var a=t.threeMesh.geometry.index;a.array.length!==e.triangleIndices&&this.logger.error("uv and vertex arrays are different sizes",a,e),a.setArray(e.triangleIndices),a.needsUpdate=!0}if(e.vertexNormalsChanged&&e.vertexNormals.length>0){var s=t.threeMesh.geometry.attributes.normals;s.array.length!==e.vertexNormals&&this.logger.error("uv and vertex arrays are different sizes",s,e),s.setArray(e.vertexNormals),s.needsUpdate=!0}}t.threeMesh.visible=this.visible}}},{key:"handleRemoveNode",value:function(e){this.remove(e.node),e.threeMesh.geometry.dispose(),this.engine._removeAnchorForNode(e.node,this.logger),gn.delete(e.worldMesh.uid)}},{key:"handleNewNode",value:function(e){var t=new Q.Group,r=this.newMeshNode(e);t.add(r),this.add(t),t.visible=r.visible=this.visible,this.engine.addAnchoredNode(e,t,this.logger),gn.set(e.uid,{ts:e.timeStamp,worldMesh:e,node:t,seen:!0,threeMesh:r})}},{key:"newMeshNode",value:function(e){var t=new Q.Group,r=new Q.BufferGeometry,n=new Q.BufferAttribute(e.triangleIndices,1);n.dynamic=!0,r.setIndex(n);var i=new Q.BufferAttribute(e.vertexPositions,3);i.dynamic=!0,r.addAttribute("position",i);var a=new Q.BufferAttribute(e.textureCoordinates,2);if(a.dynamic=!0,r.addAttribute("uv",a),e.vertexNormals.length>0){var s=new Q.BufferAttribute(e.vertexNormals,3);s.dynamic=!0,r.addAttribute("normal",s)}else r.computeVertexNormals();var o=new Q.MeshPhongMaterial({color:"#11FF11",wireframe:!0}),c=new Q.MeshPhongMaterial({color:"#009900",transparent:!0,opacity:.25});return t.add(new Q.Mesh(r,c)),t.add(new Q.Mesh(r,o)),t.geometry=r,t}},{key:"findFloorNear",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:9,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-.5,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-2,i=Nt.vec3.create(),a=Nt.vec3.create(),s=0;return gn.forEach(function(o){var c=o.worldMesh;Nt.vec3.set(i,c._center.x,c._center.y,c._center.z),Nt.vec3.transformMat4(i,i,c.modelMatrix);var u=i[1]-e[1];u>r||(u<n||(e[0]-i[0])*(e[0]-i[0])+(e[2]-i[2])*(e[2]-i[2])-c._extent[0]*c._extent[0]-c._extent[1]*c._extent[1]-t>0||s<u||(s=u,Nt.vec3.set(a,e[0],i[1],e[2])))}),!!s&&(Nt.vec3.copy(e,a),!0)}},{key:"floorPos",get:function(){return this._floorPos}}]),t}(Q.Group),Pn=r(44),Dn=r.n(Pn),Rn=function(e){return document.querySelector(e)};function Ln(e,t){e.find=function(t,r){return r||(r=[]),t(e)&&r.push(e),e.children&&e.children.forEach(function(e){e.find(t,r)}),r},e.exists=function(){return!0},e.getParent=function(){return t[e.parent]}}var In=function(e){function t(e){var r;Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this,e))).clickedStart=function(){console.log("clicked. play the sample audio"),Rn("#overlay").style.display="none",Rn("#test-audio").play();var e=r.canvas;Ft.supportsARKit()?(r.xr=new Ft,r.xr.getContext(e).then(function(t){r.initThreeJS(e,t),r.xr.setAnimationLoop(r.renderThreeWithCamera.bind(Object(d.a)(Object(d.a)(r)))),r.xrWorldInfo=new En(r.xr,r.logger),r.scene.add(r.xrWorldInfo),r.startScene()}).catch(function(e){console.error("Error",e)})):(r.initThreeJS(e,0),r.renderer.setAnimationLoop(r.renderThree.bind(Object(d.a)(Object(d.a)(r)))),r.startScene())},r.clickedCanvas=function(e){r.logger.log("clicked on the canvas"),r.canvas.focus();var t=r.canvas.getBoundingClientRect(),n={x:(e.clientX-t.left)/t.width*2-1,y:-(e.clientY-t.top)/t.height*2+1};r.raycaster.setFromCamera(n,r.camera);var i=r.three_map[r.current_scene.id],a=r.raycaster.intersectObjects(i.children,!0);if(a&&a.length>=1){var s=a.find(function(e){return e.distance>0});if(s){var o=function e(t){return t?t.userData.graphid?t:e(t.parent):null}(s.object),c=r.obj_map[o.userData.graphid];r.scriptManager.performClickAction(c,e)}}},r.renderThreeWithCamera=function(e,t,n,i,a){r.scene&&r.camera&&(r.camera.matrix.fromArray(n),r.camera.matrixWorldNeedsUpdate=!0,r.camera.updateMatrixWorld(),r.camera.projectionMatrix.fromArray(t),r.xrWorldInfo&&r.xrWorldInfo.refreshWorldInfo(a),r.renderThree(i,a))},r.renderThree=function(e,t){r.tweenManager&&r.tweenManager.update(e),r.previewUpdateNodes.forEach(function(e){return e.previewUpdate()}),r.pointer&&r.pointer.tick(e),r.stats&&r.stats.update(e),r.controller&&r.controller.update(e);var n=null;r.xr&&(n=r.xr.session),r.scriptManager.tick(e,n),r.renderer.render(r.scene,r.camera)},r.state={docLoaded:!1,title:"Loading...",showErrors:!1,splashImage:null};var n=Object(x.v)({});if(!n.doc)throw new Error("doc not specified");return new x.l(e.options),r.obj_map={},r.three_map={},r.title_map={},r.previewUpdateNodes=[],r.current_scene=null,r.root=null,r.behavior_map={},r.behavior_assets={},r.assets_url_map={},r.pendingAssets=[],r.badAssets=[],r.sceneAnchor=null,r.logger=new T(n.doc),r.scriptManager=new gt(new Tn(Object(d.a)(Object(d.a)(r))),r.logger),r.provider={accessObject:function(e){return r.obj_map[e]?r.obj_map[e]:{exists:function(){return!1}}},getLogger:function(){return r.logger},getAudioListener:function(){return r.audioListener}},r.assetsManager=new Jr(r.provider),r.provider.assetsManager=r.assetsManager,r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"getLogger",value:function(){return this.logger}},{key:"componentDidMount",value:function(){this.logger.log("mounted ImmersivePlayer"),this.loadDocument(),Rn("#progress").value=0}},{key:"loadDocument",value:function(){var e=this,t=Object(x.v)({});this.logger.log("loading assets"),this.assetsManager.cacheAssetsList().then(function(){e.logger.log("loading document"),P.getJSON(Object(x.p)()+t.doc).then(function(t){if(e.logger.log("loaded payload",e.root),e.root=t.graph,e.root.children.forEach(function(t){if(t.type===et.ASSETS_LIST)return e.initAssets(t)}),e.logger.log("the title is",e.root.title),e.root.splashImage&&e.root.splashImage!==qe.id){e.logger.log("the splash image is",e.root.splashImage);var r=e.provider.accessObject(e.root.splashImage);e.logger.log("the asset is",r);var n=e.assetsManager.getAssetURL(r);e.logger.log("the url is",n),e.setState({splashImage:n})}e.setState({title:e.root.title});var i=e.root.children.find(function(e){return e.type===et.ASSETS_LIST});e.validateAssets(i).then(function(){console.log("fully validated!"),Rn("#progress").value=100,Rn("#loading-indicator").style.display="none",e.setState({docLoaded:!0})})})})}},{key:"startScene",value:function(){var e=this;this.buildRoot(this.root),this.logger.log(this.root),Promise.all(this.pendingAssets).then(function(){if(e.logger.log("all assets loaded now. starting script manager"),e.scriptManager.startRunning(),e.root.defaultScene&&e.root.defaultScene!==qe.id){var t=e.root.children.find(function(t){return t.id===e.root.defaultScene});if(!t)return e.logger.error("cannot find the default scene");e.setCurrentScene(t)}else{var r=e.root.children[0];e.setCurrentScene(r)}e.scriptManager.startFirstScene()})}},{key:"render",value:function(){var e=this;return i.a.createElement("div",null,i.a.createElement("audio",{id:"test-audio",src:Dn.a}),i.a.createElement("div",{id:"overlay"},i.a.createElement("div",{id:"inner"},i.a.createElement("h1",{id:"title"},this.state.title),i.a.createElement("h2",null,i.a.createElement("button",{onClick:this.clickedStart,disabled:!this.state.docLoaded},"click to start")),i.a.createElement("div",{id:"loading-indicator"},i.a.createElement("label",null,"loading..."),i.a.createElement("br",null),i.a.createElement("progress",{max:"100",value:"0",id:"progress"})),this.renderSplashImage()),this.renderErrors()),i.a.createElement(Kr,{logger:this.logger},i.a.createElement("canvas",{ref:function(t){return e.canvas=t},width:600,height:400,onClick:this.clickedCanvas})))}},{key:"buildRoot",value:function(e){var t=this;e.children.forEach(function(e){return Ln(e,t.obj_map),e.type===et.SCENE?t.initObject(e):e.type===et.BEHAVIORS_LIST?t.initBehaviors(e):void 0})}},{key:"initObject",value:function(e){var t=this;Ln(e,this.obj_map),this.obj_map[e.id]=e,e.title&&(this.title_map[e.title]=e);var r=null;if(e.type===et.SCENE){var n=(new dt).makeNode(e,this.provider);this.three_map[e.id]=n,n.userData.graphid=e.id,this.scenes.add(n),n.visible=!1,r=n}return e.props=function(){return e},rt(e.type)&&((r=at(e.type).makeNode(e,this.provider)).previewUpdate&&this.previewUpdateNodes.push(r),this.three_map[e.id]=r,r.userData.graphid=e.id,Object(x.u)(r,"click",function(r){t.scriptManager.performClickAction(e,r)})),e.type===et.BEHAVIOR&&(this.behavior_map[e.id]=e),e.children&&e.children.forEach(function(e){var n=t.initObject(e);n&&r.add(n)}),r}},{key:"initThreeJS",value:function(e,t){var r=this;this.tweenManager=new Dt,this.scene=new Q.Scene,this.camera=new Q.PerspectiveCamera(70,window.innerWidth/window.innerHeight,.1,50),this.renderer=new Q.WebGLRenderer({antialias:!0,canvas:e,context:t}),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.gammaOutput=!0,this.renderer.vr.enabled=!0,this.vrmanager=new Qt.h(this.renderer),this.audioListener=new Q.AudioListener,this.camera.add(this.audioListener),this.xr||(this.scene.background=new Q.Color(0)),this.camera.matrixAutoUpdate=!1,this.scene.add(this.camera),window.addEventListener("resize",function(){var e=document.documentElement;r.camera.aspect=e.clientWidth/e.clientHeight,r.camera.updateProjectionMatrix(),r.renderer.setSize(e.clientWidth,e.clientHeight)},!1);var n=new Q.DirectionalLight(16777215,1);n.position.set(1,1,1).normalize(),this.scene.add(n),this.scene.add(new Q.AmbientLight(16777215,.2)),this.scenes=new Q.Group,this.scene.add(this.scenes),this.raycaster=new Q.Raycaster}},{key:"initAssets",value:function(e){var t=this;e.children.forEach(function(e){t.logger.log("initing asset",e),Ln(e,t.obj_map),t.obj_map[e.id]=e,e.title&&(t.title_map[e.title]=e),t.assets_url_map[e.id]=e.url})}},{key:"initBehaviors",value:function(e){var t=this;e.children.forEach(function(e){if(Ln(e,t.obj_map),t.obj_map[e.id]=e,e.type===et.BEHAVIOR_SCRIPT){var r=Object(x.s)()+e.src;t.logger.log("loading behavior",e,"from",r);var n=P.fetch(r,{method:"GET"}).then(function(e){return e.text()}).then(function(r){var n=ht(r);return n.text=r,t.behavior_assets[e.id]=n,r}).catch(function(e){t.logger.error("error loading behavior",e)});t.pendingAssets.push(n)}})}},{key:"setCurrentScene",value:function(e){var t=this,r=this.three_map[e.id];if(r&&this.xr){var n=r.userData.sceneAnchor;n?(n.children?(this.logger.log("scene has children: ",r.children.length),this.logger.log("scene anchor has children: ",n.children.length)):this.logger.log("no sceneNode children?"),!this.sceneAnchor||this.sceneAnchor&&e.autoRecenter?(this.sceneAnchor&&(this.xr.removeSceneAnchor(this.sceneAnchor,this.logger),this.sceneAnchor=null),this.xr.createSceneAnchor(n,this.logger).then(function(e){t.sceneAnchor=e}).catch(function(e){t.logger.error("error creating new scene anchor: ".concat(e))})):this.xr.updateAnchoredSceneNode(this.sceneAnchor,n,this.logger)):this.logger.error("no sceneNode? so no children?")}this.scenes.children.forEach(function(e){return e.visible=!1}),this.three_map[e.id]&&(this.three_map[e.id].visible=!0),this.current_scene=e}},{key:"renderSplashImage",value:function(){return this.state.splashImage?i.a.createElement("img",{src:this.state.splashImage,width:"80%",height:"auto",alt:"splash screen"}):""}},{key:"validateAssets",value:function(e){var t=this;return Promise.all(e.children.map(function(e){return e.subtype===ct.VIDEO?t.assetsManager.getTexture(e.id).then(function(r){r||(t.getLogger().error("error loading a texture",e),t.addAssetLoadingError(e))}):e.subtype===ct.IMAGE?t.assetsManager.getTexture(e.id).then(function(r){r||(t.getLogger().error("error loading a texture",e),t.addAssetLoadingError(e))}):e.subtype===ct.GLTF?t.assetsManager.getGLTF(e.id).then(function(r){r||(t.getLogger().error("error loading a model",e),t.addAssetLoadingError(e))}):Promise.resolve("all good")})).then(function(e){console.log("fully loaded all assets now"),console.log("error count is",t.badAssets.length),t.badAssets.length>0&&t.showBadAssetsDialog()})}},{key:"showBadAssetsDialog",value:function(){this.logger.log("showing a bad assets dialog"),this.setState({showErrors:!0})}},{key:"addAssetLoadingError",value:function(e){this.badAssets.push(e)}},{key:"renderErrors",value:function(){var e=this;return this.state.showErrors?i.a.createElement("div",{id:"errors-dialog"},i.a.createElement("h3",null,"Bad or Missing Assets"),i.a.createElement("ul",null,this.badAssets.map(function(e,t){return i.a.createElement("li",{key:t},i.a.createElement("b",null,e.title)," ",i.a.createElement("i",null,e.src))})),i.a.createElement("button",{onClick:function(){return e.setState({showErrors:!1})}},"dismiss")):""}}]),t}(n.Component),Tn=function(e){function t(e){var r;return Object(o.a)(this,t),(r=Object(u.a)(this,Object(l.a)(t).call(this))).player=e,r.logger=r.player.logger,r}return Object(h.a)(t,e),Object(c.a)(t,[{key:"getCurrentScene",value:function(){return this.player.current_scene||this.logger.error("the current scene is null"),this.player.current_scene}},{key:"getSceneObjects",value:function(e){return e.children.filter(function(e){return rt(e.type)})}},{key:"getBehaviorsForObject",value:function(e){return e.children?e.children.filter(function(e){return e.type===et.BEHAVIOR}):[]}},{key:"getThreeObject",value:function(e){if(e){if(e.id)return this.player.three_map[e.id]}else this.logger.error("getThreeObject got invalid obj");return this.player.three_map[e]}},{key:"getParsedBehaviorAsset",value:function(e){return this.player.behavior_assets[e.behavior]}},{key:"getAllBehaviors",value:function(){var e=this;return Object.keys(this.player.behavior_map).map(function(t){return e.player.behavior_map[t]})}},{key:"getAllScenes",value:function(){var e=this;return Object.keys(this.player.obj_map).map(function(t){return e.player.obj_map[t]}).filter(function(e){return e.type===et.SCENE})}},{key:"navigateScene",value:function(e){this.logger.log("navigating to ",e);var t=this.player.obj_map[e];if(!t)return this.logger.error("couldn't find scene for",e);this.player.setCurrentScene(t)}},{key:"playMediaAsset",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.player.assetsManager.playMediaAsset(e,t)}},{key:"stopMediaAsset",value:function(e){this.player.assetsManager.stopMediaAsset(e)}},{key:"getGraphObjectByName",value:function(e){return this.player.title_map[e]}},{key:"getGraphObjectById",value:function(e){return this.player.obj_map[e]}},{key:"getCamera",value:function(){return this.player.camera}},{key:"getTweenManager",value:function(){return this.player.tweenManager}},{key:"getFloorNear",value:function(e){if(this.player.xr&&this.player.xr.session&&this.player.xrWorldInfo){var t=Nt.vec3.fromValues(e.point.x,e.point.y,e.point.z),r=e.targetRadiusSq||9,n=e.targetTop||-.5,i=e.targetBottom||-2;return this.player.xrWorldInfo.findFloorNear(t,r,n,i)?new Q.Vector3(t[0],t[1],t[2]):0}this.logger.log("XR is not active?")}},{key:"startLocalAnchor",value:function(e){if(this.logger.log("start or update anchor of various flavors"),this.player.xr&&this.player.xr.session&&this.player.xrWorldInfo)switch(e.node&&e.node.position||this.logger.log("Node is not present or wrong type?"),e.style){case"ray":this.player.xr.updateRayAnchor(e,this.logger);break;case"floor":default:var t=Nt.vec3.fromValues(e.node.position.x,e.node.position.y,e.node.position.z);this.player.xrWorldInfo.findFloorNear(t)&&(this.logger.log("Found a floor at "+t[1]),e.point=t,e.node.position.y=t[1])}else this.logger.log("XR is not active?")}},{key:"stopLocalAnchor",value:function(e){this.logger.log("stopping vanilla anchor"),this.player.xr&&this.player.xr.session?this.player.xr.stopAnchor(e,this.logger):this.logger.log("XR is not active?")}},{key:"startImageRecognizer",value:function(e){var t=this;return this.logger.log("starting the image recognizer"),new Promise(function(r,n){t.player.xr&&t.player.xr.session?t.player.xr.createDetectionImage(e,t.logger).then(function(r){t.player.xr.startImageRecognizer(e,r,t.logger)}):t.logger.log("XR is not active?")})}},{key:"stopImageRecognizer",value:function(e){this.logger.log("stopping the image recognizer"),this.player.xr&&this.player.xr.session?this.player.xr.stopImageRecognizer(e,this.logger):this.logger.log("XR is not active?")}},{key:"startGeoTracker",value:function(e){var t=this;return new Promise(function(r,n){t.player.xr&&t.player.xr.session?t.player.xr.createGeoAnchor(e,t.logger).then(function(){t.player.xr.addGeoAnchoredNode(e,t.logger)}):t.logger.log("XR is not active?")})}},{key:"stopGeoTracker",value:function(e){this.player.xr&&this.player.xr.session?this.player.xr.stopGeoTracker(e,this.logger):this.logger.log("XR is not active?")}},{key:"startWorldInfo",value:function(e){this.player.xrWorldInfo?this.player.xrWorldInfo.setVisible(!0):this.logger.log("World Info is not active?")}},{key:"stopWorldInfo",value:function(e){this.player.xrWorldInfo?this.player.xrWorldInfo.setVisible(!1):this.logger.log("World Info is not active?")}}]),t}(mt),Nn=function(e){function t(){return Object(o.a)(this,t),Object(u.a)(this,Object(l.a)(t).apply(this,arguments))}return Object(h.a)(t,e),Object(c.a)(t,[{key:"getApp",value:function(){return this.props.options.AuthModule=P,"play"===this.props.options.mode?i.a.createElement(In,{options:this.props.options}):(this.provider=new sn(this.props.options),this.provider.popupManager=this.context,this.provider.getApp())}},{key:"render",value:function(){return this.getApp()}}]),t}(n.Component);Nn.contextType=H.f;var Gn=Object(x.v)({mode:"edit"});console.log("options is",Gn),s.a.render(i.a.createElement(H.f.Provider,{value:new H.e},i.a.createElement(Nn,{options:Gn})),document.getElementById("root"))},13:function(e,t){e.exports={adds:[],add:function(e){this.adds.forEach(function(t){return t(e)})},onAdd:function(e){this.adds.push(e)},offAdd:function(e){this.adds=this.adds.filter(function(t){return t!==e})}}},44:function(e,t,r){e.exports=r.p+"static/media/startup-sound.8786b4e1.m4a"},46:function(e,t,r){e.exports=r(114)},51:function(e,t,r){}},[[46,2,1]]]);
//# sourceMappingURL=main.33a3234f.chunk.js.map